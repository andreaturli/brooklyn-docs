<!--
  ~ Licensed to the Apache Software Foundation (ASF) under one
  ~ or more contributor license agreements.  See the NOTICE file
  ~ distributed with this work for additional information
  ~ regarding copyright ownership.  The ASF licenses this file
  ~ to you under the Apache License, Version 2.0 (the
  ~ "License"); you may not use this file except in compliance
  ~ with the License.  You may obtain a copy of the License at
  ~
  ~      http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing,
  ~ software distributed under the License is distributed on an
  ~ "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~ KIND, either express or implied.  See the License for the
  ~ specific language governing permissions and limitations
  ~ under the License.
  -->

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Windows Blueprints - Apache Brooklyn</title>

<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/octicons/octicons.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/bootstrap-theme.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/font-awesome-4.2.0/css/font-awesome.min.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/tooltip.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/css/code.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/css/website.css" rel="stylesheet" />

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
</head>

<body class="page">
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <div class="navbar-brand">
                <a class="brand-apache" href="http://www.apache.org/">
                    <img src="https://www.apache.org/foundation/press/kit/feather.svg" alt="[Apache]">
                </a>
                
                <a class="brand-brooklyn" href="/brooklyn-docs/"><img src="/brooklyn-docs/style/img/apache-brooklyn-logo-244px-wide.png" alt="brooklyn"></a>
                
            </div>
        </div>
        <div class="collapse navbar-collapse" id="main-menu">


            <ul class="nav navbar-nav navbar-right">
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/learnmore/index.html" data-toggle="dropdown">learn more <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/learnmore/index.html">Learn More</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/blueprint-tour.html">Blueprint Tour
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/features/index.html">Features
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/theory.html">Theory
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/catalog/index.html">Browse Catalog
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/v/latest/start/index.html" data-toggle="dropdown">get started <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/v/latest/start/index.html">Get Started</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/running.html">Running Apache Brooklyn
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/blueprints.html">Deploying Blueprints
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/managing.html">Monitoring and Managing Applications
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/policies.html">Policies
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/concept-quickstart.html">Brooklyn Concepts Quickstart
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown active">
                    
                    <a href="/brooklyn-docs/documentation/index.html" data-toggle="dropdown">documentation <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/documentation/index.html">Documentation</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li class="section">
                            <a href="/brooklyn-docs/v/latest/index.html">User Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/blueprints/creating-yaml.html">Writing Blueprints
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/locations/index.html">Deploying Blueprints
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li class="section">
                            <a href="/brooklyn-docs/v/latest/ops/index.html">Reference Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/dev/index.html">Developer Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        <li class="divider"></li>
                        <li >
                            <a href="/brooklyn-docs/meta/versions.html">Versions
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/documentation/other-docs.html">Other Resources
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/community/index.html" data-toggle="dropdown">community <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/community/index.html">Community</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/mailing-lists.html">Mailing Lists
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/irc.html">IRC
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/security/index.html">Security Advisories
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="https://issues.apache.org/jira/browse/BROOKLYN">Bug Tracker (JIRA)
                                &nbsp;<span class="octicon octicon-link-external"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/how-to-contribute-docs.html">Contributing Documentation
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/developers/index.html" data-toggle="dropdown">developers <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/developers/index.html">Developers</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/code/index.html">Get the Code
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/how-to-contribute.html">How to Contribute
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/dev/index.html">Developer Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/committers/index.html">Committer Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/code-standards.html">Code Standards
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/links.html">Handy Places
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="http://github.com/apache/brooklyn">GitHub
                                &nbsp;<span class="octicon octicon-link-external"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="https://issues.apache.org/jira/browse/BROOKLYN">Bug Tracker (JIRA)
                                &nbsp;<span class="octicon octicon-link-external"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <form class="navbar-form">
                        <a href="/brooklyn-docs/download/index.html" class="btn btn-default">download</a>
                    </form>
                    
                </li>
                
            </ul>
        </div>
    </div>
</nav>


<main>
    <div class="container">
        <div class="row">
            <div class="col-md-9 content">
                <div id="page_notes"></div>
                <h1>Windows Blueprints</h1>
                <p>Brooklyn can deploy to Windows servers using WinRM to run commands. These deployments can be 
expressed in pure YAML, and utilise Powershell to install and manage the software process. 
This approach is similar to the use of SSH for UNIX-like servers.</p>

<h2 id="about-winrm">About WinRM</h2>

<p>WinRM - or <em>Windows Remote Management</em> to give its full title - is a system administration service provided in all
recent Windows Server operating systems. It allows remote access to system information (provided via WMI) and the
ability to execute commands. For more information refer to <a href="https://msdn.microsoft.com/en-us/library/aa384426(v=vs.85).aspx">Microsoft’s MSDN article on Windows Remote
Management</a>.</p>

<p>WinRM is available by default in Windows Server, but is not enabled by default. Brooklyn will, in most cases, be able
to switch on WinRM support, but this is dependent on your cloud provider supporting a user metadata service with script
execution (see <a href="#user-metadata-service-requirement">below</a>).</p>

<h2 id="locations-for-windows">Locations for Windows</h2>

<p>You must define a new location in Brooklyn for Windows deployments. Windows deployments require a different VM image
ID to Linux, as well as some other special configuration, so you must have separate Brooklyn locations for Windows and
Linux deployments.</p>

<p>In particular, you will most likely want to set these properties on your location:</p>

<ul>
  <li><code>imageId</code> or <code>imageNameRegex</code> - select your preferred Windows Server image from your cloud provider.</li>
  <li><code>hardwareId</code> or <code>minRam</code>/<code>minCores</code> - since Windows machines generally require more powerful servers, ensure you get
a machine with the required specification.</li>
  <li><code>useJcloudsSshInit</code> - this must be set to <code>false</code>. Without this setting, jclouds will attempt to connect to the new
VMs using SSH, which will fail on Windows Server.</li>
  <li><code>templateOptions</code> - you may also wish to request a larger disk size. This setting is cloud specific; on AWS, you can
request a 100GB disk by setting this property to <code>{mapNewVolumeToDeviceName: ["/dev/sda1", 100, true]}</code>.</li>
</ul>

<p>In your YAML blueprint:</p>

<pre><code>...
location:
  jclouds:aws-ec2:
    region: us-west-2
    identity: AKA_YOUR_ACCESS_KEY_ID
    credential: &lt;access-key-hex-digits&gt;
    imageNameRegex: Windows_Server-2012-R2_RTM-English-64Bit-Base-.*
    imageOwner: 801119661308
    hardwareId: m3.medium
    useJcloudsSshInit: false
    templateOptions: {mapNewVolumeToDeviceName: ["/dev/sda1", 100, true]}
...
</code></pre>

<p>Alternatively, you can define a new named location in <code>brooklyn.properties</code>:</p>

<pre><code>brooklyn.location.named.AWS\ Oregon\ Win = jclouds:aws-ec2:us-west-2
brooklyn.location.named.AWS\ Oregon\ Win.displayName = AWS Oregon (Windows)
brooklyn.location.named.AWS\ Oregon\ Win.imageNameRegex = Windows_Server-2012-R2_RTM-English-64Bit-Base-.*
brooklyn.location.named.AWS\ Oregon\ Win.imageOwner = 801119661308
brooklyn.location.named.AWS\ Oregon\ Win.hardwareId = m3.medium
brooklyn.location.named.AWS\ Oregon\ Win.useJcloudsSshInit = false
brooklyn.location.named.AWS\ Oregon\ Win.templateOptions = {mapNewVolumeToDeviceName: ["/dev/sda1", 100, true]}
</code></pre>

<h2 id="a-sample-blueprint">A Sample Blueprint</h2>

<p>Creating a Windows VM is done using the <code>org.apache.brooklyn.entity.software.base.VanillaWindowsProcess</code> entity type. This is very similar
to <code>VanillaSoftwareProcess</code>, but adapted to work for Windows and WinRM instead of Linux. We suggest you read the
<a href="/brooklyn-docs/v/latest/blueprints/custom-entities.html#vanilla-software-using-bash">documentation for VanillaSoftwareProcess</a> to find out what you
can do with this entity.</p>

<p>Entity authors are strongly encouraged to write Windows Powershell or Batch scripts as separate 
files, to configure these to be uploaded, and then to configure the appropriate command as a 
single line that executes given script.</p>

<p>For example - here is a simplified blueprint (but see <a href="#tips-and-tricks">Tips and Tricks</a> below!):</p>

<pre><code>name: Server with 7-Zip

location:
  jclouds:aws-ec2:
    region: us-west-2
    identity: AKA_YOUR_ACCESS_KEY_ID
    credential: &lt;access-key-hex-digits&gt;
    imageNameRegex: Windows_Server-2012-R2_RTM-English-64Bit-Base-.*
    imageOwner: 801119661308
    hardwareId: m3.medium
    useJcloudsSshInit: false
    templateOptions: {mapNewVolumeToDeviceName: ["/dev/sda1", 100, true]}

services:
- type: org.apache.brooklyn.entity.software.base.VanillaWindowsProcess
  brooklyn.config:
    templates.preinstall:
      file:///Users/richard/install7zip.ps1: "C:\\install7zip.ps1"
    install.command: powershell -command "C:\\install7zip.ps1"
    customize.command: echo true
    launch.command: echo true
    stop.command: echo true
    checkRunning.command: echo true
    installer.download.url: http://www.7-zip.org/a/7z938-x64.msi
</code></pre>

<p>The installation script - referred to as <code>/Users/richard/install7zip.ps1</code> in the example above - is:</p>

<pre><code>$Path = "C:\InstallTemp"
New-Item -ItemType Directory -Force -Path $Path

$Url = "${config['installer.download.url']}"
$Dl = [System.IO.Path]::Combine($Path, "installer.msi")
$WebClient = New-Object System.Net.WebClient
$WebClient.DownloadFile( $Url, $Dl )

Start-Process "msiexec" -ArgumentList '/qn','/i',$Dl -RedirectStandardOutput ( [System.IO.Path]::Combine($Path, "stdout.txt") ) -RedirectStandardError ( [System.IO.Path]::Combine($Path, "stderr.txt") ) -Wait
</code></pre>

<p>Where security-related operation are to be executed, it may require the use of <code>CredSSP</code> to obtain
the correct Administrator privileges: you may otherwise get an access denied error. See the sub-section 
<a href="#how-and-why-to-re-authenticate-within-a-powershell-script">How and Why to re-authenticate within a powershell script</a> for more details.</p>

<p>This is only a very simple example. A more complex example can be found in the <a href="https://github.com/apache/brooklyn-server/tree/master/software/database/src/main/resources/org/apache/brooklyn/entity/database/mssql">Microsoft SQL Server blueprint in the
Brooklyn source code</a>.</p>

<h2 id="tips-and-tricks">Tips and Tricks</h2>

<p>The best practices for other entities (e.g. using <a href="/brooklyn-docs/v/latest/blueprints/custom-entities.html#vanilla-software-using-bash">VanillaSoftwareProcess</a>)
apply for WinRM as well.</p>

<h3 id="execution-phases">Execution Phases</h3>

<p>Blueprint authors are strongly encouraged to provide an implementation for install, launch, stop 
and checkRunning. These are vital for the generic effectors such as stopping and restarting the 
process.</p>

<h3 id="powershell">Powershell</h3>

<p>Powershell commands can be supplied using config options such as <code>launch.powershell.command</code>.</p>

<p>This is an alternative to supplying a standard batch command using config such as <code>launch.command</code>.
For a given phase, only one of the commands (Powershell or Batch) should be supplied.</p>

<h3 id="getting-the-right-exit-codes">Getting the Right Exit Codes</h3>

<p>WinRM (or at least the chosen WinRM client!) can return a zero exit code even on error in certain 
circumstances. It is therefore advisable to follow the guidelines below.</p>

<p><em>For a given command, write the Powershell or Batch script as a separate multi-command file. 
Upload this (e.g. by including it in the <code>files.preinstall</code> configuration). For the configuration
of the given command, execute the file.</em></p>

<p>When you have a command inside the powershell script which want to report its non zero exiting, 
please consider adding a check for its exit code after it.
Example:</p>

<pre><code>&amp; "C:\install.exe"
If ($lastexitcode -ne 0) {
    exit $lastexitcode
}
</code></pre>

<p>For Powershell files, consider including </p>

<pre><code>$ErrorActionPreference = "Stop"
</code></pre>

<p>at the start of the file. 
<code>$ErrorActionPreference</code> Determines how Windows PowerShell responds to a non-terminating
error (an error that does not stop the cmdlet processing) at the
command line or in a script, cmdlet, or provider, such as the
errors generated by the Write-Error cmdlet.
https://technet.microsoft.com/en-us/library/hh847796.aspx</p>

<p>See <a href="#incorrect-exit-codes">Incorrect Exit Codes</a> under Known Limitations below.</p>

<h3 id="executing-scripts-from-batch-commands">Executing Scripts From Batch Commands</h3>

<p>In a batch command, you can execute a batch file or Powershell file. For example:</p>

<pre><code>install.command: powershell -NonInteractive -NoProfile -Command "C:\\install7zip.ps1"
</code></pre>

<p>Or alternatively:</p>

<pre><code>install.command: C:\\install7zip.bat
</code></pre>

<h3 id="executing-scripts-from-powershell">Executing Scripts From Powershell</h3>

<p>In a Powershell command, you can execute a batch file or Powershell file. There are many ways
to do this (see official Powershell docs). For example:</p>

<pre><code>install.powershell.command: "&amp; C:\\install7zip.ps1"
</code></pre>

<p>Or alternatively:</p>

<pre><code>install.powershell.command: "&amp; C:\\install7zip.bat"
</code></pre>

<p>Note the quotes around the command. This is because the “&amp;” has special meaning in a YAML value. </p>

<h3 id="uploading-script-and-configuration-files">Uploading Script and Configuration Files</h3>

<p>Often, blueprints will require that (parameterized) scripts and configuration files are available to be copied to the
target VM. These must be URLs resolvable from the Brooklyn instance, or on the Brooklyn classpath. One simple way 
to achieve this is to compile the support files into a .jar, which is then added to AMP’s ‘dropins’ folder. Alternatively, 
an OSGi bundle can be used, referenced from the catalog item. </p>

<p>Ensure that these scripts end each line with “\r\n”, rather than just “\n”.</p>

<p>There are two types of file that can be uploaded: plain files and templated files. A plain 
file is uploaded unmodified. A templated file is interpreted as a <a href="http://freemarker.org">FreeMarker</a> 
template. This supports a powerful set of substitutions. In brief, anything (unescaped) of the form
<code>${name}</code> will be substituted, in this case looking up “name” for the value to use.</p>

<p>Templated files (be they configuration files or scripts) gives a powerful way to inject dependent 
configuration when installing an entity (e.g. for customising the install, or for referencing the
connection details of another entity). A common substitution is of the form <code>${config['mykey']}</code>. 
This looks up a config key (in this case named “mykey”) and will insert the value into the file.
Another common substitution is is of the form <code>${attribute['myattribute']}</code> - this looks up the
attribute named “myattribute” of this entity.</p>

<p>Files can be referenced as URLs. This includes support for things like <code>classpath://mypath/myfile.bat</code>. 
This looks for the given (fully qualified) resource on the Brooklyn classpath.</p>

<p>The destination for the file upload is specified in the entity’s configuration. Note that “" must
be escaped. For example <code>"C:\\install7zip.ps1"</code>.</p>

<p>A list of plain files to be uploaded can be configured under <code>files.preinstall</code>, <code>files.install</code> and
<code>files.runtime</code>. These are uploaded respectively prior to executing the <code>pre.install.command</code>,
prior to <code>install.command</code> and prior to <code>pre.launch.command</code>.</p>

<p>A list of templated files to be uploaded can be configured under <code>templates.preinstall</code>, <code>templates.install</code>
and <code>templates.runtime</code>. The times these are uploaded is as for the plain files. The templates 
substitutions will be resolved only at the point when the file is to be uploaded.</p>

<p>For example:</p>

<pre><code>files.preinstall:
- classpath://com/acme/installAcme.ps1
- classpath://com/acme/acme.conf
</code></pre>

<h3 id="parameterised-scripts">Parameterised Scripts</h3>

<p>Calling parameterised Batch and Powershell scripts is done in the normal Windows way - see
offical Microsoft docs. For example:</p>

<pre><code>install.command: "c:\\myscript.bat myarg1 myarg2"
</code></pre>

<p>Or as a Powershell example:</p>

<pre><code>install.powershell.command: "&amp; c:\\myscript.ps1 -key1 myarg1 -key2 myarg2"
</code></pre>

<p>It is also possible to construct the script parameters by referencing attributes of this or
other entities using the standard <code>attributeWhenReady</code> mechanism. For example:</p>

<pre><code>install.command: $brooklyn:formatString("c:\\myscript.bat %s", component("db").attributeWhenReady("datastore.url"))
</code></pre>

<h3 id="powershell---using-start-process">Powershell - Using Start-Process</h3>

<p>When you are invoking a command from a powershell script with <code>Start-Process</code> cmdlet,
please use the <code>-Wait</code> and the <code>-PassThru</code> arguments.
Example <code>Start-Process C:\mycommand -Wait -PassThru</code></p>

<p>Using <code>-Wait</code> guarantees that the script process and its children and thus the winrm session won’t be terminated until it is finished.
<code>-PassThru</code> Returns a process object for each process that the cmdlet started. By default, this cmdlet does not generate any output.
See https://technet.microsoft.com/en-us/library/hh849848.aspx</p>

<h3 id="rebooting">Rebooting</h3>

<p>Where a reboot is required as part of the entity setup, this can be configured using
config like <code>pre.install.reboot.required</code> and <code>install.reboot.required</code>. If required, the 
installation commands can be split between the pre-install, install and post-install phases
in order to do a reboot at the appropriate point of the VM setup.</p>

<p>We Strongly recommend to <strong>write blueprints in a way that they do NOT restart automatically windows</strong> and
use one of the <code>pre.install.reboot.required</code> or <code>install.reboot.required</code> parameters to perform restart.</p>

<h3 id="install-location">Install Location</h3>

<p>Blueprint authors are encouraged to explicitly specify the full path for file uploads, and 
for paths in their Powershell scripts (e.g. for installation, configuration files, log files, etc).</p>

<h3 id="how-and-why-to-re-authenticate-within-a-powershell-script">How and Why to re-authenticate within a powershell script</h3>

<p>Some installation scripts require the use of security-related operations. In some environments,<br />
these fail by default when executed over WinRM, even though the script may succeed when run locally <br />
(e.g. by using RDP to connect to the machine and running the script manually). There may be no<br />
clear indication from Windows why it failed (e.g. for MSSQL install, the only clue is a <br />
security exception in the installation log).</p>

<p>When a script is run over WinRM, the credentials under which the script are run are marked as
‘remote’ credentials, which are prohibited from running certain security-related operations. The 
solution is to obtain a new set of credentials within the script and use those credentials to 
required commands.</p>

<p>The WinRM client uses Negotiate+NTLM to authenticate against the machine.
This mechanism applies certain restrictions to executing commands on the windows host.</p>

<p>For this reason you should enable CredSSP on the windows host which grants all privileges available to the user.
 https://technet.microsoft.com/en-us/library/hh849719.aspx#sectionSection4</p>

<p>To use <code>Invoke-Command -Authentication CredSSP</code> the Windows Machine has to have:
- Up and running WinRM over http. The custom-enable-credssp.ps1 script enables winrm over http because <code>Invoke-Command</code> use winrm over http by default.
  Invoke-Command can be used with -UseSSL option but this will lead to modifying powershell scripts.
  With always enabling winrm over http on the host, blueprint’s powershell scripts remain consistent and not depend on the winrm https/http environments.
  We hope future versions of winrm4j will support CredSSP out of the box and wrapping commands in Invoke-Command will not be needed.
- Added trusted host entries which will use Invoke-Command
- Allowed CredSSP</p>

<p>All the above requirements are enabled in Apache Brooklyn through <a href="https://github.com/apache/brooklyn-server/blob/master/software/base/src/main/resources/org/apache/brooklyn/software/base/custom-enable-credssp.ps1">brooklyn-server/software/base/src/main/resources/org/apache/brooklyn/software/base/custom-enable-credssp.ps1</a>
script which enables executing commands with CredSSP in the general case.
The script works for most of the Windows images out there version 2008 and later.</p>

<p>Please ensure that Brooklyn’s changes are compatible with your organisation’s security policy.</p>

<p>Check Microsoft Documentation for more information about <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa378748(v=vs.85).aspx">Negotiate authenticate mechanism on technet.microsoft.com</a></p>

<p>Re-authentication also requires that the password credentials are passed in plain text within the
script. Please be aware that it is normal for script files - and therefore the plaintext password - 
to be saved to the VM’s disk. The scripts are also accessible via the Brooklyn web-console’s 
activity view. Access to the latter can be controlled via 
<a href="/brooklyn-docs/v/latest/blueprints/java/entitlements.html">Entitlements</a>.</p>

<p>As an example (taken from MSSQL install), the command below works when run locally, but fails over 
WinRM:</p>

<pre><code>( $driveLetter + "setup.exe") /ConfigurationFile=C:\ConfigurationFile.ini
</code></pre>

<p>The code below can be used instead (note this example uses Freemarker templating):</p>

<pre><code>&amp; winrm set winrm/config/service/auth '@{CredSSP="true"}'
&amp; winrm set winrm/config/client/auth '@{CredSSP="true"}'
#
$pass = '${attribute['windows.password']}'
$secpasswd = ConvertTo-SecureString $pass -AsPlainText -Force
$mycreds = New-Object System.Management.Automation.PSCredential ($($env:COMPUTERNAME + "\${location.user}"), $secpasswd)
#
$exitCode = Invoke-Command -ComputerName $env:COMPUTERNAME -Credential $mycreds -ScriptBlock {
    param($driveLetter)
    $process = Start-Process ( $driveLetter + "setup.exe") -ArgumentList "/ConfigurationFile=C:\ConfigurationFile.ini" -RedirectStandardOutput "C:\sqlout.txt" -RedirectStandardError "C:\sqlerr.txt" -Wait -PassThru -NoNewWindow
    $process.ExitCode
} -Authentication CredSSP -ArgumentList $driveLetter
#
exit $exitCode
</code></pre>

<p>In this example, the <code>${...}</code> format is FreeMarker templating. Those sections will be substituted
before the script is uploaded for execution. To explain this example in more detail:</p>

<ul>
  <li>
    <p><code>${attribute['windows.password']}</code> is substituted for the entity’s attribute “windows.password”.
This (clear-text) password is sent as part of the script. Assuming that HTTPS and NTLM is used,
the script will be encrypted while in-flight.</p>
  </li>
  <li>
    <p>The <code>${location.user}</code> gets (from the entity’s machine location) the username, substituting this 
text for the actual username. In many cases, this will be “Administrator”. However, on some<br />
clouds a different username (with admin privileges) will be used.</p>
  </li>
  <li>
    <p>The username and password are used to create a new credential object (having first converted the
password to a secure string).</p>
  </li>
  <li>
    <p>Credential Security Service Provider (CredSSP) is used for authentication, to pass the explicit<br />
credentials when using <code>Invoke-Command</code>.</p>
  </li>
</ul>

<h3 id="windows-amis-on-aws">Windows AMIs on AWS</h3>

<p>Windows AMIs in AWS change regularly (to include the latest Windows updates). If using the community
AMI, it is recommended to use an AMI name regex, rather than an image id, so that the latest AMI is 
always picked up. If an image id is used, it may fail as Amazon will delete their old Windows AMIs.</p>

<p>If using an image regex, it is recommended to include the image owner in case someone else uploads
a similarly named AMI. For example:</p>

<pre><code>brooklyn.location.named.AWS\ Oregon\ Win = jclouds:aws-ec2:us-west-2
brooklyn.location.named.AWS\ Oregon\ Win.imageNameRegex = Windows_Server-2012-R2_RTM-English-64Bit-Base-.*
brooklyn.location.named.AWS\ Oregon\ Win.imageOwner = 801119661308
...
</code></pre>

<h2 id="stdout-and-stderr-in-a-powershell-script">stdout and stderr in a Powershell script</h2>

<p>When calling an executable in a Powershell script, the stdout and stderr will usually be output to the console.
This is captured by Brooklyn, and shown in the activities view under the specific tasks.</p>

<p>An alternative is to redirect stdout and stderr to a file on the VM, which can be helpful if one expects sys admins
to log into the VM. However, be warned that this would hide the stdout/stderr from Brooklyn’s activities view.</p>

<p>For example, instead of running the following:</p>

<pre><code>D:\setup.exe /ConfigurationFile=C:\ConfigurationFile.ini
</code></pre>

<p>The redirect can be achieved by using the <code>Start-Process</code> scriptlet:</p>

<pre><code>Start-Process D:\setup.exe -ArgumentList "/ConfigurationFile=C:\ConfigurationFile.ini" -RedirectStandardOutput "C:\sqlout.txt" -RedirectStandardError "C:\sqlerr.txt" -PassThru -Wait
</code></pre>

<p>The <code>-ArgumentList</code> is simply the arguments that are to be passed to the executable, <code>-RedirectStandardOutput</code> and
<code>RedirectStandardError</code> take file locations for the output (if the file already exists, it will be overwritten). The
<code>-PassThru</code> argument indicates that Powershell should write to the file <em>in addition</em> to the console, rather than
<em>instead</em> of the console. The <code>-Wait</code> argument will cause the scriptlet to block until the process is complete.</p>

<p>Further details can be found on the <a href="https://technet.microsoft.com/en-us/library/hh849848.aspx">Start-Process documentation page</a>
on the Microsoft TechNet site.</p>

<h2 id="troubleshooting">Troubleshooting</h2>

<p>Much of the <a href="/brooklyn-docs/v/latest/ops/troubleshooting/">operations troubleshooting guide</a> is applicable for Windows blueprints.  </p>

<h3 id="user-metadata-service-requirement">User metadata service requirement</h3>

<p>WinRM requires activation and configuration before it will work in a standard Windows Server deployment. To automate
this, Brooklyn will place a setup script in the user metadata blob. Services such as Amazon EC2’s <code>Ec2ConfigService</code>
will automatically load and execute this script. If your chosen cloud provider does not support <code>Ec2ConfigService</code> or
a similar package, or if your cloud provider does not support user metadata, then you must pre-configure a Windows image
with the required WinRM setup and make Brooklyn use this image.</p>

<p>If the configuration options <code>userMetadata</code> or <code>userMetadataString</code> are used on the location, then this will override
the default setup script. This allows one to supply a custom setup script. However, if userMetadata contains something
else then the setup will not be done and the VM may not not be accessible remotely over WinRM.</p>

<h3 id="credentials-issue-requiring-special-configuration">Credentials issue requiring special configuration</h3>

<p>When a script is run over WinRM over HTTP, the credentials under which the script are run are marked as
‘remote’ credentials, which are prohibited from running certain security-related operations. This may prevent certain
operations. The installer from Microsoft SQL Server is known to fail in this case, for example. For a workaround, please
refer to <a href="#how-and-why-to-re-authenticate-within-a-powershell-script">How and Why to re-authenticate withing a powershell script</a> 
above.</p>

<h3 id="webserviceexception-could-not-send-message">WebServiceException: Could not send Message</h3>

<p>We detected a <code>WebServiceException</code> and different <code>SocketException</code>
during deployment of long lasting Application Blueprint against VcloudDirector.</p>

<p>Launching the blueprint bellow was giving constantly this type of error on launch step.</p>

<pre><code>services:
  type: org.apache.brooklyn.entity.software.base.VanillaWindowsProcess
  brooklyn.config:
    pre.install.command: echo preInstallCommand
    install.command: echo installCommand &gt; C:\\install.txt
    post.install.command: echo postInstallCommand
    customize.command: echo customizeCommand
    pre.launch.command: echo preLaunchCommand
    launch.powershell.command: |
      Start-Sleep -s 400
      Write-Host Test Completed
    post.launch.command: echo postLaunchCommand
    checkRunning.command: echo checkRunningCommand
    stop.command: echo stopCommand
</code></pre>

<p>With series of tests we concluded that on the Vcloud Director environment we were using
a restart was happening ~2 minutes after the VM is provisioned.
Logging in the host and search for System event of type 1074 in Windows Event Viewer, we found two 1074 events where the second one was</p>

<pre><code>The process C:\Windows\system32\winlogon.exe (W2K12-STD) has initiated the restart of computer WIN-XXXX on behalf of user
NT AUTHORITY\SYSTEM for the following reason: Operating System: Upgrade (Planned) Reason Code: 0x80020003 Shutdown Type: restart Comment:
</code></pre>

<p>Normally on other clouds only one restart event is registered and the first time winrm connection is made the Windows VM is ready for use. </p>

<p>For this particular case when you want this second restart to finish we made <code>waitWindowsToStart</code> location parameter
which basically adds additional check assuring the Windows VM provisioning is done.</p>

<p>For example when using <code>waitWindowsToStart: 5m</code> location parameter, Apache Brooklyn will wait 5 minutes to see if a disconnect occurs.
If it does, then it will again wait 5m for the machine to come back up.
The default behaviour in Apache Brooklyn is to consider provisioning done on the first successful winrm connection, without waiting for restart. </p>

<p>To determine whether you should use this parameter you should carefully inspect how the image you choose to provision is behaving.
If the description above matches your case and you are getting <strong>connection failure message in the middle of the installation process</strong> for your blueprints,
a restart probably occurred and you should try this parameter.</p>

<p>Before using this parameter we advice to check whether this is really your case.
To verify the behavior check as described above.</p>

<h3 id="amis-not-found">AMIs not found</h3>

<p>If using the imageId of a Windows community AMI, you may find that the AMI is deleted after a few weeks.
See <a href="#windows-amis-on-aws">Windows AMIs on AWS</a> above.</p>

<h3 id="vm-provisioning-times-out">VM Provisioning Times Out</h3>

<p>In some environments, provisioning of Windows VMs can take a very long time to return a usable VM.
If the image is old, it may install many security updates (and reboot several times) before it is
usable.</p>

<p>On a VMware vCloud Director environment, the guest customizations can cause the VM to reboot (sometimes
several times) before the VM is usable.</p>

<p>This could cause the WinRM connection attempts to timeout. The location configuration option 
<code>waitForWinRmAvailable</code> defaults to <code>30m</code> (i.e. 30 minutes). This can be increased if required.</p>

<p>Incorrectly prepared Windows template can cause the deployment to time-out expecting an interaction by the user.
You can verify if this is the case by RDP to the deployment which is taking to much time to complete. 
It is recommended to manually deploy a single VM for every newly created Windows template to verify that it can be
used for unattended installations and it doesn’t wait and/or require an input by the user.
See <a href="#windows-template-settings-for-an-unattended-installation">Windows template settings for an Unattended Installation</a> under Known Limitations below. </p>

<h3 id="windows-log-files">Windows log files</h3>

<p>Details of the commands executed, and their results, can be found in the Brooklyn log and in the Brooklyn 
web-console’s activity view. </p>

<p>There will also be log files on the Windows Server. System errors in Windows are usually reported in the Windows Event Log -<br />
see <a href="https://technet.microsoft.com/en-us/library/cc766042.aspx">https://technet.microsoft.com/en-us/library/cc766042.aspx</a> 
for more information.</p>

<p>Additional logs may be created by some Windows programs. For example, MSSQL creates a log in 
<code>%programfiles%\Microsoft SQL Server\130\Setup Bootstrap\Log\</code> - for more information see 
<a href="https://msdn.microsoft.com/en-us/library/ms143702.aspx">https://msdn.microsoft.com/en-us/library/ms143702.aspx</a>.</p>

<h2 id="known-limitations">Known Limitations</h2>

<p>WinRM 2.0 supports encryption mechanisms on top of HTTP. However those are not supported in Apache Brooklyn.
For production adoptions please make sure you follow Microsoft Guidelines https://msdn.microsoft.com/en-us/library/ee309366(v=vs.85).aspx</p>

<h3 id="apache-brooklyn-limitations-on-using-winrm-over-http-and-https">Apache Brooklyn limitations on using WinRM over HTTP and HTTPS</h3>

<p>By default Apache Brooklyn is currently using unencrypted HTTP for WinRM communication. It does not support encrypted HTTP for WinRM.</p>

<p>HTTPS is supported but there is no mechanism of specifying which certificates to trust.
Currently Apache Brooklyn will accept any certificate used in a HTTPS WinRM connection.</p>

<h3 id="incorrect-exit-codes">Incorrect Exit Codes</h3>

<p>Some limitations with WinRM (or at least the chosen WinRM Client!) are listed below:</p>

<h5 id="single-line-powershell-files">Single-line Powershell files</h5>

<p>When a Powershell file contains just a single command, the execution of that file over WinRM returns exit code 0
even if the command fails! This is the case for even simple examples like <code>exit 1</code> or <code>thisFileDoesNotExist.exe</code>.</p>

<p>A workaround is to add an initial command, for example:</p>

<pre><code>Write-Host dummy line for workaround 
exit 1
</code></pre>

<h5 id="direct-configuration-of-powershell-commands">Direct Configuration of Powershell commands</h5>

<p>If a command is directly configured with Powershell that includes <code>exit</code>, the return code over WinRM
is not respected. For example, the command below will receive an exit code of 0.</p>

<pre><code>launch.powershell.command: |
  echo first
  exit 1
</code></pre>

<h5 id="direct-configuration-of-batch-commands">Direct Configuration of Batch commands</h5>

<p>If a command is directly configured with a batch exit, the return code over WinRM
is not respected. For example, the command below will receive an exit code of 0.</p>

<pre><code>launch.command: exit /B 1
</code></pre>

<h5 id="non-zero-exit-code-returned-as-one">Non-zero Exit Code Returned as One</h5>

<p>If a batch or Powershell file exits with an exit code greater than one (or negative), this will 
be reported as 1 over WinRM.</p>

<p>We advise you to use native commands (non-powershell ones) since executing it as a native command
will return the exact exit code rather than 1.
For instance if you have installmssql.ps1 script use <code>install.command: powershell -command "C:\\installmssql.ps1"</code>
rather than using <code>install.powershell.command: "C:\\installmssql.ps1"</code>
The first will give you an exact exit code rather than 1</p>

<h3 id="powershell-preparing-modules-for-first-use">PowerShell “Preparing modules for first use”</h3>

<p>The first command executed over WinRM has been observed to include stderr saying “Preparing 
modules for first use”, such as that below:</p>

<pre><code>&lt; CLIXML
&lt;Objs Version="1.1.0.1" xmlns="http://schemas.microsoft.com/powershell/2004/04"&gt;&lt;Obj S="progress" RefId="0"&gt;&lt;TN RefId="0"&gt;&lt;T&gt;System.Management.Automation.PSCustomObject&lt;/T&gt;&lt;T&gt;System.Object&lt;/T&gt;&lt;/TN&gt;&lt;MS&gt;&lt;I64 N="SourceId"&gt;1&lt;/I64&gt;&lt;PR N="Record"&gt;&lt;AV&gt;Preparing modules for first use.&lt;/AV&gt;&lt;AI&gt;0&lt;/AI&gt;&lt;Nil /&gt;&lt;PI&gt;-1&lt;/PI&gt;&lt;PC&gt;-1&lt;/PC&gt;&lt;T&gt;Completed&lt;/T&gt;&lt;SR&gt;-1&lt;/SR&gt;&lt;SD&gt; &lt;/SD&gt;&lt;/PR&gt;&lt;/MS&gt;&lt;/Obj&gt;&lt;Obj S="progress" RefId="1"&gt;&lt;TNRef RefId="0" /&gt;&lt;MS&gt;&lt;I64 N="SourceId"&gt;2&lt;/I64&gt;&lt;PR N="Record"&gt;&lt;AV&gt;Preparing modules for first use.&lt;/AV&gt;&lt;AI&gt;0&lt;/AI&gt;&lt;Nil /&gt;&lt;PI&gt;-1&lt;/PI&gt;&lt;PC&gt;-1&lt;/PC&gt;&lt;T&gt;Completed&lt;/T&gt;&lt;SR&gt;-1&lt;/SR&gt;&lt;SD&gt; &lt;/SD&gt;&lt;/PR&gt;&lt;/MS&gt;&lt;/Obj&gt;&lt;/Objs&gt;
</code></pre>

<p>The command still succeeded. This has only been observed on private clouds (e.g. not on
AWS). It could be related to the specific Windows images in use. It is recommended that 
VM images are prepared carefully, e.g. so that security patches are up-to-date and the
VM is suitably initialised.</p>

<h3 id="winrm-executescript-failed-httplibbadstatusline-">WinRM executeScript failed: httplib.BadStatusLine: ‘’</h3>

<p>As described in https://issues.apache.org/jira/browse/BROOKLYN-173, a failure has been
observed where the 10 attempts to execute the command over WinRM failed with:</p>

<pre><code>httplib.BadStatusLine: ''
</code></pre>

<p>Subsequently retrying the command worked. It is unclear what caused the failure, but could 
have been that the Windows VM was not yet in the right state.</p>

<p>One possible workaround is to ensure the Windows VM is in a good state for immediate use (e.g. 
security updates are up-to-date). Another option is to increase the number of retries, 
which defaults to 10. This is a configuration option on the machine location, so can be set on
the location’s brooklyn.properties or in the YAML: </p>

<pre><code>execTries: 20
</code></pre>

<h3 id="direct-configuration-of-multi-line-batch-commands-not-executed">Direct Configuration of Multi-line Batch Commands Not Executed</h3>

<p>If a command is directly configured with multi-line batch commands, then only the first line 
will be executed. For example the command below will only output “first”:</p>

<pre><code>launch.command: |
  echo first
  echo second
</code></pre>

<p>The workaround is to write a file with the batch commands, have that file uploaded, and execute it.</p>

<p>Note this is not done automatically because that could affect the capture and returning
of the exit code for the commands executed.</p>

<h3 id="install-location-1">Install location</h3>

<p>Work is required to better configure a default install location on the VM (e.g. so that 
environment variables are set). The installation pattern for linux-based blueprints,
of using brooklyn-managed-processes/installs, is not used or recommended on Windows.
Files will be uploaded to C:\ if no explicit directory is supplied, which is untidy, 
unnecessarily exposes the scripts to the user, and could cause conflicts if multiple 
entities are installed.</p>

<p>Blueprint authors are strongly encourages to explicitly specific directories for file
uploads and in their Powershell scripts.</p>

<h3 id="windows-template-settings-for-an-unattended-installation">Windows template settings for an Unattended Installation</h3>

<p>Windows template needs certain configuration to be applied to prevent windows setup UI from being displayed.
The default behavior is to display it if there are incorrect or empty settings. Showing Setup UI will prevent the proper
deployment, because it will expect interaction by the user such as agreeing on the license agreement or some of the setup dialogs.</p>

<p>Detailed instruction how to prepare an Unattended installation are provided at <a href="https://technet.microsoft.com/en-us/library/cc722411%28v=ws.10%29.aspx">https://technet.microsoft.com/en-us/library/cc722411%28v=ws.10%29.aspx</a>.</p>


            </div>

            <aside class="col-md-3">
                <div class="list-group side-menu" id="side-menu">



  
     
              
                  <h4 class=" with_following">
                    <a href="/brooklyn-docs/v/latest/index.html" class="list-group-item breadcrumb breadcrumb0">
                      User Guide
                      </a></h4>
              
                  <h4 class=" with_preceding">
                    <a href="/brooklyn-docs/v/latest/blueprints/index.html" class="list-group-item breadcrumb breadcrumb1">
                      Writing Blueprints
                      </a></h4>
              
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/creating-yaml.html" class="list-group-item">The Basic Structure
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/entity-configuration.html" class="list-group-item">Entity Configuration
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/setting-locations.html" class="list-group-item">Setting Locations
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/configuring-vms.html" class="list-group-item">Configuring VMs
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/multiple-services.html" class="list-group-item">Multiple Services and Dependency Injection
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/custom-entities.html" class="list-group-item">Custom Entities
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/catalog/index.html" class="list-group-item">Catalog
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/clusters.html" class="list-group-item">Clusters, Specs, and Composition
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/enrichers.html" class="list-group-item">Enrichers
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/policies.html" class="list-group-item">Policies
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/clusters-and-policies.html" class="list-group-item">Clusters and Policies
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/java/index.html" class="list-group-item">Java Entities
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/winrm/index.html" class="list-group-item active with-sub-item">Windows Blueprints
                    </a>
                  <div class="sub-item">
                    
                      
                      <a href="/brooklyn-docs/v/latest/blueprints/winrm/client.html" class="list-group-item sub-item " >
                        Winrm4j Client
                        </a>
                    
                  </div>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/test/index.html" class="list-group-item">Testing YAML Blueprints
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/ansible/index.html" class="list-group-item">Ansible in YAML Blueprints
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/chef/index.html" class="list-group-item">Chef in YAML Blueprints
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/salt/index.html" class="list-group-item">Salt in YAML Blueprints
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/advanced-example.html" class="list-group-item">YAML Blueprint Advanced Example
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/blueprinting-tips.html" class="list-group-item">Blueprinting Tips
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/yaml-reference.html" class="list-group-item">YAML Blueprint Reference
                    </a>
                
              
        
        
  

        
</div>
<div id="width_reference"></div>


<script language="JavaScript" type="application/javascript">
(function($){
    
    sidemenu_x_sizer=function(){ $('#side-menu').width($('#side-menu').parent().find('#width_reference').outerWidth()); };
    $(sidemenu_x_sizer);
    $(window).resize(sidemenu_x_sizer);

    
    sidemenu_y_nonfloater=function(){
      if ($('#side-menu').outerHeight(true) + $('#header').outerHeight(true) + $('#footer').outerHeight(true) > window.innerHeight ||
          $('#side-menu').width() >= $('#content_container').width()/2) {
        $('#side-menu').css('position', 'inherit');
      } else {
        // restore if screen has grown
        $('#side-menu').css('position', 'fixed');
      }
    };
    $(sidemenu_y_nonfloater);
    $(window).resize(sidemenu_y_nonfloater);

    

    var sideMenu = $("#side-menu"),
        sideItems = sideMenu.find("a"),
        // Anchors corresponding to menu items
        scrollItems = sideItems.map(function(){
          var item = $(this).attr("section-target");
          if (item && item.length) { return item; }
        });

    var highlight_section_last_top = -1;
    var highlight_section_completed = false;

    var highlight_section = function() {
       // Get container scroll position
       var highlight_section_new_top = $(this).scrollTop();
       if (highlight_section_new_top == highlight_section_last_top) return;
       var highlight_section_new_bottom = highlight_section_new_top + $(window).height();
       var scroll_advancing = (highlight_section_new_top > highlight_section_last_top);

       var last_item = null, active_item = $("#side-menu a.section#active");

       var found_top = false;
       var displayable_items = scrollItems.map(function(itemI){
         item = $(scrollItems[itemI]);
         if (item && item.length) {
           if (highlight_section_last_top == -1 || !highlight_section_completed) {
             // just opening page - take item matching hash, or otherwise the first item visible
             if (item.selector === window.location.hash || (item.offset().top > highlight_section_new_top - 20 && !found_top)) {
               found_top = true;
               if (item.selector === window.location.hash && item.offset().top < highlight_section_new_top + 60) {
                 // because of our top header, we need to scroll 64px down from any link
                 $('html, body').animate({scrollTop: item.offset().top - 64}, 0);
               }
               return item;
             }
           } else if (scroll_advancing) {
             // if scrolling advance, pick up a section when title starts before 1/3 height
             if (item.offset().top < highlight_section_new_top + $(window).height()/3)
               return item;

             // or if containing div is finished (usu the whole main content)
             div_containing_item = item.closest("div");
             if (div_containing_item.offset().top + div_containing_item.height() < highlight_section_new_bottom + 15)
               return item;
             // or when next title is visible
             if (last_item && item.offset().top < highlight_section_new_bottom + 15)
               return last_item;
           } else {
             // if scrolling back, pick up a section as soon as the title is visible,
             if (item.offset().top < highlight_section_new_top)
               return item;
             // or if title is before the 2/3 point
             // (not sure about this, probably want also to have
             // "AND the id.top is <= displayable_itemsrent_active_it.top" so we don't jump FORWARD a section
             // when scrolling BACK, with lots of tiny sections)
             if ((item.offset().top < highlight_section_new_top + 2*$(window).height()/3)
                 && (!active_item || !active_item.offset() || active_item.offset().top >= item.offset().top))
               return item;

           }
           last_item = item;
         }
       });
       if (!highlight_section_completed && document.readyState === "complete") {
         highlight_section_completed = true;
       }
       if (!displayable_items.length) {
         $("#side-menu a.section").removeClass("active");
       } else {
         displayable_items = displayable_items[displayable_items.length-1];
         var id = displayable_items && displayable_items.length ? displayable_items[0].id : "";
       // Set/remove active class
         new_active = $("#side-menu a.section").filter("[section-target='#"+id+"']");
         if (new_active.hasClass("active")) {
           // nothing needed
         } else {
           $("#side-menu a.section").removeClass("active");
           $("#side-menu a.section").filter("[section-target='#"+id+"']").addClass("active");
         }
       }

       highlight_section_last_top = highlight_section_new_top;
    };
    var highlight_new_section = function() {
      highlight_section_completed = false;
      highlight_section_last_top = -1;
      highlight_section();
    }

    $(window).scroll(highlight_section);
    $(highlight_new_section);

    // detect link change - courtesy http://www.bennadel.com/blog/1520-binding-events-to-non-dom-objects-with-jquery.htm

    // Default to the current location.
    var strLocation = window.location.href;
    var strHash = window.location.hash;
    var strPrevLocation = "";
    var strPrevHash = "";

    // This is how often we will be checkint for
    // changes on the location.
    var intIntervalTime = 100;

    // This method removes the pound from the hash.
    var fnCleanHash = function( strHash ){
        return(
            strHash.substring( 1, strHash.length )
            );
    }

    // This will be the method that we use to check
    // changes in the window location.
    var fnCheckLocation = function(){
        // Check to see if the location has changed.
        if (strLocation != window.location.href){

            // Store the new and previous locations.
            strPrevLocation = strLocation;
            strPrevHash = strHash;
            strLocation = window.location.href;
            strHash = window.location.hash;

            // The location has changed. Trigger a
            // change event on the location object,
            // passing in the current and previous
            // location values.
            $( window.location ).trigger(
                "change",
                {
                    currentHref: strLocation,
                    currentHash: fnCleanHash( strHash ),
                    previousHref: strPrevLocation,
                    previousHash: fnCleanHash( strPrevHash )
                }
                );

        }
    }

    // Set an interval to check the location changes.
    setInterval( fnCheckLocation, intIntervalTime );

    // and trigger highlight section on link change
    $(window.location).bind("change", highlight_new_section);
})(jQuery);

</script>

            </aside>
        </div>
    </div>
</main>

<footer class="container">
    <div class="row">
        <div class="col-md-9">
            <p>Apache Brooklyn is distributed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License v2.0</a>.</p>
        </div>
        <div class="col-md-3 text-right">
            <p>
                <a class="btn btn-sm btn-default" href="https://github.com/apache/brooklyn-docs/edit/master/guide/blueprints/winrm/index.md">Edit This Page</a>
                <a href="https://brooklyn.apache.org/community/how-to-contribute-docs.html"
                    data-toggle="tooltip" data-placement="top" title="" data-delay="400" data-original-title="How to Edit Documentation">
                    <span class="octicon octicon-question octicon-footer"></span>
                </a>
            </p>
        </div>
    </div>
</footer>

</body>

<!--
  ~ Licensed to the Apache Software Foundation (ASF) under one
  ~ or more contributor license agreements.  See the NOTICE file
  ~ distributed with this work for additional information
  ~ regarding copyright ownership.  The ASF licenses this file
  ~ to you under the Apache License, Version 2.0 (the
  ~ "License"); you may not use this file except in compliance
  ~ with the License.  You may obtain a copy of the License at
  ~
  ~      http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing,
  ~ software distributed under the License is distributed on an
  ~ "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~ KIND, either express or implied.  See the License for the
  ~ specific language governing permissions and limitations
  ~ under the License.
  -->

<script type="text/javascript" src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/brooklyn-docs/style/deps/jquery.cookie.js"></script>
<script type="text/javascript" src="/brooklyn-docs/style/js/zeroclipboard/ZeroClipboard.min.js"></script>
<script type="text/javascript" src="/brooklyn-docs/style/deps/tooltip.js"></script>

<script type="text/javascript">
    ZeroClipboard.config({ moviePath: '/style/js/zeroclipboard/ZeroClipboard.swf' });
</script>
<script src="/brooklyn-docs/style/js/public.js"></script>
</html>
