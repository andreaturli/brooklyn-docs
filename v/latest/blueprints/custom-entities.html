<!--
  ~ Licensed to the Apache Software Foundation (ASF) under one
  ~ or more contributor license agreements.  See the NOTICE file
  ~ distributed with this work for additional information
  ~ regarding copyright ownership.  The ASF licenses this file
  ~ to you under the Apache License, Version 2.0 (the
  ~ "License"); you may not use this file except in compliance
  ~ with the License.  You may obtain a copy of the License at
  ~
  ~      http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing,
  ~ software distributed under the License is distributed on an
  ~ "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~ KIND, either express or implied.  See the License for the
  ~ specific language governing permissions and limitations
  ~ under the License.
  -->

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Custom Entities - Apache Brooklyn</title>

<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/octicons/octicons.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/bootstrap-theme.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/font-awesome-4.2.0/css/font-awesome.min.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/tooltip.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/css/code.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/css/website.css" rel="stylesheet" />

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
</head>

<body class="page">
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <div class="navbar-brand">
                <a class="brand-apache" href="http://www.apache.org/">
                    <img src="https://www.apache.org/foundation/press/kit/feather.svg" alt="[Apache]">
                </a>
                
                <a class="brand-brooklyn" href="/brooklyn-docs/"><img src="/brooklyn-docs/style/img/apache-brooklyn-logo-244px-wide.png" alt="brooklyn"></a>
                
            </div>
        </div>
        <div class="collapse navbar-collapse" id="main-menu">


            <ul class="nav navbar-nav navbar-right">
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/learnmore/index.html" data-toggle="dropdown">learn more <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/learnmore/index.html">Learn More</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/blueprint-tour.html">Blueprint Tour
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/features/index.html">Features
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/theory.html">Theory
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/catalog/index.html">Browse Catalog
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/v/latest/start/index.html" data-toggle="dropdown">get started <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/v/latest/start/index.html">Get Started</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/running.html">Running Apache Brooklyn
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/blueprints.html">Deploying Blueprints
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/managing.html">Monitoring and Managing Applications
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/policies.html">Policies
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/concept-quickstart.html">Brooklyn Concepts Quickstart
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown active">
                    
                    <a href="/brooklyn-docs/documentation/index.html" data-toggle="dropdown">documentation <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/documentation/index.html">Documentation</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li class="section">
                            <a href="/brooklyn-docs/v/latest/index.html">User Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/blueprints/creating-yaml.html">Writing Blueprints
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/locations/index.html">Deploying Blueprints
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li class="section">
                            <a href="/brooklyn-docs/v/latest/ops/index.html">Reference Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/dev/index.html">Developer Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        <li class="divider"></li>
                        <li >
                            <a href="/brooklyn-docs/meta/versions.html">Versions
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/documentation/other-docs.html">Other Resources
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/community/index.html" data-toggle="dropdown">community <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/community/index.html">Community</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/mailing-lists.html">Mailing Lists
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/irc.html">IRC
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/security/index.html">Security Advisories
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="https://issues.apache.org/jira/browse/BROOKLYN">Bug Tracker (JIRA)
                                &nbsp;<span class="octicon octicon-link-external"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/how-to-contribute-docs.html">Contributing Documentation
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/developers/index.html" data-toggle="dropdown">developers <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/developers/index.html">Developers</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/code/index.html">Get the Code
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/how-to-contribute.html">How to Contribute
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/dev/index.html">Developer Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/committers/index.html">Committer Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/code-standards.html">Code Standards
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/links.html">Handy Places
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="http://github.com/apache/brooklyn">GitHub
                                &nbsp;<span class="octicon octicon-link-external"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="https://issues.apache.org/jira/browse/BROOKLYN">Bug Tracker (JIRA)
                                &nbsp;<span class="octicon octicon-link-external"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <form class="navbar-form">
                        <a href="/brooklyn-docs/download/index.html" class="btn btn-default">download</a>
                    </form>
                    
                </li>
                
            </ul>
        </div>
    </div>
</nav>


<main>
    <div class="container">
        <div class="row">
            <div class="col-md-9 content">
                <div id="page_notes"></div>
                <h1>Custom Entities</h1>
                <p>So far we’ve covered how to configure and compose entities.
There’s a large library of blueprints available, but
there are also times when you’ll want to write your own.</p>

<p>For complex use cases, you can write JVM, but for many common situations,
some of the highly-configurable blueprints make it easy to write in YAML,
including <code>bash</code> and Chef.</p>

<h3 id="vanilla-software-using-bash">Vanilla Software using <code>bash</code></h3>

<p>The following blueprint shows how a simple script can be embedded in the YAML
(the <code>|</code> character is special YAML which makes it easier to insert multi-line text):</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server Example</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.software.base.VanillaSoftwareProcess</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server</span>
  <span class="l-Scalar-Plain">launch.command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
    <span class="no">echo hello | nc -l 4321 &amp;</span>
    <span class="no">echo $! &gt; $PID_FILE</span></code></pre></div>

<p>This starts a simple <code>nc</code> listener on port 4321 which will respond <code>hello</code> to the first
session which connects to it. Test it by running <code>telnet localhost 4321</code>
or opening <code>http://localhost:4321</code> in a browser.</p>

<p>Note that it only allows you connect once, and after that it fails.
This is deliberate! We’ll repair this later in this example.
Until then however, in the <em>Applications</em> view you can click the server,
go to the <code>Effectors</code> tab, and click <code>restart</code> to bring if back to life.  </p>

<p>This is just a simple script, but it shows how any script can be easily embedded here,
including a script to download and run other artifacts.
Many artifacts are already packaged such that they can be downloaded and launched 
with a simple script, and <code>VanillaSoftwareProcess</code> can also be used for them. </p>

<h4 id="downloading-files">Downloading Files</h4>

<p>We can specify a <code>download.url</code> which downloads an artifact 
(and automatically unpacking TAR, TGZ, and ZIP archives)
before running <code>launch.command</code> relative to where that file is installed (or unpacked),
with the default <code>launch.command</code> being <code>./start.sh</code>.</p>

<p>So if we create a file <code>/tmp/netcat-server.tgz</code> containing just <code>start.sh</code> in the root
which consists of the two lines in the previous example,
we can instead write our example as: </p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Example From File</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.software.base.VanillaSoftwareProcess</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server</span>
  <span class="l-Scalar-Plain">download.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">file:///tmp/netcat-server.tgz</span></code></pre></div>

<h4 id="port-inferencing">Port Inferencing</h4>

<p>If you’re deploying to a cloud machine, a firewall might block the port 4321.
We can tell Brooklyn to open this port explicitly by specifying <code>inboundPorts: [ 4321 ]</code>;
however a more idiomatic way is to specify a config ending with <code>.port</code>,
such as:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Netcat Example with Port Opened</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.software.base.VanillaSoftwareProcess</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server</span>
  <span class="l-Scalar-Plain">launch.command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
    <span class="no">echo hello | nc -l 4321 &amp;</span>
    <span class="no">echo $! &gt; $PID_FILE</span>
    
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="c1"># matching the regex `.*\.port` will cause the port to be opened</span>
    <span class="c1"># if in a cloud where configurable security groups are available</span>
    <span class="l-Scalar-Plain">netcat.port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4321</span></code></pre></div>

<p>The regex for ports to be opened can be configured using
the config <code>inboundPorts.configRegex</code> (which has <code>.*\.port</code> as the default value).</p>

<p>Config keys of type <code>org.apache.brooklyn.api.location.PortRange</code> (aka <code>port</code>)
have special behaviour: when configuring, you can use range notation <code>8000-8100</code> or <code>8000+</code> to tell Brooklyn
to find <strong>one</strong> port matching; this is useful when ports might be in use.
In addition, any such config key will be opened, 
irrespective of whether it matches the <code>inboundPorts.configRegex</code>. 
To prevent any inferencing of ports to open, you can set the config <code>inboundPorts.autoInfer</code> to <code>false</code>.</p>

<p>Furthermore, the port inferencing capability takes in account static <code>ConfigKey</code> fields that
are defined on any Entity sub-class. So, <code>ConfigKey</code> fields that are based on <code>PortRanges</code> type will
be also included as required open ports.</p>

<p>Note that in the example above, <code>netcat.port</code> must be specified in a <code>brooklyn.config</code> block.
This block can be used to hold any config (including for example the <code>launch.command</code>),
but for convenience Brooklyn allows config keys declared on the underlying type
to be specified up one level, alongside the type.
However config keys which are <em>not</em> declared on the type <em>must</em> be declared in the <code>brooklyn.config</code> block. </p>

<h3 id="passing-custom-variables">Passing custom variables</h3>

<p>Blueprint scripts can be parametrised through environment variables, making them reusable in different use-cases.
Define the variables in the <code>env</code> block and then reference them using the standard bash notation:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Netcat Example with Environment Vars</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.software.base.VanillaSoftwareProcess</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server</span>
  <span class="l-Scalar-Plain">launch.command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
    <span class="no">echo $MESSAGE | nc -l $NETCAT_PORT &amp;</span>
    <span class="no">echo $! &gt; $PID_FILE</span>
    
  <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">MESSAGE</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hello</span>
    <span class="l-Scalar-Plain">NETCAT_PORT</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4321</span></code></pre></div>

<p>Non-string objects in the <code>env</code> map will be serialized to JSON before passing them to the script.</p>

<h4 id="declaring-new-config-keys">Declaring New Config Keys</h4>

<p>We can define config keys to be presented to the user 
using the <code>brooklyn.parameters</code> block:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Netcat Example with Parameter</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.software.base.VanillaSoftwareProcess</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server</span>
  <span class="l-Scalar-Plain">launch.command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
    <span class="no">echo $MESSAGE | nc -l $NETCAT_PORT &amp;</span>
    <span class="no">echo $! &gt; $PID_FILE</span>
    
  <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">MESSAGE</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:config(&quot;message&quot;)</span>
    <span class="l-Scalar-Plain">NETCAT_PORT</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:attributeWhenReady(&quot;netcat.port&quot;)</span>
  
  <span class="l-Scalar-Plain">brooklyn.parameters</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">message</span>
    <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">a message to send to the caller</span>
    <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hello</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">netcat.port</span>
    <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">port</span>
    <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">the port netcat should run on</span>
    <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4321+</span></code></pre></div>

<p>The example above will allow a user to specify a message to send back
and the port where netcat will listen.
The metadata on these parameters is available at runtime in the UI
and through the API, and is used when populating a catalog.</p>

<p>The example also shows how these values can be passed as environment variables to the launch command.
The <code>$brooklyn:config(...)</code> function returns the config value supplied or default.
For the type <code>port</code>, an attribute sensor is also created to report the <em>actual</em> port used after port inference,
and so the <code>$brooklyn:attributeWhenReady(...)</code> function is used.
(If <code>$brooklyn:config("netcat.port")</code> had been used, <code>4321+</code> would be passed as <code>NETCAT_PORT</code>.)</p>

<p>This gives us quite a bit more power in writing our blueprint:</p>

<ul>
  <li>Multiple instances of the server can be launched simultaneously on the same host, 
as the <code>4321+</code> syntax enables Brooklyn to assign them different ports</li>
  <li>If this type is added to the catalog, a user can configure the message and the port;
we’ll show this in the next section</li>
</ul>

<h4 id="using-the-catalog-and-clustering">Using the Catalog and Clustering</h4>

<p>The <em>Catalog</em> tab allows you to add blueprints which you can refer to in other blueprints.
In that tab, click <em>+</em> then <em>YAML</em>, and enter the following:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">brooklyn.catalog</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">netcat-example</span>
  <span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&quot;1.0&quot;</span>
  <span class="l-Scalar-Plain">itemType</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity</span>
  <span class="l-Scalar-Plain">item</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.software.base.VanillaSoftwareProcess</span>
    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server</span>

    <span class="l-Scalar-Plain">launch.command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
      <span class="no">echo $MESSAGE | nc -l $NETCAT_PORT &amp;</span>
      <span class="no">echo $! &gt; $PID_FILE</span>
      <span class="no">  </span>
    <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">MESSAGE</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:config(&quot;message&quot;)</span>
      <span class="l-Scalar-Plain">NETCAT_PORT</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:attributeWhenReady(&quot;netcat.port&quot;)</span>
      
    <span class="l-Scalar-Plain">brooklyn.parameters</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">message</span>
      <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">a message to send to the caller</span>
      <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hello</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">netcat.port</span>
      <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">port</span>
      <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">the port netcat should run on</span>
      <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4321+</span>

    <span class="l-Scalar-Plain">brooklyn.enrichers</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.enricher.stock.Transformer</span>
      <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">uniqueTag</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">main-uri-generator</span>
        <span class="l-Scalar-Plain">enricher.sourceSensor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:sensor(&quot;host.address&quot;)</span>
        <span class="l-Scalar-Plain">enricher.targetSensor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:sensor(&quot;main.uri&quot;)</span>
        <span class="l-Scalar-Plain">enricher.targetValue</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">$brooklyn:formatString</span><span class="p-Indicator">:</span>
          <span class="p-Indicator">-</span> <span class="s">&quot;http://%s:%s/&quot;</span>
          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">$brooklyn:attributeWhenReady(&quot;host.address&quot;)</span>
          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">$brooklyn:attributeWhenReady(&quot;netcat.port&quot;)</span></code></pre></div>

<p>This is the same example as in the previous section, wrapped according to the catalog YAML requirements,
with one new block added defining an enricher. An enricher creates a new sensor from other values;
in this case it will create a <code>main.uri</code> sensor by populating a <code>printf</code>-style string <code>"http://%s:%s"</code>
with the sensor values.</p>

<p>With this added to the catalog, we can reference the type <code>netcat-example</code> when we deploy an application.
Return to the <em>Home</em> or <em>Applications</em> tab, click <em>+</em>, and submit this YAML blueprint:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Netcat Type Reference Example</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">netcat-example</span>
  <span class="l-Scalar-Plain">message</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hello from netcat using a registered type</span></code></pre></div>

<p>This extends the previous blueprint which we registered in the catalog,
meaning that we don’t need to include it each time.
Here, we’ve elected to supply our own message, but we’ll use the default port.
More importantly, we can package it for others to consume – or take items others have built.</p>

<p>We can go further and use this to deploy a cluster,
this time giving a custom port as well as a custom message: </p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Netcat Cluster Example</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.group.DynamicCluster</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">dynamiccluster.memberspec</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">$brooklyn:entitySpec</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">netcat-example</span>
        <span class="l-Scalar-Plain">message</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hello from cluster member</span>
        <span class="l-Scalar-Plain">netcat.port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8000+</span>
    <span class="l-Scalar-Plain">cluster.initial.size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
    <span class="l-Scalar-Plain">restartMode</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">parallel</span></code></pre></div>

<p>In either of the above examples, if you explore the tree in the <em>Applications</em> view
and look at the <em>Summary</em> tab of any of the server instances, you’ll now see the URL where netcat is running.
But remember, netcat will stop after one run, so you’ll only be able to use each link once
before you have to restart it.  You can also run <code>restart</code> on the cluster,
and if you haven’t yet experimented with <code>resize</code> on the cluster you might want to do that.</p>

<h4 id="determining-successful-launch">Determining Successful Launch</h4>

<p>One requirement of the launch script is that it store the process ID (PID) in the file
pointed to by <code>$PID_FILE</code>, hence the second line of the script.
This is because Brooklyn wants to monitor the services under management.
You’ll observe this if you connect to one of the netcat services,
as the process exits afterwards and Brooklyn sets the entity to an <code>ON_FIRE</code> state.
(You can also test this with a <code>killall nc</code> before connecting
or issueing a <code>stop</code> command on the server – but not on the example,
as stopping an application root causes it to be removed altogether!) </p>

<p>There are other options for determining launch: you can set <code>checkRunning.command</code> and <code>stop.command</code> instead,
as documented on the javadoc and config keys of the <code>VanillaSoftwareProcess</code>
  (<a href="https://github.com/apache/brooklyn-server/tree/master/software/base/src/main/java/org/apache/brooklyn/entity/software/base/VanillaSoftwareProcess.java">src</a>)
 class,
and those scripts will be used instead of checking and stopping the process whose PID is in <code>$PID_FILE</code>.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Netcat Example with Explicit Check and Stop Commands</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.software.base.VanillaSoftwareProcess</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server</span>
  <span class="l-Scalar-Plain">launch.command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
    <span class="no">echo hello | nc -l 4321 &amp;</span>
    <span class="no">echo $! &gt; $PID_FILE</span>

  <span class="c1"># The following overrides demonstrate the use of a custom shell environment as well as</span>
  <span class="c1"># check-running and stop commands. These are optional; default behavior will &quot;do the</span>
  <span class="c1"># right thing&quot; with the pid file automatically.</span>

  <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>                  <span class="p-Indicator">{</span> <span class="nv">CHECK_MARKER</span><span class="p-Indicator">:</span> <span class="s">&quot;checkRunning&quot;</span><span class="p-Indicator">,</span> <span class="nv">STOP_MARKER</span><span class="p-Indicator">:</span> <span class="s">&quot;stop&quot;</span> <span class="p-Indicator">}</span>
  <span class="l-Scalar-Plain">checkRunning.command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">echo $CHECK_MARKER &gt;&gt; DATE &amp;&amp; test -f &quot;$PID_FILE&quot; &amp;&amp; ps -p `cat $PID_FILE` &gt;/dev/null</span>
  <span class="l-Scalar-Plain">stop.command</span><span class="p-Indicator">:</span>         <span class="l-Scalar-Plain">echo $STOP_MARKER  &gt;&gt; DATE &amp;&amp; test -f &quot;$PID_FILE&quot; &amp;&amp; { kill -9 `cat $PID_FILE`; rm /tmp/vanilla.pid; }</span></code></pre></div>

<p>And indeed, once you’ve run one <code>telnet</code> to the server, you’ll see that the 
service has gone “on fire” in Brooklyn – because the <code>nc</code> process stops after one run. </p>

<h4 id="attaching-policies">Attaching Policies</h4>

<p>Besides detecting this failure, Brooklyn policies can be added to the YAML to take appropriate 
action. A simple recovery here might just to automatically restart the process:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Netcat Example with Restarter Policy</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.software.base.VanillaSoftwareProcess</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">netcat-server</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server</span>
  <span class="l-Scalar-Plain">launch.command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
    <span class="no">echo hello | nc -l 4321 &amp;</span>
    <span class="no">echo $! &gt; $PID_FILE</span>
  <span class="l-Scalar-Plain">brooklyn.enrichers</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.policy.ha.ServiceFailureDetector</span>
    <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
      <span class="c1"># wait 15s after service fails before propagating failure</span>
      <span class="l-Scalar-Plain">serviceFailedStabilizationDelay</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">15s</span>
  <span class="l-Scalar-Plain">brooklyn.policies</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.policy.ha.ServiceRestarter</span>
    <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
      <span class="c1"># repeated failures in a time window can cause the restarter to abort,</span>
      <span class="c1"># propagating the failure; a time window of 0 will mean it always restarts!</span>
      <span class="l-Scalar-Plain">failOnRecurringFailuresInThisDuration</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span></code></pre></div>

<p>Autonomic management in Brooklyn often follows the principle that complex behaviours emerge
from composing simple policies.
The blueprint above uses one policy to triggering a failure sensor when the service is down,
and another responds to such failures by restarting the service.
This makes it easy to configure various aspects, such as to delay to see if the service itself recovers
(which here we’ve set to 15 seconds) or to bail out on multiple failures within a time window (which again we are not doing).
Running with this blueprint, you’ll see that the service shows as on fire for 15s after a <code>telnet</code>,
before the policy restarts it. </p>

<h3 id="sensors-and-effectors">Sensors and Effectors</h3>

<p>For an even more interesting way to test it, look at the blueprint defining
<a href="example_yaml/vanilla-bash-netcat-w-client.yaml">a netcat server and client</a>.
This uses <code>initializers</code> to define an effector to <code>sayHiNetcat</code> on the <code>Simple Pinger</code> client,
using <code>env</code> variables to inject the <code>netcat-server</code> location and 
<code>parameters</code> to pass in per-effector data:</p>

<pre><code>  env:
    TARGET_HOSTNAME: $brooklyn:entity("netcat-server").attributeWhenReady("host.name")
  brooklyn.initializers:
  - type: org.apache.brooklyn.core.effector.ssh.SshCommandEffector
    brooklyn.config:
      name: sayHiNetcat
      description: Echo a small hello string to the netcat entity
      command: |
        echo $message | nc $TARGET_HOSTNAME 4321
      parameters:
        message:
          description: The string to pass to netcat
          defaultValue: hi netcat
</code></pre>

<p>This blueprint also uses initializers to define sensors on the <code>netcat-server</code> entity
so that the <code>$message</code> we passed above gets logged and reported back:</p>

<pre><code>  launch.command: |
    echo hello | nc -l 4321 &gt;&gt; server-input &amp;
    echo $! &gt; $PID_FILE
  brooklyn.initializers:
  - type: org.apache.brooklyn.core.sensor.ssh.SshCommandSensor
    brooklyn.config:
      name: output.last
      period: 1s
      command: tail -1 server-input
</code></pre>

<h5 id="windows-command-sensor">Windows Command Sensor</h5>

<p>Like the blueprint above, the following example also uses brooklyn.initializers to define sensors on the entity,
this time however it is a windows VM and uses <code>WinRmCommandSensor</code>.</p>

<pre><code>- type: org.apache.brooklyn.entity.software.base.VanillaWindowsProcess
  brooklyn.config:
    launch.command: echo launching
    checkRunning.command: echo running
  brooklyn.initializers:
  - type: org.apache.brooklyn.core.sensor.windows.WinRmCommandSensor
    brooklyn.config:
      name: ip.config
      period: 60s
      command: hostname
</code></pre>

<h4 id="summary">Summary</h4>

<p>These examples are relatively simple example, but they
illustrate many of the building blocks used in real-world blueprints,
and how they can often be easily described and combined in Brooklyn YAML blueprints.
Next, if you need to drive off-piste, or you want to write tests against these blueprints,
have a look at, for example, <code>VanillaBashNetcatYamlTest.java</code> in the Brooklyn codebase,
or follow the other references below.</p>

            </div>

            <aside class="col-md-3">
                <div class="list-group side-menu" id="side-menu">



  
     
              
                  <h4 class=" with_following">
                    <a href="/brooklyn-docs/v/latest/index.html" class="list-group-item breadcrumb breadcrumb0">
                      User Guide
                      </a></h4>
              
                  <h4 class=" with_preceding">
                    <a href="/brooklyn-docs/v/latest/blueprints/index.html" class="list-group-item breadcrumb breadcrumb1">
                      Writing Blueprints
                      </a></h4>
              
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/creating-yaml.html" class="list-group-item">The Basic Structure
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/entity-configuration.html" class="list-group-item">Entity Configuration
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/setting-locations.html" class="list-group-item">Setting Locations
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/configuring-vms.html" class="list-group-item">Configuring VMs
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/multiple-services.html" class="list-group-item">Multiple Services and Dependency Injection
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/custom-entities.html" class="list-group-item active">Custom Entities
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/catalog/index.html" class="list-group-item">Catalog
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/clusters.html" class="list-group-item">Clusters, Specs, and Composition
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/enrichers.html" class="list-group-item">Enrichers
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/policies.html" class="list-group-item">Policies
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/clusters-and-policies.html" class="list-group-item">Clusters and Policies
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/java/index.html" class="list-group-item">Java Entities
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/winrm/index.html" class="list-group-item">Windows Blueprints
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/test/index.html" class="list-group-item">Testing YAML Blueprints
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/ansible/index.html" class="list-group-item">Ansible in YAML Blueprints
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/chef/index.html" class="list-group-item">Chef in YAML Blueprints
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/salt/index.html" class="list-group-item">Salt in YAML Blueprints
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/advanced-example.html" class="list-group-item">YAML Blueprint Advanced Example
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/blueprinting-tips.html" class="list-group-item">Blueprinting Tips
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/yaml-reference.html" class="list-group-item">YAML Blueprint Reference
                    </a>
                
              
        
        
  

        
</div>
<div id="width_reference"></div>


<script language="JavaScript" type="application/javascript">
(function($){
    
    sidemenu_x_sizer=function(){ $('#side-menu').width($('#side-menu').parent().find('#width_reference').outerWidth()); };
    $(sidemenu_x_sizer);
    $(window).resize(sidemenu_x_sizer);

    
    sidemenu_y_nonfloater=function(){
      if ($('#side-menu').outerHeight(true) + $('#header').outerHeight(true) + $('#footer').outerHeight(true) > window.innerHeight ||
          $('#side-menu').width() >= $('#content_container').width()/2) {
        $('#side-menu').css('position', 'inherit');
      } else {
        // restore if screen has grown
        $('#side-menu').css('position', 'fixed');
      }
    };
    $(sidemenu_y_nonfloater);
    $(window).resize(sidemenu_y_nonfloater);

    

    var sideMenu = $("#side-menu"),
        sideItems = sideMenu.find("a"),
        // Anchors corresponding to menu items
        scrollItems = sideItems.map(function(){
          var item = $(this).attr("section-target");
          if (item && item.length) { return item; }
        });

    var highlight_section_last_top = -1;
    var highlight_section_completed = false;

    var highlight_section = function() {
       // Get container scroll position
       var highlight_section_new_top = $(this).scrollTop();
       if (highlight_section_new_top == highlight_section_last_top) return;
       var highlight_section_new_bottom = highlight_section_new_top + $(window).height();
       var scroll_advancing = (highlight_section_new_top > highlight_section_last_top);

       var last_item = null, active_item = $("#side-menu a.section#active");

       var found_top = false;
       var displayable_items = scrollItems.map(function(itemI){
         item = $(scrollItems[itemI]);
         if (item && item.length) {
           if (highlight_section_last_top == -1 || !highlight_section_completed) {
             // just opening page - take item matching hash, or otherwise the first item visible
             if (item.selector === window.location.hash || (item.offset().top > highlight_section_new_top - 20 && !found_top)) {
               found_top = true;
               if (item.selector === window.location.hash && item.offset().top < highlight_section_new_top + 60) {
                 // because of our top header, we need to scroll 64px down from any link
                 $('html, body').animate({scrollTop: item.offset().top - 64}, 0);
               }
               return item;
             }
           } else if (scroll_advancing) {
             // if scrolling advance, pick up a section when title starts before 1/3 height
             if (item.offset().top < highlight_section_new_top + $(window).height()/3)
               return item;

             // or if containing div is finished (usu the whole main content)
             div_containing_item = item.closest("div");
             if (div_containing_item.offset().top + div_containing_item.height() < highlight_section_new_bottom + 15)
               return item;
             // or when next title is visible
             if (last_item && item.offset().top < highlight_section_new_bottom + 15)
               return last_item;
           } else {
             // if scrolling back, pick up a section as soon as the title is visible,
             if (item.offset().top < highlight_section_new_top)
               return item;
             // or if title is before the 2/3 point
             // (not sure about this, probably want also to have
             // "AND the id.top is <= displayable_itemsrent_active_it.top" so we don't jump FORWARD a section
             // when scrolling BACK, with lots of tiny sections)
             if ((item.offset().top < highlight_section_new_top + 2*$(window).height()/3)
                 && (!active_item || !active_item.offset() || active_item.offset().top >= item.offset().top))
               return item;

           }
           last_item = item;
         }
       });
       if (!highlight_section_completed && document.readyState === "complete") {
         highlight_section_completed = true;
       }
       if (!displayable_items.length) {
         $("#side-menu a.section").removeClass("active");
       } else {
         displayable_items = displayable_items[displayable_items.length-1];
         var id = displayable_items && displayable_items.length ? displayable_items[0].id : "";
       // Set/remove active class
         new_active = $("#side-menu a.section").filter("[section-target='#"+id+"']");
         if (new_active.hasClass("active")) {
           // nothing needed
         } else {
           $("#side-menu a.section").removeClass("active");
           $("#side-menu a.section").filter("[section-target='#"+id+"']").addClass("active");
         }
       }

       highlight_section_last_top = highlight_section_new_top;
    };
    var highlight_new_section = function() {
      highlight_section_completed = false;
      highlight_section_last_top = -1;
      highlight_section();
    }

    $(window).scroll(highlight_section);
    $(highlight_new_section);

    // detect link change - courtesy http://www.bennadel.com/blog/1520-binding-events-to-non-dom-objects-with-jquery.htm

    // Default to the current location.
    var strLocation = window.location.href;
    var strHash = window.location.hash;
    var strPrevLocation = "";
    var strPrevHash = "";

    // This is how often we will be checkint for
    // changes on the location.
    var intIntervalTime = 100;

    // This method removes the pound from the hash.
    var fnCleanHash = function( strHash ){
        return(
            strHash.substring( 1, strHash.length )
            );
    }

    // This will be the method that we use to check
    // changes in the window location.
    var fnCheckLocation = function(){
        // Check to see if the location has changed.
        if (strLocation != window.location.href){

            // Store the new and previous locations.
            strPrevLocation = strLocation;
            strPrevHash = strHash;
            strLocation = window.location.href;
            strHash = window.location.hash;

            // The location has changed. Trigger a
            // change event on the location object,
            // passing in the current and previous
            // location values.
            $( window.location ).trigger(
                "change",
                {
                    currentHref: strLocation,
                    currentHash: fnCleanHash( strHash ),
                    previousHref: strPrevLocation,
                    previousHash: fnCleanHash( strPrevHash )
                }
                );

        }
    }

    // Set an interval to check the location changes.
    setInterval( fnCheckLocation, intIntervalTime );

    // and trigger highlight section on link change
    $(window.location).bind("change", highlight_new_section);
})(jQuery);

</script>

            </aside>
        </div>
    </div>
</main>

<footer class="container">
    <div class="row">
        <div class="col-md-9">
            <p>Apache Brooklyn is distributed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License v2.0</a>.</p>
        </div>
        <div class="col-md-3 text-right">
            <p>
                <a class="btn btn-sm btn-default" href="https://github.com/apache/brooklyn-docs/edit/master/guide/blueprints/custom-entities.md">Edit This Page</a>
                <a href="https://brooklyn.apache.org/community/how-to-contribute-docs.html"
                    data-toggle="tooltip" data-placement="top" title="" data-delay="400" data-original-title="How to Edit Documentation">
                    <span class="octicon octicon-question octicon-footer"></span>
                </a>
            </p>
        </div>
    </div>
</footer>

</body>

<!--
  ~ Licensed to the Apache Software Foundation (ASF) under one
  ~ or more contributor license agreements.  See the NOTICE file
  ~ distributed with this work for additional information
  ~ regarding copyright ownership.  The ASF licenses this file
  ~ to you under the Apache License, Version 2.0 (the
  ~ "License"); you may not use this file except in compliance
  ~ with the License.  You may obtain a copy of the License at
  ~
  ~      http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing,
  ~ software distributed under the License is distributed on an
  ~ "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~ KIND, either express or implied.  See the License for the
  ~ specific language governing permissions and limitations
  ~ under the License.
  -->

<script type="text/javascript" src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/brooklyn-docs/style/deps/jquery.cookie.js"></script>
<script type="text/javascript" src="/brooklyn-docs/style/js/zeroclipboard/ZeroClipboard.min.js"></script>
<script type="text/javascript" src="/brooklyn-docs/style/deps/tooltip.js"></script>

<script type="text/javascript">
    ZeroClipboard.config({ moviePath: '/style/js/zeroclipboard/ZeroClipboard.swf' });
</script>
<script src="/brooklyn-docs/style/js/public.js"></script>
</html>
