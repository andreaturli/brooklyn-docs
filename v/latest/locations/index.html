<!--
  ~ Licensed to the Apache Software Foundation (ASF) under one
  ~ or more contributor license agreements.  See the NOTICE file
  ~ distributed with this work for additional information
  ~ regarding copyright ownership.  The ASF licenses this file
  ~ to you under the Apache License, Version 2.0 (the
  ~ "License"); you may not use this file except in compliance
  ~ with the License.  You may obtain a copy of the License at
  ~
  ~      http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing,
  ~ software distributed under the License is distributed on an
  ~ "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~ KIND, either express or implied.  See the License for the
  ~ specific language governing permissions and limitations
  ~ under the License.
  -->

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Locations - Apache Brooklyn</title>

<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/octicons/octicons.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/bootstrap-theme.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/font-awesome-4.2.0/css/font-awesome.min.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/tooltip.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/css/code.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/css/website.css" rel="stylesheet" />

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
</head>

<body class="page">
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <div class="navbar-brand">
                <a class="brand-apache" href="http://www.apache.org/">
                    <img src="https://www.apache.org/foundation/press/kit/feather.svg" alt="[Apache]">
                </a>
                
                <a class="brand-brooklyn" href="/brooklyn-docs/"><img src="/brooklyn-docs/style/img/apache-brooklyn-logo-244px-wide.png" alt="brooklyn"></a>
                
            </div>
        </div>
        <div class="collapse navbar-collapse" id="main-menu">


            <ul class="nav navbar-nav navbar-right">
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/learnmore/index.html" data-toggle="dropdown">learn more <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/learnmore/index.html">Learn More</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/blueprint-tour.html">Blueprint Tour
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/features/index.html">Features
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/theory.html">Theory
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/catalog/index.html">Browse Catalog
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/v/latest/start/index.html" data-toggle="dropdown">get started <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/v/latest/start/index.html">Get Started</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/running.html">Running Apache Brooklyn
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/blueprints.html">Deploying Blueprints
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/managing.html">Monitoring and Managing Applications
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/policies.html">Policies
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/concept-quickstart.html">Brooklyn Concepts Quickstart
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/documentation/index.html" data-toggle="dropdown">documentation <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/documentation/index.html">Documentation</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li class="section">
                            <a href="/brooklyn-docs/v/latest/index.html">User Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/blueprints/creating-yaml.html">Writing Blueprints
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/locations/index.html">Deploying Blueprints
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li class="section">
                            <a href="/brooklyn-docs/v/latest/ops/index.html">Reference Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/dev/index.html">Developer Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        <li class="divider"></li>
                        <li >
                            <a href="/brooklyn-docs/meta/versions.html">Versions
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/documentation/other-docs.html">Other Resources
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/community/index.html" data-toggle="dropdown">community <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/community/index.html">Community</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/mailing-lists.html">Mailing Lists
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/irc.html">IRC
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/security/index.html">Security Advisories
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="https://issues.apache.org/jira/browse/BROOKLYN">Bug Tracker (JIRA)
                                &nbsp;<span class="octicon octicon-link-external"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/how-to-contribute-docs.html">Contributing Documentation
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/developers/index.html" data-toggle="dropdown">developers <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/developers/index.html">Developers</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/code/index.html">Get the Code
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/how-to-contribute.html">How to Contribute
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/dev/index.html">Developer Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/committers/index.html">Committer Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/code-standards.html">Code Standards
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/links.html">Handy Places
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="http://github.com/apache/brooklyn">GitHub
                                &nbsp;<span class="octicon octicon-link-external"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="https://issues.apache.org/jira/browse/BROOKLYN">Bug Tracker (JIRA)
                                &nbsp;<span class="octicon octicon-link-external"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <form class="navbar-form">
                        <a href="/brooklyn-docs/download/index.html" class="btn btn-default">download</a>
                    </form>
                    
                </li>
                
            </ul>
        </div>
    </div>
</nav>


<main>
    <div class="container">
        <div class="row">
            <div class="col-md-9 content">
                <div id="page_notes"></div>
                <h1>Locations</h1>
                <p>Locations are the environments to which Brooklyn deploys applications. Most commonly these 
are cloud services such as AWS, GCE, and IBM Softlayer. Brooklyn also supports deploying 
to a pre-provisioned network or to localhost (primarily useful for testing blueprints).</p>

<p>See also:</p>

<ul>
  <li>The <a href="/brooklyn-docs/v/latest/blueprints/setting-locations.html">Locations yaml guide</a></li>
  <li>Use within an entity of the configuration option 
<a href="/brooklyn-docs/v/latest/blueprints/entity-configuration.html#entity-provisioningproperties-overriding-and-merging">provisioning.properties</a></li>
  <li>How to add location definitions to the <a href="/brooklyn-docs/v/latest/blueprints/catalog/">Catalog</a>; and </li>
  <li>How to use <a href="/brooklyn-docs/v/latest/ops/externalized-configuration.html">Externalized Configuration</a>.</li>
</ul>

<h3 id="clouds">Clouds</h3>

<p>For most cloud provisioning tasks, Brooklyn uses
<a href="http://jclouds.org">Apache jclouds</a>.
The identifiers for some of the most commonly used jclouds-supported clouds are
(or <a href="http://jclouds.apache.org/reference/providers/">see the full list</a>):</p>

<ul>
  <li><code>jclouds:aws-ec2:&lt;region&gt;</code>: Amazon EC2, where <code>:&lt;region&gt;</code> might be <code>us-east-1</code> or <code>eu-west-1</code> (or omitted)</li>
  <li><code>jclouds:softlayer:&lt;region&gt;</code>: IBM Softlayer, where <code>:&lt;region&gt;</code> might be <code>dal05</code> or <code>ams01</code> (or omitted)</li>
  <li><code>jclouds:google-compute-engine</code>: Google Compute Engine</li>
  <li><code>jclouds:openstack-nova:&lt;endpoint&gt;</code>: OpenStack, where <code>:&lt;endpoint&gt;</code> is the access URL (required)</li>
  <li><code>jclouds:cloudstack:&lt;endpoint&gt;</code>: Apache CloudStack, where <code>:&lt;endpoint&gt;</code> is the access URL (required)</li>
</ul>

<p>For any of these, of course, Brooklyn needs to be configured with an <code>identity</code> and a <code>credential</code>:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">jclouds:aws-ec2</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">identity</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ABCDEFGHIJKLMNOPQRST</span>
    <span class="l-Scalar-Plain">credential</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">s3cr3tsq1rr3ls3cr3tsq1rr3ls3cr3tsq1rr3l</span></code></pre></div>

<p>The above YAML can be embedded directly in blueprints, either at the root or on individual services.
If you prefer to keep the credentials separate, you can instead store them as a <a href="/brooklyn-docs/v/latest/blueprints/catalog/index.html#locations-in-catalog">catalog entry</a> or set them in <code>brooklyn.properties</code>
in the <code>jclouds.&lt;provider&gt;</code> namespace:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">brooklyn.location.jclouds.aws-ec2.identity<span class="o">=</span>ABCDEFGHIJKLMNOPQRST  
brooklyn.location.jclouds.aws-ec2.credential<span class="o">=</span>s3cr3tsq1rr3ls3cr3tsq1rr3ls3cr3tsq1rr3l</code></pre></div>

<p>And in this case you can reference the location in YAML with <code>location: jclouds:aws-ec2</code>.</p>

<p>Alternatively, you can use the location wizard tool available within the web console
to create any cloud location supported by <a href="http://jclouds.org">Apache jclouds</a>.
This location will be saved as a <a href="/brooklyn-docs/v/latest/blueprints/catalog/index.html#locations-in-catalog">catalog entry</a> for easy reusability.</p>

<p>Brooklyn irons out many of the differences between clouds so that blueprints run similarly
in a wide range of locations, including setting up access and configuring images and machine specs.
The configuration options are described in more detail below.</p>

<p>In some cases, cloud providers have special features or unusual requirements. 
These are outlined in <strong><a href="#more-details-on-specific-clouds">More Details for Specific Clouds</a></strong>.</p>

<h4 id="os-initial-login-and-setup">OS Initial Login and Setup</h4>

<p>Once a machine is provisioned, Brooklyn will normally attempt to log in via SSH and configure the machine sensibly.</p>

<p>The credentials for the initial OS log on are typically discovered from the cloud, 
but in some environments this is not possible.
The keys <code>loginUser</code> and either <code>loginUser.password</code> or <code>loginUser.privateKeyFile</code> can be used to force
Brooklyn to use specific credentials for the initial login to a cloud-provisioned machine.</p>

<p>(This custom login is particularly useful when using a custom image templates where the cloud-side account 
management logic is not enabled. For example, a vCloud (vCD) template can have guest customization that will change
the root password. This setting tells Apache Brooklyn to only use the given password, rather than the initial 
randomly generated password that vCD returns. Without this property, there is a race for such templates:
does Brooklyn manage to create the admin user before the guest customization changes the login and reboots,
or is the password reset first (the latter means Brooklyn can never ssh to the VM). With this property, 
Brooklyn will always wait for guest customization to complete before it is able to ssh at all. In such
cases, it is also recommended to use <code>useJcloudsSshInit=false</code>.)</p>

<p>Following a successful logon, Brooklyn performs the following steps to configure the machine:</p>

<ol>
  <li>
    <p>creates a new user with the same name as the user <code>brooklyn</code> is running as locally
  (this can be overridden with <code>user</code>, below).</p>
  </li>
  <li>
    <p>install the local user’s <code>~/.ssh/id_rsa.pub</code> as an <code>authorized_keys</code> on the new machine,
to make it easy for the operator to <code>ssh</code> in
(override with <code>privateKeyFile</code>; or if there is no <code>id_{r,d}sa{,.pub}</code> an ad hoc keypair will be generated
for the regular Brooklyn user;
if there is a passphrase on the key, this must be supplied)  </p>
  </li>
  <li>
    <p>give <code>sudo</code> access to the newly created user (override with <code>grantUserSudo: false</code>)</p>
  </li>
  <li>
    <p>disable direct <code>root</code> login to the machine</p>
  </li>
</ol>

<p>These steps can be skipped or customized as described below.</p>

<h4 id="jclouds-config-keys">jclouds Config Keys</h4>

<p>The following is a subset of the most commonly used configuration keys used to customize 
cloud provisioning.
For more keys and more detail on the keys below, see 
<code>JcloudsLocationConfig</code>
  (<a href="https://github.com/apache/brooklyn-server/tree/master/locations/jclouds/src/main/java/org/apache/brooklyn/location/jclouds/JcloudsLocationConfig.java">src</a>)
.</p>

<h6 id="vm-creation">VM Creation</h6>

<ul>
  <li>
    <p>Most providers require exactly one of either <code>region</code> (e.g. <code>us-east-1</code>) or <code>endpoint</code> (the URL, usually for private cloud deployments)</p>
  </li>
  <li>
    <p>Hardware requirements can be specified, including 
<code>minRam</code>, <code>minCores</code>, and <code>os64Bit</code>; or as a specific <code>hardwareId</code></p>
  </li>
  <li>
    <p>VM image constraints can be set using <code>osFamily</code> (e.g. <code>Ubuntu</code>, <code>CentOS</code>, <code>Debian</code>, <code>RHEL</code>)
and <code>osVersionRegex</code>, or specific VM images can be specified using <code>imageId</code> or <code>imageNameRegex</code></p>
  </li>
  <li>
    <p>Specific VM images can be specified using <code>imageId</code> or <code>imageNameRegex</code></p>
  </li>
  <li>
    <p>Specific Security Groups can be specified using <code>securityGroups</code>, as a list of strings (the existing security group names),
or <code>inboundPorts</code> can be set, as a list of numeric ports (selected clouds only)</p>
  </li>
  <li>
    <p>Where a key pair is registered with a target cloud for logging in to machines,
Brooklyn can be configured to request this when provisioning VMs by setting <code>keyPair</code> (selected clouds only). 
Note that if this <code>keyPair</code> does not correspond your default <code>~/.ssh/id_rsa</code>, you must typically 
also specify the corresponding <code>loginUser.privateKeyFile</code> as a file or URL accessible from Brooklyn.</p>
  </li>
  <li>
    <p>A specific VM name (often the hostname) base to be used can be specified by setting <code>groupId</code>.
By default, this name is constructed based on the entity which is creating it,
including the ID of the app and of the entity.
(As many cloud portals let you filter views, this can help find a specific entity or all machines for a given application.)
For more sophisticated control over host naming, you can supply a custom 
<code>CloudMachineNamer</code>
(<a href="https://github.com/apache/brooklyn-server/tree/master/core/src/main/java/org/apache/brooklyn/core/location/cloud/names/CloudMachineNamer.java">src</a>)
,
for example
<code>cloudMachineNamer: CustomMachineNamer</code>.
<code>CustomMachineNamer</code>
(<a href="https://github.com/apache/brooklyn-server/tree/master/core/src/main/java/org/apache/brooklyn/core/location/cloud/names/CustomMachineNamer.java">src</a>)</p>

    <p>will use the entity’s name or following a template you supply.
On many clouds, a random suffix will be appended to help guarantee uniqueness;
this can be removed by setting <code>vmNameSaltLength: 0</code> (selected clouds only).
<!-- TODO jclouds softlayer includes a 3-char hex suffix --></p>
  </li>
  <li>
    <p>A DNS domain name where this host should be placed can be specified with <code>domainName</code>
(in selected clouds only)</p>
  </li>
  <li>
    <p>User metadata can be attached using the syntax <code>userMetadata: { key: value, key2: "value 2" }</code> 
(or <code>userMetadata=key=value,key2="value 2"</code> in a properties file)</p>
  </li>
  <li>
    <p>By default, several pieces of user metadata are set to correlate VMs with Brooklyn entities,
prefixed with <code>brooklyn-</code>.
This user metadata can be omitted by setting <code>includeBrooklynUserMetadata: false</code>.</p>
  </li>
  <li>
    <p>You can specify the number of attempts Brooklyn should make to create
machines with <code>machineCreateAttempts</code> (jclouds only). This is useful as an efficient low-level fix
for those occasions when cloud providers give machines that are dead on arrival.
You can of course also resolve it at a higher level with a policy such as 
<code>ServiceRestarter</code>
(<a href="https://github.com/apache/brooklyn-server/tree/master/policy/src/main/java/org/apache/brooklyn/policy/ha/ServiceRestarter.java">src</a>)
.</p>
  </li>
  <li>
    <p>If you want to investigate failures, set <code>destroyOnFailure: false</code>
to keep failed VM’s around. (You’ll have to manually clean them up.)
The default is false: if a VM fails to start, or is never ssh’able, then the VM will be terminated.</p>
  </li>
  <li>
    <p>You can set <code>useMachinePublicAddressAsPrivateAddress</code> to true to overwrite the VMs private IP with its public IP. This is useful as it can be difficult to get VMs communicating via the private IPs they are assigned in some clouds.  Using this config, blueprints which use private IPs can still be deployed to these clouds.</p>

    <h6 id="os-setup">OS Setup</h6>
  </li>
  <li>
    <p><code>user</code> and <code>password</code> can be used to configure the operating user created on cloud-provisioned machines</p>
  </li>
  <li>
    <p>The <code>loginUser</code> config key (and subkeys) control the initial user to log in as,
in cases where this cannot be discovered from the cloud provider</p>
  </li>
  <li>
    <p>Private keys can be specified using <code>privateKeyFile</code>; 
these are not copied to provisioned machines, but are required if using a local public key
or a pre-defined <code>authorized_keys</code> on the server.
(For more information on SSH keys, see <a href="#ssh-keys">here</a>.) </p>
  </li>
  <li>
    <p>If there is a passphrase on the key file being used, you must supply it to Brooklyn for it to work, of course!
<code>privateKeyPassphrase</code> does the trick (as in <code>brooklyn.location.jclouds.privateKeyPassphrase</code>, or other places
where <code>privateKeyFile</code> is valid).  If you don’t like keys, you can just use a plain old <code>password</code>.</p>
  </li>
  <li>
    <p>Public keys can be specified using <code>publicKeyFile</code>, 
although these can usually be omitted if they follow the common pattern of being
the private key file with the suffix <code>.pub</code> appended.
(It is useful in the case of <code>loginUser.publicKeyFile</code>, where you shouldn’t need,
or might not even have, the private key of the <code>root</code> user when you log in.)</p>
  </li>
  <li>
    <p>Provide a list of URLs to public keys in <code>extraSshPublicKeyUrls</code>,
or the data of one key in <code>extraSshPublicKeyData</code>,
to have additional public keys added to the <code>authorized_keys</code> file for logging in.
(This is supported in most but not all locations.)</p>
  </li>
  <li>
    <p>Use <code>dontCreateUser</code> to have Brooklyn run as the initial <code>loginUser</code> (usually <code>root</code>),
without creating any other user.</p>
  </li>
  <li>
    <p>A post-provisioning <code>setup.script</code> can be specified to run an additional script, before making the <code>Location</code> 
available to entities. This may take the form of a URL of a script or a <a href="https://en.wikipedia.org/wiki/Data_URI_scheme">data URI</a>.
Note that if using a data URI it is usually a good idea to <a href="https://en.wikipedia.org/wiki/Base64">base64</a> this string to escape problem characters
in more complex scripts. The base64 encoded script should then be prefixed with <code>data:text/plain;base64,</code> to denote this. 
For example if you wanted to disable a yum repository called <code>reponame</code> prior to using the machine, you could use the following command:</p>

    <p><code>sudo yum-config-manager --disable reponame</code></p>

    <p>Base64 encoding can be done with a with a tool such as <a href="https://www.base64encode.org/">this</a> or a linux command such as:</p>

    <p><code>echo "sudo yum-config-manager --disable reponame" | base64</code></p>

    <p>With the base64 prefix this would then look like this:</p>

    <p><code>setup.script: data:text/plain;base64,c3VkbyB5dW0tY29uZmlnLW1hbmFnZXIgLS1kaXNhYmxlIHJlcG9uYW1l</code></p>

    <p>The <code>setup.script</code> can also take <a href="http://freemarker.org/">FreeMarker</a> variables in a <code>setup.script.vars</code>
property. Variables are set in the format <code>key1:value1,key2:value2</code> and used in the form <code>${key1}</code>. So for the above example:</p>

    <p><code>setup.script.vars: repository:reponame</code></p>

    <p>then</p>

    <p><code>setup.script: data:sudo yum-config-manager --disable ${repository}</code></p>

    <p>or encoded in base64:</p>

    <p><code>setup.script: data:text/plain;base64,c3VkbyB5dW0tY29uZmlnLW1hbmFnZXIgLS1kaXNhYmxlICR7cmVwb3NpdG9yeX0=</code></p>

    <p>This enables the name of the repository to be passed in to the script.</p>
  </li>
  <li>
    <p>Use <code>openIptables: true</code> to automatically configure <code>iptables</code>, to open the TCP ports required by
the software process. One can alternatively use <code>stopIptables: true</code> to entirely stop the
iptables service.</p>
  </li>
  <li>
    <p>Use <code>installDevUrandom: true</code> to fall back to using <code>/dev/urandom</code> rather than <code>/dev/random</code>. This setting
is useful for cloud VMs where there is not enough random entropy, which can cause <code>/dev/random</code> to be
extremely slow (causing <code>ssh</code> to be extremely slow to respond).</p>
  </li>
  <li>
    <p>Use <code>useJcloudsSshInit: false</code> to disable the use of the native jclouds support for initial commands executed 
on the VM (e.g. for creating new users, setting root passwords, etc.). Instead, Brooklyn’s ssh support will
be used. Timeouts and retries are more configurable within Brooklyn itself. Therefore this option is particularly 
recommended when the VM startup is unusual (for example, if guest customizations will cause reboots and/or will 
change login credentials).</p>
  </li>
  <li>
    <p>Use <code>brooklyn.ssh.config.noDeleteAfterExec: true</code> to keep scripts on the server after execution.
The contents of the scripts and the stdout/stderr of their execution are available in the Brooklyn web console,
but sometimes it can also be useful to have them on the box.
This setting prevents scripts executed on the VMs from being deleted on completion.
Note that some scripts run periodically so this can eventually fill a disk; it should only be used for dev/test. </p>
  </li>
</ul>

<h6 id="custom-template-options">Custom Template Options</h6>

<p>jclouds supports many additional options for configuring how a virtual machine is created and deployed, many of which
are for cloud-specific features and enhancements. Brooklyn supports some of these, but if what you are looking for is
not supported directly by Brooklyn, we instead offer a mechanism to set any parameter that is supported by the jclouds
template options for your cloud.</p>

<p>Part of the process for creating a virtual machine is the creation of a jclouds <code>TemplateOptions</code> object. jclouds
providers extends this with extra options for each cloud - so when using the AWS provider, the object will be of
type <code>AWSEC2TemplateOptions</code>. By <a href="https://jclouds.apache.org/reference/javadoc/2.0.x/org/jclouds/aws/ec2/compute/AWSEC2TemplateOptions.html">examining the source code</a>,
you can see all of the options available to you.</p>

<p>The <code>templateOptions</code> config key takes a map. The keys to the map are method names, and Brooklyn will find the method on
the <code>TemplateOptions</code> instance; it then invokes the method with arguments taken from the map value. If a method takes a
single parameter, then simply give the argument as the value of the key; if the method takes multiple parameters, the
value of the key should be an array, containing the argument for each parameter.</p>

<p>For example, here is a complete blueprint that sets some AWS EC2 specific options:</p>

<pre><code>location: AWS_eu-west-1
services:
- type: org.apache.brooklyn.entity.software.base.EmptySoftwareProcess
  provisioningProperties:
    templateOptions:
      subnetId: subnet-041c8373
      mapNewVolumeToDeviceName: ["/dev/sda1", 100, true]
      securityGroupIds: ['sg-4db68928']
</code></pre>

<p>Here you can see that we set three template options:</p>

<ul>
  <li><code>subnetId</code> is an example of a single parameter method. Brooklyn will effectively try to run the statement
<code>templateOptions.subnetId("subnet-041c88373");</code></li>
  <li><code>mapNewVolumeToDeviceName</code> is an example of a multiple parameter method, so the value of the key is an array.
Brooklyn will effectively true to run the statement <code>templateOptions.mapNewVolumeToDeviceName("/dev/sda1", 100, true);</code></li>
  <li><code>securityGroupIds</code> demonstrates an ambiguity between the two types; Brooklyn will first try to parse the value as
a multiple parameter method, but there is no method that matches this parameter. In this case, Brooklyn will next try
to parse the value as a single parameter method which takes a parameter of type <code>List</code>; such a method does exist so
the operation will succeed.</li>
</ul>

<p>If the method call cannot be matched to the template options available - for example if you are trying to set an AWS EC2
specific option but your location is an OpenStack cloud - then a warning is logged and the option is ignored.</p>

<h6 id="cloud-machine-naming">Cloud Machine Naming</h6>

<p>The name that Apache Brooklyn generates for your virtual machine will, by default, be based on your Apache Brooklyn server name and the IDs of the entities involved. This is the name you see in places such as the AWS console and will look something like:</p>

<pre><code>brooklyn-o8jql4-machinename-rkix-tomcat-wi-nca6-14b
</code></pre>

<p>If you have created a lot of virtual machines, this kind of naming may not be helpful. This can be changed using the following YAML in your location’s <code>brooklyn.config</code>:</p>

<pre><code>cloudMachineNamer: org.apache.brooklyn.core.location.cloud.names.CustomMachineNamer
custom.machine.namer.machine: My-Custom-Name-${entity.displayName}
</code></pre>

<p>A <a href="http://freemarker.org/">FreeMarker</a> format is used in <code>custom.machine.namer.machine</code> which can take values from places such as the launching entity or location.</p>

<p>The above example will create a name such as:</p>

<pre><code>My-Custom-Name-Tomcat
</code></pre>

<p>Allowing you to more easily identify your virtual machines.</p>

<h3 id="more-details-on-specific-clouds">More Details on Specific Clouds</h3>

<p>Clouds vary in the format of the identity, credential, endpoint, and region.
Some also have their own idiosyncracies.  More details for configuring some common clouds
is included below. You may also find these sources helpful:</p>

<ul>
  <li>The <strong><a href="/brooklyn-docs/v/latest/start/brooklyn.properties">template brooklyn.properties</a></strong> file
in the Getting Started guide
contains numerous examples of configuring specific clouds,
including the format of credentials and options for sometimes-fiddly private clouds.</li>
  <li>The <strong><a href="https://jclouds.apache.org/guides">jclouds guides</a></strong> describes low-level configuration
sometimes required for various clouds.</li>
</ul>

<h3 id="azure-compute-arm">Azure Compute ARM</h3>

<p>Azure Resource Manager (ARM) is a framework for deploying and managing applications across resources and managing groups of resources as single logical units on the Microsoft Azure cloud computing platform.</p>

<h4 id="setup-the-azure-credentials">Setup the Azure credentials</h4>

<p>Firstly, install and configure Azure CLI following <a href="https://docs.microsoft.com/en-us/azure/cli-install-nodejs">these steps</a>.</p>

<p>Using the Azure CLI, run the following commands to create a service principal</p>

<pre><code># Set mode to ARM
azure config mode arm

# Enter your Microsoft account credentials when prompted
azure login

# Set current subscription to create a service principal
azure account set &lt;Subscription-id&gt;

# Create an AAD application with your information.
azure ad app create --name &lt;name&gt; --password &lt;Password&gt; --home-page &lt;home-page&gt; --identifier-uris &lt;identifier-uris&gt;

# For example: azure ad app create --name "myappname"  --password abcd --home-page "https://myappwebsite" --identifier-uris "https://myappwebsite"

# Output will include a value for `Application Id`, which will be used for the live tests

# Create a Service Principal
azure ad sp create --applicationId &lt;Application-id&gt;

# Output will include a value for `Object Id`, to be used in the next step 
</code></pre>

<p>Run the following commands to assign roles to the service principal</p>

<pre><code># Assign roles for this service principal
azure role assignment create --objectId &lt;Object-id&gt; -o Contributor -c /subscriptions/&lt;Subscription-id&gt;/
</code></pre>

<p>Look up the the tenant Id</p>

<pre><code>azure account show -s &lt;Subscription-id&gt; --json

# output will be a JSON which will include the `Tenant id`
</code></pre>

<p>Verify service principal</p>

<pre><code>azure login -u &lt;Application-id&gt; -p &lt;Password&gt; --service-principal --tenant &lt;Tenant-id&gt;
</code></pre>

<h4 id="using-the-azure-arm-location">Using the Azure ARM Location</h4>

<p>Below is an example Azure ARM location in YAML which will launch a Ubuntu instance in south east asia:</p>

<pre><code>brooklyn.catalog:
  id: my-azure-arm-location
  name: "My Azure ARM location"
  itemType: location
  item:
    type: jclouds:azurecompute-arm
    brooklyn.config:
      identity: &lt;Application-id&gt;
      credential: &lt;Password&gt;
      endpoint: https://management.azure.com/subscriptions/&lt;Subscription-id&gt;
      oauth.endpoint: https://login.microsoftonline.com/&lt;Tenant-id&gt;/oauth2/token
  
      jclouds.azurecompute.arm.publishers: OpenLogic
      region: southeastasia
      loginUser: brooklyn
      templateOptions:
        overrideAuthenticateSudo: true 
</code></pre>

<p>Fill the values <code>&lt;Application-id&gt;</code>, <code>&lt;Password&gt;</code>, <code>&lt;Subscription-id&gt;</code> and <code>&lt;Tenant-id&gt;</code> in from the values generated when 
setting up your credentials. In addition; several keys, not required in other locations need to be specified in order to 
use the Azure Compute ARM location. These are:</p>

<pre><code>jclouds.azurecompute.arm.publishers: OpenLogic
</code></pre>

<p>The publishers is any item from the list available here: <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/virtual-machines-linux-cli-ps-findimage">https://docs.microsoft.com/en-us/azure/virtual-machines/virtual-machines-linux-cli-ps-findimage</a></p>

<pre><code>region: southeastasia    
</code></pre>

<p>The region is any region from the list available here: <a href="https://azure.microsoft.com/en-us/regions/">https://azure.microsoft.com/en-us/regions/</a></p>

<pre><code>loginUser: brooklyn
</code></pre>

<p>The loginUser can be anything, as long as it’s specified. </p>

<pre><code>templateOptions:
    overrideAuthenticateSudo: true
</code></pre>

<p>The <code>overrideAuthenticateSudo: true</code> key tells Apache Brooklyn that default on Azure images do not have passwordless sudo 
configured by default.</p>

<h4 id="known-issues">Known issues</h4>
<p>There are currently two known issues with Azure ARM:</p>

<ul>
  <li>It can take a long time for VMs to be provisioned</li>
  <li>The Azure ARM APIs appear to have some fairly strict rate limiting that can result in AzureComputeRateLimitExceededException</li>
</ul>

<h2 id="amazon-web-services-aws">Amazon Web Services (AWS)</h2>

<h3 id="credentials">Credentials</h3>

<p>AWS has an “access key” and a “secret key”, which correspond to Brooklyn’s identity and credential
respectively.</p>

<p>These keys are the way for any programmatic mechanism to access the AWS API.</p>

<p>To generate an access key and a secret key, see <a href="http://jclouds.apache.org/guides/aws">jclouds instructions</a>
and <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/ManagingCredentials.html">AWS IAM instructions</a>.</p>

<p>An example of the expected format is shown below:</p>

<pre><code>location:
  jclouds:aws-ec2:
    region: us-east-1
    identity: ABCDEFGHIJKLMNOPQRST
    credential: abcdefghijklmnopqrstu+vwxyzabcdefghijklm
</code></pre>

<p>Users are strongly recommended to use 
<a href="/brooklyn-docs/v/latest/ops/externalized-configuration.html">externalized configuration</a> for better
credential management, for example using <a href="https://www.vaultproject.io/">Vault</a>.</p>

<h3 id="common-configuration-options">Common Configuration Options</h3>

<p>Below are examples of configuration options that use values specific to AWS EC2:</p>

<ul>
  <li>
    <p>The <code>region</code> is the <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html">AWS region code</a>.
For example, <code>region: us-east-1</code>. You can in-line the region name using the following format: <code>jclouds:aws-ec2:us-east-1</code>.
A specific availability zone within the region can be specified by including its letter identifier as a suffix. 
For example, <code>region: us-east-1a</code>.</p>
  </li>
  <li>
    <p>The <code>hardwareId</code> is the <a href="https://aws.amazon.com/ec2/instance-types/">instance type</a>. For example,
<code>hardwareId: m4.large</code>.</p>
  </li>
  <li>
    <p>The <code>imageId</code> is the region-specific <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/finding-an-ami.html">AMI id</a>.
For example, <code>imageId: us-east-1/ami-05ebd06c</code>.</p>
  </li>
  <li>
    <p>The <code>securityGroups</code> option takes one or more names of pre-existing 
<a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-network-security.html">security groups</a>.
For example, <code>securityGroups: mygroup1</code> or <code>securityGroups: [ mygroup1, mygroup2 ]</code>.</p>
  </li>
</ul>

<h3 id="using-subnets-and-security-groups">Using Subnets and Security Groups</h3>

<p>Apache Brooklyn can run with AWS VPC and both public and private subnets.
Simply provide the <code>subnet-a1b2c3d4</code> as the <code>networkName</code> when deploying:</p>

<pre><code>location:
  jclouds:aws-ec2:
    region: us-west-1
    networkName: subnet-a1b2c3d4   # use your subnet ID
</code></pre>

<p>Subnets are typically used in conjunction with security groups.
Brooklyn does <em>not</em> attempt to open additional ports
when private subnets or security groups are supplied,
so the subnet and ports must be configured appropriately for the blueprints being deployed.
You can configure a default security group with appropriate (or all) ports opened for
access from the appropriate (or all) CIDRs and security groups,
or you can define specific <code>securityGroups</code> on the location
or as <code>provisioning.properties</code> on the entities.</p>

<p>Make sure that Brooklyn has access to the machines under management.
This includes SSH, which might be done with a public IP created with inbound access
on port 22 permitted for a CIDR range including the IP from which Brooklyn contacts it.
Alternatively you can run Brooklyn on a machine in that same subnet, or
set up a VPN or jumphost which Brooklyn will use.</p>

<h3 id="ec2-classic-problems-with-vpc-only-hardware-instance-types">EC2 “Classic” Problems with VPC-only Hardware Instance Types</h3>

<p>If you have a pre-2014 Amazon account, it is likely configured in some regions to run in “EC2 Classic” mode
by default, instead of the more modern “VPC” default mode.  This can cause failures when requesting certain hardware
configurations because many of the more recent hardware “instance types” only run in “VPC” mode.
For instance when requesting an instance with <code>minRam: 8gb</code>, Brooklyn may opt for an <code>m4.large</code>,
which is a VPC-only instance type. If you are in a region configured to use “EC2 Classic” mode,
you may see a message such as this:</p>

<pre><code>400 VPCResourceNotSpecified: The specified instance type can only be used in a VPC.
A subnet ID or network interface ID is required to carry out the request.
</code></pre>

<p>This is a limitation of “legacy” accounts.  The easiest fixes are either:</p>

<ul>
  <li>specify an instance type which is supported in classic, such as <code>m3.xlarge</code> (see below)</li>
  <li>move to a different region where VPC is the default
(<code>eu-central-1</code> should work as it <em>only</em> offers VPC mode,
irrespective of the age of your AWS account)</li>
  <li>get a new AWS account – “VPC” will be the default mode
(Amazon recommend this and if you want to migrate existing deployments
they provide <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/vpc-migrate.html">detailed instructions</a>)</li>
</ul>

<p>To understand the situation, the following resources may be useful:</p>

<ul>
  <li>Background on VPC vs Classic:  <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-vpc.html">http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-vpc.html</a></li>
  <li>Good succinct answers to FAQs: <a href="">http://aws.amazon.com/vpc/faqs/#Default_VPCs</a></li>
  <li>Check if a region in your account is “VPC” or “Classic”: <a href="">http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/default-vpc.html#default-vpc-availability</a></li>
  <li>Regarding instance types:
    <ul>
      <li>All instance types: <a href="">https://aws.amazon.com/ec2/instance-types</a></li>
      <li>Those which require VPC: <a href="">http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-vpc.html#vpc-only-instance-types</a></li>
    </ul>
  </li>
</ul>

<p>If you want to solve this problem with your existing account,
you can create a VPC and instruct Brooklyn to use it:</p>

<ol>
  <li>Use the “Start VPC Wizard” option in <a href="https://console.aws.amazon.com/vpc">the VPC dashboard</a>,
  making sure it is for the right region, and selecting a “Single Public Subnet”.
  (More information is in <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/get-set-up-for-amazon-ec2.html#create-a-vpc">these AWS instructions</a>.)</li>
  <li>Once the VPC is created, open the “Subnets” view and modify the “Public subnet”
so that it will “Auto-assign Public IP”.</li>
  <li>Next click on the “Security Groups” and find the <code>default</code> security group for that VPC.
Modify its “Inbound Rules” to allow “All traffic” from “Anywhere”.
(Or for more secure options, see the instructions in the previous section,
“Using Subnets”.)</li>
  <li>Finally make a note of the subnet ID (e.g. <code>subnet-a1b2c3d4</code>) for use in Brooklyn.</li>
</ol>

<p>You can then deploy blueprints to the subnet, allowing VPC hardware instance types,
by specifying the subnet ID as the <code>networkName</code> in your YAML blueprint.
This is covered in the previous section, “Using Subnets”.</p>

<h3 id="tidying-up-after-jclouds">Tidying up after jclouds</h3>

<p>Security groups are not always deleted by jclouds. This is due to a limitation in AWS (see
https://issues.apache.org/jira/browse/JCLOUDS-207). In brief, AWS prevents the security group
from being deleted until there are no VMs using it. However, there is eventual consistency for
recording which VMs still reference those security groups: after deleting the VM, it can sometimes
take several minutes before the security group can be deleted. jclouds retries for 3 seconds, but
does not block for longer.</p>

<p>Whilst there is eventual consistency for recording which VMs still reference security groups, after deleting a VM, it can sometimes take several minutes before a security group can be deleted</p>

<p>There is utility written by <a href="http://www.cloudsoft.io/">Cloudsoft</a> for deleting these unused resources:
<a href="http://blog.abstractvisitorpattern.co.uk/2013/03/tidying-up-after-jclouds.html">http://blog.abstractvisitorpattern.co.uk/2013/03/tidying-up-after-jclouds.html</a>.</p>

<h3 id="azure-compute-classic">Azure Compute Classic</h3>

<p>Azure is a cloud computing platform and infrastructure created by Microsoft. Apache Brooklyn includes support for both Azure Classic and Azure ARM, as
one of the <a href="http://jclouds.org">Apache jclouds</a> supported clouds <code>Microsoft Azure Compute</code>.</p>

<p>The two modes of using Azure are the “classic deployment” model and the newer “Azure Resource Manager” (ARM)
model. See <a href="https://azure.microsoft.com/en-gb/documentation/articles/resource-manager-deployment-model/">https://azure.microsoft.com/en-gb/documentation/articles/resource-manager-deployment-model/</a>
for details.</p>

<h4 id="setup-the-azure-credentials-1">Setup the Azure credentials</h4>

<p>Microsoft Azure requests are signed by SSL certificate. You need to upload one into your account in order to use an Azure
location.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># create the certificate request</span>
mkdir -m <span class="m">700</span> <span class="nv">$HOME</span>/.brooklyn
openssl req -x509 -nodes -days <span class="m">365</span> -newkey rsa:1024 -keyout <span class="nv">$HOME</span>/.brooklyn/azure.pem -out <span class="nv">$HOME</span>/.brooklyn/azure.pem
<span class="c"># create the p12 file, and note your export password. This will be your test credentials.</span>
openssl pkcs12 -export -out <span class="nv">$HOME</span>/.brooklyn/azure.p12 -in <span class="nv">$HOME</span>/.brooklyn/azure.pem -name <span class="s2">&quot;brooklyn :: $USER&quot;</span>
<span class="c"># create a cer file</span>
openssl x509 -inform pem -in <span class="nv">$HOME</span>/.brooklyn/azure.pem -outform der -out <span class="nv">$HOME</span>/.brooklyn/azure.cer</code></pre></div>

<p>Finally, upload .cer file to the management console at https://manage.windowsazure.com/@myId#Workspaces/AdminTasks/ListManagementCertificates to authorize this certificate.</p>

<p>Please note, you can find the “myId” value for this link by looking at the URL when logged into the Azure management portal.</p>

<p><strong>Note</strong>, you will need to use <code>.p12</code> format in the <code>brooklyn.properties</code>.</p>

<h4 id="how-to-configure-apache-brooklyn-to-use-azure-compute">How to configure Apache Brooklyn to use Azure Compute</h4>

<p>First, in your <code>brooklyn.properties</code> define a location as follows:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.location.jclouds.azurecompute.identity</span><span class="o">=</span><span class="s">$HOME/.brooklyn/azure.p12</span>
<span class="na">brooklyn.location.jclouds.azurecompute.credential</span><span class="o">=</span><span class="s">&lt;P12_EXPORT_PASSWORD&gt;</span>
<span class="na">brooklyn.location.jclouds.azurecompute.endpoint</span><span class="o">=</span><span class="s">https://management.core.windows.net/&lt;YOUR_SUBSCRIPTION_ID&gt;</span>
<span class="na">brooklyn.location.jclouds.azurecompute.vmNameMaxLength</span><span class="o">=</span><span class="s">45</span>
<span class="na">brooklyn.location.jclouds.azurecompute.jclouds.azurecompute.operation.timeout</span><span class="o">=</span><span class="s">120000</span>
<span class="na">brooklyn.location.jclouds.azurecompute.user</span><span class="o">=</span><span class="s">&lt;USER_NAME&gt;</span>
<span class="na">brooklyn.location.jclouds.azurecompute.password</span><span class="o">=</span><span class="s">&lt;PASSWORD&gt;</span></code></pre></div>

<p>During the VM provisioning, Azure will set up the account with <code>&lt;USER_NAME&gt;</code> and <code>&lt;PASSWORD&gt;</code> automatically.
Notice, <code>&lt;PASSWORD&gt;</code> must be a minimum of 8 characters and must contain 3 of the following: a lowercase character, an uppercase
character, a number, a special character.</p>

<p>To force Apache Brooklyn to use a particular image in Azure, say Ubuntu 14.04.1 64bit, one can add:</p>

<pre><code>brooklyn.location.jclouds.azurecompute.imageId=b39f27a8b8c64d52b05eac6a62ebad85__Ubuntu-14_04_1-LTS-amd64-server-20150123-en-us-30GB
</code></pre>

<p>From $BROOKLYN_HOME, you can list the image IDs available using the following command:</p>

<pre><code>./bin/client "list-images --location azure-west-europe"
</code></pre>

<p>To force Brooklyn to use a particular hardwareSpec in Azure, one can add something like:</p>

<pre><code>brooklyn.location.jclouds.azurecompute.hardwareId=BASIC_A2
</code></pre>

<p>From $BROOKLYN_HOME, you can list the hardware profile IDs available using the following command:</p>

<pre><code>./bin/client "list-hardware-profiles --location azure-west-europe"
</code></pre>

<p>At the time of writing, the classic deployment model has the possible values shown below.
See https://azure.microsoft.com/en-us/documentation/articles/virtual-machines-size-specs/
for further details, though that description focuses on the new “resource manager deployment”
rather than “classic”.</p>

<ul>
  <li><code>Basic_A0</code> to <code>Basic_A4</code></li>
  <li><code>Standard_D1</code> to <code>Standard_D4</code></li>
  <li><code>Standard_G1</code> to <code>Standard_G5</code></li>
  <li><code>ExtraSmall</code>, <code>Small</code>, <code>Medium</code>, <code>Large</code>, <code>ExtraLarge</code></li>
</ul>

<h5 id="named-location">Named location</h5>

<p>For convenience, you can define a named location, like:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.location.named.azure-west-europe</span><span class="o">=</span><span class="s">jclouds:azurecompute:West Europe</span>
<span class="na">brooklyn.location.named.azure-west-europe.displayName</span><span class="o">=</span><span class="s">Azure West Europe</span>
<span class="na">brooklyn.location.named.azure-west-europe.imageId</span><span class="o">=</span><span class="s">b39f27a8b8c64d52b05eac6a62ebad85__Ubuntu-14_04_1-LTS-amd64-server-20150123-en-us-30GB</span>
<span class="na">brooklyn.location.named.azure-west-europe.hardwareId</span><span class="o">=</span><span class="s">BASIC_A2</span>
<span class="na">brooklyn.location.named.azure-west-europe.user</span><span class="o">=</span><span class="s">test</span>
<span class="na">brooklyn.location.named.azure-west-europe.password</span><span class="o">=</span><span class="s">MyPassword1!</span></code></pre></div>

<p>This will create a location named <code>azure-west-europe</code>. It will inherit all the configuration
defined on <code>brooklyn.location.jclouds.azurecompute</code>. It will also augment and override this
configuration (e.g. setting the display name, image id and hardware id).</p>

<p>On Linux VMs, The <code>user</code> and <code>password</code> will create a user with that name and set its password,
disabling the normal login user and password defined on the <code>azurecompute</code> location.</p>

<h4 id="windows-vms-on-azure">Windows VMs on Azure</h4>

<p>The following configuration options are important for provisioning Windows VMs in Azure:</p>

<ul>
  <li>
    <p><code>osFamily: windows</code> tells Apache Brooklyn to consider it as a Windows machine</p>
  </li>
  <li>
    <p><code>useJcloudsSshInit: false</code> tells jclouds to not try to connect to the VM</p>
  </li>
  <li>
    <p><code>vmNameMaxLength: 15</code> tells the cloud client to strip the VM name to maximum 15 characters. 
This is the maximum size supported by Azure Windows VMs.</p>
  </li>
  <li>
    <p><code>winrm.useHttps</code> tells Apache Brooklyn to configure the WinRM client to use HTTPS.</p>

    <p>This is currently not supported in the default configuration for other clouds, where
Apache Brooklyn is deploying Windows VMs.</p>

    <p>If the parameter value is <code>false</code> the default WinRM port is 5985; if <code>true</code> the default port 
for WinRM will be 5986. Use of default ports is stongly recommended.</p>
  </li>
  <li>
    <p><code>winrm.useNtlm</code> tells Apache Brooklyn to configure the WinRM client to use NTLM protocol.</p>

    <p>For Azure, this is mandatory.</p>

    <p>For other clouds, this value is used in the cloud init script to configure WinRM on the VM. <br />
If the value is <code>true</code> then Basic Authentication will be disabled and the WinRM client will only use Negotiate plus NTLM.<br />
If the value is <code>false</code> then Basic Authentication will be enabled and the WinRM client will use Basic Authentication.</p>

    <p>NTLM is the default Authentication Protocol.</p>

    <p>The format of this configuration option is subject to change: WinRM supports several 
authentication mechanisms, so this may be changed to a prioritised list so as to
provide fallback options.</p>
  </li>
  <li>
    <p><code>user</code> tells Apache Brooklyn which user to login as. The value should match that supplied 
in the <code>overrideLoginUser</code> of the <code>templateOptions</code>.</p>
  </li>
  <li>
    <p><code>password</code>: tells Apache Brooklyn the password to use when connecting. The value should
match that supplied in the <code>overrideLoginPassword</code> of the <code>templateOptions</code>.</p>
  </li>
  <li>
    <p><code>templateOptions: { overrideLoginUser: adminuser, overrideLoginPassword: Pa55w0rd! }</code><br />
tells the Azure Cloud to provision a VM with the given admin username and password. Note that
no “Administrator” user will be created.</p>

    <p>If this config is not set then the VM will have a default user named “jclouds” with password 
“Azur3Compute!”. It is <strong>Strongly Recommended</strong> that these template options are set.</p>

    <p><strong>Notice</strong>: one cannot use <code>Administrator</code> as the user in Azure.</p>

    <p>This configuration is subject to change in future releases.</p>
  </li>
</ul>

<h6 id="sample-windows-blueprint">Sample Windows Blueprint</h6>

<p>Below is an example for provisioning a Windows-based entity on Azure. Note the placeholder values 
for the identity, credential and password.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Windows Test @ Azure</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">jclouds:azurecompute:West Europe</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">identity</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/users/brooklyn/.brooklyn/azure.p12</span>
    <span class="l-Scalar-Plain">credential</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">xxxxxxxp12</span>
    <span class="l-Scalar-Plain">endpoint</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://management.core.windows.net/12345678-1234-1234-1234-123456789abc</span>
    <span class="l-Scalar-Plain">imageId</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3a50f22b388a4ff7ab41029918570fa6__Windows-Server-2012-Essentials-20141204-enus</span>
    <span class="l-Scalar-Plain">hardwareId</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">BASIC_A2</span>
    <span class="l-Scalar-Plain">osFamily</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">windows</span>
    <span class="l-Scalar-Plain">useJcloudsSshInit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
    <span class="l-Scalar-Plain">vmNameMaxLength</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">15</span>
    <span class="l-Scalar-Plain">winrm.useHttps</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
    <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn</span>
    <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">secretPass1!</span>
    <span class="l-Scalar-Plain">templateOptions</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">overrideLoginUser</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn</span>
      <span class="l-Scalar-Plain">overrideLoginPassword</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">secretPass1!</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.software.base.VanillaWindowsProcess</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">install.command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">echo install phase</span>
    <span class="l-Scalar-Plain">launch.command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">echo launch phase</span>
    <span class="l-Scalar-Plain">checkRunning.command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">echo launch phase</span></code></pre></div>

<p>Below is an example named location for Azure, configured in <code>brooklyn.properties</code>. Note the 
placeholder values for the identity, credential and password.</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.location.named.myazure</span><span class="o">=</span><span class="s">jclouds:azurecompute:West Europe</span>
<span class="na">brooklyn.location.named.myazure.displayName</span><span class="o">=</span><span class="s">Azure West Europe (windows)</span>
<span class="na">brooklyn.location.named.myazure.identity</span><span class="o">=</span><span class="s">$HOME/.brooklyn/azure.p12</span>
<span class="na">brooklyn.location.named.myazure.credential</span><span class="o">=</span><span class="s">&lt;P12_EXPORT_PASSWORD&gt;</span>
<span class="na">brooklyn.location.named.myazure.endpoint</span><span class="o">=</span><span class="s">https://management.core.windows.net/&lt;YOUR_SUBSCRIPTION_ID&gt;</span>
<span class="na">brooklyn.location.named.myazure.vmNameMaxLength</span><span class="o">=</span><span class="s">15</span>
<span class="na">brooklyn.location.named.myazure.jclouds.azurecompute.operation.timeout</span><span class="o">=</span><span class="s">120000</span>
<span class="na">brooklyn.location.named.myazure.imageId</span><span class="o">=</span><span class="s">3a50f22b388a4ff7ab41029918570fa6__Windows-Server-2012-Essentials-20141204-enus</span>
<span class="na">brooklyn.location.named.myazure.hardwareId</span><span class="o">=</span><span class="s">BASIC_A2</span>
<span class="na">brooklyn.location.named.myazure.osFamily</span><span class="o">=</span><span class="s">windows</span>
<span class="na">brooklyn.location.named.myazure.useJcloudsSshInit</span><span class="o">=</span><span class="s">false</span>
<span class="na">brooklyn.location.named.myazure.winrm.useHttps</span><span class="o">=</span><span class="s">true</span>
<span class="na">brooklyn.location.named.myazure.user</span><span class="o">=</span><span class="s">brooklyn</span>
<span class="na">brooklyn.location.named.myazure.password</span><span class="o">=</span><span class="s">secretPass1!</span>
<span class="na">brooklyn.location.named.myazure.templateOptions</span><span class="o">=</span><span class="s">{ overrideLoginUser: amp, overrideLoginPassword: secretPass1! }</span></code></pre></div>

<h6 id="user-and-password-configuration">User and Password Configuration</h6>

<p>As described under the configuration options, the username and password must be explicitly supplied
in the configuration.</p>

<p>This is passed to the Azure Cloud during provisioning, to create the required user. These values 
correspond to the options <code>AdminUsername</code> and <code>AdminPassword</code> in the Azure API.</p>

<p>If a hard-coded password is not desired, then within Java code a random password could be 
auto-generated and passed into the call to <code>location.obtain(Map&lt;?,?&gt;)</code> to override these values.</p>

<p>This approach differs from the behaviour of clouds like AWS, where the password is auto-generated 
by the cloud provider and is then retrieved via the cloud provider’s API after provisioning the VM.</p>

<h6 id="winrm-configuration">WinRM Configuration</h6>

<p>The WinRM initialization in Azure is achieved through configuration options in the VM provisioning request.
The required configuration is to enabled HTTPS (if Azure is told to use http, the VM comes pre-configured 
with WinRM encrypted over HTTP). The default is then to support NTLM protocol.</p>

<p>The setup of Windows VMs on Azure differs from that on other clouds, such as AWS. In contrast, on AWS an 
init script is passed to the cloud API to configure WinRM appropriately.</p>

<p><em>Windows initialization scripts in Azure are unfortunately not supported in “classic deployment”<br />
model, but are available in the newer “resource manager deployment” model as an “Azure VM Extension”.</em></p>

<h2 id="apache-cloudstack">Apache CloudStack</h2>

<h3 id="connection-details">Connection Details</h3>

<p>The endpoint URI will normally have the suffix <code>/client/api/</code>.</p>

<p>The identity is the “api key” and the credential is the “secret key”. These can be generated in 
the CloudStack gui: under accounts, select “view users”, then “generate key”.</p>

<pre><code>location:
  jclouds:cloudstack:
    endpoint: https://cloud.acme.com/client/api
    identity: abcdefghijklmnopqrstuvwxyz01234567890-abcdefghijklmnopqrstuvwxyz01234567890-abcdefghij
    credential: mycred-abcdefghijklmnopqrstuvwxyz01234567890-abcdefghijklmnopqrstuvwxyz01234567890-abc
</code></pre>

<p>Users are strongly recommended to use 
<a href="/brooklyn-docs/v/latest/ops/externalized-configuration.html">externalized configuration</a> for better
credential management, for example using <a href="https://www.vaultproject.io/">Vault</a>.</p>

<h3 id="common-configuration-options-1">Common Configuration Options</h3>

<p>Below are examples of configuration options that use values specific to CloudStack environments:</p>

<ul>
  <li>
    <p>The <code>imageId</code> is the template id. For example,
<code>imageId: db0bcce3-9e9e-4a87-a953-2f46b603498f</code>.</p>
  </li>
  <li>
    <p>The <code>region</code> is CloudStack zone id.
For example <code>region: 84539b9c-078e-458a-ae26-c3ffc5bb1ec9</code>..</p>
  </li>
  <li>
    <p><code>networkName</code> is the network id (within the given zone) to be used. For example, 
<code>networkName: 961c03d4-9828-4037-9f4d-3dd597f60c4f</code>.</p>
  </li>
</ul>

<p>For further configuration options, consult 
<a href="https://jclouds.apache.org/reference/javadoc/1.9.x/org/jclouds/cloudstack/compute/options/CloudStackTemplateOptions.html">jclouds CloudStack template options</a>.
These can be used with the <strong><a href="#custom-template-options">templateOptions</a></strong> configuration option.</p>

<h3 id="using-a-pre-existing-key-pair">Using a Pre-existing Key Pair</h3>

<p>The configuration below uses a pre-existing key pair:</p>

<pre><code>location:
  jclouds:cloudstack:
    ...
    loginUser: root
    loginUser.privateKeyFile: /path/to/keypair.pem
    keyPair: my-keypair
</code></pre>

<h3 id="using-pre-existing-security-groups">Using Pre-existing Security Groups</h3>

<p>To specify existing security groups, their IDs must be used rather than their names (note this
differs from the configuration on other clouds!).</p>

<p>The configuration below uses a pre-existing security group:</p>

<pre><code>location:
  jclouds:cloudstack:
    ...
    templateOptions:
      generateSecurityGroup: false
      securityGroupIds:
      - 12345678-90ab-def0-1234-567890abcdef
</code></pre>

<h3 id="using-static-nat">Using Static NAT</h3>

<p>Assigning a public IP to a VM at provision-time is referred to as “static NAT” in CloudStack
parlance. To give some consistency across different clouds, the configuration option is named
<code>autoAssignFloatingIp</code>. For example, <code>autoAssignFloatingIp: false</code>.</p>

<h3 id="cloudmonkey-cli">CloudMonkey CLI</h3>

<p>The <a href="https://cwiki.apache.org/confluence/display/CLOUDSTACK/CloudStack+cloudmonkey+CLI">CloudStack CloudMonkey CLI</a>
is a very useful tool. It gives is an easy way to validate that credentials are correct, and to query<br />
the API to find the correct zone IDs etc.</p>

<p>Useful commands include:</p>

<pre><code># for finding the ids of the zones:
cloudmonkey api listZones

# for finding the ids of the networks.
cloudmonkey api listNetworks | grep -E "id =|name =|========="
</code></pre>

<h3 id="cloudstack-troubleshooting">CloudStack Troubleshooting</h3>

<p>These troubleshooting tips are more geared towards problems encountered in old test/dev 
CloudStack environment.</p>

<h4 id="resource-garbage-collection-issues">Resource Garbage Collection Issues</h4>

<p>The environment may run out of resources, due to GC issues, preventing the user from creating new 
VMs or allocating IP addresses (May respond with this error message: 
<code>errorCode=INTERNAL_ERROR, errorText=Job failed due to exception Unable to create a deployment for VM</code>). 
There are two options worth checking it to enforce clearing up the zombie resources:</p>

<ul>
  <li>Go to the Accounts tab in the webconsole and tap on the Update Resource Count button.</li>
  <li>Restart the VPC in question from the Network tab.</li>
</ul>

<h4 id="releasing-allocated-public-ip-addresses">Releasing Allocated Public IP Addresses</h4>

<p>Releasing an allocated Public IP from the web console did not free up the resources. Instead 
CloudMonkey can be used to dissociate IPs and expunge VMs.</p>

<p>Here is a CloudMonkey script to dissociate any zombie IPs:</p>

<pre><code>cloudmonkey set display json;
cloudmonkey api listPublicIpAddresses | grep '"id":' &gt; ips.txt; 
sed -i -e s/'      "id": "'/''/g ips.txt;
sed -i -e s/'",'/''/g ips.txt
for line in $(cat ips.txt); do cloudmonkey api disassociateIpAddress id="$line"; done
rm ips.txt;
cloudmonkey set display default;
</code></pre>

<h4 id="restarting-vpcs">Restarting VPCs</h4>

<p>Errors have been encountered when a zone failed to provision new VMs, with messages like:</p>

<pre><code>Job failed due to exception Resource [Host:15] is unreachable: Host 15: Unable to start instance due to null
</code></pre>

<p>The workaround was to restart the VPC networks:</p>

<ul>
  <li>Log into the CloudStack web-console.</li>
  <li>Go to Network -&gt; VPC (from the “select view”)</li>
  <li>For each of the VPCs, click on the “+” in the “quickview” column, and invoke “restart VPC”.</li>
</ul>

<p>Other symptoms of this issue were that: 1) an administrator could still provision VMs using 
the admin account, which used a different network; and 2) the host number was very low, so it 
was likely to be a system host/VM that was faulty.</p>

<h2 id="google-compute-engine-gce">Google Compute Engine (GCE)</h2>

<h3 id="credentials-1">Credentials</h3>

<p>GCE uses a service account e-mail address for the identity and a private key as the credential.</p>

<p>To obtain credentials for GCE, use the GCE web page’s “APIs &amp; auth -&gt; Credentials” page,
creating a “Service Account” of type JSON, then extracting the client_email as the identity and 
private_key as the credential. For more information, see the 
<a href="https://jclouds.apache.org/guides/google">jclouds instructions</a>.</p>

<p>An example of the expected format is shown below. Note that when supplying the credential in a 
properties file, it can either be one long line with <code>\n</code> representing the new line characters, 
or in YAML it can be split over multiple lines as below:</p>

<pre><code>location:
  jclouds:google-compute-engine:
    region: us-central1-a
    identity: 1234567890-somet1mesArand0mU1Dhere@developer.gserviceaccount.com
    credential: |
      -----BEGIN RSA PRIVATE KEY-----
      abcdefghijklmnopqrstuvwxyz0123456789/+abcdefghijklmnopqrstuvwxyz
      0123456789/+abcdefghijklmnopqrstuvwxyz0123456789/+abcdefghijklmn
      opqrstuvwxyz0123456789/+abcdefghijklmnopqrstuvwxyz0123456789/+ab
      cdefghijklmnopqrstuvwxyz0123456789/+abcdefghijklmnopqrstuvwxyz01
      23456789/+abcdefghijklmnopqrstuvwxyz0123456789/+abcdefghijklmnop
      qrstuvwxyz0123456789/+abcdefghijklmnopqrstuvwxyz0123456789/+abcd
      efghijklmnopqrstuvwxyz0123456789/+abcdefghijklmnopqrstuvwxyz0123
      456789/+abcdefghijklmnopqrstuvwxyz0123456789/+abcdefghijklmnopqr
      stuvwxyz0123456789/+abcdefghijklmnopqrstuvwxyz0123456789/+abcdef
      ghijklmnopqrstuvwxyz0123456789/+abcdefghijklmnopqrstuvwxyz012345
      6789/+abcdefghijklmnopqrstuvwxyz0123456789/+abcdefghijklmnopqrst
      uvwxyz0123456789/+abcdefghijklmnopqrstuvwxyz0123456789/+abcdefgh
      ijklmnopqrstuvwxyz0123456789/+abcdefghijklmnopqrstuvwxyz01234567
      89/+abcdefghijklmnopqrstuvwxyz0123456789/+abcdefghijklmnopqrstuv
      wxyz0123456789/+abcdefghijklmnopqrstuvwxyz0123456789/+abcdefghij
      klmnopqrstuvwxyz0123456789/+abcdefghijklmnopqrstuvwxyz0123456789
      /+abcdefghijklmnopqrstuvwxyz0123456789/+abcdefghijklmnopqrstuvwx
      yz0123456789/+abcdefghijklmnopqrstuvwxyz0123456789/+abcdefghijkl
      mnopqrstuvwxyz0123456789/+abcdefghijklmnopqrstuvwxyz0123456789/+
      abcdefghijklmnopqrstuvwxyz0123456789/+abcdefghijklmnopqrstuvwxyz
      0123456789/+abcdefghijklmnopqrstuvwxyz0123456789/+abcdefghijklmn
      opqrstuvwxyz0123456789/+abcdefghijklmnopqrstuvwxyz0123456789/+ab
      cdefghijklmnopqrstuvwxyz
      -----END RSA PRIVATE KEY-----
</code></pre>

<p>It is also possible to have the credential be the path of a local file that contains the key.
However, this can make it harder to setup and manage multiple Brooklyn servers (particularly
when using high availability mode).</p>

<p>Users are strongly recommended to use 
<a href="/brooklyn-docs/v/latest/ops/externalized-configuration.html">externalized configuration</a> for better
credential management, for example using <a href="https://www.vaultproject.io/">Vault</a>.</p>

<h3 id="quotas">Quotas</h3>

<p>GCE accounts can have low default <a href="https://cloud.google.com/compute/docs/resource-quotas">quotas</a>.</p>

<p>It is easy to request a quota increase by submitting a <a href="https://support.google.com/cloud/answer/6075746?hl=en">quota increase form</a>.</p>

<h3 id="networks">Networks</h3>

<p>GCE accounts often have a limit to the number of networks that can be created. One work around
is to manually create a network with the required open ports, and to refer to that named network
in Brooklyn’s location configuration.</p>

<p>To create a network, see <a href="https://cloud.google.com/compute/docs/networking#networks_1">GCE network instructions</a>.</p>

<p>For example, for dev/demo purposes an “everything” network could be created that opens all ports.</p>

<table>
  <tbody>
    <tr>
      <td> </td>
      <td>Name</td>
      <td> </td>
      <td>everything</td>
    </tr>
    <tr>
      <td> </td>
      <td>Description</td>
      <td> </td>
      <td>opens all tcp ports</td>
    </tr>
    <tr>
      <td> </td>
      <td>Source IP Ranges</td>
      <td> </td>
      <td>0.0.0.0/0</td>
    </tr>
    <tr>
      <td> </td>
      <td>Allowed protocols and ports</td>
      <td> </td>
      <td>tcp:0-65535 and udp:0-65535</td>
    </tr>
  </tbody>
</table>

<p>To configure the location to use this, you can include a location configuration option like:</p>

<pre><code>templateOptions:
  network: https://www.googleapis.com/compute/v1/projects/&lt;project name&gt;/global/networks/everything
</code></pre>

<h2 id="ibm-softlayer">IBM SoftLayer</h2>

<h3 id="credentials-2">Credentials</h3>

<p>Credentials can be obtained from the Softlayer API, under “administrative -&gt; user administration -&gt; api-access”.</p>

<p>For example:</p>

<pre><code>location:
  jclouds:softlayer:
    region: ams01
    identity: my-user-name
    credential: 1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef
</code></pre>

<p>Users are strongly recommended to use 
<a href="/brooklyn-docs/v/latest/ops/externalized-configuration.html">externalized configuration</a> for better
credential management, for example using <a href="https://www.vaultproject.io/">Vault</a>.</p>

<h3 id="common-configuration-options-2">Common Configuration Options</h3>

<p>Below are examples of configuration options that use values specific to Softlayer:</p>

<ul>
  <li>
    <p>The <code>region</code> is the <a href="http://www.softlayer.com/data-centers">Softlayer datacenter</a>.
For example, <code>region: dal05</code>.</p>
  </li>
  <li>
    <p>The <code>hardwareId</code> is an auto-generated combination of the hardware configuration options.
This is because there is no concept of hardwareId or hardware profile names in Softlayer. 
An example value is <code>hardwareId: "cpu=1,memory=1024,disk=25,type=LOCAL"</code>.</p>
  </li>
  <li>
    <p>The <code>imageId</code> is the <a href="https://knowledgelayer.softlayer.com/learning/introduction-image-templates">Image template</a>.
For example, <code>imageId: CENTOS_6_64</code>.</p>
  </li>
</ul>

<h3 id="vlan-selection">VLAN Selection</h3>

<p>SoftLayer may provision VMs in different VLANs, even within the same region.
Some applications require VMs to be on the <em>same</em> internal subnet; blueprints
for these can specify this behaviour in SoftLayer in one of two ways.</p>

<p>The VLAN ID can be set explicitly using the fields
<code>primaryNetworkComponentNetworkVlanId</code> and
<code>primaryBackendNetworkComponentNetworkVlanId</code> of <code>SoftLayerTemplateOptions</code>
when specifying the location being used in the blueprint, as follows:</p>

<pre><code>location:
  jclouds:softlayer:
    region: ams01
    templateOptions:
      # Enter your preferred network IDs
      primaryNetworkComponentNetworkVlanId: 1153481
      primaryBackendNetworkComponentNetworkVlanId: 1153483
</code></pre>

<p>This method requires that a VM already exist and you look up the IDs of its
VLANs, for example in the SoftLayer console UI, and that subsequently at least
one VM in that VLAN is kept around.  If all VMs on a VLAN are destroyed
SoftLayer may destroy the VLAN.  Creating VLANs directly and then specifying
them as IDs here may not work.  Add a line note</p>

<p>The second method tells Brooklyn to discover VLAN information automatically: it
will provision one VM first, and use the VLAN information from it when
provisioning subsequent machines. This ensures that all VMs are on the same
subnet without requiring any manual VLAN referencing, making it very easy for
end-users.</p>

<p>To use this method, we tell brooklyn to use <code>SoftLayerSameVlanLocationCustomizer</code>
as a location customizer.  This can be done on a location as follows:</p>

<pre><code>location:
  jclouds:softlayer:
    region: lon02
    customizers:
    - $brooklyn:object:
        type: org.apache.brooklyn.location.jclouds.softlayer.SoftLayerSameVlanLocationCustomizer
    softlayer.vlan.scopeUid: "my-custom-scope"
    softlayer.vlan.timeout: 10m
</code></pre>

<p>Usually you will want the scope to be unique to a single application, but if you
need multiple applications to share the same VLAN, simply configure them with
the same scope identifier.</p>

<p>It is also possible with many blueprints to specify this as one of the
<code>provisioning.properties</code> on an <em>application</em>:</p>

<pre><code>services:
- type: org.apache.brooklyn.entity.stock.BasicApplication
  id: same-vlan-application
  brooklyn.config:
    provisioning.properties:
      customizers:
      - $brooklyn:object:
          type: org.apache.brooklyn.location.jclouds.softlayer.SoftLayerSameVlanLocationCustomizer
    softlayer.vlan.scopeUid: "my-custom-scope"
    softlayer.vlan.timeout: 10m
</code></pre>

<p>If you are writing an entity in Java, you can also use the helper
method <code>forScope(String)</code> to create the customizer. Configure the
provisioning flags as follows:</p>

<pre><code>JcloudsLocationCustomizer vlans = SoftLayerSameVlanLocationCustomizer.forScope("my-custom-scope");
flags.put(JcloudsLocationConfig.JCLOUDS_LOCATION_CUSTOMIZERS.getName(), ImmutableList.of(vlans));
</code></pre>

<h3 id="configuration-options">Configuration Options</h3>

<p>The allowed configuration keys for the <code>SoftLayerSameVlanLocationCustomizer</code>
are:</p>

<ul>
  <li>
    <p><strong>softlayer.vlan.scopeUid</strong> The scope identifier for locations whose
VMs will have the same VLAN.</p>
  </li>
  <li>
    <p><strong>softlayer.vlan.timeout</strong> The amount of time to wait for a VM to
be configured before timing out without setting the VLAN ids.</p>
  </li>
  <li>
    <p><strong>softlayer.vlan.publicId</strong> A specific public VLAN ID to use for
the specified scope.</p>
  </li>
  <li>
    <p><strong>softlayer.vlan.privateId</strong> A specific private VLAN ID to use for
the specified scope.</p>
  </li>
</ul>

<p>An entity being deployed to a customized location will have the VLAN ids set as
sensors, with the same names as the last two configuration keys.</p>

<p><strong><em>NOTE</em></strong> If the SoftLayer location is already configured with specific VLANs
then this customizer will have no effect.</p>

<h2 id="openstack">OpenStack</h2>

<h3 id="apache-jclouds">Apache jclouds</h3>

<p>Support for OpenStack is provided by Apache jclouds. For more information, see their guide
<a href="https://jclouds.apache.org/guides/openstack/">here</a>.</p>

<h3 id="connection-details-1">Connection Details</h3>

<p>The endpoint URI is that of keystone (normally on port 5000).</p>

<p>The identity normally consists of a colon-separated tenant and username. The credential is 
the password. For example:</p>

<pre><code>location:
  jclouds:openstack-nova:
    endpoint: http://x.x.x.x:5000/v2.0/
    identity: "your-tenant:your-username"
    credential: your-password
</code></pre>

<p>OpenStack Nova access information can be downloaded from the openstack web interface, for example 
as an openrc.sh file. It is usually available from API Access tab in “Access &amp; Security” section.
This file will normally contain the identity and credential.</p>

<p>Users are strongly recommended to use 
<a href="/brooklyn-docs/v/latest/ops/externalized-configuration.html">externalized configuration</a> for better
credential management, for example using <a href="https://www.vaultproject.io/">Vault</a>.</p>

<h3 id="common-configuration-options-3">Common Configuration Options</h3>

<p>Below are examples of configuration options that use values specific to OpenStack environments:</p>

<ul>
  <li>
    <p>The <code>imageId</code> is the id of an image. For example,
<code>imageId: RegionOne/08086159-8b0b-4970-b332-a7a929ee601f</code>.
These ids can be found from the the CLI or the web-console, for example in IBM Blue Box London, 
the URL is https://tenant-region.openstack.blueboxgrid.com/project/images/.</p>
  </li>
  <li>
    <p>The <code>hardwareId</code> is the <a href="http://docs.openstack.org/admin-guide/compute-flavors.html">flavor id</a>.
For example <code>hardwareId: RegionOne/1</code>. These ids can be found from the the CLI or the web-console,
for example in IBM Blue Box, the URL is https://tenant-region.openstack.blueboxgrid.com/admin/flavors/.</p>
  </li>
</ul>

<p>The default flavors are shown below (though the set of flavors can be 
<a href="http://docs.openstack.org/admin-guide/cli_manage_flavors.html">managed by the admin</a>):</p>

<pre><code>+-----+-----------+-----------+------+
| ID  | Name      | Memory_MB | Disk |
+-----+-----------+-----------+------+
| 1   | m1.tiny   | 512       | 1    |
| 2   | m1.small  | 2048      | 20   |
| 3   | m1.medium | 4096      | 40   |
| 4   | m1.large  | 8192      | 80   |
| 5   | m1.xlarge | 16384     | 160  |
+-----+-----------+-----------+------+
</code></pre>

<p>For further configuration options, consult 
<a href="https://jclouds.apache.org/reference/javadoc/2.0.x/org/jclouds/openstack/nova/v2_0/compute/options/NovaTemplateOptions.html">jclouds Nova template options</a>.
These can be used with the <strong><a href="#custom-template-options">templateOptions</a></strong> configuration option.</p>

<h3 id="networks-1">Networks</h3>

<p>When multiple networks are available you should indicate which ones machines should join.
Do this by setting the desired values id as an option in the
<strong><a href="#custom-template-options">templateOptions</a></strong> configuration:</p>

<pre><code>location:
  jclouds:openstack-nova:
    ...
    templateOptions:
      # Assign the node to all networks in the list.
      networks:
      - network-one-id
      - network-two-id
      - ...
</code></pre>

<h3 id="floating-ips">Floating IPs</h3>

<p>The <code>autoAssignFloatingIp</code> option means that a <a href="https://www.mirantis.com/blog/configuring-floating-ip-addresses-networking-openstack-public-private-clouds/">floating ip</a>
will be assigned to the VM at provision-time.</p>

<p>A floating IP pool name can also be specified. If not set, a floating IP from any available pool will be chosen.
This is set using the <a href="#custom-template-options">template option</a>. For example:</p>

<pre><code>location:
  jclouds:openstack-nova:
    ...
    autoAssignFloatingIp: true
    templateOptions:
      # Pool names to use when allocating a floating IP
      floatingIpPoolNames:
      - "pool name"
</code></pre>

<h3 id="basic-location-structure">Basic Location Structure</h3>

<p>This is a basic inline YAML template for an OpenStack location:</p>

<pre><code>location:
    jclouds:openstack-nova:
        endpoint: http://x.x.x.x:5000/v2.0/
        identity: "your-tenant:your-username"
        credential: your-password

        # imageId, hardwareId, and loginUser* are optional
        imageId: your-region-name/your-image-id
        hardwareId: your-region-name/your-flavor-id
        loginUser: 'ubuntu'
        loginUser.privateKeyFile: /path/to/your/privatekey

        jclouds.openstack-nova.auto-generate-keypairs: false
        jclouds.openstack-nova.auto-create-floating-ips: true

        templateOptions:
            networks: [ "your-network-id" ]
            floatingIpPoolNames: [ "your-floatingIp-pool" ]
            securityGroups: ['your-security-group']

            # Optional if 'jclouds.openstack-nova.auto-generate-keypairs' is assigned to 'true'
            keyPairName: "your-keypair"
</code></pre>

<p>This is the same OpenStack location in a format that can be added to your
<code>brooklyn.properties</code> file:</p>

<pre><code>brooklyn.location.named.My\ OpenStack=jclouds:openstack-nova:http://x.x.x.x:5000/v2.0/
brooklyn.location.named.My\ OpenStack.identity=your-tenant:your-username
brooklyn.location.named.My\ OpenStack.credential=your-password
brooklyn.location.named.My\ OpenStack.endpoint=http://x.x.x.x:5000/v2.0/

brooklyn.location.named.My\ OpenStack.imageId=your-region-name/your-image-id
brooklyn.location.named.My\ OpenStack.hardwareId=your-region-name/your-flavor-id
brooklyn.location.named.My\ OpenStack.loginUser=ubuntu
brooklyn.location.named.My\ OpenStack.loginUser.privateKeyFile=/path/to/your/privatekey
brooklyn.location.named.My\ OpenStack.openstack-nova.auto-generate-keypairs=false
brooklyn.location.named.My\ OpenStack.openstack-nova.auto-create-floating-ips=true

brooklyn.location.named.My\ OpenStack.networks=your-network-id
brooklyn.location.named.My\ OpenStack.floatingIpPoolNames=your-floatingIp-pool
brooklyn.location.named.My\ OpenStack.securityGroups=your-security-group
brooklyn.location.named.My\ OpenStack.keyPair=your-keypair
</code></pre>

<h3 id="troubleshooting">Troubleshooting</h3>

<h4 id="cloud-credentials-failing">Cloud Credentials Failing</h4>

<p>If the cloud API calls return <code>401 Unauthorized</code> (e.g. in a <code>org.jclouds.rest.AuthorizationException</code>),
then this could be because the credentials are incorrect.</p>

<p>A good way to check this is to try the same credentials with the 
<a href="http://docs.openstack.org/user-guide/common/cli_install_openstack_command_line_clients.html">OpenStack nova command line client</a>.</p>

<h4 id="unable-to-ssh-wrong-user">Unable to SSH: Wrong User</h4>

<p>If SSH authentication fails, it could be that the login user is incorrect. For most clouds, this 
is inferred from the image metadata, but if no (or the wrong) login user is specified then it will<br />
default to root. The correct login user can be specified using the configuration option <code>loginUser</code>.
For example, <code>loginUser: ubuntu</code>.</p>

<p>The use of the wrong login user can also result in the obscure message, caused by 
an unexpected response saying to use a different user. For more technical information, see 
this <a href="https://github.com/hierynomus/sshj/issues/75">sshj github issue</a>. The message is:</p>

<pre><code>Received message too long 1349281121
</code></pre>

<h4 id="i-want-to-use-my-own-keypair">I Want to Use My Own KeyPair</h4>

<p>By default, jclouds will auto-generate a new <a href="http://docs.openstack.org/user-guide/cli_nova_configure_access_security_for_instances.html">key pair</a>
for the VM. This key pair will be deleted automatically when the VM is deleted.</p>

<p>Alternatively, you can use a pre-existing key pair. If so, you must also specify the corresponding
private key (pem file, or data) to be used for the initial login. The name used in the <code>keyPair</code> 
configuration must match the name of a key pair that has already been added in OpenStack.
For example:</p>

<pre><code>location:
  jclouds:clouds:openstack-nova:
    ...
    jclouds.openstack-nova.auto-generate-keypairs: false
    keyPair: "my-keypair"
    loginUser: ubuntu
    loginUser.privateKeyFile: /path/to/my/privatekey.pem
</code></pre>

<h4 id="error-doesnt-contain-------begin">Error “doesn’t contain … —–BEGIN”</h4>

<p>If using <code>loginUser.privateKeyFile</code> (or <code>loginUser.privateKeyData</code>), this is expected to be a .pem
file. If a different format is used (e.g. a .ppk file), it will give an error like that below:</p>

<pre><code>Error invoking start at EmptySoftwareProcessImpl{id=TrmhitVc}: chars
PuTTY-User-Key-File-2: ssh-rsa
...
doesn't contain % line [-----BEGIN ]
</code></pre>

<h4 id="warning-message-ignoring-request-to-set">Warning Message: “Ignoring request to set…”</h4>

<p>If you see a warning log message like that below:</p>

<pre><code>2016-06-23 06:05:12,297 WARN  o.a.b.l.j.JcloudsLocation [brooklyn-execmanager-XlwkWB3k-312]: 
Ignoring request to set template option loginUser because this is not supported by 
org.jclouds.openstack.nova.v2_0.compute.options.NovaTemplateOptions
</code></pre>

<p>It can mean that the location configuration option is in the wrong place. The configuration under 
<code>templateOptions</code> must correspond to those options on the
<a href="https://jclouds.apache.org/reference/javadoc/1.9.x/org/jclouds/openstack/nova/v2_0/compute/options/NovaTemplateOptions.html">jclouds Nova template options</a>.
However, template options such as <code>loginUser</code> are top-level configuration options that should not
be inside the <code>templateOptions</code> section.</p>

<h4 id="httpresponseexception-accessing-compute-endpoint">HttpResponseException Accessing Compute Endpoint</h4>

<p>The Keystone endpoint is first queried to get the API access endpoints for the appropriate services.</p>

<p>Some private OpenStack installs are (mis)configured such that the returned addresses are not always 
directly accessible. It could be that the service is behind a VPN, or that they rely on hostnames
that are only in a private DNS.</p>

<p>You can find the service endpoints in OpenStack, either using the CLI or the web-console. For 
example, in Blue Box the URL is https://tenant-region.openstack.blueboxgrid.com/project/access_and_security/.
You can then check if the Compute service endpoint is directly reachable.</p>

<h4 id="vm-failing-to-provision">VM Failing to Provision</h4>

<p>It can be useful to drop down to the OpenStack nova CLI, or to jclouds, to confirm that VM
provisioning is working and to check which options are required.</p>

<p>For example, try following <a href="https://github.com/jclouds/jclouds-examples/tree/master/compute-basics#your-own-openstack-nova">these jclouds instructions</a>.</p>

<h4 id="jclouds-namespace-issue">jclouds Namespace Issue</h4>

<p>A change to Nova’s API (in the Mitaka release) resulted in all extensions having the same “fake” 
namespace which the current version of jclouds does not yet support.</p>

<p>If you are having problems deploying to OpenStack, consult your Brooklyn debug log and
look for the following:</p>

<pre><code>"namespace": "http://docs.openstack.org/compute/ext/fake_xml"
</code></pre>

<p>If you already have <code>jclouds:openstack-mitaka-nova</code>, then try using this instead of the vanilla
<code>jclouds:openstack-nova</code>. For example:</p>

<pre><code>location:
    jclouds:openstack-mitaka-nova:
        endpoint: http://x.x.x.x:5000/v2.0/
        identity: "your-tenant:your-username"
        credential: your-password
        templateOptions:
            networks: [ "your-network-id" ]
            floatingIpPoolNames: [ "your-floatingIp-pool" ]
</code></pre>

<p>Note that the following values will be set by default when omitted above:</p>

<pre><code>jclouds.keystone.credential-type=passwordCredentials
jclouds.openstack-nova.auto-generate-keypairs: true
jclouds.openstack-nova.auto-create-floating-ips: true
</code></pre>

<h3 id="inheritance-and-named-locations">Inheritance and Named Locations</h3>

<p>Named locations can be defined for commonly used groups of properties, 
with the syntax <code>brooklyn.location.named.your-group-name.</code>
followed by the relevant properties.
These can be accessed at runtime using the syntax <code>named:your-group-name</code> as the deployment location.</p>

<p>Some illustrative examples using named locations and
showing the syntax and properties above are as follows:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Production pool of machines for my application (deploy to named:prod1)</span>
brooklyn.location.named.prod1<span class="o">=</span>byon:<span class="o">(</span><span class="nv">hosts</span><span class="o">=</span><span class="s2">&quot;10.9.1.1,10.9.1.2,produser2@10.9.2.{10,11,20-29}&quot;</span><span class="o">)</span>
brooklyn.location.named.prod1.user<span class="o">=</span>produser1
brooklyn.location.named.prod1.privateKeyFile<span class="o">=</span>~/.ssh/produser_id_rsa
brooklyn.location.named.prod1.privateKeyPassphrase<span class="o">=</span>s3cr3tCOMPANYpassphrase

<span class="c"># AWS using my company&#39;s credentials and image standard, then labelling images so others know they&#39;re mine</span>
brooklyn.location.named.company-jungle<span class="o">=</span>jclouds:aws-ec2:us-west-1
brooklyn.location.named.company-jungle.identity<span class="o">=</span>BCDEFGHIJKLMNOPQRSTU  
brooklyn.location.named.company-jungle.privateKeyFile<span class="o">=</span>~/.ssh/public_clouds/company_aws_id_rsa
brooklyn.location.named.company-jungle.imageId<span class="o">=</span>ami-12345
brooklyn.location.named.company-jungle.minRam<span class="o">=</span>2048
brooklyn.location.named.company-jungle.userMetadata<span class="o">=</span><span class="nv">application</span><span class="o">=</span>my-jungle-app,owner<span class="o">=</span><span class="s2">&quot;Bob Johnson&quot;</span>
brooklyn.location.named.company-jungle.machineCreateAttempts<span class="o">=</span>2

brooklyn.location.named.AWS<span class="se">\ </span>Virginia<span class="se">\ </span>Large<span class="se">\ </span><span class="nv">Centos</span> <span class="o">=</span> jclouds:aws-ec2
brooklyn.location.named.AWS<span class="se">\ </span>Virginia<span class="se">\ </span>Large<span class="se">\ </span>Centos.region <span class="o">=</span> us-east-1
brooklyn.location.named.AWS<span class="se">\ </span>Virginia<span class="se">\ </span>Large<span class="se">\ </span>Centos.imageId<span class="o">=</span>us-east-1/ami-7d7bfc14
brooklyn.location.named.AWS<span class="se">\ </span>Virginia<span class="se">\ </span>Large<span class="se">\ </span>Centos.user<span class="o">=</span>root
brooklyn.location.named.AWS<span class="se">\ </span>Virginia<span class="se">\ </span>Large<span class="se">\ </span>Centos.minRam<span class="o">=</span>4096</code></pre></div>

<p>Named locations can refer to other named locations using <code>named:xxx</code> as their value.
These will inherit the configuration and can override selected keys.
Properties set in the namespace of the provider (e.g. <code>b.l.jclouds.aws-ec2.KEY=VALUE</code>)
will be inherited by everything which extends AWS
Sub-prefix strings are also inherited up to <code>brooklyn.location.*</code>, 
except that they are filtered for single-word and other
known keys 
(so that we exclude provider-scoped properties when looking at sub-prefix keys).
The precedence for configuration defined at different levels is that the value
defined in the most specific context will apply.</p>

<p>This is rather straightforward and powerful to use,
although it sounds rather more complicated than it is!
The examples below should make it clear.
You could use the following to install
a public key on all provisioned machines,
an additional public key in all AWS machines, 
and no extra public key in <code>prod1</code>: </p>

<!-- tested in JcloudsLocationResolverTest -->
<div class="highlight"><pre><code class="language-bash" data-lang="bash">brooklyn.location.extraSshPublicKeyUrls<span class="o">=</span>http://me.com/public_key
brooklyn.location.jclouds.aws-ec2.extraSshPublicKeyUrls<span class="o">=</span><span class="s2">&quot;[ \&quot;http://me.com/public_key\&quot;, \&quot;http://me.com/aws_public_key\&quot; ]&quot;</span>
brooklyn.location.named.prod1.extraSshPublicKeyUrls<span class="o">=</span></code></pre></div>

<p>And in the example below, a config key is repeatedly overridden. 
Deploying <code>location: named:my-extended-aws</code> will result in an <code>aws-ec2</code> machine in <code>us-west-1</code> (by inheritance)
with <code>VAL6</code> for <code>KEY</code>:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">brooklyn.location.KEY<span class="o">=</span>VAL1
brooklyn.location.jclouds.KEY<span class="o">=</span>VAL2
brooklyn.location.jclouds.aws-ec2.KEY<span class="o">=</span>VAL3
brooklyn.location.jclouds.aws-ec2@us-west-1.KEY<span class="o">=</span>VAL4
brooklyn.location.named.my-aws<span class="o">=</span>jclouds:aws-ec2:us-west-1
brooklyn.location.named.my-aws.KEY<span class="o">=</span>VAL5
brooklyn.location.named.my-extended-aws<span class="o">=</span>named:my-aws
brooklyn.location.named.my-extended-aws.KEY<span class="o">=</span>VAL6</code></pre></div>

<h3 id="byon">BYON</h3>

<p>“Bring-your-own-nodes” mode is useful in production, where machines have been provisioned by someone else,
and during testing, to cut down provisioning time.</p>

<p>Your nodes must meet the following prerequisites:</p>

<ul>
  <li>A suitable OS must have been installed on all nodes</li>
  <li>The node must be running sshd (or similar)</li>
  <li>the brooklyn user must be able to ssh to each node as root or as a user with passwordless sudo permission. (For more information on SSH keys, see <a href="#ssh-keys">here</a>.) </li>
</ul>

<p>To deploy to machines with known IP’s in a blueprint, use the following syntax:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">byon</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn</span>
    <span class="l-Scalar-Plain">privateKeyFile</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~/.ssh/brooklyn.pem</span>
    <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">192.168.0.18</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">192.168.0.19</span></code></pre></div>

<p>Some of the login properties as described above for jclouds are supported,
but not <code>loginUser</code> (as no users are created), and not any of the
VM creation parameters such as <code>minRam</code> and <code>imageId</code>.
(These clearly do not apply in the same way, and they are <em>not</em> 
by default treated as constraints, although an entity can confirm these
where needed.)
As before, if the brooklyn user and its default key are authorized for the hosts,
those fields can be omitted.</p>

<p>Named locations can also be configured in your <code>brooklyn.properties</code>,
using the format <code>byon:(key=value,key2=value2)</code>.
For convenience, for hosts wildcard globs are supported.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">brooklyn.location.named.On-Prem<span class="se">\ </span>Iron<span class="se">\ </span><span class="nv">Example</span><span class="o">=</span>byon:<span class="o">(</span><span class="nv">hosts</span><span class="o">=</span><span class="s2">&quot;10.9.1.1,10.9.1.2,produser2@10.9.2.{10,11,20-29}&quot;</span><span class="o">)</span>
brooklyn.location.named.On-Prem<span class="se">\ </span>Iron<span class="se">\ </span>Example.user<span class="o">=</span>produser1
brooklyn.location.named.On-Prem<span class="se">\ </span>Iron<span class="se">\ </span>Example.privateKeyFile<span class="o">=</span>~/.ssh/produser_id_rsa
brooklyn.location.named.On-Prem<span class="se">\ </span>Iron<span class="se">\ </span>Example.privateKeyPassphrase<span class="o">=</span>s3cr3tpassphrase</code></pre></div>

<p>Alternatively, you can create a specific BYON location through the location wizard tool available within the web console.
This location will be saved as a <a href="/brooklyn-docs/v/latest/blueprints/catalog/index.html#locations-in-catalog">catalog entry</a> for easy reusability.</p>

<p>For more complex host configuration, one can define custom config values per machine. In the example 
below, there will be two machines. The first will be a machine reachable on
<code>ssh -i ~/.ssh/brooklyn.pem -p 8022 myuser@50.51.52.53</code>. The second is a windows machine, reachable 
over WinRM. Each machine has also has a private address (e.g. for within a private network).</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">byon</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ssh</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">50.51.52.53:8022</span>
      <span class="l-Scalar-Plain">privateAddresses</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">10.0.0.1</span><span class="p-Indicator">]</span>
      <span class="l-Scalar-Plain">privateKeyFile</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~/.ssh/brooklyn.pem</span>
      <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">myuser</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">winrm</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">50.51.52.54:8985</span>
      <span class="l-Scalar-Plain">privateAddresses</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">10.0.0.2</span><span class="p-Indicator">]</span>
      <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mypassword</span>
      <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">myuser</span>
      <span class="l-Scalar-Plain">osFamily</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">windows</span></code></pre></div>

<p>The BYON location also supports a machine chooser, using the config key <code>byon.machineChooser</code>. 
This allows one to plugin logic to choose from the set of available machines in the pool. For
example, additional config could be supplied for each machine. This could be used (during the call
to <code>location.obtain()</code>) to find the config that matches the requirements of the entity being
provisioned. See <code>FixedListMachineProvisioningLocation.MACHINE_CHOOSER</code>.</p>

<h3 id="ssh-keys">SSH Keys</h3>

<p>SSH keys are one of the simplest and most secure ways to access remote servers.
They consist of two parts:</p>

<ul>
  <li>
    <p>A private key (e.g. <code>id_rsa</code>) which is known only to one party or group</p>
  </li>
  <li>
    <p>A public key (e.g. <code>id_rsa.pub</code>) which can be given to anyone and everyone,
and which can be used to confirm that a party has a private key
(or has signed a communication with the private key)</p>
  </li>
</ul>

<p>In this way, someone – such as you – can have a private key,
and can install a public key on a remote machine (in an <code>authorized_keys</code> file)
for secure automated access.
Commands such as <code>ssh</code> (and Brooklyn) can log in without
revealing the private key to the remote machine,
the remote machine can confirm it is you accessing it (if no one else has the private key),
and no one snooping on the network can decrypt of any of the traffic.</p>

<h4 id="creating-an-ssh-key">Creating an SSH Key</h4>

<p>If you don’t have an SSH key, create one with:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>ssh-keygen -t rsa -N <span class="s2">&quot;&quot;</span> -f ~/.ssh/id_rsa</code></pre></div>

<h4 id="localhost-setup">Localhost Setup</h4>

<p>If you want to deploy to <code>localhost</code>, ensure that you have a public and private key,
and that your key is authorized for ssh access:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># _Appends_ id_rsa.pub to authorized_keys. Other keys are unaffected.</span>
<span class="nv">$ </span>cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</code></pre></div>

<p>Now verify that your setup by running the command: <code>ssh localhost echo hello world</code></p>

<p>If your setup is correct, you should see <code>hello world</code> printed back at you.</p>

<p>On the first connection, you may see a message similar to this:</p>

<pre>
The authenticity of host 'localhost (::1)' can't be established.
RSA key fingerprint is 7b:e3:8e:c6:5b:2a:05:a1:7c:8a:cf:d1:6a:83:c2:ad.
Are you sure you want to continue connecting (yes/no)?
</pre>

<p>Simply answer ‘yes’ and then repeat the command again.</p>

<p>If this isn’t the case, see below. </p>

<h4 id="potential-problems">Potential Problems</h4>

<ul>
  <li>
    <p><strong>MacOS user?</strong> In addition to the above, enable “Remote Login” in “System Preferences &gt; Sharing”.</p>
  </li>
  <li>
    <p><strong>Got a passphrase?</strong> Set <code>brooklyn.location.localhost.privateKeyPassphrase</code>
as described <a href="index.html#os-setup">here</a>.
If you’re not sure, or you don’t know what a passphrase is, you can test this by executing <code>ssh-keygen -y</code>.
If it does <em>not</em> ask for a passphrase, then your key has no passphrase.
If your key does have a passphrase, you can remove it by running <code>ssh-keygen -p</code>.</p>
  </li>
  <li>
    <p>Check that you have an <code>~/.ssh/id_rsa</code> file (or <code>id_dsa</code>) and a corresponding public key with a <code>.pub</code> extension;
if not, create one as described above</p>
  </li>
  <li>
    <p><code>~/.ssh/</code> or files in that directory may have permissions they shouldn’t: 
they should be visible only to the user (apart from public keys),
both on the source machine and the target machine.
You can verify this with <code>ls -l ~/.ssh/</code>:  lines should start with <code>-rw-------</code> or <code>-r--------</code> (or <code>-rwx------</code> for directories). 
If it does not, execute <code>chmod go-rwx ~/.ssh ~/.ssh/*</code>.</p>
  </li>
  <li>
    <p>Sometimes machines are configured with different sets of support SSL/TLS versions and ciphers;
if command-line <code>ssh</code> and <code>scp</code> work, but Brooklyn/java does not, check the versions enabled in Java and on both servers.</p>
  </li>
  <li>
    <p>Missing entropy: creating and using ssh keys requires randomness available on the servers,
usually in <code>/dev/random</code>; see <a href="/brooklyn-docs/v/latest/ops/troubleshooting/increase-entropy.html">here</a> for more information</p>
  </li>
</ul>

<h3 id="localhost">Localhost</h3>

<p>If passwordless ssh login to <code>localhost</code> and passwordless <code>sudo</code> is enabled on your 
machine, you should be able to deploy some blueprints with no special configuration,
just by specifying <code>location: localhost</code> in YAML.</p>

<p>If you use a passphrase or prefer a different key, these can be configured as follows:</p>

<pre><code>location:
  localhost:
    privateKeyFile=~/.ssh/brooklyn_key
    privateKeyPassphrase=s3cr3tPASSPHRASE
</code></pre>

<p>Alternatively, you can create a specific localhost location through the location wizard tool available within the web console.
This location will be saved as a <a href="/brooklyn-docs/v/latest/blueprints/catalog/index.html#locations-in-the-catalog">catalog entry</a>
for easy reusability.</p>

<h4 id="passwordless-sudo">Passwordless Sudo</h4>

<p>If you encounter issues or for more information, see <a href="#localhost-setup">SSH Keys Localhost Setup</a>. </p>

<p>For some blueprints, passwordless sudo is required. (Try executing <code>sudo whoami</code> to see if it prompts for a password. 
To enable passwordless <code>sudo</code> for your account, a line must be added to the system <code>/etc/sudoers</code> file.<br />
To edit the file, use the <code>visudo</code> command:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo visudo</code></pre></div>

<p>Add this line at the bottom of the file, replacing <code>username</code> with your own user:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">username <span class="nv">ALL</span><span class="o">=(</span>ALL<span class="o">)</span> NOPASSWD: ALL</code></pre></div>

<p>If executing the following command does not ask for your password, then <code>sudo</code> has been setup correctly:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo whoami</code></pre></div>

<h3 id="specialized-locations">Specialized Locations</h3>

<p>Some additional location types are supported for specialized situations:</p>

<h4 id="single-host">Single Host</h4>

<p>The spec <code>host</code>, taking a string argument (the address) or a map (<code>host</code>, <code>user</code>, <code>password</code>, etc.),
provides a convenient syntax when specifying a single host.
For example:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">host:(192.168.0.1)</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.jboss.JBoss7Server</span></code></pre></div>

<p>Or, in <code>brooklyn.properties</code>, set <code>brooklyn.location.named.host1=host:(192.168.0.1)</code>.</p>

<h4 id="the-multi-location">The Multi Location</h4>

<p>The spec <code>multi</code> allows multiple locations, specified as <code>targets</code>,
to be combined and treated as one location.</p>

<h5 id="sequential-consumption">Sequential Consumption</h5>

<p>In its simplest form, this will use the first target location where possible,
and will then switch to the second and subsequent locations when there are no
machines available.</p>

<p>In the example below, it provisions the first node to <code>192.168.0.1</code>, then it provisions into AWS
us-east-1 region (because the bring-your-own-nodes region will have run out of nodes).</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">multi</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">targets</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">byon:(hosts=192.168.0.1)</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">jclouds:aws-ec2:us-east-1</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.group.DynamicCluster</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">cluster.initial.size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
    <span class="l-Scalar-Plain">dynamiccluster.memberspec</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">$brooklyn:entitySpec</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.machine.MachineEntity</span></code></pre></div>

<h5 id="round-robin-consumption-and-availability-zones-for-clustered-applications">Round-Robin Consumption and Availability Zones for Clustered Applications</h5>

<p>A <code>DynamicCluster</code> can be configured to cycle through its deployment targets round-robin when
provided with a location that supports the <code>AvailabilityZoneExtension</code> – the <code>multi</code> location
supports this extension.</p>

<p>The configuration option <code>dynamiccluster.zone.enable</code> on <code>DynamicCluster</code> tells it to query the
given location for <code>AvailabilityZoneExtension</code> support. If the location supports it, then the
cluster will query for the list of availability zones (which in this case is simply the list of
targets) and deploy to them round-robin.</p>

<p>In the example below, the cluster will request VMs round-robin across three different
locations (in this case, the locations were already added to the catalog, or defined in
<code>brooklyn.properties</code>).</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">multi</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">targets</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">my-location-1</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">my-location-2</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">my-location-3</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.group.DynamicCluster</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">dynamiccluster.zone.enable</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
    <span class="l-Scalar-Plain">cluster.initial.size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
    <span class="l-Scalar-Plain">dynamiccluster.memberspec</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">$brooklyn:entitySpec</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.machine.MachineEntity</span></code></pre></div>

<p>Of course, clusters can also be deployed round-robin to real availability zones offered by
cloud providers, as long as their locations support <code>AvailabilityZoneExtension</code>. Currently, only
AWS EC2 locations support this feature.</p>

<p>In the example below, the cluster will request VMs round-robin across the availability zones
provided by AWS EC2 in the “us-east-1” region.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">jclouds:aws-ec2:us-east-1</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.group.DynamicCluster</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">dynamiccluster.zone.enable</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
    <span class="l-Scalar-Plain">cluster.initial.size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
    <span class="l-Scalar-Plain">dynamiccluster.memberspec</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">$brooklyn:entitySpec</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.machine.MachineEntity</span></code></pre></div>

<p>For more information about AWS EC2 availability zones, see
<a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html">this guide</a>.</p>

<p>Custom alternatives to round-robin are also possible using the configuration option
<code>dynamiccluster.zone.placementStrategy</code> on <code>DynamicCluster</code>.</p>

<h4 id="the-server-pool">The Server Pool</h4>

<p>The <code>ServerPool</code>
  (<a href="https://github.com/apache/brooklyn-server/tree/master/software/base/src/main/java/org/apache/brooklyn/entity/machine/pool/ServerPool.java">src</a>)</p>

<p>entity type allows defining an entity which becomes available as a location.</p>


            </div>

            <aside class="col-md-3">
                <div class="list-group side-menu" id="side-menu">



  
     
              
                  <h4 class="">
                    <a href="/brooklyn-docs/v/latest/locations/index.html" class="list-group-item active breadcrumb breadcrumb0">
                      Locations</a></h4>
              
              
              
                <a href="/brooklyn-docs/v/latest/locations/index.html#clouds" class="list-group-item">Clouds
                  </a>
              
                <a href="/brooklyn-docs/v/latest/locations/index.html#amazon-web-services-aws" class="list-group-item">Amazon Web Services
                  </a>
              
                <a href="/brooklyn-docs/v/latest/locations/index.html#azure-compute-arm" class="list-group-item">Azure Compute ARM
                  </a>
              
                <a href="/brooklyn-docs/v/latest/locations/index.html#azure-compute-classic" class="list-group-item">Azure Compute Classic
                  </a>
              
                <a href="/brooklyn-docs/v/latest/locations/index.html#cloudstack" class="list-group-item">Apache CloudStack
                  </a>
              
                <a href="/brooklyn-docs/v/latest/locations/index.html#google-compute-engine-gce" class="list-group-item">Google Compute Engine
                  </a>
              
                <a href="/brooklyn-docs/v/latest/locations/index.html#ibm-softlayer" class="list-group-item">IBM Softlayer
                  </a>
              
                <a href="/brooklyn-docs/v/latest/locations/index.html#inheritance-and-named-locations" class="list-group-item">Named Locations
                  </a>
              
                <a href="/brooklyn-docs/v/latest/locations/index.html#openstack" class="list-group-item">OpenStack
                  </a>
              
                <a href="/brooklyn-docs/v/latest/locations/location-customizers.html" class="list-group-item">Location Customizers
                  </a>
              
                <a href="/brooklyn-docs/v/latest/locations/index.html#byon" class="list-group-item">BYON
                  </a>
              
                <a href="/brooklyn-docs/v/latest/locations/index.html#ssh-keys" class="list-group-item">SSH Keys
                  </a>
              
                <a href="/brooklyn-docs/v/latest/locations/index.html#localhost" class="list-group-item">Localhost
                  </a>
              
                <a href="/brooklyn-docs/v/latest/locations/index.html#specialized-locations" class="list-group-item">Specialized Locations
                  </a>
              
    
        
  

        
</div>
<div id="width_reference"></div>


<script language="JavaScript" type="application/javascript">
(function($){
    
    sidemenu_x_sizer=function(){ $('#side-menu').width($('#side-menu').parent().find('#width_reference').outerWidth()); };
    $(sidemenu_x_sizer);
    $(window).resize(sidemenu_x_sizer);

    
    sidemenu_y_nonfloater=function(){
      if ($('#side-menu').outerHeight(true) + $('#header').outerHeight(true) + $('#footer').outerHeight(true) > window.innerHeight ||
          $('#side-menu').width() >= $('#content_container').width()/2) {
        $('#side-menu').css('position', 'inherit');
      } else {
        // restore if screen has grown
        $('#side-menu').css('position', 'fixed');
      }
    };
    $(sidemenu_y_nonfloater);
    $(window).resize(sidemenu_y_nonfloater);

    

    var sideMenu = $("#side-menu"),
        sideItems = sideMenu.find("a"),
        // Anchors corresponding to menu items
        scrollItems = sideItems.map(function(){
          var item = $(this).attr("section-target");
          if (item && item.length) { return item; }
        });

    var highlight_section_last_top = -1;
    var highlight_section_completed = false;

    var highlight_section = function() {
       // Get container scroll position
       var highlight_section_new_top = $(this).scrollTop();
       if (highlight_section_new_top == highlight_section_last_top) return;
       var highlight_section_new_bottom = highlight_section_new_top + $(window).height();
       var scroll_advancing = (highlight_section_new_top > highlight_section_last_top);

       var last_item = null, active_item = $("#side-menu a.section#active");

       var found_top = false;
       var displayable_items = scrollItems.map(function(itemI){
         item = $(scrollItems[itemI]);
         if (item && item.length) {
           if (highlight_section_last_top == -1 || !highlight_section_completed) {
             // just opening page - take item matching hash, or otherwise the first item visible
             if (item.selector === window.location.hash || (item.offset().top > highlight_section_new_top - 20 && !found_top)) {
               found_top = true;
               if (item.selector === window.location.hash && item.offset().top < highlight_section_new_top + 60) {
                 // because of our top header, we need to scroll 64px down from any link
                 $('html, body').animate({scrollTop: item.offset().top - 64}, 0);
               }
               return item;
             }
           } else if (scroll_advancing) {
             // if scrolling advance, pick up a section when title starts before 1/3 height
             if (item.offset().top < highlight_section_new_top + $(window).height()/3)
               return item;

             // or if containing div is finished (usu the whole main content)
             div_containing_item = item.closest("div");
             if (div_containing_item.offset().top + div_containing_item.height() < highlight_section_new_bottom + 15)
               return item;
             // or when next title is visible
             if (last_item && item.offset().top < highlight_section_new_bottom + 15)
               return last_item;
           } else {
             // if scrolling back, pick up a section as soon as the title is visible,
             if (item.offset().top < highlight_section_new_top)
               return item;
             // or if title is before the 2/3 point
             // (not sure about this, probably want also to have
             // "AND the id.top is <= displayable_itemsrent_active_it.top" so we don't jump FORWARD a section
             // when scrolling BACK, with lots of tiny sections)
             if ((item.offset().top < highlight_section_new_top + 2*$(window).height()/3)
                 && (!active_item || !active_item.offset() || active_item.offset().top >= item.offset().top))
               return item;

           }
           last_item = item;
         }
       });
       if (!highlight_section_completed && document.readyState === "complete") {
         highlight_section_completed = true;
       }
       if (!displayable_items.length) {
         $("#side-menu a.section").removeClass("active");
       } else {
         displayable_items = displayable_items[displayable_items.length-1];
         var id = displayable_items && displayable_items.length ? displayable_items[0].id : "";
       // Set/remove active class
         new_active = $("#side-menu a.section").filter("[section-target='#"+id+"']");
         if (new_active.hasClass("active")) {
           // nothing needed
         } else {
           $("#side-menu a.section").removeClass("active");
           $("#side-menu a.section").filter("[section-target='#"+id+"']").addClass("active");
         }
       }

       highlight_section_last_top = highlight_section_new_top;
    };
    var highlight_new_section = function() {
      highlight_section_completed = false;
      highlight_section_last_top = -1;
      highlight_section();
    }

    $(window).scroll(highlight_section);
    $(highlight_new_section);

    // detect link change - courtesy http://www.bennadel.com/blog/1520-binding-events-to-non-dom-objects-with-jquery.htm

    // Default to the current location.
    var strLocation = window.location.href;
    var strHash = window.location.hash;
    var strPrevLocation = "";
    var strPrevHash = "";

    // This is how often we will be checkint for
    // changes on the location.
    var intIntervalTime = 100;

    // This method removes the pound from the hash.
    var fnCleanHash = function( strHash ){
        return(
            strHash.substring( 1, strHash.length )
            );
    }

    // This will be the method that we use to check
    // changes in the window location.
    var fnCheckLocation = function(){
        // Check to see if the location has changed.
        if (strLocation != window.location.href){

            // Store the new and previous locations.
            strPrevLocation = strLocation;
            strPrevHash = strHash;
            strLocation = window.location.href;
            strHash = window.location.hash;

            // The location has changed. Trigger a
            // change event on the location object,
            // passing in the current and previous
            // location values.
            $( window.location ).trigger(
                "change",
                {
                    currentHref: strLocation,
                    currentHash: fnCleanHash( strHash ),
                    previousHref: strPrevLocation,
                    previousHash: fnCleanHash( strPrevHash )
                }
                );

        }
    }

    // Set an interval to check the location changes.
    setInterval( fnCheckLocation, intIntervalTime );

    // and trigger highlight section on link change
    $(window.location).bind("change", highlight_new_section);
})(jQuery);

</script>

            </aside>
        </div>
    </div>
</main>

<footer class="container">
    <div class="row">
        <div class="col-md-9">
            <p>Apache Brooklyn is distributed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License v2.0</a>.</p>
        </div>
        <div class="col-md-3 text-right">
            <p>
                <a class="btn btn-sm btn-default" href="https://github.com/apache/brooklyn-docs/edit/master/guide/locations/index.md">Edit This Page</a>
                <a href="https://brooklyn.apache.org/community/how-to-contribute-docs.html"
                    data-toggle="tooltip" data-placement="top" title="" data-delay="400" data-original-title="How to Edit Documentation">
                    <span class="octicon octicon-question octicon-footer"></span>
                </a>
            </p>
        </div>
    </div>
</footer>

</body>

<!--
  ~ Licensed to the Apache Software Foundation (ASF) under one
  ~ or more contributor license agreements.  See the NOTICE file
  ~ distributed with this work for additional information
  ~ regarding copyright ownership.  The ASF licenses this file
  ~ to you under the Apache License, Version 2.0 (the
  ~ "License"); you may not use this file except in compliance
  ~ with the License.  You may obtain a copy of the License at
  ~
  ~      http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing,
  ~ software distributed under the License is distributed on an
  ~ "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~ KIND, either express or implied.  See the License for the
  ~ specific language governing permissions and limitations
  ~ under the License.
  -->

<script type="text/javascript" src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/brooklyn-docs/style/deps/jquery.cookie.js"></script>
<script type="text/javascript" src="/brooklyn-docs/style/js/zeroclipboard/ZeroClipboard.min.js"></script>
<script type="text/javascript" src="/brooklyn-docs/style/deps/tooltip.js"></script>

<script type="text/javascript">
    ZeroClipboard.config({ moviePath: '/style/js/zeroclipboard/ZeroClipboard.swf' });
</script>
<script src="/brooklyn-docs/style/js/public.js"></script>
</html>
