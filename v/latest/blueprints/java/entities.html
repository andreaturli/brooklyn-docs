<!--
  ~ Licensed to the Apache Software Foundation (ASF) under one
  ~ or more contributor license agreements.  See the NOTICE file
  ~ distributed with this work for additional information
  ~ regarding copyright ownership.  The ASF licenses this file
  ~ to you under the Apache License, Version 2.0 (the
  ~ "License"); you may not use this file except in compliance
  ~ with the License.  You may obtain a copy of the License at
  ~
  ~      http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing,
  ~ software distributed under the License is distributed on an
  ~ "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~ KIND, either express or implied.  See the License for the
  ~ specific language governing permissions and limitations
  ~ under the License.
  -->

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Custom Entity Development - Apache Brooklyn</title>

<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/octicons/octicons.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/bootstrap-theme.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/font-awesome-4.2.0/css/font-awesome.min.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/tooltip.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/css/code.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/css/website.css" rel="stylesheet" />

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
</head>

<body class="page">
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <div class="navbar-brand">
                <a class="brand-apache" href="http://www.apache.org/">
                    <img src="https://www.apache.org/foundation/press/kit/feather.svg" alt="[Apache]">
                </a>
                
                <a class="brand-brooklyn" href="/brooklyn-docs/"><img src="/brooklyn-docs/img/apache-brooklyn-logo-244px-wide.png" alt="brooklyn"></a>
                
            </div>
        </div>
        <div class="collapse navbar-collapse" id="main-menu">


            <ul class="nav navbar-nav navbar-right">
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/learnmore/index.html" data-toggle="dropdown">learn more <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/learnmore/index.html">Learn More</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/blueprint-tour.html">Blueprint Tour
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/features/index.html">Features
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/theory.html">Theory
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/catalog/index.html">Browse Catalog
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/v/latest/start/index.html" data-toggle="dropdown">get started <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/v/latest/start/index.html">Get Started</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/running.html">Running Apache Brooklyn
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/blueprints.html">Deploying Blueprints
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/managing.html">Monitoring and Managing Applications
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/policies.html">Policies
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/concept-quickstart.html">Brooklyn Concepts Quickstart
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown active">
                    
                    <a href="/brooklyn-docs/documentation/index.html" data-toggle="dropdown">documentation <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/documentation/index.html">Documentation</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li class="section">
                            <a href="/brooklyn-docs/v/latest/index.html">User Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/blueprints/creating-yaml.html">Writing Blueprints
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/locations/index.html">Deploying Blueprints
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li class="section">
                            <a href="/brooklyn-docs/v/latest/ops/index.html">Reference Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/dev/index.html">Developer Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        <li class="divider"></li>
                        <li >
                            <a href="/brooklyn-docs/meta/versions.html">Versions
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/documentation/other-docs.html">Other Resources
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/community/index.html" data-toggle="dropdown">community <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/community/index.html">Community</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/mailing-lists.html">Mailing Lists
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/irc.html">IRC
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/security/index.html">Security Advisories
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="https://issues.apache.org/jira/browse/BROOKLYN">Bug Tracker (JIRA)
                                &nbsp;<span class="octicon octicon-link-external"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/how-to-contribute-docs.html">Contributing Documentation
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/developers/index.html" data-toggle="dropdown">developers <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/developers/index.html">Developers</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/code/index.html">Get the Code
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/how-to-contribute.html">How to Contribute
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/dev/index.html">Developer Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/committers/index.html">Committer Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/code-standards.html">Code Standards
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/links.html">Handy Places
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="http://github.com/apache/brooklyn">GitHub
                                &nbsp;<span class="octicon octicon-link-external"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="https://issues.apache.org/jira/browse/BROOKLYN">Bug Tracker (JIRA)
                                &nbsp;<span class="octicon octicon-link-external"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <form class="navbar-form">
                        <a href="/brooklyn-docs/download/index.html" class="btn btn-default">download</a>
                    </form>
                    
                </li>
                
            </ul>
        </div>
    </div>
</nav>


<main>
    <div class="container">
        <div class="row">
            <div class="col-md-9 content">
                <div id="page_notes"></div>
                <h1>Custom Entity Development</h1>
                <p>This section details how to create new custom application components or groups as brooklyn entities.</p>

<h2 id="the-entity-lifecycle">The Entity Lifecycle</h2>

<ul>
  <li>Importance of serialization, ref to How mananagement works</li>
  <li>Parents and Membership (groups)</li>
</ul>

<h2 id="what-to-extend----implementation-classes">What to Extend – Implementation Classes</h2>

<ul>
  <li>
    <p>entity implementation class hierarchy</p>

    <ul>
      <li><code>SoftwareProcess</code> as the main starting point for base entities (corresponding to software processes),
and subclasses such as <code>VanillaJavaApp</code></li>
      <li><code>DynamicCluster</code> (multiple instances of the same entity in a location) and 
<code>DynamicFabric</code> (clusters in multiple location) for automatically creating many instances,
supplied with an <code>EntityFactory</code> (e.g. <code>BaseEntityFactory</code>) in the <code>factory</code> flag</li>
      <li><code>AbstractGroup</code> for collecting entities which are parented elsewhere in the hierachy</li>
      <li><code>AbstractEntity</code> if nothing else fits</li>
    </ul>
  </li>
  <li>
    <p>traits (mixins, otherwise known as interfaces with statics) to define available config keys, sensors, and effectors;
  and conveniences e.g. <code>StartableMethods.{start,stop}</code> is useful for entities which implement <code>Startable</code></p>
  </li>
  <li>
    <p>the <code>Entities</code> class provides some generic convenience methods; worth looking at it for any work you do</p>
  </li>
</ul>

<p>A common lifecycle pattern is that the <code>start</code> effector (see more on effectors below) is invoked, 
often delegating either to a driver (for software processes) or children entities (for clusters etc).</p>

<h2 id="configuration">Configuration</h2>
<!---
TODO: why to use config?
-->

<ul>
  <li>
    <p>AttributeSensorAndConfigKey fields can be automatically converted for <code>SoftwareProcess</code>. 
This is done in <code>preStart()</code>. This must be done manually if required for other entities,
often with <code>ConfigToAttributes.apply(this)</code>.</p>
  </li>
  <li>
    <p>Setting ports is a special challenge, and one which the <code>AttributeSensorAndConfigKey</code> is particularly helpful for,
cf <code>PortAttributeSensorAndConfigKey</code> (a subclass),
causing ports automatically get assigned from a range and compared with the target <code>PortSupplied</code> location.</p>

    <p>Syntax is as described in the PortRange interface. For example, “8080-8099,8800+” will try port 8080, try sequentially through 8099, then try from 8800 until all ports are exhausted.</p>

    <p>This is particularly useful on a contended machine (localhost!). Like ordinary configuration, the config is done by the user, and the actual port used is reported back as a sensor on the entity.</p>
  </li>
  <li>
    <p>Validation of config values can be applied by supplying a <code>Predicate</code> to the <code>constraint</code> of a ConfigKey builder.
Constraints are tested after an entity is initialised and before an entity managed.
Useful predicates include:</p>
    <ul>
      <li><code>StringPredicates.isNonBlank</code>: require that a String key is neither null nor empty.</li>
      <li><code>ResourcePredicates.urlExists</code>: require that a URL that is loadable by Brooklyn. Use this to
confirm that necessary resources are available to the entity.</li>
      <li><code>Predicates.in</code>: require one of a fixed set of values.</li>
      <li><code>Predicates.containsPattern</code>: require that a value match a regular expression pattern.</li>
    </ul>

    <p>An important caveat is that only constraints on config keys that are on an entity’s type hierarchy can be
tested automatically. Brooklyn has no knowledge of the true type of other keys until they are retrieved with a
<code>config().get(key)</code>.</p>
  </li>
</ul>

<h2 id="implementing-sensors">Implementing Sensors</h2>

<ul>
  <li>e.g. HTTP, JMX</li>
</ul>

<p>Sensors at base entities are often retrieved by feeds which poll the entity’s corresponding instance in the real world.
The <code>SoftwareProcess</code> provides a good example; by subclassing it and overriding the <code>connectSensors()</code> method
you could wire some example sensors using the following: </p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">connectSensors</span><span class="o">()</span> <span class="o">{</span>
	<span class="kd">super</span><span class="o">.</span><span class="na">connectSensors</span><span class="o">()</span>
	
    <span class="n">httpFeed</span> <span class="o">=</span> <span class="n">HttpFeed</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">entity</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
            <span class="o">.</span><span class="na">period</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
            <span class="o">.</span><span class="na">baseUri</span><span class="o">(</span><span class="n">mgmtUrl</span><span class="o">)</span>
            <span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpPollConfig</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;(</span><span class="n">SERVICE_UP</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">onSuccess</span><span class="o">(</span><span class="n">HttpValueFunctions</span><span class="o">.</span><span class="na">responseCodeEquals</span><span class="o">(</span><span class="mi">200</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">Functions</span><span class="o">.</span><span class="na">constant</span><span class="o">(</span><span class="kc">false</span><span class="o">)))</span>
            <span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpPollConfig</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;(</span><span class="n">REQUEST_COUNT</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">onSuccess</span><span class="o">(</span><span class="n">HttpValueFunctions</span><span class="o">.</span><span class="na">jsonContents</span><span class="o">(</span><span class="s">&quot;requestCount&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">)))</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
    
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">disconnectSensors</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">disconnectSensors</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">httpFeed</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">httpFeed</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
<span class="o">}</span></code></pre></div>

<p>In this example (a simplified version of <code>JBoss7Server</code>), the url returns metrics in JSON. 
We report the entity as up if we get back an http response code of 200, or down if any other response code or exception.
We retrieve the request count from the response body, and convert it to an integer.</p>

<p>Note the first line (<code>super.connectSensors()</code>); as one descends into specific convenience subclasses (such as for Java web-apps), the work done by the parent class’s overridden methods may be relevant, and will want to be invoked or even added to a resulting list.</p>

<p>For some sensors, and often at compound entities, the values are obtained by monitoring values of other sensors on the same (in the case of a rolling average) or different (in the case of the average of children nodes) entities. This is achieved by policies, described below.</p>

<h2 id="implementing-effectors">Implementing Effectors</h2>

<p>The <code>Entity</code> interface defines the sensors and effectors available. The entity class provides 
wiring for the sensors, and the effector implementations. In simple cases it may be straightforward 
to capture the behaviour of the effectors in a simple methods.
For example deploying a WAR to a cluster can be done as follows:</p>

<p><em>This section is not complete. Feel free to <a href="https://github.com/apache/brooklyn-docs">fork</a> the docs and lend a hand.</em></p>

<!---
TODO show an effector which recurses across children
-->

<p>For some entities, specifically base entities, the implementation of effectors might need other tools (such as SSH), and may vary by location, so having a single implementation is not appropriate.</p>

<p>The problem of multiple inheritance (e.g. SSH functionality and entity inheritance) and multiple implementations (e.g. SSH versus Windows) is handled in brooklyn using delegates called <em>drivers</em>. </p>

<p>In the implementations of <code>JavaWebApp</code> entities, the behaviour which the entity always does is captured in the entity class (for example, breaking deployment of multiple WARs into atomic actions), whereas implementations which is specific to a particular entity and driver (e.g. using scp to copy the WARs to the right place and install them, which of course is different among appservers, or using an HTTP or JMX management API, again where details vary between appservers) is captured in a driver class.</p>

<p>Routines which are convenient for specific drivers can then be inherited in the driver class hierarchy. For example, when passing JMX environment variables to Java over SSH, <code>JavaSoftwareProcessSshDriver</code> extends <code>AbstractSoftwareProcessSshDriver</code> and parents <code>JBoss7SshDriver</code>.</p>

<!---
TODO more drivers such as jmx, etc are planned
-->

<h2 id="testing">Testing</h2>

<ul>
  <li>Unit tests can make use of <code>SimulatedLocation</code> and <code>TestEntity</code>, and can extend <code>BrooklynAppUnitTestSupport</code>.</li>
  <li>Integration tests and use a <code>LocalhostMachineProvisioningLocation</code>, and can also extend <code>BrooklynAppUnitTestSupport</code>.</li>
</ul>

<p><a name="SoftwareProcess-lifecycle"></a></p>

<h2 id="softwareprocess-lifecycle">SoftwareProcess Lifecycle</h2>

<p><code>SoftwareProcess</code> is the common super-type of most integration components (when implementing in Java).</p>

<p>See <code>JBoss7Server</code> and <code>MySqlNode</code> for exemplars.</p>

<p>The methods called in a <code>SoftwareProcess</code> entity’s lifecycle are described below. The most important steps are shown in bold (when writing a new entity, these are the methods most often implemented).</p>

<ul>
  <li>Initial creation (via <code>EntitySpec</code> or YAML):
    <ul>
      <li><strong>no-arg constructor</strong></li>
      <li><strong>init</strong></li>
      <li>add locations</li>
      <li>apply initializers</li>
      <li>add enrichers</li>
      <li>add policies</li>
      <li>add children</li>
      <li>manages entity (so is discoverable by other entities)</li>
    </ul>
  </li>
  <li>Start:
    <ul>
      <li>provisions new machine, if the location is a <code>MachineProvisioningLocation</code></li>
      <li>creates new driver
        <ul>
          <li><strong>calls <code>getDriverInterface</code></strong></li>
          <li>Infers the concrete driver class from the machine-type, 
e.g. by default it adds “Ssh” before the word “Driver” in “JBoss7Driver”.</li>
          <li>instantiates the driver, <strong>calling the constructor</strong> to pass in the entity itself and the machine location</li>
        </ul>
      </li>
      <li>sets attributes from config (e.g. for ports being used)</li>
      <li>calls <code>entity.preStart()</code></li>
      <li>calls <code>driver.start()</code>, which:
        <ul>
          <li>runs pre-install command (see config key <code>pre.install.command</code>)</li>
          <li>uploads install resources (see config keys <code>files.install</code> and <code>templates.install</code>)</li>
          <li><strong>calls <code>driver.install()</code></strong></li>
          <li>runs post-install command (see config key <code>post.install.command</code>)</li>
          <li><strong>calls <code>driver.customize()</code></strong></li>
          <li>uploads runtime resources (see config keys <code>files.runtime</code> and <code>templates.runtime</code>)</li>
          <li>runs pre-launch command (see config key <code>pre.launch.command</code>)</li>
          <li><strong>calls <code>driver.launch()</code></strong></li>
          <li>runs post-launch command (see config key <code>post.launch.command</code>)</li>
          <li>calls <code>driver.postLaunch()</code></li>
        </ul>
      </li>
      <li>calls <code>entity.postDriverStart()</code>, which:
        <ul>
          <li>calls <code>enity.waitForEntityStart()</code> - <strong>waits for <code>driver.isRunning()</code> to report true</strong></li>
        </ul>
      </li>
      <li><strong>calls <code>entity.connectSensors()</code></strong></li>
      <li>calls <code>entity.waitForServicUp()</code></li>
      <li>calls <code>entity.postStart()</code></li>
    </ul>
  </li>
  <li>Restart:
    <ul>
      <li>If restarting machine…
        <ul>
          <li>calls <code>entity.stop()</code>, with <code>stopMachine</code> set to true.</li>
          <li>calls start</li>
          <li>restarts children (if configured to do so)</li>
        </ul>
      </li>
      <li>Else (i.e. not restarting machine)…
        <ul>
          <li>calls <code>entity.preRestart()</code></li>
          <li>calls <code>driver.restart()</code>
            <ul>
              <li><strong>calls <code>driver.stop()</code></strong></li>
              <li><strong>calls <code>driver.launch()</code></strong></li>
              <li>calls <code>driver.postLaunch()</code></li>
            </ul>
          </li>
          <li>restarts children (if configured to do so)</li>
          <li>calls <code>entity.postDriverStart()</code>, which:
            <ul>
              <li>calls <code>enity.waitForEntityStart()</code> - <strong>polls <code>driver.isRunning()</code></strong>, waiting for true</li>
            </ul>
          </li>
          <li>calls <code>entity.waitForServicUp()</code></li>
          <li>calls <code>entity.postStart()</code></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Stop:
    <ul>
      <li>calls <code>entity.preStopConfirmCustom()</code> - aborts if exception.</li>
      <li>calls <code>entity.preStop()</code></li>
      <li>stops the process:
        <ul>
          <li>stops children (if configured to do so)</li>
          <li><strong>calls <code>driver.stop()</code></strong></li>
        </ul>
      </li>
      <li>stops the machine (if configured to do so)</li>
      <li>calls <code>entity.postStop()</code></li>
    </ul>
  </li>
  <li>Rebind (i.e. when Brooklyn is restarted):
    <ul>
      <li><strong>no-arg constructor</strong></li>
      <li>reconstitutes entity (e.g. setting config and attributes)</li>
      <li>If entity was running…
        <ul>
          <li>calls <code>entity.rebind()</code>; if previously started then:
            <ul>
              <li>creates the driver (same steps as for start)</li>
              <li>calls <code>driver.rebind()</code></li>
              <li><strong>calls <code>entity.connectSensors()</code></strong></li>
            </ul>
          </li>
        </ul>
      </li>
      <li>attaches policies, enrichers and persisted feeds</li>
      <li>manages the entity (so is discoverable by other entities)</li>
    </ul>
  </li>
</ul>

            </div>

            <aside class="col-md-3">
                <div class="list-group side-menu" id="side-menu">



  
     
              
                  <h4 class=" with_following">
                    <a href="/brooklyn-docs/v/latest/index.html" class="list-group-item breadcrumb breadcrumb0">
                      User Guide
                      </a></h4>
              
                  <h4 class=" with_preceding with_following">
                    <a href="/brooklyn-docs/v/latest/blueprints/index.html" class="list-group-item breadcrumb breadcrumb1">
                      Writing Blueprints
                      </a></h4>
              
                  <h4 class=" with_preceding">
                    <a href="/brooklyn-docs/v/latest/blueprints/java/index.html" class="list-group-item breadcrumb breadcrumb2">
                      Java Entities
                      </a></h4>
              
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/java/archetype.html" class="list-group-item">Creating from a Maven Archetype
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/java/defining-and-deploying.html" class="list-group-item">Defining and Deploying
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/java/bundle-dependencies.html" class="list-group-item">Handling Bundle Dependencies
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/java/topology-dependencies.html" class="list-group-item">Topology, Dependencies, and Management Policies
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/java/common-usage.html" class="list-group-item">Common Classes and Entities
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/java/feeds.html" class="list-group-item">Feeds
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/java/entity.html" class="list-group-item">Writing an Entity
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/java/entities.html" class="list-group-item active">Custom Entity Development
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/java/service-state.html" class="list-group-item">Service State
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/java/entitlements.html" class="list-group-item">Entitlements
                    </a>
                
              
        
        
  

        
</div>
<div id="width_reference"></div>


<script language="JavaScript" type="application/javascript">
(function($){
    
    sidemenu_x_sizer=function(){ $('#side-menu').width($('#side-menu').parent().find('#width_reference').outerWidth()); };
    $(sidemenu_x_sizer);
    $(window).resize(sidemenu_x_sizer);

    
    sidemenu_y_nonfloater=function(){
      if ($('#side-menu').outerHeight(true) + $('#header').outerHeight(true) + $('#footer').outerHeight(true) > window.innerHeight ||
          $('#side-menu').width() >= $('#content_container').width()/2) {
        $('#side-menu').css('position', 'inherit');
      } else {
        // restore if screen has grown
        $('#side-menu').css('position', 'fixed');
      }
    };
    $(sidemenu_y_nonfloater);
    $(window).resize(sidemenu_y_nonfloater);

    

    var sideMenu = $("#side-menu"),
        sideItems = sideMenu.find("a"),
        // Anchors corresponding to menu items
        scrollItems = sideItems.map(function(){
          var item = $(this).attr("section-target");
          if (item && item.length) { return item; }
        });

    var highlight_section_last_top = -1;
    var highlight_section_completed = false;

    var highlight_section = function() {
       // Get container scroll position
       var highlight_section_new_top = $(this).scrollTop();
       if (highlight_section_new_top == highlight_section_last_top) return;
       var highlight_section_new_bottom = highlight_section_new_top + $(window).height();
       var scroll_advancing = (highlight_section_new_top > highlight_section_last_top);

       var last_item = null, active_item = $("#side-menu a.section#active");

       var found_top = false;
       var displayable_items = scrollItems.map(function(itemI){
         item = $(scrollItems[itemI]);
         if (item && item.length) {
           if (highlight_section_last_top == -1 || !highlight_section_completed) {
             // just opening page - take item matching hash, or otherwise the first item visible
             if (item.selector === window.location.hash || (item.offset().top > highlight_section_new_top - 20 && !found_top)) {
               found_top = true;
               if (item.selector === window.location.hash && item.offset().top < highlight_section_new_top + 60) {
                 // because of our top header, we need to scroll 64px down from any link
                 $('html, body').animate({scrollTop: item.offset().top - 64}, 0);
               }
               return item;
             }
           } else if (scroll_advancing) {
             // if scrolling advance, pick up a section when title starts before 1/3 height
             if (item.offset().top < highlight_section_new_top + $(window).height()/3)
               return item;

             // or if containing div is finished (usu the whole main content)
             div_containing_item = item.closest("div");
             if (div_containing_item.offset().top + div_containing_item.height() < highlight_section_new_bottom + 15)
               return item;
             // or when next title is visible
             if (last_item && item.offset().top < highlight_section_new_bottom + 15)
               return last_item;
           } else {
             // if scrolling back, pick up a section as soon as the title is visible,
             if (item.offset().top < highlight_section_new_top)
               return item;
             // or if title is before the 2/3 point
             // (not sure about this, probably want also to have
             // "AND the id.top is <= displayable_itemsrent_active_it.top" so we don't jump FORWARD a section
             // when scrolling BACK, with lots of tiny sections)
             if ((item.offset().top < highlight_section_new_top + 2*$(window).height()/3)
                 && (!active_item || !active_item.offset() || active_item.offset().top >= item.offset().top))
               return item;

           }
           last_item = item;
         }
       });
       if (!highlight_section_completed && document.readyState === "complete") {
         highlight_section_completed = true;
       }
       if (!displayable_items.length) {
         $("#side-menu a.section").removeClass("active");
       } else {
         displayable_items = displayable_items[displayable_items.length-1];
         var id = displayable_items && displayable_items.length ? displayable_items[0].id : "";
       // Set/remove active class
         new_active = $("#side-menu a.section").filter("[section-target='#"+id+"']");
         if (new_active.hasClass("active")) {
           // nothing needed
         } else {
           $("#side-menu a.section").removeClass("active");
           $("#side-menu a.section").filter("[section-target='#"+id+"']").addClass("active");
         }
       }

       highlight_section_last_top = highlight_section_new_top;
    };
    var highlight_new_section = function() {
      highlight_section_completed = false;
      highlight_section_last_top = -1;
      highlight_section();
    }

    $(window).scroll(highlight_section);
    $(highlight_new_section);

    // detect link change - courtesy http://www.bennadel.com/blog/1520-binding-events-to-non-dom-objects-with-jquery.htm

    // Default to the current location.
    var strLocation = window.location.href;
    var strHash = window.location.hash;
    var strPrevLocation = "";
    var strPrevHash = "";

    // This is how often we will be checkint for
    // changes on the location.
    var intIntervalTime = 100;

    // This method removes the pound from the hash.
    var fnCleanHash = function( strHash ){
        return(
            strHash.substring( 1, strHash.length )
            );
    }

    // This will be the method that we use to check
    // changes in the window location.
    var fnCheckLocation = function(){
        // Check to see if the location has changed.
        if (strLocation != window.location.href){

            // Store the new and previous locations.
            strPrevLocation = strLocation;
            strPrevHash = strHash;
            strLocation = window.location.href;
            strHash = window.location.hash;

            // The location has changed. Trigger a
            // change event on the location object,
            // passing in the current and previous
            // location values.
            $( window.location ).trigger(
                "change",
                {
                    currentHref: strLocation,
                    currentHash: fnCleanHash( strHash ),
                    previousHref: strPrevLocation,
                    previousHash: fnCleanHash( strPrevHash )
                }
                );

        }
    }

    // Set an interval to check the location changes.
    setInterval( fnCheckLocation, intIntervalTime );

    // and trigger highlight section on link change
    $(window.location).bind("change", highlight_new_section);
})(jQuery);

</script>

            </aside>
        </div>
    </div>
</main>

<footer class="container">
    <div class="row">
        <div class="col-md-9">
            <p>Apache Brooklyn is distributed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License v2.0</a>.</p>
        </div>
        <div class="col-md-3 text-right">
            <p>
                <a class="btn btn-sm btn-default" href="https://github.com/apache/brooklyn-docs/edit/master/guide/blueprints/java/entities.md">Edit This Page</a>
                <a href="https://brooklyn.apache.org/community/how-to-contribute-docs.html"
                    data-toggle="tooltip" data-placement="top" title="" data-delay="400" data-original-title="How to Edit Documentation">
                    <span class="octicon octicon-question octicon-footer"></span>
                </a>
            </p>
        </div>
    </div>
</footer>

</body>

<!--
  ~ Licensed to the Apache Software Foundation (ASF) under one
  ~ or more contributor license agreements.  See the NOTICE file
  ~ distributed with this work for additional information
  ~ regarding copyright ownership.  The ASF licenses this file
  ~ to you under the Apache License, Version 2.0 (the
  ~ "License"); you may not use this file except in compliance
  ~ with the License.  You may obtain a copy of the License at
  ~
  ~      http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing,
  ~ software distributed under the License is distributed on an
  ~ "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~ KIND, either express or implied.  See the License for the
  ~ specific language governing permissions and limitations
  ~ under the License.
  -->

<script type="text/javascript" src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/brooklyn-docs/style/deps/jquery.cookie.js"></script>
<script type="text/javascript" src="/brooklyn-docs/style/js/zeroclipboard/ZeroClipboard.min.js"></script>
<script type="text/javascript" src="/brooklyn-docs/style/deps/tooltip.js"></script>

<script type="text/javascript">
    ZeroClipboard.config({ moviePath: '/style/js/zeroclipboard/ZeroClipboard.swf' });
</script>
<script src="/brooklyn-docs/style/js/public.js"></script>
</html>
