<!--
  ~ Licensed to the Apache Software Foundation (ASF) under one
  ~ or more contributor license agreements.  See the NOTICE file
  ~ distributed with this work for additional information
  ~ regarding copyright ownership.  The ASF licenses this file
  ~ to you under the Apache License, Version 2.0 (the
  ~ "License"); you may not use this file except in compliance
  ~ with the License.  You may obtain a copy of the License at
  ~
  ~      http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing,
  ~ software distributed under the License is distributed on an
  ~ "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~ KIND, either express or implied.  See the License for the
  ~ specific language governing permissions and limitations
  ~ under the License.
  -->

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Persistence - Apache Brooklyn</title>

<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/octicons/octicons.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/bootstrap-theme.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/font-awesome-4.2.0/css/font-awesome.min.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/tooltip.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/css/code.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/css/website.css" rel="stylesheet" />

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
</head>

<body class="page">
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <div class="navbar-brand">
                <a class="brand-apache" href="http://www.apache.org/">
                    <img src="https://www.apache.org/foundation/press/kit/feather.svg" alt="[Apache]">
                </a>
                
                <a class="brand-brooklyn" href="/brooklyn-docs/"><img src="/brooklyn-docs/img/apache-brooklyn-logo-244px-wide.png" alt="brooklyn"></a>
                
            </div>
        </div>
        <div class="collapse navbar-collapse" id="main-menu">


            <ul class="nav navbar-nav navbar-right">
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/learnmore/index.html" data-toggle="dropdown">learn more <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/learnmore/index.html">Learn More</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/blueprint-tour.html">Blueprint Tour
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/features/index.html">Features
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/theory.html">Theory
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/catalog/index.html">Browse Catalog
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/v/latest/start/index.html" data-toggle="dropdown">get started <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/v/latest/start/index.html">Get Started</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/running.html">Running Apache Brooklyn
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/blueprints.html">Deploying Blueprints
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/managing.html">Monitoring and Managing Applications
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/policies.html">Policies
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/concept-quickstart.html">Brooklyn Concepts Quickstart
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown active">
                    
                    <a href="/brooklyn-docs/documentation/index.html" data-toggle="dropdown">documentation <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/documentation/index.html">Documentation</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li class="section">
                            <a href="/brooklyn-docs/v/latest/index.html">User Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/blueprints/creating-yaml.html">Writing Blueprints
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/locations/index.html">Deploying Blueprints
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li class="section">
                            <a href="/brooklyn-docs/v/latest/ops/index.html">Reference Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/dev/index.html">Developer Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        <li class="divider"></li>
                        <li >
                            <a href="/brooklyn-docs/meta/versions.html">Versions
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/documentation/other-docs.html">Other Resources
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/community/index.html" data-toggle="dropdown">community <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/community/index.html">Community</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/mailing-lists.html">Mailing Lists
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/irc.html">IRC
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/security/index.html">Security Advisories
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="https://issues.apache.org/jira/browse/BROOKLYN">Bug Tracker (JIRA)
                                &nbsp;<span class="octicon octicon-link-external"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/how-to-contribute-docs.html">Contributing Documentation
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/developers/index.html" data-toggle="dropdown">developers <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/developers/index.html">Developers</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/code/index.html">Get the Code
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/how-to-contribute.html">How to Contribute
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/dev/index.html">Developer Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/committers/index.html">Committer Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/code-standards.html">Code Standards
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/links.html">Handy Places
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="http://github.com/apache/brooklyn">GitHub
                                &nbsp;<span class="octicon octicon-link-external"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="https://issues.apache.org/jira/browse/BROOKLYN">Bug Tracker (JIRA)
                                &nbsp;<span class="octicon octicon-link-external"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <form class="navbar-form">
                        <a href="/brooklyn-docs/download/index.html" class="btn btn-default">download</a>
                    </form>
                    
                </li>
                
            </ul>
        </div>
    </div>
</nav>


<main>
    <div class="container">
        <div class="row">
            <div class="col-md-9 content">
                <div id="page_notes"></div>
                <h1>Persistence</h1>
                <p>Brooklyn can be configured to persist its state so that the Brooklyn server can be restarted, 
or so that a high availability standby server can take over.</p>

<p>Brooklyn can persist its state to one of two places: the file system, or to an Object Store
of your choice.</p>

<h2 id="command-line-options">Command Line Options</h2>

<p>To configure brooklyn, the relevant command line options for the <code>launch</code> commands are:</p>

<ul>
  <li><code>--persist</code> <persistence mode="">
The persistence mode.</persistence></li>
  <li><code>--persistenceDir</code> <persistence dir="">
The directory to read/write persisted state (or container name if using an object store).</persistence></li>
  <li><code>--persistenceLocation</code> <persistence location="">
The location spec for an object store to read/write persisted state.</persistence></li>
</ul>

<p>For the persistence mode, the possible values are:</p>

<ul>
  <li><code>disabled</code> means that no state will be persisted or read; when Brooklyn stops all state is lost.</li>
  <li><code>rebind</code> means that it will read existing state, and recreate entities, locations and policies 
from that. If there is no existing state, startup will fail.</li>
  <li><code>clean</code> means that any existing state will be deleted, and Brooklyn will be started afresh.</li>
  <li><code>auto</code> means Brooklyn will rebind if there is any existing state, or will start afresh if 
there is no state.</li>
</ul>

<p>The persistence directory and location can instead be specified from <code>brooklyn.properties</code> using
the following config keys:</p>

<ul>
  <li><code>brooklyn.persistence.dir</code></li>
  <li><code>brooklyn.persistence.location.spec</code></li>
</ul>

<h2 id="file-based-persistence">File-based Persistence</h2>

<p>To persist to the file system, start brooklyn with:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">brooklyn launch --persist auto --persistenceDir /path/to/myPersistenceDir</code></pre></div>

<p>If there is already data at <code>/path/to/myPersistenceDir</code>, then a backup of the directory will 
be made. This will have a name like <code>/path/to/myPersistenceDir.20140701-142101345.bak</code>.</p>

<p>The state is written to the given path. The file structure under that path is:</p>

<ul>
  <li><code>./entities/</code></li>
  <li><code>./locations/</code></li>
  <li><code>./policies/</code></li>
  <li><code>./enrichers/</code></li>
</ul>

<p>In each of those directories, an XML file will be created per item - for example a file per
entity in <code>./entities/</code>. This file will capture all of the state - for example, an
entity’s: id; display name; type; config; attributes; tags; relationships to locations, child 
entities, group membership, policies and enrichers; and dynamically added effectors and sensors.</p>

<p>If using the default persistence dir (i.e. no <code>--persistenceDir</code> was specified), then Brooklyn will
write its state to <code>~/.brooklyn/brooklyn-persisted-state/data</code>. Copies of this directory
will be automatically created in <code>~/.brooklyn/brooklyn-persisted-state/backups/</code> each time Brooklyn 
is restarted (or if a standby Brooklyn instances takes over as master).</p>

<p>A custom directory for Brooklyn state can also be configured in <code>brooklyn.properties</code> using:</p>

<pre><code># For all Brooklyn files
brooklyn.base.dir=/path/to/base/dir

# Sub-directory of base.dir for writing persisted state (if relative). If directory
# starts with "/" (or "~/", or something like "c:\") then assumed to be absolute. 
brooklyn.persistence.dir=data

# Sub-directory of base.dir for creating backup directories (if relative). If directory
# starts with "/" (or "~/", or something like "c:\") then assumed to be absolute. 
brooklyn.persistence.backups.dir=backups
</code></pre>

<p>This <code>base.dir</code> will also include temporary files such as the OSGi cache.</p>

<p>If <code>persistence.dir</code> is not specified then it will use the sub-directory
<code>brooklyn-persisted-state/data</code> of the <code>base.dir</code>. If the <code>backups.dir</code> is not specified
the backup directories will be created in the sub-directory <code>backups</code> of the persistence dir.</p>

<h2 id="object-store-persistence">Object Store Persistence</h2>

<p>Brooklyn can persist its state to any Object Store API that jclouds supports including 
S3, Swift and Azure. This gives access to any compatible Object Store product or cloud provider
including AWS-S3, SoftLayer, Rackspace and Microsoft Azure. For a complete list of supported
providers, see <a href="http://jclouds.apache.org/reference/providers/#blobstore">jclouds</a>.</p>

<p>To configure the Object Store, add the credentials to <code>~/.brooklyn/brooklyn.properties</code> such as:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.location.named.aws-s3-eu-west-1</span><span class="o">=</span><span class="s">aws-s3:eu-west-1</span>
<span class="na">brooklyn.location.named.aws-s3-eu-west-1.identity</span><span class="o">=</span><span class="s">ABCDEFGHIJKLMNOPQRSTU</span>
<span class="na">brooklyn.location.named.aws-s3-eu-west-1.credential</span><span class="o">=</span><span class="s">abcdefghijklmnopqrstuvwxyz1234567890ab/c</span></code></pre></div>

<p>or:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.location.named.softlayer-swift-ams01</span><span class="o">=</span><span class="s">jclouds:openstack-swift:https://ams01.objectstorage.softlayer.net/auth/v1.0</span>
<span class="na">brooklyn.location.named.softlayer-swift-ams01.identity</span><span class="o">=</span><span class="s">ABCDEFGHIJKLM:myname</span>
<span class="na">brooklyn.location.named.softlayer-swift-ams01.credential</span><span class="o">=</span><span class="s">abcdefghijklmnopqrstuvwxyz1234567890abcdefghijklmnopqrstuvwxyz12</span>
<span class="na">brooklyn.location.named.softlayer-swift-ams01.jclouds.keystone.credential-type</span><span class="o">=</span><span class="s">tempAuthCredentials</span></code></pre></div>

<p>Start Brooklyn pointing at this target object store, e.g.:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">nohup brooklyn launch --persist auto --persistenceDir myContainerName --persistenceLocation named:softlayer-swift-ams01 <span class="p">&amp;</span></code></pre></div>

<p>The following <code>brooklyn.properties</code> options can also be used:</p>

<pre><code># Location spec string for an object store (e.g. jclouds:openstack-swift:URL) where persisted state 
# should be kept; if blank or not supplied, the file system is used.
brooklyn.persistence.location.spec=&lt;location&gt;

# Container name for writing persisted state
brooklyn.persistence.dir=/path/to/dataContainer

# Location spec string for an object store (e.g. jclouds:openstack-swift:URL) where backups of  
# persisted state should be kept; defaults to the local file system.
brooklyn.persistence.backups.location.spec=&lt;location&gt;

# Container name for writing backups of persisted state;
# defaults to 'backups' inside the default persistence container.
brooklyn.persistence.backups.dir=/path/to/backupContainer
</code></pre>

<h2 id="rebinding-to-state">Rebinding to State</h2>

<p>When Brooklyn starts up pointing at existing state, it will recreate the entities, locations 
and policies based on that persisted state.</p>

<p>Once all have been created, Brooklyn will “manage” the entities. This will bind to the 
underlying entities under management to update the each entity’s sensors (e.g. to poll over 
HTTP or JMX). This new state will be reported in the web-console and can also trigger 
any registered policies.</p>

<h2 id="cli-commands-for-copying-state">CLI Commands for Copying State</h2>

<p>Brooklyn includes a command to copy persistence state easily between two locations.
The <code>copy-state</code> CLI command takes the following arguments:</p>

<ul>
  <li><code>--persistenceDir</code> <source persistence="" dir="" />
The directory to read persisted state (or container name if using an object store).</li>
  <li><code>--persistenceLocation</code> <source persistence="" location="" />
The location spec for an object store to read persisted state.</li>
  <li><code>--destinationDir</code> <target persistence="" dir="">
The directory to copy persistence data to (or container name if using an object store).</target></li>
  <li><code>--destinationLocation</code> <target persistence="" location="">
The location spec for an object store to copy data to.</target></li>
  <li><code>--transformations</code> <transformations>
The local transformations file to be applied to the copy of the data before uploading it.</transformations></li>
</ul>

<h2 id="cli-commands-for-cleaning-orphaned-state">CLI Commands for Cleaning Orphaned State</h2>

<p>Brooklyn includes a command to clean orphaned state which uses the copy state command
and removes orphaned locations, enrichers, policies and feeds from the copied state.
The <code>clean-orphaned-state</code> CLI command takes the following arguments:</p>

<ul>
  <li><code>--persistenceDir</code> <source persistence="" dir="" />
The directory to read persisted state (or container name if using an object store).</li>
  <li><code>--persistenceLocation</code> <source persistence="" location="" />
The location spec for an object store to read persisted state.</li>
  <li><code>--destinationDir</code> <target persistence="" dir="">
The directory to copy persistence data to, with orphaned state removed.</target></li>
  <li><code>--destinationLocation</code> <target persistence="" location="">
The location spec for an object store to copy data to.</target></li>
</ul>

<h2 id="handling-rebind-failures">Handling Rebind Failures</h2>

<p>If rebind fails fail for any reason, details of the underlying failures will be reported 
in the <code>brooklyn.debug.log</code>. There are several approaches to resolving problems.</p>

<h3 id="determine-underlying-cause">Determine Underlying Cause</h3>

<p>The problems reported in brooklyn.debug.log will indicate where the problem lies - which 
entities, locations or policies, and in what way it failed.</p>

<h3 id="ignore-errors">Ignore Errors</h3>

<p>The <code>~/.brooklyn/brooklyn.properties</code> has several configuration options:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">rebind.failureMode.danglingRef</span><span class="o">=</span><span class="s">continue</span>
<span class="na">rebind.failureMode.loadPolicy</span><span class="o">=</span><span class="s">continue</span>
<span class="na">rebind.failureMode.addPolicy</span><span class="o">=</span><span class="s">continue</span>
<span class="na">rebind.failureMode.rebind</span><span class="o">=</span><span class="s">fail_at_end</span>
<span class="na">rebind.failureMode.addConfig</span><span class="o">=</span><span class="s">fail_at_end</span></code></pre></div>

<p>For each of these configuration options, the possible values are:</p>

<ul>
  <li><code>fail_fast</code>: stop rebind immediately upon errors; do not try to rebind other entities</li>
  <li><code>fail_at_end</code>: continue rebinding all entities, but then fail so that all errors 
encountered are reported</li>
  <li><code>continue</code>: log a warning, but ignore the error to continue rebinding. Depending on the 
type of error, this can cause serious problems later (e.g. if the state of an entity
was entirely missing, then all its children would be orphaned).</li>
</ul>

<p>The meaning of the configuration options is:</p>

<ul>
  <li><code>rebind.failureMode.dangingRef</code>: if there is a reference to an entity, location or policy 
that is missing… whether to continue (discarding the reference) or fail.</li>
  <li><code>rebind.failureMode.loadPolicy</code>: if there is an error instantiate or reconstituting the 
state of a policy or enricher… whether to continue (discarding the policy or enricher) 
or fail.</li>
  <li><code>rebind.failureMode.addPolicy</code>: if there is an error re-adding the policy or enricher to
its associated entity… whether to continue (discarding the policy or enricher) 
or fail.</li>
  <li><code>rebind.failureMode.addConfig</code>: if there is invalid config value, or some other error occurs when adding a config.</li>
  <li><code>rebind.failureMode.rebind</code>: any errors on rebind not covered by the more specific error cases described above.</li>
</ul>

<h3 id="seek-help">Seek Help</h3>

<p>Help can be found at <code>dev@brooklyn.apache.org</code>, where folk will be able to investigate 
issues and suggest work-arounds.</p>

<p>By sharing the persisted state (with credentials removed), Brooklyn developers will be able to 
reproduce and debug the problem.</p>

<h3 id="fix-up-the-state">Fix-up the State</h3>

<p>The state of each entity, location, policy and enricher is persisted in XML. 
It is thus human readable and editable.</p>

<p>After first taking a backup of the state, it is possible to modify the state. For example,
an offending entity could be removed, or references to that entity removed, or its XML 
could be fixed to remove the problem.</p>

<h3 id="fixing-with-groovy-scripts">Fixing with Groovy Scripts</h3>

<p>The final (powerful and dangerous!) tool is to execute Groovy code on the running Brooklyn 
instance. If authorized, the REST api allows arbitrary Groovy scripts to be passed in and 
executed. This allows the state of entities to be modified (and thus fixed) at runtime.</p>

<p>If used, it is strongly recommended that Groovy scripts are run against a disconnected Brooklyn
instance. After fixing the entities, locations and/or policies, the Brooklyn instance’s 
new persisted state can be copied and used to fix the production instance.</p>

<h2 id="writing-persistable-code">Writing Persistable Code</h2>
<p>The most common problem on rebind is that custom entity code has not been written in a way
that can be persisted and/or rebound.</p>

<p>The rule of thumb when implementing new entities, locations, policies and enrichers is that 
all state must be persistable. All state must be stored as config or as attributes, and must be
serializable. For making backwards compatibility simpler, the persisted state should be clean.</p>

<p>Below are tips and best practices for when implementing an entity in Java (or any other 
JVM language).</p>

<p>How to store entity state:</p>

<ul>
  <li>Config keys and values are persisted.</li>
  <li>Store an entity’s runtime state as attributes.</li>
  <li>Don’t store state in arbitrary fields - the field will not be persisted (this is a design
decision, because Brooklyn cannot intercept the field being written to, so cannot know
when to persist).</li>
  <li>Don’t just modify the retrieved attribute value (e.g. <code>getAttribute(MY_LIST).add("a")</code> is bad).
The value may not be persisted unless setAttribute() is called.</li>
  <li>For special cases, it is possible to call <code>entity.requestPerist()</code> which will trigger
asynchronous persistence of the entity.</li>
  <li>Overriding (and customizing) of <code>getRebindSupport()</code> is discouraged - this will change
in a future version.</li>
</ul>

<p>How to store policy/enricher/location state:</p>

<ul>
  <li>Store values as config keys where applicable.</li>
  <li>Unfortunately these (currently) do not have attributes. Normally the state of a policy 
or enricher is transient - on rebind it starts afresh, for example with monitoring the 
performance or health metrics rather than relying on the persisted values.</li>
  <li>For special cases, you can annotate a field with <code>@SetFromFlag</code> for it be persisted. 
When you call <code>requestPersist()</code> then values of these fields will be scheduled to be 
persisted. <em>Warning: the <code>@SetFromFlag</code> functionality may change in future versions.</em></li>
</ul>

<p>Persistable state:</p>

<ul>
  <li>Ensure values can be serialized. This (currently) uses xstream, which means it does not
need to implement <code>Serializable</code>.</li>
  <li>Always use static (or top-level) classes. Otherwise it will try to also persist the outer 
instance!</li>
  <li>Any reference to an entity or location will be automatically swapped out for marker, and 
re-injected with the new entity/location instance on rebind. The same applies for policies,
enrichers, feeds, catalog items and <code>ManagementContext</code>.</li>
</ul>

<p>Behaviour on rebind:</p>

<ul>
  <li>By extending <code>SoftwareProcess</code>, entities get a lot of the rebind logic for free. For 
example, the default <code>rebind()</code> method will call <code>connectSensors()</code>.
See <a href="/brooklyn-docs/v/latest/blueprints/java/entities.html#SoftwareProcess-lifecycle"><code>SoftwareProcess</code> Lifecycle</a>
for more details.</li>
  <li>If necessary, implement rebind. The <code>entity.rebind()</code> is called automatically by the
Brooklyn framework on rebind, after configuring the entity’s config/attributes but before 
the entity is managed.
Note that <code>init()</code> will not be called on rebind.</li>
  <li>Feeds will be persisted if and only if <code>entity.addFeed(...)</code> was called. Otherwise the
feed needs to be re-registered on rebind. <em>Warning: this behaviour may change in future version.</em></li>
  <li>All functions/predicates used with persisted feeds must themselves be persistable - 
use of anonymous inner classes is strongly discouraged.</li>
  <li>Subscriptions (e.g. from calls to <code>subscribe(...)</code> for sensor events) are not persisted.
They must be re-registered on rebind.  <em>Warning: this behaviour may change in future version.</em></li>
</ul>

<p>Below are tips to make backwards-compatibility easier for persisted state: </p>

<ul>
  <li>Never use anonymous inner classes - even in static contexts. The auto-generated class names 
are brittle, making backwards compatibility harder.</li>
  <li>Always use sensible field names (and use <code>transient</code> whenever you don’t want it persisted).
The field names are part of the persisted state.</li>
  <li>Consider using Value Objects for persisted values. This can give clearer separation of 
responsibilities in your code, and clearer control of what fields are being persisted.</li>
  <li>Consider writing transformers to handle backwards-incompatible code changes.
Brooklyn supports applying transformations to the persisted state, which can be done as 
part of an upgrade process.</li>
</ul>

<h2 id="persisted-state-backup">Persisted State Backup</h2>

<h3 id="file-system-backup">File system backup</h3>

<p>When using the file system it is important to ensure it is backed up regularly.</p>

<p>One could use <code>rsync</code> to regularly backup the contents to another server.</p>

<p>It is also recommended to periodically create a complete archive of the state.
A simple mechanism is to run a CRON job periodically (e.g. every 30 minutes) that creates an
archive of the persistence directory, and uploads that to a backup 
facility (e.g. to S3).</p>

<p>Optionally, to avoid excessive load on the Brooklyn server, the archive-generation could be done 
on another “data” server. This could get a copy of the data via an <code>rsync</code> job.</p>

<p>An example script to be invoked by CRON is shown below:</p>

<pre><code>DATE=`date "+%Y%m%d.%H%M.%S"`
BACKUP_FILENAME=/path/to/archives/back-${DATE}.tar.gz
DATA_DIR=/path/to/base/dir/data

tar --exclude '*/backups/*' -czvf $BACKUP_FILENAME $DATA_DIR
# For s3cmd installation see http://s3tools.org/repositories
s3cmd put $BACKUP_FILENAME s3://mybackupbucket
rm $BACKUP_FILENAME
</code></pre>

<h3 id="object-store-backup">Object store backup</h3>

<p>Object Stores will normally handle replication. However, many such object stores do not handle 
versioning (i.e. to allow access to an old version, if an object has been incorrectly changed or 
deleted).</p>

<p>The state can be downloaded periodically from the object store, archived and backed up. </p>

<p>An example script to be invoked by CRON is shown below:</p>

<pre><code>DATE=`date "+%Y%m%d.%H%M.%S"`
BACKUP_FILENAME=/path/to/archives/back-${DATE}.tar.gz
TEMP_DATA_DIR=/path/to/tempdir

brooklyn copy-state \
        --persistenceLocation named:my-persistence-location \
        --persistenceDir /path/to/bucket \
        --destinationDir $TEMP_DATA_DIR

tar --exclude '*/backups/*' -czvf $BACKUP_FILENAME $TEMP_DATA_DIR
# For s3cmd installation see http://s3tools.org/repositories
s3cmd put $BACKUP_FILENAME s3://mybackupbucket
rm $BACKUP_FILENAME
rm -r $TEMP_DATA_DIR
</code></pre>

            </div>

            <aside class="col-md-3">
                <div class="list-group side-menu" id="side-menu">



  
     
              
                  <h4 class=" with_following">
                    <a href="/brooklyn-docs/v/latest/index.html" class="list-group-item breadcrumb breadcrumb0">
                      User Guide
                      </a></h4>
              
                  <h4 class=" with_preceding">
                    <a href="/brooklyn-docs/v/latest/ops/index.html" class="list-group-item breadcrumb breadcrumb1">
                      Reference Guide
                      </a></h4>
              
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/ops/production-installation.html" class="list-group-item">Production Installation
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/ops/starting-stopping-monitoring.html" class="list-group-item">Starting, Stopping and Monitoring
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/ops/server-cli-reference.html" class="list-group-item">Server CLI Reference
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/ops/cli/index.html" class="list-group-item">Client CLI Reference
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/ops/gui/index.html" class="list-group-item">GUI Guide
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/ops/rest.html" class="list-group-item">REST API
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/ops/brooklyn_properties.html" class="list-group-item">brooklyn.properties
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/ops/persistence/index.html" class="list-group-item active with-sub-item">Persistence
                    </a>
                  <div class="sub-item">
                    
                      
                      <a href="/brooklyn-docs/v/latest/ops/persistence/index.html#command-line-options" class="list-group-item sub-item  section" section-target="#command-line-options">
                        Command Line Options
                        </a>
                    
                      
                      <a href="/brooklyn-docs/v/latest/ops/persistence/index.html#file-based-persistence" class="list-group-item sub-item  section" section-target="#file-based-persistence">
                        File-based Persistence
                        </a>
                    
                      
                      <a href="/brooklyn-docs/v/latest/ops/persistence/index.html#object-store-persistence" class="list-group-item sub-item  section" section-target="#object-store-persistence">
                        Object Store Persistence
                        </a>
                    
                      
                      <a href="/brooklyn-docs/v/latest/ops/persistence/index.html#rebinding-to-state" class="list-group-item sub-item  section" section-target="#rebinding-to-state">
                        Rebinding to State
                        </a>
                    
                      
                      <a href="/brooklyn-docs/v/latest/ops/persistence/index.html#writing-persistable-code" class="list-group-item sub-item  section" section-target="#writing-persistable-code">
                        Writing Persistable Code
                        </a>
                    
                      
                      <a href="/brooklyn-docs/v/latest/ops/persistence/index.html#persisted-state-backup" class="list-group-item sub-item  section" section-target="#persisted-state-backup">
                        Persisted State Backup
                        </a>
                    
                  </div>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/ops/high-availability/index.html" class="list-group-item">High Availability
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/ops/osgi.html" class="list-group-item">OSGi Distribution
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/ops/logging.html" class="list-group-item">Logging
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/ops/https.html" class="list-group-item">HTTPS Configuration
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/ops/externalized-configuration.html" class="list-group-item">Externalized Configuration
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/ops/requirements.html" class="list-group-item">Requirements
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/ops/security-guidelines.html" class="list-group-item">Security Guidelines
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/ops/troubleshooting/index.html" class="list-group-item">Troubleshooting
                    </a>
                
              
        
        
  

        
</div>
<div id="width_reference"></div>


<script language="JavaScript" type="application/javascript">
(function($){
    
    sidemenu_x_sizer=function(){ $('#side-menu').width($('#side-menu').parent().find('#width_reference').outerWidth()); };
    $(sidemenu_x_sizer);
    $(window).resize(sidemenu_x_sizer);

    
    sidemenu_y_nonfloater=function(){
      if ($('#side-menu').outerHeight(true) + $('#header').outerHeight(true) + $('#footer').outerHeight(true) > window.innerHeight ||
          $('#side-menu').width() >= $('#content_container').width()/2) {
        $('#side-menu').css('position', 'inherit');
      } else {
        // restore if screen has grown
        $('#side-menu').css('position', 'fixed');
      }
    };
    $(sidemenu_y_nonfloater);
    $(window).resize(sidemenu_y_nonfloater);

    

    var sideMenu = $("#side-menu"),
        sideItems = sideMenu.find("a"),
        // Anchors corresponding to menu items
        scrollItems = sideItems.map(function(){
          var item = $(this).attr("section-target");
          if (item && item.length) { return item; }
        });

    var highlight_section_last_top = -1;
    var highlight_section_completed = false;

    var highlight_section = function() {
       // Get container scroll position
       var highlight_section_new_top = $(this).scrollTop();
       if (highlight_section_new_top == highlight_section_last_top) return;
       var highlight_section_new_bottom = highlight_section_new_top + $(window).height();
       var scroll_advancing = (highlight_section_new_top > highlight_section_last_top);

       var last_item = null, active_item = $("#side-menu a.section#active");

       var found_top = false;
       var displayable_items = scrollItems.map(function(itemI){
         item = $(scrollItems[itemI]);
         if (item && item.length) {
           if (highlight_section_last_top == -1 || !highlight_section_completed) {
             // just opening page - take item matching hash, or otherwise the first item visible
             if (item.selector === window.location.hash || (item.offset().top > highlight_section_new_top - 20 && !found_top)) {
               found_top = true;
               if (item.selector === window.location.hash && item.offset().top < highlight_section_new_top + 60) {
                 // because of our top header, we need to scroll 64px down from any link
                 $('html, body').animate({scrollTop: item.offset().top - 64}, 0);
               }
               return item;
             }
           } else if (scroll_advancing) {
             // if scrolling advance, pick up a section when title starts before 1/3 height
             if (item.offset().top < highlight_section_new_top + $(window).height()/3)
               return item;

             // or if containing div is finished (usu the whole main content)
             div_containing_item = item.closest("div");
             if (div_containing_item.offset().top + div_containing_item.height() < highlight_section_new_bottom + 15)
               return item;
             // or when next title is visible
             if (last_item && item.offset().top < highlight_section_new_bottom + 15)
               return last_item;
           } else {
             // if scrolling back, pick up a section as soon as the title is visible,
             if (item.offset().top < highlight_section_new_top)
               return item;
             // or if title is before the 2/3 point
             // (not sure about this, probably want also to have
             // "AND the id.top is <= displayable_itemsrent_active_it.top" so we don't jump FORWARD a section
             // when scrolling BACK, with lots of tiny sections)
             if ((item.offset().top < highlight_section_new_top + 2*$(window).height()/3)
                 && (!active_item || !active_item.offset() || active_item.offset().top >= item.offset().top))
               return item;

           }
           last_item = item;
         }
       });
       if (!highlight_section_completed && document.readyState === "complete") {
         highlight_section_completed = true;
       }
       if (!displayable_items.length) {
         $("#side-menu a.section").removeClass("active");
       } else {
         displayable_items = displayable_items[displayable_items.length-1];
         var id = displayable_items && displayable_items.length ? displayable_items[0].id : "";
       // Set/remove active class
         new_active = $("#side-menu a.section").filter("[section-target='#"+id+"']");
         if (new_active.hasClass("active")) {
           // nothing needed
         } else {
           $("#side-menu a.section").removeClass("active");
           $("#side-menu a.section").filter("[section-target='#"+id+"']").addClass("active");
         }
       }

       highlight_section_last_top = highlight_section_new_top;
    };
    var highlight_new_section = function() {
      highlight_section_completed = false;
      highlight_section_last_top = -1;
      highlight_section();
    }

    $(window).scroll(highlight_section);
    $(highlight_new_section);

    // detect link change - courtesy http://www.bennadel.com/blog/1520-binding-events-to-non-dom-objects-with-jquery.htm

    // Default to the current location.
    var strLocation = window.location.href;
    var strHash = window.location.hash;
    var strPrevLocation = "";
    var strPrevHash = "";

    // This is how often we will be checkint for
    // changes on the location.
    var intIntervalTime = 100;

    // This method removes the pound from the hash.
    var fnCleanHash = function( strHash ){
        return(
            strHash.substring( 1, strHash.length )
            );
    }

    // This will be the method that we use to check
    // changes in the window location.
    var fnCheckLocation = function(){
        // Check to see if the location has changed.
        if (strLocation != window.location.href){

            // Store the new and previous locations.
            strPrevLocation = strLocation;
            strPrevHash = strHash;
            strLocation = window.location.href;
            strHash = window.location.hash;

            // The location has changed. Trigger a
            // change event on the location object,
            // passing in the current and previous
            // location values.
            $( window.location ).trigger(
                "change",
                {
                    currentHref: strLocation,
                    currentHash: fnCleanHash( strHash ),
                    previousHref: strPrevLocation,
                    previousHash: fnCleanHash( strPrevHash )
                }
                );

        }
    }

    // Set an interval to check the location changes.
    setInterval( fnCheckLocation, intIntervalTime );

    // and trigger highlight section on link change
    $(window.location).bind("change", highlight_new_section);
})(jQuery);

</script>

            </aside>
        </div>
    </div>
</main>

<footer class="container">
    <div class="row">
        <div class="col-md-9">
            <p>Apache Brooklyn is distributed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License v2.0</a>.</p>
        </div>
        <div class="col-md-3 text-right">
            <p>
                <a class="btn btn-sm btn-default" href="https://github.com/apache/brooklyn-docs/edit/master/guide/ops/persistence/index.md">Edit This Page</a>
                <a href="https://brooklyn.apache.org/community/how-to-contribute-docs.html"
                    data-toggle="tooltip" data-placement="top" title="" data-delay="400" data-original-title="How to Edit Documentation">
                    <span class="octicon octicon-question octicon-footer"></span>
                </a>
            </p>
        </div>
    </div>
</footer>

</body>

<!--
  ~ Licensed to the Apache Software Foundation (ASF) under one
  ~ or more contributor license agreements.  See the NOTICE file
  ~ distributed with this work for additional information
  ~ regarding copyright ownership.  The ASF licenses this file
  ~ to you under the Apache License, Version 2.0 (the
  ~ "License"); you may not use this file except in compliance
  ~ with the License.  You may obtain a copy of the License at
  ~
  ~      http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing,
  ~ software distributed under the License is distributed on an
  ~ "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~ KIND, either express or implied.  See the License for the
  ~ specific language governing permissions and limitations
  ~ under the License.
  -->

<script type="text/javascript" src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/brooklyn-docs/style/deps/jquery.cookie.js"></script>
<script type="text/javascript" src="/brooklyn-docs/style/js/zeroclipboard/ZeroClipboard.min.js"></script>
<script type="text/javascript" src="/brooklyn-docs/style/deps/tooltip.js"></script>

<script type="text/javascript">
    ZeroClipboard.config({ moviePath: '/style/js/zeroclipboard/ZeroClipboard.swf' });
</script>
<script src="/brooklyn-docs/style/js/public.js"></script>
</html>
