<!--
  ~ Licensed to the Apache Software Foundation (ASF) under one
  ~ or more contributor license agreements.  See the NOTICE file
  ~ distributed with this work for additional information
  ~ regarding copyright ownership.  The ASF licenses this file
  ~ to you under the Apache License, Version 2.0 (the
  ~ "License"); you may not use this file except in compliance
  ~ with the License.  You may obtain a copy of the License at
  ~
  ~      http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing,
  ~ software distributed under the License is distributed on an
  ~ "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~ KIND, either express or implied.  See the License for the
  ~ specific language governing permissions and limitations
  ~ under the License.
  -->

<!DOCTYPE html>
<html lang="en">
<head>
    <title>YAML Blueprint Advanced Example - Apache Brooklyn</title>

<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/octicons/octicons.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/bootstrap-theme.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/font-awesome-4.2.0/css/font-awesome.min.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/deps/tooltip.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/css/code.css" rel="stylesheet" />
<link href="/brooklyn-docs/style/css/website.css" rel="stylesheet" />

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
</head>

<body class="page">
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <div class="navbar-brand">
                <a class="brand-apache" href="http://www.apache.org/">
                    <img src="https://www.apache.org/foundation/press/kit/feather.svg" alt="[Apache]">
                </a>
                
                <a class="brand-brooklyn" href="/brooklyn-docs/"><img src="/brooklyn-docs/img/apache-brooklyn-logo-244px-wide.png" alt="brooklyn"></a>
                
            </div>
        </div>
        <div class="collapse navbar-collapse" id="main-menu">


            <ul class="nav navbar-nav navbar-right">
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/learnmore/index.html" data-toggle="dropdown">learn more <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/learnmore/index.html">Learn More</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/blueprint-tour.html">Blueprint Tour
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/features/index.html">Features
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/theory.html">Theory
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/learnmore/catalog/index.html">Browse Catalog
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/v/latest/start/index.html" data-toggle="dropdown">get started <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/v/latest/start/index.html">Get Started</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/running.html">Running Apache Brooklyn
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/blueprints.html">Deploying Blueprints
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/managing.html">Monitoring and Managing Applications
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/policies.html">Policies
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/start/concept-quickstart.html">Brooklyn Concepts Quickstart
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown active">
                    
                    <a href="/brooklyn-docs/documentation/index.html" data-toggle="dropdown">documentation <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/documentation/index.html">Documentation</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li class="section">
                            <a href="/brooklyn-docs/v/latest/index.html">User Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/blueprints/creating-yaml.html">Writing Blueprints
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/locations/index.html">Deploying Blueprints
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li class="section">
                            <a href="/brooklyn-docs/v/latest/ops/index.html">Reference Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/dev/index.html">Developer Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        <li class="divider"></li>
                        <li >
                            <a href="/brooklyn-docs/meta/versions.html">Versions
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/documentation/other-docs.html">Other Resources
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/community/index.html" data-toggle="dropdown">community <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/community/index.html">Community</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/mailing-lists.html">Mailing Lists
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/irc.html">IRC
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/security/index.html">Security Advisories
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="https://issues.apache.org/jira/browse/BROOKLYN">Bug Tracker (JIRA)
                                &nbsp;<span class="octicon octicon-link-external"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/community/how-to-contribute-docs.html">Contributing Documentation
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <a href="/brooklyn-docs/developers/index.html" data-toggle="dropdown">developers <span class="caret"></span></a>
                    
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="/brooklyn-docs/developers/index.html">Developers</a>
                        </li>
                        <li class="divider"></li>
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/code/index.html">Get the Code
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/how-to-contribute.html">How to Contribute
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/v/latest/dev/index.html">Developer Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/committers/index.html">Committer Guide
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/code-standards.html">Code Standards
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="/brooklyn-docs/developers/links.html">Handy Places
                                </a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="http://github.com/apache/brooklyn">GitHub
                                &nbsp;<span class="octicon octicon-link-external"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                        
                        <li >
                            <a href="https://issues.apache.org/jira/browse/BROOKLYN">Bug Tracker (JIRA)
                                &nbsp;<span class="octicon octicon-link-external"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li>test 1</li>
                                <li>test 1</li>
                                <li>test 1</li>
                            </ul>
                        </li>
                        
                        
                    </ul>
                    
                    
                </li>
                
                <li class="dropdown">
                    
                    <form class="navbar-form">
                        <a href="/brooklyn-docs/download/index.html" class="btn btn-default">download</a>
                    </form>
                    
                </li>
                
            </ul>
        </div>
    </div>
</nav>


<main>
    <div class="container">
        <div class="row">
            <div class="col-md-9 content">
                <div id="page_notes"></div>
                <h1>YAML Blueprint Advanced Example</h1>
                <p>By this point you should be familiar with the fundamental concepts behind both Apache Brooklyn and YAML blueprints. This section of the documentation is intended to show a complete, advanced example of a YAML blueprint.</p>

<p>The intention is that this example is used to learn the more in-depth concepts, and also to serve as a reference when writing your own blueprints. This page will first explain what the example application is and how to run it, then it will spotlight interesting features.</p>

<h3 id="elk-stack-example">ELK Stack Example</h3>

<p>This example demonstrates the deployment of an ELK Stack (Elasticsearch, Logstash and Kibana), using the provided blueprint to deploy, install, run and manage all three. Briefly, the component parts are:</p>

<ul>
  <li>Elasticsearch: A clustered search engine</li>
  <li>Logstash: Collects, parses and stores logs. For our example it will store logs in Elasticsearch</li>
  <li>Kibana: A web front end to Elasticsearch</li>
</ul>

<p>We also deploy a simple webserver whose logs will be collected.</p>

<ul>
  <li>Tomcat 8: Web server whose logs will be stored in Elasticsearch by Logstash.</li>
</ul>

<p>For more about the ELK stack, please see the documentation <a href="https://www.elastic.co/webinars/introduction-elk-stack">here</a>.</p>

<h4 id="the-blueprints">The Blueprints</h4>
<hr />

<p>There are four blueprints that make up this application. Each of them are used to add one or more catalog items to Brooklyn. You can find them below:</p>

<ul>
  <li><a href="https://github.com/brooklyncentral/brooklyn-elk/blob/master/brooklyn-elasticsearch-catalog.bom">Elasticsearch</a></li>
  <li><a href="https://github.com/brooklyncentral/brooklyn-elk/blob/master/brooklyn-logstash-catalog.bom">Logstash</a></li>
  <li><a href="https://github.com/brooklyncentral/brooklyn-elk/blob/master/brooklyn-kibana-catalog.bom">Kibana</a></li>
  <li><a href="https://github.com/brooklyncentral/brooklyn-elk/blob/master/brooklyn-elk-catalog.bom">ELK</a></li>
</ul>

<h4 id="running-the-example">Running the example</h4>
<p>First, add all four blueprints to the Brooklyn Catalog. This can be done by clicking the ‘Catalog’ tab, clicking the ‘+’
 symbol and pasting the YAML. Once this is done, click the ‘Application’ tab, then the ‘+’ button to bring up the add 
application wizard. A new Catalog application will be available called ‘ELK Stack’. Using the add application wizard, 
you should be able to deploy an ELK stack to a location of your choosing.  Alternatively use the <code>br</code> Brooklyn
command line tool and add the files with <code>br catalog add</code>.</p>

<h4 id="exploring-the-example">Exploring the example</h4>
<p>After the application has been deployed, you can ensure it is working as expected by checking the following:</p>

<ul>
  <li>There is a Kibana sensor called <code>main.uri</code>, the value of which points to the Kibana front end. You can explore this 
front end, and observe the logs stored in Elasticsearch. Many Brooklyn applications have a <code>main.uri</code> set to point you 
in the right direction.</li>
  <li>You can also use the Elasticsearch REST API to explore further. The Elasticsearch Cluster entity has a <code>urls.http.list</code> 
sensor. Using a host:port from that list you will be able to access the REST API. The following URL will give you the 
state of the cluster <code>http://&lt;host:port&gt;/_cluster/health?pretty=true</code>. As you can see the <code>number_of_nodes</code> is 
currently 2, indicating that the Elasticsearch nodes are communicating with each other.</li>
</ul>

<h3 id="interesting-feature-spotlight">Interesting Feature Spotlight</h3>
<p>We will mainly focus on the Elasticsearch blueprint, and will be clear when another blueprint is being discussed. This blueprint describes a cluster of Elasticsearch nodes. </p>

<h4 id="provisioning-properties">Provisioning Properties</h4>
<p>Our Elasticsearch blueprint has a few requirements of the location in which it is run. Firstly, it must be run on an
Ubuntu machine as the example has been written specifically for this OS. Secondly, two ports must opened to ensure
that the entities can be accessed from the outside world. Both of these requirements are configured via 
<code>provisioning.properties</code> as follows:</p>

<pre><code class="language-yaml">brooklyn.config:
  elasticsearch.http.port: 9220
  elasticsearch.tcp.port: 9330
  provisioning.properties:
    osFamily: ubuntu
    inboundPorts:
    - $brooklyn:config("elasticsearch.http.port")
    - $brooklyn:config("elasticsearch.tcp.port")
</code></pre>

<h4 id="vanillasoftwareprocess">VanillaSoftwareProcess</h4>
<p>When composing a YAML blueprint, the VanillaSoftwareProcess is a very useful entity to be aware of. 
A VanillaSoftwareProcess will instruct Brooklyn to provision an instance, and run a series of shell 
commands to setup, run, monitor and teardown your program. The commands are specified as configuration 
on the VanillaSoftwareProcess and there are several available. We will spotlight a few now. To simplify
 this blueprint, we have specified ubuntu only installs so that our commands can be tailored to this 
 system (e.g. use apt-get rather than yum).</p>

<h5 id="customize-command">Customize Command</h5>
<p>The Customize Command is run after the application has been installed but before it is run. It is the perfect
 place to create and amend config files. Please refer to the following section of the Elasticsearch blueprint:</p>

<pre><code class="language-yaml">customize.command: |
  sudo rm -fr sudo tee /etc/elasticsearch/elasticsearch.yml
  echo discovery.zen.ping.multicast.enabled: false | sudo tee -a /etc/elasticsearch/elasticsearch.yml
  echo discovery.zen.ping.unicast.enabled: true | sudo tee -a /etc/elasticsearch/elasticsearch.yml
  echo discovery.zen.ping.unicast.hosts: ${URLS_WITH_BRACKETS} | sudo tee -a /etc/elasticsearch/elasticsearch.yml
  echo http.port: ${ES_HTTP_PORT} | sudo tee -a /etc/elasticsearch/elasticsearch.yml
  echo transport.tcp.port: ${ES_TCP_PORT} | sudo tee -a /etc/elasticsearch/elasticsearch.yml
  echo network.host: ${IP_ADDRESS} | sudo tee -a /etc/elasticsearch/elasticsearch.yml
</code></pre>

<p>The purpose of this section is to create a YAML file with all of the required configuration. We use the YAML 
literal style <code>|</code> indicator to write a multi line command. We start our series of commands by using the <code>rm</code> command to remove the 
previous config file. We then use <code>echo</code> and <code>tee</code> to create the new config file and insert the config. Part 
of the configuration is a list of all hosts that is set on the parent entity- this is done by using a combination
 of the <code>component</code> and  <code>attributeWhenReady</code> DSL commands. More on how this is generated later.</p>

<h5 id="check-running">Check running</h5>
<p>After an app is installed and run, this command is scheduled to run regularly and used to populate the <code>service.isUp</code> 
sensor. If this command is not specified, or returns an exit code of anything other than zero, then Brooklyn will 
assume that your entity has failed and will display the fire status symbol. Please refer to the following section 
of the Elasticsearch blueprint:</p>

<pre><code class="language-yaml">checkRunning.command: sudo systemctl status kibana.service
</code></pre>

<p>There are many different ways to implement this command. For this example, we are simply using the systemctl status 
of the appropriate service.</p>

<h4 id="enrichers">Enrichers</h4>

<h5 id="elasticsearch-urls">Elasticsearch URLS</h5>
<p>To ensure that all Elasticsearch nodes can communicate with each other they need to be configured with the TCP URL 
of all other nodes. Similarly, the Logstash instances need to be configured with all the HTTP URLs of the Elasticsearch 
nodes. The mechanism for doing this is the same, and involves using Transformers, Aggregators and Joiners, as follows:</p>

<pre><code class="language-yaml">brooklyn.enrichers:
  - type: org.apache.brooklyn.enricher.stock.Transformer
    brooklyn.config:
      enricher.sourceSensor: $brooklyn:sensor("host.subnet.address")
      enricher.targetSensor: $brooklyn:sensor("url.tcp")
      enricher.targetValue: $brooklyn:formatString("%s:%s", $brooklyn:attributeWhenReady("host.subnet.address"), $brooklyn:config("elasticsearch.tcp.port"))
</code></pre>

<p>In this example, we take the host.subnet.address and append the TCP port, outputting the result as <code>url.tcp</code>. 
After this has been done, we now need to collect all the URLs into a list in the Cluster entity, as follows:</p>

<pre><code class="language-yaml">brooklyn.enrichers:
  - type: org.apache.brooklyn.enricher.stock.Aggregator
    brooklyn.config:
      enricher.sourceSensor: $brooklyn:sensor("url.tcp")
      enricher.targetSensor: $brooklyn:sensor("urls.tcp.list")
      enricher.aggregating.fromMembers: true

</code></pre>

<p>In the preceding example, we aggregated all of the TCP URLs generated in the early example. 
These are then stored in a sensor called <code>urls.tcp.list</code>. This list is then joined together into one long string:</p>

<pre><code class="language-yaml">- type: org.apache.brooklyn.enricher.stock.Joiner
  brooklyn.config:
    enricher.sourceSensor: $brooklyn:sensor("urls.tcp.list")
    enricher.targetSensor: $brooklyn:sensor("urls.tcp.string")
    uniqueTag: urls.quoted.string
</code></pre>

<p>Finally, the string has brackets added to the start and end:</p>

<pre><code class="language-yaml">- type: org.apache.brooklyn.enricher.stock.Transformer
  brooklyn.config:
    enricher.sourceSensor: $brooklyn:sensor("urls.tcp.string")
    enricher.targetSensor: $brooklyn:sensor("urls.tcp.withBrackets")
    enricher.targetValue: $brooklyn:formatString("[%s]", $brooklyn:attributeWhenReady("urls.tcp.string"))
</code></pre>

<p>The resulting sensor will be called <code>urls.tcp.withBrackets</code> and will be used by all Elasticsearch nodes during setup.</p>

<h5 id="kibana-url">Kibana URL</h5>
<p>Kibana also needs to be configured such that it can access the Elasticsearch cluster. However, Kibana can
 only be configured to point at one Elasticsearch instance. To enable this, we use another enricher in the 
 cluster to select the first URL from the list, as follows:</p>

<pre><code class="language-yaml">- type: org.apache.brooklyn.enricher.stock.Aggregator
  brooklyn.config:
    enricher.sourceSensor: $brooklyn:sensor("host.subnet.address")
    enricher.targetSensor: $brooklyn:sensor("host.address.first")
    enricher.aggregating.fromMembers: true
    enricher.transformation:
     $brooklyn:object:
       type: "org.apache.brooklyn.util.collections.CollectionFunctionals$FirstElementFunction"
</code></pre>

<p>Similar to the above Aggregator, this Aggregator collects all the URLs from the members of the cluster. 
However, this Aggregator specifies a transformation. In this instance a transformation is a Java class that 
implements a Guava Function <code>&lt;? super Collection&lt;?&gt;, ?&gt;&gt;</code>, i.e. a function that takes in a collection and 
returns something. In this case we specify the FirstElementFunction from the CollectionFunctionals to ensure 
that we only get the first member of the URL list.</p>

<h4 id="latches">Latches</h4>
<p>In the ELK blueprint, there is a good example of a latch. Latches are used to force an entity to wait until 
certain conditions are met before continuing. For example:</p>

<pre><code class="language-yaml">- type: kibana-standalone
  id: kibana
  name: Kibana Server
  customize.latch: $brooklyn:component("es").attributeWhenReady("service.isUp")
</code></pre>

<p>This latch is used to stop Kibana customizing until the Elasticsearch cluster is up. We do this to ensure 
that the URL sensors have been setup, so that they can be passed into Kibana during the customization phase.</p>

<p>Latches can also be used to control how many entities can execute the same step at any given moment. When
a latch is given the value of a <code>MaxConcurrencySensor</code> it will unblock execution only when there are
available “slots” to execute (think of it as a semaphore). For example to let a single entity execute the
launch step of the start effector:</p>

<pre><code class="language-yaml">services:
- type: cluster

  brooklyn.initializers:
  - type: org.apache.brooklyn.core.sensor.MaxConcurrencySensor
    brooklyn.config:
      name: single-executor
      latch.concurrency.max: 1

  brooklyn.config: 
    initialSize: 10
    memberSpec:
      $brooklyn:entitySpec:
        type: vanilla-bash-server
        brooklyn.config:
          launch.command: sleep 2
          checkRunning.command: true
          launch.latch: $brooklyn:parent().attributeWhenReady("single-executor")
</code></pre>

<p>It’s important to note that the above setup is not reentrant. This means that users should be careful to
avoid deadlocks. For example having a start and launch latches against the <code>single-executor</code> from above.
The launch latch will block forever since the start latch already would’ve acquired the free slot.</p>

<h4 id="child-entities">Child entities</h4>
<p>The ELK blueprint also contains a good example of a child entity.</p>

<pre><code class="language-yaml">- type: org.apache.brooklyn.entity.webapp.tomcat.Tomcat8Server
  brooklyn.config:
    children.startable.mode: background_late
  ...
  brooklyn.children:
  - type: logstash-child
</code></pre>

<p>In this example, a logstash-child is started as a child of the parent Tomcat server. The Tomcat server needs 
to be configured with a <code>children.startable.mode</code> to inform Brooklyn when to bring up the child. In this case
 we have selected background so that the child is disassociated from the parent entity, and late to specify that
  the parent entity should start before we start the child.</p>

<p>The example also shows how to configure Logstash inputs and filters, if necessary, for a particular application, 
in this case Tomcat.</p>

<pre><code class="language-yaml">- type: logstash-child
  name: Logstash
  brooklyn.config:
    logstash.elasticsearch.hosts: $brooklyn:entity("es").attributeWhenReady("urls.http.withBrackets")
    logstash.config.input:
      $brooklyn:formatString:
      - |
        input {
          file {
            path =&gt; "%s/logs/localhost_access_log.*"
            start_position =&gt; "beginning"
          }
        }
      - $brooklyn:entity("tomcat").attributeWhenReady("run.dir")
    logstash.config.filter: |
      filter {
        grok {
          match =&gt; { "message" =&gt; "%{COMBINEDAPACHELOG}" }
        }
        date {
          match =&gt; [ "timestamp" , "dd/MMM/yyyy:HH:mm:ss Z" ]
        }
      }
</code></pre>

<p>Configuring an appropriate visualisation on the Kibana server (access it via the URL on the summary tab for 
that entity) allows a dashboard to be created such as</p>

<p><img src="logstash-snapshot.png" alt="kibana dashboard" /></p>

            </div>

            <aside class="col-md-3">
                <div class="list-group side-menu" id="side-menu">



  
     
              
                  <h4 class=" with_following">
                    <a href="/brooklyn-docs/v/latest/index.html" class="list-group-item breadcrumb breadcrumb0">
                      User Guide
                      </a></h4>
              
                  <h4 class=" with_preceding">
                    <a href="/brooklyn-docs/v/latest/blueprints/index.html" class="list-group-item breadcrumb breadcrumb1">
                      Writing Blueprints
                      </a></h4>
              
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/creating-yaml.html" class="list-group-item">The Basic Structure
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/entity-configuration.html" class="list-group-item">Entity Configuration
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/setting-locations.html" class="list-group-item">Setting Locations
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/configuring-vms.html" class="list-group-item">Configuring VMs
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/multiple-services.html" class="list-group-item">Multiple Services and Dependency Injection
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/custom-entities.html" class="list-group-item">Custom Entities
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/catalog/index.html" class="list-group-item">Catalog
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/clusters.html" class="list-group-item">Clusters, Specs, and Composition
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/enrichers.html" class="list-group-item">Enrichers
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/policies.html" class="list-group-item">Policies
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/clusters-and-policies.html" class="list-group-item">Clusters and Policies
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/java/index.html" class="list-group-item">Java Entities
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/winrm/index.html" class="list-group-item">Windows Blueprints
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/test/index.html" class="list-group-item">Testing YAML Blueprints
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/ansible/index.html" class="list-group-item">Ansible in YAML Blueprints
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/chef/index.html" class="list-group-item">Chef in YAML Blueprints
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/salt/index.html" class="list-group-item">Salt in YAML Blueprints
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/advanced-example.html" class="list-group-item active">YAML Blueprint Advanced Example
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/blueprinting-tips.html" class="list-group-item">Blueprinting Tips
                    </a>
                
              
                 
                
                  
                  <a href="/brooklyn-docs/v/latest/blueprints/yaml-reference.html" class="list-group-item">YAML Blueprint Reference
                    </a>
                
              
        
        
  

        
</div>
<div id="width_reference"></div>


<script language="JavaScript" type="application/javascript">
(function($){
    
    sidemenu_x_sizer=function(){ $('#side-menu').width($('#side-menu').parent().find('#width_reference').outerWidth()); };
    $(sidemenu_x_sizer);
    $(window).resize(sidemenu_x_sizer);

    
    sidemenu_y_nonfloater=function(){
      if ($('#side-menu').outerHeight(true) + $('#header').outerHeight(true) + $('#footer').outerHeight(true) > window.innerHeight ||
          $('#side-menu').width() >= $('#content_container').width()/2) {
        $('#side-menu').css('position', 'inherit');
      } else {
        // restore if screen has grown
        $('#side-menu').css('position', 'fixed');
      }
    };
    $(sidemenu_y_nonfloater);
    $(window).resize(sidemenu_y_nonfloater);

    

    var sideMenu = $("#side-menu"),
        sideItems = sideMenu.find("a"),
        // Anchors corresponding to menu items
        scrollItems = sideItems.map(function(){
          var item = $(this).attr("section-target");
          if (item && item.length) { return item; }
        });

    var highlight_section_last_top = -1;
    var highlight_section_completed = false;

    var highlight_section = function() {
       // Get container scroll position
       var highlight_section_new_top = $(this).scrollTop();
       if (highlight_section_new_top == highlight_section_last_top) return;
       var highlight_section_new_bottom = highlight_section_new_top + $(window).height();
       var scroll_advancing = (highlight_section_new_top > highlight_section_last_top);

       var last_item = null, active_item = $("#side-menu a.section#active");

       var found_top = false;
       var displayable_items = scrollItems.map(function(itemI){
         item = $(scrollItems[itemI]);
         if (item && item.length) {
           if (highlight_section_last_top == -1 || !highlight_section_completed) {
             // just opening page - take item matching hash, or otherwise the first item visible
             if (item.selector === window.location.hash || (item.offset().top > highlight_section_new_top - 20 && !found_top)) {
               found_top = true;
               if (item.selector === window.location.hash && item.offset().top < highlight_section_new_top + 60) {
                 // because of our top header, we need to scroll 64px down from any link
                 $('html, body').animate({scrollTop: item.offset().top - 64}, 0);
               }
               return item;
             }
           } else if (scroll_advancing) {
             // if scrolling advance, pick up a section when title starts before 1/3 height
             if (item.offset().top < highlight_section_new_top + $(window).height()/3)
               return item;

             // or if containing div is finished (usu the whole main content)
             div_containing_item = item.closest("div");
             if (div_containing_item.offset().top + div_containing_item.height() < highlight_section_new_bottom + 15)
               return item;
             // or when next title is visible
             if (last_item && item.offset().top < highlight_section_new_bottom + 15)
               return last_item;
           } else {
             // if scrolling back, pick up a section as soon as the title is visible,
             if (item.offset().top < highlight_section_new_top)
               return item;
             // or if title is before the 2/3 point
             // (not sure about this, probably want also to have
             // "AND the id.top is <= displayable_itemsrent_active_it.top" so we don't jump FORWARD a section
             // when scrolling BACK, with lots of tiny sections)
             if ((item.offset().top < highlight_section_new_top + 2*$(window).height()/3)
                 && (!active_item || !active_item.offset() || active_item.offset().top >= item.offset().top))
               return item;

           }
           last_item = item;
         }
       });
       if (!highlight_section_completed && document.readyState === "complete") {
         highlight_section_completed = true;
       }
       if (!displayable_items.length) {
         $("#side-menu a.section").removeClass("active");
       } else {
         displayable_items = displayable_items[displayable_items.length-1];
         var id = displayable_items && displayable_items.length ? displayable_items[0].id : "";
       // Set/remove active class
         new_active = $("#side-menu a.section").filter("[section-target='#"+id+"']");
         if (new_active.hasClass("active")) {
           // nothing needed
         } else {
           $("#side-menu a.section").removeClass("active");
           $("#side-menu a.section").filter("[section-target='#"+id+"']").addClass("active");
         }
       }

       highlight_section_last_top = highlight_section_new_top;
    };
    var highlight_new_section = function() {
      highlight_section_completed = false;
      highlight_section_last_top = -1;
      highlight_section();
    }

    $(window).scroll(highlight_section);
    $(highlight_new_section);

    // detect link change - courtesy http://www.bennadel.com/blog/1520-binding-events-to-non-dom-objects-with-jquery.htm

    // Default to the current location.
    var strLocation = window.location.href;
    var strHash = window.location.hash;
    var strPrevLocation = "";
    var strPrevHash = "";

    // This is how often we will be checkint for
    // changes on the location.
    var intIntervalTime = 100;

    // This method removes the pound from the hash.
    var fnCleanHash = function( strHash ){
        return(
            strHash.substring( 1, strHash.length )
            );
    }

    // This will be the method that we use to check
    // changes in the window location.
    var fnCheckLocation = function(){
        // Check to see if the location has changed.
        if (strLocation != window.location.href){

            // Store the new and previous locations.
            strPrevLocation = strLocation;
            strPrevHash = strHash;
            strLocation = window.location.href;
            strHash = window.location.hash;

            // The location has changed. Trigger a
            // change event on the location object,
            // passing in the current and previous
            // location values.
            $( window.location ).trigger(
                "change",
                {
                    currentHref: strLocation,
                    currentHash: fnCleanHash( strHash ),
                    previousHref: strPrevLocation,
                    previousHash: fnCleanHash( strPrevHash )
                }
                );

        }
    }

    // Set an interval to check the location changes.
    setInterval( fnCheckLocation, intIntervalTime );

    // and trigger highlight section on link change
    $(window.location).bind("change", highlight_new_section);
})(jQuery);

</script>

            </aside>
        </div>
    </div>
</main>

<footer class="container">
    <div class="row">
        <div class="col-md-9">
            <p>Apache Brooklyn is distributed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License v2.0</a>.</p>
        </div>
        <div class="col-md-3 text-right">
            <p>
                <a class="btn btn-sm btn-default" href="https://github.com/apache/brooklyn-docs/edit/master/guide/blueprints/advanced-example.md">Edit This Page</a>
                <a href="https://brooklyn.apache.org/community/how-to-contribute-docs.html"
                    data-toggle="tooltip" data-placement="top" title="" data-delay="400" data-original-title="How to Edit Documentation">
                    <span class="octicon octicon-question octicon-footer"></span>
                </a>
            </p>
        </div>
    </div>
</footer>

</body>

<!--
  ~ Licensed to the Apache Software Foundation (ASF) under one
  ~ or more contributor license agreements.  See the NOTICE file
  ~ distributed with this work for additional information
  ~ regarding copyright ownership.  The ASF licenses this file
  ~ to you under the Apache License, Version 2.0 (the
  ~ "License"); you may not use this file except in compliance
  ~ with the License.  You may obtain a copy of the License at
  ~
  ~      http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing,
  ~ software distributed under the License is distributed on an
  ~ "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~ KIND, either express or implied.  See the License for the
  ~ specific language governing permissions and limitations
  ~ under the License.
  -->

<script type="text/javascript" src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/brooklyn-docs/style/deps/jquery.cookie.js"></script>
<script type="text/javascript" src="/brooklyn-docs/style/js/zeroclipboard/ZeroClipboard.min.js"></script>
<script type="text/javascript" src="/brooklyn-docs/style/deps/tooltip.js"></script>

<script type="text/javascript">
    ZeroClipboard.config({ moviePath: '/style/js/zeroclipboard/ZeroClipboard.swf' });
</script>
<script src="/brooklyn-docs/style/js/public.js"></script>
</html>
