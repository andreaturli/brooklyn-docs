<!DOCTYPE html>
<html>
<head>
<title>Apache Brooklyn Manual - Apache Brooklyn</title>
<meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
<link href="./style/deps/bootstrap.min.css" rel="stylesheet">
<link href="./style/deps/octicons/octicons.css" rel="stylesheet">
<link href="./style/deps/bootstrap-theme.css" rel="stylesheet">

<link href="./style/css/website.css" rel="stylesheet">
<link rel="stylesheet" href="./style/css/singlePage.css" type="text/css" media="screen" />
<style>.usermanual-pdf-exclude{ display: none; } .usermanual-pdf-include{ display: inline !important; visibility: visible !important; }</style>
<script>
[]
.forEach
.call(document.querySelectorAll('a[target="_blank"]'),
 function(link) {
  link.removeAttribute('target');
});
</script>
</head>

<body>



<div id="content_container" class="container">
	<header>
		<h1 id="content-top">Apache Brooklyn: User Manual</h1>
	</header>
	<h1>Contents</h1>
		
    <nav><ul>
		
		
			
			


	
	
	
	
	
	
	
	
	
	
	<a id="website/learnmore/index.md" name="website/learnmore/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-learn-more" id="link-learn-more">Learn More</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/learnmore/features/index.md" name="website/learnmore/features/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-features" id="link-features">Features</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Blueprinting
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Policy-based Management
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Operations
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Java
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/learnmore/theory.md" name="website/learnmore/theory.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	The Theory behind Brooklyn
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Why Brooklyn?
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Blueprints
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Benefits
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Standards
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/learnmore/catalog/index.html" name="website/learnmore/catalog/index.html" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Catalog
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

		
			
			

		
			
			


	
	
	
	
	
	
	
	
	
	
	<a id="website/documentation/index.md" name="website/documentation/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Documentation
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/index.md" name="guide/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	User Guide
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/misc/download.md" name="guide/misc/download.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-downloads" id="link-downloads">Downloads</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/concepts/index.md" name="guide/concepts/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-brooklyn-concepts" id="link-brooklyn-concepts">Brooklyn Concepts</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/concepts/entities.md" name="guide/concepts/entities.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-entities" id="link-entities">Entities</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/concepts/application-parent-membership.md" name="guide/concepts/application-parent-membership.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-application,-parent-and-membership" id="link-application,-parent-and-membership">Application, Parent and Membership</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/concepts/configuration-sensor-effectors.md" name="guide/concepts/configuration-sensor-effectors.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-configuration,-sensors-and-effectors" id="link-configuration,-sensors-and-effectors">Configuration, Sensors and Effectors</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/concepts/lifecycle-managementcontext.md" name="guide/concepts/lifecycle-managementcontext.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-lifecycle-and-managementcontext" id="link-lifecycle-and-managementcontext">Lifecycle and ManagementContext</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/concepts/dependent-configuration.md" name="guide/concepts/dependent-configuration.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-dependent-configuration" id="link-dependent-configuration">Dependent Configuration</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/concepts/location.md" name="guide/concepts/location.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-location" id="link-location">Location</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/concepts/policies.md" name="guide/concepts/policies.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-policies" id="link-policies">Policies</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/concepts/execution.md" name="guide/concepts/execution.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-execution" id="link-execution">Execution</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/concepts/stop-start-restart-behaviour.md" name="guide/concepts/stop-start-restart-behaviour.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-stopstartrestart-behaviour" id="link-stopstartrestart-behaviour">Stop/start/restart behaviour</a>
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/index.md" name="guide/blueprints/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-writing-blueprints" id="link-writing-blueprints">Writing Blueprints</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/creating-yaml.md" name="guide/blueprints/creating-yaml.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-the-basic-structure" id="link-the-basic-structure">The Basic Structure</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/entity-configuration.md" name="guide/blueprints/entity-configuration.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-entity-configuration" id="link-entity-configuration">Entity Configuration</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/setting-locations.md" name="guide/blueprints/setting-locations.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-setting-locations" id="link-setting-locations">Setting Locations</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/configuring-vms.md" name="guide/blueprints/configuring-vms.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-configuring-vms" id="link-configuring-vms">Configuring VMs</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/multiple-services.md" name="guide/blueprints/multiple-services.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-multiple-services-and-dependency-injection" id="link-multiple-services-and-dependency-injection">Multiple Services and Dependency Injection</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/custom-entities.md" name="guide/blueprints/custom-entities.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-custom-entities" id="link-custom-entities">Custom Entities</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/catalog/index.md" name="guide/blueprints/catalog/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-catalog" id="link-catalog">Catalog</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	General YAML Schema
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Catalog Metadata
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Catalog YAML Examples
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Templates
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Adding and Deleting
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Versioning
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	CLI Options
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/clusters.md" name="guide/blueprints/clusters.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-clusters,-specs,-and-composition" id="link-clusters,-specs,-and-composition">Clusters, Specs, and Composition</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/enrichers.md" name="guide/blueprints/enrichers.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-enrichers" id="link-enrichers">Enrichers</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/policies.md" name="guide/blueprints/policies.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-policies" id="link-policies">Policies</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/clusters-and-policies.md" name="guide/blueprints/clusters-and-policies.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-clusters-and-policies" id="link-clusters-and-policies">Clusters and Policies</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/java/index.md" name="guide/blueprints/java/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-java-entities" id="link-java-entities">Java Entities</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/java/archetype.md" name="guide/blueprints/java/archetype.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-creating-from-a-maven-archetype" id="link-creating-from-a-maven-archetype">Creating from a Maven Archetype</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/java/defining-and-deploying.md" name="guide/blueprints/java/defining-and-deploying.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-defining-and-deploying" id="link-defining-and-deploying">Defining and Deploying</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/java/bundle-dependencies.md" name="guide/blueprints/java/bundle-dependencies.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-handling-bundle-dependencies" id="link-handling-bundle-dependencies">Handling Bundle Dependencies</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/java/topology-dependencies.md" name="guide/blueprints/java/topology-dependencies.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-topology,-dependencies,-and-management-policies" id="link-topology,-dependencies,-and-management-policies">Topology, Dependencies, and Management Policies</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/java/common-usage.md" name="guide/blueprints/java/common-usage.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-common-classes-and-entities" id="link-common-classes-and-entities">Common Classes and Entities</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/java/feeds.md" name="guide/blueprints/java/feeds.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-feeds" id="link-feeds">Feeds</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/java/entity.md" name="guide/blueprints/java/entity.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-writing-an-entity" id="link-writing-an-entity">Writing an Entity</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/java/entities.md" name="guide/blueprints/java/entities.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-custom-entity-development" id="link-custom-entity-development">Custom Entity Development</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/java/service-state.md" name="guide/blueprints/java/service-state.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-service-state" id="link-service-state">Service State</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/java/entitlements.md" name="guide/blueprints/java/entitlements.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-entitlements" id="link-entitlements">Entitlements</a>
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/winrm/index.md" name="guide/blueprints/winrm/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-windows-blueprints" id="link-windows-blueprints">Windows Blueprints</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/winrm/client.md" name="guide/blueprints/winrm/client.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-winrm4j-client" id="link-winrm4j-client">Winrm4j Client</a>
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/test/index.md" name="guide/blueprints/test/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-testing-yaml-blueprints" id="link-testing-yaml-blueprints">Testing YAML Blueprints</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/test/test-entities.md" name="guide/blueprints/test/test-entities.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-blueprint-test-entities" id="link-blueprint-test-entities">Blueprint Test Entities</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/test/usage-examples.md" name="guide/blueprints/test/usage-examples.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-example-blueprint-tests" id="link-example-blueprint-tests">Example Blueprint Tests</a>
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/ansible/index.md" name="guide/blueprints/ansible/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-ansible-in-yaml-blueprints" id="link-ansible-in-yaml-blueprints">Ansible in YAML Blueprints</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/ansible/about-ansible.md" name="guide/blueprints/ansible/about-ansible.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-about-ansible" id="link-about-ansible">About Ansible</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/ansible/creating-ansible-blueprints.md" name="guide/blueprints/ansible/creating-ansible-blueprints.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-creating-blueprints-with-ansible" id="link-creating-blueprints-with-ansible">Creating Blueprints with Ansible</a>
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/chef/index.md" name="guide/blueprints/chef/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-chef-in-yaml-blueprints" id="link-chef-in-yaml-blueprints">Chef in YAML Blueprints</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/chef/about-chef.md" name="guide/blueprints/chef/about-chef.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-about-chef" id="link-about-chef">About Chef</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/chef/creating-blueprints.md" name="guide/blueprints/chef/creating-blueprints.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-creating-blueprints-from-chef" id="link-creating-blueprints-from-chef">Creating Blueprints from Chef</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/chef/writing-chef.md" name="guide/blueprints/chef/writing-chef.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-writing-chef-for-blueprints" id="link-writing-chef-for-blueprints">Writing Chef for Blueprints</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/chef/advanced-chef-integration.md" name="guide/blueprints/chef/advanced-chef-integration.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-advanced-chef-integration" id="link-advanced-chef-integration">Advanced Chef Integration</a>
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/salt/index.md" name="guide/blueprints/salt/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-salt-in-yaml-blueprints" id="link-salt-in-yaml-blueprints">Salt in YAML Blueprints</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/salt/about-salt.md" name="guide/blueprints/salt/about-salt.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-about-salt" id="link-about-salt">About Salt</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/salt/creating-salt-blueprints.md" name="guide/blueprints/salt/creating-salt-blueprints.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-creating-blueprints-with-salt" id="link-creating-blueprints-with-salt">Creating Blueprints with Salt</a>
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/advanced-example.md" name="guide/blueprints/advanced-example.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-yaml-blueprint-advanced-example" id="link-yaml-blueprint-advanced-example">YAML Blueprint Advanced Example</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/blueprinting-tips.md" name="guide/blueprints/blueprinting-tips.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-blueprinting-tips" id="link-blueprinting-tips">Blueprinting Tips</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/yaml-reference.md" name="guide/blueprints/yaml-reference.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	YAML Blueprint Reference
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/index.md" name="guide/ops/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-reference-guide" id="link-reference-guide">Reference Guide</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/production-installation.md" name="guide/ops/production-installation.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-production-installation" id="link-production-installation">Production Installation</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/starting-stopping-monitoring.md" name="guide/ops/starting-stopping-monitoring.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-starting,-stopping-and-monitoring" id="link-starting,-stopping-and-monitoring">Starting, Stopping and Monitoring</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/server-cli-reference.md" name="guide/ops/server-cli-reference.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-server-cli-reference" id="link-server-cli-reference">Server CLI Reference</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/cli/index.md" name="guide/ops/cli/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-client-cli-reference" id="link-client-cli-reference">Client CLI Reference</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/cli/cli-ref-guide.md" name="guide/ops/cli/cli-ref-guide.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-cli-reference-guide" id="link-cli-reference-guide">CLI Reference Guide</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	List of Commands
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Scopes
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Abbreviations
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Command Reference
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Login
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Applications
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Entities
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Sensors
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Effectors
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Policies
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Activities
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Miscellaneous
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/cli/cli-usage-guide.md" name="guide/ops/cli/cli-usage-guide.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-cli-usage-guide" id="link-cli-usage-guide">CLI Usage Guide</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Login
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Applications
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Entities
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Sensors
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Effectors
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Policies
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Activities
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	YAML Blueprint
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/gui/index.md" name="guide/ops/gui/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-gui-guide" id="link-gui-guide">GUI Guide</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/gui/running.md" name="guide/ops/gui/running.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-launching" id="link-launching">Launching</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/gui/blueprints.md" name="guide/ops/gui/blueprints.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-deploying-blueprints" id="link-deploying-blueprints">Deploying Blueprints</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Launching from a Blueprint
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Launching from the Catalog
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/gui/managing.md" name="guide/ops/gui/managing.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-monitoring-and-managing-applications" id="link-monitoring-and-managing-applications">Monitoring and Managing Applications</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/gui/policies.md" name="guide/ops/gui/policies.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-using-policies" id="link-using-policies">Using Policies</a>
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/rest.md" name="guide/ops/rest.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-rest-api" id="link-rest-api">REST API</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/brooklyn_properties.md" name="guide/ops/brooklyn_properties.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-brooklyn.properties" id="link-brooklyn.properties">brooklyn.properties</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Quick Setup
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Locations
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Java
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Authentication
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Entitlements
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	HTTPS Configuration
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/persistence/index.md" name="guide/ops/persistence/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-persistence" id="link-persistence">Persistence</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Command Line Options
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	File-based Persistence
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Object Store Persistence
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Rebinding to State
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Writing Persistable Code
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Persisted State Backup
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/high-availability/index.md" name="guide/ops/high-availability/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-high-availability" id="link-high-availability">High Availability</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/high-availability/high-availability-supplemental.md" name="guide/ops/high-availability/high-availability-supplemental.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-high-availability-(supplemental)" id="link-high-availability-(supplemental)">High Availability (Supplemental)</a>
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/osgi.md" name="guide/ops/osgi.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-osgi-distribution" id="link-osgi-distribution">OSGi Distribution</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/osgi-configuration.md" name="guide/ops/osgi-configuration.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-osgi-configuration" id="link-osgi-configuration">OSGi Configuration</a>
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/logging.md" name="guide/ops/logging.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-logging" id="link-logging">Logging</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/https.md" name="guide/ops/https.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-https-configuration" id="link-https-configuration">HTTPS Configuration</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/externalized-configuration.md" name="guide/ops/externalized-configuration.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-externalized-configuration" id="link-externalized-configuration">Externalized Configuration</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/requirements.md" name="guide/ops/requirements.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-requirements" id="link-requirements">Requirements</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/security-guidelines.md" name="guide/ops/security-guidelines.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-security-guidelines" id="link-security-guidelines">Security Guidelines</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/troubleshooting/index.md" name="guide/ops/troubleshooting/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-troubleshooting" id="link-troubleshooting">Troubleshooting</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/troubleshooting/overview.md" name="guide/ops/troubleshooting/overview.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Troubleshooting Overview
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/troubleshooting/web-console-issues.md" name="guide/ops/troubleshooting/web-console-issues.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Web Console Issues
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/troubleshooting/deployment.md" name="guide/ops/troubleshooting/deployment.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Troubleshooting Deployment
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/troubleshooting/connectivity.md" name="guide/ops/troubleshooting/connectivity.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Troubleshooting Server Connectivity Issues in the Cloud
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/troubleshooting/slow-unresponsive.md" name="guide/ops/troubleshooting/slow-unresponsive.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Brooklyn Slow or Unresponsive
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/troubleshooting/increase-entropy.md" name="guide/ops/troubleshooting/increase-entropy.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Increase Entropy
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/troubleshooting/increase-system-resource-limits.md" name="guide/ops/troubleshooting/increase-system-resource-limits.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Increase System Resource Limits
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/troubleshooting/detailed-support-report.md" name="guide/ops/troubleshooting/detailed-support-report.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Detailed Support Report
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/troubleshooting/softwareprocess.md" name="guide/ops/troubleshooting/softwareprocess.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Troubleshooting SoftwareProcess Entities
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/troubleshooting/going-deep-in-java-and-logs.md" name="guide/ops/troubleshooting/going-deep-in-java-and-logs.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Troubleshooting: Going Deep in Java and Logs
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/troubleshooting/memory-usage.md" name="guide/ops/troubleshooting/memory-usage.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Troubleshooting: Monitoring Memory Usage
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/misc/index.md" name="guide/misc/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-other-0.12.0-snapshot-resources" id="link-other-0.12.0-snapshot-resources">Other 0.12.0-SNAPSHOT Resources</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/misc/javadoc/index.md" name="guide/misc/javadoc/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	API Reference
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/misc/download.md" name="guide/misc/download.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Downloads
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/misc/release-notes.md" name="guide/misc/release-notes.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-release-notes" id="link-release-notes">Release Notes</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/misc/migrate-to-0.8.0.md" name="guide/misc/migrate-to-0.8.0.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-migrating-to-0.8.0" id="link-migrating-to-0.8.0">Migrating to 0.8.0</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/misc/known-issues.md" name="guide/misc/known-issues.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-known-issues" id="link-known-issues">Known Issues</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/dev/index.md" name="guide/dev/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Developer Guide
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	  Get the Code &nbsp; <a href="/brooklyn-docs/developers/code/"><span class="octicon octicon-link-external"></span></a>
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/dev/env/maven-build.md" name="guide/dev/env/maven-build.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-maven-build" id="link-maven-build">Maven Build</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/dev/env/ide/index.md" name="guide/dev/env/ide/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-ide-setup" id="link-ide-setup">IDE Setup</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/dev/code/structure.md" name="guide/dev/code/structure.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-code-structure" id="link-code-structure">Code Structure</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/dev/code/tests.md" name="guide/dev/code/tests.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-tests" id="link-tests">Tests</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/dev/code/licensing.md" name="guide/dev/code/licensing.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-license-considerations" id="link-license-considerations">License Considerations</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/dev/tips/index.md" name="guide/dev/tips/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-miscellaneous-tips-and-tricks" id="link-miscellaneous-tips-and-tricks">Miscellaneous Tips and Tricks</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/dev/tips/logging.md" name="guide/dev/tips/logging.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-logging" id="link-logging">Logging</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/dev/tips/debugging-remote-brooklyn.md" name="guide/dev/tips/debugging-remote-brooklyn.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-brooklyn-remote-debugging" id="link-brooklyn-remote-debugging">Brooklyn Remote Debugging</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	  GitHub &nbsp; <a href="http://github.com/apache/brooklyn"><span class="octicon octicon-link-external"></span></a>
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	  Javadoc &nbsp; <a href="https://brooklyn.apache.org/v/latest/misc/javadoc"><span class="octicon octicon-link-external"></span></a>
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/documentation/index.md" name="website/documentation/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	  Documentation &nbsp; <a href="#link-documentation"><span class="octicon octicon-link-external flip"></span></a>
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/blueprints/index.md" name="guide/blueprints/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	  Writing Blueprints &nbsp; <a href="#link-writing-blueprints"><span class="octicon octicon-link-external flip"></span></a>
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/locations/index.md" name="guide/locations/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Locations
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Clouds
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Amazon Web Services
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Azure Compute ARM
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Azure Compute Classic
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Apache CloudStack
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Google Compute Engine
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	IBM Softlayer
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Named Locations
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	OpenStack
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/locations/location-customizers.md" name="guide/locations/location-customizers.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Location Customizers
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	BYON
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	SSH Keys
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Localhost
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Specialized Locations
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/ops/index.md" name="guide/ops/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	  Reference Guide &nbsp; <a href="#link-reference-guide"><span class="octicon octicon-link-external flip"></span></a>
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/dev/index.md" name="guide/dev/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	  Developer Guide &nbsp; <a href="#link-developer-guide"><span class="octicon octicon-link-external flip"></span></a>
	 
	</li>

	    
	     
	     

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/documentation/other-docs.md" name="website/documentation/other-docs.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Other Resources
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/documentation/glossary.md" name="website/documentation/glossary.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-glossary" id="link-glossary">Glossary</a>
	    
	  
	 
	</li>

	    
	     
	     

	    
	     
	     

	    
	    
	   </ul>
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

		
			
			

		
			
			


	
	
	
	
	
	
	
	
	
	
	<a id="website/developers/index.md" name="website/developers/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-developers" id="link-developers">Developers</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/developers/code/index.md" name="website/developers/code/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-get-the-code" id="link-get-the-code">Get the Code</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/developers/code/git-more.md" name="website/developers/code/git-more.md" href="javascript:void(0);"></a>
	
	<li>
	 
	  Get the Code &nbsp; <a href="#link-get-the-code"><span class="octicon octicon-link-external flip"></span></a>
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/developers/how-to-contribute.md" name="website/developers/how-to-contribute.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-how-to-contribute" id="link-how-to-contribute">How to Contribute</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	CLA
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Jira
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	GitHub
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	    	Reviews
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	  Get the Code &nbsp; <a href="#link-get-the-code"><span class="octicon octicon-link-external flip"></span></a>
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	  Handy Places &nbsp; <a href="links.html"><span class="octicon octicon-link-external"></span></a>
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="guide/dev/index.md" name="guide/dev/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	  Developer Guide &nbsp; <a href="#link-developer-guide"><span class="octicon octicon-link-external flip"></span></a>
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/developers/committers/index.md" name="website/developers/committers/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-committer-guide" id="link-committer-guide">Committer Guide</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/developers/committers/merging-contributed-code.md" name="website/developers/committers/merging-contributed-code.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-merging-contributed-code" id="link-merging-contributed-code">Merging Contributed Code</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/developers/committers/release-process/index.md" name="website/developers/committers/release-process/index.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-release-process" id="link-release-process">Release Process</a>
	    
	  
	   
	   <ul>
	    
	    
	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/developers/committers/release-process/prerequisites.md" name="website/developers/committers/release-process/prerequisites.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-release-prerequisites" id="link-release-prerequisites">Release Prerequisites</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/developers/committers/release-process/environment-variables.md" name="website/developers/committers/release-process/environment-variables.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-environment-variables-for-the-release" id="link-environment-variables-for-the-release">Environment variables for the release</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/developers/committers/release-process/release-version.md" name="website/developers/committers/release-process/release-version.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-release-branch-and-set-version" id="link-release-branch-and-set-version">Release branch and set version</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/developers/committers/release-process/make-release-artifacts.md" name="website/developers/committers/release-process/make-release-artifacts.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-make-the-release-artifacts" id="link-make-the-release-artifacts">Make the release artifacts</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/developers/committers/release-process/verify-release-artifacts.md" name="website/developers/committers/release-process/verify-release-artifacts.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-verify-the-release-artifacts" id="link-verify-the-release-artifacts">Verify the release artifacts</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/developers/committers/release-process/publish-temp.md" name="website/developers/committers/release-process/publish-temp.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-publish-to-the-staging-area" id="link-publish-to-the-staging-area">Publish to the staging area</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/developers/committers/release-process/vote.md" name="website/developers/committers/release-process/vote.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-vote-on-dev@brooklyn" id="link-vote-on-dev@brooklyn">Vote on dev@brooklyn</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/developers/committers/release-process/fix-release.md" name="website/developers/committers/release-process/fix-release.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-fix-on-the-release-branch" id="link-fix-on-the-release-branch">Fix on the release branch</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/developers/committers/release-process/publish.md" name="website/developers/committers/release-process/publish.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-publish-to-the-public" id="link-publish-to-the-public">Publish to the public</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/developers/committers/release-process/announce.md" name="website/developers/committers/release-process/announce.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-announce-the-release" id="link-announce-the-release">Announce the release</a>
	    
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/developers/code-standards.md" name="website/developers/code-standards.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-code-standards" id="link-code-standards">Code Standards</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="website/developers/links.md" name="website/developers/links.md" href="javascript:void(0);"></a>
	
	<li>
	 
	 	 
	   		<a href="#contentsLink-handy-places" id="link-handy-places">Handy Places</a>
	    
	  
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	  GitHub &nbsp; <a href="http://github.com/apache/brooklyn"><span class="octicon octicon-link-external"></span></a>
	 
	</li>

	    
	     
	     


	
	
	
	
	
	
	
	
	
	
	<a id="" name="" href="javascript:void(0);"></a>
	
	<li>
	 
	  Bug Tracker (JIRA) &nbsp; <a href="https://issues.apache.org/jira/browse/BROOKLYN"><span class="octicon octicon-link-external"></span></a>
	 
	</li>

	    
	    
	   </ul>
	  
	 
	</li>

		
			
			

		
    </ul></nav>

	
	
		
		

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-learn-more" class="section-breaker section p-">
	<span style="width: 100%"><h1>Learn More</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<!--
TODO have a list of resources here?  or start w yaml explained?

Got a minute?  blueprint-tour
Got two minutes?  watch the video
Four minutes?  read the features list
  cf http://help.eclipse.org/juno/index.jsp?topic=%2Forg.eclipse.platform.doc.user%2FwhatsNew%2Fplatform_whatsnew.html  -- though maybe with smaller screenshots at left and bigger text for summary!)
More time?
  Browse the catalog of Supported software, clouds, and policies
  Read on the Theory behing brooklyn
  Read the Brooklyn News
    infoq - http://www.infoq.com/news/2014/06/clocker
    Adam Davis: The case for application-driven cloud computing (Gluecon keynote) http://www.cloudsoftcorp.com/blog/2014/06/adam-davis-case-application-driven-cloud-computing/
    [showing video at min 14]
    twitter feed
    selected blog posts
-->

<div class="list-children"><ul>

<li> <a href="http://brooklyn.apache.org/v/0.10.0/learnmore/blueprint-tour.html">A Quick Tour of a Brooklyn Blueprint</a> </li>

<li> <a href="#contentsLink-features">Features</a> </li>

<li> <a href="#contentsLink-the-theory-behind-brooklyn">The Theory behind Brooklyn</a> </li>

<li> <a href="#contentsLink-catalog">Catalog</a> </li>

</ul></div>


	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-features" class="section-breaker section p-">
	<span style="width: 100%"><h1>Features</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<div class="feature-list">


<h3 id="internalLink_features_blueprinting">Blueprinting</h3>

<div class="feature-item">
  <div class="feature-title">Composable blueprints</div>
  <div class="feature-body">


A YAML service spec can refer to other blueprints,
either in the catalog or by URL,
and can supply custom configuration.


<div class="feature-image">
  <img src="./learnmore/features/blueprint-compose.png" />
</div>




</div></div>

<div class="feature-item">
  <div class="feature-title">Portable machines specs -- or location-specific identifiers</div>
  <div class="feature-body">


<p>
Define machine specs using portable constraints,
or, when you need to, use specific <code>imageId</code>, hardware profiles, and more
</p>





<div class="feature-image">
  <img src="./learnmore/features/blueprint-machine-specs.png" />
</div>



</div></div>


<h3 id="internalLink_features_policy-based-management">Policy-Based Management</h3>

<div class="feature-item">
  <div class="feature-title">Live metrics</div>
  <div class="feature-body">


Collect live metrics for use in policies,
either from metric stores or directly using REST, JMX, SSH, and more.




</div></div>

<div class="feature-item">
  <div class="feature-title">Management policies</div>
  <div class="feature-body">

<p>
Choose from built-in policies including auto-scaling, failover, and follow-the-sun,
or create new policies to perform custom runtime management.
</p>

<p>
Use config keys to customize the policies to suit your systems, right in the YAML blueprint.
</p>



</div></div>

<div class="feature-item">
  <div class="feature-title">Dynamic reconfiguration</div>
  <div class="feature-body">

Reconfigure policies, suspend them, or add new ones on-the-fly
through the REST API.



</div></div>


<h3 id="internalLink_features_operations">Operations</h3>

<div class="feature-item">
  <div class="feature-title">Brooklyn console</div>
  <div class="feature-body">


Brooklyn runs with a GUI console giving easy access to the
management hierarchy, sensors, and activities.





<div class="feature-image">
  <img src="./learnmore/features/ops-console.png" />
</div>



</div></div>

<div class="feature-item">
  <div class="feature-title">High availability</div>
  <div class="feature-body">


Run standby nodes which can optionally automatically promote to master
in the event of master failure. Hot standby nodes can provide additional
read-only access to entity information.



</div></div>

<div class="feature-item">
  <div class="feature-title">State persistence</div>
  <div class="feature-body">


Blueprint, catalog, topology and sensor information can be 
automatically persisted to any file system or object store to 
stop Brooklyn and restart resuming where you left off.



</div></div>

<div class="feature-item">
  <div class="feature-title">REST API</div>
  <div class="feature-body">


<p>
The console is pure JS-REST, and all the data shown in the GUI
is available through a straightforward REST/JSON API.
</p>

<p>
In many cases, the REST API is simply the GUI endpoint without the
leading <code>#</code>.  For instance the data for
<code>#/v1/applications/</code> is available at <code>/v1/applications/</code>. 
And in all cases, Swagger doc is available in the product.
</p>




<div class="feature-image">
  <img src="./learnmore/features/ops-rest.png" />
</div>



</div></div>

<div class="feature-item">
  <div class="feature-title">Groovy console</div>
  <div class="feature-body">


With the right permissions, Groovy scripts can be sent via
the GUI or via REST, allowing open-heart surgery on your systems.
(Use with care!) 



</div></div>

<div class="feature-item">
  <div class="feature-title">Versioning</div>
  <div class="feature-body">


Blueprints in the catalog can be versioned on-the-fly.
Running entities are attached to the version against which
they were launched to preserve integrity, until manual
version updates are performed. 



</div></div>

<div class="feature-item">
  <div class="feature-title">Deep task information</div>
  <div class="feature-body">

The console shows task flows in real-time,
including the `stdin` and `stdout` for shell commands,
making it simpler to debug those pesky failures.



</div></div>



<h3 id="internalLink_features_java">Java</h3>

<div class="feature-item">
  <div class="feature-title">Discoverable configuration</div>
  <div class="feature-body">


Config keys, sensors, and effectors can be defined on the classes
such that they are automatically discoverable at runtime.
Type information, parameters, documentation, and default values
are returned through the REST API and shown in the GUI.   




</div></div>

<div class="feature-item">
  <div class="feature-title">Type hierarchy</div>
  <div class="feature-body">


Use interfaces and mix-ins to share and inherit behavior in a strongly typed way.





<div class="feature-image">
  <img src="./learnmore/features/java-hierarchy.png" />
</div>



</div></div>

<div class="feature-item">
  <div class="feature-title">Sensor feeds</div>
  <div class="feature-body">


Fluent builder-style API's are included for collecting sensor information
from REST endpoints, SSH commands, JMX connectors, and more. 




</div></div>

<div class="feature-item">
  <div class="feature-title">Task libraries</div>
  <div class="feature-body">


Fluent builder-style task libraries are included for building activity
chains which run in parallel or sequentially,
executing SSH, REST, or arbitrary Java commands.
Task status, result, hierarchies, and errors are exposed through the REST API and in the GUI. 




</div></div>


</div>

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	    
	  
	 

 
    
		
		

    
		
		

	
	
	
	
	
	
	
	 
	 
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	   
	    
	    
	    
	     
	     

	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-downloads" class="section-breaker section p-">
	<span style="width: 100%"><h1>Downloads</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	
<p><strong>The downloads on this page have not been voted on and should be used at your own risk.
The latest stable release can be accessed on the <a href="http://brooklyn.apache.org/v/0.10.0/download/index.html">main download page</a>.</strong></p>

<h2 id="internalLink_downloads_download-version-0120-snapshot">Download Version 0.12.0-SNAPSHOT</h2>

<table class="table">
  <tr>
	<th style="text-align:left">Download</th>
	<th style="text-align:left">File/Format</th>
	<th>checksums <small><a href="http://brooklyn.apache.org/v/0.10.0/download/verify.html" title="Instructions on verifying the integrity of your downloads. May not be available for SNAPSHOT artifacts.">(?)</a></small></th>
  </tr>
  <tr>
	<td style="text-align:left;vertical-align:top" rowspan="2">Binary distribution<br />Server &amp; client</td>
	<td style="text-align:left"><a href="https://www.apache.org/dyn/closer.lua?action=download&amp;filename=brooklyn/apache-brooklyn-0.10.0/apache-brooklyn-0.10.0-bin.tar.gz" title="Download TGZ archive">apache-brooklyn-0.12.0-SNAPSHOT-bin.tar.gz</a></td>
	<td><small>
	  
	  <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/misc/-bin.tar.gz.sha1">SHA1</a></small></td>
  </tr>
  <tr>
	<td style="text-align:left"><a href="https://www.apache.org/dyn/closer.lua?action=download&amp;filename=brooklyn/apache-brooklyn-0.10.0/apache-brooklyn-0.10.0-bin.zip" title="Download ZIP archive">apache-brooklyn-0.12.0-SNAPSHOT-bin.zip</a></td>
	<td><small>
	  
	  <a href="https://dist.apache.org/repos/dist/release/brooklyn/apache-brooklyn-0.10.0/apache-brooklyn-0.10.0-bin.zip.sha1">SHA1</a></small></td>
  </tr>
  <tr>
	<td style="text-align:left;vertical-align:top">RPM package<br />CentOS7, RHEL7, etc.</td>
	<td style="text-align:left"><a href="https://www.apache.org/dyn/closer.lua?action=download&amp;filename=brooklyn/apache-brooklyn-0.10.0/apache-brooklyn-0.10.0-1.noarch.rpm" title="Download ZIP archive">apache-brooklyn-0.12.0-SNAPSHOT-1.noarch.rpm</a></td>
	<td><small>
	  
	  <a href="https://dist.apache.org/repos/dist/release/brooklyn/apache-brooklyn-0.10.0/apache-brooklyn-0.10.0-1.noarch.rpm.sha1">SHA1</a></small></td>
  </tr>
  <tr>
	<td style="text-align:left;vertical-align:top" rowspan="6">Client CLI only</td>
	<td style="text-align:left"><a href="https://www.apache.org/dyn/closer.lua?action=download&amp;filename=brooklyn/apache-brooklyn-0.10.0/apache-brooklyn-0.10.0-client-cli-linux.tar.gz" title="Download TGZ archive">apache-brooklyn-0.12.0-SNAPSHOT-client-cli-linux.tar.gz</a></td>
	<td><small>
	  
	  <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/misc/-client-cli-linux.tar.gz.sha1">SHA1</a></small></td>
  </tr>
  <tr>
	<td style="text-align:left"><a href="https://www.apache.org/dyn/closer.lua?action=download&amp;filename=brooklyn/apache-brooklyn-0.10.0/apache-brooklyn-0.10.0-client-cli-linux.zip" title="Download ZIP archive">apache-brooklyn-0.12.0-SNAPSHOT-client-cli-linux.zip</a></td>
	<td><small>
	  
	  <a href="https://dist.apache.org/repos/dist/release/brooklyn/apache-brooklyn-0.10.0/apache-brooklyn-0.10.0-client-cli-linux.zip.sha1">SHA1</a></small></td>
  </tr>
  <tr>
	<td style="text-align:left"><a href="https://www.apache.org/dyn/closer.lua?action=download&amp;filename=brooklyn/apache-brooklyn-0.10.0/apache-brooklyn-0.10.0-client-cli-macosx.tar.gz" title="Download TGZ archive">apache-brooklyn-0.12.0-SNAPSHOT-client-cli-macosx.tar.gz</a></td>
	<td><small>
	  
	  <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/misc/-client-cli-macosx.tar.gz.sha1">SHA1</a></small></td>
  </tr>
  <tr>
	<td style="text-align:left"><a href="https://www.apache.org/dyn/closer.lua?action=download&amp;filename=brooklyn/apache-brooklyn-0.10.0/apache-brooklyn-0.10.0-client-cli-macosx.zip" title="Download ZIP archive">apache-brooklyn-0.12.0-SNAPSHOT-client-cli-macosx.zip</a></td>
	<td><small>
	  
	  <a href="https://dist.apache.org/repos/dist/release/brooklyn/apache-brooklyn-0.10.0/apache-brooklyn-0.10.0-client-cli-macosx.zip.sha1">SHA1</a></small></td>
  </tr>
  <tr>
	<td style="text-align:left"><a href="https://www.apache.org/dyn/closer.lua?action=download&amp;filename=brooklyn/apache-brooklyn-0.10.0/apache-brooklyn-0.10.0-client-cli-windows.tar.gz" title="Download TGZ archive">apache-brooklyn-0.12.0-SNAPSHOT-client-cli-windows.tar.gz</a></td>
	<td><small>
	  
	  <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/misc/-client-cli-windows.tar.gz.sha1">SHA1</a></small></td>
  </tr>
  <tr>
	<td style="text-align:left"><a href="https://www.apache.org/dyn/closer.lua?action=download&amp;filename=brooklyn/apache-brooklyn-0.10.0/apache-brooklyn-0.10.0-client-cli-windows.zip" title="Download ZIP archive">apache-brooklyn-0.12.0-SNAPSHOT-client-cli-windows.zip</a></td>
	<td><small>
	  
	  <a href="https://dist.apache.org/repos/dist/release/brooklyn/apache-brooklyn-0.10.0/apache-brooklyn-0.10.0-client-cli-windows.zip.sha1">SHA1</a></small></td>
  </tr>
  <tr>
	<td style="text-align:left;vertical-align:top" rowspan="2">Source code</td>
	<td style="text-align:left"><a href="https://www.apache.org/dyn/closer.lua?action=download&amp;filename=brooklyn/apache-brooklyn-0.10.0/apache-brooklyn-0.10.0-src.tar.gz" title="Download TGZ archive">apache-brooklyn-0.12.0-SNAPSHOT-src.tar.gz</a></td>
	<td><small>
	  
	  <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/misc/-src.tar.gz.sha1">SHA1</a></small></td>
  </tr>
  <tr>
	<td style="text-align:left"><a href="https://www.apache.org/dyn/closer.lua?action=download&amp;filename=brooklyn/apache-brooklyn-0.10.0/apache-brooklyn-0.10.0-src.zip" title="Download ZIP archive">apache-brooklyn-0.12.0-SNAPSHOT-src.zip</a></td>
	<td><small>
	  
	  <a href="https://dist.apache.org/repos/dist/release/brooklyn/apache-brooklyn-0.10.0/apache-brooklyn-0.10.0-src.zip.sha1">SHA1</a></small></td>
  </tr>
</table>

<h2 id="internalLink_downloads_release-notes">Release Notes</h2>

<p>Release notes can be found <a href="#contentsLink-release-notes">here</a>.</p>

<p><a name="maven"></a></p>

<h2 id="internalLink_downloads_maven">Maven</h2>

<p>If you use Maven, you can add Brooklyn with the following in your pom:</p>

<!-- the comment is included due to a jekyll/highlight bug which
     removes indentation on the first line in a highlight block;
     we want the actual XML indented so you can cut and paste into a pom.xml sensibly -->

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="c">&lt;!-- include all Brooklyn items in our project --&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.brooklyn<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>brooklyn-all<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>0.12.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span></code></pre></div>

<p><code>brooklyn-all</code> brings in all dependencies, including jclouds.
If you prefer a smaller repo you might want just <code>brooklyn-core</code>,  <code>brooklyn-policies</code>, 
and some of <code>brooklyn-software-webapp</code>,  <code>brooklyn-software-database</code>, <code>brooklyn-software-messaging</code>, or others
(browse the full list <a href="https://repository.apache.org/index.html#nexus-search;gav~org.apache.brooklyn~~0.12.0-SNAPSHOT~~">here</a>).</p>

<p>If you wish to use the Apache snapshot repo, you can add this to you <code>pom.xml</code>:</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="c">&lt;!-- include repos for snapshot items and other dependencies --&gt;</span>
    <span class="nt">&lt;repositories&gt;</span>
        <span class="nt">&lt;repository&gt;</span>
            <span class="nt">&lt;id&gt;</span>apache-nexus-snapshots<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;name&gt;</span>Apache Nexus Snapshots<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;url&gt;</span>https://repository.apache.org/content/repositories/snapshots<span class="nt">&lt;/url&gt;</span>
            <span class="nt">&lt;releases&gt;</span> <span class="nt">&lt;enabled&gt;</span>false<span class="nt">&lt;/enabled&gt;</span> <span class="nt">&lt;/releases&gt;</span>
            <span class="nt">&lt;snapshots&gt;</span> <span class="nt">&lt;enabled&gt;</span>true<span class="nt">&lt;/enabled&gt;</span> <span class="nt">&lt;/snapshots&gt;</span>
        <span class="nt">&lt;/repository&gt;</span>
    <span class="nt">&lt;/repositories&gt;</span></code></pre></div>

<p><strong>Please note</strong>: to add a snapshot version of Brooklyn as a dependency to your project, 
you must either have Brooklyn built locally or one of these snapshot repositories in your POM.</p>

<p><a name="source"></a></p>

<h2 id="internalLink_downloads_source-code">Source Code</h2>

<p>Source code is hosted at <a href="http://github.com/apache/brooklyn">github.com/apache/brooklyn</a>,
with this version in branch <a href="https://github.com/apache/brooklyn-server/tree/master">master</a>.
These locations have a <code>README.md</code> in the root which explains how to get the code including
submodules.</p>

<p>Useful information on working with the source is <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/dev/code">here</a>.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-brooklyn-concepts" class="section-breaker section p-">
	<span style="width: 100%"><h1>Brooklyn Concepts</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>This introduces brooklyn and describes how it simplifies the deployment and management of big applications. It is
intended for people who are using brooklyn-supported application components (such as web/app servers, data stores)
to be able to use brooklyn to easily start their application in multiple locations with off-the-shelf management
policies.</p>

<div class="list-children"><ul>

<li> <a href="#contentsLink-entities">Entities</a> </li>

<li> <a href="#contentsLink-application,-parent-and-membership">Application, Parent and Membership</a> </li>

<li> <a href="#contentsLink-configuration,-sensors-and-effectors">Configuration, Sensors and Effectors</a> </li>

<li> <a href="#contentsLink-lifecycle-and-managementcontext">Lifecycle and ManagementContext</a> </li>

<li> <a href="#contentsLink-dependent-configuration">Dependent Configuration</a> </li>

<li> <a href="#contentsLink-location">Location</a> </li>

<li> <a href="#contentsLink-policies">Policies</a> </li>

<li> <a href="#contentsLink-execution">Execution</a> </li>

<li> <a href="#contentsLink-stopstartrestart-behaviour">Stop/start/restart behaviour</a> </li>

</ul></div>

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-entities" class="section-breaker section p-">
	<span style="width: 100%"><h1>Entities</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>The central concept in a Brooklyn deployment is that of an <strong><em>entity</em></strong>. 
An entity represents a resource under management, either <em>base</em> entities (individual machines or software processes) 
or logical collections of these entities.</p>

<p>Fundamental to the processing model is the capability of entities to be the <em>parent</em> of other entities (the mechanism by which collections are formed), 
with every entity having a single parent entity, up to the privileged top-level <strong><em>application</em></strong> entity.</p>

<p>Entities are code, so they can be extended, overridden, and modified. Entities can have events, operations, and processing logic associated with them, and it is through this mechanism that the active management is delivered.</p>

<p>The main responsibilities of an entity are:</p>

<ul>
  <li>Provisioning the entity in the given location or locations</li>
  <li>Holding configuration and state (attributes) for the entity</li>
  <li>Reporting monitoring data (sensors) about the status of the entity</li>
  <li>Exposing operations (effectors) that can be performed on the entity</li>
  <li>Hosting management policies and tasks related to the entity</li>
</ul>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-application,-parent-and-membership" class="section-breaker section p-">
	<span style="width: 100%"><h1>Application, Parent and Membership</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>All entities have a <strong><em>parent</em></strong> entity, which creates and manages it, with one important exception: <em>applications</em>.
Application entities are the top-level entities created and managed externally, manually or programmatically.</p>

<p>Applications are typically defined in Brooklyn as an <strong><em>application descriptor</em></strong>. 
This is a Java class specifying the entities which make up the application,
by extending the class <code>AbstractApplication</code>, and specifying how these entities should be configured and managed.</p>

<p>All entities, including applications, can be the parent of other entities. 
This means that the “child” is typically started, configured, and managed by the parent.
For example, an application may be the parent of a web cluster; that cluster in turn is the parent of web server processes.
In the management console, this is represented hierarchically in a tree view.</p>

<p>A parallel concept is that of <strong><em>membership</em></strong>: in addition to one fixed parent,
and entity may be a <strong><em>member</em></strong> of any number of special entities called <strong><em>groups</em></strong>.
Membership of a group can be used for whatever purpose is required; 
for example, it can be used to manage a collection of entities together for one purpose 
(e.g. wide-area load-balancing between locations) even though they may have been
created by different parents (e.g. a multi-tier stack within a location).</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-configuration,-sensors-and-effectors" class="section-breaker section p-">
	<span style="width: 100%"><h1>Configuration, Sensors and Effectors</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h3 id="internalLink_configuration,-sensors-and-effectors_configuration">Configuration</h3>

<p>All entities contain a map of config information. This can contain arbitrary values, typically keyed under static <code>ConfigKey</code> fields on the <code>Entity</code> sub-class. These values are inherited, so setting a configuration value at the
application level will make it available in all entities underneath unless it is overridden.</p>

<p>Configuration is propagated when an application “goes live” (i.e. it becomes “managed”, either explicitly or when its <code>start()</code> method is invoked), so config values must be set before this occurs. </p>

<p>Configuration values can be specified in a configuration file (<code>~/.brooklyn/brooklyn.properties</code>)
to apply universally, and/or programmatically to a specific entity and its descendants 
by calling <code>.configure(KEY, VALUE)</code> in the entity spec when creating it.
There is also an <code>entity.config().set(KEY, VALUE)</code> method.</p>

<p>Additionally, many common configuration parameters are available as “flags” which can be supplied as Strings when constructing
then entity, in the form
<code>EntitySpec.create˙(MyEntity.class).configure("config1", "value1").configure("config2", "value2")</code>. </p>

<p>Documentation of the flags available for individual entities can normally be found in the javadocs. 
The <code>@SetFromFlag</code> annotations on <code>ConfigKey</code> static field definitions
in the entity’s interface is the recommended mechanism for exposing configuration options.</p>

<h3 id="internalLink_configuration,-sensors-and-effectors_sensors-and-effectors">Sensors and Effectors</h3>

<p><strong><em>Sensors</em></strong> (activity information and notifications) and <strong><em>effectors</em></strong> (operations that can be invoked on the entity) are defined by entities as static fields on the <code>Entity</code> subclass.</p>

<p>Sensors can be updated by the entity or associated tasks, and sensors from an entity can be subscribed to by its parent or other entities to track changes in an entity’s activity.</p>

<p>Effectors can be invoked by an entity’s parent remotely, and the invoker is able to track the execution of that effector. Effectors can be invoked by other entities, but use this functionality with care to prevent too many managers!</p>

<p>An entity consists of a Java interface (used when interacting with the entity) and a Java class. For resilience. it is recommended to store 
the entity’s state in attributes (see <code>getAttribute(AttributeKey)</code>). If internal fields can be used then the data will be lost on brooklyn
restart, and may cause problems if the entity is to be moved to a different brooklyn management node.</p>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-lifecycle-and-managementcontext" class="section-breaker section p-">
	<span style="width: 100%"><h1>Lifecycle and ManagementContext</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Under-the-covers, at heart of the brooklyn management plane is the <code>ManagementContext</code>. 
This is started automatically when using launching an application using the brooklyn CLI. For programmatic use, see 
<code>BrooklynLauncher.newLauncher().launch()</code>.</p>

<p>A Brooklyn deployment consists of many entities in a hierarchical tree, with the privileged <em>application</em> entity at the top level.</p>

<p>An application entity (<code>Application</code> class) is responsible for starting the deployment of all its child entities (i.e. the entire entity tree under its ownership).</p>

<p>An <code>Application</code>’s <code>start()</code> method begins provisioning the child entities of the application (and their entities, recursively). </p>

<p>Provisioning of entities typically happens in parallel automatically,
although this can be customized. This is implemented as <strong><em>tasks</em></strong> which are tracked by the management plane and is accessible in the web-based management console and REST API.</p>

<p>Customized provisioning can be useful where two starting entities depend on each other. For example, it is often necessary to delay start of one entity until another entity reaches a certain state, and to supply run-time information about the latter to the former.</p>

<!-- TODO ambiguous language; need a better description of the "manage" lifecycle -->
<p>When new entities are created, the entity is wired up to an application by giving it a parent. The entity is then explicitly “managed”, which allows other entities to discover it.</p>

<p>Typically a Brooklyn deployment has a single management context which records:</p>

<ul>
  <li>all entities under management that are reachable by the application(s) via the parent-child relationships,</li>
  <li>the state associated with each entity,</li>
  <li>subscribers (listeners) to sensor events arising from the entities,</li>
  <li>active tasks (jobs) associated with any the entity,</li>
  <li>which Brooklyn management node is mastering (managing) each entity.</li>
</ul>

<!-- TODO Distributed brooklyn not yet supported; needs clarification in docs -->

<p>In a multi-location deployment, management operates in all regions, with brooklyn entity instances being mastered in the relevant region.</p>

<p>When management is distributed a Brooklyn deployment may consist of multiple Brooklyn management nodes each with a <code>ManagementContext</code> instance.</p>

<!-- TODO - Clarify the following statements.
The management context entity forms part of the management plane. 
The management plane is responsible for the distribution of the ``Entity`` instances across multiple machines and multiple locations, 
tracking the transfer of events (subscriptions) between ``Entity`` instances, and the execution of tasks (often initiated by management policies).
-->

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-dependent-configuration" class="section-breaker section p-">
	<span style="width: 100%"><h1>Dependent Configuration</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Under the covers Brooklyn has a sophisticated sensor event and subscription model, but conveniences around this model make it very simple to express cross-entity dependencies. Consider the example where Tomcat instances need to know the URL of a database (or a set of URLs to connect to a Monterey processing fabric, or other entities)</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">setConfiguration</span><span class="o">(</span><span class="n">UsesJava</span><span class="o">.</span><span class="na">JAVA_OPTIONS</span><span class="o">,</span> <span class="n">ImmutableMap</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&quot;mysql.url&quot;</span><span class="o">,</span> 
	    <span class="n">attributeWhenReady</span><span class="o">(</span><span class="n">mysql</span><span class="o">,</span> <span class="n">MySqlNode</span><span class="o">.</span><span class="na">MY_SQL_URL</span><span class="o">)</span> <span class="o">))</span></code></pre></div>

<p>The <code>attributeWhenReady(Entity, Sensor)</code> call (a static method on the class <code>DependentConfiguration</code>)
causes the configuration value to be set when that given entity’s attribue is ready. 
In the example, <code>attributeWhenReady()</code> causes the JVM system property <code>mysql.url</code> to be set to the value of the <code>MySqlNode.MY_SQL_URL</code> sensor from <code>mysql</code> when that value is ready. As soon as the database URL is announced by the MySql entity, the configuration value will be available to the Tomcat cluster. </p>

<p>By default “ready” means being <em>set</em> (non-null) and, if appropriate, <em>non-empty</em> (for collections and strings) or <em>non-zero</em> (for numbers). Formally the interpretation of ready is that of “Groovy truth” defined by an <code>asBoolean()</code> method on the class and in the Groovy language extensions. </p>

<p>You can customize “readiness” by supplying a <code>Predicate</code> (Google common) or <code>Closure</code> (Groovy) in a third parameter. 
This evaluates candidate values reported by the sensor until one is found to be <code>true</code>. 
For example, passing <code>{ it.size()&gt;=3 }</code> as the readiness argument would require at least three management plane URLs.</p>

<p>More information on this can be found in the javadoc for <code>DependentConfiguration</code>,
along with a few other methods such as <code>valueWhenAttributeReady</code> which allow post-processing of an attribute value.</p>

<p>Note that if the value of <code>CONFIG_KEY</code> passed to <code>Entity.getConfig</code> is a Closure or Task (such as returned by <code>attributeWhenReady</code>),
the first access of <code>Entity.getConfig(CONFIG_KEY)</code> will block until the task completes.
Typically this does the right thing, blocking when necessary to generate the right start-up sequence
without the developer having to think through the order, but it can take some getting used to.
Be careful not to request config information until really necessary (or to use non-blocking “raw” mechanisms),
and in complicated situations be ready to attend to circular dependencies.
The management console gives useful information for understanding what is happening and resolving the cycle.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-location" class="section-breaker section p-">
	<span style="width: 100%"><h1>Location</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<!-- TODO, Clarify is how geographical location works.
-->

<p>Entities can be provisioned/started in the location of your choice. Brooklyn transparently uses <a href="http://www.jclouds.org">jclouds</a> to support different cloud providers and to support BYON (Bring Your Own Nodes). </p>

<p>The implementation of an entity (e.g. Tomcat) is agnostic about where it will be installed/started. When writing the application definition specify the location or list of possible locations (<code>Location</code> instances) for hosting the entity.</p>

<p><code>Location</code> instances represent where they run and indicate how that location (resource or service) can be accessed.</p>

<p>For example, a <code>JBoss7Server</code> will usually be running in an <code>SshMachineLocation</code>, which contains the credentials and address for sshing to the machine. A cluster of such servers may be running in a <code>MachineProvisioningLocation</code>, capable of creating new <code>SshMachineLocation</code> instances as required.</p>

<!-- TODO, incorporate the following.

The idea is that you could specify the location as AWS and also supply an image id. You could configure the Tomcat entity accordingly: specify the path if the image already has Tomcat installed, or specify that Tomcat must be downloaded/installed. Entities typically use _drivers_ (such as SSH-based) to install, start, and interact with their corresponding real-world instance. 
-->

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-policies" class="section-breaker section p-">
	<span style="width: 100%"><h1>Policies</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Policies perform the active management enabled by Brooklyn. Entities can have zero or more <code>Policy</code> instances attached to them. </p>

<p>Policies can subscribe to sensors from entities or run periodically, and
when they run they can perform calculations, look up other values, and if deemed necessary invoke effectors or emit sensor values from the entity with which they are associated.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-execution" class="section-breaker section p-">
	<span style="width: 100%"><h1>Execution</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>All processing, whether an effector invocation or a policy cycle, are tracked as <strong><em>tasks</em></strong>. This allows several important capabilities:</p>

<ul>
  <li>active and historic processing can be observed by operators</li>
  <li>the invocation context is available in the thread, to check entitlement (permissions) and maintain a
hierarchical causal chain even when operations are run in parallel</li>
  <li>processing can be managed across multiple management nodes</li>
</ul>

<p>Some executions create new entities, which can then have tasks associated with them, and the system will record, for example, that a start effector on the new entity is a task associated with that entity, with that task
created by a task associated with a different entity.</p>

<p>The execution of a typical overall start-up sequence is shown below:</p>

<p><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/concepts/brooklyn-flow-websequencediagrams.com.png"><img src="./v/latest/concepts/brooklyn-flow-websequencediagrams.com-w400.png" alt="Brooklyn Flow Diagram" title="Brooklyn Flow Diagram" /></a></p>

<h2 id="internalLink_execution_integration">Integration</h2>

<p>One vital aspect of Brooklyn is its ability to communicate with the systems it starts. This is abstracted using a <strong><em>driver</em></strong> facility in Brooklyn, where a
driver describes how a process or service can be installed and managed using a particular technology.</p>

<p>For example, a <code>TomcatServer</code> may implement start and other effectors using a <code>TomcatSshDriver</code> which inherits from <code>JavaSoftwareProcessSshDriver</code> (for JVM and JMX start confguration), inheriting from <code>AbstractSoftwareProcessSshDriver</code>
(for SSH scripting support).</p>

<p>Particularly for sensors, some technologies are used so frequently that they are
packaged as <strong><em>feeds</em></strong> which can discover their configuration (including from drivers). These include JMX and HTTP (see <code>JmxFeed</code> and <code>HttpFeed</code>).</p>

<p>Brooklyn comes with entity implementations for a growing number of commonly used systems, including various web application servers, databases and NoSQL data stores, and messaging systems.</p>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-stopstartrestart-behaviour" class="section-breaker section p-">
	<span style="width: 100%"><h1>Stop/start/restart behaviour</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Many entities expose <code>start</code>, <code>stop</code> and <code>restart</code> effectors. The semantics of these operations (and the parameters they take) depends on the type of entity.</p>

<h2 id="internalLink_stopstartrestart-behaviour_top-level-applications">Top-level applications</h2>
<p>A top-level application is a grouping of other entities, pulling them together into the “application” of your choice. This could range from a single app-server, to an app that is a composite of a no-sql cluster (e.g. MongoDB sharded cluster, or Cassandra spread over multiple datacenters), a cluster of load-balanced app-servers, message brokers, etc.</p>

<h3 id="internalLink_stopstartrestart-behaviour_startcollection-ltlocationgt">start(Collection &lt;Location&gt;)</h3>
<p>This will start the application in the given location(s). Each child-entity within the application will be started concurrently, passing the location(s) to each child.
The start effector will be called automatically when the application is deployed through the catalog.
Is is strongly recommended to not call start again.</p>

<h3 id="internalLink_stopstartrestart-behaviour_stop">stop()</h3>
<p>Stop will terminate the application and all its child entities (including releasing all their resources).
The application will also be unmanaged, <strong>removing</strong> it from Brooklyn.</p>

<h3 id="internalLink_stopstartrestart-behaviour_restart">restart()</h3>
<p>This will invoke <code>restart()</code> on each child-entity concurrently (with the default values for the child-entity’s restart effector parameters).
Is is strongly recommended to not call this, unless the application has been explicitly written to implement restart.</p>

<h2 id="internalLink_stopstartrestart-behaviour_software-process-eg-mysql-tomcat-jboss-app-server-mongodb">Software Process (e.g MySql, Tomcat, JBoss app-server, MongoDB)</h2>

<h3 id="internalLink_stopstartrestart-behaviour_startcollection-ltlocationgt-1">start(Collection &lt;Location&gt;)</h3>
<p>This will start the software process in the given location.
If a machine location is passed in, then the software process is started there.
If a cloud location is passed in, then a new VM will be created in that cloud - the software process will be <strong>installed+launched</strong> on that new VM.</p>

<p>The start effector will have been called automatically when deploying an application through the catalog.
In normal usage, do not invoke start again.</p>

<p>If calling <code>start()</code> a second time, with no locations passed in (e.g. an empty list), then it will go through the start sequence on the existing location from the previous call.
It will <strong>install+customize+launch</strong> the process.
For some entities, this could be <em>dangerous</em>. The customize step might execute a database initialisation script, which could cause data to be overwritten (depending how the initialisation script was written).</p>

<p>If calling <code>start()</code> a second time with additional locations, then these additional locations will be added to the set of locations.
In normal usage it is not recommended.
This could be desired behaviour if the entity had previously been entirely stopped (including its VM terminated) - but for a simple one-entity app then you might as well have deleted the entire app and created a new one.</p>

<h3 id="internalLink_stopstartrestart-behaviour_stopboolean-stopmachine">stop(boolean stopMachine)</h3>
<p>If <code>stopMachine==true</code>, this effector will stop the software process and then terminate the VM (if a VM had been created as part of <code>start()</code>). This behaviour is the inverse of the first <code>start()</code> effector call.
When stopping the software process, it does not uninstall the software packages / files.</p>

<p>If <code>stopMachine==false</code>, this effector will stop just the software process (leaving the VM and all configuration files / install artifacts in place).</p>

<h3 id="internalLink_stopstartrestart-behaviour_restartboolean-restartmachine-boolean-restartchildren">restart(boolean restartMachine, boolean restartChildren)</h3>
<p>This will restart the software process.</p>

<p>If <code>restartMachine==true</code>, it will also terminate the VM and create a new VM. It will then install+customize+launch the software process on the new VM. It is equivalent of invoking <code>stop(true)</code> and then <code>start(Collections.EMPTY_LIST)</code>.
If <code>restartMachine==false</code>, it will first attempt to stop the software process (which should be a no-op if the process is not running), and will then start the software process (without going through the <strong>install+customize</strong> steps).</p>

<p>If <code>restartChildren==true</code>, then after restarting itself it will call <code>restart(restartMachine, restartChildren)</code> on each child-entity concurrently.</p>

<h2 id="internalLink_stopstartrestart-behaviour_recommended-operations">Recommended operations</h2>

<p>The recommended operations to invoke to stop just the software process, and then to restart it are:</p>

<ul>
  <li>Select the software process entity in the tree (<em>not</em> the parent application, but the child of that application).</li>
  <li>Invoke <code>stop(stopMachine=false)</code></li>
  <li>Invoke <code>restart(restartMachine=false, restartChildren=false)</code></li>
</ul>

	</div>
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-writing-blueprints" class="section-breaker section p-">
	<span style="width: 100%"><h1>Writing Blueprints</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	
<div class="list-children"><ul>

<li> <a href="#contentsLink-writing-blueprints">The Basic Structure</a> </li>

<li> <a href="#contentsLink-entity-configuration">Entity Configuration</a> </li>

<li> <a href="#contentsLink-setting-locations">Setting Locations</a> </li>

<li> <a href="#contentsLink-configuring-vms">Configuring VMs</a> </li>

<li> <a href="#contentsLink-multiple-services-and-dependency-injection">Multiple Services and Dependency Injection</a> </li>

<li> <a href="#contentsLink-custom-entities">Custom Entities</a> </li>

<li> <a href="#contentsLink-catalog">Catalog</a> </li>

<li> <a href="#contentsLink-clusters,-specs,-and-composition">Clusters, Specs, and Composition</a> </li>

<li> <a href="#contentsLink-enrichers">Enrichers</a> </li>

<li> <a href="#contentsLink-policies">Policies</a> </li>

<li> <a href="#contentsLink-clusters-and-policies">Clusters and Policies</a> </li>

<li> <a href="#contentsLink-java-entities">Java Entities</a> </li>

<li> <a href="#contentsLink-windows-blueprints">Windows Blueprints</a> </li>

<li> <a href="#contentsLink-testing-yaml-blueprints">Testing YAML Blueprints</a> </li>

<li> <a href="#contentsLink-ansible-in-yaml-blueprints">Ansible in YAML Blueprints</a> </li>

<li> <a href="#contentsLink-chef-in-yaml-blueprints">Chef in YAML Blueprints</a> </li>

<li> <a href="#contentsLink-salt-in-yaml-blueprints">Salt in YAML Blueprints</a> </li>

<li> <a href="#contentsLink-yaml-blueprint-advanced-example">YAML Blueprint Advanced Example</a> </li>

<li> <a href="#contentsLink-blueprinting-tips">Blueprinting Tips</a> </li>

<li> <a href="#contentsLink-yaml-blueprint-reference">YAML Blueprint Reference</a> </li>

</ul></div>

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-the-basic-structure" class="section-breaker section p-">
	<span style="width: 100%"><h1>The Basic Structure</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_the-basic-structure_a-first-blueprint">A First Blueprint</h2>

<p>The easiest way to write a blueprint is as a YAML file.
This follows the  <a href="https://www.oasis-open.org/committees/camp/">OASIS CAMP</a> plan specification, 
with some extensions described below.
(A <a href="#contentsLink-yaml-blueprint-reference">YAML reference</a> has more information,
and if the YAML doesn’t yet do what you want,
it’s easy to add new extensions using your favorite JVM language.)</p>

<h3 id="internalLink_the-basic-structure_the-basic-structure">The Basic Structure</h3>

<p>Here’s a very simple YAML blueprint plan, to explain the structure:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">simple-appserver</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.jboss.JBoss7Server</span></code></pre></div>

<ul>
  <li>
    <p>The <code>name</code> is just for the benefit of us humans.</p>
  </li>
  <li>
    <p>The <code>location</code> specifies where this should be deployed.
If you’ve <a href="#contentsLink-locations">set up passwordless localhost SSH access</a> 
you can use <code>localhost</code> as above, but if not, just wait ten seconds for the next example.</p>
  </li>
  <li>
    <p>The <code>services</code> block takes a list of the typed services we want to deploy.
This is the meat of the blueprint plan, as you’ll see below.</p>
  </li>
</ul>

<p>Finally, the clipboard in the top-right corner of the example plan box above (hover your cursor over the box)  lets you easily copy-and-paste into the web-console:
simply <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/start/running.html">download and launch</a> Brooklyn,
then in the “Create Application” dialog at the web console
(usually <a href="http://127.0.0.1:8081/">http://127.0.0.1:8081/</a>, paste the copied YAML into the “Yaml” tab of the dialog and press “Finish”. 
There are several other ways to deploy, including <code>curl</code> and via the command-line,
and you can configure users, https, persistence, and more, 
as described <a href="#contentsLink-reference-guide">in the ops guide</a>.</p>

<p><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/blueprints/web-console-yaml.png"><img src="./v/latest/blueprints/web-console-yaml-700.png" alt="Web Console" title="YAML via Web Console" /></a></p>

<!--
TODO building up children entities

-->

<h3 id="internalLink_the-basic-structure_more-information">More Information</h3>

<p>Topics to explore next on the topic of YAML blueprints are:</p>

<div class="list-children"><ul>

</ul></div>

<p>Plenty of examples of blueprints exist in the Brooklyn codebase,
so another starting point is to <a href="#contentsLink-get-the-code"><code>git clone</code></a> it
and search for <code>*.yaml</code> files therein.</p>

<p>Brooklyn lived as a Java framework for many years before we felt confident
to make a declarative front-end, so you can do pretty much anything you want to
by dropping to the JVM. For more information on Java:</p>

<ul>
  <li>start with a <a href="#contentsLink-creating-from-a-maven-archetype">Maven archetype</a></li>
  <li>see all <a href="#contentsLink-java-entities">Brooklyn Java guide</a> topics</li>
  <li>look at test cases in the <a href="https://github.com/apache/brooklyn">codebase</a></li>
</ul>

<!-- 
TODO
* review some [examples](/v/latest/use/examples/index.html)
-->

<p>You can also come talk to us, on IRC (#brooklyncentral on Freenode) or
any of the usual <a href="http://brooklyn.apache.org/v/0.10.0/community/index.html">hailing frequencies</a>,
as these documents are a work in progress.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-entity-configuration" class="section-breaker section p-">
	<span style="width: 100%"><h1>Entity Configuration</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Within a blueprint or catalog item, entities can be configured. The rules for setting this 
configuration, including when composing and extending existing entities, is described in this 
section. </p>

<h3 id="internalLink_entity-configuration_basic-configuration">Basic Configuration</h3>

<p>Within a YAML file, entity configuration should be supplied within a <code>brooklyn.config</code> map. It is 
also possible to supply configuration at the top-level of the entity. However, that approach is
discouraged as it can sometimes be ambiguous (e.g. if the config key is called “name” or “type”), 
and also it does not work in all contexts such as for an enricher’s configuration.</p>

<p>A simple example is shown below:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.tomcat.TomcatServer</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">webapp.enabledProtocols</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http</span>
    <span class="l-Scalar-Plain">http.port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">9080</span>
    <span class="l-Scalar-Plain">wars.root</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=org/apache/brooklyn/example/brooklyn-example-hello-world-webapp/0.9.0/brooklyn-example-hello-world-webapp-0.9.0.war</span></code></pre></div>

<p>If no config value is supplied, the default for that config key will be used. For example, 
<code>http.port</code> would default to 8080 if not explicitly supplied.</p>

<p>Some config keys also have a short-form (e.g. <code>httpPort</code> instead of <code>http.port</code> would also work 
in the YAML example above). However, that approach is discouraged as it does not work in all contexts
such as for inheriting configuration from a parent entity.</p>

<h3 id="internalLink_entity-configuration_configuration-in-a-catalog-item">Configuration in a Catalog Item</h3>

<p>When defining an entity in the catalog, it can include configuration values like any other 
blueprint (i.e. inside the <code>brooklyn.config</code> block).</p>

<p>It can also explicitly declare config keys, using the <code>brooklyn.parameters</code> block. The example 
below illustrates the principle:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">brooklyn.catalog</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">items</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity-config-example</span>
    <span class="l-Scalar-Plain">itemType</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity</span>
    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Entity Config Example</span>
    <span class="l-Scalar-Plain">item</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.software.base.VanillaSoftwareProcess</span>
      <span class="l-Scalar-Plain">brooklyn.parameters</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">custom.message</span>
        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">string</span>
        <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Message to be displayed</span>
        <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Hello</span>
      <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">shell.env</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">MESSAGE</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:config(&quot;custom.message&quot;)</span>
        <span class="l-Scalar-Plain">launch.command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
          <span class="no">echo &quot;My example launch command: $MESSAGE&quot;</span>
        <span class="l-Scalar-Plain">checkRunning.command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
          <span class="no">echo &quot;My example checkRunning command: $MESSAGE&quot;</span></code></pre></div>

<p>Once added to the catalog, it can be used with the simple blueprint below (substituting the location
of your choice). Because no configuration has been overridden, this will use the default value
for <code>custom.message</code>, and will use the given values for <code>launch.command</code> and <code>checkRunning.command</code>:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">aws-ec2:us-east-1</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity-config-example</span></code></pre></div>

<p>For details of how to write and add catalog items, see <a href="#contentsLink-catalog">Catalog</a>. </p>

<h4 id="internalLink_entity-configuration_config-key-constraints">Config Key Constraints</h4>

<p>The config keys in the <code>brooklyn.parameters</code> can also have constraints defined, for what values
are valid. If more than one constraint is defined, then they must all be satisfied. The constraints 
can be any of:</p>

<ul>
  <li><code>required</code>: deployment will fail if no value is supplied for this config key.</li>
  <li><code>regex: ...</code>: the value will be compared against the given regular expression.</li>
  <li>A predicate, declared using the DSL <code>$brooklyn:object</code>.  </li>
</ul>

<p>This is illustrated in the example below:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">brooklyn.catalog</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">items</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity-constraint-example</span>
    <span class="l-Scalar-Plain">itemType</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity</span>
    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Entity Config Example</span>
    <span class="l-Scalar-Plain">item</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.stock.BasicEntity</span>
      <span class="l-Scalar-Plain">brooklyn.parameters</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">compulsoryExample</span>
        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">string</span>
        <span class="l-Scalar-Plain">constraints</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">required</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">addressExample</span>
        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">string</span>
        <span class="l-Scalar-Plain">constraints</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">regex</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">numberExample</span>
        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">double</span>
        <span class="l-Scalar-Plain">constraints</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">$brooklyn:object</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.util.math.MathPredicates</span>
            <span class="l-Scalar-Plain">factoryMethod.name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">greaterThan</span>
            <span class="l-Scalar-Plain">factoryMethod.args</span><span class="p-Indicator">:</span>
            <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0.0</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">$brooklyn:object</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.util.math.MathPredicates</span>
            <span class="l-Scalar-Plain">factoryMethod.name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">lessThan</span>
            <span class="l-Scalar-Plain">factoryMethod.args</span><span class="p-Indicator">:</span>
            <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">256.0</span></code></pre></div>

<p>An example usage of this toy example, once added to the catalog, is shown below:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity-constraint-example</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">compulsoryExample</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">foo</span>
    <span class="l-Scalar-Plain">addressExample</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1.1.1.1</span>
    <span class="l-Scalar-Plain">numberExample</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2.0</span></code></pre></div>

<h3 id="internalLink_entity-configuration_inheriting-configuration">Inheriting Configuration</h3>

<p>Configuration can be inherited from a super-type, and from a parent entity in the runtime 
management hierarchy. This applies to entities and locations. In a future release, this will be
extended to also apply to policies and enrichers.</p>

<p>When a blueprint author defines a config key, they can explicitly specify the rules for inheritance 
(both for super/sub-types, and for the runtime management hiearchy). This gives great flexibilty,
but should be used with care so as not to surprise users of the blueprint.</p>

<p>The default behaviour is outlined below, along with examples and details of how to explilcitly 
define the desired behaviour.</p>

<h4 id="internalLink_entity-configuration_normal-configuration-precedence">Normal Configuration Precedence</h4>

<p>There are several places that a configuration value can come from. If different values are 
specified in multiple places, then the order of precedence is as listed below:</p>

<ol>
  <li>Configuration on the entity itself</li>
  <li>Inherited configuration from the super-type</li>
  <li>Inherited configuration from the runtime type hierarchy</li>
  <li>The config key’s default value</li>
</ol>

<h4 id="internalLink_entity-configuration_inheriting-configuration-from-super-type">Inheriting Configuration from Super-type</h4>

<p>When using an entity from the catalog, its configuration values can be overridden. For example,
consider the <code>entity-config-example</code> added to the catalog in the section 
<a href="#internalLink_entity-configuration_configuration-in-a-catalog-item">Configuration in a Catalog Item</a>.
We can override these values. If not overridden, then the existing values from the super-type will be used:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">aws-ec2:us-east-1</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity-config-example</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">custom.message</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Goodbye</span>
    <span class="l-Scalar-Plain">launch.command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
      <span class="no">echo &quot;Sub-type launch command: $MESSAGE&quot;</span></code></pre></div>

<p>In this example, the <code>custom.message</code> overrides the default defined on the config key.
The <code>launch.command</code> overrides the original command. The other config (e.g. <code>checkRunning.command</code>)
is inherited unchanged.</p>

<p>It will write out: <code>Sub-type launch command: Goodbye</code>.</p>

<h4 id="internalLink_entity-configuration_inheriting-configuration-from-a-parent-in-the-runtime-management-hieararchy">Inheriting Configuration from a Parent in the Runtime Management Hieararchy</h4>

<p>Configuration passed to an entity is inherited by all child entities, unless explicitly overridden.</p>

<p>In the example below, the <code>wars.root</code> config key is inherited by all TomcatServer entities created
under the cluster, so they will use that war:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.group.DynamicCluster</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">wars.root</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=org/apache/brooklyn/example/brooklyn-example-hello-world-webapp/0.9.0/brooklyn-example-hello-world-webapp-0.9.0.war</span>
    <span class="l-Scalar-Plain">dynamiccluster.memberspec</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">$brooklyn:entitySpec</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.tomcat.TomcatServer</span></code></pre></div>

<p>In the above example, it would be better to have specified the <code>wars.root</code> configuration in the 
<code>TomcatServer</code> entity spec, rather than at the top level. This would make it clearer for the reader
what is actually being configured.</p>

<p>The technique of inherited config can simplify some blueprints, but care should be taken. 
For more complex (composite) blueprints, this can be difficult to use safely; it relies on 
knowledge of the internals of the child components. For example, the inherited config 
may impact multiple sub-components, rather than just the specific entity to be changed.
This is particularly true when using complex items from the catalog, and when using common config 
values (e.g. <code>install.version</code>).</p>

<p>An alternative approach is to declare the expected configuration options at the top level of the
catalog item, and then (within the catalog item) explicitly inject those values into the correct
sub-components. Users of this catalog item would set only those exposed config options, rather 
than trying to inject config directly into the nested entities.</p>

<h4 id="internalLink_entity-configuration_dsl-evaluation-of-inherited-config">DSL Evaluation of Inherited Config</h4>

<p>When writing blueprints that rely on inheritance from the runtime management hierarchy, it is 
important to  understand how config keys that use DSL will be evaluated. In particular, when 
evaluating a DSL expression, it will be done in the context of the entity declaring the config 
value (rather than on the entity using the config value).</p>

<p>For example, consider the config value <code>$brooklyn:attributeWhenReady("host.name")</code>
declared on entity X, and inherited by child entity Y. If entity Y uses this config value, 
it will get the “host.name” attribute of entity X.</p>

<p>Below is another (contrived!) example of this DSL evaluation. When evaluating <code>refExampleConfig</code>,
it retrievies the value of <code>exampleConfig</code> which is the DSL expression, and evaluates this in the 
context of the parent entity that declares it. Therefore <code>$brooklyn:config("ownConfig")</code> returns 
the parent’s <code>ownConfig</code> value, and the final result for <code>refExampleConfig</code> is set to “parentValue”:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.stock.BasicApplication</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">ownConfig</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">parentValue</span>
    <span class="l-Scalar-Plain">exampleConfig</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:config(&quot;ownConfig&quot;)</span>
  
  <span class="l-Scalar-Plain">brooklyn.children</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.stock.BasicEntity</span>
    <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">ownConfig</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">childValue</span>
      <span class="l-Scalar-Plain">refExampleConfig</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:config(&quot;exampleConfig&quot;)</span></code></pre></div>

<p><em>However, the web-console also shows other misleading (incorrect!) config values for the child 
entity. It shows the inherited config value of <code>exampleConfig</code> as “childValue” (because the
REST api did not evaluate the DSL in the correct context, when retrieving the value! 
See https://issues.apache.org/jira/browse/BROOKLYN-455.</em></p>

<h4 id="internalLink_entity-configuration_merging-configuration-values">Merging Configuration Values</h4>

<p>For some configuration values, the most logical behaviour is to merge the configuration value
with that in the super-type. This depends on the type and meaning of the config key, and is thus 
an option when defining the config key.</p>

<p>Currently it is only supported for merging config keys of type Map.</p>

<p>Some common config keys will default to merging the values from the super-type. These config keys<br />
include those below. The value is merged with that of its super-type (but will not be merged with 
the value on a parent entity):</p>

<ul>
  <li><code>shell.env</code>: a map of environment variables to pass to the runtime shell</li>
  <li><code>files.preinstall</code>: a mapping of files, to be copied before install, to destination name relative to installDir</li>
  <li><code>templates.preinstall</code>: a mapping of templates, to be filled in and copied before pre-install, to destination name relative to installDir </li>
  <li><code>files.install</code>: a mapping of files, to be copied before install, to destination name relative to installDir </li>
  <li><code>templates.install</code>: a mapping of templates, to be filled in and copied before install, to destination name relative to installDir </li>
  <li><code>files.runtime</code>: a mapping of files, to be copied before customisation, to destination name relative to runDir </li>
  <li><code>templates.runtime</code>: a mapping of templates, to be filled in and copied before customisation, to destination name relative to runDir </li>
  <li><code>provisioning.properties</code>: custom properties to be passed in when provisioning a new machine</li>
</ul>

<p>A simple example of merging <code>shell.env</code> is shown below (building on the <code>entity-config-example</code> in 
the section <a href="#internalLink_entity-configuration_configuration-in-a-catalog-item">Configuration in a Catalog Item</a>).
The environment variables will include the <code>MESSAGE</code> 
set in the super-type and the <code>MESSAGE2</code> set here:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">aws-ec2:us-east-1</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity-config-example</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">shell.env</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">MESSAGE2</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Goodbye</span>
    <span class="l-Scalar-Plain">launch.command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
      <span class="no">echo &quot;Different example launch command: $MESSAGE and $MESSAGE2&quot;</span></code></pre></div>

<p>To explicitly remove a value from the super-type’s map (rather than adding to it), a blank entry
can be defined. </p>

<h4 id="internalLink_entity-configuration_entity-provisioningproperties-overriding-and-merging">Entity provisioning.properties: Overriding and Merging</h4>

<p>An entity (which extends <code>SoftwareProcess</code>) can define a map of <code>provisioning.properties</code>. If 
the entity then provisions a location, it passes this map of properties to the location for
obtaining the machine. These properties will override and augment the configuration on the location
itself.</p>

<p>When deploying to a jclouds location, one can specify <code>templateOptions</code> (of type map). Rather than
overriding, these will be merged with any templateOptions defined on the location.</p>

<p>In the example below, the VM will be provisioned with minimum 2G ram and minimum 2 cores. It will 
also use the merged template options value of 
<code>{placementGroup: myPlacementGroup, securityGroupIds: sg-000c3a6a}</code>:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">aws-ec2:us-east-1</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">minRam</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2G</span>
    <span class="l-Scalar-Plain">templateOptions</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">placementGroup</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">myPlacementGroup</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.machine.MachineEntity</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">provisioning.properties</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">minCores</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
      <span class="l-Scalar-Plain">templateOptions</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">securityGroupIds</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sg-000c3a6a</span></code></pre></div>

<p>The merging of <code>templateOptions</code> is shallow (i.e. maps within the <code>templateOptions</code> are not merged). 
In the example below, the <code>userMetadata</code> value within <code>templateOptions</code> will be overridden by the 
entity’s value, rather than the maps being merged; the value used when provisioning will be 
<code>{key2: val2}</code>:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">aws-ec2:us-east-1</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">templateOptions</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">userMetadata</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">key1</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">val1</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.machine.MachineEntity</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">provisioning.properties</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">userMetadata</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">key2</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">val2</span></code></pre></div>

<h4 id="internalLink_entity-configuration_re-inherited-versus-not-re-inherited">Re-inherited Versus not Re-inherited</h4>

<p>For some configuration values, the most logical behaviour is for an entity to “consume” the config
key’s value, and thus not pass it down to children in the runtime type hierarchy. This is called
“not re-inherited”.</p>

<p>Some common config keys that will not re-inherited include:</p>

<ul>
  <li><code>install.command</code> (and the <code>pre.install.command</code> and <code>post.install.command</code>) </li>
  <li><code>customize.command</code> (and the <code>pre.customize.command</code> and <code>post.customize.command</code>)</li>
  <li><code>launch.command</code> (and the ``pre.launch.command<code> and </code>post.launch.command`)</li>
  <li><code>checkRunning.command</code></li>
  <li><code>stop.command</code></li>
  <li>The similar commands for <code>VanillaWindowsProcess</code> powershell.</li>
  <li>The file and template install config keys (e.g. <code>files.preinstall</code>, <code>templates.preinstall</code>, etc)</li>
</ul>

<p>An example is shown below. Here, the “logstash-child” is a sub-type of <code>VanillaSoftwareProcess</code>,
and is co-located on the same VM as Tomcat. We don’t want the Tomcat’s configuration, such as 
<code>install.command</code>, to be inherited by the logstash child. If it was inherited, the logstash-child
entity might re-execute the Tomcat’s install command! Instead, the <code>install.command</code> config is
“consumed” by the Tomcat instance and is not re-inherited:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.tomcat.Tomcat8Server</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">children.startable.mode</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">background_late</span>
  <span class="l-Scalar-Plain">brooklyn.children</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">logstash-child</span>
    <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">logstash.elasticsearch.host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:entity(&quot;es&quot;).attributeWhenReady(&quot;urls.http.withBrackets&quot;)</span>
<span class="nn">...</span></code></pre></div>

<p>“Not re-inherited” differs from “never inherited”. The example below illustrates the difference, 
though this use is discouraged (it is mostly for backwards compatibility). The <code>post.install.command</code>
is not consumed by the <code>BasicApplication</code>, so will be inherited by the <code>Tomcat8Server</code> which will
consume it. The config value will therefore not be inherited by the <code>logstash-child</code>.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.stock.BasicApplication</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">post.install.command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">echo &quot;My post.install command&quot;</span>
  <span class="l-Scalar-Plain">brooklyn.children</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.tomcat.Tomcat8Server</span>
    <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">children.startable.mode</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">background_late</span>
    <span class="l-Scalar-Plain">brooklyn.children</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">logstash-child</span>
      <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">logstash.elasticsearch.host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:entity(&quot;es&quot;).attributeWhenReady(&quot;urls.http.withBrackets&quot;)</span>
<span class="nn">...</span></code></pre></div>

<h4 id="internalLink_entity-configuration_never-inherited">Never Inherited</h4>

<p>For some configuration values, the most logical behaviour is for the value to never be inherited
in the runtime management hiearchy.</p>

<p>Some common config keys that will never inherited include:</p>

<ul>
  <li>
    <p><code>defaultDisplayName</code>: this is the name to use for the entity, if an explicit name is not supplied.
This is particularly useful when adding an entity in a catalog item (so if the user does not give
a name, it will get a sensible default). It would not be intuitive for all the children of that
entity to also get that default name.</p>
  </li>
  <li>
    <p><code>id</code>: the id of an entity (as supplied in the YAML, to allow references to that entity) is not 
inherited. It is the id of that specific entity, so must not be shared by all its children.</p>
  </li>
</ul>

<h4 id="internalLink_entity-configuration_inheritance-modes-deep-dive">Inheritance Modes: Deep Dive</h4>

<p>The javadoc in the code is useful for anyone who wants to go deep! See
<code>org.apache.brooklyn.config.BasicConfigInheritance</code> and <code>org.apache.brooklyn.config.ConfigInheritances</code>
in the repo https://github.com/apache/brooklyn-server.</p>

<p>When defining a new config key, the exact semantics for inheritance can be defined. There are 
separate options to control config inheritance from the super-type, and config inheritance from the
parent in the runtime management hierarchy.</p>

<p>The possible modes are:</p>

<ul>
  <li>
    <p><code>NEVER_INHERITED</code>: indicates that a key’s value should never be inherited (even if defined on 
an entity that does not know the key). Most usages will prefer <code>NOT_REINHERITED</code>.</p>
  </li>
  <li>
    <p><code>NOT_REINHERITED</code>: indicates that a config key value (if used) should not be passed down to
children / sub-types. Unlike <code>NEVER_INHERITED</code>, these values can be passed down if they are not
used by the entity (i.e. if the entity does not expect it). However, when used by a child,
it will not be passed down any further. If the inheritor also defines a value the parent’s 
value is ignored irrespective  (as in <code>OVERWRITE</code>; see <code>NOT_REINHERITED_ELSE_DEEP_MERGE</code> if merging 
is desired).</p>
  </li>
  <li>
    <p><code>NOT_REINHERITED_ELSE_DEEP_MERGE</code>: as <code>NOT_REINHERITED</code> but in cases where a value is inherited 
because a parent did not recognize it, if the inheritor also defines a value the two values should 
be merged.</p>
  </li>
  <li>
    <p><code>OVERWRITE</code>: indicates that if a key has a value at both an ancestor and a descendant, the 
descendant and his descendants will prefer the value at the descendant.</p>
  </li>
  <li>
    <p><code>DEEP_MERGE</code>: indicates that if a key has a value at both an ancestor and a descendant, the 
descendant and his descendants should attempt to merge the values. If the values are not mergable,
behaviour is undefined (and often the descendant’s value will simply overwrite).</p>
  </li>
</ul>

<h4 id="internalLink_entity-configuration_explicit-inheritance-modes">Explicit Inheritance Modes</h4>

<p><em>The YAML support for explicitly defining the inheritance mode is still work-in-progress. The options
documented below will be enhanced in a future version of AMP, to better support the modes described
above.</em></p>

<p>In a YAML blueprint, within the <code>brooklyn.parameters</code> section for declaring new config keys, one can
set the mode for <code>inheritance.type</code> and <code>inheritance.parent</code> (i.e. for inheritance from the super-type, and
inheritance in the runtime management hierarchy). The possible values are:</p>

<ul>
  <li><code>deep_merge</code>: the inherited and the given value should be merged; maps within the map will also be merged</li>
  <li><code>always</code>: the inherited value should be used, unless explicitly overridden by the entity</li>
  <li><code>none</code>: the value should not be inherited; if there is no explicit value on the entity then the default value will be used</li>
</ul>

<p>Below is a (contrived!) example of inheriting the <code>example.map</code> config key. When using this entity
in a blueprint, the entity’s config will be merged with that defined in the super-type, and the 
parent entity’s value will never be inherited:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">brooklyn.catalog</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">items</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity-config-inheritance-example</span>
    <span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&quot;1.1.0-SNAPSHOT&quot;</span>
    <span class="l-Scalar-Plain">itemType</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity</span>
    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Entity Config Inheritance Example</span>
    <span class="l-Scalar-Plain">item</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.machine.MachineEntity</span>
      <span class="l-Scalar-Plain">brooklyn.parameters</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">example.map</span>
        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">java.util.Map</span>
        <span class="l-Scalar-Plain">inheritance.type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">deep_merge</span>
        <span class="l-Scalar-Plain">inheritance.parent</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">none</span>
        <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">MESSAGE_IN_DEFAULT</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">InDefault</span>
      <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">example.map</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">MESSAGE</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Hello</span></code></pre></div>

<p>The blueprints below demonstrate the various permutations for setting configuration for the
config <code>example.map</code>. This can be inspected by looking at the entity’s config. The config
we see for app1 is the inherited <code>{MESSAGE: "Hello"}</code>; in app2 we define additional configuration,
which will be merged to give <code>{MESSAGE: "Hello", MESSAGE_IN_CHILD: "InChild"}</code>; in app3, the 
config from the parent is not inherited because there is an explicit inheritance.parent of “none”,
so it just has the value <code>{MESSAGE: "Hello"}</code>; in app4 again the parent’s config is ignored,
with the super-type and entity’s config being merged to give  <code>{MESSAGE: "Hello", MESSAGE_IN_CHILD: "InChild"}</code>.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">aws-ec2:us-east-1</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.stock.BasicApplication</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">app1</span>
  <span class="l-Scalar-Plain">brooklyn.children</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity-config-inheritance-example</span>

<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.stock.BasicApplication</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">app2</span>
  <span class="l-Scalar-Plain">brooklyn.children</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity-config-inheritance-example</span>
    <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">example.map</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">MESSAGE_IN_CHILD</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">InChild</span>

<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.stock.BasicApplication</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">app3</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">example.map</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">MESSAGE_IN_PARENT</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">InParent</span>
  <span class="l-Scalar-Plain">brooklyn.children</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity-config-inheritance-example</span>

<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.stock.BasicApplication</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">app4</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">example.map</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">MESSAGE_IN_PARENT</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">InParent</span>
  <span class="l-Scalar-Plain">brooklyn.children</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity-config-inheritance-example</span>
    <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">example.map</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">MESSAGE_IN_CHILD</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">InChild</span></code></pre></div>

<p>A limitations of <code>inheritance.parent</code> is when inheriting values from parent and grandparent 
entities: a value specified on the parent will override (rather than be merged with) the
value on the grandparent.</p>

<h4 id="internalLink_entity-configuration_merging-policy-and-enricher-configuration-values">Merging Policy and Enricher Configuration Values</h4>

<p>A current limitation is that sub-type inheritance is not supported for configuration of
policies and enrichers. The current behaviour is that config is not inherited. The concept of
inheritance from the runtime management hierarchy does not apply for policies and enrichers
(they do not have “parents”; they are attached to an entity).</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-setting-locations" class="section-breaker section p-">
	<span style="width: 100%"><h1>Setting Locations</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	
<p>Brooklyn supports a very wide range of target locations. 
With deep integration to <a href="https://jclouds.apache.org">Apache jclouds</a>, most well-known clouds 
and cloud platforms are supported. See the <a href="#contentsLink-locations">Locations guide</a> 
for details and more examples.</p>

<h3 id="internalLink_setting-locations_cloud-example">Cloud Example</h3>

<p>The following example is for Amazon EC2:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">simple-appserver-with-location</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">jclouds:aws-ec2</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">region</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">us-east-1</span>
    <span class="l-Scalar-Plain">identity</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">AKA_YOUR_ACCESS_KEY_ID</span>
    <span class="l-Scalar-Plain">credential</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;access-key-hex-digits&gt;</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.tomcat.Tomcat8Server</span></code></pre></div>

<p>(You’ll need to replace the <code>identity</code> and <code>credential</code> with the 
“Access Key ID” and “Secret Access Key” for your account,
as configured in the <a href="https://console.aws.amazon.com/iam/home?#security_credential">AWS Console</a>.)</p>

<p>Other popular public clouds include <code>softlayer</code>, <code>google-compute-engine</code>, and <code>rackspace-cloudservers-us</code>.
Private cloud systems including <code>openstack-nova</code> and <code>cloudstack</code> are also supported,
although for these you’ll supply an <code>endpoint: https://9.9.9.9:9999/v2.0/</code> 
(or <code>client/api/</code> in the case of CloudStack) instead of the <code>region</code>.</p>

<h3 id="internalLink_setting-locations_bring-your-own-nodes-byon-example">“Bring Your Own Nodes” (BYON) Example</h3>

<p>You can also specify pre-existing servers to use – “bring-your-own-nodes”.
The example below shows a pool of machines that will be used by the entities within the 
application.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">simple-appserver-with-location-byon</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">byon</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn</span>
    <span class="l-Scalar-Plain">privateKeyFile</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~/.ssh/brooklyn.pem</span>
    <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">192.168.0.18</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">192.168.0.19</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.tomcat.Tomcat8Server</span></code></pre></div>

<h3 id="internalLink_setting-locations_single-line-and-multi-line-locations">Single Line and Multi Line Locations</h3>

<p>A simple location can be specified on a single line. Alternatively, it can be split to have one
configuration option per line (recommended for all but the simplest locations).</p>

<p>For example, the two examples below are equivalent:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">byon(name=&quot;my loc&quot;,hosts=&quot;1.2.3.4&quot;,user=&quot;bob&quot;,privateKeyFile=&quot;~/.ssh/bob_id_rsa&quot;)</span></code></pre></div>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">byon</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;my</span><span class="nv"> </span><span class="s">loc&quot;</span>
    <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="s">&quot;1.2.3.4&quot;</span>
    <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="s">&quot;bob&quot;</span>
    <span class="l-Scalar-Plain">privateKeyFile</span><span class="p-Indicator">:</span> <span class="s">&quot;~/.ssh/bob_id_rsa&quot;</span></code></pre></div>

<h3 id="internalLink_setting-locations_specific-locations-for-specific-entities">Specific Locations for Specific Entities</h3>

<p>One can define specific locations on specific entities within the blueprint (instead of, or as 
well as, defining the location at the top-level of the blueprint).</p>

<p>The example below will deploy Tomcat and JBoss App Server to different Bring Your Own Nodes
locations:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">simple-appserver-with-location-per-entity</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.tomcat.Tomcat8Server</span>
  <span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">byon(hosts=&quot;192.168.0.18&quot;,user=&quot;brooklyn&quot;,privateKeyFile=&quot;~/.ssh/brooklyn.pem&quot;)</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.jboss.JBoss7Server</span>
  <span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">byon(hosts=&quot;192.168.0.19&quot;,user=&quot;brooklyn&quot;,privateKeyFile=&quot;~/.ssh/brooklyn.pem&quot;)</span></code></pre></div>

<p>The rules for precedence when defining a location for an entity are:</p>

<ul>
  <li>The location defined on that specific entity.</li>
  <li>If no location is defined, then the first ancestor that defines an explicit location.</li>
  <li>If still no location is defined, then the location defined at the top-level of the blueprint.</li>
</ul>

<p>This means, for example, that if you define an explicit location on a cluster then it will be used 
for all members of that cluster.</p>

<h3 id="internalLink_setting-locations_multiple-locations">Multiple Locations</h3>

<p>Some entities are written to expect a set of locations. For example, a <code>DynamicFabric</code> will
create a member entity in each location that it is given. To supply multiple locations, simply
use <code>locations</code> with a yaml list.</p>

<p>In the example below, it will create a cluster of app-servers in each location. One location is
used for each <code>DynamicCluster</code>; all app-servers inside that cluster will obtain a machine from
that given location.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">fabric-of-app-server-clusters</span>
<span class="l-Scalar-Plain">locations</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">aws-ec2:us-east-1</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">aws-ec2:us-west-1</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.group.DynamicFabric</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">dynamiccluster.memberspec</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">$brooklyn:entitySpec</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.group.DynamicCluster</span>
        <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">cluster.initial.size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
          <span class="l-Scalar-Plain">dynamiccluster.memberspec</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">$brooklyn:entitySpec</span><span class="p-Indicator">:</span>
              <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.tomcat.Tomcat8Server</span></code></pre></div>

<p>The entity hierarchy at runtime will have a <code>DynamicFabric</code> with two children, each of type 
<code>DynamicCluster</code> (each running in different locations), each of which initially has three 
app-servers.</p>

<p>For brevity, this example excludes the credentials for aws-ec2. These could either be specificed
in-line or defined as named locations in the catalog (see below).</p>

<h3 id="internalLink_setting-locations_adding-locations-to-the-catalog">Adding Locations to the Catalog</h3>

<p>The examples above have given all the location details within the application blueprint.
It is also possible (and indeed preferred) to add the location definitions to the catalog
so that they can be referenced by name in any blueprint.</p>

<p>For more information see the <a href="#contentsLink-catalog">Operations: Catalog</a> section of 
the User Guide.</p>

<h3 id="internalLink_setting-locations_externalized-configuration">Externalized Configuration</h3>

<p>For simplicity, the examples above have included the cloud credentials. For a production system, 
it is strongly recommended to use <a href="#contentsLink-externalized-configuration">Externalized Configuration</a>
to retrieve the credentials from a secure credentials store, such as <a href="https://www.vaultproject.io">Vault</a>.</p>

<h3 id="internalLink_setting-locations_use-of-provisioningproperties">Use of provisioning.properties</h3>

<p>An entity that represents a “software process” can use the configuration option 
<code>provisioning.properties</code> to augment the location’s configuration. For more information, see
<a href="#contentsLink-entity-configuration">Entity Configuration</a>
details.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-configuring-vms" class="section-breaker section p-">
	<span style="width: 100%"><h1>Configuring VMs</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Another simple blueprint will just create a VM which you can use, without any software installed upon it:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">simple-vm</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.software.base.EmptySoftwareProcess</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">VM</span>
  <span class="l-Scalar-Plain">provisioning.properties</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">minRam</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8192mb</span>
    <span class="l-Scalar-Plain">minCores</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4</span>
    <span class="l-Scalar-Plain">minDisk</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">100gb</span></code></pre></div>

<p><em>We’ve omitted the <code>location</code> section here and in many of the examples below;
add the appropriate choice when you paste your YAML. Note that the <code>provisioning.properties</code> will be
ignored if deploying to <code>localhost</code> or <code>byon</code> fixed-IP machines.</em> </p>

<p>This will create a VM with the specified parameters in your choice of cloud.
In the GUI (and in the REST API), the entity is called “VM”,
and the hostname and IP address(es) are reported as <a href="#contentsLink-entities">sensors</a>.
There are many more <code>provisioning.properties</code> supported here,
including:</p>

<ul>
  <li>a <code>user</code> to create (if not specified it creates the same username as <code>brooklyn</code> is running under) </li>
  <li>a <code>password</code> for him or a <code>publicKeyFile</code> and <code>privateKeyFile</code> (defaulting to keys in <code>~/.ssh/id_rsa{.pub,}</code> and no password,
so if you have keys set up you can immediately ssh in!)</li>
  <li><code>machineCreateAttempts</code> (for dodgy clouds, and they nearly all fail occasionally!) </li>
  <li>and things like <code>imageId</code> and <code>userMetadata</code> and disk and networking options (e.g. <code>autoAssignFloatingIp</code> for private clouds)</li>
</ul>

<p>For more information, see <a href="#contentsLink-locations">Operations: Locations</a>.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-multiple-services-and-dependency-injection" class="section-breaker section p-">
	<span style="width: 100%"><h1>Multiple Services and Dependency Injection</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>We’ve seen the configuration of machines and how to build up clusters.
Now let’s return to our app-server example and explore how more interesting
services can be configured, composed, and combined.</p>

<h3 id="internalLink_multiple-services-and-dependency-injection_service-configuration">Service Configuration</h3>

<p>We’ll begin by using more key-value pairs to configure the JBoss server to run a real app:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">appserver-configured</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.jboss.JBoss7Server</span>
  <span class="l-Scalar-Plain">war</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=org/apache/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.8.0-incubating/brooklyn-example-hello-world-sql-webapp-0.8.0-incubating.war</span>
  <span class="l-Scalar-Plain">httpPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8080</span></code></pre></div>

<p>(As before, you’ll need to add the <code>location</code> info; <code>localhost</code> will work for these and subsequent examples.)</p>

<p>When this is deployed, you can see management information in the Brooklyn Web Console,
including a link to the deployed application (downloaded to the target machine from the <code>hello-world</code> URL),
running on port 8080.</p>

<p><strong>Tip</strong>:  If port 8080 might be in use, you can specify <code>8080+</code> to take the first available port &gt;= 8080;
the actual port will be reported as a sensor by Brooklyn.</p>

<p>It’s also worth indicating an alternate, more formal syntax.
Not all configuration on entities is supported at the top level of the service specification
(only those which are defined as “flags” in the underlying blueprint,
e.g. the <code>@SetFromFlag("war")</code> in the <code>WebAppServiceConstants</code> parent of <code>JBoss7Server</code>).
All configuration has a formal qualified name, and this can be supplied even where flags or config keys are not
explicitly defined, by placing it into a <code>brooklyn.config</code> section:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">appserver-configured-in-config</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.jboss.JBoss7Server</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">wars.root</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=org/apache/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.8.0-incubating/brooklyn-example-hello-world-sql-webapp-0.8.0-incubating.war</span>
    <span class="l-Scalar-Plain">http.port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8080</span></code></pre></div>

<h3 id="internalLink_multiple-services-and-dependency-injection_multiple-services">Multiple Services</h3>

<p>If you explored the <code>hello-world-sql</code> application we just deployed, 
you’ll have noticed it tries to access a database.
And it fails, because we have not set one up.  Let’s do that now:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">appserver-w-db</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.jboss.JBoss7Server</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">AppServer HelloWorld</span> 
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">wars.root</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=org/apache/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.8.0-incubating/brooklyn-example-hello-world-sql-webapp-0.8.0-incubating.war</span>
    <span class="l-Scalar-Plain">http.port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8080+</span>
    <span class="l-Scalar-Plain">java.sysprops</span><span class="p-Indicator">:</span> 
      <span class="l-Scalar-Plain">brooklyn.example.db.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:formatString(&quot;jdbc:%s%s?user=%s\\&amp;password=%s&quot;,</span>
         <span class="l-Scalar-Plain">component(&quot;db&quot;).attributeWhenReady(&quot;datastore.url&quot;), &quot;visitors&quot;, &quot;brooklyn&quot;, &quot;br00k11n&quot;)</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.database.mysql.MySqlNode</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">db</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">DB HelloWorld Visitors</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">datastore.creation.script.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://github.com/apache/brooklyn-library/raw/master/examples/simple-web-cluster/src/main/resources/visitors-creation-script.sql</span></code></pre></div>

<p>Here there are a few things going on:</p>

<ul>
  <li>We’ve added a second service, which will be the database;
you’ll note the database has been configured to run a custom setup script</li>
  <li>We’ve injected the URL of the second service into the appserver as a Java system property
(so our app knows where to find the database) </li>
</ul>

<p><strong>Caution: Be careful if you write your YAML in an editor which attempts to put “smart-quotes” in.
All quote characters must be plain ASCII, not fancy left-double-quotes and right-double-quotes!</strong></p>

<p>There are as many ways to do dependency injection as there are developers,
it sometimes seems; our aim in Brooklyn is not to say this has to be done one way,
but to support the various mechanisms people might need, for whatever reasons.
(We each have our opinions about what works well, of course;
the one thing we do want to call out is that being able to dynamically update
the injection is useful in a modern agile application – so we are definitively <strong>not</strong>
recommending this Java system property approach … but it is an easy one to demo!)</p>

<p>The way the dependency injection works is again by using the <code>$brooklyn:</code> DSL,
this time referring to the <code>component("db")</code> (looked up by the <code>id</code> field on our DB component),
and then to a sensor emitted by that component.
All the database entities emit a <code>database.url</code> sensor when they are up and running;
the <code>attributeWhenReady</code> DSL method will store a pointer to that sensor (a Java Future under the covers)
in the Java system properties map which the JBoss entity reads at launch time, blocking if needed.</p>

<p>This means that the deployment occurs in parallel, and if the database comes up first,
there is no blocking; but if the JBoss entity completes its installation and 
downloading the WAR, it will wait for the database before it launches.
At that point the URL is injected, first passing it through <code>formatString</code>
to include the credentials for the database (which are defined in the database creation script).</p>

<h3 id="internalLink_multiple-services-and-dependency-injection_an-aside-substitutability">An Aside: Substitutability</h3>

<p>Don’t like JBoss?  Is there something about Maria?
One of the modular principles we follow in Brooklyn is substitutability:
in many cases, the config keys, sensors, and effectors are defined
in superclasses and are portable across multiple implementations.</p>

<p>Here’s an example deploying the same application but with different flavors of the components:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">appserver-w-db-other-flavor</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.tomcat.TomcatServer</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">AppServer HelloWorld</span> 
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">wars.root</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=org/apache/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.8.0-incubating/brooklyn-example-hello-world-sql-webapp-0.8.0-incubating.war</span>
    <span class="l-Scalar-Plain">http.port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8080+</span>
    <span class="l-Scalar-Plain">java.sysprops</span><span class="p-Indicator">:</span> 
      <span class="l-Scalar-Plain">brooklyn.example.db.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:formatString(&quot;jdbc:%s%s?user=%s\\&amp;password=%s&quot;,</span>
         <span class="l-Scalar-Plain">component(&quot;db&quot;).attributeWhenReady(&quot;datastore.url&quot;), &quot;visitors&quot;, &quot;brooklyn&quot;, &quot;br00k11n&quot;)</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.database.mariadb.MariaDbNode</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">db</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">DB HelloWorld Visitors</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">datastore.creation.script.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://github.com/apache/brooklyn-library/raw/master/examples/simple-web-cluster/src/main/resources/visitors-creation-script.sql</span>
    <span class="l-Scalar-Plain">provisioning.properties</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">minRam</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8192</span></code></pre></div>

<p>We’ve also brought in the <code>provisioning.properties</code> from the VM example earlier
so our database has 8GB RAM.
Any of those properties, including <code>imageId</code> and <code>user</code>, can be defined on a per-entity basis.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-custom-entities" class="section-breaker section p-">
	<span style="width: 100%"><h1>Custom Entities</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>So far we’ve covered how to configure and compose entities.
There’s a large library of blueprints available, but
there are also times when you’ll want to write your own.</p>

<p>For complex use cases, you can write JVM, but for many common situations,
some of the highly-configurable blueprints make it easy to write in YAML,
including <code>bash</code> and Chef.</p>

<h3 id="internalLink_custom-entities_vanilla-software-using-bash">Vanilla Software using <code>bash</code></h3>

<p>The following blueprint shows how a simple script can be embedded in the YAML
(the <code>|</code> character is special YAML which makes it easier to insert multi-line text):</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server Example</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.software.base.VanillaSoftwareProcess</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server</span>
  <span class="l-Scalar-Plain">launch.command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
    <span class="no">echo hello | nc -l 4321 &amp;</span>
    <span class="no">echo $! &gt; $PID_FILE</span></code></pre></div>

<p>This starts a simple <code>nc</code> listener on port 4321 which will respond <code>hello</code> to the first
session which connects to it. Test it by running <code>telnet localhost 4321</code>
or opening <code>http://localhost:4321</code> in a browser.</p>

<p>Note that it only allows you connect once, and after that it fails.
This is deliberate! We’ll repair this later in this example.
Until then however, in the <em>Applications</em> view you can click the server,
go to the <code>Effectors</code> tab, and click <code>restart</code> to bring if back to life.  </p>

<p>This is just a simple script, but it shows how any script can be easily embedded here,
including a script to download and run other artifacts.
Many artifacts are already packaged such that they can be downloaded and launched 
with a simple script, and <code>VanillaSoftwareProcess</code> can also be used for them. </p>

<h4 id="internalLink_custom-entities_downloading-files">Downloading Files</h4>

<p>We can specify a <code>download.url</code> which downloads an artifact 
(and automatically unpacking TAR, TGZ, and ZIP archives)
before running <code>launch.command</code> relative to where that file is installed (or unpacked),
with the default <code>launch.command</code> being <code>./start.sh</code>.</p>

<p>So if we create a file <code>/tmp/netcat-server.tgz</code> containing just <code>start.sh</code> in the root
which consists of the two lines in the previous example,
we can instead write our example as: </p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Example From File</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.software.base.VanillaSoftwareProcess</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server</span>
  <span class="l-Scalar-Plain">download.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">file:///tmp/netcat-server.tgz</span></code></pre></div>

<h4 id="internalLink_custom-entities_port-inferencing">Port Inferencing</h4>

<p>If you’re deploying to a cloud machine, a firewall might block the port 4321.
We can tell Brooklyn to open this port explicitly by specifying <code>inboundPorts: [ 4321 ]</code>;
however a more idiomatic way is to specify a config ending with <code>.port</code>,
such as:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Netcat Example with Port Opened</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.software.base.VanillaSoftwareProcess</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server</span>
  <span class="l-Scalar-Plain">launch.command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
    <span class="no">echo hello | nc -l 4321 &amp;</span>
    <span class="no">echo $! &gt; $PID_FILE</span>
    
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="c1"># matching the regex `.*\.port` will cause the port to be opened</span>
    <span class="c1"># if in a cloud where configurable security groups are available</span>
    <span class="l-Scalar-Plain">netcat.port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4321</span></code></pre></div>

<p>The regex for ports to be opened can be configured using
the config <code>inboundPorts.configRegex</code> (which has <code>.*\.port</code> as the default value).</p>

<p>Config keys of type <code>org.apache.brooklyn.api.location.PortRange</code> (aka <code>port</code>)
have special behaviour: when configuring, you can use range notation <code>8000-8100</code> or <code>8000+</code> to tell Brooklyn
to find <strong>one</strong> port matching; this is useful when ports might be in use.
In addition, any such config key will be opened, 
irrespective of whether it matches the <code>inboundPorts.configRegex</code>. 
To prevent any inferencing of ports to open, you can set the config <code>inboundPorts.autoInfer</code> to <code>false</code>.</p>

<p>Furthermore, the port inferencing capability takes in account static <code>ConfigKey</code> fields that
are defined on any Entity sub-class. So, <code>ConfigKey</code> fields that are based on <code>PortRanges</code> type will
be also included as required open ports.</p>

<p>Note that in the example above, <code>netcat.port</code> must be specified in a <code>brooklyn.config</code> block.
This block can be used to hold any config (including for example the <code>launch.command</code>),
but for convenience Brooklyn allows config keys declared on the underlying type
to be specified up one level, alongside the type.
However config keys which are <em>not</em> declared on the type <em>must</em> be declared in the <code>brooklyn.config</code> block. </p>

<h3 id="internalLink_custom-entities_passing-custom-variables">Passing custom variables</h3>

<p>Blueprint scripts can be parametrised through environment variables, making them reusable in different use-cases.
Define the variables in the <code>env</code> block and then reference them using the standard bash notation:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Netcat Example with Environment Vars</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.software.base.VanillaSoftwareProcess</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server</span>
  <span class="l-Scalar-Plain">launch.command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
    <span class="no">echo $MESSAGE | nc -l $NETCAT_PORT &amp;</span>
    <span class="no">echo $! &gt; $PID_FILE</span>
    
  <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">MESSAGE</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hello</span>
    <span class="l-Scalar-Plain">NETCAT_PORT</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4321</span></code></pre></div>

<p>Non-string objects in the <code>env</code> map will be serialized to JSON before passing them to the script.</p>

<h4 id="internalLink_custom-entities_declaring-new-config-keys">Declaring New Config Keys</h4>

<p>We can define config keys to be presented to the user 
using the <code>brooklyn.parameters</code> block:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Netcat Example with Parameter</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.software.base.VanillaSoftwareProcess</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server</span>
  <span class="l-Scalar-Plain">launch.command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
    <span class="no">echo $MESSAGE | nc -l $NETCAT_PORT &amp;</span>
    <span class="no">echo $! &gt; $PID_FILE</span>
    
  <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">MESSAGE</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:config(&quot;message&quot;)</span>
    <span class="l-Scalar-Plain">NETCAT_PORT</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:attributeWhenReady(&quot;netcat.port&quot;)</span>
  
  <span class="l-Scalar-Plain">brooklyn.parameters</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">message</span>
    <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">a message to send to the caller</span>
    <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hello</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">netcat.port</span>
    <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">port</span>
    <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">the port netcat should run on</span>
    <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4321+</span></code></pre></div>

<p>The example above will allow a user to specify a message to send back
and the port where netcat will listen.
The metadata on these parameters is available at runtime in the UI
and through the API, and is used when populating a catalog.</p>

<p>The example also shows how these values can be passed as environment variables to the launch command.
The <code>$brooklyn:config(...)</code> function returns the config value supplied or default.
For the type <code>port</code>, an attribute sensor is also created to report the <em>actual</em> port used after port inference,
and so the <code>$brooklyn:attributeWhenReady(...)</code> function is used.
(If <code>$brooklyn:config("netcat.port")</code> had been used, <code>4321+</code> would be passed as <code>NETCAT_PORT</code>.)</p>

<p>This gives us quite a bit more power in writing our blueprint:</p>

<ul>
  <li>Multiple instances of the server can be launched simultaneously on the same host, 
as the <code>4321+</code> syntax enables Brooklyn to assign them different ports</li>
  <li>If this type is added to the catalog, a user can configure the message and the port;
we’ll show this in the next section</li>
</ul>

<h4 id="internalLink_custom-entities_using-the-catalog-and-clustering">Using the Catalog and Clustering</h4>

<p>The <em>Catalog</em> tab allows you to add blueprints which you can refer to in other blueprints.
In that tab, click <em>+</em> then <em>YAML</em>, and enter the following:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">brooklyn.catalog</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">netcat-example</span>
  <span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&quot;1.0&quot;</span>
  <span class="l-Scalar-Plain">itemType</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity</span>
  <span class="l-Scalar-Plain">item</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.software.base.VanillaSoftwareProcess</span>
    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server</span>

    <span class="l-Scalar-Plain">launch.command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
      <span class="no">echo $MESSAGE | nc -l $NETCAT_PORT &amp;</span>
      <span class="no">echo $! &gt; $PID_FILE</span>
      <span class="no">  </span>
    <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">MESSAGE</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:config(&quot;message&quot;)</span>
      <span class="l-Scalar-Plain">NETCAT_PORT</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:attributeWhenReady(&quot;netcat.port&quot;)</span>
      
    <span class="l-Scalar-Plain">brooklyn.parameters</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">message</span>
      <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">a message to send to the caller</span>
      <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hello</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">netcat.port</span>
      <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">port</span>
      <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">the port netcat should run on</span>
      <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4321+</span>

    <span class="l-Scalar-Plain">brooklyn.enrichers</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.enricher.stock.Transformer</span>
      <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">uniqueTag</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">main-uri-generator</span>
        <span class="l-Scalar-Plain">enricher.sourceSensor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:sensor(&quot;host.address&quot;)</span>
        <span class="l-Scalar-Plain">enricher.targetSensor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:sensor(&quot;main.uri&quot;)</span>
        <span class="l-Scalar-Plain">enricher.targetValue</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">$brooklyn:formatString</span><span class="p-Indicator">:</span>
          <span class="p-Indicator">-</span> <span class="s">&quot;http://%s:%s/&quot;</span>
          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">$brooklyn:attributeWhenReady(&quot;host.address&quot;)</span>
          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">$brooklyn:attributeWhenReady(&quot;netcat.port&quot;)</span></code></pre></div>

<p>This is the same example as in the previous section, wrapped according to the catalog YAML requirements,
with one new block added defining an enricher. An enricher creates a new sensor from other values;
in this case it will create a <code>main.uri</code> sensor by populating a <code>printf</code>-style string <code>"http://%s:%s"</code>
with the sensor values.</p>

<p>With this added to the catalog, we can reference the type <code>netcat-example</code> when we deploy an application.
Return to the <em>Home</em> or <em>Applications</em> tab, click <em>+</em>, and submit this YAML blueprint:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Netcat Type Reference Example</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">netcat-example</span>
  <span class="l-Scalar-Plain">message</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hello from netcat using a registered type</span></code></pre></div>

<p>This extends the previous blueprint which we registered in the catalog,
meaning that we don’t need to include it each time.
Here, we’ve elected to supply our own message, but we’ll use the default port.
More importantly, we can package it for others to consume – or take items others have built.</p>

<p>We can go further and use this to deploy a cluster,
this time giving a custom port as well as a custom message: </p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Netcat Cluster Example</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.group.DynamicCluster</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">dynamiccluster.memberspec</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">$brooklyn:entitySpec</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">netcat-example</span>
        <span class="l-Scalar-Plain">message</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hello from cluster member</span>
        <span class="l-Scalar-Plain">netcat.port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8000+</span>
    <span class="l-Scalar-Plain">cluster.initial.size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
    <span class="l-Scalar-Plain">restartMode</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">parallel</span></code></pre></div>

<p>In either of the above examples, if you explore the tree in the <em>Applications</em> view
and look at the <em>Summary</em> tab of any of the server instances, you’ll now see the URL where netcat is running.
But remember, netcat will stop after one run, so you’ll only be able to use each link once
before you have to restart it.  You can also run <code>restart</code> on the cluster,
and if you haven’t yet experimented with <code>resize</code> on the cluster you might want to do that.</p>

<h4 id="internalLink_custom-entities_determining-successful-launch">Determining Successful Launch</h4>

<p>One requirement of the launch script is that it store the process ID (PID) in the file
pointed to by <code>$PID_FILE</code>, hence the second line of the script.
This is because Brooklyn wants to monitor the services under management.
You’ll observe this if you connect to one of the netcat services,
as the process exits afterwards and Brooklyn sets the entity to an <code>ON_FIRE</code> state.
(You can also test this with a <code>killall nc</code> before connecting
or issueing a <code>stop</code> command on the server – but not on the example,
as stopping an application root causes it to be removed altogether!) </p>

<p>There are other options for determining launch: you can set <code>checkRunning.command</code> and <code>stop.command</code> instead,
as documented on the javadoc and config keys of the <code>VanillaSoftwareProcess</code>
  (<a href="https://github.com/apache/brooklyn-server/tree/master/software/base/src/main/java/org/apache/brooklyn/entity/software/base/VanillaSoftwareProcess.java">src</a>)
 class,
and those scripts will be used instead of checking and stopping the process whose PID is in <code>$PID_FILE</code>.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Netcat Example with Explicit Check and Stop Commands</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.software.base.VanillaSoftwareProcess</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server</span>
  <span class="l-Scalar-Plain">launch.command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
    <span class="no">echo hello | nc -l 4321 &amp;</span>
    <span class="no">echo $! &gt; $PID_FILE</span>

  <span class="c1"># The following overrides demonstrate the use of a custom shell environment as well as</span>
  <span class="c1"># check-running and stop commands. These are optional; default behavior will &quot;do the</span>
  <span class="c1"># right thing&quot; with the pid file automatically.</span>

  <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>                  <span class="p-Indicator">{</span> <span class="nv">CHECK_MARKER</span><span class="p-Indicator">:</span> <span class="s">&quot;checkRunning&quot;</span><span class="p-Indicator">,</span> <span class="nv">STOP_MARKER</span><span class="p-Indicator">:</span> <span class="s">&quot;stop&quot;</span> <span class="p-Indicator">}</span>
  <span class="l-Scalar-Plain">checkRunning.command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">echo $CHECK_MARKER &gt;&gt; DATE &amp;&amp; test -f &quot;$PID_FILE&quot; &amp;&amp; ps -p `cat $PID_FILE` &gt;/dev/null</span>
  <span class="l-Scalar-Plain">stop.command</span><span class="p-Indicator">:</span>         <span class="l-Scalar-Plain">echo $STOP_MARKER  &gt;&gt; DATE &amp;&amp; test -f &quot;$PID_FILE&quot; &amp;&amp; { kill -9 `cat $PID_FILE`; rm /tmp/vanilla.pid; }</span></code></pre></div>

<p>And indeed, once you’ve run one <code>telnet</code> to the server, you’ll see that the 
service has gone “on fire” in Brooklyn – because the <code>nc</code> process stops after one run. </p>

<h4 id="internalLink_custom-entities_attaching-policies">Attaching Policies</h4>

<p>Besides detecting this failure, Brooklyn policies can be added to the YAML to take appropriate 
action. A simple recovery here might just to automatically restart the process:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Netcat Example with Restarter Policy</span>
<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.software.base.VanillaSoftwareProcess</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">netcat-server</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple Netcat Server</span>
  <span class="l-Scalar-Plain">launch.command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
    <span class="no">echo hello | nc -l 4321 &amp;</span>
    <span class="no">echo $! &gt; $PID_FILE</span>
  <span class="l-Scalar-Plain">brooklyn.enrichers</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.policy.ha.ServiceFailureDetector</span>
    <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
      <span class="c1"># wait 15s after service fails before propagating failure</span>
      <span class="l-Scalar-Plain">serviceFailedStabilizationDelay</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">15s</span>
  <span class="l-Scalar-Plain">brooklyn.policies</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.policy.ha.ServiceRestarter</span>
    <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
      <span class="c1"># repeated failures in a time window can cause the restarter to abort,</span>
      <span class="c1"># propagating the failure; a time window of 0 will mean it always restarts!</span>
      <span class="l-Scalar-Plain">failOnRecurringFailuresInThisDuration</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span></code></pre></div>

<p>Autonomic management in Brooklyn often follows the principle that complex behaviours emerge
from composing simple policies.
The blueprint above uses one policy to triggering a failure sensor when the service is down,
and another responds to such failures by restarting the service.
This makes it easy to configure various aspects, such as to delay to see if the service itself recovers
(which here we’ve set to 15 seconds) or to bail out on multiple failures within a time window (which again we are not doing).
Running with this blueprint, you’ll see that the service shows as on fire for 15s after a <code>telnet</code>,
before the policy restarts it. </p>

<h3 id="internalLink_custom-entities_sensors-and-effectors">Sensors and Effectors</h3>

<p>For an even more interesting way to test it, look at the blueprint defining
<a href="http://brooklyn.apache.org/v/0.10.0/v/latest/blueprints/example_yaml/vanilla-bash-netcat-w-client.yaml">a netcat server and client</a>.
This uses <code>initializers</code> to define an effector to <code>sayHiNetcat</code> on the <code>Simple Pinger</code> client,
using <code>env</code> variables to inject the <code>netcat-server</code> location and 
<code>parameters</code> to pass in per-effector data:</p>

<pre><code>  env:
    TARGET_HOSTNAME: $brooklyn:entity("netcat-server").attributeWhenReady("host.name")
  brooklyn.initializers:
  - type: org.apache.brooklyn.core.effector.ssh.SshCommandEffector
    brooklyn.config:
      name: sayHiNetcat
      description: Echo a small hello string to the netcat entity
      command: |
        echo $message | nc $TARGET_HOSTNAME 4321
      parameters:
        message:
          description: The string to pass to netcat
          defaultValue: hi netcat
</code></pre>

<p>This blueprint also uses initializers to define sensors on the <code>netcat-server</code> entity
so that the <code>$message</code> we passed above gets logged and reported back:</p>

<pre><code>  launch.command: |
    echo hello | nc -l 4321 &gt;&gt; server-input &amp;
    echo $! &gt; $PID_FILE
  brooklyn.initializers:
  - type: org.apache.brooklyn.core.sensor.ssh.SshCommandSensor
    brooklyn.config:
      name: output.last
      period: 1s
      command: tail -1 server-input
</code></pre>

<h5 id="internalLink_custom-entities_windows-command-sensor">Windows Command Sensor</h5>

<p>Like the blueprint above, the following example also uses brooklyn.initializers to define sensors on the entity,
this time however it is a windows VM and uses <code>WinRmCommandSensor</code>.</p>

<pre><code>- type: org.apache.brooklyn.entity.software.base.VanillaWindowsProcess
  brooklyn.config:
    launch.command: echo launching
    checkRunning.command: echo running
  brooklyn.initializers:
  - type: org.apache.brooklyn.core.sensor.windows.WinRmCommandSensor
    brooklyn.config:
      name: ip.config
      period: 60s
      command: hostname
</code></pre>

<h4 id="internalLink_custom-entities_summary">Summary</h4>

<p>These examples are relatively simple example, but they
illustrate many of the building blocks used in real-world blueprints,
and how they can often be easily described and combined in Brooklyn YAML blueprints.
Next, if you need to drive off-piste, or you want to write tests against these blueprints,
have a look at, for example, <code>VanillaBashNetcatYamlTest.java</code> in the Brooklyn codebase,
or follow the other references below.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-catalog" class="section-breaker section p-">
	<span style="width: 100%"><h1>Catalog</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Apache Brooklyn provides a <strong>catalog</strong>, which is a persisted collection of versioned blueprints 
and other resources. A set of blueprints is loaded from the <code>default.catalog.bom</code> in the Brooklyn 
folder by default and additional ones can be added through the web console or CLI.  Blueprints in 
the catalog can be deployed directly, via the Brooklyn CLI or the web console, or referenced in 
other blueprints using their <code>id</code>.</p>

<h3 id="internalLink_catalog_catalog-items-yaml-syntax">Catalog Items YAML Syntax</h3>

<p>An item or items to be added to the catalog is defined by a YAML file,
specifying the catalog metadata for the items and the actual blueprint or resource definition.</p>

<h4 id="internalLink_catalog_general-yaml-schema">General YAML Schema</h4>

<p>Catalog items can be defined using the general structure below:</p>

<pre><code class="language-yaml">brooklyn.catalog:
  &lt;catalog-metadata&gt;
  items:
  - &lt;additional-catalog-metadata&gt;
    item:
      &lt;blueprint-or-resource-definition&gt;
  - &lt;additional-catalog-metadata&gt;
    item:
      &lt;blueprint-or-resource-definition&gt;
</code></pre>

<p>Alternatively, a single catalog item can be defined using the following general structure:</p>

<pre><code class="language-yaml">brooklyn.catalog:
  &lt;catalog-metadata&gt;
  item:
    &lt;blueprint-or-resource-definition&gt;
</code></pre>

<p>For example, the YAML below adds to the catalog a Tomcat entity with some additional default 
configuration:</p>

<pre><code class="language-yaml">brooklyn.catalog:
  items:
  - id: tomcat-server
    version: "1.0.0"
    itemType: entity
    item:
      type: org.apache.brooklyn.entity.webapp.tomcat.Tomcat8Server
      brooklyn.config:
        webapp.enabledProtocols: https
        httpsSsl:
          url: classpath://org/apache/brooklyn/entity/webapp/sample-java-keystore.jks
          alias: myname
          password: mypass
</code></pre>

<h4 id="internalLink_catalog_catalog-metadata">Catalog Metadata</h4>

<p>Catalog metadata fields supply the additional information required in order to register an item in the catalog. 
These fields can be supplied as <code>key: value</code> entries 
where either the <code>&lt;catalog-metadata&gt;</code> or <code>&lt;additional-catalog-metadata&gt;</code> placeholders are,
with the latter overriding the former unless otherwise specified below.</p>

<p>The following metadata is <em>required</em> for all items:</p>

<ul>
  <li><code>id</code>: a human-friendly unique identifier for how this catalog item will be referenced from blueprints</li>
  <li><code>version</code>: multiple versions of a blueprint can be installed and used simultaneously;
this field disambiguates between blueprints of the same <code>id</code>.
Note that this is typically <em>not</em> the version of the software being installed,
but rather the version of the blueprint. For more information on versioning, see below.
(Also note YAML treats numbers differently to Strings. Explicit quotes are recommended, to avoid 
<code>1.10</code> being interpretted as the number <code>1.1</code>.)</li>
  <li><code>itemType</code>: the type of the item being defined. The supported item types are:
    <ul>
      <li><code>entity</code></li>
      <li><code>template</code></li>
      <li><code>policy</code></li>
      <li><code>location</code></li>
    </ul>
  </li>
</ul>

<p>To reference a catalog item in another blueprint, simply reference its ID and optionally its version number.
For instance, if we’ve added an item with metadata <code>{ id: datastore, version: "1.0" }</code> (such as the example below),
we could refer to it in another blueprint with: </p>

<pre><code class="language-yaml">services:
- type: datastore:1.0
</code></pre>

<p>In addition to the above fields, exactly <strong>one</strong> of the following is also required:</p>

<ul>
  <li><code>item</code>: the YAML for an entity, or policy, or location specification 
(a map containing <code>type</code> and optional <code>brooklyn.config</code>). For a “template” item, it
should be a map containing <code>services</code> (i.e. the usual YAML format for a full application
blueprint). <strong>Or</strong></li>
  <li><code>items</code>: a list of catalog items, where each entry in the map follows the same schema as
the <code>brooklyn.catalog</code> value, and the keys in these map override any metadata specified as
a sibling of this <code>items</code> key (or, in the case of <code>brooklyn.libraries</code> they add to the list);
if there are references between items, then order is important:
<code>items</code> are processed in order, depth-first, and forward references are not supported. Entries
can be URL to another catalog file to include, inheriting the metadata from the current hierarchy.
Libraries defined so far in the metadata will be used to load classpath entries. For example:</li>
</ul>

<pre><code class="language-yaml">brooklyn.catalog:
  brooklyn.libraries:
  - http://some.server.or.other/path/my.jar
  items:
  - classpath://my-catalog-entries-inside-jar.bom
  - some-property: value
    include: classpath://more-catalog-entries-inside-jar.bom
  - id: use-from-my-catalog
    version: "1.0.0"
    itemType: entity
    item:
      type: some-type-defined-in-my-catalog-entries
      brooklyn.config:
        some.config: "some value"
</code></pre>

<p>The following optional catalog metadata is supported:</p>

<ul>
  <li><code>name</code>: a nicely formatted display name for the item, used when presenting it in a GUI.</li>
  <li><code>description</code>: supplies an extended textual description for the item.</li>
  <li><code>iconUrl</code>: points to an icon for the item, used when presenting it in a GUI.
The URL prefix <code>classpath</code> is supported but these URLs may <em>not</em> refer to resources in any OSGi 
bundle in the <code>brooklyn.libraries</code> section (to prevent requiring all OSGi bundles to be loaded 
at launch). Icons are instead typically installed either at the web server from which the OSGi 
bundles or catalog items are supplied or in the <code>conf</code> folder of the Brooklyn distro.</li>
  <li><code>scanJavaAnnotations</code> [experimental; deprecated]: if provided (as <code>true</code>), this will scan any 
locally provided library URLs for types annotated <code>@Catalog</code> and extract metadata to include 
them as catalog items. If no libraries are specified this will scan the default classpath.
This feature will likely be removed.
Also note that external OSGi dependencies are not supported 
and other metadata (such as versions, etc) may not be applied.</li>
  <li><code>brooklyn.libraries</code>: a list of pointers to OSGi bundles required for the catalog item.
This can be omitted if blueprints are pure YAML and everything required is included in the classpath and catalog.
Where custom Java code or bundled resources is needed, however, OSGi JARs supply
a convenient packaging format and a very powerful versioning format.
Libraries should be supplied in the form 
<code>brooklyn.libraries: [ "http://...", "http://..." ]</code>, 
or as
<code>brooklyn.libraries: [ { name: symbolic-name, version: "1.0", url: http://... }, ... ]</code> if <code>symbolic-name:1.0</code> 
might already be installed from a different URL and you want to skip the download.
Note that these URLs should point at immutable OSGi bundles;
if the contents at any of these URLs changes, the behaviour of the blueprint may change 
whenever a bundle is reloaded in a Brooklyn server,
and if entities have been deployed against that version, their behavior may change in subtle or potentially incompatible ways.
To avoid this situation, it is highly recommended to use OSGi version stamps as part of the URL.</li>
  <li><code>include</code>: A URL to another catalog file to include, inheriting the meta from the current hierarchy.
Libraries defined so far in the meta will be used to load classpath entries. <code>include</code> must be used
when you have sibling properties. If it’s the only property it may be skipped by having the URL as the
value - see <code>items</code> example above.</li>
</ul>

<h4 id="internalLink_catalog_catalog-yaml-examples">Catalog YAML Examples</h4>

<h5 id="internalLink_catalog_a-simple-example">A Simple Example</h5>

<p>The following example installs the <code>RiakNode</code> entity, making it also available as an application template,
with a nice display name, description, and icon.
It can be referred in other blueprints to as <code>datastore:1.0</code>,
and its implementation will be the Java class <code>org.apache.brooklyn.entity.nosql.riak.RiakNode</code> included with Brooklyn.</p>

<pre><code class="language-yaml">brooklyn.catalog:
  id: datastore
  version: "1.0"
  itemType: template
  iconUrl: classpath://org/apache/brooklyn/entity/nosql/riak/riak.png
  name: Datastore (Riak)
  description: Riak is an open-source NoSQL key-value data store.
  item:
    services:
    - type: org.apache.brooklyn.entity.nosql.riak.RiakNode
      name: Riak Node
</code></pre>

<h5 id="internalLink_catalog_multiple-items">Multiple Items</h5>

<p>This YAML will install three items:</p>

<pre><code class="language-yaml">brooklyn.catalog:
  version: "1.1"
  iconUrl: classpath://org/apache/brooklyn/entity/nosql/riak/riak.png
  description: Riak is an open-source NoSQL key-value data store.
  items:
    - id: riak-node
      itemType: entity
      item:
        type: org.apache.brooklyn.entity.nosql.riak.RiakNode
        name: Riak Node
    - id: riak-cluster
      itemType: entity
      item:
        type: org.apache.brooklyn.entity.nosql.riak.RiakCluster
        name: Riak Cluster
    - id: datastore
      name: Datastore (Riak Cluster)
      itemType: template
      item:
        services:
        - type: riak-cluster
          brooklyn.config:
            # the default size is 3 but this can be changed to suit your requirements
            initial.size: 3
            provisioning.properties:
              # you can also define machine specs
              minRam: 8gb
</code></pre>

<p>The items this will add to the catalog are:</p>

<ul>
  <li><code>riak-node</code>, as before, but with a different name</li>
  <li><code>riak-cluster</code> as a convenience short name for the <code>org.apache.brooklyn.entity.nosql.riak.RiakCluster</code> class</li>
  <li><code>datastore</code>, now pointing at the <code>riak-cluster</code> blueprint, in SoftLayer and with the given size and machine spec, 
as the default implementation for anyone
requesting a <code>datastore</code> (and if installed atop the previous example, new references to <code>datastore</code> 
will access this version because it is a higher number);
because it is a template, users will have the opportunity to edit the YAML (see below).
(This must be supplied after <code>riak-cluster</code>, because it refers to <code>riak-cluster</code>.)</li>
</ul>

<h4 id="internalLink_catalog_locations-in-the-catalog">Locations in the Catalog</h4>

<p>In addition to blueprints, locations can be added to the Apache Brooklyn catalog. The example below shows a location for the vagrant configuration used in the <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/start/blueprints.html">getting started guide</a>, formatted as a catalog entry.</p>

<pre><code class="language-yaml">brooklyn.catalog:
  id: vagrant
  version: "1.0"
  itemType: location
  name: Vagrant getting started location
  item:
    type: byon
    brooklyn.config:
      user: vagrant
      password: vagrant
      hosts:
        - 10.10.10.101
        - 10.10.10.102
        - 10.10.10.103
        - 10.10.10.104
</code></pre>

<p>Once this has been added to the catalog it can be used as a named location in yaml blueprints using:</p>

<pre><code class="language-yaml">location: vagrant
</code></pre>

<h4 id="internalLink_catalog_legacy-syntax">Legacy Syntax</h4>

<p>The following legacy and experimental syntax is also supported, but deprecated:</p>

<pre><code class="language-yaml">&lt;blueprint-definition&gt;
brooklyn.catalog:
  &lt;catalog-metadata&gt;
</code></pre>

<p>In this format, the <code>brooklyn.catalog</code> block is optional;
and an <code>id</code> in the <code>&lt;blueprint-definition&gt;</code> will be used to determine the catalog ID. 
This is primarily supplied for OASIS CAMP 1.1 compatibility,
where the same YAML blueprint can be POSTed to the catalog endpoint to add to a catalog
or POSTed to the applications endpoint to deploy an instance.
(This syntax is discouraged as the latter usage, 
POSTing to the applications endpoint,
will ignored the <code>brooklyn.catalog</code> information;
this means references to any <code>item</code> blocks in the <code>&lt;catalog-metadata&gt;</code> will not be resolved,
and any OSGi <code>brooklyn.libraries</code> defined there will not be loaded.)</p>

<h3 id="internalLink_catalog_templates-and-the-add-application-wizard">Templates and the Add-Application Wizard</h3>

<p>A <code>template</code> is a full application. It consists of one or more entities inside an application 
(though this is also composable: it can be used as part of another application).
When a <code>template</code> is added to the catalog, the blueprint will appear in the ‘Create Application’ dialog
as shown here:</p>

<p><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/blueprints/catalog/mysql-in-catalog.png"><img src="./v/latest/blueprints/catalog/mysql-in-catalog-w700.png" alt="MySQL in Brooklyn Catalog" title="MySQL in Brooklyn Catalog" /></a> </p>

<h3 id="internalLink_catalog_catalog-management">Catalog Management</h3>

<p>The Catalog tab in the web console will show all versions of catalog items,
and allow you to add new items.</p>

<h4 id="internalLink_catalog_adding-to-the-catalog">Adding to the Catalog</h4>

<p>On the UI the “add” button <img src="./v/latest/blueprints/catalog/images/add-to-catalog.png" width="24" alt="add-to-catalog" /> at the top of the menu panel allows the
addition of new Applications to the catalog, via YAML, and of new Locations.</p>

<p>In addition to the GUI, items can be added to the catalog via the REST API
with a <code>POST</code> of the YAML file to <code>/v1/catalog</code> endpoint.
To do this using <code>curl</code>:</p>

<pre><code class="language-bash">curl -u admin:password http://127.0.0.1:8081/v1/catalog --data-binary @/path/to/riak.catalog.bom
</code></pre>

<p>Or using the CLI:</p>

<pre><code class="language-bash">br catalog add /path/to/riak.catalog.bom
</code></pre>

<h4 id="internalLink_catalog_deleting-from-the-catalog">Deleting from the Catalog</h4>

<p>On the UI, if an item is selected, a ‘Delete’ button in the detail panel can be used to delete it from the catalog.</p>

<p>Using the REST API, you can delete a versioned item from the catalog using the corresponding endpoint. 
For example, to delete the item with id <code>datastore</code> and version <code>1.0</code> with <code>curl</code>:</p>

<pre><code class="language-bash">curl -u admin:password -X DELETE http://127.0.0.1:8081/v1/catalog/applications/datastore/1.0
</code></pre>

<p><strong>Note:</strong> Catalog items should not be deleted if there are running apps which were created using the same item. 
During rebinding the catalog item is used to reconstruct the entity.</p>

<p>If you have running apps which were created using the item you wish to delete, you should instead deprecate the catalog item.
Deprecated catalog items will not appear in the add application wizard, or in the catalog list but will still
be available to Brooklyn for rebinding. The option to display deprecated catalog items in the catalog list will be added
in a future release.</p>

<p>Deprecation applies to a specific version of a catalog item, so the full
id including the version number is passed to the REST API as follows:</p>

<pre><code class="language-bash">curl -u admin:password -X POST http://127.0.0.1:8081/v1/catalog/entities/MySQL:1.0/deprecated/true
</code></pre>

<h3 id="internalLink_catalog_versioning">Versioning</h3>

<p>Version numbers follow the OSGi convention. This can have a major, minor, micro and qualifier part.
For example, <code>1.0</code>. <code>1.0.1</code> or <code>1.0.1-20150101</code>.</p>

<p>The combination of <code>id:version</code> strings must be unique across the catalog.
It is an error to deploy the same version of an existing item:
to update a blueprint, it is recommended to increase its version number;
alternatively in some cases it is permitted to delete an <code>id:version</code> instance
and then re-deploy.
If no version is specified, re-deploying will automatically
increment an internal version number for the catalog item.</p>

<p>When referencing a blueprint, if a version number is not specified 
the latest non-snapshot version will be loaded when an entity is instantiated.</p>

<h3 id="internalLink_catalog_brooklyn-server-command-line-arguments">Brooklyn Server Command Line Arguments</h3>

<p>The command line arguments when launching <code>brooklyn</code> include several commands for working with the catalog.</p>

<ul>
  <li><code>--catalogAdd &lt;file.bom&gt;</code> will add the catalog items in the <code>bom</code> file</li>
  <li><code>--catalogReset</code> will reset the catalog to the initial state 
(based on <code>brooklyn/default.catalog.bom</code> on the classpath, by default in a dist in the <code>conf/</code> directory)</li>
  <li><code>--catalogInitial &lt;file.bom&gt;</code> will set the catalog items to use on first run,
on a catalog reset, or if persistence is off</li>
</ul>

<p>If <code>--catalogInitial</code> is not specified, the default initial catalog at <code>brooklyn/default.catalog.bom</code> will be used.
As <code>scanJavaAnnotations: true</code> is set in <code>default.catalog.bom</code>, Brooklyn will scan the classpath for catalog items,
which will be added to the catalog.
To launch Brooklyn without initializing the catalog, use <code>--catalogInitial classpath://brooklyn/empty.catalog.bom</code></p>

<p>If <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/blueprints/catalog/../../ops/persistence/index.html">persistence</a> is enabled, catalog additions will remain between runs. If items that were
previously added based on items in <code>brooklyn/default.catalog.bom</code> or <code>--catalogInitial</code> are 
deleted, they will not be re-added on subsequent restarts of brooklyn. I.e. <code>--catalogInitial</code> is ignored
if persistence is enabled and persistent state has already been created.</p>

<p>For more information on these commands, run <code>brooklyn help launch</code>.</p>

<!--
TODO: make test cases from the code snippets here, and when building the docs assert that they match test cases
-->

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-clusters,-specs,-and-composition" class="section-breaker section p-">
	<span style="width: 100%"><h1>Clusters, Specs, and Composition</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>What if you want multiple machines?</p>

<p>One way is just to repeat the <code>- type: org.apache.brooklyn.entity.software.base.EmptySoftwareProcess</code> block,
but there’s another way which will keep your powder <a href="http://en.wikipedia.org/wiki/Don't_repeat_yourself">DRY</a>:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">cluster-vm</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.group.DynamicCluster</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">cluster.initial.size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
    <span class="l-Scalar-Plain">dynamiccluster.memberspec</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">$brooklyn:entitySpec</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.software.base.EmptySoftwareProcess</span>
        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">VM</span>
        <span class="l-Scalar-Plain">provisioning.properties</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">minRam</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8g</span>
          <span class="l-Scalar-Plain">minCores</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4</span>
          <span class="l-Scalar-Plain">minDisk</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">100g</span></code></pre></div>

<p>Here we’ve composed the previous blueprint introducing some new important concepts, the <code>DynamicCluster</code>
the <code>$brooklyn</code> DSL, and the “entity-spec”.  Let’s unpack these. </p>

<p>The <code>DynamicCluster</code> creates a set of homogeneous instances.
At design-time, you specify an initial size and the specification for the entity it should create.
At runtime you can restart and stop these instances as a group (on the <code>DynamicCluster</code>) or refer to them
individually. You can resize the cluster, attach enrichers which aggregate sensors across the cluster, 
and attach policies which, for example, replace failed members or resize the cluster dynamically.</p>

<p>The specification is defined in the <code>dynamiccluster.memberspec</code> key.  As you can see it looks very much like the
previous blueprint, with one extra line.  Entries in the blueprint which start with <code>$brooklyn:</code>
refer to the Brooklyn DSL and allow a small amount of logic to be embedded
(if there’s a lot of logic, it’s recommended to write a blueprint YAML plugin or write the blueprint itself
as a plugin, in Java or a JVM-supported language).  </p>

<p>In this case we want to indicate that the parameter to <code>dynamiccluster.memberspec</code> is an entity specification
(<code>EntitySpec</code> in the underlying type system); the <code>entitySpec</code> DSL command will do this for us.
The example above thus gives us 5 VMs identical to the one we created in the previous section.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-enrichers" class="section-breaker section p-">
	<span style="width: 100%"><h1>Enrichers</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Enrichers provide advanced manipulation of an entity’s sensor values.
See below for documentation of the stock enrichers available in Apache Brooklyn.</p>

<h4 id="internalLink_enrichers_transformer">Transformer</h4>

<p><a href="https://brooklyn.apache.org/v/latest/misc/javadoc/org/apache/brooklyn/enricher/stock/Transformer.html"><code>org.apache.brooklyn.enricher.stock.Transformer</code></a></p>

<p>Takes a source sensor and modifies it in some way before publishing the result in a new sensor. See below an example using <code>$brooklyn:formatString</code>.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">brooklyn.enrichers</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.enricher.stock.Transformer</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">enricher.sourceSensor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:sensor(&quot;urls.tcp.string&quot;)</span>
    <span class="l-Scalar-Plain">enricher.targetSensor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:sensor(&quot;urls.tcp.withBrackets&quot;)</span>
    <span class="l-Scalar-Plain">enricher.targetValue</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:formatString(&quot;[%s]&quot;, $brooklyn:attributeWhenReady(&quot;urls.tcp.string&quot;))</span></code></pre></div>

<h4 id="internalLink_enrichers_propagator">Propagator</h4>

<p><a href="https://brooklyn.apache.org/v/latest/misc/javadoc/org/apache/brooklyn/enricher/stock/Propagator.html"><code>org.apache.brooklyn.enricher.stock.Propagator</code></a></p>

<p>Use propagator to duplicate one sensor as another, giving the supplied sensor mapping.
The other use of Propagator is where you specify a producer (using <code>$brooklyn:entity(...)</code> as below)
from which to take sensors; in that mode you can specify <code>propagate</code> as a list of sensors whose names are unchanged, instead of (or in addition to) this map.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">brooklyn.enrichers</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.enricher.stock.Propagator</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">producer</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:entity(&quot;cluster&quot;)</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.enricher.stock.Propagator</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">sensorMapping</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">$brooklyn:sensor(&quot;url&quot;)</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:sensor(&quot;org.apache.brooklyn.core.entity.Attributes&quot;, &quot;main.uri&quot;)</span></code></pre></div>

<h4 id="internalLink_enrichers_custom-aggregating">Custom Aggregating</h4>

<p><a href="https://brooklyn.apache.org/v/latest/misc/javadoc/org/apache/brooklyn/enricher/stock/Aggregator.html"><code>org.apache.brooklyn.enricher.stock.Aggregator</code></a></p>

<p>Aggregates multiple sensor values (usually across a tier, esp. a cluster) and performs a supplied aggregation method to them to return an aggregate figure, e.g. sum, mean, median, etc.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">brooklyn.enrichers</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.enricher.stock.Aggregator</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">enricher.sourceSensor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:sensor(&quot;webapp.reqs.perSec.windowed&quot;)</span>
    <span class="l-Scalar-Plain">enricher.targetSensor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:sensor(&quot;webapp.reqs.perSec.perNode&quot;)</span>
    <span class="l-Scalar-Plain">enricher.aggregating.fromMembers</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
    <span class="l-Scalar-Plain">transformation</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">average</span></code></pre></div>

<p>There are a number of additional configuration keys available for the Aggregators:</p>

<table>
  <thead>
    <tr>
      <th>Configuration Key</th>
      <th>Default</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>enricher.transformation.untyped</td>
      <td>list</td>
      <td>Specifies a transformation, as a function from a collection to the value, or as a string matching a pre-defined named transformation, such as ‘average’ (for numbers), ‘sum’ (for numbers), ‘isQuorate’ (to compute a quorum), or ‘list’ (the default, putting any collection of items into a list)</td>
    </tr>
    <tr>
      <td>quorum.check.type</td>
      <td> </td>
      <td>The requirement to be considered quorate – possible values: ‘all’, ‘allAndAtLeastOne’, ‘atLeastOne’, ‘atLeastOneUnlessEmpty’, ‘alwaysHealthy’”, “allAndAtLeastOne”</td>
    </tr>
    <tr>
      <td>quorum.total.size</td>
      <td>1</td>
      <td>The total size to consider when determining if quorate</td>
    </tr>
  </tbody>
</table>

<h4 id="internalLink_enrichers_joiner">Joiner</h4>

<p><a href="https://brooklyn.apache.org/v/latest/misc/javadoc/org/apache/brooklyn/enricher/stock/Joiner.html"><code>org.apache.brooklyn.enricher.stock.Joiner</code></a></p>

<p>Joins a sensor whose output is a list into a single item joined by a separator.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">brooklyn.enrichers</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.enricher.stock.Joiner</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">enricher.sourceSensor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:sensor(&quot;urls.tcp.list&quot;)</span>
    <span class="l-Scalar-Plain">enricher.targetSensor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:sensor(&quot;urls.tcp.string&quot;)</span>
    <span class="l-Scalar-Plain">uniqueTag</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">urls.quoted.string</span></code></pre></div>

<p>There are a number of additional configuration keys available for the joiner:</p>

<table>
  <thead>
    <tr>
      <th>Configuration Key</th>
      <th>Default</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>enricher.joiner.separator</td>
      <td>,</td>
      <td>Separator string to insert between each argument</td>
    </tr>
    <tr>
      <td>enricher.joiner.keyValueSeparator</td>
      <td>=</td>
      <td>Separator string to insert between each key-value pair</td>
    </tr>
    <tr>
      <td>enricher.joiner.joinMapEntries</td>
      <td>false</td>
      <td>Whether to add map entries as key-value pairs or just use the value</td>
    </tr>
    <tr>
      <td>enricher.joiner.quote</td>
      <td>true</td>
      <td>Whether to bash-escape each parameter and wrap in double-quotes</td>
    </tr>
    <tr>
      <td>enricher.joiner.minimum</td>
      <td>0</td>
      <td>Minimum number of elements to join; if fewer than this, sets null</td>
    </tr>
    <tr>
      <td>enricher.joiner.maximum</td>
      <td>null</td>
      <td>Maximum number of elements to join (null means all elements taken)</td>
    </tr>
  </tbody>
</table>

<h4 id="internalLink_enrichers_delta-enricher">Delta Enricher</h4>

<p><a href="https://brooklyn.apache.org/v/latest/misc/javadoc/org/apache/brooklyn/policy/enricher/DeltaEnricher.html"><code>org.apache.brooklyn.policy.enricher.DeltaEnricher</code></a></p>

<p>Converts an absolute sensor into a delta sensor (i.e. the difference between the current and previous value)</p>

<h4 id="internalLink_enrichers_time-weighted-delta">Time-weighted Delta</h4>

<p><a href="https://brooklyn.apache.org/v/latest/misc/javadoc/org/apache/brooklyn/enricher/stock/YamlTimeWeightedDeltaEnricher.html"><code>org.apache.brooklyn.enricher.stock.YamlTimeWeightedDeltaEnricher</code></a></p>

<p>Converts absolute sensor values into a difference over time. The <code>enricher.delta.period</code> indicates the measurement interval.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">brooklyn.enrichers</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.enricher.stock.YamlTimeWeightedDeltaEnricher</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">enricher.sourceSensor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">reqs.count</span>
    <span class="l-Scalar-Plain">enricher.targetSensor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">reqs.per_sec</span>
    <span class="l-Scalar-Plain">enricher.delta.period</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1s</span></code></pre></div>

<h4 id="internalLink_enrichers_rolling-mean">Rolling Mean</h4>

<p><a href="https://brooklyn.apache.org/v/latest/misc/javadoc/org/apache/brooklyn/policy/enricher/RollingMeanEnricher.html"><code>org.apache.brooklyn.policy.enricher.RollingMeanEnricher</code></a></p>

<p>Transforms a sensor into a rolling average based on a fixed window size. This is useful for smoothing sample type metrics, such as latency or CPU time</p>

<h4 id="internalLink_enrichers_rolling-time-window-mean">Rolling Time-window Mean</h4>

<p><a href="https://brooklyn.apache.org/v/latest/misc/javadoc/org/apache/brooklyn/policy/enricher/RollingTimeWindowMeanEnricher.html"><code>org.apache.brooklyn.policy.enricher.RollingTimeWindowMeanEnricher</code></a></p>

<p>Transforms a sensor’s data into a rolling average based on a time window. This time window can be specified with the config key <code>confidenceRequired</code> - Minimum confidence level (ie period covered) required to publish a rolling average (default <code>8d</code>).</p>

<h4 id="internalLink_enrichers_http-latency-detector">Http Latency Detector</h4>

<p><a href="https://brooklyn.apache.org/v/latest/misc/javadoc/org/apache/brooklyn/policy/enricher/HttpLatencyDetector.html"><code>org.apache.brooklyn.policy.enricher.RollingTimeWindowMeanEnricher.HttpLatencyDetector</code></a></p>

<p>An Enricher which computes latency in accessing a URL, normally by periodically polling that URL. This is then published in the sensors <code>web.request.latency.last</code> and <code>web.request.latency.windowed</code>.</p>

<p>There are a number of additional configuration keys available for the Http Latency Detector:</p>

<table>
  <thead>
    <tr>
      <th>Configuration Key</th>
      <th>Default</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>latencyDetector.url</td>
      <td> </td>
      <td>The URL to compute the latency of</td>
    </tr>
    <tr>
      <td>latencyDetector.urlSensor</td>
      <td> </td>
      <td>A sensor containing the URL to compute the latency of</td>
    </tr>
    <tr>
      <td>latencyDetector.urlPostProcessing</td>
      <td> </td>
      <td>Function applied to the urlSensor value, to determine the URL to use</td>
    </tr>
    <tr>
      <td>latencyDetector.rollup</td>
      <td> </td>
      <td>The window size (in duration) over which to compute</td>
    </tr>
    <tr>
      <td>latencyDetector.requireServiceUp</td>
      <td>false</td>
      <td>Require the service is up</td>
    </tr>
    <tr>
      <td>latencyDetector.period</td>
      <td>1s</td>
      <td>The period of polling</td>
    </tr>
  </tbody>
</table>

<h4 id="internalLink_enrichers_combiner">Combiner</h4>

<p><a href="https://brooklyn.apache.org/v/latest/misc/javadoc/org/apache/brooklyn/enricher/stock/Combiner.html"><code>org.apache.brooklyn.enricher.stock.Combiner</code></a></p>

<p>Can be used to combine the values of sensors.  This enricher should be instantiated using <code>Enrichers.builder().combining(..)</code>.
This enricher is only available in Java blueprints and cannot be used in YAML.</p>

<h4 id="internalLink_enrichers_note-on-enricher-producers">Note On Enricher Producers</h4>

<p>If an entity needs an enricher whose source sensor (<code>enricher.sourceSensor</code>) belongs to another entity, then the enricher
configuration must include an <code>enricher.producer</code> key referring to the other entity.</p>

<p>For example, if we consider the Transfomer from above, suppose that <code>enricher.sourceSensor: $brooklyn:sensor("urls.tcp.list")</code>
is actually a sensor on a different entity called <code>load.balancer</code>. In this case, we would need to supply an
<code>enricher.producer</code> value.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">brooklyn.enrichers</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.enricher.stock.Transformer</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">enricher.producer</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:entity(&quot;load.balancer&quot;)</span>
    <span class="l-Scalar-Plain">enricher.sourceSensor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:sensor(&quot;urls.tcp.string&quot;)</span>
    <span class="l-Scalar-Plain">enricher.targetSensor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:sensor(&quot;urls.tcp.withBrackets&quot;)</span>
    <span class="l-Scalar-Plain">enricher.targetValue</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
      <span class="no">$brooklyn:formatString(&quot;[%s]&quot;, $brooklyn:attributeWhenReady(&quot;urls.tcp.string&quot;))</span></code></pre></div>

<p>It is important to note that the value supplied to <code>enricher.producer</code> must be immediately resolvable. While it would be valid
DSL syntax to write:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">enricher.producer</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn:entity($brooklyn:attributeWhenReady(&quot;load.balancer.entity&quot;))</span></code></pre></div>

<p>(assuming the <code>load.balancer.entity</code> sensor returns a Brooklyn entity), this will not function properly because <code>enricher.producer</code>
will unsuccessfully attempt to get the supplied entity immediately.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-policies" class="section-breaker section p-">
	<span style="width: 100%"><h1>Policies</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Policies perform the active management enabled by Brooklyn.
They can subscribe to entity sensors and be triggered by them (or they can run periodically,
or be triggered by external systems).</p>

<!---
TODO, clarify below, members of what?
-->
<p>Policies can add subscriptions to sensors on any entity. Normally a policy will subscribe to its
associated entity, to the child entities, and/or to the members of a “group” entity.</p>

<p>Common uses of a policy include the following:</p>

<ul>
  <li>perform calculations,</li>
  <li>look up other values,</li>
  <li>invoke effectors  (management policies) or,</li>
  <li>cause the entity associated with the policy to emit sensor values (enricher policies).</li>
</ul>

<p>Entities can have zero or more <code>Policy</code> instances attached to them.</p>

<h2 id="internalLink_policies_off-the-shelf-policies">Off-the-Shelf Policies</h2>

<p>Policies are highly reusable as their inputs, thresholds and targets are customizable.</p>

<h3 id="internalLink_policies_management-policies">Management Policies</h3>

<h4 id="internalLink_policies_autoscaler-policy">AutoScaler Policy</h4>

<ul>
  <li>org.apache.brooklyn.policy.autoscaling.AutoScalerPolicy</li>
</ul>

<p>Increases or decreases the size of a Resizable entity based on an aggregate sensor value, the current size of the entity, and customized high/low watermarks.</p>

<p>An AutoScaler policy can take any sensor as a metric, have its watermarks tuned live, and target any resizable entity - be it an application server managing how many instances it handles, or a tier managing global capacity.</p>

<p>e.g. if the average request per second across a cluster of Tomcat servers goes over the high watermark, it will resize the cluster to bring the average back to within the watermarks.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">brooklyn.policies</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.policy.autoscaling.AutoScalerPolicy</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">metric</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">webapp.reqs.perSec.perNode</span>
    <span class="l-Scalar-Plain">metricUpperBound</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
    <span class="l-Scalar-Plain">metricLowerBound</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
    <span class="l-Scalar-Plain">resizeUpStabilizationDelay</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2s</span>
    <span class="l-Scalar-Plain">resizeDownStabilizationDelay</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1m</span>
    <span class="l-Scalar-Plain">maxPoolSize</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span></code></pre></div>

<h4 id="internalLink_policies_servicerestarter">ServiceRestarter</h4>

<ul>
  <li>org.apache.brooklyn.policy.ha.ServiceRestarter</li>
</ul>

<p>Attaches to a SoftwareProcess (or anything Startable, emitting ENTITY_FAILED or other configurable sensor), and invokes restart on failure; if there is a subsequent failure within a configurable time interval, or if the restart fails, this gives up and emits {@link #ENTITY_RESTART_FAILED}</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">brooklyn.policies</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.policy.ha.ServiceRestarter</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">failOnRecurringFailuresInThisDuration</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5m</span></code></pre></div>

<h4 id="internalLink_policies_stopafterduration-policy">StopAfterDuration Policy</h4>

<ul>
  <li>org.apache.brooklyn.policy.action.StopAfterDurationPolicy</li>
</ul>

<p>The StopAfterDurationPolicy can be used to limit the lifetime of an entity.  After a configure time period expires the entity will be stopped.</p>

<h4 id="internalLink_policies_createuser-policy">CreateUser Policy</h4>

<ul>
  <li>org.apache.brooklyn.policy.jclouds.os.CreateUserPolicy</li>
</ul>

<p>The CreateUserPolicy Attaches to an Entity and monitors for the addition of a location to that entity, the policy then adds a new user to the VM with a randomly generated password, with the SSH connection details set on the entity as the createuser.vm.user.credentials sensor.</p>

<h4 id="internalLink_policies_advertisewinrmlogin-policy">AdvertiseWinRMLogin Policy</h4>

<ul>
  <li>org.apache.brooklyn.location.winrm.WinRmMachineLocation</li>
</ul>

<p>This is similar to the CreateUserPolicy.  It will monitor the addition of WinRmMachineLocation to an entity and then create a sensor advertising the administrative user’s credentials.</p>

<h4 id="internalLink_policies_sshmachinefailuredetector">SshMachineFailureDetector</h4>

<ul>
  <li>org.apache.brooklyn.policy.ha.SshMachineFailureDetector</li>
</ul>

<p>The SshMachineFailureDetector is an HA policy for monitoring an SshMachine, emitting an event if the connection is lost/restored.</p>

<h4 id="internalLink_policies_connectionfailuredetector">ConnectionFailureDetector</h4>

<ul>
  <li>org.apache.brooklyn.policy.ha.ConnectionFailureDetector</li>
</ul>

<p>The ConnectionFailureDetector is an HA policy for monitoring an http connection, emitting an event if the connection is lost/restored.</p>

<h4 id="internalLink_policies_servicereplacer">ServiceReplacer</h4>

<ul>
  <li>org.apache.brooklyn.policy.ha.ServiceReplacer</li>
</ul>

<p>The ServiceReplacer attaches to a DynamicCluster and replaces a failed member in response to HASensors.ENTITY_FAILED or other sensor.  The <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/blueprints/../index.html">introduction to policies</a> shows a worked example of the ServiceReplacer policy in user.</p>

<h4 id="internalLink_policies_followthesun-policy">FollowTheSun Policy</h4>

<ul>
  <li>org.apache.brooklyn.policy.followthesun.FollowTheSunPolicy</li>
</ul>

<p>The FollowTheSunPolicy is for moving work around to follow the demand.  The work can be any Movable entity.  This currently available in yaml blueprints.</p>

<h4 id="internalLink_policies_conditionalsuspend-policy">ConditionalSuspend Policy</h4>

<ul>
  <li>org.apache.brooklyn.policy.ha.ConditionalSuspendPolicy</li>
</ul>

<p>The ConditionalSuspendPolicy will suspend and resume a target policy based on configured suspend and resume sensors.</p>

<h4 id="internalLink_policies_loadbalancing-policy">LoadBalancing Policy</h4>

<ul>
  <li>org.apache.brooklyn.policy.loadbalancing.LoadBalancingPolicy</li>
</ul>

<p>The LoadBalancingPolicy is attached to a pool of “containers”, each of which can host one or more migratable “items”.  The policy monitors the workrates of the items and effects migrations in an attempt to ensure that the containers are all sufficiently utilized without any of them being overloaded.</p>

<h2 id="internalLink_policies_writing-a-policy">Writing a Policy</h2>

<h3 id="internalLink_policies_your-first-policy">Your First Policy</h3>

<p>Policies perform the active management enabled by Brooklyn.
Each policy instance is associated with an entity,
and at runtime it will typically subscribe to sensors on that entity or children,
performing some computation and optionally actions when a subscribed sensor event occurs.
This action might be invoking an effector or emitting a new sensor,
depending the desired behavior is.</p>

<p>Writing a policy is straightforward.
Simply extend <a href="https://brooklyn.apache.org/v/latest/misc/javadoc/org/apache/brooklyn/core/policy/AbstractPolicy.html"><code>AbstractPolicy</code></a>,
overriding the <a href="https://brooklyn.apache.org/v/latest/misc/javadoc/org/apache/brooklyn/core/objs/AbstractEntityAdjunct.html#setEntity-org.apache.brooklyn.api.entity.EntityLocal-"><code>setEntity</code></a> method to supply any subscriptions desired:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEntity</span><span class="o">(</span><span class="n">EntityLocal</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">setEntity</span><span class="o">(</span><span class="n">entity</span><span class="o">)</span>
        <span class="n">subscribe</span><span class="o">(</span><span class="n">entity</span><span class="o">,</span> <span class="n">TARGET_SENSOR</span><span class="o">,</span> <span class="k">this</span><span class="o">)</span>
    <span class="o">}</span></code></pre></div>

<p>and supply the computation and/or activity desired whenever that event occurs:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onEvent</span><span class="o">(</span><span class="n">SensorEvent</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">val</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
            <span class="n">entity</span><span class="o">.</span><span class="na">sayYoureOdd</span><span class="o">();</span>
    <span class="o">}</span></code></pre></div>

<p>You’ll want to do more complicated things, no doubt,
like access other entities, perform multiple subscriptions,
and emit other sensors – and you can.
See the best practices below and source code for some commonly used policies and enrichers,
such as <code>AutoScalerPolicy</code> and <code>RollingMeanEnricher</code>.</p>

<p>One rule of thumb, to close on:
try to keep policies simple, and compose them together at runtime;
for instance, if a complex computation triggers an action,
define one <strong>enricher</strong> policy to aggregate other sensors and emit a new sensor,
then write a second policy to perform that action.</p>

<h3 id="internalLink_policies_best-practice">Best Practice</h3>

<p>The following recommendations should be considered when designing policies:</p>

<h4 id="internalLink_policies_management-should-take-place-as-low-as-possible-in-the-hierarchy">Management should take place as “low” as possible in the hierarchy</h4>
<ul>
  <li>
    <p>place management responsibility in policies at the entity, as much as possible ideally management should take run as a policy on the relevant entity</p>
  </li>
  <li>
    <p>place escalated management responsibility at the parent entity. Where this is impractical, perhaps because two aspects of an entity are best handled in two different places, ensure that the separation of responsibilities is documented and there is a group membership relationship between secondary/aspect managers.</p>
  </li>
</ul>

<h4 id="internalLink_policies_policies-should-be-small-and-composable">Policies should be small and composable</h4>

<p>e.g. one policy which takes a sensor and emits a different, enriched sensor, and a second policy which responds to the enriched sensor of the first     (e.g. a policy detects a process is maxed out and emits a TOO_HOT sensor; a second policy responds to this by scaling up the VM where it is running, requesting more CPU)</p>

<h4 id="internalLink_policies_where-a-policy-cannot-resolve-a-situation-at-an-entity-the-issue-should-be-escalated-to-a-manager-with-a-compatible-policy">Where a policy cannot resolve a situation at an entity, the issue should be escalated to a manager with a compatible policy.</h4>

<p>Typically escalation will go to the entity parent, and then cascade up.
e.g. if the earlier VM CPU cannot be increased, the TOO_HOT event may go to the parent, a cluster entity, which attempts to balance. If the cluster cannot balance, then to another policy which attempts to scale out the cluster, and should the cluster be unable to scale, to a third policy which emits TOO_HOT for the cluster.</p>

<h4 id="internalLink_policies_management-escalation-should-be-carefully-designed-so-that-policies-are-not-incompatible">Management escalation should be carefully designed so that policies are not incompatible</h4>

<p>Order policies carefully, and mark sensors as “handled” (or potentially “swallow” them locally), so that subsequent policies and parent entities do not take superfluous (or contradictory) corrective action.</p>

<h3 id="internalLink_policies_implementation-classes">Implementation Classes</h3>

<p>Extend <a href="https://brooklyn.apache.org/v/latest/misc/javadoc/org/apache/brooklyn/core/policy/AbstractPolicy.html"><code>AbstractPolicy</code></a>, or override an existing policy.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-clusters-and-policies" class="section-breaker section p-">
	<span style="width: 100%"><h1>Clusters and Policies</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Now let’s bring the concept of the “cluster” back in.
We could wrap our appserver in the same <code>DynamicCluster</code> we used earlier,
although then we’d need to define and configure the load balancer.
But another blueprint, the <code>ControlledDynamicWebAppCluster</code>, does this for us.
It takes the same <code>dynamiccluster.memberspec</code>, so we can build a fully functional elastic 3-tier
deployment of our <code>hello-world-sql</code> application as follows:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">appserver-clustered-w-db</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.ControlledDynamicWebAppCluster</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">cluster.initial.size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
    <span class="l-Scalar-Plain">dynamiccluster.memberspec</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">$brooklyn:entitySpec</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.jboss.JBoss7Server</span>
        <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">wars.root</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=org/apache/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.8.0-incubating/brooklyn-example-hello-world-sql-webapp-0.8.0-incubating.war</span>
          <span class="l-Scalar-Plain">http.port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8080+</span>
          <span class="l-Scalar-Plain">java.sysprops</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">brooklyn.example.db.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:formatString(&quot;jdbc:%s%s?user=%s\\&amp;password=%s&quot;,</span>
                <span class="l-Scalar-Plain">component(&quot;db&quot;).attributeWhenReady(&quot;datastore.url&quot;), &quot;visitors&quot;, &quot;brooklyn&quot;, &quot;br00k11n&quot;)</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.database.mysql.MySqlNode</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">db</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">DB HelloWorld Visitors</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">datastore.creation.script.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://github.com/apache/brooklyn-library/raw/master/examples/simple-web-cluster/src/main/resources/visitors-creation-script.sql</span></code></pre></div>

<p>This sets up Nginx as the controller by default, but that can be configured
using the <code>controllerSpec</code> key. In fact, JBoss is the default appserver,
and because configuration in Brooklyn is inherited by default,
the same blueprint can be expressed more concisely as:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">appserver-clustered-w-db-concise</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.ControlledDynamicWebAppCluster</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">cluster.initial.size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
    <span class="l-Scalar-Plain">wars.root</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=org/apache/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.8.0-incubating/brooklyn-example-hello-world-sql-webapp-0.8.0-incubating.war</span>
    <span class="l-Scalar-Plain">http.port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8080+</span>
    <span class="l-Scalar-Plain">java.sysprops</span><span class="p-Indicator">:</span> 
      <span class="l-Scalar-Plain">brooklyn.example.db.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:formatString(&quot;jdbc:%s%s?user=%s\\&amp;password=%s&quot;,</span>
           <span class="l-Scalar-Plain">component(&quot;db&quot;).attributeWhenReady(&quot;datastore.url&quot;), &quot;visitors&quot;, &quot;brooklyn&quot;, &quot;br00k11n&quot;)</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.database.mysql.MySqlNode</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">db</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">DB HelloWorld Visitors</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">datastore.creation.script.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://github.com/apache/brooklyn-library/blob/master/examples/simple-web-cluster/src/main/resources/visitors-creation-script.sql</span></code></pre></div>

<p>The other nicety supplied by the <code>ControlledDynamicWebAppCluster</code> blueprint is that
it aggregates sensors from the appserver, so we have access to things like
<code>webapp.reqs.perSec.windowed.perNode</code>.
These are convenient for plugging in to policies!
We can set up our blueprint to do autoscaling based on requests per second
(keeping it in the range 10..100, with a maximum of 5 appserver nodes)
as follows: </p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">appserver-w-policy</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.ControlledDynamicWebAppCluster</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">cluster.initial.size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
    <span class="l-Scalar-Plain">dynamiccluster.memberspec</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">$brooklyn:entitySpec</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.jboss.JBoss7Server</span>
        <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">wars.root</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=org/apache/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.8.0-incubating/brooklyn-example-hello-world-sql-webapp-0.8.0-incubating.war</span>
          <span class="l-Scalar-Plain">http.port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8080+</span>
          <span class="l-Scalar-Plain">java.sysprops</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">brooklyn.example.db.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:formatString(&quot;jdbc:%s%s?user=%s\\&amp;password=%s&quot;,</span>
                <span class="l-Scalar-Plain">component(&quot;db&quot;).attributeWhenReady(&quot;datastore.url&quot;), &quot;visitors&quot;, &quot;brooklyn&quot;, &quot;br00k11n&quot;)</span>
  <span class="l-Scalar-Plain">brooklyn.policies</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.policy.autoscaling.AutoScalerPolicy</span>
    <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">metric</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:sensor(&quot;brooklyn.entity.webapp.DynamicWebAppCluster&quot;, &quot;webapp.reqs.perSec.windowed.perNode&quot;)</span>
      <span class="l-Scalar-Plain">metricLowerBound</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>
      <span class="l-Scalar-Plain">metricUpperBound</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">100</span>
      <span class="l-Scalar-Plain">minPoolSize</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
      <span class="l-Scalar-Plain">maxPoolSize</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.database.mysql.MySqlNode</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">db</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">DB HelloWorld Visitors</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">datastore.creation.script.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://github.com/apache/brooklyn-library/raw/master/examples/simple-web-cluster/src/main/resources/visitors-creation-script.sql</span></code></pre></div>

<p>Use your favorite load-generation tool (<code>jmeter</code> is one good example) to send a huge
volume of requests against the server and see the policies kick in to resize it.</p>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-java-entities" class="section-breaker section p-">
	<span style="width: 100%"><h1>Java Entities</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Java blueprints are powerful, but also rather more difficult to write than YAML.
Advanced Java skills are required.</p>

<div class="list-children"><ul>

<li> <a href="#contentsLink-creating-from-a-maven-archetype">Creating from a Maven Archetype</a> </li>

<li> <a href="#contentsLink-defining-and-deploying">Defining and Deploying</a> </li>

<li> <a href="#contentsLink-handling-bundle-dependencies">Handling Bundle Dependencies</a> </li>

<li> <a href="#contentsLink-topology,-dependencies,-and-management-policies">Topology, Dependencies, and Management Policies</a> </li>

<li> <a href="#contentsLink-common-classes-and-entities">Common Classes and Entities</a> </li>

<li> <a href="#contentsLink-feeds">Feeds</a> </li>

<li> <a href="#contentsLink-writing-an-entity">Writing an Entity</a> </li>

<li> <a href="#contentsLink-custom-entity-development">Custom Entity Development</a> </li>

<li> <a href="#contentsLink-service-state">Service State</a> </li>

<li> <a href="#contentsLink-entitlements">Entitlements</a> </li>

</ul></div>

<p>The main uses of Java-based blueprints are:</p>

<ul>
  <li>Integration with a service’s API (e.g. for an on-line DNS service). This could take advantage of
existing Java-based clients, or of Java’s flexibility to chain together multiple calls.</li>
  <li>Complex management logic, for example when the best practices for adding/removing nodes from a
cluster is fiddly and has many conditionals.</li>
  <li>Where the developer has a strong preference for Java. Anything that can be done in YAML can be done in
the Java API. Once the blueprint is added to the catalog, the use of Java will be entirely hidden
from users of that blueprint.</li>
</ul>

<p>The Apache Brooklyn community is striving to make YAML-based blueprints as simple as possible -
if you come across a use-case that is hard to do in YAML then please let the community know.</p>


	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-creating-from-a-maven-archetype" class="section-breaker section p-">
	<span style="width: 100%"><h1>Creating from a Maven Archetype</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h3 id="internalLink_creating-from-a-maven-archetype_maven-archetype">Maven Archetype</h3>

<p>Brooklyn includes a maven archetype, which can be used to create the project structure for 
developing a new Java entity, and generating the OSGi bundle for it.</p>

<h4 id="internalLink_creating-from-a-maven-archetype_generating-the-project">Generating the Project</h4>

<p>The archetype can be used interactively, by running:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>mvn archetype:generate</code></pre></div>

<p>The user will be prompted for the archetype to use (i.e. group “org.apache.brooklyn” 
and artifact “brooklyn-archetype-quickstart”), as well as options for the project 
to be created.</p>

<p>Alternatively, all options can be supplied at the command line. For example, 
if creating a project named “autobrick” for “com.acme”:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ BROOKLYN_VERSION</span><span class="o">=</span>0.12.0-SNAPSHOT
<span class="nv">$ </span>mvn archetype:generate <span class="se">\</span>
	-DarchetypeGroupId<span class="o">=</span>org.apache.brooklyn <span class="se">\</span>
	-DarchetypeArtifactId<span class="o">=</span>brooklyn-archetype-quickstart <span class="se">\</span>
	-DarchetypeVersion<span class="o">=</span><span class="k">${</span><span class="nv">BROOKLYN_VERSION</span><span class="k">}</span> <span class="se">\</span>
	-DgroupId<span class="o">=</span>com.acme <span class="se">\</span>
	-DartifactId<span class="o">=</span>autobrick <span class="se">\</span>
	-Dversion<span class="o">=</span>0.1.0-SNAPSHOT <span class="se">\</span>
	-DpackageName<span class="o">=</span>com.acme.autobrick <span class="se">\</span>
	-DinteractiveMode<span class="o">=</span><span class="nb">false</span></code></pre></div>

<p>This will create a directory with the artifact name (e.g. “autobrick” in the example above).
Note that if run from a directory containing a pom, it will also modify that pom to add this as 
a module!</p>

<p>The project will contain an example Java entity. You can test this using the supplied unit tests,
and also replace it with your own code.</p>

<p>The <code>README.md</code> file within the project gives further guidance.</p>

<h4 id="internalLink_creating-from-a-maven-archetype_building">Building</h4>

<p>To build, run the commands:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">cd </span>autobrick
<span class="nv">$ </span>mvn clean install</code></pre></div>

<h4 id="internalLink_creating-from-a-maven-archetype_adding-to-the-catalog">Adding to the Catalog</h4>

<p>The build will produce an OSGi bundle in <code>target/autobrick-0.1.0-SNAPSHOT.jar</code>, suitable for 
use in the <a href="#contentsLink-catalog">Brooklyn catalog</a> (using <code>brooklyn.libraries</code>).</p>

<p>To use this in your Brooklyn catalog you will first have to copy the target jar to a suitable location. 
For developing/testing purposes storing on the local filesystem is fine. 
For production use, we recommend uploading to a remote maven repository or similar.</p>

<p>Once your jar is in a suitable location the next step is to add a new catalog item to Brooklyn. 
The project comes with a <code>catalog.bom</code> file, located in <code>src/main/resources</code>. 
Modify this file by adding a ‘brooklyn.libraries’ statement to the bom pointing to the jar. 
For example:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">brooklyn.catalog</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">brooklyn.libraries</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">file:///path/to/jar/autobrick-0.1.0-SNAPSHOT.jar</span>
    <span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&quot;0.1.0-SNAPSHOT&quot;</span>
    <span class="l-Scalar-Plain">itemType</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity</span>
    <span class="l-Scalar-Plain">items</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">com.acme.autobrick.MySample</span>
      <span class="l-Scalar-Plain">item</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">com.acme.autobrick.MySample</span></code></pre></div>

<p>The command below will use the CLI to add this to the catalog of a running Brooklyn instance:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">br catalog add catalog.bom</code></pre></div>

<p>After running that command, the OSGi bundle will have been added to the OSGi container, and the
entity will have been added to your catalog. It can then be used in the same way as regular AMP 
entities.</p>

<p>For example, you can use the blueprint:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">com.acme.autobrick.MySample</span></code></pre></div>

<h3 id="internalLink_creating-from-a-maven-archetype_testing-entities">Testing Entities</h3>

<p>The project comes with unit tests that demonstrate how to test entities, both within Java and
also using YAML-based blueprints.</p>

<p>A strongly recommended way is to write a YAML test blueprint using the test framework, and making<br />
this available to anyone who will use your entity. This will allow users to easily run the test
blueprint in their own environment (simply by deploying it to their own Brooklyn server) to confirm 
that the entity is working as expected. An example is contained within the project at 
<code>src/test/resources/sample-test.yaml</code>.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-defining-and-deploying" class="section-breaker section p-">
	<span style="width: 100%"><h1>Defining and Deploying</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_defining-and-deploying_intro">Intro</h2>

<p>This walkthrough will set up a simple entity, add it to the catalog, and provision it.</p>

<p>For illustration purposes, we will write an integration with <a href="https://gist.github.com/">Github Gist</a>, 
with an effector to create new gists.</p>

<h2 id="internalLink_defining-and-deploying_project-setup">Project Setup</h2>

<p>Follow the instructions to create a new Java project using the <a href="#contentsLink-creating-from-a-maven-archetype">archetype</a>, and
import it into your <a href="#contentsLink-ide-setup">favorite IDE</a>. This example assumes you 
used the groupId <code>com.acme</code> and artifact id <code>autobrick</code>.</p>

<p>First ensure you can build this project at the command line, using <code>mvn clean install</code>.</p>

<h2 id="internalLink_defining-and-deploying_java-entity-classes">Java Entity Classes</h2>

<p>For this particular example, we will use a third party Gist library, so will need to add that as 
a dependency. Add the following to your <code>pom.xml</code> inside the <code>&lt;dependencies&gt;</code> section 
(see <a href="https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html">Maven</a> 
for more details):</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.eclipse.mylyn.github<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>org.eclipse.egit.github.core<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>2.1.5<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></div>

<p>Create a new Java interface, <code>GistGenerator</code>, to describe the entity’s interface (i.e. the 
configuration options, sensors, and effectors). The code below assumes you have created this
in the package <code>com.acme</code> for <code>src/main/java</code>.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">acme</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.brooklyn.api.entity.Entity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.api.entity.ImplementedBy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.config.ConfigKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.core.annotation.Effector</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.core.annotation.EffectorParam</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.core.config.ConfigKeys</span><span class="o">;</span>

<span class="nd">@ImplementedBy</span><span class="o">(</span><span class="n">GistGeneratorImpl</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GistGenerator</span> <span class="kd">extends</span> <span class="n">Entity</span> <span class="o">{</span>

    <span class="n">ConfigKey</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">OAUTH_KEY</span> <span class="o">=</span> <span class="n">ConfigKeys</span><span class="o">.</span><span class="na">newStringConfigKey</span><span class="o">(</span><span class="s">&quot;oauth.key&quot;</span><span class="o">,</span> <span class="s">&quot;OAuth key for creating a gist&quot;</span><span class="o">,</span>
            <span class="s">&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span><span class="o">);</span>

    <span class="nd">@Effector</span><span class="o">(</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Create a Gist&quot;</span><span class="o">)</span>
    <span class="n">String</span> <span class="nf">createGist</span><span class="o">(</span>
            <span class="nd">@EffectorParam</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;gistName&quot;</span><span class="o">,</span> <span class="n">description</span><span class="o">=</span><span class="s">&quot;Gist Name&quot;</span><span class="o">,</span> <span class="n">defaultValue</span><span class="o">=</span><span class="s">&quot;Demo Gist&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">gistName</span><span class="o">,</span>
            <span class="nd">@EffectorParam</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;fileName&quot;</span><span class="o">,</span> <span class="n">description</span><span class="o">=</span><span class="s">&quot;File Name&quot;</span><span class="o">,</span> <span class="n">defaultValue</span><span class="o">=</span><span class="s">&quot;Hello.java&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">fileName</span><span class="o">,</span>
            <span class="nd">@EffectorParam</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;gistContents&quot;</span><span class="o">,</span> <span class="n">description</span><span class="o">=</span><span class="s">&quot;Gist Contents&quot;</span><span class="o">,</span> <span class="n">defaultValue</span><span class="o">=</span><span class="s">&quot;System.out.println(\&quot;Hello World\&quot;);&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">gistContents</span><span class="o">,</span>
            <span class="nd">@EffectorParam</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;oauth.key&quot;</span><span class="o">,</span> <span class="n">description</span><span class="o">=</span><span class="s">&quot;OAuth key for creating a gist&quot;</span><span class="o">,</span> <span class="n">defaultValue</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">oauthKey</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>

    <span class="nd">@Effector</span><span class="o">(</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Retrieve a Gist&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getGist</span><span class="o">(</span>
            <span class="nd">@EffectorParam</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="n">description</span><span class="o">=</span><span class="s">&quot;Gist id&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">id</span><span class="o">,</span>
            <span class="nd">@EffectorParam</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;oauth.key&quot;</span><span class="o">,</span> <span class="n">description</span><span class="o">=</span><span class="s">&quot;OAuth key for creating a gist&quot;</span><span class="o">,</span> <span class="n">defaultValue</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">oauthKey</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
<span class="o">}</span></code></pre></div>

<p>To describe each part of this:</p>

<ul>
  <li>The <code>@ImplementedBy</code> indicates the implementation class for this entity type - i.e. the class 
to instantiate when an entity of this type is created.</li>
  <li>By extending <code>Entity</code>, we indicate that this interface is an Entity type. We could alternatively
have extended one of the other sub-types of Entity.</li>
  <li>The <code>OAUTH_KEY</code> is a configuration key - it is configuration that can be set on the entity when 
it is being instantiated.</li>
  <li>The <code>@Effector</code> annotation indicates that the given method is an effector, so should be presented
and tracked as such. Execution of the effector is intercepted, to track it as a task and show its
execution in the Activity view.</li>
  <li>The <code>@EffectorParam</code> annotations give metadata about the effector’s parameters. This metadata,
such as the parameter description, is available to those using the client CLI, rest API and 
web-console.</li>
</ul>

<p>Note there is an alternative way of defining effectors - adding them to the entity dynamically, 
discussed in the section <a href="#contentsLink-common-classes-and-entities">Dynamically Added Effectors</a>.</p>

<p>Next lets add the implementation. Create a new Java class named <code>GistGeneratorImpl</code>.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">acme</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.brooklyn.core.entity.AbstractEntity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.util.text.Strings</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.egit.github.core.Gist</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.egit.github.core.GistFile</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.egit.github.core.service.GistService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.google.common.collect.Iterables</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GistGeneratorImpl</span> <span class="kd">extends</span> <span class="n">AbstractEntity</span> <span class="kd">implements</span> <span class="n">GistGenerator</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOG</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">GistGeneratorImpl</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createGist</span><span class="o">(</span><span class="n">String</span> <span class="n">gistName</span><span class="o">,</span> <span class="n">String</span> <span class="n">fileName</span><span class="o">,</span> <span class="n">String</span> <span class="n">gistContents</span><span class="o">,</span> <span class="n">String</span> <span class="n">oathToken</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Strings</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">oathToken</span><span class="o">))</span> <span class="n">oathToken</span> <span class="o">=</span> <span class="n">config</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">OAUTH_KEY</span><span class="o">);</span>

        <span class="n">GistFile</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">GistFile</span><span class="o">();</span>
        <span class="n">file</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">gistContents</span><span class="o">);</span>
        <span class="n">Gist</span> <span class="n">gist</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Gist</span><span class="o">();</span>
        <span class="n">gist</span><span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="n">gistName</span><span class="o">);</span>
        <span class="n">gist</span><span class="o">.</span><span class="na">setFiles</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span><span class="n">fileName</span><span class="o">,</span> <span class="n">file</span><span class="o">));</span>
        <span class="n">gist</span><span class="o">.</span><span class="na">setPublic</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        
        <span class="n">GistService</span> <span class="n">service</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">GistService</span><span class="o">();</span>
        <span class="n">service</span><span class="o">.</span><span class="na">getClient</span><span class="o">().</span><span class="na">setOAuth2Token</span><span class="o">(</span><span class="n">oathToken</span><span class="o">);</span>
        <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Creating Gist: &quot;</span> <span class="o">+</span>  <span class="n">gistName</span><span class="o">);</span>
        <span class="n">Gist</span> <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">createGist</span><span class="o">(</span><span class="n">gist</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getGist</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">String</span> <span class="n">oathToken</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Strings</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">oathToken</span><span class="o">))</span> <span class="n">oathToken</span> <span class="o">=</span> <span class="n">config</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">OAUTH_KEY</span><span class="o">);</span>

        <span class="n">GistService</span> <span class="n">service</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">GistService</span><span class="o">();</span>
        <span class="n">service</span><span class="o">.</span><span class="na">getClient</span><span class="o">().</span><span class="na">setOAuth2Token</span><span class="o">(</span><span class="n">oathToken</span><span class="o">);</span>
        <span class="n">Gist</span> <span class="n">gist</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">getGist</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">Iterables</span><span class="o">.</span><span class="na">getOnlyElement</span><span class="o">(</span><span class="n">gist</span><span class="o">.</span><span class="na">getFiles</span><span class="o">().</span><span class="na">values</span><span class="o">()).</span><span class="na">getContent</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>To describe each part of this:</p>

<ul>
  <li>Extends <code>AbstractEntity</code> - all entity implementations should extend this, or one of its 
sub-types.</li>
  <li>Implements <code>GistGenerator</code>: this is the Entity type definition, so must be implemented.
Users of the entity will only refer to the interface; they will never be given an instance 
of the concrete class - instead a <a href="https://docs.oracle.com/javase/7/docs/api/java/lang/reflect/Proxy.html">dynamic proxy</a> 
is used (to allow remoting).</li>
  <li><code>org.slf4j.Logger</code> is the logger used throughout Apache Brooklyn.</li>
  <li>Implements the <code>createGist</code> effector - we do not need to re-declare all the annotations.</li>
  <li>If no <code>oath.key</code> parameter was passed in, then use the configuration set on the entity.</li>
  <li>Use the third party library to create the gist.</li>
</ul>

<h3 id="internalLink_defining-and-deploying_configuring-github">Configuring GitHub</h3>

<p>First, create a github.com account, if you do not already have one.</p>

<p>Before running the blueprint, we’ll need to generate an access token that has permissions to
create a gist programmatically.</p>

<p>First <a href="https://help.github.com/articles/creating-an-access-token-for-command-line-use/">create a new access token</a> 
that our blueprint will use to create a gist:</p>

<p><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/blueprints/java/gist_generator/gist_create_token.png"><img src="./v/latest/blueprints/java/gist_generator/gist_create_token.png" alt="Create a new access key." title="Create a new access key" /></a></p>

<p>Next, grant the token rights to create gists:</p>

<p><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/blueprints/java/gist_generator/gist_grant_access.png"><img src="./v/latest/blueprints/java/gist_generator/gist_grant_access.png" alt="Grant access." title="Grant access" /></a></p>

<h3 id="internalLink_defining-and-deploying_testing">Testing</h3>

<p>The archetype project comes with example unit tests that demonstrate how to test entities, 
both within Java and also using YAML-based blueprints. </p>

<p>We will create a similar Java-based test for this blueprint. Create a new Java class named 
<code>GistGeneratorTest</code> in the package <code>com.acme</code>, inside <code>src/test/java</code>.</p>

<p>You will need to substitute the github access token you generated in the previous section for
the placeholder text <code>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</code>.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">acme</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">testng</span><span class="o">.</span><span class="na">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.brooklyn.api.entity.EntitySpec</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.core.test.BrooklynAppUnitTestSupport</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.testng.annotations.Test</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GistGeneratorTest</span> <span class="kd">extends</span> <span class="n">BrooklynAppUnitTestSupport</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testEntity</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">oathKey</span> <span class="o">=</span> <span class="s">&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span><span class="o">;</span>
        <span class="n">GistGenerator</span> <span class="n">entity</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="na">createAndManageChild</span><span class="o">(</span><span class="n">EntitySpec</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">GistGenerator</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="n">String</span> <span class="n">id</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="na">createGist</span><span class="o">(</span><span class="s">&quot;myGistName&quot;</span><span class="o">,</span> <span class="s">&quot;myFileName&quot;</span><span class="o">,</span> <span class="s">&quot;myGistContents&quot;</span><span class="o">,</span> <span class="n">oathKey</span><span class="o">);</span>
        
        <span class="n">String</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="na">getGist</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">oathKey</span><span class="o">);</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="n">contents</span><span class="o">,</span> <span class="s">&quot;myGistContents&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>Similarly, we can write a test that uses the <code>GistGenerator</code> from a YAML blueprint. 
Create a new Java class named <code>GistGeneratorYamlTest</code> in the package <code>com.acme</code>, 
inside <code>src/test/java</code>.</p>

<p>Again you will need to substitute the github access token you generated in the previous section for
the placeholder text <code>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</code>. See the section on 
<a href="#contentsLink-externalized-configuration">externalised configuration</a> 
for how to store these credentials more securely. </p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">acme</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">testng</span><span class="o">.</span><span class="na">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.brooklyn.api.entity.Entity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.camp.brooklyn.AbstractYamlTest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.core.entity.Entities</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.testng.annotations.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.google.common.base.Joiner</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.common.collect.Iterables</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GistGeneratorYamlTest</span> <span class="kd">extends</span> <span class="n">AbstractYamlTest</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">contents</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testEntity</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">oathKey</span> <span class="o">=</span> <span class="s">&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span><span class="o">;</span>
        
        <span class="n">String</span> <span class="n">yaml</span> <span class="o">=</span> <span class="n">Joiner</span><span class="o">.</span><span class="na">on</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">).</span><span class="na">join</span><span class="o">(</span>
            <span class="s">&quot;name: my test&quot;</span><span class="o">,</span>
            <span class="s">&quot;services:&quot;</span><span class="o">,</span>
            <span class="s">&quot;- type: com.acme.GistGenerator&quot;</span><span class="o">,</span>
            <span class="s">&quot;  brooklyn.config:&quot;</span><span class="o">,</span>
            <span class="s">&quot;    oauth.key: &quot;</span><span class="o">+</span><span class="n">oathKey</span><span class="o">);</span>
        
        <span class="n">Entity</span> <span class="n">app</span> <span class="o">=</span> <span class="n">createAndStartApplication</span><span class="o">(</span><span class="n">yaml</span><span class="o">);</span>
        <span class="n">waitForApplicationTasks</span><span class="o">(</span><span class="n">app</span><span class="o">);</span>

        <span class="n">Entities</span><span class="o">.</span><span class="na">dumpInfo</span><span class="o">(</span><span class="n">app</span><span class="o">);</span>

        <span class="n">GistGenerator</span> <span class="n">entity</span> <span class="o">=</span> <span class="o">(</span><span class="n">GistGenerator</span><span class="o">)</span> <span class="n">Iterables</span><span class="o">.</span><span class="na">getOnlyElement</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">getChildren</span><span class="o">());</span>
        <span class="n">String</span> <span class="n">id</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="na">createGist</span><span class="o">(</span><span class="s">&quot;myGistName&quot;</span><span class="o">,</span> <span class="s">&quot;myFileName&quot;</span><span class="o">,</span> <span class="s">&quot;myGistContents&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        
        <span class="n">contents</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="na">getGist</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="n">contents</span><span class="o">,</span> <span class="s">&quot;myGistContents&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<h2 id="internalLink_defining-and-deploying_building-the-osgi-bundle">Building the OSGi Bundle</h2>

<p>Next we will build this example as an <a href="https://www.osgi.org/developer/architecture/">OSGi Bundle</a> 
so that it can be added to the Apache Brooklyn server at runtime, and so multiple versions of the<br />
blueprint can be managed.</p>

<p>The <code>mvn clean install</code> will automatically do this, creating a jar inside the <code>target/</code> sub-directory
of the project. This works by using the 
<a href="http://felix.apache.org/documentation/subprojects/apache-felix-maven-bundle-plugin-bnd.html">Maven Bundle Plugin</a>
which we get automatically by declaring the <code>pom.xml</code>’s parent as <code>brooklyn-downstream-parent</code>.</p>

<h2 id="internalLink_defining-and-deploying_adding-to-the-catalog">Adding to the catalog</h2>

<p>Similar to the <code>sample.bom</code> entity that ships with the archetype, we will define a <code>.bom</code> file
to add our <code>GistGenerator</code> to the catalog. Substitute the URL below for your own newly built 
artifact (which will be in the <code>target</code> sub-directory after running <code>mvn clean install</code>).</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">brooklyn.catalog</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">libraries</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=com/google/code/gson/gson/2.2.2/gson-2.2.2.jar</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">http://repo1.maven.org/maven2/org/apache/servicemix/bundles/org.apache.servicemix.bundles.egit.github.core/2.1.5_1/org.apache.servicemix.bundles.egit.github.core-2.1.5_1.jar</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">http://developers.cloudsoftcorp.com/brooklyn/guide/blueprints/java/gist_generator/autobrick-0.1.0-SNAPSHOT.jar</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">example.GistGenerator</span>
  <span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&quot;0.1.0-SNAPSHOT&quot;</span>
  <span class="l-Scalar-Plain">itemType</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">template</span>
  <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">For programmatically generating GitHub Gists</span>
  <span class="l-Scalar-Plain">displayName</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Gist Generator</span>
  <span class="l-Scalar-Plain">iconUrl</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">classpath:///sample-icon.png</span>
  <span class="l-Scalar-Plain">item</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">com.acme.GistGenerator</span></code></pre></div>

<p>See <a href="#contentsLink-handling-bundle-dependencies">Handling Bundle Dependencies</a>
for a description of the <code>brooklyn.libraries</code> used above, and for other alternative approaches.</p>

<p>The command below will use the <code>br</code> CLI to add this to the catalog of a running Brooklyn instance.
Substitute the credentials, URL and port for those of your server.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>br login https://127.0.0.1:8443 admin pa55w0rd
<span class="nv">$ </span>br catalog add gist_generator.bom</code></pre></div>

<h2 id="internalLink_defining-and-deploying_using-the-blueprint">Using the blueprint</h2>

<p>The YAML blueprint below shows an example usage of this blueprint:</p>

<pre><code>name: my sample
services:
- type: example.GistGenerator
  brooklyn.config:
    oauth.key: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
</code></pre>

<p>Note the type name matches the id defined in the <code>.bom</code> file.</p>

<p>You can now call the effector by any of the standard means - <a href="#contentsLink-gui-guide">web console</a>, 
<a href="#contentsLink-rest-api">REST api</a>, or <a href="#contentsLink-client-cli-reference">Client CLI</a>.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-handling-bundle-dependencies" class="section-breaker section p-">
	<span style="width: 100%"><h1>Handling Bundle Dependencies</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Some Java blueprints will require third party libraries. These need to be made available to the
Apache Brooklyn runtime. There are a number of ways this can be achieved.</p>

<h3 id="internalLink_handling-bundle-dependencies_classic-mode-dropins-folder">Classic Mode: Dropins Folder</h3>

<p>In Brooklyn classic mode (i.e. when not using Karaf), jars can be added to <code>./lib/dropins/</code>.
After restarting Brooklyn, these will be available on the classpath.</p>

<p>In Brooklyn classic mode, there is an embedded OSGi container. This is used for installing 
libraries referenced in catalog items.</p>

<h3 id="internalLink_handling-bundle-dependencies_osgi-bundles">OSGi Bundles</h3>

<h4 id="internalLink_handling-bundle-dependencies_introduction-to-osgi-bundles">Introduction to OSGi Bundles</h4>

<p>An <a href="https://en.wikipedia.org/wiki/OSGi#Bundles">OSGi bundle</a> is a jar file with additional 
metadata in its manifest file. The <code>MANIFEST.MF</code> file contains the symbolic name and version 
of the bundle, along with details of its dependencies and of the packages it exports 
(which are thus visible to other bundles).</p>

<p>The <a href="http://felix.apache.org/documentation/subprojects/apache-felix-maven-bundle-plugin-bnd.html">maven-bundle-plugin</a> 
is a convenient way of building OSGi bundles.</p>

<h4 id="internalLink_handling-bundle-dependencies_osgi-bundles-declared-in-catalog-items">OSGi Bundles Declared in Catalog Items</h4>

<p>Within a <a href="#contentsLink-catalog">catalog item</a>, a list of URLs can be supplied under
<code>brooklyn.libraries</code>. Each URL should point to an OSGi bundle. This list should include the OSGi 
bundle that has the Java code for your blueprint, and also the OSGi bundles that it depends
on (including all transitive dependencies).</p>

<p>It is vital that these jars are built correctly as OSGi bundles, and that all transitive 
dependencies are included. The bundles will be added to Karaf in the order given, so a bundle’s
dependencies should be listed before the bundle(s) that depend on them.</p>

<p>In the <a href="#contentsLink-defining-and-deploying">GistGenerator example</a>, the 
<a href="http://brooklyn.apache.org/v/0.10.0/v/latest/blueprints/java/gist_generator/gist_generator.bom">catalog.bom file</a> included
the URL of the dependency <code>org.eclipse.egit.github.core</code>. It also (before that line) included
its transitive dependency, which is a specific version of <code>gson</code>.</p>

<p>For Java blueprint developers, this is often the most convenient way to share a blueprint.</p>

<p>Similarly for those wishing to use a new blueprint, this is often the simplest mechanism: the
dependencies are fully described in the catalog item, which makes it convenient for deploying 
to Apache Brooklyn instances where there is not direct access to Karaf or the file system.</p>

<h4 id="internalLink_handling-bundle-dependencies_adding-bundles-and-features-directly-to-karaf">Adding Bundles and Features Directly to Karaf</h4>

<p>Bundles and features can be added manually, directly to Karaf.</p>

<p>However, note this only affects the single Karaf instance. If running in HA mode or if provisioning
a new instance of Apache Brooklyn, the bundles will also need to be added to these Karaf instances.</p>

<h5 id="internalLink_handling-bundle-dependencies_karaf-console">Karaf Console</h5>

<p>Login to the <a href="https://karaf.apache.org/manual/latest/#_shell_console_basics">Karaf console</a>
using <code>./bin/client</code>, and add the bundles and features as desired.</p>

<p>Examples of some useful commands are shown below:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">karaf@amp&gt; bundle:install -s http://repo1.maven.org/maven2/org/apache/servicemix/bundles/org.apache.servicemix.bundles.egit.github.core/2.1.5_1/org.apache.servicemix.bundles.egit.github.core-2.1.5_1.jar
Bundle ID: 316

karaf@amp&gt; bundle:list -t <span class="m">0</span> -s <span class="p">|</span> grep github
<span class="m">318</span> <span class="p">|</span> Active   <span class="p">|</span>  <span class="m">80</span> <span class="p">|</span> 2.1.5.1                       <span class="p">|</span> org.apache.servicemix.bundles.egit.github.core

karaf@amp&gt; bundle:headers org.apache.servicemix.bundles.egit.github.core
...

karaf@amp&gt; bundle:uninstall org.apache.servicemix.bundles.egit.github.core</code></pre></div>

<h5 id="internalLink_handling-bundle-dependencies_karaf-deploy-folder">Karaf Deploy Folder</h5>

<p>Karaf support <a href="https://karaf.apache.org/manual/latest/#_deployers">hot deployment</a>. There are a 
set of deployers, such as feature and KAR deployers, that handle deployment of artifacts added
to the <code>deploy</code> folder.</p>

<p>Note that the Karaf console can give finer control (including for uninstall).</p>

<h3 id="internalLink_handling-bundle-dependencies_karaf-kar-files">Karaf KAR files</h3>

<p><a href="https://karaf.apache.org/manual/latest/kar">Karaf KAR</a> is an archive format (Karaf ARchive).
A KAR is a jar file (so a zip file), which contains a set of feature descriptors and bundle jar files.</p>

<p>This can be a useful way to bundle a more complex Java blueprint (along with its dependencies), to
make it easier for others to install.</p>

<p>A KAR file can be built using the 
<a href="https://karaf.apache.org/manual/latest/#_maven">maven plugin org.apache.karaf.tooling:features-maven-plugin</a>.</p>

<h3 id="internalLink_handling-bundle-dependencies_karaf-features">Karaf Features</h3>

<p>A <a href="https://karaf.apache.org/manual/latest/#_create_a_features_xml_karaf_feature_archetype">karaf feature.xml</a>
defines a set of bundles that make up a feature. Once a feature is defined, one can add it to a Karaf instance:
either directly (e.g. using the <a href="https://karaf.apache.org/manual/latest/#_shell_console_basics">Karaf console</a>), or
by referencing it in another feature.xml file. </p>

<h3 id="internalLink_handling-bundle-dependencies_embedded-dependencies">Embedded Dependencies</h3>

<p>An OSGi bundle can 
<a href="http://felix.apache.org/documentation/subprojects/apache-felix-maven-bundle-plugin-bnd.html#embedding-dependencies">embed jar dependencies</a>
within it. This allows dependencies to be kept private within a bundle, and easily shipped with that bundle.</p>

<p>To keep these private, it is vital that the OSGi bundle does not import or export the packages
contained within those embedded jars, and does not rely on any of those packages in the public 
signatures of any packages that are exported or imported.</p>

<h3 id="internalLink_handling-bundle-dependencies_converting-non-osgi-dependencies-to-bundles">Converting Non-OSGi Dependencies to Bundles</h3>

<p>If a dependencies is not available as an OSGi bundle (and you don’t want to just <a href="#internalLink_handling-bundle-dependencies_embedded-dependencies">embed the jar</a>),
there are a few options for getting an equivalent OSGi bundle:</p>

<ul>
  <li>
    <p>Use a ServiceMix re-packaged jar, if available. ServiceMix have re-packed many common dependencies as
OSGi bundles, and published them on <a href="https://search.maven.org">Maven Central</a>.</p>
  </li>
  <li>
    <p>Use the <code>wrap:</code> prefix. The <a href="https://ops4j1.jira.com/wiki/display/paxurl/Wrap+Protocol">PAX URL Wrap protocol</a> 
is an OSGi URL handler that can process your legacy jar at runtime and transform it into an OSGi bundle.<br />
This can be used when declaring a dependency in your feature.xml, and when using the Karaf console’s 
<code>bundle:install</code>. Note that it is not yet supported in Brooklyn’s <code>brooklyn.libraries</code> catalog items.</p>
  </li>
  <li>
    <p>Re-package the bundle yourself, offline, to produce a valid OSGi bundle.</p>
  </li>
</ul>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-topology,-dependencies,-and-management-policies" class="section-breaker section p-">
	<span style="width: 100%"><h1>Topology, Dependencies, and Management Policies</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Applications written in YAML can similarly be written in Java. However, the YAML approach is 
recommended.</p>

<h2 id="internalLink_topology,-dependencies,-and-management-policies_define-your-application-blueprint">Define your Application Blueprint</h2>

<p>The example below creates a three tier web service, composed of an Nginx load-balancer, 
a cluster of Tomcat app-servers, and a MySQL database. It is similar to the <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/start/policies.html">YAML policies
example</a>, but also includes the MySQL database
to demonstrate the use of dependent configuration.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">acme</span><span class="o">.</span><span class="na">autobrick</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.brooklyn.api.entity.EntitySpec</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.api.policy.PolicySpec</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.api.sensor.AttributeSensor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.api.sensor.EnricherSpec</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.core.entity.AbstractApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.core.sensor.DependentConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.core.sensor.Sensors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.enricher.stock.Enrichers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.entity.database.mysql.MySqlNode</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.entity.group.DynamicCluster</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.entity.proxy.nginx.NginxController</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.entity.webapp.tomcat.TomcatServer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.policy.autoscaling.AutoScalerPolicy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.policy.ha.ServiceFailureDetector</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.policy.ha.ServiceReplacer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.policy.ha.ServiceRestarter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.brooklyn.util.time.Duration</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleWebApp</span> <span class="kd">extends</span> <span class="n">AbstractApplication</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">AttributeSensor</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">reqsPerSecPerNodeSensor</span> <span class="o">=</span> <span class="n">Sensors</span><span class="o">.</span><span class="na">newDoubleSensor</span><span class="o">(</span>
                <span class="s">&quot;webapp.reqs.perSec.perNode&quot;</span><span class="o">,</span>
                <span class="s">&quot;Reqs/sec averaged over all nodes&quot;</span><span class="o">);</span>
        
        <span class="n">MySqlNode</span> <span class="n">db</span> <span class="o">=</span> <span class="n">addChild</span><span class="o">(</span><span class="n">EntitySpec</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">MySqlNode</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="n">MySqlNode</span><span class="o">.</span><span class="na">CREATION_SCRIPT_URL</span><span class="o">,</span> <span class="s">&quot;https://bit.ly/brooklyn-visitors-creation-script&quot;</span><span class="o">));</span>

        <span class="n">DynamicCluster</span> <span class="n">cluster</span> <span class="o">=</span> <span class="n">addChild</span><span class="o">(</span><span class="n">EntitySpec</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">DynamicCluster</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">displayName</span><span class="o">(</span><span class="s">&quot;Cluster&quot;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="n">DynamicCluster</span><span class="o">.</span><span class="na">MEMBER_SPEC</span><span class="o">,</span> <span class="n">EntitySpec</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">TomcatServer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="n">TomcatServer</span><span class="o">.</span><span class="na">ROOT_WAR</span><span class="o">,</span> 
                                <span class="s">&quot;http://search.maven.org/remotecontent?filepath=org/apache/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.8.0-incubating/brooklyn-example-hello-world-sql-webapp-0.8.0-incubating.war&quot;</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="n">TomcatServer</span><span class="o">.</span><span class="na">JAVA_SYSPROPS</span><span class="o">.</span><span class="na">subKey</span><span class="o">(</span><span class="s">&quot;brooklyn.example.db.url&quot;</span><span class="o">),</span>
                                <span class="n">DependentConfiguration</span><span class="o">.</span><span class="na">formatString</span><span class="o">(</span><span class="s">&quot;jdbc:%s%s?user=%s&amp;password=%s&quot;</span><span class="o">,</span>
                                        <span class="n">DependentConfiguration</span><span class="o">.</span><span class="na">attributeWhenReady</span><span class="o">(</span><span class="n">db</span><span class="o">,</span> <span class="n">MySqlNode</span><span class="o">.</span><span class="na">DATASTORE_URL</span><span class="o">),</span>
                                        <span class="s">&quot;visitors&quot;</span><span class="o">,</span> <span class="s">&quot;brooklyn&quot;</span><span class="o">,</span> <span class="s">&quot;br00k11n&quot;</span><span class="o">))</span>
                        <span class="o">.</span><span class="na">policy</span><span class="o">(</span><span class="n">PolicySpec</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">ServiceRestarter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="n">ServiceRestarter</span><span class="o">.</span><span class="na">FAIL_ON_RECURRING_FAILURES_IN_THIS_DURATION</span><span class="o">,</span> <span class="n">Duration</span><span class="o">.</span><span class="na">minutes</span><span class="o">(</span><span class="mi">5</span><span class="o">)))</span>
                        <span class="o">.</span><span class="na">enricher</span><span class="o">(</span><span class="n">EnricherSpec</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">ServiceFailureDetector</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="n">ServiceFailureDetector</span><span class="o">.</span><span class="na">ENTITY_FAILED_STABILIZATION_DELAY</span><span class="o">,</span> <span class="n">Duration</span><span class="o">.</span><span class="na">seconds</span><span class="o">(</span><span class="mi">30</span><span class="o">))))</span>
                <span class="o">.</span><span class="na">policy</span><span class="o">(</span><span class="n">PolicySpec</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">ServiceReplacer</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
                <span class="o">.</span><span class="na">policy</span><span class="o">(</span><span class="n">PolicySpec</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">AutoScalerPolicy</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="n">AutoScalerPolicy</span><span class="o">.</span><span class="na">METRIC</span><span class="o">,</span> <span class="n">reqsPerSecPerNodeSensor</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="n">AutoScalerPolicy</span><span class="o">.</span><span class="na">METRIC_LOWER_BOUND</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="n">AutoScalerPolicy</span><span class="o">.</span><span class="na">METRIC_UPPER_BOUND</span><span class="o">,</span> <span class="mi">3</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="n">AutoScalerPolicy</span><span class="o">.</span><span class="na">RESIZE_UP_STABILIZATION_DELAY</span><span class="o">,</span> <span class="n">Duration</span><span class="o">.</span><span class="na">seconds</span><span class="o">(</span><span class="mi">2</span><span class="o">))</span>
                        <span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="n">AutoScalerPolicy</span><span class="o">.</span><span class="na">RESIZE_DOWN_STABILIZATION_DELAY</span><span class="o">,</span> <span class="n">Duration</span><span class="o">.</span><span class="na">minutes</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
                        <span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="n">AutoScalerPolicy</span><span class="o">.</span><span class="na">MAX_POOL_SIZE</span><span class="o">,</span> <span class="mi">3</span><span class="o">))</span>
                <span class="o">.</span><span class="na">enricher</span><span class="o">(</span><span class="n">Enrichers</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">aggregating</span><span class="o">(</span><span class="n">TomcatServer</span><span class="o">.</span><span class="na">REQUESTS_PER_SECOND_IN_WINDOW</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">computingAverage</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">fromMembers</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">publishing</span><span class="o">(</span><span class="n">reqsPerSecPerNodeSensor</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">build</span><span class="o">()));</span>
        <span class="n">addChild</span><span class="o">(</span><span class="n">EntitySpec</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">NginxController</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="n">NginxController</span><span class="o">.</span><span class="na">SERVER_POOL</span><span class="o">,</span> <span class="n">cluster</span><span class="o">)</span>
                <span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="n">NginxController</span><span class="o">.</span><span class="na">STICKY</span><span class="o">,</span> <span class="kc">false</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>To describe each part of this:</p>

<ul>
  <li>The application extends <code>AbstractApplication</code>.</li>
  <li>It implements <code>init()</code>, to add its child entities. The <code>init</code> method is called only once, when
instantiating the entity instance.</li>
  <li>The <code>addChild</code> method takes an <code>EntitySpec</code>. This describes the entity to be created, defining
its type and its configuration.</li>
  <li>The <code>brooklyn.example.db.url</code> is a system property that will be passed to each <code>TomcatServer</code> 
instance. Its value is the database’s URL (discussed below).</li>
  <li>The policies and enrichers provide in-life management of the application, to restart failed
instances and to replace those components that repeatedly fail.</li>
  <li>The <code>NginxController</code> is the load-balancer and reverse-proxy: by default, it round-robins to 
the ip:port of each member of the cluster configured as the <code>SERVER_POOL</code>.</li>
</ul>

<h2 id="internalLink_topology,-dependencies,-and-management-policies_dependent-configuration">Dependent Configuration</h2>

<p>Often a component of an application will depend on another component, where the dependency
information is only available at runtime (e.g. it requires the IP of a dynamically provisioned
component). For example, the app-servers in the example above require the database URL to be 
injected.</p>

<p>The “DependentConfiguration” methods returns a future (or a “promise” in the language of 
some other programming languages): when the  value is needed, the caller will block to wait for<br />
the future to resolve. It will block only “at the last moment” when the value is needed (e.g. 
after the VMs have been provisioned and the software is installed, thus optimising the 
provisioning time). It will automatically monitor the given entity’s sensor, and generate the 
value when the sensor is populated.</p>

<p>The <code>attributeWhenReady</code> is used to generate a configuration value that depends on the dynamic 
sensor value of another entity - in the example above, it will not be available until that 
<code>MySqlNode.DATASTORE_URL</code> sensor is populated. At that point, the JDBC URL will be constructed 
(as defined in the <code>formatString</code> method, which also returns a future).</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-common-classes-and-entities" class="section-breaker section p-">
	<span style="width: 100%"><h1>Common Classes and Entities</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<!-- TODO old, needs work (refactoring!) and use of java_link -->

<h3 id="internalLink_common-classes-and-entities_entity-class-hierarchy">Entity Class Hierarchy</h3>

<p>By convention in Brooklyn the following words have a particular meaning:</p>

<ul>
  <li><em>Group</em> - a homogeneous grouping of entities (which need not all be managed by the same parent 
entity)</li>
  <li><em>Cluster</em> - a homogeneous collection of entities (all managed by the “cluster” entity)</li>
  <li><em>Fabric</em> - a multi-location collection of entities, with one per location; often used with a cluster per location</li>
  <li><em>Application</em> - a top-level entity, which can have one or more child entities.</li>
</ul>

<p>The following constructs are often used for Java entities:</p>

<ul>
  <li><em>entity spec</em> defines an entity to be created; used to define a child entity, or often to 
define the type of entity in a cluster.</li>
  <li><em>traits</em> (mixins) providing certain capabilities, such as <em>Resizable</em> and <em>Startable</em>.</li>
  <li><em>Resizable</em> entities can re-sized dynamically, to increase/decrease the number of child entities.
For example, scaling up or down a cluster. It could similarly be used to vertically scale a VM,
or to resize a disk.</li>
  <li><em>Startable</em> indicates the effector to be executed on initial deployment (<code>start()</code>) and on 
tear down (<code>stop()</code>).</li>
</ul>

<h3 id="internalLink_common-classes-and-entities_configuration">Configuration</h3>

<p>Configuration keys are typically defined as static named fields on the Entity interface. These
define the configuration values that can be passed to the entity during construction. For
example:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ConfigKey</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">ROOT_WAR</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConfigKeys</span><span class="o">.</span><span class="na">newStringConfigKey</span><span class="o">(</span>
        <span class="s">&quot;wars.root&quot;</span><span class="o">,</span>
        <span class="s">&quot;WAR file to deploy as the ROOT, as URL (supporting file: and classpath: prefixes)&quot;</span><span class="o">);</span></code></pre></div>

<p>One can optionally define a <code>@SetFromFlag("war")</code>. This defines a short-hand for configuring the
entity. However, it should be used with caution - when using configuration set on a parent entity
(and thus inherited), the <code>@SetFromFlag</code> short-form names are not checked. The long form defined 
in the constructor should be meaningful and sufficient. The usage of <code>@SetFromFlag</code> is therefore
discouraged.</p>

<p>The type <code>AttributeSensorAndConfigKey&lt;?&gt;</code> can be used to indicate that a config key should be resolved,
and its value set as a sensor on the entity (when <code>ConfigToAttributes.apply(entity)</code> is called).</p>

<p>A special case of this is <code>PortAttributeSensorAndConfigKey</code>. This is resolved to find an available 
port (by querying the target location). For example, the value <code>8081+</code> means that then next available
port starting from 8081 will be used.</p>

<h3 id="internalLink_common-classes-and-entities_declaring-sensors">Declaring Sensors</h3>

<p>Sensors are typically defined as static named fields on the Entity interface. These define 
the events published by the entity, which interested parties can subscribe to. For example:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">AttributeSensor</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">MANAGEMENT_URL</span> <span class="o">=</span> <span class="n">Sensors</span><span class="o">.</span><span class="na">newStringSensor</span><span class="o">(</span>
        <span class="s">&quot;crate.managementUri&quot;</span><span class="o">,</span>
        <span class="s">&quot;The address at which the Crate server listens&quot;</span><span class="o">);</span></code></pre></div>

<h3 id="internalLink_common-classes-and-entities_declaring-effectors">Declaring Effectors</h3>

<p>Effectors are the operations that an entity supports. There are multiple ways that an entity can 
be defined. Examples of each are given below.</p>

<h4 id="internalLink_common-classes-and-entities_effector-annotation">Effector Annotation</h4>

<p>A method on the entity interface can be annotated to indicate it is an effector, and to provide
metadata about the effector and its parameters.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@org.apache.brooklyn.core.annotation.Effector</span><span class="o">(</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;Retrieve a Gist&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">getGist</span><span class="o">(</span><span class="nd">@EffectorParam</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="n">description</span><span class="o">=</span><span class="s">&quot;Gist id&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">id</span><span class="o">);</span></code></pre></div>

<h4 id="internalLink_common-classes-and-entities_static-field-effector-declaration">Static Field Effector Declaration</h4>

<p>A static field can be defined on the entity to define an effector, giving metadata about that effector.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Effector</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">EXECUTE_SCRIPT</span> <span class="o">=</span> <span class="n">Effectors</span><span class="o">.</span><span class="na">effector</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;executeScript&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">description</span><span class="o">(</span><span class="s">&quot;invokes a script&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">parameter</span><span class="o">(</span><span class="n">ExecuteScriptEffectorBody</span><span class="o">.</span><span class="na">SCRIPT</span><span class="o">)</span>
        <span class="o">.</span><span class="na">impl</span><span class="o">(</span><span class="k">new</span> <span class="nf">ExecuteScriptEffectorBody</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span></code></pre></div>

<p>In this example, the implementation of the effector is an instance of <code>ExecuteScriptEffectorBody</code>. 
This implements <code>EffectorBody</code>. It will be invoked whenever the effector is called.</p>

<h4 id="internalLink_common-classes-and-entities_dynamically-added-effectors">Dynamically Added Effectors</h4>

<p>An effector can be added to an entity dynamically - either as part of the entity’s <code>init()</code>
or as separate initialization code. This allows the implementation of the effector to be shared
amongst multiple entities, without sub-classing. For example:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Effector</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="n">GET_GIST</span> <span class="o">=</span> <span class="n">Effectors</span><span class="o">.</span><span class="na">effector</span><span class="o">(</span><span class="n">Void</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;createGist&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">description</span><span class="o">(</span><span class="s">&quot;Create a Gist&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">parameter</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="s">&quot;Gist id&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">buildAbstract</span><span class="o">();</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="n">CreateGistEffectorBody</span> <span class="kd">implements</span> <span class="n">EffectorBody</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Void</span> <span class="nf">call</span><span class="o">(</span><span class="n">ConfigBag</span> <span class="n">parameters</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// impl</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">getMutableEntityType</span><span class="o">().</span><span class="na">addEffector</span><span class="o">(</span><span class="n">CREATE_GIST</span><span class="o">,</span> <span class="k">new</span> <span class="nf">CreateGistEffectorBody</span><span class="o">());</span>
<span class="o">}</span></code></pre></div>

<h3 id="internalLink_common-classes-and-entities_effector-invocation">Effector Invocation</h3>

<p>There are several ways to invoke an effector programmatically:</p>

<ul>
  <li>
    <p>Where there is an annotated method, simply call the method on the interface.</p>
  </li>
  <li>
    <p>Call the <code>invoke</code> method on the entity, using the static effector declaration. For example:<br />
<code>entity.invoke(CREATE_GIST, ImmutableMap.of("id", id));</code>.</p>
  </li>
  <li>
    <p>Call the utility method <code>org.apache.brooklyn.core.entity.Entities.invokeEffector</code>. For example:<br />
<code>Entities.invokeEffector(this, targetEntity, CREATE_GIST, ImmutableMap.of("id", id));</code>.</p>
  </li>
</ul>

<p>When an effector is invoked, the call is intercepted to wrap it in a task. In this way, the 
effector invocation is tracked - it is shown in the Activity view.</p>

<p>When <code>invoke</code> or <code>invokeEffector</code> is used, the call returns a <code>Task</code> object (which extends 
<code>Future</code>). This allows the caller to understand progress and errors on the task, as well as 
calling <code>task.get()</code> to retrieve the return value. Be aware that <code>task.get()</code> is a blocking 
function that will wait until a value is available before returning.</p>

<h3 id="internalLink_common-classes-and-entities_tasks">Tasks</h3>

<p><em>Warning: the task API may be changed in a future release. However, backwards compatibility
will be maintained where possible.</em></p>

<p>When implementing entities and policies, all work done within Brooklyn is executed as Tasks.
This makes it trackable and visible to administrators. For the activity list to show a break-down 
of an effector’s work (in real-time, and also after completion), tasks and sub-tasks must be 
created.</p>

<p>In common situations, tasks are implicitly created and executed. For example, when implementing
an effector using the <code>@Effector</code> annotation on a method, the method invocation is automatically
wrapped as a task. Similarly, when a subscription is passed an event (e.g. when using 
<code>SensorEventListener.onEvent(SensorEvent&lt;T&gt; event)</code>, that call is done inside a task.</p>

<p>Within a task, it is possible to create and execute sub-tasks. A common way to do this is to 
use <code>DynamicTasks.queue</code>. If called from within a a “task queuing context” (e.g. from inside an
effector implementation), it will add the task to be executed. By default, the outer task will not be
marked as done until its queued sub-tasks are complete.</p>

<p>When creating tasks, the <code>TaskBuilder</code> can be used to create simple tasks or to create compound tasks
whose sub-tasks are to be executed either sequentially or in parallel. For example:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">TaskBuilder</span><span class="o">.&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="n">builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">displayName</span><span class="o">(</span><span class="s">&quot;stdout-example&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="k">new</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;()</span> <span class="o">{</span> <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">call</span><span class="o">()</span> <span class="o">{</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;example&quot;</span><span class="o">;</span> <span class="o">}</span> <span class="o">})</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span></code></pre></div>

<p>There are also builder and factory utilities for common types of operation, such as executing SSH 
commands using <code>SshTasks</code>.</p>

<p>A lower level way to submit tasks within an entity is to call <code>getExecutionContext().submit(...)</code>.
This automatically tags the task to indicate that its context is the given entity.</p>

<p>An even lower level way to execute tasks (to be ignored except for power-users) is to go straight<br />
to the <code>getManagementContext().getExecutionManager().submit(...)</code>. This is similar to the standard
Java <code>Executor</code>, but also supports more metadata about tasks such as descriptions and tags.
It also supports querying for tasks. There is also support for submitting <code>ScheduledTask</code> 
instances which run periodically.</p>

<p>The <code>Tasks</code> and <code>BrooklynTaskTags</code> classes supply a number of conveniences including builders to 
make working with tasks easier.</p>

<h3 id="internalLink_common-classes-and-entities_subscriptions-and-the-subscription-manager">Subscriptions and the Subscription Manager</h3>

<p>Entities, locations, policies and enrichers can subscribe to events. These events could be
attribute-change events from other entities, or other events explicitly published by the entities.</p>

<p>A subscription is created by calling <code>subscriptions().subscribe(entity, sensorType, sensorEventListener)</code>.
The <code>sensorEventListener</code> will be called with the event whenever the given entity emits a sensor of
the given type. If <code>null</code> is used for either the entity or sensor type, this is treated as a 
wildcard.</p>

<p>It is very common for a policy or enricher to subscribe to events, to kick off actions or to 
publish other aggregated attributes or events. </p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-feeds" class="section-breaker section p-">
	<span style="width: 100%"><h1>Feeds</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<!-- TODO old, needs work (refactoring!) and use of java_link -->

<h3 id="internalLink_feeds_feeds">Feeds</h3>

<p><code>Feed</code>s within Apache Brooklyn are used to populate an entity’s sensors. There are a variety of 
feed types, which commonly poll to retrieve the raw metrics of the entity (for example polling an 
HTTP management API, or over JMX).  </p>

<h4 id="internalLink_feeds_persistence">Persistence</h4>

<p>There are two ways to associate a feed with an entity.</p>

<p>The first way is (within the entity) to call <code>feeds().addFeed(...)</code>.
This persists the feed: the feed will be automatically
added to the entity when the Brooklyn server restarts. It is important that all configuration
of the feed is persistable (e.g. not using any in-line anonymous inner classes to define
functions).</p>

<p>The feed builders can be passed a <code>uniqueTag(...)</code>, which will be used to ensure that on
rebind there will not be multiple copied of the feed (e.g. if <code>rebind()</code> had already re-created
the feed).</p>

<p>The second way is to just pass to the feed’s builder the entity. When using this mechanism, 
the feed will be wired up to the entity but it will not be persisted. In this case, it is
important that the entity’s <code>rebind()</code> method recreates the feed.</p>

<h4 id="internalLink_feeds_types-of-feed">Types of Feed</h4>

<h5 id="internalLink_feeds_http-feed">HTTP Feed</h5>

<p>An <code>HttpFeed</code> polls over http(s). An example is shown below:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">HttpFeed</span> <span class="n">feed</span><span class="o">;</span>

<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">connectSensors</span><span class="o">()</span> <span class="o">{</span>
  <span class="kd">super</span><span class="o">.</span><span class="na">connectSensors</span><span class="o">();</span>
  
  <span class="n">feed</span> <span class="o">=</span> <span class="n">feeds</span><span class="o">().</span><span class="na">addFeed</span><span class="o">(</span><span class="n">HttpFeed</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
      <span class="o">.</span><span class="na">period</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
      <span class="o">.</span><span class="na">baseUri</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;http://%s:%s/management/subsystem/web/connector/http/read-resource&quot;</span><span class="o">,</span> <span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">))</span>
      <span class="o">.</span><span class="na">baseUriVars</span><span class="o">(</span><span class="n">ImmutableMap</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&quot;include-runtime&quot;</span><span class="o">,</span><span class="s">&quot;true&quot;</span><span class="o">))</span>
      <span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="k">new</span> <span class="nf">HttpPollConfig</span><span class="o">(</span><span class="n">SERVICE_UP</span><span class="o">)</span>
          <span class="o">.</span><span class="na">onSuccess</span><span class="o">(</span><span class="n">HttpValueFunctions</span><span class="o">.</span><span class="na">responseCodeEquals</span><span class="o">(</span><span class="mi">200</span><span class="o">))</span>
          <span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">Functions</span><span class="o">.</span><span class="na">constant</span><span class="o">(</span><span class="kc">false</span><span class="o">)))</span>
      <span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="k">new</span> <span class="nf">HttpPollConfig</span><span class="o">(</span><span class="n">REQUEST_COUNT</span><span class="o">)</span>
          <span class="o">.</span><span class="na">onSuccess</span><span class="o">(</span><span class="n">HttpValueFunctions</span><span class="o">.</span><span class="na">jsonContents</span><span class="o">(</span><span class="s">&quot;requestCount&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">)))</span>
      <span class="o">.</span><span class="na">build</span><span class="o">());</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">disconnectSensors</span><span class="o">()</span> <span class="o">{</span>
  <span class="kd">super</span><span class="o">.</span><span class="na">disconnectSensors</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">feed</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">feed</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
<span class="o">}</span></code></pre></div>

<h5 id="internalLink_feeds_ssh-feed">SSH Feed</h5>

<p>An SSH feed executes a command over ssh periodically. An example is shown below:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">AbstractCommandFeed</span> <span class="n">feed</span><span class="o">;</span>

<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">connectSensors</span><span class="o">()</span> <span class="o">{</span>
  <span class="kd">super</span><span class="o">.</span><span class="na">connectSensors</span><span class="o">();</span>

  <span class="n">feed</span> <span class="o">=</span> <span class="n">feeds</span><span class="o">.</span><span class="na">addFeed</span><span class="o">(</span><span class="n">SshFeed</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
      <span class="o">.</span><span class="na">machine</span><span class="o">(</span><span class="n">mySshMachineLachine</span><span class="o">)</span>
      <span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="k">new</span> <span class="nf">CommandPollConfig</span><span class="o">(</span><span class="n">SERVICE_UP</span><span class="o">)</span>
          <span class="o">.</span><span class="na">command</span><span class="o">(</span><span class="s">&quot;rabbitmqctl -q status&quot;</span><span class="o">)</span>
          <span class="o">.</span><span class="na">onSuccess</span><span class="o">(</span><span class="k">new</span> <span class="nf">Function</span><span class="o">()</span> <span class="o">{</span>
              <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">apply</span><span class="o">(</span><span class="n">SshPollValue</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="o">(</span><span class="n">input</span><span class="o">.</span><span class="na">getExitStatus</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">);</span>
              <span class="o">}}))</span>
      <span class="o">.</span><span class="na">build</span><span class="o">());</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">disconnectSensors</span><span class="o">()</span> <span class="o">{</span>
  <span class="kd">super</span><span class="o">.</span><span class="na">disconnectSensors</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">feed</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">feed</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
<span class="o">}</span></code></pre></div>

<h5 id="internalLink_feeds_winrm-cmd-feed">WinRm CMD Feed</h5>

<p>A WinRM feed executes a windows command over winrm periodically. An example is shown below:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">AbstractCommandFeed</span> <span class="n">feed</span><span class="o">;</span>

<span class="c1">//@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">connectSensors</span><span class="o">()</span> <span class="o">{</span>
  <span class="kd">super</span><span class="o">.</span><span class="na">connectSensors</span><span class="o">();</span>

  <span class="n">feed</span> <span class="o">=</span> <span class="n">feeds</span><span class="o">.</span><span class="na">addFeed</span><span class="o">(</span><span class="n">CmdFeed</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">entity</span><span class="o">(</span><span class="n">entity</span><span class="o">)</span>
                <span class="o">.</span><span class="na">machine</span><span class="o">(</span><span class="n">machine</span><span class="o">)</span>
                <span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="k">new</span> <span class="n">CommandPollConfig</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(</span><span class="n">SENSOR_STRING</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">command</span><span class="o">(</span><span class="s">&quot;ipconfig&quot;</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">onSuccess</span><span class="o">(</span><span class="n">SshValueFunctions</span><span class="o">.</span><span class="na">stdout</span><span class="o">()))</span>
                <span class="o">.</span><span class="na">build</span><span class="o">());</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">disconnectSensors</span><span class="o">()</span> <span class="o">{</span>
  <span class="kd">super</span><span class="o">.</span><span class="na">disconnectSensors</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">feed</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">feed</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
<span class="o">}</span></code></pre></div>

<h5 id="internalLink_feeds_windows-performance-counter-feed">Windows Performance Counter Feed</h5>

<p>This type of feed retrieves performance counters from a Windows host, and posts the values to sensors.</p>

<p>One must supply a collection of mappings between Windows performance counter names and Brooklyn 
attribute sensors.</p>

<p>This feed uses WinRM to invoke the windows utility <tt>typeperf</tt> to query for a specific set 
of performance counters, by name. The values are extracted from the response, and published to the
entity’s sensors. An example is shown below:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">WindowsPerformanceCounterFeed</span> <span class="n">feed</span><span class="o">;</span>

<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">connectSensors</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">feed</span> <span class="o">=</span> <span class="n">feeds</span><span class="o">.</span><span class="na">addFeed</span><span class="o">(</span><span class="n">WindowsPerformanceCounterFeed</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
      <span class="o">.</span><span class="na">addSensor</span><span class="o">(</span><span class="s">&quot;\\Processor(_total)\\% Idle Time&quot;</span><span class="o">,</span> <span class="n">CPU_IDLE_TIME</span><span class="o">)</span>
      <span class="o">.</span><span class="na">addSensor</span><span class="o">(</span><span class="s">&quot;\\Memory\\Available MBytes&quot;</span><span class="o">,</span> <span class="n">AVAILABLE_MEMORY</span><span class="o">)</span>
      <span class="o">.</span><span class="na">build</span><span class="o">());</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">disconnectSensors</span><span class="o">()</span> <span class="o">{</span>
  <span class="kd">super</span><span class="o">.</span><span class="na">disconnectSensors</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">feed</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">feed</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
<span class="o">}</span></code></pre></div>

<h5 id="internalLink_feeds_jmx-feed">JMX Feed</h5>

<p>This type of feed queries over JMX to retrieve sensor values. This can query attribute
values or call operations.</p>

<p>The JMX connection details can be automatically inferred from the entity’s standard attributes,
or it can be explicitly supplied.</p>

<p>An example is shown below:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">JmxFeed</span> <span class="n">feed</span><span class="o">;</span>

<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">connectSensors</span><span class="o">()</span> <span class="o">{</span>
  <span class="kd">super</span><span class="o">.</span><span class="na">connectSensors</span><span class="o">();</span>

  <span class="n">feed</span> <span class="o">=</span> <span class="n">feeds</span><span class="o">().</span><span class="na">addFeed</span><span class="o">(</span><span class="n">JmxFeed</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
      <span class="o">.</span><span class="na">period</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)</span>
      <span class="o">.</span><span class="na">pollAttribute</span><span class="o">(</span><span class="k">new</span> <span class="n">JmxAttributePollConfig</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;(</span><span class="n">ERROR_COUNT</span><span class="o">)</span>
          <span class="o">.</span><span class="na">objectName</span><span class="o">(</span><span class="n">requestProcessorMbeanName</span><span class="o">)</span>
          <span class="o">.</span><span class="na">attributeName</span><span class="o">(</span><span class="s">&quot;errorCount&quot;</span><span class="o">))</span>
      <span class="o">.</span><span class="na">pollAttribute</span><span class="o">(</span><span class="k">new</span> <span class="n">JmxAttributePollConfig</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;(</span><span class="n">SERVICE_UP</span><span class="o">)</span>
          <span class="o">.</span><span class="na">objectName</span><span class="o">(</span><span class="n">serverMbeanName</span><span class="o">)</span>
          <span class="o">.</span><span class="na">attributeName</span><span class="o">(</span><span class="s">&quot;Started&quot;</span><span class="o">)</span>
          <span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">Functions</span><span class="o">.</span><span class="na">constant</span><span class="o">(</span><span class="kc">false</span><span class="o">)))</span>
      <span class="o">.</span><span class="na">build</span><span class="o">());</span>
<span class="o">}</span>

<span class="n">Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">disconnectSensors</span><span class="o">()</span> <span class="o">{</span>
  <span class="kd">super</span><span class="o">.</span><span class="na">disconnectSensors</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">feed</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">feed</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
<span class="o">}</span></code></pre></div>

<h5 id="internalLink_feeds_function-feed">Function Feed</h5>

<p>This type of feed periodically executes something to compute the attribute values. This 
can be a <code>Callable</code>, <code>Supplier</code> or Groovy <code>Closure</code>. It must be persistable (e.g. not use 
an in-line anonymous inner classes).</p>

<p>An example is shown below:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ErrorCountRetriever</span> <span class="kd">implements</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Entity</span> <span class="n">entity</span><span class="o">;</span>
  
  <span class="kd">public</span> <span class="nf">ErrorCountRetriever</span><span class="o">(</span><span class="n">Entity</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">entity</span> <span class="o">=</span> <span class="n">entity</span><span class="o">;</span>
  <span class="o">}</span>
  
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="c1">// TODO your implementation...</span>
    <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="n">FunctionFeed</span> <span class="n">feed</span><span class="o">;</span>

<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">connectSensors</span><span class="o">()</span> <span class="o">{</span>
  <span class="kd">super</span><span class="o">.</span><span class="na">connectSensors</span><span class="o">();</span>

  <span class="n">feed</span> <span class="o">=</span> <span class="n">feeds</span><span class="o">().</span><span class="na">addFeed</span><span class="o">(</span><span class="n">FunctionFeed</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="k">new</span> <span class="n">FunctionPollConfig</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;(</span><span class="n">ERROR_COUNT</span><span class="o">)</span>
        <span class="o">.</span><span class="na">period</span><span class="o">(</span><span class="mi">500</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">)</span>
        <span class="o">.</span><span class="na">callable</span><span class="o">(</span><span class="k">new</span> <span class="nf">ErrorCountRetriever</span><span class="o">(</span><span class="k">this</span><span class="o">))</span>
        <span class="o">.</span><span class="na">onExceptionOrFailure</span><span class="o">(</span><span class="n">Functions</span><span class="o">.&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="n">constant</span><span class="o">(</span><span class="kc">null</span><span class="o">))</span>
    <span class="o">.</span><span class="na">build</span><span class="o">());</span>
<span class="o">}</span>
 
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">disconnectSensors</span><span class="o">()</span> <span class="o">{</span>
  <span class="kd">super</span><span class="o">.</span><span class="na">disconnectSensors</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">feed</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">feed</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
<span class="o">}</span></code></pre></div>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-writing-an-entity" class="section-breaker section p-">
	<span style="width: 100%"><h1>Writing an Entity</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_writing-an-entity_ways-to-write-an-entity">Ways to write an entity</h2>

<p>There are several ways to write a new entity:</p>

<ul>
  <li>For Unix/Linux, write YAML blueprints, for example using a <strong><code>VanillaSoftwareProcess</code></strong> and 
configuring it with your scripts.</li>
  <li>For Windows, write YAML blueprints using <strong><code>VanillaWindowsProcess</code></strong> and configure the PowerShell
scripts.</li>
  <li>For composite entities, use YAML to compose exiting types of entities (potentially overwriting
parts of their configuration), and wire them together.</li>
  <li>Use <strong><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/blueprints/chef">Chef recipes</a></strong>.</li>
  <li>Use <strong><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/blueprints/salt">Salt formulas</a></strong>.</li>
  <li>Use <strong><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/blueprints/ansible">Ansible playbooks</a></strong>.</li>
  <li>Write pure-java, extending existing base-classes. For example, the <code>GistGenerator</code> 
<a href="#contentsLink-defining-and-deploying">example</a>. These can use utilities such as <code>HttpTool</code> and 
<code>BashCommands</code>.</li>
  <li>Write pure-Java blueprints that extend <code>SoftwareProcess</code>. However, the YAML approach is strongly
recommended over this approach.</li>
  <li>Write pure-Java blueprints that compose together existing entities, for example to manage
a cluster. Often this is possible in YAML and that approach is strongly recommended. However,
sometimes the management logic may be so complex that it is easier to use Java.</li>
</ul>

<p>The rest of this section covers writing an entity in pure-java (or other JVM languages).</p>

<h2 id="internalLink_writing-an-entity_things-to-know">Things To Know</h2>

<p>All entities have an interface and an implementation. The methods on the interface 
are its effectors; the interface also defines its sensors.</p>

<p>Entities are created through the management context (rather than calling the<br />
constructor directly). This returns a proxy for the entity rather than the real 
instance, which is important in a distributed management plane.</p>

<p>All entity implementations inherit from <code>AbstractEntity</code>, often through one of the following:</p>

<ul>
  <li><strong><code>SoftwareProcessImpl</code></strong>:  if it’s a software process</li>
  <li><strong><code>VanillaJavaAppImpl</code></strong>:  if it’s a plain-old-java app</li>
  <li><strong><code>JavaWebAppSoftwareProcessImpl</code></strong>:  if it’s a JVM-based web-app</li>
  <li><strong><code>DynamicClusterImpl</code></strong>, <strong><code>DynamicGroupImpl</code></strong> or <strong><code>AbstractGroupImpl</code></strong>:  if it’s a collection of other entities</li>
</ul>

<p>Software-based processes tend to use <em>drivers</em> to install and
launch the remote processes onto <em>locations</em> which support that driver type.
For example, <code>AbstractSoftwareProcessSshDriver</code> is a common driver superclass,
targetting <code>SshMachineLocation</code> (a machine to which Brooklyn can ssh).
The various <code>SoftwareProcess</code> entities above (and some of the exemplars 
listed at the end of this page) have their own dedicated drivers.</p>

<p>Finally, there are a collection of <em>traits</em>, such as <code>Resizable</code>, 
in the package <code>brooklyn.entity.trait</code>. These provide common
sensors and effectors on entities, supplied as interfaces.
Choose one (or more) as appropriate.</p>

<h2 id="internalLink_writing-an-entity_key-steps">Key Steps</h2>

<p><em>NOTE: Consider instead writing a YAML blueprint for your entity.</em></p>

<p>So to get started:</p>

<ol>
  <li>Create your entity interface, extending the appropriate selection from above,
to define the effectors and sensors.</li>
  <li>Include an annotation like <code>@ImplementedBy(YourEntityImpl.class)</code> on your interface,
where <code>YourEntityImpl</code> will be the class name for your entity implementation.</li>
  <li>Create your entity class, implementing your entity interface and extending the 
classes for your chosen entity super-types. Naming convention is a suffix “Impl”
for the entity class, but this is not essential.</li>
  <li>Create a driver interface, again extending as appropriate (e.g. <code>SoftwareProcessDriver</code>).
The naming convention is to have a suffix “Driver”. </li>
  <li>Create the driver class, implementing your driver interface, and again extending as appropriate.
Naming convention is to have a suffix “SshDriver” for an ssh-based implementation.
The correct driver implementation is found using this naming convention, or via custom
namings provided by the <code>BasicEntityDriverFactory</code>.</li>
  <li>Wire the <code>public Class getDriverInterface()</code> method in the entity implementation, to specify
your driver interface.</li>
  <li>Provide the implementation of missing lifecycle methods in your driver class (details below)</li>
  <li>Connect the sensors from your entity (e.g. overriding <code>connectSensors()</code> of <code>SoftwareProcessImpl</code>)..
See the sensor feeds, such as <code>HttpFeed</code> and <code>JmxFeed</code>.</li>
</ol>

<p>Any JVM language can be used to write an entity. However use of pure Java is encouraged for
entities in core brooklyn. </p>

<h2 id="internalLink_writing-an-entity_helpful-references">Helpful References</h2>

<p>A few handy pointers will help make it easy to build your own entities.
Check out some of the exemplar existing entities
(note, some of the other entities use deprecated utilities and a deprecated class 
hierarchy; it is suggested to avoid these, looking at the ones below instead):</p>

<ul>
  <li><code>JBoss7Server</code></li>
  <li><code>MySqlNode</code></li>
</ul>

<p>You might also find the following helpful:</p>

<ul>
  <li><strong><a href="#contentsLink-miscellaneous-tips-and-tricks">Entity Design Tips</a></strong></li>
  <li>The <strong><a href="http://brooklyn.apache.org/v/0.10.0/v/latest">User Guide</a></strong></li>
  <li>The <strong><a href="https://mail-archives.apache.org/mod_mbox/brooklyn-dev/">Mailing List</a></strong></li>
</ul>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-custom-entity-development" class="section-breaker section p-">
	<span style="width: 100%"><h1>Custom Entity Development</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>This section details how to create new custom application components or groups as brooklyn entities.</p>

<h2 id="internalLink_custom-entity-development_the-entity-lifecycle">The Entity Lifecycle</h2>

<ul>
  <li>Importance of serialization, ref to How mananagement works</li>
  <li>Parents and Membership (groups)</li>
</ul>

<h2 id="internalLink_custom-entity-development_what-to-extend----implementation-classes">What to Extend – Implementation Classes</h2>

<ul>
  <li>
    <p>entity implementation class hierarchy</p>

    <ul>
      <li><code>SoftwareProcess</code> as the main starting point for base entities (corresponding to software processes),
and subclasses such as <code>VanillaJavaApp</code></li>
      <li><code>DynamicCluster</code> (multiple instances of the same entity in a location) and 
<code>DynamicFabric</code> (clusters in multiple location) for automatically creating many instances,
supplied with an <code>EntityFactory</code> (e.g. <code>BaseEntityFactory</code>) in the <code>factory</code> flag</li>
      <li><code>AbstractGroup</code> for collecting entities which are parented elsewhere in the hierachy</li>
      <li><code>AbstractEntity</code> if nothing else fits</li>
    </ul>
  </li>
  <li>
    <p>traits (mixins, otherwise known as interfaces with statics) to define available config keys, sensors, and effectors;
  and conveniences e.g. <code>StartableMethods.{start,stop}</code> is useful for entities which implement <code>Startable</code></p>
  </li>
  <li>
    <p>the <code>Entities</code> class provides some generic convenience methods; worth looking at it for any work you do</p>
  </li>
</ul>

<p>A common lifecycle pattern is that the <code>start</code> effector (see more on effectors below) is invoked, 
often delegating either to a driver (for software processes) or children entities (for clusters etc).</p>

<h2 id="internalLink_custom-entity-development_configuration">Configuration</h2>
<!---
TODO: why to use config?
-->

<ul>
  <li>
    <p>AttributeSensorAndConfigKey fields can be automatically converted for <code>SoftwareProcess</code>. 
This is done in <code>preStart()</code>. This must be done manually if required for other entities,
often with <code>ConfigToAttributes.apply(this)</code>.</p>
  </li>
  <li>
    <p>Setting ports is a special challenge, and one which the <code>AttributeSensorAndConfigKey</code> is particularly helpful for,
cf <code>PortAttributeSensorAndConfigKey</code> (a subclass),
causing ports automatically get assigned from a range and compared with the target <code>PortSupplied</code> location.</p>

    <p>Syntax is as described in the PortRange interface. For example, “8080-8099,8800+” will try port 8080, try sequentially through 8099, then try from 8800 until all ports are exhausted.</p>

    <p>This is particularly useful on a contended machine (localhost!). Like ordinary configuration, the config is done by the user, and the actual port used is reported back as a sensor on the entity.</p>
  </li>
  <li>
    <p>Validation of config values can be applied by supplying a <code>Predicate</code> to the <code>constraint</code> of a ConfigKey builder.
Constraints are tested after an entity is initialised and before an entity managed.
Useful predicates include:</p>
    <ul>
      <li><code>StringPredicates.isNonBlank</code>: require that a String key is neither null nor empty.</li>
      <li><code>ResourcePredicates.urlExists</code>: require that a URL that is loadable by Brooklyn. Use this to
confirm that necessary resources are available to the entity.</li>
      <li><code>Predicates.in</code>: require one of a fixed set of values.</li>
      <li><code>Predicates.containsPattern</code>: require that a value match a regular expression pattern.</li>
    </ul>

    <p>An important caveat is that only constraints on config keys that are on an entity’s type hierarchy can be
tested automatically. Brooklyn has no knowledge of the true type of other keys until they are retrieved with a
<code>config().get(key)</code>.</p>
  </li>
</ul>

<h2 id="internalLink_custom-entity-development_implementing-sensors">Implementing Sensors</h2>

<ul>
  <li>e.g. HTTP, JMX</li>
</ul>

<p>Sensors at base entities are often retrieved by feeds which poll the entity’s corresponding instance in the real world.
The <code>SoftwareProcess</code> provides a good example; by subclassing it and overriding the <code>connectSensors()</code> method
you could wire some example sensors using the following: </p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">connectSensors</span><span class="o">()</span> <span class="o">{</span>
	<span class="kd">super</span><span class="o">.</span><span class="na">connectSensors</span><span class="o">()</span>
	
    <span class="n">httpFeed</span> <span class="o">=</span> <span class="n">HttpFeed</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">entity</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
            <span class="o">.</span><span class="na">period</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
            <span class="o">.</span><span class="na">baseUri</span><span class="o">(</span><span class="n">mgmtUrl</span><span class="o">)</span>
            <span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpPollConfig</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;(</span><span class="n">SERVICE_UP</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">onSuccess</span><span class="o">(</span><span class="n">HttpValueFunctions</span><span class="o">.</span><span class="na">responseCodeEquals</span><span class="o">(</span><span class="mi">200</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">Functions</span><span class="o">.</span><span class="na">constant</span><span class="o">(</span><span class="kc">false</span><span class="o">)))</span>
            <span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpPollConfig</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;(</span><span class="n">REQUEST_COUNT</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">onSuccess</span><span class="o">(</span><span class="n">HttpValueFunctions</span><span class="o">.</span><span class="na">jsonContents</span><span class="o">(</span><span class="s">&quot;requestCount&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">)))</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
    
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">disconnectSensors</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">disconnectSensors</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">httpFeed</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">httpFeed</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
<span class="o">}</span></code></pre></div>

<p>In this example (a simplified version of <code>JBoss7Server</code>), the url returns metrics in JSON. 
We report the entity as up if we get back an http response code of 200, or down if any other response code or exception.
We retrieve the request count from the response body, and convert it to an integer.</p>

<p>Note the first line (<code>super.connectSensors()</code>); as one descends into specific convenience subclasses (such as for Java web-apps), the work done by the parent class’s overridden methods may be relevant, and will want to be invoked or even added to a resulting list.</p>

<p>For some sensors, and often at compound entities, the values are obtained by monitoring values of other sensors on the same (in the case of a rolling average) or different (in the case of the average of children nodes) entities. This is achieved by policies, described below.</p>

<h2 id="internalLink_custom-entity-development_implementing-effectors">Implementing Effectors</h2>

<p>The <code>Entity</code> interface defines the sensors and effectors available. The entity class provides 
wiring for the sensors, and the effector implementations. In simple cases it may be straightforward 
to capture the behaviour of the effectors in a simple methods.
For example deploying a WAR to a cluster can be done as follows:</p>

<p><em>This section is not complete. Feel free to <a href="https://github.com/apache/brooklyn-docs">fork</a> the docs and lend a hand.</em></p>

<!---
TODO show an effector which recurses across children
-->

<p>For some entities, specifically base entities, the implementation of effectors might need other tools (such as SSH), and may vary by location, so having a single implementation is not appropriate.</p>

<p>The problem of multiple inheritance (e.g. SSH functionality and entity inheritance) and multiple implementations (e.g. SSH versus Windows) is handled in brooklyn using delegates called <em>drivers</em>. </p>

<p>In the implementations of <code>JavaWebApp</code> entities, the behaviour which the entity always does is captured in the entity class (for example, breaking deployment of multiple WARs into atomic actions), whereas implementations which is specific to a particular entity and driver (e.g. using scp to copy the WARs to the right place and install them, which of course is different among appservers, or using an HTTP or JMX management API, again where details vary between appservers) is captured in a driver class.</p>

<p>Routines which are convenient for specific drivers can then be inherited in the driver class hierarchy. For example, when passing JMX environment variables to Java over SSH, <code>JavaSoftwareProcessSshDriver</code> extends <code>AbstractSoftwareProcessSshDriver</code> and parents <code>JBoss7SshDriver</code>.</p>

<!---
TODO more drivers such as jmx, etc are planned
-->

<h2 id="internalLink_custom-entity-development_testing">Testing</h2>

<ul>
  <li>Unit tests can make use of <code>SimulatedLocation</code> and <code>TestEntity</code>, and can extend <code>BrooklynAppUnitTestSupport</code>.</li>
  <li>Integration tests and use a <code>LocalhostMachineProvisioningLocation</code>, and can also extend <code>BrooklynAppUnitTestSupport</code>.</li>
</ul>

<p><a name="SoftwareProcess-lifecycle"></a></p>

<h2 id="internalLink_custom-entity-development_softwareprocess-lifecycle">SoftwareProcess Lifecycle</h2>

<p><code>SoftwareProcess</code> is the common super-type of most integration components (when implementing in Java).</p>

<p>See <code>JBoss7Server</code> and <code>MySqlNode</code> for exemplars.</p>

<p>The methods called in a <code>SoftwareProcess</code> entity’s lifecycle are described below. The most important steps are shown in bold (when writing a new entity, these are the methods most often implemented).</p>

<ul>
  <li>Initial creation (via <code>EntitySpec</code> or YAML):
    <ul>
      <li><strong>no-arg constructor</strong></li>
      <li><strong>init</strong></li>
      <li>add locations</li>
      <li>apply initializers</li>
      <li>add enrichers</li>
      <li>add policies</li>
      <li>add children</li>
      <li>manages entity (so is discoverable by other entities)</li>
    </ul>
  </li>
  <li>Start:
    <ul>
      <li>provisions new machine, if the location is a <code>MachineProvisioningLocation</code></li>
      <li>creates new driver
        <ul>
          <li><strong>calls <code>getDriverInterface</code></strong></li>
          <li>Infers the concrete driver class from the machine-type, 
e.g. by default it adds “Ssh” before the word “Driver” in “JBoss7Driver”.</li>
          <li>instantiates the driver, <strong>calling the constructor</strong> to pass in the entity itself and the machine location</li>
        </ul>
      </li>
      <li>sets attributes from config (e.g. for ports being used)</li>
      <li>calls <code>entity.preStart()</code></li>
      <li>calls <code>driver.start()</code>, which:
        <ul>
          <li>runs pre-install command (see config key <code>pre.install.command</code>)</li>
          <li>uploads install resources (see config keys <code>files.install</code> and <code>templates.install</code>)</li>
          <li><strong>calls <code>driver.install()</code></strong></li>
          <li>runs post-install command (see config key <code>post.install.command</code>)</li>
          <li><strong>calls <code>driver.customize()</code></strong></li>
          <li>uploads runtime resources (see config keys <code>files.runtime</code> and <code>templates.runtime</code>)</li>
          <li>runs pre-launch command (see config key <code>pre.launch.command</code>)</li>
          <li><strong>calls <code>driver.launch()</code></strong></li>
          <li>runs post-launch command (see config key <code>post.launch.command</code>)</li>
          <li>calls <code>driver.postLaunch()</code></li>
        </ul>
      </li>
      <li>calls <code>entity.postDriverStart()</code>, which:
        <ul>
          <li>calls <code>enity.waitForEntityStart()</code> - <strong>waits for <code>driver.isRunning()</code> to report true</strong></li>
        </ul>
      </li>
      <li><strong>calls <code>entity.connectSensors()</code></strong></li>
      <li>calls <code>entity.waitForServicUp()</code></li>
      <li>calls <code>entity.postStart()</code></li>
    </ul>
  </li>
  <li>Restart:
    <ul>
      <li>If restarting machine…
        <ul>
          <li>calls <code>entity.stop()</code>, with <code>stopMachine</code> set to true.</li>
          <li>calls start</li>
          <li>restarts children (if configured to do so)</li>
        </ul>
      </li>
      <li>Else (i.e. not restarting machine)…
        <ul>
          <li>calls <code>entity.preRestart()</code></li>
          <li>calls <code>driver.restart()</code>
            <ul>
              <li><strong>calls <code>driver.stop()</code></strong></li>
              <li><strong>calls <code>driver.launch()</code></strong></li>
              <li>calls <code>driver.postLaunch()</code></li>
            </ul>
          </li>
          <li>restarts children (if configured to do so)</li>
          <li>calls <code>entity.postDriverStart()</code>, which:
            <ul>
              <li>calls <code>enity.waitForEntityStart()</code> - <strong>polls <code>driver.isRunning()</code></strong>, waiting for true</li>
            </ul>
          </li>
          <li>calls <code>entity.waitForServicUp()</code></li>
          <li>calls <code>entity.postStart()</code></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Stop:
    <ul>
      <li>calls <code>entity.preStopConfirmCustom()</code> - aborts if exception.</li>
      <li>calls <code>entity.preStop()</code></li>
      <li>stops the process:
        <ul>
          <li>stops children (if configured to do so)</li>
          <li><strong>calls <code>driver.stop()</code></strong></li>
        </ul>
      </li>
      <li>stops the machine (if configured to do so)</li>
      <li>calls <code>entity.postStop()</code></li>
    </ul>
  </li>
  <li>Rebind (i.e. when Brooklyn is restarted):
    <ul>
      <li><strong>no-arg constructor</strong></li>
      <li>reconstitutes entity (e.g. setting config and attributes)</li>
      <li>If entity was running…
        <ul>
          <li>calls <code>entity.rebind()</code>; if previously started then:
            <ul>
              <li>creates the driver (same steps as for start)</li>
              <li>calls <code>driver.rebind()</code></li>
              <li><strong>calls <code>entity.connectSensors()</code></strong></li>
            </ul>
          </li>
        </ul>
      </li>
      <li>attaches policies, enrichers and persisted feeds</li>
      <li>manages the entity (so is discoverable by other entities)</li>
    </ul>
  </li>
</ul>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-service-state" class="section-breaker section p-">
	<span style="width: 100%"><h1>Service State</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Any entity can use the standard “service-up” and “service-state” 
sensors to inform other entities and the GUI about its status.</p>

<p>In normal operation, entities should publish at least one “service not-up indicator”,
using the <code>ServiceNotUpLogic.updateNotUpIndicator</code> method.  Each such indicator should have
a unique name or input sensor.  <code>Attributes.SERVICE_UP</code> will then be updated automatically
when there are no not-up indicators.</p>

<p>When there are transient problems that can be detected, to trigger <code>ON_FIRE</code> status
entity code can similarly set <code>ServiceProblemsLogic.updateProblemsIndicator</code> with a unique namespace,
and subsequently clear it when the problem goes away.
These problems are reflected at runtime in the <code>SERVICE_PROBLEMS</code> sensor,
allowing multiple problems to be tracked independently.</p>

<p>When an entity is changing the expected state, e.g. starting or stopping,
the expected state can be set using <code>ServiceStateLogic.setExpectedState</code>;
this expected lifecycle state is considered together with <code>SERVICE_UP</code> and <code>SERVICE_PROBLEMS</code>
to compute the actual state.  By default the logic in <code>ComputeServiceState</code> is applied.</p>

<p>For common entities, good out-of-the-box logic is applied, as follows:</p>

<ul>
  <li>
    <p>For <code>SoftwareProcess</code> entities, lifecycle service state is updated by the framework
and a service not-up indicator is linked to the driver <code>isRunning()</code> check.</p>
  </li>
  <li>
    <p>For common parents, including <code>AbstractApplication</code> and <code>AbstractGroup</code> subclasses (including clusters, fabrics, etc),
the default enrichers analyse children and members to set a not-up indicator
(requiring at least one child or member who is up) and a problem indicator
(if any children or members are on-fire).
In some cases other quorum checks are preferable; this can be set e.g. by overriding 
the <code>UP_QUORUM_CHECK</code> or the <code>RUNNING_QUORUM_CHECK</code>, as follows:</p>

    <pre><code>public static final ConfigKey&lt;QuorumCheck&gt; UP_QUORUM_CHECK = ConfigKeys.newConfigKeyWithDefault(AbstractGroup.UP_QUORUM_CHECK, 
    "Require all children and members to be up for this node to be up",
    QuorumChecks.all());
</code></pre>

    <p>Alternatively the <code>initEnrichers()</code> method can be overridden to specify a custom-configured
enricher or set custom config key values (as done e.g. in <code>DynamicClusterImpl</code> so that
zero children is permitted provided when the initial size is configured to be 0).</p>
  </li>
</ul>

<p>For sample code to set and more information on these methods’ behaviours,
see javadoc in <code>ServiceStateLogic</code>,
overrides of <code>AbstractEntity.initEnrichers()</code>
and tests in <code>ServiceStateLogicTests</code>.</p>

<!-- TODO include more documentation, sample code (ideally extracted on the fly from test cases so we know it works!) -->

<h2 id="internalLink_service-state_notes-on-advanced-use">Notes on Advanced Use</h2>

<p>The enricher to derive <code>SERVICE_UP</code> and <code>SERVICE_STATE_ACTUAL</code> from the maps and expected state values discussed above
is added by the <code>AbstractEntity.initEnrichers()</code> method.
This method can be overridden – or excluded altogether by by overriding <code>init()</code> –
and can add enrichers created using the <code>ServiceStateLogic.newEnricherFromChildren()</code> method
suitably customized using methods on the returned spec object, for instance to look only at members
or specify a quorum function (from <code>QuorumChecks</code>). 
If different logic is required for computing <code>SERVICE_UP</code> and <code>SERVICE_STATE_ACTUAL</code>,
use <code>ServiceStateLogic.newEnricherFromChildrenState()</code> and <code>ServiceStateLogic.newEnricherFromChildrenUp()</code>,
noting that the first of these will replace the enricher added by the default <code>initEnrichers()</code>,
whereas the second one runs with a different namespace (unique tag).
For more information consult the javadoc on those classes.</p>

<p>Entities can set <code>SERVICE_UP</code> and <code>SERVICE_STATE_ACTUAL</code> directly.
Provided these entities never use the <code>SERVICE_NOT_UP_INDICATORS</code> and <code>SERVICE_PROBLEMS</code> map,
the default enrichers will not override these values.</p>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-entitlements" class="section-breaker section p-">
	<span style="width: 100%"><h1>Entitlements</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Brooklyn supports a plug-in system for defining “entitlements” – 
essentially permissions.</p>

<p>Any entitlement scheme can be implemented by supplying a class which implements one method on one class:</p>

<pre><code>public interface EntitlementManager {
  public &lt;T&gt; boolean isEntitled(@Nullable EntitlementContext context, @Nonnull EntitlementClass&lt;T&gt; entitlementClass, @Nullable T entitlementClassArgument);
}
</code></pre>

<p>This answers the question who is allowed do what to whom, looking at the following fields:</p>

<ul>
  <li><code>context</code>: the user who is logged in and is attempting an action
(extensions can contain additional metadata)</li>
  <li><code>entitlementClass</code>: the type of action being queried, e.g. <code>DEPLOY_APPLICATION</code> or <code>SEE_SENSOR</code>
(declared in the class <code>Entitlements</code>)</li>
  <li><code>entitlementClassArgument</code>: details of the action being queried,
such as the blueprint in the case of <code>DEPLOY_APPLICATION</code> or the entity and sensor name in the case
of <code>SEE_SENSOR</code></li>
</ul>

<p>To set a custom entitlements manager to apply across the board, simply use:</p>

<pre><code>brooklyn.entitlements.global=org.apache.brooklyn.core.mgmt.entitlement.AcmeEntitlementManager
</code></pre>

<p>The example above refers to a sample manager which is included in the test JARs of Brooklyn,
which you can see <a href="https://github.com/apache/brooklyn-server/tree/master/core/src/test/java/org/apache/brooklyn/core/mgmt/entitlement/AcmeEntitlementManagerTest.java">here</a>,
and include in your project by adding the core tests JAR to your <code>dropins</code> folder.</p>

<p>There are some entitlements schemes which exist out of the box, so for a simpler setup,
see <a href="#contentsLink-brooklyn.properties">Operations: Entitlements</a>. </p>

<p>There are also more complex schemes which some users have developed, including LDAP extensions 
which re-use the LDAP authorization support in Brooklyn, 
allowing permissions objects to be declared in LDAP leveraging regular expressions.
For more information on this, ask on IRC or the mailing list,
and see 
<code>EntitlementManager</code>
  (<a href="https://github.com/apache/brooklyn-server/tree/master/api/src/main/java/org/apache/brooklyn/api/mgmt/entitlement/EntitlementManager.java">src</a>)
.</p>


	</div>
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-windows-blueprints" class="section-breaker section p-">
	<span style="width: 100%"><h1>Windows Blueprints</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Brooklyn can deploy to Windows servers using WinRM to run commands. These deployments can be 
expressed in pure YAML, and utilise Powershell to install and manage the software process. 
This approach is similar to the use of SSH for UNIX-like servers.</p>

<h2 id="internalLink_windows-blueprints_about-winrm">About WinRM</h2>

<p>WinRM - or <em>Windows Remote Management</em> to give its full title - is a system administration service provided in all
recent Windows Server operating systems. It allows remote access to system information (provided via WMI) and the
ability to execute commands. For more information refer to <a href="https://msdn.microsoft.com/en-us/library/aa384426(v=vs.85).aspx">Microsoft’s MSDN article on Windows Remote
Management</a>.</p>

<p>WinRM is available by default in Windows Server, but is not enabled by default. Brooklyn will, in most cases, be able
to switch on WinRM support, but this is dependent on your cloud provider supporting a user metadata service with script
execution (see <a href="#internalLink_windows-blueprints_user-metadata-service-requirement">below</a>).</p>

<h2 id="internalLink_windows-blueprints_locations-for-windows">Locations for Windows</h2>

<p>You must define a new location in Brooklyn for Windows deployments. Windows deployments require a different VM image
ID to Linux, as well as some other special configuration, so you must have separate Brooklyn locations for Windows and
Linux deployments.</p>

<p>In particular, you will most likely want to set these properties on your location:</p>

<ul>
  <li><code>imageId</code> or <code>imageNameRegex</code> - select your preferred Windows Server image from your cloud provider.</li>
  <li><code>hardwareId</code> or <code>minRam</code>/<code>minCores</code> - since Windows machines generally require more powerful servers, ensure you get
a machine with the required specification.</li>
  <li><code>useJcloudsSshInit</code> - this must be set to <code>false</code>. Without this setting, jclouds will attempt to connect to the new
VMs using SSH, which will fail on Windows Server.</li>
  <li><code>templateOptions</code> - you may also wish to request a larger disk size. This setting is cloud specific; on AWS, you can
request a 100GB disk by setting this property to <code>{mapNewVolumeToDeviceName: ["/dev/sda1", 100, true]}</code>.</li>
</ul>

<p>In your YAML blueprint:</p>

<pre><code>...
location:
  jclouds:aws-ec2:
    region: us-west-2
    identity: AKA_YOUR_ACCESS_KEY_ID
    credential: &lt;access-key-hex-digits&gt;
    imageNameRegex: Windows_Server-2012-R2_RTM-English-64Bit-Base-.*
    imageOwner: 801119661308
    hardwareId: m3.medium
    useJcloudsSshInit: false
    templateOptions: {mapNewVolumeToDeviceName: ["/dev/sda1", 100, true]}
...
</code></pre>

<p>Alternatively, you can define a new named location in <code>brooklyn.properties</code>:</p>

<pre><code>brooklyn.location.named.AWS\ Oregon\ Win = jclouds:aws-ec2:us-west-2
brooklyn.location.named.AWS\ Oregon\ Win.displayName = AWS Oregon (Windows)
brooklyn.location.named.AWS\ Oregon\ Win.imageNameRegex = Windows_Server-2012-R2_RTM-English-64Bit-Base-.*
brooklyn.location.named.AWS\ Oregon\ Win.imageOwner = 801119661308
brooklyn.location.named.AWS\ Oregon\ Win.hardwareId = m3.medium
brooklyn.location.named.AWS\ Oregon\ Win.useJcloudsSshInit = false
brooklyn.location.named.AWS\ Oregon\ Win.templateOptions = {mapNewVolumeToDeviceName: ["/dev/sda1", 100, true]}
</code></pre>

<h2 id="internalLink_windows-blueprints_a-sample-blueprint">A Sample Blueprint</h2>

<p>Creating a Windows VM is done using the <code>org.apache.brooklyn.entity.software.base.VanillaWindowsProcess</code> entity type. This is very similar
to <code>VanillaSoftwareProcess</code>, but adapted to work for Windows and WinRM instead of Linux. We suggest you read the
<a href="#contentsLink-custom-entities">documentation for VanillaSoftwareProcess</a> to find out what you
can do with this entity.</p>

<p>Entity authors are strongly encouraged to write Windows Powershell or Batch scripts as separate 
files, to configure these to be uploaded, and then to configure the appropriate command as a 
single line that executes given script.</p>

<p>For example - here is a simplified blueprint (but see <a href="#internalLink_windows-blueprints_tips-and-tricks">Tips and Tricks</a> below!):</p>

<pre><code>name: Server with 7-Zip

location:
  jclouds:aws-ec2:
    region: us-west-2
    identity: AKA_YOUR_ACCESS_KEY_ID
    credential: &lt;access-key-hex-digits&gt;
    imageNameRegex: Windows_Server-2012-R2_RTM-English-64Bit-Base-.*
    imageOwner: 801119661308
    hardwareId: m3.medium
    useJcloudsSshInit: false
    templateOptions: {mapNewVolumeToDeviceName: ["/dev/sda1", 100, true]}

services:
- type: org.apache.brooklyn.entity.software.base.VanillaWindowsProcess
  brooklyn.config:
    templates.preinstall:
      file:///Users/richard/install7zip.ps1: "C:\\install7zip.ps1"
    install.command: powershell -command "C:\\install7zip.ps1"
    customize.command: echo true
    launch.command: echo true
    stop.command: echo true
    checkRunning.command: echo true
    installer.download.url: http://www.7-zip.org/a/7z938-x64.msi
</code></pre>

<p>The installation script - referred to as <code>/Users/richard/install7zip.ps1</code> in the example above - is:</p>

<pre><code>$Path = "C:\InstallTemp"
New-Item -ItemType Directory -Force -Path $Path

$Url = "${config['installer.download.url']}"
$Dl = [System.IO.Path]::Combine($Path, "installer.msi")
$WebClient = New-Object System.Net.WebClient
$WebClient.DownloadFile( $Url, $Dl )

Start-Process "msiexec" -ArgumentList '/qn','/i',$Dl -RedirectStandardOutput ( [System.IO.Path]::Combine($Path, "stdout.txt") ) -RedirectStandardError ( [System.IO.Path]::Combine($Path, "stderr.txt") ) -Wait
</code></pre>

<p>Where security-related operation are to be executed, it may require the use of <code>CredSSP</code> to obtain
the correct Administrator privileges: you may otherwise get an access denied error. See the sub-section 
<a href="#internalLink_windows-blueprints_how-and-why-to-re-authenticate-within-a-powershell-script">How and Why to re-authenticate within a powershell script</a> for more details.</p>

<p>This is only a very simple example. A more complex example can be found in the <a href="https://github.com/apache/brooklyn-server/tree/master/software/database/src/main/resources/org/apache/brooklyn/entity/database/mssql">Microsoft SQL Server blueprint in the
Brooklyn source code</a>.</p>

<h2 id="internalLink_windows-blueprints_tips-and-tricks">Tips and Tricks</h2>

<p>The best practices for other entities (e.g. using <a href="#contentsLink-custom-entities">VanillaSoftwareProcess</a>)
apply for WinRM as well.</p>

<h3 id="internalLink_windows-blueprints_execution-phases">Execution Phases</h3>

<p>Blueprint authors are strongly encouraged to provide an implementation for install, launch, stop 
and checkRunning. These are vital for the generic effectors such as stopping and restarting the 
process.</p>

<h3 id="internalLink_windows-blueprints_powershell">Powershell</h3>

<p>Powershell commands can be supplied using config options such as <code>launch.powershell.command</code>.</p>

<p>This is an alternative to supplying a standard batch command using config such as <code>launch.command</code>.
For a given phase, only one of the commands (Powershell or Batch) should be supplied.</p>

<h3 id="internalLink_windows-blueprints_getting-the-right-exit-codes">Getting the Right Exit Codes</h3>

<p>WinRM (or at least the chosen WinRM client!) can return a zero exit code even on error in certain 
circumstances. It is therefore advisable to follow the guidelines below.</p>

<p><em>For a given command, write the Powershell or Batch script as a separate multi-command file. 
Upload this (e.g. by including it in the <code>files.preinstall</code> configuration). For the configuration
of the given command, execute the file.</em></p>

<p>When you have a command inside the powershell script which want to report its non zero exiting, 
please consider adding a check for its exit code after it.
Example:</p>

<pre><code>&amp; "C:\install.exe"
If ($lastexitcode -ne 0) {
    exit $lastexitcode
}
</code></pre>

<p>For Powershell files, consider including </p>

<pre><code>$ErrorActionPreference = "Stop"
</code></pre>

<p>at the start of the file. 
<code>$ErrorActionPreference</code> Determines how Windows PowerShell responds to a non-terminating
error (an error that does not stop the cmdlet processing) at the
command line or in a script, cmdlet, or provider, such as the
errors generated by the Write-Error cmdlet.
https://technet.microsoft.com/en-us/library/hh847796.aspx</p>

<p>See <a href="#internalLink_windows-blueprints_incorrect-exit-codes">Incorrect Exit Codes</a> under Known Limitations below.</p>

<h3 id="internalLink_windows-blueprints_executing-scripts-from-batch-commands">Executing Scripts From Batch Commands</h3>

<p>In a batch command, you can execute a batch file or Powershell file. For example:</p>

<pre><code>install.command: powershell -NonInteractive -NoProfile -Command "C:\\install7zip.ps1"
</code></pre>

<p>Or alternatively:</p>

<pre><code>install.command: C:\\install7zip.bat
</code></pre>

<h3 id="internalLink_windows-blueprints_executing-scripts-from-powershell">Executing Scripts From Powershell</h3>

<p>In a Powershell command, you can execute a batch file or Powershell file. There are many ways
to do this (see official Powershell docs). For example:</p>

<pre><code>install.powershell.command: "&amp; C:\\install7zip.ps1"
</code></pre>

<p>Or alternatively:</p>

<pre><code>install.powershell.command: "&amp; C:\\install7zip.bat"
</code></pre>

<p>Note the quotes around the command. This is because the “&amp;” has special meaning in a YAML value. </p>

<h3 id="internalLink_windows-blueprints_uploading-script-and-configuration-files">Uploading Script and Configuration Files</h3>

<p>Often, blueprints will require that (parameterized) scripts and configuration files are available to be copied to the
target VM. These must be URLs resolvable from the Brooklyn instance, or on the Brooklyn classpath. One simple way 
to achieve this is to compile the support files into a .jar, which is then added to AMP’s ‘dropins’ folder. Alternatively, 
an OSGi bundle can be used, referenced from the catalog item. </p>

<p>Ensure that these scripts end each line with “\r\n”, rather than just “\n”.</p>

<p>There are two types of file that can be uploaded: plain files and templated files. A plain 
file is uploaded unmodified. A templated file is interpreted as a <a href="http://freemarker.org">FreeMarker</a> 
template. This supports a powerful set of substitutions. In brief, anything (unescaped) of the form
<code>${name}</code> will be substituted, in this case looking up “name” for the value to use.</p>

<p>Templated files (be they configuration files or scripts) gives a powerful way to inject dependent 
configuration when installing an entity (e.g. for customising the install, or for referencing the
connection details of another entity). A common substitution is of the form <code>${config['mykey']}</code>. 
This looks up a config key (in this case named “mykey”) and will insert the value into the file.
Another common substitution is is of the form <code>${attribute['myattribute']}</code> - this looks up the
attribute named “myattribute” of this entity.</p>

<p>Files can be referenced as URLs. This includes support for things like <code>classpath://mypath/myfile.bat</code>. 
This looks for the given (fully qualified) resource on the Brooklyn classpath.</p>

<p>The destination for the file upload is specified in the entity’s configuration. Note that “" must
be escaped. For example <code>"C:\\install7zip.ps1"</code>.</p>

<p>A list of plain files to be uploaded can be configured under <code>files.preinstall</code>, <code>files.install</code> and
<code>files.runtime</code>. These are uploaded respectively prior to executing the <code>pre.install.command</code>,
prior to <code>install.command</code> and prior to <code>pre.launch.command</code>.</p>

<p>A list of templated files to be uploaded can be configured under <code>templates.preinstall</code>, <code>templates.install</code>
and <code>templates.runtime</code>. The times these are uploaded is as for the plain files. The templates 
substitutions will be resolved only at the point when the file is to be uploaded.</p>

<p>For example:</p>

<pre><code>files.preinstall:
- classpath://com/acme/installAcme.ps1
- classpath://com/acme/acme.conf
</code></pre>

<h3 id="internalLink_windows-blueprints_parameterised-scripts">Parameterised Scripts</h3>

<p>Calling parameterised Batch and Powershell scripts is done in the normal Windows way - see
offical Microsoft docs. For example:</p>

<pre><code>install.command: "c:\\myscript.bat myarg1 myarg2"
</code></pre>

<p>Or as a Powershell example:</p>

<pre><code>install.powershell.command: "&amp; c:\\myscript.ps1 -key1 myarg1 -key2 myarg2"
</code></pre>

<p>It is also possible to construct the script parameters by referencing attributes of this or
other entities using the standard <code>attributeWhenReady</code> mechanism. For example:</p>

<pre><code>install.command: $brooklyn:formatString("c:\\myscript.bat %s", component("db").attributeWhenReady("datastore.url"))
</code></pre>

<h3 id="internalLink_windows-blueprints_powershell---using-start-process">Powershell - Using Start-Process</h3>

<p>When you are invoking a command from a powershell script with <code>Start-Process</code> cmdlet,
please use the <code>-Wait</code> and the <code>-PassThru</code> arguments.
Example <code>Start-Process C:\mycommand -Wait -PassThru</code></p>

<p>Using <code>-Wait</code> guarantees that the script process and its children and thus the winrm session won’t be terminated until it is finished.
<code>-PassThru</code> Returns a process object for each process that the cmdlet started. By default, this cmdlet does not generate any output.
See https://technet.microsoft.com/en-us/library/hh849848.aspx</p>

<h3 id="internalLink_windows-blueprints_rebooting">Rebooting</h3>

<p>Where a reboot is required as part of the entity setup, this can be configured using
config like <code>pre.install.reboot.required</code> and <code>install.reboot.required</code>. If required, the 
installation commands can be split between the pre-install, install and post-install phases
in order to do a reboot at the appropriate point of the VM setup.</p>

<p>We Strongly recommend to <strong>write blueprints in a way that they do NOT restart automatically windows</strong> and
use one of the <code>pre.install.reboot.required</code> or <code>install.reboot.required</code> parameters to perform restart.</p>

<h3 id="internalLink_windows-blueprints_install-location">Install Location</h3>

<p>Blueprint authors are encouraged to explicitly specify the full path for file uploads, and 
for paths in their Powershell scripts (e.g. for installation, configuration files, log files, etc).</p>

<h3 id="internalLink_windows-blueprints_how-and-why-to-re-authenticate-within-a-powershell-script">How and Why to re-authenticate within a powershell script</h3>

<p>Some installation scripts require the use of security-related operations. In some environments,<br />
these fail by default when executed over WinRM, even though the script may succeed when run locally <br />
(e.g. by using RDP to connect to the machine and running the script manually). There may be no<br />
clear indication from Windows why it failed (e.g. for MSSQL install, the only clue is a <br />
security exception in the installation log).</p>

<p>When a script is run over WinRM, the credentials under which the script are run are marked as
‘remote’ credentials, which are prohibited from running certain security-related operations. The 
solution is to obtain a new set of credentials within the script and use those credentials to 
required commands.</p>

<p>The WinRM client uses Negotiate+NTLM to authenticate against the machine.
This mechanism applies certain restrictions to executing commands on the windows host.</p>

<p>For this reason you should enable CredSSP on the windows host which grants all privileges available to the user.
 https://technet.microsoft.com/en-us/library/hh849719.aspx#sectionSection4</p>

<p>To use <code>Invoke-Command -Authentication CredSSP</code> the Windows Machine has to have:
- Up and running WinRM over http. The custom-enable-credssp.ps1 script enables winrm over http because <code>Invoke-Command</code> use winrm over http by default.
  Invoke-Command can be used with -UseSSL option but this will lead to modifying powershell scripts.
  With always enabling winrm over http on the host, blueprint’s powershell scripts remain consistent and not depend on the winrm https/http environments.
  We hope future versions of winrm4j will support CredSSP out of the box and wrapping commands in Invoke-Command will not be needed.
- Added trusted host entries which will use Invoke-Command
- Allowed CredSSP</p>

<p>All the above requirements are enabled in Apache Brooklyn through <a href="https://github.com/apache/brooklyn-server/blob/master/software/base/src/main/resources/org/apache/brooklyn/software/base/custom-enable-credssp.ps1">brooklyn-server/software/base/src/main/resources/org/apache/brooklyn/software/base/custom-enable-credssp.ps1</a>
script which enables executing commands with CredSSP in the general case.
The script works for most of the Windows images out there version 2008 and later.</p>

<p>Please ensure that Brooklyn’s changes are compatible with your organisation’s security policy.</p>

<p>Check Microsoft Documentation for more information about <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa378748(v=vs.85).aspx">Negotiate authenticate mechanism on technet.microsoft.com</a></p>

<p>Re-authentication also requires that the password credentials are passed in plain text within the
script. Please be aware that it is normal for script files - and therefore the plaintext password - 
to be saved to the VM’s disk. The scripts are also accessible via the Brooklyn web-console’s 
activity view. Access to the latter can be controlled via 
<a href="#contentsLink-entitlements">Entitlements</a>.</p>

<p>As an example (taken from MSSQL install), the command below works when run locally, but fails over 
WinRM:</p>

<pre><code>( $driveLetter + "setup.exe") /ConfigurationFile=C:\ConfigurationFile.ini
</code></pre>

<p>The code below can be used instead (note this example uses Freemarker templating):</p>

<pre><code>&amp; winrm set winrm/config/service/auth '@{CredSSP="true"}'
&amp; winrm set winrm/config/client/auth '@{CredSSP="true"}'
#
$pass = '${attribute['windows.password']}'
$secpasswd = ConvertTo-SecureString $pass -AsPlainText -Force
$mycreds = New-Object System.Management.Automation.PSCredential ($($env:COMPUTERNAME + "\${location.user}"), $secpasswd)
#
$exitCode = Invoke-Command -ComputerName $env:COMPUTERNAME -Credential $mycreds -ScriptBlock {
    param($driveLetter)
    $process = Start-Process ( $driveLetter + "setup.exe") -ArgumentList "/ConfigurationFile=C:\ConfigurationFile.ini" -RedirectStandardOutput "C:\sqlout.txt" -RedirectStandardError "C:\sqlerr.txt" -Wait -PassThru -NoNewWindow
    $process.ExitCode
} -Authentication CredSSP -ArgumentList $driveLetter
#
exit $exitCode
</code></pre>

<p>In this example, the <code>${...}</code> format is FreeMarker templating. Those sections will be substituted
before the script is uploaded for execution. To explain this example in more detail:</p>

<ul>
  <li>
    <p><code>${attribute['windows.password']}</code> is substituted for the entity’s attribute “windows.password”.
This (clear-text) password is sent as part of the script. Assuming that HTTPS and NTLM is used,
the script will be encrypted while in-flight.</p>
  </li>
  <li>
    <p>The <code>${location.user}</code> gets (from the entity’s machine location) the username, substituting this 
text for the actual username. In many cases, this will be “Administrator”. However, on some<br />
clouds a different username (with admin privileges) will be used.</p>
  </li>
  <li>
    <p>The username and password are used to create a new credential object (having first converted the
password to a secure string).</p>
  </li>
  <li>
    <p>Credential Security Service Provider (CredSSP) is used for authentication, to pass the explicit<br />
credentials when using <code>Invoke-Command</code>.</p>
  </li>
</ul>

<h3 id="internalLink_windows-blueprints_windows-amis-on-aws">Windows AMIs on AWS</h3>

<p>Windows AMIs in AWS change regularly (to include the latest Windows updates). If using the community
AMI, it is recommended to use an AMI name regex, rather than an image id, so that the latest AMI is 
always picked up. If an image id is used, it may fail as Amazon will delete their old Windows AMIs.</p>

<p>If using an image regex, it is recommended to include the image owner in case someone else uploads
a similarly named AMI. For example:</p>

<pre><code>brooklyn.location.named.AWS\ Oregon\ Win = jclouds:aws-ec2:us-west-2
brooklyn.location.named.AWS\ Oregon\ Win.imageNameRegex = Windows_Server-2012-R2_RTM-English-64Bit-Base-.*
brooklyn.location.named.AWS\ Oregon\ Win.imageOwner = 801119661308
...
</code></pre>

<h2 id="internalLink_windows-blueprints_stdout-and-stderr-in-a-powershell-script">stdout and stderr in a Powershell script</h2>

<p>When calling an executable in a Powershell script, the stdout and stderr will usually be output to the console.
This is captured by Brooklyn, and shown in the activities view under the specific tasks.</p>

<p>An alternative is to redirect stdout and stderr to a file on the VM, which can be helpful if one expects sys admins
to log into the VM. However, be warned that this would hide the stdout/stderr from Brooklyn’s activities view.</p>

<p>For example, instead of running the following:</p>

<pre><code>D:\setup.exe /ConfigurationFile=C:\ConfigurationFile.ini
</code></pre>

<p>The redirect can be achieved by using the <code>Start-Process</code> scriptlet:</p>

<pre><code>Start-Process D:\setup.exe -ArgumentList "/ConfigurationFile=C:\ConfigurationFile.ini" -RedirectStandardOutput "C:\sqlout.txt" -RedirectStandardError "C:\sqlerr.txt" -PassThru -Wait
</code></pre>

<p>The <code>-ArgumentList</code> is simply the arguments that are to be passed to the executable, <code>-RedirectStandardOutput</code> and
<code>RedirectStandardError</code> take file locations for the output (if the file already exists, it will be overwritten). The
<code>-PassThru</code> argument indicates that Powershell should write to the file <em>in addition</em> to the console, rather than
<em>instead</em> of the console. The <code>-Wait</code> argument will cause the scriptlet to block until the process is complete.</p>

<p>Further details can be found on the <a href="https://technet.microsoft.com/en-us/library/hh849848.aspx">Start-Process documentation page</a>
on the Microsoft TechNet site.</p>

<h2 id="internalLink_windows-blueprints_troubleshooting">Troubleshooting</h2>

<p>Much of the <a href="#contentsLink-troubleshooting">operations troubleshooting guide</a> is applicable for Windows blueprints.  </p>

<h3 id="internalLink_windows-blueprints_user-metadata-service-requirement">User metadata service requirement</h3>

<p>WinRM requires activation and configuration before it will work in a standard Windows Server deployment. To automate
this, Brooklyn will place a setup script in the user metadata blob. Services such as Amazon EC2’s <code>Ec2ConfigService</code>
will automatically load and execute this script. If your chosen cloud provider does not support <code>Ec2ConfigService</code> or
a similar package, or if your cloud provider does not support user metadata, then you must pre-configure a Windows image
with the required WinRM setup and make Brooklyn use this image.</p>

<p>If the configuration options <code>userMetadata</code> or <code>userMetadataString</code> are used on the location, then this will override
the default setup script. This allows one to supply a custom setup script. However, if userMetadata contains something
else then the setup will not be done and the VM may not not be accessible remotely over WinRM.</p>

<h3 id="internalLink_windows-blueprints_credentials-issue-requiring-special-configuration">Credentials issue requiring special configuration</h3>

<p>When a script is run over WinRM over HTTP, the credentials under which the script are run are marked as
‘remote’ credentials, which are prohibited from running certain security-related operations. This may prevent certain
operations. The installer from Microsoft SQL Server is known to fail in this case, for example. For a workaround, please
refer to <a href="#internalLink_windows-blueprints_how-and-why-to-re-authenticate-within-a-powershell-script">How and Why to re-authenticate withing a powershell script</a> 
above.</p>

<h3 id="internalLink_windows-blueprints_webserviceexception-could-not-send-message">WebServiceException: Could not send Message</h3>

<p>We detected a <code>WebServiceException</code> and different <code>SocketException</code>
during deployment of long lasting Application Blueprint against VcloudDirector.</p>

<p>Launching the blueprint bellow was giving constantly this type of error on launch step.</p>

<pre><code>services:
  type: org.apache.brooklyn.entity.software.base.VanillaWindowsProcess
  brooklyn.config:
    pre.install.command: echo preInstallCommand
    install.command: echo installCommand &gt; C:\\install.txt
    post.install.command: echo postInstallCommand
    customize.command: echo customizeCommand
    pre.launch.command: echo preLaunchCommand
    launch.powershell.command: |
      Start-Sleep -s 400
      Write-Host Test Completed
    post.launch.command: echo postLaunchCommand
    checkRunning.command: echo checkRunningCommand
    stop.command: echo stopCommand
</code></pre>

<p>With series of tests we concluded that on the Vcloud Director environment we were using
a restart was happening ~2 minutes after the VM is provisioned.
Logging in the host and search for System event of type 1074 in Windows Event Viewer, we found two 1074 events where the second one was</p>

<pre><code>The process C:\Windows\system32\winlogon.exe (W2K12-STD) has initiated the restart of computer WIN-XXXX on behalf of user
NT AUTHORITY\SYSTEM for the following reason: Operating System: Upgrade (Planned) Reason Code: 0x80020003 Shutdown Type: restart Comment:
</code></pre>

<p>Normally on other clouds only one restart event is registered and the first time winrm connection is made the Windows VM is ready for use. </p>

<p>For this particular case when you want this second restart to finish we made <code>waitWindowsToStart</code> location parameter
which basically adds additional check assuring the Windows VM provisioning is done.</p>

<p>For example when using <code>waitWindowsToStart: 5m</code> location parameter, Apache Brooklyn will wait 5 minutes to see if a disconnect occurs.
If it does, then it will again wait 5m for the machine to come back up.
The default behaviour in Apache Brooklyn is to consider provisioning done on the first successful winrm connection, without waiting for restart. </p>

<p>To determine whether you should use this parameter you should carefully inspect how the image you choose to provision is behaving.
If the description above matches your case and you are getting <strong>connection failure message in the middle of the installation process</strong> for your blueprints,
a restart probably occurred and you should try this parameter.</p>

<p>Before using this parameter we advice to check whether this is really your case.
To verify the behavior check as described above.</p>

<h3 id="internalLink_windows-blueprints_amis-not-found">AMIs not found</h3>

<p>If using the imageId of a Windows community AMI, you may find that the AMI is deleted after a few weeks.
See <a href="#internalLink_windows-blueprints_windows-amis-on-aws">Windows AMIs on AWS</a> above.</p>

<h3 id="internalLink_windows-blueprints_vm-provisioning-times-out">VM Provisioning Times Out</h3>

<p>In some environments, provisioning of Windows VMs can take a very long time to return a usable VM.
If the image is old, it may install many security updates (and reboot several times) before it is
usable.</p>

<p>On a VMware vCloud Director environment, the guest customizations can cause the VM to reboot (sometimes
several times) before the VM is usable.</p>

<p>This could cause the WinRM connection attempts to timeout. The location configuration option 
<code>waitForWinRmAvailable</code> defaults to <code>30m</code> (i.e. 30 minutes). This can be increased if required.</p>

<p>Incorrectly prepared Windows template can cause the deployment to time-out expecting an interaction by the user.
You can verify if this is the case by RDP to the deployment which is taking to much time to complete. 
It is recommended to manually deploy a single VM for every newly created Windows template to verify that it can be
used for unattended installations and it doesn’t wait and/or require an input by the user.
See <a href="#internalLink_windows-blueprints_windows-template-settings-for-an-unattended-installation">Windows template settings for an Unattended Installation</a> under Known Limitations below. </p>

<h3 id="internalLink_windows-blueprints_windows-log-files">Windows log files</h3>

<p>Details of the commands executed, and their results, can be found in the Brooklyn log and in the Brooklyn 
web-console’s activity view. </p>

<p>There will also be log files on the Windows Server. System errors in Windows are usually reported in the Windows Event Log -<br />
see <a href="https://technet.microsoft.com/en-us/library/cc766042.aspx">https://technet.microsoft.com/en-us/library/cc766042.aspx</a> 
for more information.</p>

<p>Additional logs may be created by some Windows programs. For example, MSSQL creates a log in 
<code>%programfiles%\Microsoft SQL Server\130\Setup Bootstrap\Log\</code> - for more information see 
<a href="https://msdn.microsoft.com/en-us/library/ms143702.aspx">https://msdn.microsoft.com/en-us/library/ms143702.aspx</a>.</p>

<h2 id="internalLink_windows-blueprints_known-limitations">Known Limitations</h2>

<p>WinRM 2.0 supports encryption mechanisms on top of HTTP. However those are not supported in Apache Brooklyn.
For production adoptions please make sure you follow Microsoft Guidelines https://msdn.microsoft.com/en-us/library/ee309366(v=vs.85).aspx</p>

<h3 id="internalLink_windows-blueprints_apache-brooklyn-limitations-on-using-winrm-over-http-and-https">Apache Brooklyn limitations on using WinRM over HTTP and HTTPS</h3>

<p>By default Apache Brooklyn is currently using unencrypted HTTP for WinRM communication. It does not support encrypted HTTP for WinRM.</p>

<p>HTTPS is supported but there is no mechanism of specifying which certificates to trust.
Currently Apache Brooklyn will accept any certificate used in a HTTPS WinRM connection.</p>

<h3 id="internalLink_windows-blueprints_incorrect-exit-codes">Incorrect Exit Codes</h3>

<p>Some limitations with WinRM (or at least the chosen WinRM Client!) are listed below:</p>

<h5 id="internalLink_windows-blueprints_single-line-powershell-files">Single-line Powershell files</h5>

<p>When a Powershell file contains just a single command, the execution of that file over WinRM returns exit code 0
even if the command fails! This is the case for even simple examples like <code>exit 1</code> or <code>thisFileDoesNotExist.exe</code>.</p>

<p>A workaround is to add an initial command, for example:</p>

<pre><code>Write-Host dummy line for workaround 
exit 1
</code></pre>

<h5 id="internalLink_windows-blueprints_direct-configuration-of-powershell-commands">Direct Configuration of Powershell commands</h5>

<p>If a command is directly configured with Powershell that includes <code>exit</code>, the return code over WinRM
is not respected. For example, the command below will receive an exit code of 0.</p>

<pre><code>launch.powershell.command: |
  echo first
  exit 1
</code></pre>

<h5 id="internalLink_windows-blueprints_direct-configuration-of-batch-commands">Direct Configuration of Batch commands</h5>

<p>If a command is directly configured with a batch exit, the return code over WinRM
is not respected. For example, the command below will receive an exit code of 0.</p>

<pre><code>launch.command: exit /B 1
</code></pre>

<h5 id="internalLink_windows-blueprints_non-zero-exit-code-returned-as-one">Non-zero Exit Code Returned as One</h5>

<p>If a batch or Powershell file exits with an exit code greater than one (or negative), this will 
be reported as 1 over WinRM.</p>

<p>We advise you to use native commands (non-powershell ones) since executing it as a native command
will return the exact exit code rather than 1.
For instance if you have installmssql.ps1 script use <code>install.command: powershell -command "C:\\installmssql.ps1"</code>
rather than using <code>install.powershell.command: "C:\\installmssql.ps1"</code>
The first will give you an exact exit code rather than 1</p>

<h3 id="internalLink_windows-blueprints_powershell-preparing-modules-for-first-use">PowerShell “Preparing modules for first use”</h3>

<p>The first command executed over WinRM has been observed to include stderr saying “Preparing 
modules for first use”, such as that below:</p>

<pre><code>&lt; CLIXML
&lt;Objs Version="1.1.0.1" xmlns="http://schemas.microsoft.com/powershell/2004/04"&gt;&lt;Obj S="progress" RefId="0"&gt;&lt;TN RefId="0"&gt;&lt;T&gt;System.Management.Automation.PSCustomObject&lt;/T&gt;&lt;T&gt;System.Object&lt;/T&gt;&lt;/TN&gt;&lt;MS&gt;&lt;I64 N="SourceId"&gt;1&lt;/I64&gt;&lt;PR N="Record"&gt;&lt;AV&gt;Preparing modules for first use.&lt;/AV&gt;&lt;AI&gt;0&lt;/AI&gt;&lt;Nil /&gt;&lt;PI&gt;-1&lt;/PI&gt;&lt;PC&gt;-1&lt;/PC&gt;&lt;T&gt;Completed&lt;/T&gt;&lt;SR&gt;-1&lt;/SR&gt;&lt;SD&gt; &lt;/SD&gt;&lt;/PR&gt;&lt;/MS&gt;&lt;/Obj&gt;&lt;Obj S="progress" RefId="1"&gt;&lt;TNRef RefId="0" /&gt;&lt;MS&gt;&lt;I64 N="SourceId"&gt;2&lt;/I64&gt;&lt;PR N="Record"&gt;&lt;AV&gt;Preparing modules for first use.&lt;/AV&gt;&lt;AI&gt;0&lt;/AI&gt;&lt;Nil /&gt;&lt;PI&gt;-1&lt;/PI&gt;&lt;PC&gt;-1&lt;/PC&gt;&lt;T&gt;Completed&lt;/T&gt;&lt;SR&gt;-1&lt;/SR&gt;&lt;SD&gt; &lt;/SD&gt;&lt;/PR&gt;&lt;/MS&gt;&lt;/Obj&gt;&lt;/Objs&gt;
</code></pre>

<p>The command still succeeded. This has only been observed on private clouds (e.g. not on
AWS). It could be related to the specific Windows images in use. It is recommended that 
VM images are prepared carefully, e.g. so that security patches are up-to-date and the
VM is suitably initialised.</p>

<h3 id="internalLink_windows-blueprints_winrm-executescript-failed-httplibbadstatusline-">WinRM executeScript failed: httplib.BadStatusLine: ‘’</h3>

<p>As described in https://issues.apache.org/jira/browse/BROOKLYN-173, a failure has been
observed where the 10 attempts to execute the command over WinRM failed with:</p>

<pre><code>httplib.BadStatusLine: ''
</code></pre>

<p>Subsequently retrying the command worked. It is unclear what caused the failure, but could 
have been that the Windows VM was not yet in the right state.</p>

<p>One possible workaround is to ensure the Windows VM is in a good state for immediate use (e.g. 
security updates are up-to-date). Another option is to increase the number of retries, 
which defaults to 10. This is a configuration option on the machine location, so can be set on
the location’s brooklyn.properties or in the YAML: </p>

<pre><code>execTries: 20
</code></pre>

<h3 id="internalLink_windows-blueprints_direct-configuration-of-multi-line-batch-commands-not-executed">Direct Configuration of Multi-line Batch Commands Not Executed</h3>

<p>If a command is directly configured with multi-line batch commands, then only the first line 
will be executed. For example the command below will only output “first”:</p>

<pre><code>launch.command: |
  echo first
  echo second
</code></pre>

<p>The workaround is to write a file with the batch commands, have that file uploaded, and execute it.</p>

<p>Note this is not done automatically because that could affect the capture and returning
of the exit code for the commands executed.</p>

<h3 id="internalLink_windows-blueprints_install-location-1">Install location</h3>

<p>Work is required to better configure a default install location on the VM (e.g. so that 
environment variables are set). The installation pattern for linux-based blueprints,
of using brooklyn-managed-processes/installs, is not used or recommended on Windows.
Files will be uploaded to C:\ if no explicit directory is supplied, which is untidy, 
unnecessarily exposes the scripts to the user, and could cause conflicts if multiple 
entities are installed.</p>

<p>Blueprint authors are strongly encourages to explicitly specific directories for file
uploads and in their Powershell scripts.</p>

<h3 id="internalLink_windows-blueprints_windows-template-settings-for-an-unattended-installation">Windows template settings for an Unattended Installation</h3>

<p>Windows template needs certain configuration to be applied to prevent windows setup UI from being displayed.
The default behavior is to display it if there are incorrect or empty settings. Showing Setup UI will prevent the proper
deployment, because it will expect interaction by the user such as agreeing on the license agreement or some of the setup dialogs.</p>

<p>Detailed instruction how to prepare an Unattended installation are provided at <a href="https://technet.microsoft.com/en-us/library/cc722411%28v=ws.10%29.aspx">https://technet.microsoft.com/en-us/library/cc722411%28v=ws.10%29.aspx</a>.</p>


	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-winrm4j-client" class="section-breaker section p-">
	<span style="width: 100%"><h1>Winrm4j Client</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_winrm4j-client_winrm4j-parameters">Winrm4j parameters</h2>

<p>Check <a href="https://github.com/apache/brooklyn-server/blob/master/software/winrm/src/main/java/org/apache/brooklyn/location/winrm/WinRmMachineLocation.java#L82-L112">org.apache.brooklyn.location.winrm.WinRmMachineLocation</a>
parameters available for WinRM.</p>

<ul>
  <li>host <string>: Host to connect to (required).Default value `null`</string></li>
  <li>port <integer>: WinRM port to use when connecting to the remote machine.<br />
If no port is specified then it defaults to a port depending on the `winrm.useHttps` flag.</integer></li>
  <li>winrm.useHttps <boolean>: The parameter tells the machine sensors whether the winrm port is over https. If the parameter is true then 5986 will be used as a winrm port.<br />
Default value: `false`</boolean></li>
  <li>retriesOfNetworkFailures <integer>: The parameter sets the number of retries for connection failures. If you use high value, consider taking care for the machine's network.<br />
Default value: `4`</integer></li>
  <li>winrm.useNtlm <boolean>: The parameter configures tells the machine sensors whether the winrm port is over https. If the parameter is true then 5986 will be used as a winrm port.<br />
Default value: `true`</boolean></li>
  <li>winrm.computerName <string>: Windows Computer Name to use for authentication.<br />
Default value: `null`</string></li>
  <li>user <string>: User to connect as<br />
Default value: `null`</string></li>
  <li>password <string>: Password to use to connect.<br />
Default value: `null`</string></li>
  <li>waitWindowsToStart <duration>: By default Brooklyn will return the machine immediately after Brooklyn is able to WinRM. Sometimes restart could happen after a Windows VM is provisioned.
This could be because of System Upgrade or other.
By setting this config key to 60s, 5m or other X Duration of time Brooklyn will wait X amount of time for disconnect to occur.
If connection failure occurs it will wait X amount of time for the machine to come up.<br />
Default value: `null`</duration></li>
</ul>

<p>If there are location config keys prefixed with <code>brooklyn.winrm.config.</code> prefix will be removed
and it will be used to instantiate a <code>org.apache.brooklyn.util.core.internal.winrm.WiRmTool</code> implementation.</p>

<h2 id="internalLink_winrm4j-client_winrm-connectivity-diagnostics">WinRM Connectivity Diagnostics</h2>

<p>If you are experiencing problems with a windows blueprint against a jclouds location 
where Apache Brooklyn complains about failing to connect to the IP you should check those things.</p>

<ol>
  <li>Apache Brooklyn is using correct username and password</li>
  <li>Apache Brooklyn can reach the IP of the provisioned machine. WinRM port 5985 or 5986 is also reachable from Apache Brooklyn.</li>
  <li>Check whether <code>WinRmMachineLocation#getDefaultUserMetadataString(ConfigurationSupportInternal)</code> is applied on the VM.
This script should be passed to the cloud and executed in order to configure WinRM according to Apache Brooklyn requirements for authentication.
So far windows startup script are known to be supported on AWS EC2 and VCloud Director.
If your cloud doesn’t use this script then tune WinRM parameters accordingly.</li>
  <li>Check whether you use winrm over http or over https.</li>
  <li>If you are using WinRM over http then make sure WinRM service on target VM has <code>AllowUnencrypted = true</code></li>
</ol>

<p>If the quick list above doesn’t help then follow the steps bellow.</p>

<p>To speed up diagnosing the problem we advice to trigger a deployment with the JcloudsLocation flag <code>destroyOnFailure: false</code> so you can check status of the provisioned machine
or try later different WinRM parameters with a Apache Brooklyn <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/blueprints/winrm/../../locations/index.html">BYON Location</a>.</p>

<p>After you determined what is the username and the password you can proceed with next steps.
<em>(Notice that for cloud providers which use Auto Generated password will not be logged.
For these cases use Java Debug to retrieve ot or provision a VM manually with the same parameters when using Apache Brooklyn to provision a jclouds location.)</em></p>

<p>The first step is to find what is the winrm service configuration on the target host.</p>

<ol>
  <li>
    <p>If you have RDP access or KVM like access to the VM then check the winrm service status with the command bellow.
<code>winrm get winrm/config/service</code>
If you are using http you should have AllowUnencrypted to false.
Encryption is supported only over https.
Sample output:</p>

    <pre><code> MaxConcurrentOperations = 4294967295
 MaxConcurrentOperationsPerUser = 1500
 EnumerationTimeoutms = 240000
 MaxConnections = 300
 MaxPacketRetrievalTimeSeconds = 120
 AllowUnencrypted = true
 Auth
     Basic = false
     Kerberos = true
     Negotiate = true
     Certificate = false
     CredSSP = true
     CbtHardeningLevel = Relaxed
 DefaultPorts
     HTTP = 5985
     HTTPS = 5986
 IPv4Filter = *
 IPv6Filter = *
 EnableCompatibilityHttpListener = false
 EnableCompatibilityHttpsListener = false
 CertificateThumbprint
 AllowRemoteAccess = true
</code></pre>
  </li>
</ol>

<p>Use an Apache Brooklyn BYON blueprint to try easily other connection options.</p>

<pre><code>location:
  byon:
    hosts:
    - winrm: 10.0.0.1
      user: Administrator
      password: pa55w0rd
      osFamily: windows
services:
- type: org.apache.brooklyn.entity.software.base.VanillaWindowsProcess
  brooklyn.config:
     checkRunning.command: echo checkRunning
     install.command: echo installCommand
</code></pre>

<ol>
  <li>Check IP is reachable from Apache Brooklyn instance
Check whether <code>telnet 10.0.0.1 5985</code> makes successfully a socket.</li>
  <li>If AllowUnencrypted is false and you are using winrm over http then apply <code>winrm set winrm/config/service @{AllowUnencrypted="true"}</code>
<em>If jclouds or the cloud provider doesn’t support passing <code>sysprep-specialize-script-cmd</code> then consider modifying Windows VM Image.</em> </li>
  <li>
    <p>Check your username and password. Notice in Windows passwords are case sensitive.
Here is how it looks log from a wrong password:</p>

    <pre><code> INFO: Authorization loop detected on Conduit "{http://schemas.dmtf.org/wbem/wsman/1/wsman.xsd}WinRmPort.http-conduit" on URL "http://192.168.122.1:5985/wsman" with realm "null"
 Oct 21, 2016 10:43:11 AM org.apache.cxf.phase.PhaseInterceptorChain doDefaultLogging
 WARNING: Interceptor for {http://schemas.dmtf.org/wbem/wsman/1/wsman.xsd}WinRmService#{http://schemas.dmtf.org/wbem/wsman/1/wsman.xsd}Create has thrown exception, unwinding now
 org.apache.cxf.interceptor.Fault: Could not send Message.
 at org.apache.cxf.interceptor.MessageSenderInterceptor$MessageSenderEndingInterceptor.handleMessage(MessageSenderInterceptor.java:64)
</code></pre>
  </li>
  <li>When having wrong password you may want to try logging on a different domain
This is possible from <code>brooklyn.winrm.config.winrm.computerName</code> location config.</li>
  <li>If you want to configure Windows target host with https then check the article <a href="https://support.microsoft.com/en-us/kb/2019527">Configuring WINRM for HTTPS</a></li>
  <li>If you are still seeing authorization errors then try connecting via winrm with the embedded winrs client.
First make sure you have the server in trusted hosts.</li>
</ol>

<p>Then execute a simple command like</p>

<pre><code>winrs -r:10.0.2.15 -unencrypted -u:Administrator -p:pa55w0rd ipconfig
</code></pre>

	</div>
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-testing-yaml-blueprints" class="section-breaker section p-">
	<span style="width: 100%"><h1>Testing YAML Blueprints</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Brooklyn provides a selection of test entities which can be used to validate Blueprints via YAML. The basic building block is a TargetableTestComponent, which is used to resolve a target. There are two different groups of entities that inherit from TargetableTestComponent. The first is structural, which effects how the tests are run, for example by affecting the order they are run in. The second group is validation, which is used to confirm the application is deployed as intended, for example by checking some sensor value.</p>

<p>Structural test entities include:</p>

<ul>
  <li><code>TestCase</code>  - starts child entities sequentially.</li>
  <li><code>ParallelTestCase</code> - starts child entities in parallel.</li>
  <li><code>LoopOverGroupMembersTestCase</code> - creates a TargetableTestComponent for each member of a group.</li>
  <li><code>InfrastructureDeploymentTestCase</code> - will create the specified Infrastructure and then deploy the target entity specifications there.</li>
</ul>

<p>Validation test entities include:</p>

<ul>
  <li><code>TestSensor</code> - perform assertion on a specified sensor.</li>
  <li><code>TestEffector</code> - perform assertion on response to effector call.</li>
  <li><code>TestHttpCall</code> - perform assertion on response to specified HTTP GET Request.</li>
  <li><code>TestSshCommand</code> - test assertions on the result of an ssh command on the same machine as the target entity.</li>
  <li><code>TestWinrmCommand</code> - test assertions on the result of a WinRM command on the same machine as the target entity.</li>
  <li><code>TestEndpointReachable</code> - assert that a TCP endpoint is reachable. The endpoint can be in a 
number of different formats: a string in the form of <code>ip:port</code> or URI format; or a 
<code>com.google.common.net.HostAndPort</code> instance; or a <code>java.net.URI</code> instance; or a <code>java.net.URL</code> instance.</li>
</ul>

<p>TargetableTestComponents can be chained together, with the target being inherited by the components children. For example, a ParallelTestCase could be created that has a TestHttpCall as a child. As long as the TestHttpCall itself does not have a target, it will use the target of it’s parent, ParallelTestCase. Using this technique, we can build up complex test scenarios.</p>

<p>The following sections provide details on each test entity along with examples of their use.</p>

<div class="list-children"><ul>

<li> <a href="#contentsLink-blueprint-test-entities">Blueprint Test Entities</a> </li>

<li> <a href="#contentsLink-example-blueprint-tests">Example Blueprint Tests</a> </li>

</ul></div>

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-blueprint-test-entities" class="section-breaker section p-">
	<span style="width: 100%"><h1>Blueprint Test Entities</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	
<h2 id="internalLink_blueprint-test-entities_structural-test-entities">Structural Test Entities</h2>

<h3 id="internalLink_blueprint-test-entities_testcase">TestCase</h3>
<p>The <code>TestCase</code> entity acts as a container for a list of child entities which are started <em>sequentially</em>.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.test.framework.TestCase</span>
  <span class="l-Scalar-Plain">brooklyn.children</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.database.mysql.MySqlNode</span>
    <span class="l-Scalar-Plain">...</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.test.framework.TestSensor</span>
    <span class="l-Scalar-Plain">...</span></code></pre></div>

<p>This can be used to enforce a strict ordering, for example ensuring a sensor has a certain value before attempting to invoke an effector.</p>

<p>Timeouts on child entities should be set relative to the completion of the preceding entity.</p>

<p>The <code>ParallelTestCase</code> entity can be added as a child to run a subset of entities in parallel as a single step.</p>

<h3 id="internalLink_blueprint-test-entities_paralleltestcase">ParallelTestCase</h3>
<p>The <code>ParallelTestCase</code> entity acts as a container for a list of child entities which are started in <em>parallel</em>.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.test.framework.ParallelTestCase</span>
  <span class="l-Scalar-Plain">brooklyn.children</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.database.mysql.MySqlNode</span>
    <span class="l-Scalar-Plain">...</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.ControlledDynamicWebAppCluster</span>
    <span class="l-Scalar-Plain">...</span></code></pre></div>

<p>This can be used to run a subset of entities in parallel as a single step when nested under a <code>TestCase</code> entity.</p>

<p>Timeouts on child entities should be set relative to the start of the <code>ParallelTestCase</code>.</p>

<h3 id="internalLink_blueprint-test-entities_loopovergroupmemberstestcase">LoopOverGroupMembersTestCase</h3>
<p>The <code>LoopOverGroupMembersTestCase</code> entity is configured with a target group and a test specification. For each member of the targeted group, the test case will create a TargetableTestComponent entity from the supplied test specification and set the components target to be the group member.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.test.framework.LoopOverGroupMembersTestCase</span>
  <span class="l-Scalar-Plain">target</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:entity(&quot;infrastructure&quot;).component(&quot;child&quot;, &quot;DockerHosts&quot;)</span>
  <span class="l-Scalar-Plain">testSpec</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">$brooklyn:entitySpec</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.test.framework.TestSensor</span>
      <span class="l-Scalar-Plain">...</span></code></pre></div>

<h4 id="internalLink_blueprint-test-entities_parameters">Parameters</h4>
<ul>
  <li><code>target</code> - group who’s members are to be tested, specified via DSL. For example, <code>$brooklyn:entity("tomcat")</code>. See also the <code>targetId</code> parameter.</li>
  <li><code>targetId</code> - alternative to the <code>target</code> parameter which wraps the DSL component lookup requiring only the <code>id</code> be supplied. For example, <code>tomcat</code>. Please note, this must point to a group.</li>
  <li><code>test.spec</code> - The TargetableTestComponent to create for each child.</li>
</ul>

<h3 id="internalLink_blueprint-test-entities_infrastructuredeploymenttestcase">InfrastructureDeploymentTestCase</h3>
<p>The <code>InfrastructureDeploymentTestCase</code> will first create and deploy an infrastructure from the <code>infrastructure.deployment.spec</code> config. It will then retrieve a deployment location by getting the value of the infrastructures <code>infrastructure.deployment.location.sensor</code> sensor. It will then create and deploy all entities from the <code>infrastructure.deployment.spec</code> config to the deployment location.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.test.framework.InfrastructureDeploymentTestCase</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">infrastructure.deployment.location.sensor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity.dynamicLocation</span>
    <span class="l-Scalar-Plain">infrastructure.deployment.spec</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">$brooklyn:entitySpec</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-cloud-calico</span>
          <span class="l-Scalar-Plain">...</span>
    <span class="l-Scalar-Plain">infrastructure.deployment.entity.specs</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">$brooklyn:entitySpec</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.software.base.VanillaSoftwareProcess</span>
          <span class="l-Scalar-Plain">...</span></code></pre></div>

<h4 id="internalLink_blueprint-test-entities_parameters-1">Parameters</h4>

<ul>
  <li><code>infrastructure.deployment.spec</code> - the infrastructure to be deployed.</li>
  <li><code>infrastructure.deployment.entity.specs</code> - the entities to be deployed to the infrastructure</li>
  <li><code>infrastructure.deployment.location.sensor</code> - the name of the sensor on the infrastructure to retrieve the deployment location</li>
</ul>

<h2 id="internalLink_blueprint-test-entities_validation-test-entities">Validation Test Entities</h2>

<h3 id="internalLink_blueprint-test-entities_testsensor">TestSensor</h3>
<p>The <code>TestSensor</code> entity performs an assertion on a specified sensors value.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.test.framework.TestSensor</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Check tomcat isUp</span>
  <span class="l-Scalar-Plain">target</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:entity(&quot;tomcat&quot;)</span>
  <span class="l-Scalar-Plain">sensor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">service.isUp</span>
  <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10m</span>
  <span class="l-Scalar-Plain">assert</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">equals</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span></code></pre></div>

<h4 id="internalLink_blueprint-test-entities_parameters-2">Parameters</h4>
<ul>
  <li><code>target</code> - entity whose sensor will be tested, specified via DSL. For example, <code>$brooklyn:entity("tomcat")</code>. See also the <code>targetId</code> parameter.</li>
  <li><code>targetId</code> - alternative to the <code>target</code> parameter which wraps the DSL component lookup requiring only the <code>id</code> be supplied. For example, <code>tomcat</code>.</li>
  <li><code>sensor</code> - sensor to evaluate. For example <code>service.isUp</code>.</li>
  <li><code>timeout</code> - duration to wait on assertion to return a result. For example <code>10s</code>, <code>10m</code>, etc</li>
  <li><code>assert</code> - assertion to perform on the specified sensor value. See section on assertions below.</li>
</ul>

<div class="alert alert-info">
    <strong>Tip:</strong> If the <code>TestSensor</code> is wrapped within a <code>TestCase</code>, 
    <code>ParallelTestCase</code> or <code>LoopOverGroupMembersTestCase</code> that set the target, 
    <strong>you don't need to specify the target</strong>, unless you want to test a different entity.
</div>

<h3 id="internalLink_blueprint-test-entities_testeffector">TestEffector</h3>
<p>The <code>TestEffector</code> entity invokes the specified effector on a target entity. If the result of the effector is a String, it will then perform assertions on the result.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.test.framework.TestEffector</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Invoke Deploy Effector</span>
  <span class="l-Scalar-Plain">target</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:entity(&quot;tomcat&quot;)</span>
  <span class="l-Scalar-Plain">effector</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">deploy</span>
  <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5m</span>
  <span class="l-Scalar-Plain">params</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=org/apache/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.8.0-incubating/brooklyn-example-hello-world-sql-webapp-0.8.0-incubating.war</span>
    <span class="l-Scalar-Plain">targetName</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">newcontext</span></code></pre></div>

<h4 id="internalLink_blueprint-test-entities_parameters-3">Parameters</h4>
<ul>
  <li><code>target</code> - entity whose effector will be invoked, specified via DSL. For example, <code>$brooklyn:entity("tomcat")</code>. See also the <code>targetId</code> parameter.</li>
  <li><code>targetId</code> - alternative to the <code>target</code> parameter which wraps the DSL component lookup requiring only the <code>id</code> be supplied. For example, <code>tomcat</code>.</li>
  <li><code>timeout</code> - duration to wait on the effector task to complete. For example <code>10s</code>, <code>10m</code>, etc</li>
  <li><code>effector</code> - effector to invoke, for example <code>deploy</code>.</li>
  <li><code>params</code> - parameters to pass to the effector, these will depend on the entity and effector being tested. The example above shows the <code>url</code> and <code>targetName</code> parameters being passed to Tomcats <code>deploy</code> effector.</li>
  <li><code>assert</code> - assertion to perform on the returned result. See section on assertions below.</li>
</ul>

<div class="alert alert-info">
    <strong>Tip:</strong> If the <code>TestEffector</code> is wrapped within a <code>TestCase</code>, 
    <code>ParallelTestCase</code> or <code>LoopOverGroupMembersTestCase</code> that set the target, 
    <strong>you don't need to specify the target</strong>, unless you want to test a different entity.
</div>

<h3 id="internalLink_blueprint-test-entities_testhttpcall">TestHttpCall</h3>
<p>The <code>TestHttpCall</code> entity performs a HTTP GET on the specified URL and performs an assertion on the response.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.test.framework.TestHttpCall</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Check HTTP Response Status Code</span>
  <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:entity(&quot;tomcat&quot;).attributeWhenReady(&quot;webapp.url&quot;)</span>
  <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">60s</span>
  <span class="l-Scalar-Plain">applyAssertionTo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">status</span>
  <span class="l-Scalar-Plain">assert</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">isEqualTo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">200</span></code></pre></div>

<h4 id="internalLink_blueprint-test-entities_parameters-4">Parameters</h4>
<ul>
  <li><code>url</code> - URL to perform GET request on, this can use DSL for example <code>$brooklyn:entity("tomcat").attributeWhenReady("webapp.url")</code>.</li>
  <li><code>timeout</code> - duration to wait on a HTTP response. For example <code>10s</code>, <code>10m</code>, etc</li>
  <li><code>applyAssertionTo</code> - The filed to apply the assertion to. For example <code>status</code>, <code>body</code></li>
  <li><code>assert</code> - assertion to perform on the response.  See section on assertions below.</li>
</ul>

<div class="alert alert-info">
    <strong>Tip:</strong> If the <code>TestHttpCall</code> is wrapped within a <code>TestCase</code>, 
    <code>ParallelTestCase</code> or <code>LoopOverGroupMembersTestCase</code> that set the target, 
    <strong>you don't need to specify the target</strong>, unless you want to test a different entity.
</div>

<h3 id="internalLink_blueprint-test-entities_testsshcommand">TestSshCommand</h3>
<p>The TestSshCommand runs a command on the host of the target entity.
The script is expected not to run indefinitely, but to return a result (process exit code), along with its
standard out and error streams, which can then be tested using assertions.
If no assertions are explicitly configured, the default is to assert a non-zero exit code.</p>

<p>Either a bash command may be provided in the YAML, or a URL for a script which will be executed.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.test.framework.TestCase</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">testcase1</span>
  <span class="l-Scalar-Plain">brooklyn.children</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.tomcat.TomcatServer</span>
      <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">testprocess</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.test.framework.TestSshCommand</span>
      <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Check tomcat process running with ps</span>
      <span class="l-Scalar-Plain">targetId</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">testprocess</span>
      <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ps -ef</span>
      <span class="l-Scalar-Plain">assertStatus</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">equals</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
      <span class="l-Scalar-Plain">assertOut</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">contains</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">tomcat</span>
      <span class="l-Scalar-Plain">assertErr</span><span class="p-Indicator">:</span> 
        <span class="l-Scalar-Plain">isEmpty</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.test.framework.TestSshCommand</span>
      <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Check hello world script</span>
      <span class="l-Scalar-Plain">targetId</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">testprocess</span>
      <span class="l-Scalar-Plain">downloadUrl</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://github.com/apache/brooklyn-docs/raw/master/guide/blueprints/test/example_yaml/entities/script1.sh</span>
      <span class="l-Scalar-Plain">assertStatus</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">equals</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
      <span class="l-Scalar-Plain">assertOut</span><span class="p-Indicator">:</span> 
        <span class="l-Scalar-Plain">equals</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hello world</span>
      <span class="l-Scalar-Plain">assertErr</span><span class="p-Indicator">:</span> 
        <span class="l-Scalar-Plain">isEmpty</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span></code></pre></div>

<h4 id="internalLink_blueprint-test-entities_parameters-5">Parameters</h4>
<ul>
  <li><code>command</code> - The shell command to execute. (This and <code>downloadUrl</code> are mutually exclusive.)</li>
  <li><code>downloadUrl</code> - URL for a script to download and execute. (This and <code>command</code> are mutually exclusive.)</li>
  <li><code>shell.env</code> - Map of environment variables to be set.</li>
  <li><code>scriptDir</code> - if <code>downloadUrl</code> is used.  The directory on the target host where downloaded scripts should be copied to.</li>
  <li><code>runDir</code> - the working directory where the command or script will be executed on the target host.</li>
  <li><code>assertStatus</code> - Assertions on the exit code of the command or script. See section on assertions below.</li>
  <li><code>assertOut</code> - Assertions on the standard output of the command as a String.</li>
  <li><code>assertErr</code> -  Assertions on the standard error of the command as a String.</li>
</ul>

<div class="alert alert-info">
    <strong>Tip:</strong> If the <code>TestSshCommand</code> is wrapped within a <code>TestCase</code>, 
    <code>ParallelTestCase</code> or <code>LoopOverGroupMembersTestCase</code> that set the target, 
    <strong>you don't need to specify the target</strong>, unless you want to test a different entity.
</div>

<h2 id="internalLink_blueprint-test-entities_assertions">Assertions</h2>

<p>The following conditions are provided by those test entities above that include assertions</p>

<ul>
  <li><code>isNull</code> - asserts that the actual value is <code>null</code>.</li>
  <li><code>notNull</code> - asserts that the actual value is NOT <code>null</code>.</li>
  <li><code>isEqualTo</code> - asserts that the actual value equals an expected value.</li>
  <li><code>equalTo</code> - a synonym for <code>isEqualTo</code></li>
  <li><code>equals</code> - a synonym for <code>isEqualTo</code></li>
  <li><code>notEqual</code> - asserts that the actual value does not equal the expected value.</li>
  <li><code>matches</code> - asserts that the actual value matches a <a href="http://docs.oracle.com/javase/7/docs/api/java/util/regex/Pattern.html?is-external=true">regex pattern</a>, for example <code>".*hello.*"</code>.
Note that regular expressions follow the Java defaults, e.g. for <a href="http://docs.oracle.com/javase/7/docs/api/java/util/regex/Pattern.html#lt">line terminators</a>. 
One can use <code>"(?m)"</code> for multi-line mode (so that <code>^</code> and <code>$</code> also match just after/before line terminators, 
rather than just the start/end of the entire input sequence). The dotall mode, set with <code>"(?s)"</code>, can also 
be useful (so that <code>.</code> matches any character, including line terminators). </li>
  <li><code>containsMatch</code> - asserts that the value contains a string that matches a regex. It follow the behaviour of 
the <a href="http://docs.oracle.com/javase/7/docs/api/java/util/regex/Matcher.html#find()">Matcher.find() method</a>.
This can be useful for simplifying matching in multi-line input.</li>
  <li><code>contains</code> - asserts that the actual value contains the supplied value</li>
  <li><code>isEmpty</code> - asserts that the actual value is an empty string</li>
  <li><code>notEmpty</code> - asserts that the actual value is a non empty string</li>
  <li><code>hasTruthValue</code> - asserts that the actual value has the expected interpretation as a boolean</li>
  <li><code>greaterThan</code> - asserts that the actual value is greater than the expected value according to Java’s
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Comparable.html">Comparable</a> interface. Actual and
expected must be instances of the same type and implement <code>Comparable</code>.</li>
  <li><code>lessThan</code> - asserts that the actual value is less than the expected value according to Java’s
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Comparable.html">Comparable</a> interface. Actual and
expected must be instances of the same type and implement <code>Comparable</code>.</li>
</ul>

<p>Assertions may be provided as a simple map:</p>

<pre><code>assert:
  contains: 2 users
  matches: .*[\d]* days.*
</code></pre>

<p>If there is the need to make multiple assertions with the same key, the assertions can be specified
as a list of such maps:</p>

<pre><code>assert:
 - contains: 2 users
 - contains: 2 days
</code></pre>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-example-blueprint-tests" class="section-breaker section p-">
	<span style="width: 100%"><h1>Example Blueprint Tests</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	
<h2 id="internalLink_example-blueprint-tests_introduction">Introduction</h2>
<p>This section describes some simple tests based on the <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/start/blueprints.html">Getting Started</a> example blueprint:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">My Web Cluster</span>

<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">jclouds:aws-ec2</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">identity</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ABCDEFGHIJKLMNOPQRST</span>
    <span class="l-Scalar-Plain">credential</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">s3cr3tsq1rr3ls3cr3tsq1rr3ls3cr3tsq1rr3l</span>

<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.ControlledDynamicWebAppCluster</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">My Web</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">webappcluster</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">wars.root</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=org/apache/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.8.0-incubating/brooklyn-example-hello-world-sql-webapp-0.8.0-incubating.war</span>
    <span class="l-Scalar-Plain">java.sysprops</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">brooklyn.example.db.url</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
        <span class="no">$brooklyn:formatString(&quot;jdbc:%s%s?user=%s&amp;password=%s&quot;,</span>
        <span class="no">component(&quot;db&quot;).attributeWhenReady(&quot;datastore.url&quot;),</span>
        <span class="no">&quot;visitors&quot;, &quot;brooklyn&quot;, &quot;br00k11n&quot;)</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.database.mysql.MySqlNode</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">My DB</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">db</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">creationScriptUrl</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://bit.ly/brooklyn-visitors-creation-script</span></code></pre></div>

<p>The following sections contain yaml snippets that be appended to the list of services in the blueprint above, a complete blueprint is also provided <a href="#internalLink_example-blueprint-tests_full-example">below</a>.</p>

<p>Note that unless otherwise specified the following tests are executed in parallel with the deployment of the application services, all <code>timeout</code> values are set accordingly.</p>

<h3 id="internalLink_example-blueprint-tests_sensor-test">Sensor Test</h3>

<p>Demonstrates the following sensor assertion:</p>

<ul>
  <li>asserts that the <code>webappcluster</code> entity <code>service.isUp</code> sensor is <code>true</code> within 10 minutes of blueprint being deployed.</li>
</ul>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.test.framework.TestSensor</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Check webappcluster isUp</span>
  <span class="l-Scalar-Plain">targetId</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">webappcluster</span>
  <span class="l-Scalar-Plain">sensor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">service.isUp</span>
  <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10m</span>
  <span class="l-Scalar-Plain">assert</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">equals</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span></code></pre></div>

<h3 id="internalLink_example-blueprint-tests_http-call-tests">HTTP Call Tests</h3>
<p>Demonstrates the following HTTP Call assertions against the specified <code>url</code>, which in these examples are being built from the <code>webappcluster</code> entities <code>host.address</code> and <code>proxy.http.port</code> sensors (the tester having flexibility in how the test URL is to be constructed):</p>

<ul>
  <li>asserts the response status code is 200 within 10 minutes of the blueprint being deployed.</li>
  <li>asserts the response body matches the regex <code>(?s).*Br[o]{2}klyn Deployed.*</code> within 10 minutes of the blueprint being deployed. Note the presence of the <code>(?s)</code> dotall flag to test a multiline response.</li>
</ul>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.test.framework.TestHttpCall</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Check HTTP Response Status Code</span>
  <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
    <span class="no">$brooklyn:formatString(&quot;http://%s:%s/newcontext/&quot;,</span>
    <span class="no">$brooklyn:component(&quot;webappcluster&quot;).attributeWhenReady(&quot;host.address&quot;),</span>
    <span class="no">$brooklyn:component(&quot;webappcluster&quot;).attributeWhenReady(&quot;proxy.http.port&quot;))</span>
  <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10m</span>
  <span class="l-Scalar-Plain">applyAssertionTo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">status</span>
  <span class="l-Scalar-Plain">assert</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">equals</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">200</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.test.framework.TestHttpCall</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Check HTTP Response Body</span>
  <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
    <span class="no">$brooklyn:formatString(&quot;http://%s:%s/newcontext/&quot;,</span>
    <span class="no">$brooklyn:component(&quot;webappcluster&quot;).attributeWhenReady(&quot;host.address&quot;),</span>
    <span class="no">$brooklyn:component(&quot;webappcluster&quot;).attributeWhenReady(&quot;proxy.http.port&quot;))</span>
  <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10m</span>
  <span class="l-Scalar-Plain">applyAssertionTo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">body</span>
  <span class="l-Scalar-Plain">assert</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">matches</span><span class="p-Indicator">:</span> <span class="s">&quot;(?s).*Br[o]{2}klyn</span><span class="nv"> </span><span class="s">Deployed.*&quot;</span></code></pre></div>

<h3 id="internalLink_example-blueprint-tests_effector-test-via-testcase-entity">Effector Test (via TestCase entity)</h3>

<p>This <code>TestEffector</code> example demonstrates the use of the <code>TestCase</code> and <code>TestSensor</code> entities to ensure the service has started before invoking an effector using the <code>TestEffector</code> entity.</p>

<ul>
  <li><code>TestCase</code> entity starts its children sequentially
    <ul>
      <li>asserts that the <code>webappcluster</code> entity <code>service.isUp</code> sensor is <code>true</code> within 10 minutes of the parent <code>TestCase</code> entity starting. Blocks start of the next child until it obtains a result (or times out).</li>
      <li><code>deploy</code> effector invoked to deploy war to a <code>newcontext</code> with a 5 minute timeout to allow completion of the deploy task.</li>
      <li>asserts <code>/newcontext</code> url returns a HTTP status code 200 within 5 minutes of the effector being invoked (Note that this timeout is relative to the preceding test entity as they are being sequentially run as children of a <code>TestCase</code> entity).</li>
    </ul>
  </li>
</ul>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.test.framework.TestCase</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Check Deploy Effector</span>
  <span class="l-Scalar-Plain">brooklyn.children</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.test.framework.TestSensor</span>
    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Check webappcluster isUp</span>
    <span class="l-Scalar-Plain">targetId</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">webappcluster</span>
    <span class="l-Scalar-Plain">sensor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">service.isUp</span>
    <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10m</span>
    <span class="l-Scalar-Plain">assert</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">equals</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.test.framework.TestEffector</span>
    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Invoke Deploy Effector</span>
    <span class="l-Scalar-Plain">targetId</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">webappcluster</span>
    <span class="l-Scalar-Plain">effector</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">deploy</span>
    <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5m</span>
    <span class="l-Scalar-Plain">params</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=org/apache/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.8.0-incubating/brooklyn-example-hello-world-sql-webapp-0.8.0-incubating.war</span>
      <span class="l-Scalar-Plain">targetName</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">newcontext</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.test.framework.TestHttpCall</span>
    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Check Deployed Webapp Status Code</span>
    <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5m</span>
    <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
      <span class="no">$brooklyn:formatString(&quot;http://%s:%s/newcontext/&quot;,</span>
      <span class="no">$brooklyn:entity(&quot;webappcluster&quot;).attributeWhenReady(&quot;host.address&quot;),</span>
      <span class="no">$brooklyn:entity(&quot;webappcluster&quot;).attributeWhenReady(&quot;proxy.http.port&quot;))</span>
    <span class="l-Scalar-Plain">applyAssertionTo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">status</span>
    <span class="l-Scalar-Plain">assert</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">isEqualTo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">200</span></code></pre></div>

<h3 id="internalLink_example-blueprint-tests_full-example">Full Example</h3>
<p>A sample blueprint containing all the tests described above is available <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/blueprints/test/example_yaml/testcases/getting-started-test-example.yaml">here</a>.</p>

<p>This blueprint will deploy the <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/start/blueprints.html">Getting Started</a> application and run all of the test entities, which if successful should appear in the web console as follows.</p>

<p><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/blueprints/test/images/getting-started-blueprint-test-large.png"><img src="./v/latest/blueprints/test/images/getting-started-blueprint-test.png" alt="Successful Getting Started App deployment and Test execution." /></a></p>

	</div>
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-ansible-in-yaml-blueprints" class="section-breaker section p-">
	<span style="width: 100%"><h1>Ansible in YAML Blueprints</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>This guide describes how Brooklyn entities can be created using the Ansible infrastructure management tool
 (<a href="http://ansible.com">ansible.com</a>).
At present Brooklyn provides basic support for Ansible, operating in a ‘masterless’ mode. 
Comments on this support and suggestions for further development are welcome.</p>

<p>This guide assumes you are familiar with the basics of <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/blueprints/ansible/../index.html">creating YAML blueprints</a>.</p>

<div class="list-children"><ul>

<li> <a href="#contentsLink-about-ansible">About Ansible</a> </li>

<li> <a href="#contentsLink-creating-blueprints-with-ansible">Creating Blueprints with Ansible</a> </li>

</ul></div>

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-about-ansible" class="section-breaker section p-">
	<span style="width: 100%"><h1>About Ansible</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_about-ansible_what-you-need-to-know-about-ansible">What you need to know about Ansible</h2>

<p><a href="http://docs.ansible.com/ansible/">Ansible</a> is a deployment tool designed to work in an agent-less manner, normally 
performing its operations on a node over SSH from some central administrating node.  Brooklyn can deploy software 
via Ansible on one of its managed nodes, by first installing Ansible on the node itself and then using Ansible to deploy
the required software.</p>

<p>A ‘Playbook’ in Ansible is a specification of the configuration and deployment of a system. 
Playbooks are expressed in YAML format, and contain a number of ‘plays’, which are in turn lists of tasks to carry out
to achieve the desired configuration on the system.  ‘Roles’ are pre-written modular collections of tasks, and can
be included in playbooks.</p>

<p>Ansible comes with built-in support for many software systems, and has a community repository of roles exists at 
<a href="https://galaxy.ansible.com">https://galaxy.ansible.com</a>.</p>

<h3 id="internalLink_about-ansible_how-brooklyn-interacts-with-ansible">How Brooklyn interacts with Ansible</h3>

<p>Brooklyn provides a Ansible entity type. An entity of this type can be specified in a blueprint in order to provision the 
node through Ansible. The Ansible entity will download Ansible and install it on the node. The entity type supports the 
configuration of Ansible playbooks to download, or write inline in the blueprint, for simple playbooks.
Configuration values for the playbooks can be supplied in the blueprint.  </p>

<p>Brooklyn will deploy the software specified in the playbook when the entity starts.  In addition, an effector is 
provided on the entity that supports general purpose Ansible instructions.</p>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-creating-blueprints-with-ansible" class="section-breaker section p-">
	<span style="width: 100%"><h1>Creating Blueprints with Ansible</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>To write a blueprint to use Ansible with Brooklyn it will help to have a degree of familiarity with Ansible itself. In the 
sections below, when the Brooklyn configuration is described, the underlying Ansible operation is also noted briefly, for 
clarity for readers who know Ansible.</p>

<p>To manage a node with Ansible, create a blueprint containing a service of type <code>org.apache.brooklyn.entity.cm.ansible.AnsibleEntity</code>
and define and minimum the <code>playbook</code> value, and one or other of <code>playbook.url</code> or <code>playbook.yaml</code>. You must also define
the <code>service.name</code> that will be tested in order to determine if the entity is running successfully.</p>

<p>For example:</p>

<pre><code>name: myweb
location: ...
services:
  - type: org.apache.brooklyn.entity.cm.ansible.AnsibleEntity
    id: apache
    name: apache
    service.name: apache2
    playbook: apache-playbook
    playbook.url: http://myhost/projectX/apache-playbook.yaml
</code></pre>

<p>This example specifies that Brooklyn should use Ansible to download the playbook from the repository on
“myhost”. The playbook contains the instructions to install the Apache web server. To start the 
entity, Brooklyn will use Ansible’s “ansible-playbook” command to run the playbook, which will bring up the web server.</p>

<h3 id="internalLink_creating-blueprints-with-ansible_lifecycle-of-ansibleentity">Lifecycle of AnsibleEntity</h3>

<p>The start effector applies the playbook and verifies that it has started the software correctly by checking the service
defined as <code>service.name</code> is running.  This can be customized, see <code>ansible.service.start</code> configuration below.</p>

<p>The stop effector will stop the service <code>service.name</code>.  Again, this can be customized, with <code>ansible.service.stop</code>. </p>

<p>The restart effector will apply stop and then start.</p>

<h3 id="internalLink_creating-blueprints-with-ansible_configuration-of-ansibleentity">Configuration of AnsibleEntity</h3>

<p>The <code>playbook</code> configuration key names the top level list of states that will be applied using Ansible.<br />
 This configuration key is mandatory.</p>

<p>The playbook must be defined using one or other (both together are not permitted) of  <code>playbook.yaml</code> or <code>playbook.url</code>.
The former allows the playbook content to be defined inline within the blueprint, using the normal YAML format of an 
Ansible playbook.  The latter obtains the playbook from an external URL.</p>

<p>The <code>ansible.service.start</code> configuration key allows the blueprint author to override the command used by default to 
verify that the service <code>service.name</code> is running (or to start it, if the playbook did not specify it should run by
default).  The default value is:</p>

<pre><code>sudo ansible localhost -c local -m service -a "name=&lt;service.name&gt; state=started"
</code></pre>

<p>Similarly the <code>ansible.service.stop</code> configuration key permits override of the instruction used to get Ansible to stop the
service, by default</p>

<pre><code>sudo ansible localhost -c local -m service -a "name=&lt;service.name&gt; state=stopped"
</code></pre>

<p>The <code>ansible.service.checkPort</code> configuration key allows the user to override the mechanism used to check that the 
service <code>service.name</code> is operating. By default Brooklyn checks that the service process is running. However, if the
 service is one that listens on a particular port, this configuration key allows the blueprint author to instruct
 Brooklyn to check that the port is being listened on, using the Ansible <code>wait_for</code> module. The value of the key is 
 the port number to check.</p>

<p>The <code>ansible.vars</code> configuration key allows the blueprint author to provide entity-specific values for configuration
variables used in the playbook, so that one playbook can be used by multiple entities, each customized appropriately.
The value of <code>ansible.vars</code> is an arbitrary block of YAML configuration that will be applied to the playbook using 
Ansible’s <code>--extra-vars</code> mechanism, as described in the
Ansible <a href="http://docs.ansible.com/ansible/playbooks_variables.html#passing-variables-on-the-command-line">documentation</a>.
For example, if the playbook in the example above contained configuration such as:</p>

<pre><code>- hosts: all
  vars:
    http_port: 80
    max_clients: 200
  remote_user: root
  tasks:
  ...
</code></pre>

<p>then to change the port that the webserver in the example above runs on, it would be possible to define the following 
 in the blueprint:</p>

<pre><code>name: myweb
location: ...
services:
  - type: org.apache.brooklyn.entity.cm.ansible.AnsibleEntity
    id: apache
    name: apache
    service.name: apache2
    playbook: apache-playbook
    playbook.url: http://myhost/projectX/apache-playbook.yaml
    ansible.vars:
        http_port: 8080
</code></pre>

<h3 id="internalLink_creating-blueprints-with-ansible_ansiblecall-effector">ansibleCall Effector</h3>

<p>The Ansible entity includes a general purpose Ansible effector, <code>ansibleCommand</code>, which permits execution of Ansible 
commands via <code>ansible</code>.  It contains a two parameters:
1. <code>module</code> specifies the Ansible module to invoke.  The default is “command”.
2. <code>args</code> specifies the argument data for the Ansible module.  For example, to download an additional file for the 
webserver, the command could be invoked with the following arguments. (For convenience this
example uses the client CLI, “br”, but the effector could be invoked by any applicable means, e.g. via the web UI 
or REST API.)</p>

<pre><code>$ br app myweb ent apache effector ansibleCommand invoke \
   -P module=shell -P args='curl http://myhost:8080/additional.html &gt; /var/www/html/additional.html'
</code></pre>

<h3 id="internalLink_creating-blueprints-with-ansible_roles-and-multi-playbook-installations">Roles and Multi-Playbook Installations</h3>

<p>There is no specific configuration in AnsibleEntity for Ansible <a href="http://docs.ansible.com/ansible/playbooks_roles.html">Roles</a>,
 or to install multiple playbooks. However, the installation of roles or multiple playbooks can be carried out first 
 by taking advantage of Brooklyn’s SameServerEntity. The installation step can be applied in one child of the same server
 entity, while the AnsibleEntity can operate under the second child. It will typically be necessary to delay the start
 of the AnsibleEntity until the first child has carried out whatever preparation is required. The examples below
 illustrate the concept (with just one playbook, for brevity).</p>

<p>One way to a achieve this, as with any Brooklyn entity, is to use the idiom of making it a child of a BasicApplication 
 with a start latch waiting on the first child, such as in the following example, which installs the standalone Tomcat example,
 with its playbook and roles, from the “Ansible Examples” Github site. 
 (Note, this is designed for installation on Redhat/Centos 6.)
 The first child in the SameServerEntity downloads
 and unpacks the Ansible examples. This might also install standalone Ansible roles, or whatever other resources the
 AnsibleEntity might require.  The second child uses <code>attributeWhenReady</code> to block until the first is ready, before 
 starting the AnsibleEntity to apply the desired playbook.</p>

<pre><code>name: multi
location:
  red1
services:
- serviceType: brooklyn.entity.basic.SameServerEntity
  name: Entities
  brooklyn.children:
  
  - serviceType: org.apache.brooklyn.entity.cm.ansible.AnsibleEntity
    id: bootstrap
    service.name: crond
    playbook: bootstrap
    playbook.yaml: |
        ---
        - hosts: localhost
          tasks:
          - shell: printf "[tomcat-servers]\nlocalhost ansible_connection=local\n" &gt;&gt; /etc/ansible/hosts
          - file: path=/etc/ansible/playbooks state=directory mode=0755
          - get_url: url=https://github.com/ansible/ansible-examples/archive/master.zip dest=/tmp/master.zip mode=0440
          - command: unzip -o -d /etc/ansible/playbooks /tmp/master.zip

  - serviceType: org.apache.brooklyn.entity.stock.BasicApplication
    start.latch: $brooklyn:entity("bootstrap").attributeWhenReady("service.isUp")
    brooklyn.children:
    - type: org.apache.brooklyn.entity.cm.ansible.AnsibleEntity
      name: test
      service.name: tomcat
      playbook: tomcat
      playbook.yaml: |
          ---
          - hosts: localhost
          - include: /etc/ansible/playbooks/ansible-examples-master/tomcat-standalone/site.yml
            vars:
                http_port: 8080
                https_port: 8443
                admin_username: admin
                admin_password: secret
</code></pre>

<p>An alternative to the above is to use Ansible itself to do the waiting, as in the variant below, which uses AnsibleEntity
itself in the first SameServerEntity child, to install the required material.  In the second child, which is simply an
AnsibleEntity rather than a BasicApplication, Ansible’s <code>wait_for</code> operation is used as the first step in the playbook, 
to block the remaining steps in its playbook until the first is complete.</p>

<pre><code>name: multi
location:
  red1
services:
- serviceType: brooklyn.entity.basic.SameServerEntity
  name: Entities
  brooklyn.children:
  
  - serviceType: org.apache.brooklyn.entity.cm.ansible.AnsibleEntity
    id: bootstrap
    service.name: crond
    playbook: bootstrap
    playbook.yaml: |
        ---
        - hosts: localhost
          tasks:
          - command: rm -f /tmp/bootstrap.done
          - shell: printf "[tomcat-servers]\nlocalhost ansible_connection=local\n" &gt;&gt; /etc/ansible/hosts
          - file: path=/etc/ansible/playbooks state=directory mode=0755
          - get_url: url=https://github.com/ansible/ansible-examples/archive/master.zip dest=/tmp/master.zip mode=0440
          - command: unzip -o -d /etc/ansible/playbooks /tmp/master.zip
          - file: path=/tmp/bootstrap.done state=touch

  - serviceType: org.apache.brooklyn.entity.cm.ansible.AnsibleEntity
    name: test
    service.name: tomcat
    playbook: tomcat
    playbook.yaml: |
        ---
        - tasks:
          - wait_for: path=/tmp/bootstrap.done
          include: /etc/ansible/playbooks/ansible-examples-master/tomcat-standalone/site.yml
          vars:
            http_port: 8080
            https_port: 8443
            admin_username: admin
            admin_password: secret
</code></pre>


	</div>
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-chef-in-yaml-blueprints" class="section-breaker section p-">
	<span style="width: 100%"><h1>Chef in YAML Blueprints</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>This guide describes how Brooklyn entities can be easily created from Chef cookbooks.
As of this writing (May 2014) some of the integration points are under active development,
and comments are welcome.
A plan for the full integration is online <a href="https://docs.google.com/a/cloudsoftcorp.com/document/d/18ZwzmncbJgJeQjnSvMapTWg6N526cvGMz5jaqdkxMf8">here</a>.  </p>

<p>This guide assumes you are familiar with the basics of <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/blueprints/chef/../index.html">creating YAML blueprints</a>.</p>

<div class="list-children"><ul>

<li> <a href="#contentsLink-about-chef">About Chef</a> </li>

<li> <a href="#contentsLink-creating-blueprints-from-chef">Creating Blueprints from Chef</a> </li>

<li> <a href="#contentsLink-writing-chef-for-blueprints">Writing Chef for Blueprints</a> </li>

<li> <a href="#contentsLink-advanced-chef-integration">Advanced Chef Integration</a> </li>

</ul></div>

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-about-chef" class="section-breaker section p-">
	<span style="width: 100%"><h1>About Chef</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_about-chef_what-you-need-to-know-about-chef">What you need to know about Chef</h2>

<p>Chef works in two different modes, <em>server</em> and <em>solo</em>. <em>Server</em> is where the Chef client talks to a central server
to retrieve information about its roles, policies and cookbooks (where a cookbook defines how to install and
configure a particular piece of software). With <em>solo</em>, the client works in isolation, therefore its configuration
and cookbooks must be supplied by another means.</p>

<p>Chef <em>client</em> is the Chef agent. This is a Ruby application which is installed on each and every managed host. When
invoked in server mode, it will contact the Chef server to check for updates to cookbooks and policy; it then “runs”
the recipes in its run lists, to converge the machine to a known state. In solo mode, it reads the locally-maintained
cookbooks and policies. The client may be run as a daemon that checks the server regularly, or it could merely be
run manually when required.</p>

<p>The <em>policy</em> is a set of rules on the Chef server. A client starts with a set of <em>attributes</em>, which could be as
simple as its name and a recipe runlist, or which may involve a more complex set of attributes about how it is to be
configured. The client then augments this with auto-detected metadata - a tool called <code>ohai</code> is run that collects
detailed information about the host. Next, the policy on the server modifies these attributes - overriding some,
setting defaults for others - to produce a final set of attributes. It is these which are the input to the recipes.
Finally, the attributes are uploaded to the server where they are stored as metadata for the node, where they can be
inspected and modified by the system operator.</p>

<p>Also of interest is <code>knife</code>, which is the workstation toolkit for Chef. Typically this would be installed on the
operation engineer’s workstation, where it would be used to interact with the Chef server and clients. Of particular
interest to us is the <em>bootstrap</em> operation, which is used for setting up new Chef clients - given a virtual machine,
it will install the Chef client on it, configure it with enough information to find the Chef server and performs its
first run, and then kicks off the Chef client for the first time.</p>

<p>There is often a preconception about how a Chef client is bootstrapped; mistakenly, there is the belief that the
<code>knife</code> tool configures the Chef server with information about the client, and the client finds out about itself from
the server. This is not the case - the bootstrap operation does not involve <code>knife</code> talking to the server. Instead,
<code>knife</code> packages up all of the required information and sends it to the client - the client will then introduce
itself to the server, passing on its configuration.</p>

<p>This diagram summarises the interaction between Brooklyn, the new node, and the various Chef tools. Note that there
is no interaction between the Apache Brooklyn Server and the Chef Server.</p>

<p><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/blueprints/chef/chef-call-flow.png"><img src="./v/latest/blueprints/chef/chef-call-flow.png" alt="Chef Flow Diagram" title="Chef Flow Diagram" /></a></p>

<h3 id="internalLink_about-chef_how-brooklyn-interacts-with-chef">How Brooklyn interacts with Chef</h3>

<p>Brooklyn understands both the <em>server</em> and <em>solo</em> modes of operation. Server mode utilises the <code>knife</code> toolkit, and
therefore <code>knife</code> must be installed onto the Apache Brooklyn server and configured appropriately. Solo mode does not have any
special requirements; when running in solo mode, Brooklyn will install and configure the Chef client over SSH, just
like it does most other kinds of entities.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-creating-blueprints-from-chef" class="section-breaker section p-">
	<span style="width: 100%"><h1>Creating Blueprints from Chef</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>In a nutshell, a new Chef-based entity can be defined as a service by specifying
<code>chef:cookbook_name</code> as the <code>service_type</code>, along with a collection of optional configuration.
An illustrative example is below:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">chef-mysql-sample</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">chef:mysql</span>
  
  <span class="l-Scalar-Plain">cookbook_urls</span><span class="p-Indicator">:</span>
    <span class="c1"># only needed for chef solo; URL can be local to brooklyn, or github, etc...</span>
    <span class="l-Scalar-Plain">mysql</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://github.com/opscode-cookbooks/mysql/archive/v4.0.12.tar.gz</span>
    <span class="l-Scalar-Plain">openssl</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://github.com/opscode-cookbooks/openssl/archive/v1.1.0.tar.gz</span>
    <span class="l-Scalar-Plain">build-essential</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://github.com/opscode-cookbooks/build-essential/archive/v1.4.4.tar.gz</span>
  
  <span class="l-Scalar-Plain">launch_run_list</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span> <span class="s">&quot;mysql::server&quot;</span> <span class="p-Indicator">]</span>
  <span class="l-Scalar-Plain">launch_attributes</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">mysql</span><span class="p-Indicator">:</span>
      <span class="c1"># these attrs are required by the mysql cookbook under node[&#39;mysql&#39;]</span>
      <span class="l-Scalar-Plain">server_root_password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">p4ssw0rd</span>
      <span class="l-Scalar-Plain">server_repl_password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">p4ssw0rd</span>
      <span class="l-Scalar-Plain">server_debian_password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">p4ssw0rd</span>
      <span class="c1"># many others are attrs are supported by the cookbook and can be passed here...</span>
      
  <span class="c1"># how to determine if the process is running and how to kill it</span>
  <span class="c1"># (supported options are `service_name` and `pid_file`; normally you should just pick one.</span>
  <span class="c1"># here we use the pid_file because the service_name varies, mysql on centos, mysqld on ubuntu!)</span>
  <span class="c1">#service_name: mysqld</span>
  <span class="l-Scalar-Plain">pid_file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/var/run/mysqld/mysqld.pid</span></code></pre></div>

<p><em>This works without any installation: try it now, copying-and-pasting to the Brooklyn console.
(Don’t forget to add your preferred <code>location: some-cloud</code> to the spec.)</em>  </p>

<p>Notice, if you target <code>google-compute-engine</code> location, you may need to specify <code>bind_address: 0.0.0.0</code> for the <code>mysql</code> cookbook, as described <a href="https://github.com/chef-cookbooks/mysql/blob/46dccac22d282a05ee6a401e10ae8f5f8114fd66/README.md#parameters">here</a>.</p>

<p>We’ll now walk through the important constituent parts,
and then proceed to describing things which can be done to simplify the deployment.</p>

<h3 id="internalLink_creating-blueprints-from-chef_cookbook-primary-name">Cookbook Primary Name</h3>

<p>The first thing to note is the type definition:</p>

<pre><code>- type: chef:mysql
</code></pre>

<p>This indicates that the Chef entity should be used (<code>org.apache.brooklyn.entity.chef.ChefEntity</code>) 
to interpret and pass the configuration,
and that it should be parameterised with a <code>brooklyn.chef.cookbook.primary.name</code> of <code>mysql</code>.
This is the cookbook namespace used by default for determining what to install and run.</p>

<h3 id="internalLink_creating-blueprints-from-chef_importing-cookbooks">Importing Cookbooks</h3>

<p>Next we specify which cookbooks are required and where they can be pulled from:</p>

<pre><code>  cookbook_urls:
    mysql: https://github.com/opscode-cookbooks/mysql/archive/v4.0.12.tar.gz
    openssl: https://github.com/opscode-cookbooks/openssl/archive/v1.1.0.tar.gz
    build-essential: https://github.com/opscode-cookbooks/build-essential/archive/v1.4.4.tar.gz
</code></pre>

<p>Here, specific versions are being downloaded from the canonical github repository.
Any URL can be used, so long as it is resolvable on either the target machine or the
Brooklyn server; this includes <code>file:</code> and <code>classpath:</code> URLs.</p>

<p>The archive can be ZIP or TAR or TGZ.</p>

<p>The structure of the archive must be that a single folder is off the root,
and in that folder contains the usual Chef recipe and auxiliary files.
For example, the archive might contain <code>mysql-master/recipes/server.rb</code>.
Archives such as those above from github match this format.<br />
The name of that folder does not matter, as often they contain version information.
When deployed, these will be renamed to match the short name (the key in the <code>cookbooks_url</code> map,
for instance <code>mysql</code> or <code>openssl</code>).</p>

<p>If Chef server is configured (see below), this section can be omitted.</p>

<h3 id="internalLink_creating-blueprints-from-chef_launch-run-list-and-attributes">Launch Run List and Attributes</h3>

<p>The next part is to specify the Chef run list and attributes to store when launching the entity: </p>

<pre><code>  launch_run_list:
  - mysql::server
  
  launch_attributes:
    mysql:
      server_root_password: p4ssw0rd
      server_repl_password: p4ssw0rd
      server_debian_password: p4ssw0rd
</code></pre>

<p>For the <code>launch_run_list</code>, you can use either the YAML <code>- recipe</code> syntax or the JSON <code>[ "recipe" ]</code> syntax.</p>

<p>The <code>launch_attributes</code> key takes a map which will be stored against the <code>node</code> object in Chef.
Thus in this example, the parameter <code>node['mysql']['server_root_password']</code> required by the mysql blueprint
is set as specified.</p>

<p>You can of course set many other attributes in this manner, in addition to those that are required!  </p>

<h3 id="internalLink_creating-blueprints-from-chef_simple-monitoring">Simple Monitoring</h3>

<p>The final section determines how Brooklyn confirms that the service is up.
Sophisticated solutions may install monitoring agents as part of the <code>launch_run_list</code>,
with Brooklyn configured to read monitoring information to confirm the launch was successful.
However for convenience, two common mechanisms are available out of the box:</p>

<pre><code>  #service_name: mysqld
  pid_file: /var/run/mysqld/mysqld.pid
</code></pre>

<p>If <code>service_name</code> is supplied, Brooklyn will check the return code of the <code>status</code> command
run against that service, ensuring it is 0.  (Note that this is not universally reliable,
although it is the same mechanism which Chef typically uses to test status when determining
whether to start a service. Some services, e.g. postgres, will return 0 even if the service
is not running.)</p>

<p>If a <code>pid_file</code> is supplied, Brooklyn will check whether a process with the PID specified in that
file is running. This has been selected for mysql because it appears to be more portable:
the service name varies among OS’s:  it is <code>mysqld</code> on CentOS but <code>mysql</code> on Ubuntu!</p>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-writing-chef-for-blueprints" class="section-breaker section p-">
	<span style="width: 100%"><h1>Writing Chef for Blueprints</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_writing-chef-for-blueprints_making-it-simpler">Making it Simpler</h2>

<p>The example we’ve just seen shows how existing Chef cookbooks can be
used as the basis for entities.  If you’re <em>writing</em> the Chef recipes, 
there are a few simple techniques we’ve established with the Chef community
which make blueprints literally as simple as:</p>

<pre><code>- type: chef:mysql
  brooklyn.config:
    mysql_password: p4ssw0rd
    pid_file: /var/run/mysqld/mysqld.pid
</code></pre>

<h3 id="internalLink_writing-chef-for-blueprints_some-basic-conventions">Some Basic Conventions</h3>

<ul>
  <li>
    <p><strong>A <code>start</code> recipe</strong>:
The first step is to provide a <code>start</code> recipe in <code>recipes/start.rb</code>;
if no <code>launch_run_list</code> is supplied, this is what will be invoked to launch the entity.
It can be as simple as a one-line file:</p>

    <pre><code>include_recipe 'mysql::server'
</code></pre>
  </li>
  <li>
    <p><strong>Using <code>brooklyn.config</code></strong>:
All the <code>brooklyn.config</code> is passed to Chef as node attributes in the <code>node['brooklyn']['config']</code> namespace.
Thus if the required attributes in the mysql recipe are set to take a value set in
<code>node['brooklyn']['config']['mysql_password']</code>, you can dispense with the <code>launch_attributes</code> section.</p>
  </li>
</ul>

<h2 id="internalLink_writing-chef-for-blueprints_using-chef-server">Using Chef Server</h2>

<p>The examples so far have not required Chef Server, so they will work without any external
Chef dependencies (besides the built-in install from <code>https://www.opscode.com/chef/install.sh</code>
and the explicitly referenced cookbooks).  If you use Chef Server, however, you’ll want your
managed nodes to be integrated with it.  This is easy to set up, with a few options:</p>

<p>If you have <code>knife</code> set up in your shell environment, the Brooklyn Chef support will use it
by default. If the recipes are installed in your Chef server, you can go ahead and remove
the <code>cookbooks_url</code> section!</p>

<p>Use of <code>solo</code> or <code>knife</code> can be forced by setting the <code>chef_mode</code> flag (<code>brooklyn.chef.mode</code> config key)
to either of those values.  (It defaults to <code>autodetect</code>, which will use <code>knife</code> if it is on the path and satisfies
sanity checks).</p>

<p>If you want to specify a different configuration, there are a number of config keys you can use:</p>

<ul>
  <li><code>brooklyn.chef.knife.executableFile</code>: this should be point to the knife binary to use</li>
  <li><code>brooklyn.chef.knife.configFile</code>: this should point to the knife configuration to use</li>
  <li><code>brooklyn.chef.knife.setupCommands</code>: an optional set of commands to run prior to invoking knife,
for example to run <code>rvm</code> to get the right ruby version on the Brooklyn server</li>
</ul>

<p>If you’re interested in seeing the Chef REST API be supported directly (without knife),
please let us know.  We’d like to see this too, and we’ll help you along the way!</p>

<h2 id="internalLink_writing-chef-for-blueprints_tips-and-tricks">Tips and Tricks</h2>

<p>To help you on your way writing Chef blueprints, here are a handful of pointers
particularly useful in this context:</p>

<ul>
  <li>
    <p>Configuration keys can be inherited from the top-level and accessed using <code>$brooklyn:entity('id').config('key_name')</code>.
An example of this is shown in the <code>mysql-chef.yaml</code> sample recipe contained in the Brooklyn code base
and <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/blueprints/chef/example_yaml/mysql-chef-2.yaml">here</a> for convenience.
Here, <code>p4ssw0rd</code> is specified only once and then used for all the attributes required by the stock mysql cookbook.  </p>
  </li>
  <li>
    <p>Github tarball downloads! You’ll have noticed these in the example already, but they are so useful we thought
we’d call them out again. Except when you’re developing, we recommend using specific tagged versions rather than master.</p>
  </li>
  <li>
    <p>The usual machine <code>provisioning.properties</code> are supported with Chef blueprints, 
so you can set things like <code>minRam</code> and <code>osFamily</code></p>
  </li>
  <li>
    <p>To see more configuration options, and understand the ones presented here in more detail, see the javadoc or
the code for the class <code>ChefConfig</code> in the Brooklyn code base.</p>
  </li>
</ul>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-advanced-chef-integration" class="section-breaker section p-">
	<span style="width: 100%"><h1>Advanced Chef Integration</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h3 id="internalLink_advanced-chef-integration_adding-sensors-and-effectors">Adding Sensors and Effectors</h3>

<p>Custom sensors and effectors can be added using an <code>entity.initializer</code> section in the YAML blueprint.</p>

<p>One common pattern is to have sensors which extract information from Ohai.
Another common pattern is to install a monitoring agent as part of the run list,
configured to talk to a monitoring store, and then to add a sensor feed which reads data from that store.</p>

<p>On the effector side, you can add SSH-based effectors in the usual way.
You can also describe additional chef converge targets following the pattern set down in
<code>ChefLifecycleEffectorTasks</code>, making use of conveniences in <code>ChefSoloTasks</code> and <code>ChefServerTasks</code>,
or provide effectors which invoke network API’s of the systems under management
(for example to supply the common <code>executeScript</code> effector as on the standard <code>MySqlNode</code>). </p>

<h3 id="internalLink_advanced-chef-integration_next-steps-simpifying-sensors-and-effectors-transferring-files-and-configuring-ports">Next Steps: Simpifying sensors and effectors, transferring files, and configuring ports</h3>

<p>The Brooklyn-Chef integration is work in progress, with a few open issues we’d still like to add.
Much of the thinking for this is set forth in the <a href="https://docs.google.com/a/cloudsoftcorp.com/document/d/18ZwzmncbJgJeQjnSvMapTWg6N526cvGMz5jaqdkxMf8">Google document</a>
indicated earlier.  If you’d like to work with us to implement these, please let us know.</p>

<h2 id="internalLink_advanced-chef-integration_reference">Reference</h2>

<p>A general schema for the supported YAML is below: </p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">chef:cookbook_name</span>
  <span class="l-Scalar-Plain">cookbook_urls</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">cookbook_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">url://for/cookbook.tgz</span>
    <span class="l-Scalar-Plain">dependency1</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">url://for/dependency1.tgz</span>
  <span class="l-Scalar-Plain">launch_run_list</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span> <span class="s">&quot;cookbook_name::start&quot;</span> <span class="p-Indicator">]</span>
  <span class="l-Scalar-Plain">launch_attributes</span><span class="p-Indicator">:</span> <span class="c1"># map of arguments to set in the chef node</span>
  <span class="l-Scalar-Plain">service_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">cookbook_service</span>
  <span class="l-Scalar-Plain">pid_file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/var/run/cookbook.pid</span></code></pre></div>

<p>If you are interested in exploring the Java code for creating blueprints,
start with the <code>TypedToyMySqlEntiyChef</code> class, which essentially does what this tutorial has shown;
and then move on to the <code>DynamicToyMySqlEntiyChef</code> which starts to look at more sophisticated constructs.
(Familiarity with BASH and basic Java blueprints may be useful at that stage.)</p>


	</div>
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-salt-in-yaml-blueprints" class="section-breaker section p-">
	<span style="width: 100%"><h1>Salt in YAML Blueprints</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>This guide describes how Brooklyn entities can be created using the Salt infrastructure management tool
 (<a href="https://saltstack.com/">saltstack.com</a>).
At present Brooklyn provides basic support for Salt, operating in a ‘masterless’ mode. 
Comments on this support and suggestions for further development are welcome.</p>

<p>This guide assumes you are familiar with the basics of <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/blueprints/salt/../index.html">creating YAML blueprints</a>.</p>

<div class="list-children"><ul>

<li> <a href="#contentsLink-about-salt">About Salt</a> </li>

<li> <a href="#contentsLink-creating-blueprints-with-salt">Creating Blueprints with Salt</a> </li>

</ul></div>

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-about-salt" class="section-breaker section p-">
	<span style="width: 100%"><h1>About Salt</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_about-salt_what-you-need-to-know-about-salt">What you need to know about Salt</h2>

<p>Salt is designed to work in either what it calls a ‘master/minion’ or a ‘masterless’ topology.</p>

<p>In the former, the master server acts as a managing controller for any number of client nodes, called ‘minions’. 
A salt daemon running on the minion connects back to the master server for its operation, and manages the software on 
the minion according to a specification of ‘states’ defined in Salt configuration files.  In the latter, there is no 
master, and the salt daemon on the minion operates based on the Salt files on the minion node.  This is the mode 
currently supported by Brooklyn.</p>

<p>A ‘State’ in Salt is a specification of a configuration of some aspect of a system, such as what packages are installed,
what system services are running, what files exist, etc.  Such states are described in “SLS” files (for SaLt State 
file). These files are typically written as templates using the “Jinja” templating engine.  The actual SLS files for the
minion are then created by processing the templates using configuration data provided via Salt’s “Pillar” system.</p>

<p>Salt comes with built-in support for many software systems, and has a repository of pre-written Salt states known as 
‘formulas’ on GitHub, at <a href="https://github.com/saltstack-formulas">https://github.com/saltstack-formulas</a>.</p>

<h3 id="internalLink_about-salt_how-brooklyn-interacts-with-salt">How Brooklyn interacts with Salt</h3>

<p>Brooklyn provides a Salt entity type. An entity of this type can be specified in a blueprint in order to provision the 
node through Salt. The Salt entity will download Salt and install it on the node. The entity type supports the 
configuration of Salt formulas and Pillar data to download, and the configuration of what Salt states to apply. 
These are managed using Salt in ‘masterless’ mode, as described on the
<a href="https://docs.saltstack.com/en/latest/topics/tutorials/quickstart.html#salt-masterless-quickstart">Saltstack site</a>,
using the ‘salt-call’ functionality of Salt.</p>

<p>The Salt ‘highstate’ (the collection of states applied to the system) is exposed as a sensor on the entity.  An effector
 is provided on the entity that supports general purpose Salt instructions.</p>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-creating-blueprints-with-salt" class="section-breaker section p-">
	<span style="width: 100%"><h1>Creating Blueprints with Salt</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>To write a blueprint to use Salt with Brooklyn it will help to have a degree of familiarity with Salt itself. In the 
sections below, when the Brooklyn configuration is described, the underlying Salt operation is also noted briefly, for 
clarity for readers who know Salt.</p>

<p>To manage a node with Salt, create a blueprint containing a service of type <code>org.apache.brooklyn.entity.cm.salt.SaltEntity</code>
and define the <code>formulas</code> and <code>start_states</code> 
For example:</p>

<pre><code>name: Salt Example setting up Apache httpd
location: my-cloud
services:
- id: httpd-from-salt
  type: org.apache.brooklyn.entity.cm.salt.SaltEntity
  formulas:
  - https://github.com/saltstack-formulas/apache-formula/archive/master.tar.gz
  start_states:
  - apache
</code></pre>

<p>This example specifies that Brooklyn should use Salt to download the <code>apache-formula</code> from the Saltstack repository on
Github. The apache formula contains the Apache web server with a simple “it worked” style index page. To start the 
entity, Brooklyn will use Salt to apply the <code>apache</code> state, which will bring up the web server.</p>

<p>A typical usage of the Salt entity might be to include a formula from the Saltstack repository, such as <code>apache</code> above,
and another formula created by the blueprint author, with additional states, such as web site content for the apache 
server.</p>

<h3 id="internalLink_creating-blueprints-with-salt_start-states">Start States</h3>

<p>The <code>start_states</code> configuration key defines the top level list of states that will be applied using Salt.  These values
are added to the Salt <code>top.sls</code> file and applied using <code>state.apply</code>.  This configuration key is mandatory.</p>

<h3 id="internalLink_creating-blueprints-with-salt_stop-states">Stop States</h3>

<p>The <code>stop_states</code> configuration key is used to specify states that should be applied when the ‘stop’ effector
is invoked on the entity.  For example, the Saltstack <code>mysql</code> <a href="https://github.com/saltstack-formulas/mysql-formula">formula</a>
supplies a state <code>mysql.disabled</code> that will shut down the database server.</p>

<p>If the Saltstack formula does not supply a suitable stop state, the blueprint author can create a suitable state and
include it in an additional formula to be supplied in the <code>formulas</code> section. </p>

<p>The <code>stop_states</code> configuration key is optional; 
if it is not provided, Brooklyn assumes that each state <code>S</code> in the <code>start_states</code> will have a matching <code>S.stop</code> state.<br />
If any <code>S</code> does not have such a state, the stop effector will fail stopping processes.
Note that on a machine created for this entity, Brooklyn’s default behaviour may be to proceed to destroy the VM,
so stop states are not always needed unless there is a cleaner shutdown process or you are using long-running servers.</p>

<h3 id="internalLink_creating-blueprints-with-salt_restart-states">Restart States</h3>

<p>For completeness, Brooklyn also provides a <code>restart_states</code> configuration key. These states are applied by the restart
effector, and blueprint authors may choose to provide custom states to implement restart if that is applicable for their
application. </p>

<p>This key is again optional.
If not supplied, Brooklyn will go through each of the states <code>S</code> in <code>start_states</code> 
looking for a matching <code>S.restart</code> state defined in the formulas.
If all exist, these will be applied by the restart effector. 
If none exist, Brooklyn will invoke the <code>stop</code> and then <code>start</code> effectors – 
so <code>restart</code> states are not required for Brooklyn to use Salt.
(If some but not all have matching <code>restart</code> states, 
Brooklyn will fail the restart, on the assumption that the configuration is incomplete.)   </p>

<h3 id="internalLink_creating-blueprints-with-salt_formulas">Formulas</h3>

<p>The <code>formulas</code> key provides the URLs for archives containing the Salt formulas that defined the required states. These
archives are downloaded to the <code>/srv/formula</code> directory on the minion and added to the state filesystem roots 
configuration in Salt’s minion config, so that their states are available for a <code>state.apply</code>.</p>

<h3 id="internalLink_creating-blueprints-with-salt_pillar-configuration">Pillar Configuration</h3>

<p>A typical Salt deployment will include both states (provided via Salt formulas) and configuration data, provided through 
Salt’s “Pillar” component.  Brooklyn provides configuration keys for the Salt entity to specify where to get the Pillar
configuration data.  For example:</p>

<pre><code>name: Salt Example setting up MySQL with a Pillar
location: my-cloud
services:
- id: mysql-from-salt-with-my-pillar
  type: org.apache.brooklyn.entity.cm.salt.SaltEntity

  formulas:
  - https://github.com/saltstack-formulas/mysql-formula/archive/master.tar.gz
  - http://myhost:8080/my-mysql-formula.tar.gz

  start_states:
  - mysql
  stop_states: 
  - mysql.disabled

  pillars: 
  - mysql
  pillarUrls:
  - http://myhost:8080/my-mysql-pillar.tar.gz
</code></pre>

<p>This blueprint contains the MySQL database, and includes a formula available from <code>myhost</code> which includes the schema
information for the DB. The MySQL formula from Saltstack has extensive configurability through Salt Pillars. In the 
blueprint above, Brooklyn is instructed to apply the pillars defined in the <code>pillars</code> configuration key.  (This will 
add these values to the Salt Pillars <code>top.sls</code> file.)  The pillar data must be downloaded; for this, the <code>pillarUrls</code> key
provides the address of an archive containing the Pillar data.  The contents of the archive will be extracted and put
in the <code>/srv/pillar</code> directory on the minion, in order to be available to Salt when applying the pillar. For example,
the archive above can simply have the structure</p>

<pre><code>pillar/
|
+- mysql/
   |
   +- init.sls
</code></pre>

<p>The init.sls contains the pillar configuration values, such as </p>

<pre><code># Manage databases
database:
  - orders
schema:
  orders:
    load: True
    source: salt://mysql/files/orders.schema
</code></pre>

<p>Meanwhile the <code>my-mysql-formula.tar.gz</code> formula archive contains the schema:</p>

<pre><code>my-mysql-formula/
|
+- mysql/
   |
   +- files/
      |
      +- orders.schema
</code></pre>

<p>Note that the blueprint above defines an <code>id</code> for the Salt entity.  This id, if provided, is set as the minion id in
the Salt configuration file.  This is useful particularly for Pillar configuration, as, if there are more than one 
Salt managed nodes in the application, they can share a common Pillar file, with appropriate subdivisions of pillar 
data based on minion id.</p>

<h3 id="internalLink_creating-blueprints-with-salt_highstate-sensors">Highstate Sensors</h3>

<p>The Salt entity exposes the Salt “highstate” on the node via Brooklyn sensors.  Firstly a single sensor <code>salt.states</code> 
contains a list of all the top level Salt state ID declarations in the highstate.  For example, for the mysql case 
above, this might look like:</p>

<pre><code>["mysql_additional_config", "mysql_config", "mysql_db_0", "mysql_db_0_load", "mysql_db_0_schema", "mysql_debconf",
 "mysql_debconf_utils", "mysql_python", "mysql_user_frank_localhost", "mysql_user_frank_localhost_0", 
 "mysql_user_nopassuser_localhost", "mysqld"]
</code></pre>

<p>Then, for each ID and each Salt state function in that ID, a Brooklyn sensor is created, containing a map of the data
from the highstate.  For example, the <code>salt.state.mysqld.service.running</code> sensor would have a value like:</p>

<pre><code>{"name":"mysql", "enable":true, "watch":[{"pkg":"mysqld"}, {"file":"mysql_config"}], "order":10005}
</code></pre>

<h3 id="internalLink_creating-blueprints-with-salt_saltcall-effector">saltCall Effector</h3>

<p>The Salt entity includes a general purpose Salt effector, <code>saltCall</code>, which permits execution of Salt commands via
<code>salt-call --local</code>.  It contains a single parameter, <code>spec</code>, which specifies the command to invoke.  For example, 
invoking the effector with a <code>spec</code> value of <code>network.interfaces --out=yaml</code> would return a YAML formatted map of the 
network interfaces on the minion.</p>


	</div>
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-yaml-blueprint-advanced-example" class="section-breaker section p-">
	<span style="width: 100%"><h1>YAML Blueprint Advanced Example</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>By this point you should be familiar with the fundamental concepts behind both Apache Brooklyn and YAML blueprints. This section of the documentation is intended to show a complete, advanced example of a YAML blueprint.</p>

<p>The intention is that this example is used to learn the more in-depth concepts, and also to serve as a reference when writing your own blueprints. This page will first explain what the example application is and how to run it, then it will spotlight interesting features.</p>

<h3 id="internalLink_yaml-blueprint-advanced-example_elk-stack-example">ELK Stack Example</h3>

<p>This example demonstrates the deployment of an ELK Stack (Elasticsearch, Logstash and Kibana), using the provided blueprint to deploy, install, run and manage all three. Briefly, the component parts are:</p>

<ul>
  <li>Elasticsearch: A clustered search engine</li>
  <li>Logstash: Collects, parses and stores logs. For our example it will store logs in Elasticsearch</li>
  <li>Kibana: A web front end to Elasticsearch</li>
</ul>

<p>We also deploy a simple webserver whose logs will be collected.</p>

<ul>
  <li>Tomcat 8: Web server whose logs will be stored in Elasticsearch by Logstash.</li>
</ul>

<p>For more about the ELK stack, please see the documentation <a href="https://www.elastic.co/webinars/introduction-elk-stack">here</a>.</p>

<h4 id="internalLink_yaml-blueprint-advanced-example_the-blueprints">The Blueprints</h4>
<hr />

<p>There are four blueprints that make up this application. Each of them are used to add one or more catalog items to Brooklyn. You can find them below:</p>

<ul>
  <li><a href="https://github.com/brooklyncentral/brooklyn-elk/blob/master/brooklyn-elasticsearch-catalog.bom">Elasticsearch</a></li>
  <li><a href="https://github.com/brooklyncentral/brooklyn-elk/blob/master/brooklyn-logstash-catalog.bom">Logstash</a></li>
  <li><a href="https://github.com/brooklyncentral/brooklyn-elk/blob/master/brooklyn-kibana-catalog.bom">Kibana</a></li>
  <li><a href="https://github.com/brooklyncentral/brooklyn-elk/blob/master/brooklyn-elk-catalog.bom">ELK</a></li>
</ul>

<h4 id="internalLink_yaml-blueprint-advanced-example_running-the-example">Running the example</h4>
<p>First, add all four blueprints to the Brooklyn Catalog. This can be done by clicking the ‘Catalog’ tab, clicking the ‘+’
 symbol and pasting the YAML. Once this is done, click the ‘Application’ tab, then the ‘+’ button to bring up the add 
application wizard. A new Catalog application will be available called ‘ELK Stack’. Using the add application wizard, 
you should be able to deploy an ELK stack to a location of your choosing.  Alternatively use the <code>br</code> Brooklyn
command line tool and add the files with <code>br catalog add</code>.</p>

<h4 id="internalLink_yaml-blueprint-advanced-example_exploring-the-example">Exploring the example</h4>
<p>After the application has been deployed, you can ensure it is working as expected by checking the following:</p>

<ul>
  <li>There is a Kibana sensor called <code>main.uri</code>, the value of which points to the Kibana front end. You can explore this 
front end, and observe the logs stored in Elasticsearch. Many Brooklyn applications have a <code>main.uri</code> set to point you 
in the right direction.</li>
  <li>You can also use the Elasticsearch REST API to explore further. The Elasticsearch Cluster entity has a <code>urls.http.list</code> 
sensor. Using a host:port from that list you will be able to access the REST API. The following URL will give you the 
state of the cluster <code>http://&lt;host:port&gt;/_cluster/health?pretty=true</code>. As you can see the <code>number_of_nodes</code> is 
currently 2, indicating that the Elasticsearch nodes are communicating with each other.</li>
</ul>

<h3 id="internalLink_yaml-blueprint-advanced-example_interesting-feature-spotlight">Interesting Feature Spotlight</h3>
<p>We will mainly focus on the Elasticsearch blueprint, and will be clear when another blueprint is being discussed. This blueprint describes a cluster of Elasticsearch nodes. </p>

<h4 id="internalLink_yaml-blueprint-advanced-example_provisioning-properties">Provisioning Properties</h4>
<p>Our Elasticsearch blueprint has a few requirements of the location in which it is run. Firstly, it must be run on an
Ubuntu machine as the example has been written specifically for this OS. Secondly, two ports must opened to ensure
that the entities can be accessed from the outside world. Both of these requirements are configured via 
<code>provisioning.properties</code> as follows:</p>

<pre><code class="language-yaml">brooklyn.config:
  elasticsearch.http.port: 9220
  elasticsearch.tcp.port: 9330
  provisioning.properties:
    osFamily: ubuntu
    inboundPorts:
    - $brooklyn:config("elasticsearch.http.port")
    - $brooklyn:config("elasticsearch.tcp.port")
</code></pre>

<h4 id="internalLink_yaml-blueprint-advanced-example_vanillasoftwareprocess">VanillaSoftwareProcess</h4>
<p>When composing a YAML blueprint, the VanillaSoftwareProcess is a very useful entity to be aware of. 
A VanillaSoftwareProcess will instruct Brooklyn to provision an instance, and run a series of shell 
commands to setup, run, monitor and teardown your program. The commands are specified as configuration 
on the VanillaSoftwareProcess and there are several available. We will spotlight a few now. To simplify
 this blueprint, we have specified ubuntu only installs so that our commands can be tailored to this 
 system (e.g. use apt-get rather than yum).</p>

<h5 id="internalLink_yaml-blueprint-advanced-example_customize-command">Customize Command</h5>
<p>The Customize Command is run after the application has been installed but before it is run. It is the perfect
 place to create and amend config files. Please refer to the following section of the Elasticsearch blueprint:</p>

<pre><code class="language-yaml">customize.command: |
  sudo rm -fr sudo tee /etc/elasticsearch/elasticsearch.yml
  echo discovery.zen.ping.multicast.enabled: false | sudo tee -a /etc/elasticsearch/elasticsearch.yml
  echo discovery.zen.ping.unicast.enabled: true | sudo tee -a /etc/elasticsearch/elasticsearch.yml
  echo discovery.zen.ping.unicast.hosts: ${URLS_WITH_BRACKETS} | sudo tee -a /etc/elasticsearch/elasticsearch.yml
  echo http.port: ${ES_HTTP_PORT} | sudo tee -a /etc/elasticsearch/elasticsearch.yml
  echo transport.tcp.port: ${ES_TCP_PORT} | sudo tee -a /etc/elasticsearch/elasticsearch.yml
  echo network.host: ${IP_ADDRESS} | sudo tee -a /etc/elasticsearch/elasticsearch.yml
</code></pre>

<p>The purpose of this section is to create a YAML file with all of the required configuration. We use the YAML 
literal style <code>|</code> indicator to write a multi line command. We start our series of commands by using the <code>rm</code> command to remove the 
previous config file. We then use <code>echo</code> and <code>tee</code> to create the new config file and insert the config. Part 
of the configuration is a list of all hosts that is set on the parent entity- this is done by using a combination
 of the <code>component</code> and  <code>attributeWhenReady</code> DSL commands. More on how this is generated later.</p>

<h5 id="internalLink_yaml-blueprint-advanced-example_check-running">Check running</h5>
<p>After an app is installed and run, this command is scheduled to run regularly and used to populate the <code>service.isUp</code> 
sensor. If this command is not specified, or returns an exit code of anything other than zero, then Brooklyn will 
assume that your entity has failed and will display the fire status symbol. Please refer to the following section 
of the Elasticsearch blueprint:</p>

<pre><code class="language-yaml">checkRunning.command: sudo systemctl status kibana.service
</code></pre>

<p>There are many different ways to implement this command. For this example, we are simply using the systemctl status 
of the appropriate service.</p>

<h4 id="internalLink_yaml-blueprint-advanced-example_enrichers">Enrichers</h4>

<h5 id="internalLink_yaml-blueprint-advanced-example_elasticsearch-urls">Elasticsearch URLS</h5>
<p>To ensure that all Elasticsearch nodes can communicate with each other they need to be configured with the TCP URL 
of all other nodes. Similarly, the Logstash instances need to be configured with all the HTTP URLs of the Elasticsearch 
nodes. The mechanism for doing this is the same, and involves using Transformers, Aggregators and Joiners, as follows:</p>

<pre><code class="language-yaml">brooklyn.enrichers:
  - type: org.apache.brooklyn.enricher.stock.Transformer
    brooklyn.config:
      enricher.sourceSensor: $brooklyn:sensor("host.subnet.address")
      enricher.targetSensor: $brooklyn:sensor("url.tcp")
      enricher.targetValue: $brooklyn:formatString("%s:%s", $brooklyn:attributeWhenReady("host.subnet.address"), $brooklyn:config("elasticsearch.tcp.port"))
</code></pre>

<p>In this example, we take the host.subnet.address and append the TCP port, outputting the result as <code>url.tcp</code>. 
After this has been done, we now need to collect all the URLs into a list in the Cluster entity, as follows:</p>

<pre><code class="language-yaml">brooklyn.enrichers:
  - type: org.apache.brooklyn.enricher.stock.Aggregator
    brooklyn.config:
      enricher.sourceSensor: $brooklyn:sensor("url.tcp")
      enricher.targetSensor: $brooklyn:sensor("urls.tcp.list")
      enricher.aggregating.fromMembers: true

</code></pre>

<p>In the preceding example, we aggregated all of the TCP URLs generated in the early example. 
These are then stored in a sensor called <code>urls.tcp.list</code>. This list is then joined together into one long string:</p>

<pre><code class="language-yaml">- type: org.apache.brooklyn.enricher.stock.Joiner
  brooklyn.config:
    enricher.sourceSensor: $brooklyn:sensor("urls.tcp.list")
    enricher.targetSensor: $brooklyn:sensor("urls.tcp.string")
    uniqueTag: urls.quoted.string
</code></pre>

<p>Finally, the string has brackets added to the start and end:</p>

<pre><code class="language-yaml">- type: org.apache.brooklyn.enricher.stock.Transformer
  brooklyn.config:
    enricher.sourceSensor: $brooklyn:sensor("urls.tcp.string")
    enricher.targetSensor: $brooklyn:sensor("urls.tcp.withBrackets")
    enricher.targetValue: $brooklyn:formatString("[%s]", $brooklyn:attributeWhenReady("urls.tcp.string"))
</code></pre>

<p>The resulting sensor will be called <code>urls.tcp.withBrackets</code> and will be used by all Elasticsearch nodes during setup.</p>

<h5 id="internalLink_yaml-blueprint-advanced-example_kibana-url">Kibana URL</h5>
<p>Kibana also needs to be configured such that it can access the Elasticsearch cluster. However, Kibana can
 only be configured to point at one Elasticsearch instance. To enable this, we use another enricher in the 
 cluster to select the first URL from the list, as follows:</p>

<pre><code class="language-yaml">- type: org.apache.brooklyn.enricher.stock.Aggregator
  brooklyn.config:
    enricher.sourceSensor: $brooklyn:sensor("host.subnet.address")
    enricher.targetSensor: $brooklyn:sensor("host.address.first")
    enricher.aggregating.fromMembers: true
    enricher.transformation:
     $brooklyn:object:
       type: "org.apache.brooklyn.util.collections.CollectionFunctionals$FirstElementFunction"
</code></pre>

<p>Similar to the above Aggregator, this Aggregator collects all the URLs from the members of the cluster. 
However, this Aggregator specifies a transformation. In this instance a transformation is a Java class that 
implements a Guava Function <code>&lt;? super Collection&lt;?&gt;, ?&gt;&gt;</code>, i.e. a function that takes in a collection and 
returns something. In this case we specify the FirstElementFunction from the CollectionFunctionals to ensure 
that we only get the first member of the URL list.</p>

<h4 id="internalLink_yaml-blueprint-advanced-example_latches">Latches</h4>
<p>In the ELK blueprint, there is a good example of a latch. Latches are used to force an entity to wait until 
certain conditions are met before continuing. For example:</p>

<pre><code class="language-yaml">- type: kibana-standalone
  id: kibana
  name: Kibana Server
  customize.latch: $brooklyn:component("es").attributeWhenReady("service.isUp")
</code></pre>

<p>This latch is used to stop Kibana customizing until the Elasticsearch cluster is up. We do this to ensure 
that the URL sensors have been setup, so that they can be passed into Kibana during the customization phase.</p>

<p>Latches can also be used to control how many entities can execute the same step at any given moment. When
a latch is given the value of a <code>MaxConcurrencySensor</code> it will unblock execution only when there are
available “slots” to execute (think of it as a semaphore). For example to let a single entity execute the
launch step of the start effector:</p>

<pre><code class="language-yaml">services:
- type: cluster

  brooklyn.initializers:
  - type: org.apache.brooklyn.core.sensor.MaxConcurrencySensor
    brooklyn.config:
      name: single-executor
      latch.concurrency.max: 1

  brooklyn.config: 
    initialSize: 10
    memberSpec:
      $brooklyn:entitySpec:
        type: vanilla-bash-server
        brooklyn.config:
          launch.command: sleep 2
          checkRunning.command: true
          launch.latch: $brooklyn:parent().attributeWhenReady("single-executor")
</code></pre>

<p>It’s important to note that the above setup is not reentrant. This means that users should be careful to
avoid deadlocks. For example having a start and launch latches against the <code>single-executor</code> from above.
The launch latch will block forever since the start latch already would’ve acquired the free slot.</p>

<h4 id="internalLink_yaml-blueprint-advanced-example_child-entities">Child entities</h4>
<p>The ELK blueprint also contains a good example of a child entity.</p>

<pre><code class="language-yaml">- type: org.apache.brooklyn.entity.webapp.tomcat.Tomcat8Server
  brooklyn.config:
    children.startable.mode: background_late
  ...
  brooklyn.children:
  - type: logstash-child
</code></pre>

<p>In this example, a logstash-child is started as a child of the parent Tomcat server. The Tomcat server needs 
to be configured with a <code>children.startable.mode</code> to inform Brooklyn when to bring up the child. In this case
 we have selected background so that the child is disassociated from the parent entity, and late to specify that
  the parent entity should start before we start the child.</p>

<p>The example also shows how to configure Logstash inputs and filters, if necessary, for a particular application, 
in this case Tomcat.</p>

<pre><code class="language-yaml">- type: logstash-child
  name: Logstash
  brooklyn.config:
    logstash.elasticsearch.hosts: $brooklyn:entity("es").attributeWhenReady("urls.http.withBrackets")
    logstash.config.input:
      $brooklyn:formatString:
      - |
        input {
          file {
            path =&gt; "%s/logs/localhost_access_log.*"
            start_position =&gt; "beginning"
          }
        }
      - $brooklyn:entity("tomcat").attributeWhenReady("run.dir")
    logstash.config.filter: |
      filter {
        grok {
          match =&gt; { "message" =&gt; "%{COMBINEDAPACHELOG}" }
        }
        date {
          match =&gt; [ "timestamp" , "dd/MMM/yyyy:HH:mm:ss Z" ]
        }
      }
</code></pre>

<p>Configuring an appropriate visualisation on the Kibana server (access it via the URL on the summary tab for 
that entity) allows a dashboard to be created such as</p>

<p><img src="./v/latest/blueprints/logstash-snapshot.png" alt="kibana dashboard" /></p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-blueprinting-tips" class="section-breaker section p-">
	<span style="width: 100%"><h1>Blueprinting Tips</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_blueprinting-tips_yaml-recommended">YAML Recommended</h2>

<p>The recommended way to write a blueprint is as a YAML file. This is true both for building
an application out of existing blueprints, and for building new integrations.</p>

<p>The use of Java is reserved for those use-cases where the provisioning or configuration logic 
is very complicated.</p>

<h2 id="internalLink_blueprinting-tips_be-familiar-with-brooklyn">Be Familiar with Brooklyn</h2>

<p>Be familiar with the stock entities available in Brooklyn. For example, prove you understand<br />
the concepts by making a deployment of a cluster of Tomcat servers before you begin writing your 
own blueprints.</p>

<h2 id="internalLink_blueprinting-tips_ask-for-help">Ask For Help</h2>

<p>Ask for help early. The community is keen to help, and also keen to find out what people find 
hard and how people use the product. Such feedback is invaluable for improving future versions.</p>

<h2 id="internalLink_blueprinting-tips_faster-dev-test">Faster Dev-Test</h2>

<p>Writing a blueprint is most efficient and simple when testing is fast, and when testing is
done incrementally as features of the blueprint are written.</p>

<p>The slowest stages of deploying a blueprint are usually VM provisioning and downloading/installing
of artifacts (e.g. RPMs, zip files, etc).</p>

<p>Options for speeding up provisioning include those below.</p>

<h4 id="internalLink_blueprinting-tips_deploying-to-bring-your-own-nodes-byon">Deploying to Bring Your Own Nodes (BYON)</h4>

<p>A <a href="#contentsLink-locations">BYON location</a> can be defined, which avoids the time 
required to provision VMs. This is fast, but has the downside that artifacts installed during a 
previous run can interfere with subsequent runs.</p>

<p>A variant of this is to <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/start/running.html">use Vagrant</a> (e.g. with VirtualBox) 
to create VMs on your local machine, and to use these as the target for a BYON location.</p>

<p>These VMs should mirror the target environment as much as possible.</p>

<h4 id="internalLink_blueprinting-tips_deploying-to-the-localhost-location">Deploying to the “localhost” location</h4>

<p>This is fast and simple, but has some obvious downsides:</p>

<ul>
  <li>
    <p>Artifacts are installed directly on your desktop/server.</p>
  </li>
  <li>
    <p>The artifacts installed during previous runs can interfere with subsequent runs.</p>
  </li>
  <li>
    <p>Some entities require <code>sudo</code> rights, which must be granted to the user running Brooklyn.</p>
  </li>
</ul>

<h4 id="internalLink_blueprinting-tips_deploying-to-clocker">Deploying to Clocker</h4>

<p>Docker containers provide a convenient way to test blueprints (and also to run blueprints in
production!).</p>

<p>The <a href="http://www.clocker.io">Clocker project</a> allows the simple setup of Docker Engine(s), and for Docker
containers to be used instead of VMs. For testing, this allows each run to start from a fresh 
container (i.e. no install artifacts from previous runs), while taking advantage of the speed
of starting containers.</p>

<h4 id="internalLink_blueprinting-tips_local-repository-of-install-artifacts">Local Repository of Install Artifacts</h4>

<p>To avoid re-downloading install artifacts on every run, these can be saved to <code>~/.brooklyn/repository/</code>.
The file structure is a sub-directory with the entity’s simple name, then a sub-directory with the
version number, and then the files to be downloaded. For example, 
<code>~/.brooklyn/repository/TomcatServer/7.0.56/apache-tomcat-7.0.56.tar.gz</code>.</p>

<p>If possible, synchronise this directory with your test VMs. </p>

<h4 id="internalLink_blueprinting-tips_re-install-on-byon">Re-install on BYON</h4>

<p>If using BYON or localhost, the install artifacts will by default be installed to a directory like
<code>/tmp/brooklyn-myname/installs/</code>. If install completed successfully, then the install stage will 
be subsequently skipped (a marker file being used to indicate completion). To re-test the install 
phase, delete the install directory (e.g. delete <code>/tmp/brooklyn-myname/installs/TomcatServer_7.0.56/</code>).</p>

<p>Where installation used something like <code>apt-get install</code> or <code>yum install</code>, then re-testing the
install phase will require uninstalling these artifacts manually.</p>

<h2 id="internalLink_blueprinting-tips_monitoring-and-managing-applications">Monitoring and Managing Applications</h2>

<p>Think about what it really means for an application to be running. The out-of-the-box default 
for a software process is the lowest common denominator: that the process is still running. 
Consider checking that the app responds over HTTP etc.</p>

<p>If you have control of the app code, then consider adding an explicit health check URL that
does more than basic connectivity tests. For example, can it reach the database, message broker,
and other components that it will need for different operations.</p>

<h2 id="internalLink_blueprinting-tips_writing-composite-blueprints">Writing Composite Blueprints</h2>

<p>Write everything in discrete chunks that can be composed into larger pieces. Do not write a single 
mega-blueprint. For example, ensure each component is added to the catalog independently, along 
with a blueprint for the composite app.</p>

<p>Experiment with lots of small blueprints to test independent areas before combining them into the 
real thing.</p>

<h2 id="internalLink_blueprinting-tips_writing-entity-tests">Writing Entity Tests</h2>

<p>Use the <a href="#contentsLink-testing-yaml-blueprints">test framework</a> to write test cases. This will make 
automated (regression) testing easier, and will allow others to easily confirm that the entity 
works in their environment.</p>

<p>If using Maven/Gradle then use the <a href="https://github.com/brooklyncentral/brooklyn-maven-plugin">Brooklyn Maven plugin</a> 
to test blueprints at build time.</p>

<h2 id="internalLink_blueprinting-tips_custom-entity-development">Custom Entity Development</h2>

<p>If writing a custom integration, the following recommendations may be useful:</p>

<ul>
  <li>
    <p>Always be comfortable installing and running the process yourself before attempting to automate 
it.</p>
  </li>
  <li>
    <p>For the software to be installed, use its Installation and Admin guides to ensure best practices
are being followed. Use blogs and advice from experts, when available.</p>
  </li>
  <li>
    <p>Where there is a choice of installation approaches, use the approach that is most appropriate for
production use-cases (even if this is harder to test on locahost). For example, 
prefer the use of RPMs versus unpacking zip files, and prefer the use of services versus invoking
a <code>bin/start</code> script.</p>
  </li>
  <li>
    <p>Ensure every step is scriptable (e.g. manual install does not involve using a text editor to 
modify configuration files, or clicking on things in a web-console).</p>
  </li>
  <li>
    <p>Write scripts (or Chef recipes, or Puppet manifests, etc), and test these by executing manually. 
Only once these work in isolation, add them to the entity blueprint.</p>
  </li>
  <li>
    <p>Externalise the configuration where appropriate. For example, if there is a configuration file
then include a config key for the URL of the configuration file to use. Consider using FreeMarker
templating for such configuration files.</p>
  </li>
  <li>
    <p>Focus on a single OS distro/version first, and clearly document these assumptions.</p>
  </li>
  <li>
    <p>Breakdown the integration into separate components, where possible (and thus develop/test them separately). 
For example, if deploying a MongoDB cluster then first focus on single-node MongoDB, and then make that
configurable and composable for a cluster.</p>
  </li>
  <li>
    <p>Where appropriate, share the new entity with the Brooklyn community so that it can be reviewed, 
tested and improved by others in the community!</p>
  </li>
</ul>

<h2 id="internalLink_blueprinting-tips_cloud-portability">Cloud Portability</h2>

<p>You get a lot of support out-of-the-box for deploying blueprints to different clouds. The points 
below may also be of help:</p>

<ul>
  <li>
    <p>Test (and regression test) on each target cloud.</p>
  </li>
  <li>
    <p>Be aware that images on different clouds can be very different. For example, two CentOS 6.6 VMs 
might have different pre-installed libraries, different default iptables or SE Linux settings,
different repos, different sudo configuration, etc.</p>
  </li>
  <li>
    <p>Different clouds handle private and public IPs differently. One must be careful about which 
address to advertise to for use by other entities.</p>
  </li>
  <li>
    <p>VMs on some clouds may not have a well-configured hostname (e.g. <code>ping $(hostname)</code> can fail).</p>
  </li>
  <li>
    <p>VMs in different clouds have a different number of NICs. This is important when choosing whether
to listen on 0.0.0.0 or on a specific NIC.</p>
  </li>
</ul>

<h2 id="internalLink_blueprinting-tips_investigating-errors">Investigating Errors</h2>

<p>ALWAYS keep logs when there is an error.</p>

<p>See the <a href="#contentsLink-troubleshooting">Troubleshooting</a> guide for more information. </p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-reference-guide" class="section-breaker section p-">
	<span style="width: 100%"><h1>Reference Guide</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	
<div class="list-children"><ul>

<li> <a href="#contentsLink-production-installation">Production Installation</a> </li>

<li> <a href="#contentsLink-starting,-stopping-and-monitoring">Starting, Stopping and Monitoring</a> </li>

<li> <a href="#contentsLink-server-cli-reference">Server CLI Reference</a> </li>

<li> <a href="#contentsLink-client-cli-reference">Client CLI Reference</a> </li>

<li> <a href="#contentsLink-gui-guide">GUI Guide</a> </li>

<li> <a href="#contentsLink-rest-api">REST API</a> </li>

<li> <a href="#contentsLink-brooklyn.properties">brooklyn.properties</a> </li>

<li> <a href="#contentsLink-persistence">Persistence</a> </li>

<li> <a href="#contentsLink-high-availability">High Availability</a> </li>

<li> <a href="#contentsLink-osgi-distribution">OSGi Distribution</a> </li>

<li> <a href="#contentsLink-logging">Logging</a> </li>

<li> <a href="#contentsLink-https-configuration">HTTPS Configuration</a> </li>

<li> <a href="#contentsLink-externalized-configuration">Externalized Configuration</a> </li>

<li> <a href="#contentsLink-requirements">Requirements</a> </li>

<li> <a href="#contentsLink-security-guidelines">Security Guidelines</a> </li>

<li> <a href="#contentsLink-troubleshooting">Troubleshooting</a> </li>

</ul></div>

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-production-installation" class="section-breaker section p-">
	<span style="width: 100%"><h1>Production Installation</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	
<p>To install Apache Brooklyn on a production server:</p>

<ol>
  <li><a href="#internalLink_production-installation_prerequisites">Set up the prerequisites</a></li>
  <li><a href="#internalLink_production-installation_download">Download Apache Brooklyn</a></li>
  <li><a href="#internalLink_production-installation_configuring-properties">Configuring brooklyn.properties</a></li>
  <li><a href="#internalLink_production-installation_configuring-karaf-security">Configuring Karaf Security</a></li>
  <li><a href="#internalLink_production-installation_configuring-catalog">Configuring default.catalog.bom</a></li>
  <li><a href="#internalLink_production-installation_confirm">Test the installation</a></li>
</ol>

<p>This guide covers the basics. You may also wish to configure:</p>

<ul>
  <li><a href="#contentsLink-logging">Logging</a></li>
  <li><a href="#contentsLink-persistence">Persistence</a></li>
  <li><a href="#contentsLink-high-availability">High availability</a></li>
</ul>

<h3 id="internalLink_production-installation_a-idprerequisitesaset-up-the-prerequisites"><a id="internalLink_production-installation_prerequisites"></a>Set up the Prerequisites</h3>

<p>Check that the server meets the <a href="#contentsLink-requirements">requirements</a>.
Then configure the server as follows:</p>

<ul>
  <li>install Java JRE or JDK (version 7 or later)</li>
  <li>install an <a href="#contentsLink-locations">SSH key</a>, if not available</li>
  <li>if the “localhost” location will be used, enable <a href="#contentsLink-locations">passwordless ssh login</a></li>
  <li>create a <code>~/.brooklyn</code> directory on the host with <code>$ mkdir ~/.brooklyn</code></li>
  <li>check your <code>iptables</code> or other firewall service, making sure that incoming connections on port 8443 is not blocked</li>
  <li>check that the <a href="#contentsLink-increase-entropy">linux kernel entropy</a> is sufficient</li>
  <li>check that the <a href="#contentsLink-increase-system-resource-limits">ulimit values</a> are sufficiently high</li>
  <li>ensure external libraries are up-to-date, including <code>nss</code> for SSL. </li>
  <li>ensure the time is continually accurate, ideally by running a service like the <a href="http://www.ntp.org/">ntp daemon</a>.</li>
</ul>

<h3 id="internalLink_production-installation_a-iddownloadadownload-apache-brooklyn"><a id="internalLink_production-installation_download"></a>Download Apache Brooklyn</h3>

<p>Download Brooklyn and obtain a binary build as described on <a href="http://brooklyn.apache.org/v/0.10.0/download/index.html">the download page</a>.</p>

<p>Expand the <code>tar.gz</code> archive:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">% tar -zxf apache-brooklyn-0.10.0-dist.tar.gz</code></pre></div>

<p>This will create a <code>apache-brooklyn-0.10.0</code> folder.</p>

<p>Let’s setup some paths for easy commands.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">% <span class="nb">cd </span>apache-brooklyn-0.10.0
% <span class="nv">BROOKLYN_DIR</span><span class="o">=</span><span class="s2">&quot;$(pwd)&quot;</span>
% <span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$BROOKLYN_DIR</span>/bin/</code></pre></div>

<h3 id="internalLink_production-installation_a-idconfiguring-propertiesaconfiguring-brooklynproperties"><a id="internalLink_production-installation_configuring-properties"></a>Configuring brooklyn.properties</h3>

<p>Set up <code>brooklyn.properties</code> as described <a href="#contentsLink-brooklyn.properties">here</a>:</p>

<ul>
  <li>Configure the users who should have access</li>
  <li>Turn on HTTPS</li>
  <li>Supply credentials for any pre-defined clouds</li>
</ul>

<p>It may be useful to use the following script to install an initial <code>brooklyn.properties</code>:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">% mkdir -p ~/.brooklyn
% wget -O ~/.brooklyn/brooklyn.properties https://brooklyn.apache.org/v/latest/start/brooklyn.properties
% chmod <span class="m">600</span> ~/.brooklyn/brooklyn.properties</code></pre></div>

<h3 id="internalLink_production-installation_a-idconfiguring-karaf-securityaconfiguring-karaf-security"><a id="internalLink_production-installation_configuring-karaf-security"></a>Configuring Karaf Security</h3>

<p>Out of the box, Apache Brooklyn includes the default Karaf security configuration.
This configuration is used to manage connections to the ssh port of Karaf
(which is available to localhost connections only).
It is recommended that you update the credentials as detailed in the
<a href="https://karaf.apache.org/manual/latest/security#_users_groups_roles_and_passwords">Karaf Security</a> page.</p>

<h3 id="internalLink_production-installation_a-idconfiguring-catalogaconfiguring-the-catalog"><a id="internalLink_production-installation_configuring-catalog"></a>Configuring the Catalog</h3>

<p>By default Brooklyn loads the catalog of available application components and services from 
<code>default.catalog.bom</code> on the classpath. The initial catalog is in <code>conf/brooklyn/</code> in the dist.
If you have a preferred catalog, simply replace that file.</p>

<p><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/catalog/index.html">More information on the catalog is available here.</a></p>

<h3 id="internalLink_production-installation_a-idconfirmaconfirm-installation"><a id="internalLink_production-installation_confirm"></a>Confirm Installation</h3>

<p>Launch Brooklyn in a disconnected session so it will remain running after you have logged out:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">% nohup bin/brooklyn launch &gt; /dev/null 2<span class="p">&amp;</span>&gt;1 <span class="p">&amp;</span></code></pre></div>

<p>Apache Brooklyn should now be running on port 8081 (or other port if so specified).</p>

<p>To install on a different port edit config in <code>etc/org.ops4j.pax.web.cfg</code>.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-starting,-stopping-and-monitoring" class="section-breaker section p-">
	<span style="width: 100%"><h1>Starting, Stopping and Monitoring</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p><strong>NOTE:</strong> This document is for information on starting an Apache Brooklyn
Server.  For information on using the Brooklyn Client CLI to access an already
running Brooklyn Server, refer to <a href="#contentsLink-client-cli-reference">Client CLI Reference</a>.</p>

<h2 id="internalLink_starting,-stopping-and-monitoring_packages-for-rhelcentos-and-ubuntu">Packages for RHEL/CentOS and Ubuntu</h2>

<p>If you are using the <code>.rpm</code> or <code>.deb</code> package of Apache Brooklyn, then Brooklyn
will integrate with your OS service management. Commands such as
<code>service brooklyn start</code> will work as expected, and Brooklyn’s PID file will be
stored in the normal location for your OS, such as <code>/var/run/brooklyn.pid</code>.</p>

<h2 id="internalLink_starting,-stopping-and-monitoring_platform-independent-distributions">Platform-independent distributions</h2>

<p>The platform-independent distributions are packaged in <code>.tar.gz</code> and <code>.zip</code>
files.</p>

<h3 id="internalLink_starting,-stopping-and-monitoring_starting">Starting</h3>

<p>To launch Brooklyn, from the directory where Brooklyn is unpacked, run:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">% bin/brooklyn launch &gt; /dev/null 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">&amp;</span> <span class="nb">disown</span></code></pre></div>

<p>With no configuration, this will launch the Brooklyn web console and REST API on <a href="http://localhost:8081/"><code>http://localhost:8081/</code></a>,
listening on all network interfaces. No credentials are required by default. It is strongly
recommended to <a href="#contentsLink-brooklyn.properties">configure security</a>.</p>

<p>See the <a href="#contentsLink-server-cli-reference">Server CLI Reference</a> for more information
about the Brooklyn server process.</p>

<p>The Brooklyn startup script will create a file name <code>pid_java</code> at the root of
the Brooklyn directory, which contains the PID of the last Brooklyn process to
be started.</p>

<h3 id="internalLink_starting,-stopping-and-monitoring_stopping">Stopping</h3>

<p>To stop Brooklyn, simply send a <code>TERM</code> signal to the Brooklyn process. The PID
of the most recently run Brooklyn process can be found in the <code>pid_java</code> file at
the root of the Brooklyn directory.</p>

<p>For example:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">% <span class="nb">kill</span> <span class="k">$(</span> cat pid_java <span class="k">)</span></code></pre></div>

<h2 id="internalLink_starting,-stopping-and-monitoring_monitoring">Monitoring</h2>

<p>For <code>.tar.gz</code> and <code>.zip</code> distributions of Brooklyn, the Brooklyn startup script
will create a file name <code>pid_java</code> at the root of the Brooklyn directory, which
contains the PID of the last Brooklyn process to be started. You can examine
this file to discover the PID, and then test that the process is still running.
<code>.rpm</code> and <code>.deb</code> distributions of Brooklyn will use the normal mechanism that
your OS uses, such as writing to <code>/var/run/brooklyn.pid</code>.</p>

<p>This should lead to a fairly straightforward integration with many monitoring
tools - the monitoring tool can discover the expected PID, and can execute the
start or stop commands shown above as necessary.</p>

<p>For example, here is a fragment of a <code>monitrc</code> file as used by
<a href="https://mmonit.com/monit/">Monit</a>, for a Brooklyn <code>.tar.gz</code> distribution
unpacked and installed at <code>/opt/apache-brooklyn</code>:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">check process apachebrooklyn with pidfile /opt/apache-brooklyn/pid_java
    start program = &quot;/bin/bash -c &#39;/opt/apache-brooklyn/bin/brooklyn launch --persist auto &amp; disown&#39;&quot; with timeout 10 seconds
    stop  program = &quot;/bin/bash -c &#39;kill $( cat /opt/apache-brooklyn/pid_java )&#39;&quot;</code></pre></div>

<p>In addition to monitoring the Brooklyn process itself, you will almost certainly
want to monitor resource usage of Brooklyn. In particular, please see the
<a href="#contentsLink-requirements">Requirements</a> section for a discussion on Brooklyn’s disk
space requirements.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-server-cli-reference" class="section-breaker section p-">
	<span style="width: 100%"><h1>Server CLI Reference</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p><strong>NOTE:</strong> This document is for information on starting a Brooklyn Server.  For information on using the Brooklyn Client CLI to access an 
already running Brooklyn Server, refer to <a href="#contentsLink-client-cli-reference">Client CLI Reference</a>.</p>

<h2 id="internalLink_server-cli-reference_launch-command">Launch command</h2>

<p>To launch Brooklyn, from the directory where Brooklyn is unpacked, run:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">% nohup bin/brooklyn launch &gt; /dev/null 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">&amp;</span></code></pre></div>

<p>With no configuration, this will launch the Brooklyn web console and REST API on <a href="http://localhost:8081/"><code>http://localhost:8081/</code></a>,
listening on all network interfaces. No credentials are required by default. For a production 
system, or if Apache Brooklyn is publicly reachable, it is strongly recommended to 
<a href="#contentsLink-brooklyn.properties">configure security</a>.</p>

<p>By default, Brooklyn will write log messages at the INFO level or above to <code>brooklyn.info.log</code> and messgages at the
DEBUG level or above to <code>brooklyn.debug.log</code>. Redirecting the output to <code>/dev/null</code> prevents the default console output
being written to <code>nohup.out</code>.</p>

<p>You may wish to <a href="#internalLink_server-cli-reference_path-setup">add Brooklyn to your path</a>;
assuming you’ve done this, to get information the supported CLI options 
at any time, just run <code>brooklyn help</code>:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">% bin/brooklyn <span class="nb">help</span>

usage: brooklyn <span class="o">[(</span>-q <span class="p">|</span> --quiet<span class="o">)]</span> <span class="o">[(</span>-v <span class="p">|</span> --verbose<span class="o">)]</span> &lt;<span class="nb">command</span>&gt; <span class="o">[</span>&lt;args&gt;<span class="o">]</span>

The most commonly used brooklyn commands are:
    <span class="nb">help     </span>Display <span class="nb">help </span>information about brooklyn
    info     Display information about brooklyn
    launch   Starts a brooklyn application. Note that a BROOKLYN_CLASSPATH environment variable needs to be <span class="nb">set </span>up beforehand to point to the user application classpath.

See <span class="s1">&#39;brooklyn help &lt;command&gt;&#39;</span> <span class="k">for</span> more information on a specific command.</code></pre></div>

<p>It is important that Brooklyn is launched with either <code>nohup ... &amp;</code> or <code>... &amp; disown</code>, to ensure 
it keeps running after the shell terminates.</p>

<h3 id="internalLink_server-cli-reference_other-server-cli-arguments">Other Server CLI Arguments</h3>

<p>The Server CLI arguments for <a href="#contentsLink-persistence">persistence and HA</a> and the <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/catalog/index.html">catalog</a> are described separately.</p>

<h3 id="internalLink_server-cli-reference_path-setup">Path Setup</h3>

<p>In order to have easy access to the server cli it is useful to configure the PATH environment 
variable to also point to the cli’s bin directory:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">BROOKLYN_HOME</span><span class="o">=</span>/path/to/brooklyn/
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$BROOKLYN_HOME</span>/usage/dist/target/brooklyn-dist/bin/</code></pre></div>

<h3 id="internalLink_server-cli-reference_memory-usage">Memory Usage</h3>

<p>The amount of memory required by the Brooklyn process depends on the usage 
– for example the number of entities/VMs under management.</p>

<p>For a standard Brooklyn deployment, the defaults are to start with 256m, and to grow to 1g of memory.
These numbers can be overridden by setting the environment variable <code>JAVA_OPTS</code> before launching
the <code>brooklyn script</code>, as follows:</p>

<pre><code>JAVA_OPTS="-Xms1g -Xmx4g -XX:MaxPermSize=256m"
</code></pre>

<p>(On Java 8 and later the last entry has no effect and can be dropped.)</p>

<p>Brooklyn stores a task history in-memory using <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/ref/SoftReference.html">soft references</a>.
This means that, once the task history is large, Brooklyn will continually use the maximum allocated 
memory. It will only expunge tasks from memory when this space is required for other objects within the
Brooklyn process.</p>

<p>See <a href="#contentsLink-troubleshooting:-monitoring-memory-usage">Memory Usage</a> for more information on memory usage and
other suggested <code>JAVA_OPTS</code>.</p>

<h3 id="internalLink_server-cli-reference_web-console-bind-address">Web Console Bind Address</h3>

<p>The web console will by default bind to 0.0.0.0. It’s restricted to 127.0.0.1 if the <code>--noConsoleSecurity</code> flag is used.
To specify a local interface, or use the local loopback (127.0.0.1), for the web console to bind to you should use:</p>

<pre><code>--bindAddress &lt;IP&gt;
</code></pre>

<h2 id="internalLink_server-cli-reference_configuration">Configuration</h2>

<h3 id="internalLink_server-cli-reference_configuration-files">Configuration Files</h3>

<p>Brooklyn reads configuration from a variety of places. It aggregates the configuration.
The list below shows increasing precedence (i.e. the later ones will override values
from earlier ones, if exactly the same property is specified multiple times).</p>

<ol>
  <li><code>classpath://brooklyn/location-metadata.properties</code> is shipped as part of Brooklyn, containing 
generic metadata such as jurisdiction and geographic information about Cloud providers.        </li>
  <li>The file <code>~/.brooklyn/location-metadata.properties</code> (unless <code>--noGlobalBrooklynProperties</code> is specified).
This is intended to contain custom metadata about additional locations.</li>
  <li>The file <code>~/.brooklyn/brooklyn.properties</code> (unless <code>--noGlobalBrooklynProperties</code> is specified).</li>
  <li>Another properties file, if the <code>--localBrooklynProperties &lt;local brooklyn.properties file&gt;</code> is specified.</li>
  <li>Shell environment variables</li>
  <li>System properties, supplied with <code>-D</code> on the brooklyn (Java) command-line.</li>
</ol>

<p>These properties are described in more detail <a href="#contentsLink-brooklyn.properties">here</a>.</p>

<h3 id="internalLink_server-cli-reference_extending-the-classpath">Extending the Classpath</h3>

<p>The default Brooklyn directory structure includes:</p>

<ul>
  <li><code>./conf/</code>: for configuration resources.</li>
  <li><code>./lib/patch/</code>: for Jar files containing patches.</li>
  <li><code>./lib/brooklyn/</code>: for the brooklyn libraries.</li>
  <li><code>./lib/dropins/</code>: for additional Jars.</li>
</ul>

<p>Resources added to <code>conf/</code> will be available on the classpath.</p>

<p>A patch can be applied by adding a Jar to the <code>lib/patch/</code> directory, and restarting Brooklyn.
All jars in this directory will be at the head of the classpath.</p>

<p>Additional Jars should be added to <code>lib/dropins/</code>, prior to starting Brooklyn. These jars will 
be at the end of the classpath.</p>

<p>The initial classpath, as set in the <code>brooklyn</code> script, is:</p>

<pre><code>conf:lib/patch/*:lib/brooklyn/*:lib/dropins/*
</code></pre>

<p>Additional entries can be added at the head of the classpath by setting the environment variable 
<code>BROOKLYN_CLASSPATH</code> before running the <code>brooklyn</code> script. </p>

<h3 id="internalLink_server-cli-reference_replacing-the-web-console">Replacing the web-console</h3>

<p><em>Work in progress.</em></p>

<p>The Brooklyn web-console is loaded from the classpath as the resource <code>classpath://brooklyn.war</code>.</p>

<p>To replace this, an alternative WAR with that name can be added at the head of the classpath.
However, this approach is likely to change in a future release - consider this feature as “beta”.</p>

<h2 id="internalLink_server-cli-reference_cloud-explorer">Cloud Explorer</h2>

<p>The <code>brooklyn</code> command line tool includes support for querying (and managing) cloud
compute resources and blob-store resources. </p>

<p>For example, <code>brooklyn cloud-compute list-instances --location aws-ec2:eu-west-1</code>
will use the AWS credentials from <code>brooklyn.properties</code> and list the VM instances
running in the given EC2 region.</p>

<p>Use <code>brooklyn help</code> and <code>brooklyn help cloud-compute</code> to find out more information.</p>

<p>This functionality is not intended as a generic cloud management CLI, but instead 
solves specific Brooklyn use-cases. The main use-case is discovering the valid 
configuration options on a given cloud, such as for <code>imageId</code> and <code>hardwareId</code>.</p>

<h3 id="internalLink_server-cli-reference_cloud-compute">Cloud Compute</h3>

<p>The command <code>brooklyn cloud-compute</code> has the following options:</p>

<ul>
  <li>
    <p><code>list-images</code>: lists VM images within the given cloud, which can be chosen when
provisioning new VMs.
This is useful for finding the possible values for the <code>imageId</code> configuration.</p>
  </li>
  <li>
    <p><code>get-image &lt;imageId1&gt; &lt;imageId2&gt; ...</code>: retrieves metadata about the specific images.</p>
  </li>
  <li>
    <p><code>list-hardware-profiles</code>: lists the ids and the details of the hardware profiles
available when provisioning. 
This is useful for finding the possible values for the <code>hardwareId</code> configuration.</p>
  </li>
  <li>
    <p><code>default-template</code>: retrieves metadata about the image and hardware profile that will
be used by Brooklyn for that location, if no additional configuration options
are supplied.</p>
  </li>
  <li>
    <p><code>list-instances</code>: lists the VM instances within the given cloud.</p>
  </li>
  <li>
    <p><code>terminate-instances &lt;instanceId1&gt; &lt;instanceId2&gt; ...</code>: Terminates the instances with
the given ids.</p>
  </li>
</ul>

<h3 id="internalLink_server-cli-reference_blob-store"> Blob Store</h3>

<p>The command <code>brooklyn cloud-blobstore</code> is used to access a given object store, such as S3
or Swift. It has the following options:</p>

<ul>
  <li>
    <p><code>list-containers</code>: lists the containers (i.e. buckets in S3 terminology) within the 
given object store.</p>
  </li>
  <li>
    <p><code>list-container &lt;containerName&gt;</code>: lists all the blobs (i.e. objects) contained within 
the given container.</p>
  </li>
  <li>
    <p><code>blob --container &lt;containerName&gt; --blob &lt;blobName&gt;</code>: retrieves the given blob
(i.e. object), including metadata and its contents.</p>
  </li>
</ul>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-client-cli-reference" class="section-breaker section p-">
	<span style="width: 100%"><h1>Client CLI Reference</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p><strong>NOTE:</strong> These documents are for using the Brooklyn Client CLI tool to access a running Brooklyn Server.  For
information on starting on a Brooklyn Server, refer to <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/cli/../server-cli-reference.html">Server CLI Reference</a>.</p>

<h2 id="internalLink_client-cli-reference_obtaining-the-cli-tool">Obtaining the CLI tool</h2>

<p>A selection of distributions of the CLI tool, <code>br</code>, are available to download from the download site 
<a href="https://repository.apache.org/service/local/artifact/maven/redirect?r=snapshots&amp;g=org.apache.brooklyn&amp;a=brooklyn-client-cli&amp;v=0.12.0-SNAPSHOT&amp;c=bin&amp;e=zip">here</a>.</p>

<p>Alternatively the CLI tool is available as an executable binary for many more platforms in the Apache Brooklyn
 distribution, under <code>bin/brooklyn-client-cli/</code>, with each build in its own subdirectory:</p>

<ul>
  <li>Mac: <code>darwin.amd64/</code></li>
  <li>Windows 32-bit: <code>windows.386/</code></li>
  <li>Windows 64-bit: <code>windows.amd64/</code></li>
  <li>Linux 32-bit: <code>linux.386/</code></li>
  <li>Linux 64-bit: <code>linux.amd64/</code></li>
</ul>

<p>The binary is completely self-contained so you can either copy it to your <code>bin/</code> directory
or add the appropriate directory above to your path:</p>

<pre><code>PATH=$PATH:$HOME/apache-brooklyn/bin/brooklyn-client-cli/linux.amd64/
</code></pre>

<h2 id="internalLink_client-cli-reference_documentation">Documentation</h2>

<div class="list-children"><ul>

<li> <a href="#contentsLink-cli-reference-guide">CLI Reference Guide</a> </li>

<li> <a href="#contentsLink-cli-usage-guide">CLI Usage Guide</a> </li>

</ul></div>

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-cli-reference-guide" class="section-breaker section p-">
	<span style="width: 100%"><h1>CLI Reference Guide</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_cli-reference-guide_usage">Usage</h2>

<div class="highlight"><pre><code class="language-text" data-lang="text">NAME:
   br - A Brooklyn command line client application

USAGE:
   br [global options] command [command options] [arguments...]</code></pre></div>

<h2 id="internalLink_cli-reference-guide_list-of-commands">List of Commands</h2>
<p>Commands whose description begins with a <code>*</code> character are particularly experimental
and likely to change in upcoming releases.  </p>

<div class="highlight"><pre><code class="language-text" data-lang="text">COMMANDS:

   Commands whose description begins with a &quot;*&quot; character are particularly experimental and likely to change in upcoming
   releases.  If not otherwise specified, &quot;SCOPE&quot; below means application or entity scope.  If an entity scope is not
   specified, the application entity is used as a default.

   access		Show access control
   activity		Show the activity for an application / entity
   add-catalog		(deprecated, use catalog add) Add a new catalog item from the supplied YAML (a file or http URL)
   add-children		* Add a child or children to this entity from the supplied YAML
   application		Show the status and location of running applications
   catalog		Catalog operations
   config		Show the config for an application or entity
   delete		* Delete (expunge) a brooklyn application
   deploy		Deploy a new application from the given YAML (read from file or URL, or stdin)
   destroy-policy	Destroy a policy
   effector		Show the effectors for an application or entity
   entity		Show the entities of an application or entity
   env			Show the ENV stream for a given activity
   invoke		Invoke an effector of an application and entity
   locations		* List the available locations
   login		Login to brooklyn
   policy		Show the policies for an application or entity
   rename		Rename an application or entity
   restart		Invoke restart effector on an application and entity
   sensor		Show values of all sensors or named sensor for an application or entity
   set			Set config for an entity
   spec			Get the YAML spec used to create the entity, if available
   start		Invoke start effector on an application and entity
   start-policy		Start or resume a policy
   stderr		Show the STDERR stream for a given activity
   stdin		Show the STDIN stream for a given activity
   stdout		Show the STDOUT stream for a given activity
   stop			Invoke stop effector on an application and entity
   stop-policy		Suspends a policy
   tree			* Show the tree of all applications
   version		Display the version of the connected Brooklyn
   help			
   
GLOBAL OPTIONS:
   --skipSslChecks	Skip verification of server&#39;s certificate chain and hostname (for use with self-signed certs)
   --help, -h		show help
   --version, -v	print the version</code></pre></div>

<h2 id="internalLink_cli-reference-guide_scopes">Scopes</h2>
<p>Many commands require a “scope” expression to indicate the target on which they operate.
Where this
is required the usage statements below will use the shorthand nomenclature of <code>&lt;X-scope&gt;</code>.<br />
The various scopes should be replaced on the command line as:</p>

<ul>
  <li>
    <p><code>&lt;app-scope&gt;</code><br />
<code>application &lt;Name|AppID&gt;</code></p>
  </li>
  <li>
    <p><code>&lt;entity-scope&gt;</code><br />
<code>application &lt;Name|AppID&gt; entity &lt;Name|EntityID&gt;</code></p>
  </li>
  <li>
    <p><code>&lt;effector-scope&gt;</code><br />
<code>application &lt;Name|AppID&gt; effector &lt;Name&gt;</code><br />
<code>application &lt;Name|AppID&gt; entity &lt;Name|EntityID&gt; effector &lt;Name&gt;</code></p>
  </li>
  <li>
    <p><code>&lt;config-scope&gt;</code><br />
<code>application &lt;Name|AppID&gt; entity &lt;Name|EntityID&gt; config &lt;ConfigID&gt;</code></p>
  </li>
  <li>
    <p><code>&lt;activity-scope&gt;</code><br />
<code>activity &lt;ActivityID&gt;</code><br />
<code>application &lt;Name|AppID&gt; entity &lt;Name|EntityID&gt; activity &lt;ActivityID&gt;</code></p>
  </li>
</ul>

<h2 id="internalLink_cli-reference-guide_abbreviations">Abbreviations</h2>
<p>Many of the commands and scopes have shortened aliases:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">activity     act
application  app
entity       ent
policy       pol</code></pre></div>

<h2 id="internalLink_cli-reference-guide_command-reference">Command Reference</h2>

<h3 id="internalLink_cli-reference-guide_login">Login</h3>

<ul>
  <li>
    <p><code>br login &lt;URL&gt; [username [password]]</code><br />
Login to Brooklyn.  The CLI will prompt for a password if it is not provided.  If the Brooklyn server is running on 
localhost with no security enabled, the username and password may be omitted.<br />
On successful login, the version of the connected Brooklyn server is shown.</p>
  </li>
  <li>
    <p><code>br version</code>
Show the version of the connected Brooklyn server.</p>
  </li>
</ul>

<h3 id="internalLink_cli-reference-guide_applications">Applications</h3>

<ul>
  <li>
    <p><code>br deploy ( &lt;FILE|URL&gt; | - )</code><br />
Deploy an application based on the supplied YAML file or URL, or read from STDIN when <code>-</code> is given instead of a file name.</p>
  </li>
  <li>
    <p><code>br application</code><br />
List the running applications.</p>
  </li>
  <li>
    <p><code>br application &lt;Name|AppID&gt;</code><br />
Show the detail for an application.</p>
  </li>
  <li>
    <p><code>br &lt;app-scope&gt; config</code><br />
Show the configuration details for an application.</p>
  </li>
  <li>
    <p><code>br &lt;app-scope&gt; config &lt;ConfigID&gt;</code><br />
Show the value for a configuration item.</p>
  </li>
  <li>
    <p><code>br &lt;app-scope&gt; spec</code><br />
Show the YAML specification used to create the application.</p>
  </li>
  <li>
    <p><code>br &lt;app-scope&gt; rename &lt;Name&gt;</code><br />
Rename the application to <name>.</name></p>
  </li>
  <li>
    <p><code>br &lt;app-scope&gt; stop</code><br />
Stop an application.  See below for further information on the <code>stop</code> effector.</p>
  </li>
  <li>
    <p><code>br &lt;app-scope&gt; start</code><br />
Start an application.  See below for further information on the <code>start</code> effector.</p>
  </li>
  <li>
    <p><code>br &lt;app-scope&gt; restart</code><br />
Restart an application.  See below for further information on the <code>restart</code> effector.</p>
  </li>
  <li>
    <p><code>br &lt;app-scope&gt; delete</code><br />
Delete an application from Brooklyn.<br />
<strong>NOTE:</strong> Use this command with care.  Even if the application / entities are still running, Brooklyn will drop all 
knowledge of them and they will be left running in an ‘orphaned’ state.</p>
  </li>
</ul>

<h3 id="internalLink_cli-reference-guide_entities">Entities</h3>

<ul>
  <li>
    <p><code>br &lt;app-scope&gt; entity</code>  <br />
List the child entities for an application.</p>
  </li>
  <li>
    <p><code>br &lt;entity-scope&gt; entity</code><br />
List the child entities for an entity.</p>
  </li>
  <li>
    <p><code>br &lt;app-scope&gt; entity &lt;Name|EntityID&gt;</code><br />
Show the detail of an entity.</p>
  </li>
  <li>
    <p><code>br &lt;app-scope&gt; entity -c &lt;Name|EntityID&gt;</code><br />
List the child entities for an entity.</p>
  </li>
  <li>
    <p><code>br &lt;entity-scope&gt; config</code><br />
Show the configuration details for an entity.</p>
  </li>
  <li>
    <p><code>br &lt;entity-scope&gt; config &lt;ConfigID&gt;</code><br />
Show the value for a configuration item.</p>
  </li>
  <li>
    <p><code>br &lt;config-scope&gt; set &lt;ConfigValue&gt;</code><br />
Set the value of a configuration item.  </p>
  </li>
  <li>
    <p><code>br &lt;entity-scope&gt; spec</code><br />
Show the YAML specification used to create the entity.</p>
  </li>
  <li>
    <p><code>br &lt;entity-scope&gt; rename &lt;Name&gt;</code><br />
Rename the entity to <name>.</name></p>
  </li>
  <li>
    <p><code>br &lt;entity-scope&gt; stop</code><br />
Stop an entity.  See below for further information on the <code>stop</code> effector.</p>
  </li>
  <li>
    <p><code>br &lt;entity-scope&gt; start</code><br />
Start an entity.  See below for further information on the <code>start</code> effector.</p>
  </li>
  <li>
    <p><code>br &lt;entity-scope&gt; restart</code><br />
Restart an entity.  See below for further information on the <code>restart</code> effector.</p>
  </li>
</ul>

<h3 id="internalLink_cli-reference-guide_sensors">Sensors</h3>

<ul>
  <li>
    <p><code>br &lt;app-scope&gt; sensor</code><br />
List the sensors and values for an application.</p>
  </li>
  <li>
    <p><code>br &lt;app-scope&gt; sensor &lt;SensorID&gt;</code><br />
Show the value for a sensor.</p>
  </li>
  <li>
    <p><code>br &lt;entity-scope&gt; sensor</code><br />
List the sensors and values for an entity.</p>
  </li>
  <li>
    <p><code>br &lt;entity-scope&gt; sensor &lt;SensorID&gt;</code><br />
Show the value for a sensor.</p>
  </li>
</ul>

<h3 id="internalLink_cli-reference-guide_effectors">Effectors</h3>

<ul>
  <li>
    <p><code>br &lt;app-scope&gt; effector</code><br />
List the effectors for an application.</p>
  </li>
  <li>
    <p><code>br &lt;app-scope&gt; effector &lt;EffectorID&gt;</code><br />
Show the detail for an application effector.</p>
  </li>
  <li>
    <p><code>br &lt;app-scope&gt; effector &lt;EffectorID&gt; invoke</code><br />
Invoke the effector without any parameters.</p>
  </li>
  <li>
    <p><code>br &lt;app-scope&gt; effector &lt;EffectorID&gt; invoke [-P &lt;param&gt;=&lt;value&gt; ...]</code>
Invoke the effector with one of more parameters.</p>
  </li>
  <li>
    <p><code>br &lt;entity-scope&gt; effector</code><br />
List the effectors for an entity.</p>
  </li>
  <li>
    <p><code>br &lt;entity-scope&gt; effector &lt;EffectorID&gt;</code><br />
Show the detail for an entity effector.</p>
  </li>
  <li>
    <p><code>br &lt;entity-scope&gt; effector &lt;EffectorID&gt; invoke</code><br />
Invoke the effector without any parameters.</p>
  </li>
  <li>
    <p><code>br &lt;entity-scope&gt; effector &lt;EffectorID&gt; invoke [-P &lt;param&gt;=&lt;value&gt; ...]</code>
Invoke the effector with one of more parameters.<br />
If the parameter value is
complex or multi-lined it may be provided in a file and referenced as:<br />
<code>&lt;param&gt;=@&lt;FILE&gt;</code></p>
  </li>
</ul>

<p><strong>NOTE</strong> Shortcut commands have been provided for the standard start, restart and stop effectors.  For example:  </p>

<ul>
  <li><code>br &lt;app-scope&gt; stop</code>  </li>
  <li><code>br &lt;entity-scope&gt; restart restartChildren=true</code>  </li>
</ul>

<h3 id="internalLink_cli-reference-guide_policies">Policies</h3>

<ul>
  <li>
    <p><code>br &lt;entity-scope&gt; policy</code><br />
List the policies for an entity.</p>
  </li>
  <li>
    <p><code>br &lt;entity-scope&gt; policy &lt;PolicyID&gt;</code><br />
Show the detail for an entity policy.</p>
  </li>
  <li>
    <p><code>br &lt;entity-scope&gt; start-policy &lt;PolicyID&gt;</code><br />
Start an entity policy.</p>
  </li>
  <li>
    <p><code>br &lt;entity-scope&gt; stop-policy &lt;PolicyID&gt;</code><br />
Stop an entity policy.</p>
  </li>
  <li>
    <p><code>br &lt;entity-scope&gt; destroy-policy &lt;PolicyID&gt;</code><br />
Destroy an entity policy.</p>
  </li>
</ul>

<h3 id="internalLink_cli-reference-guide_activities">Activities</h3>

<ul>
  <li>
    <p><code>br &lt;app-scope&gt; activity</code><br />
List the activities for an application.</p>
  </li>
  <li>
    <p><code>br &lt;entity-scope&gt; activity</code><br />
List the activities for an entity.</p>
  </li>
  <li>
    <p><code>br &lt;activity-scope&gt; activity</code><br />
List the activities for an activity (ie its children).</p>
  </li>
  <li>
    <p><code>br activity &lt;ActivityID&gt;</code><br />
Show the detail for an activity.</p>
  </li>
  <li>
    <p><code>br activity -c &lt;ActivityID&gt;</code><br />
List the child activities of an activity.</p>
  </li>
  <li>
    <p><code>br &lt;activity-scope&gt; stdin</code><br />
Show the <code>&lt;STDIN&gt;</code> stream for an activity.</p>
  </li>
  <li>
    <p><code>br &lt;activity-scope&gt; stdout</code><br />
Show the <code>&lt;STDOUT&gt;</code> stream for an activity.</p>
  </li>
  <li>
    <p><code>br &lt;activity-scope&gt; stderr</code><br />
Show the <code>&lt;STDERR&gt;</code> stream for an activity.</p>
  </li>
  <li>
    <p><code>br &lt;activity-scope&gt; env</code><br />
Show the Environment for an activity.</p>
  </li>
</ul>

<h3 id="internalLink_cli-reference-guide_miscellaneous">Miscellaneous</h3>

<h4 id="internalLink_cli-reference-guide_applications-1">Applications</h4>

<ul>
  <li><code>br tree</code><br />
List all of the applications and entities in a tree representation.</li>
</ul>

<h4 id="internalLink_cli-reference-guide_entities-1">Entities</h4>

<ul>
  <li><code>br &lt;entity-scope&gt; add-children &lt;FILE|URL&gt;</code><br />
Add a child or children to the entity from local YAML file or a URL.</li>
</ul>

<h4 id="internalLink_cli-reference-guide_catalog">Catalog</h4>

<ul>
  <li>
    <p><code>br catalog list &lt;TYPE&gt;</code><br />
List the application catalog, where <code>TYPE</code> is one of “application”, “entity”, “location”, or “policy”</p>
  </li>
  <li>
    <p><code>br catalog delete  &lt;TYPE&gt; &lt;ITEM_ID:VERSION&gt;</code><br />
Delete an item from the catalog, where <code>TYPE</code> is as above, and supplying the item’s id and version </p>
  </li>
  <li>
    <p><code>br catalog add &lt;FILE|URL&gt;</code><br />
Add catalog entries from a local YAML file or a URL. The id and version of added entries are displayed.</p>
  </li>
  <li>
    <p><code>br locations</code><br />
List the location catalog. (Includes all locations including those defined in <code>brooklyn.properties</code>)</p>
  </li>
  <li>
    <p><code>br access</code><br />
Show if you have access to provision locations.</p>
  </li>
</ul>

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-cli-usage-guide" class="section-breaker section p-">
	<span style="width: 100%"><h1>CLI Usage Guide</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>This document provides a brief overview of using the most common Brooklyn CLI commands,
by using the CLI to deploy an application then examine various aspects of it.</p>

<p>The YAML blueprint for the application that will be deployed is shown at the end of this document.</p>

<p><strong>NOTE:</strong> In the sample output, some additional line-wrapping has been used to aid readabilty. Additionally, the 
vertical bar character is omitted from table output for readability.  For scripting purposes it can be useful in
conjunction with a shell pipeline like <code>some_command | cut -f 1 -d '|' | xargs -L1 some_other_command</code>.</p>

<h2 id="internalLink_cli-usage-guide_login">Login</h2>
<p>First, login to the running Brooklyn server.  This example assumes that the Brooklyn server
is running on <code>localhost</code>; change the URL and credentials as necessary.</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br login http://localhost:8081 admin
Enter Password: *
Connected to Brooklyn version 0.9.0-SNAPSHOT at http://localhost:8081</code></pre></div>

<p>The version of the connected Brooklyn server may be viewed with the <code>version</code> command:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br version
0.9.0-SNAPSHOT</code></pre></div>

<h2 id="internalLink_cli-usage-guide_applications">Applications</h2>
<p>Deploy the application; on success the Id of the new application is displayed:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br deploy webapp-policy.yaml
Id:       lmOcZbsT   
Name:     WebCluster   
Status:   In progress</code></pre></div>

<p>The <code>application</code> command can be used to list a summary of all the running applications.
After all of the entities have been started, the application status changes to <code>RUNNING</code>:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br application
Id         Name         Status    Location   
YeEQHwgW   AppCluster   RUNNING   CNTBOtjI
lmOcZbsT   WebCluster   RUNNING   CNTBOtjI</code></pre></div>

<p>Further details of an application can be seen by using the ApplicationID or Name as a
parameter for the <code>application</code> command:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br application WebCluster
Id:              lmOcZbsT   
Name:            WebCluster   
Status:          RUNNING   
ServiceUp:       true   
Type:            org.apache.brooklyn.entity.stock.BasicApplication   
CatalogItemId:   null   
LocationId:      CNTBOtjI   
LocationName:    FixedListMachineProvisioningLocation:CNTB   
LocationSpec:    byon   
LocationType:    org.apache.brooklyn.location.byon.FixedListMachineProvisioningLocation</code></pre></div>

<p>The configuration details of an application can be seen with the <code>config</code> command:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br application WebCluster config
Key                    Value   
camp.template.id       TYWVroRz   
brooklyn.wrapper_app   true</code></pre></div>

<h2 id="internalLink_cli-usage-guide_entities">Entities</h2>
<p>The entities of an application can be viewed with the <code>entity</code> command:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br app WebCluster entity
Id        Name    Type   
xOcMooka  WebApp  org.apache.brooklyn.entity.webapp.ControlledDynamicWebAppCluster
thHnLFkP  WebDB   org.apache.brooklyn.entity.database.mysql.MySqlNode</code></pre></div>

<p>It is common for an entity to have child entities; these can be listed by providing an
entity-scope for the <code>entity</code> command:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br app WebCluster entity WebApp entity
Id         Name                     Type   
e5pWAiHf   Cluster of TomcatServer  org.apache.brooklyn.entity.webapp.DynamicWebAppCluster   
CZ8QUVgX   NginxController:CZ8Q     org.apache.brooklyn.entity.proxy.nginx.NginxController</code></pre></div>

<p>or by using <code>-c</code> (or <code>--children</code>) flag with the <code>entity</code> command:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br app WebCluster entity -c e5pWAiHf
Id         Name               Type   
x0P2LRxZ   quarantine         org.apache.brooklyn.entity.group.QuarantineGroup   
QK6QjmrW   TomcatServer:QK6Q  org.apache.brooklyn.entity.webapp.tomcat.TomcatServer</code></pre></div>

<p>As for applications, the configuration details of an entity can be seen with the <code>config</code>
command:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br app WebCluster entity thHnLFkP config
Key                             Value   
install.unique_label            MySqlNode_5.6.26   
brooklyn.wrapper_app            true   
datastore.creation.script.url   https://bit.ly/brooklyn-visitors-creation-script   
camp.template.id                dnw3GqN0   
camp.plan.id                    db   
onbox.base.dir                  /home/vagrant/brooklyn-managed-processes   
onbox.base.dir.resolved         true</code></pre></div>

<p>The value of a single configuration item can be displayed by using the configuration key
as a parameter for the <code>config</code> command:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br app WebCluster entity thHnLFkP config datastore.creation.script.url
https://bit.ly/brooklyn-visitors-creation-script</code></pre></div>

<p>The value of a configuration item can be changed by using the <code>set</code> command:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br app WebCluster entity thHnLFkP config datastore.creation.script.url set \&quot;https://bit.ly/new-script\&quot;</code></pre></div>

<h2 id="internalLink_cli-usage-guide_sensors">Sensors</h2>
<p>The sensors associated with an application or entity can be listed with the <code>sensor</code> command:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br app WebCluster entity CZ8QUVgX sensor
Name                                    Value
download.addon.urls:                    {&quot;stickymodule&quot;:&quot;https://bitbucket.org/nginx-goodies/n  
                                        ginx-sticky-module-ng/get/${addonversion}.tar.gz&quot;,&quot;pcr  
                                        e&quot;:&quot;ftp://ftp.csx.cam.ac.uk/pub/software/programming/p  
                                        cre/pcre-${addonversion}.tar.gz&quot;}
download.url:                           http://nginx.org/download/nginx-${version}.tar.gz
expandedinstall.dir:                    /home/vagrant/brooklyn-managed-processes/installs/Ngi  
                                        nxController_1.8.0/nginx-1.8.0
host.address:                           192.168.52.102
host.name:                              192.168.52.102
host.sshAddress:                        vagrant@192.168.52.102:22
host.subnet.address:                    192.168.52.102
host.subnet.hostname:                   192.168.52.102
http.port:                              8000
install.dir:                            /home/vagrant/brooklyn-managed-processes/installs/Ngin  
                                        xController_1.8.0
log.location:                           /home/vagrant/brooklyn-managed-processes/apps/FoEXXwJ2  
                                        /entities/NginxController_CZ8QUVgX/console
main.uri:                               http://192.168.52.102:8000/
member.sensor.hostandport:
member.sensor.hostname:                 {&quot;typeToken&quot;:null,&quot;type&quot;:&quot;java.lang.String&quot;,&quot;name&quot;:&quot;ho  
                                        st.subnet.hostname&quot;,&quot;description&quot;:&quot;Host name as known   
                                        internally in the subnet where it is running (if diffe  
                                        rent to host.name)&quot;,&quot;persistence&quot;:&quot;REQUIRED&quot;}
member.sensor.portNumber:               {&quot;typeToken&quot;:null,&quot;type&quot;:&quot;java.lang.Integer&quot;,&quot;name&quot;:&quot;h  
                                        ttp.port&quot;,&quot;description&quot;:&quot;HTTP port&quot;,&quot;persistence&quot;:&quot;RE  
                                        QUIRED&quot;,&quot;configKey&quot;:{&quot;name&quot;:&quot;http.port&quot;,&quot;typeToken&quot;:nu  
                                        ll,&quot;type&quot;:&quot;org.apache.brooklyn.api.location.PortRange&quot;  
                                        ,&quot;description&quot;:&quot;HTTP port&quot;,&quot;defaultValue&quot;:{&quot;ranges&quot;:[{  
                                        &quot;port&quot;:8080},{&quot;start&quot;:18080,&quot;end&quot;:65535,&quot;delta&quot;:1}]},&quot;  
                                        reconfigurable&quot;:false,&quot;inheritance&quot;:null,&quot;constraint&quot;:  
                                        &quot;ALWAYS_TRUE&quot;}}
nginx.log.access:                       /home/vagrant/brooklyn-managed-processes/apps/FoEXXwJ2  
                                        /entities/NginxController_CZ8QUVgX/logs/access.log
nginx.log.error:                        /home/vagrant/brooklyn-managed-processes/apps/FoEXXwJ2  
                                        /entities/NginxController_CZ8QUVgX/logs/error.log
nginx.pid.file:                         /home/vagrant/brooklyn-managed-processes/apps/FoEXXwJ2  
                                        /entities/NginxController_CZ8QUVgX/pid.txt
nginx.url.answers.nicely:               true
proxy.domainName:
proxy.http.port:                        8000
proxy.https.port:                       8443
proxy.protocol:                         http
proxy.serverpool.targets:               {&quot;TomcatServerImpl{id=QK6QjmrW}&quot;:&quot;192.168.52.103:8080&quot;}
run.dir:                                /home/vagrant/brooklyn-managed-processes/apps/FoEXXwJ2  
                                        /entities/NginxController_CZ8QUVgX
service.isUp:                           true
service.notUp.diagnostics:              {}
service.notUp.indicators:               {}
service.problems:                       {}
service.process.isRunning:              true
service.state:                          RUNNING
service.state.expected:                 running @ 1449314377781 / Sat Dec 05 11:19:37 GMT 2015
softwareprocess.pid.file:
softwareservice.provisioningLocation:   {&quot;type&quot;:&quot;org.apache.brooklyn.api.location.Location&quot;,&quot;i  
                                        d&quot;:&quot;zhYBc6xt&quot;}
webapp.url:                             http://192.168.52.102:8000/</code></pre></div>

<p>Details for an individual sensor can be shown by providing the Sensor Name as a
parameter to the <code>sensor</code> command:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br app WebCluster entity CZ8QUVgX sensor service.state.expected
running @ 1449314377781 / Sat Dec 05 11:19:37 GMT 2015</code></pre></div>

<h2 id="internalLink_cli-usage-guide_effectors">Effectors</h2>
<p>The effectors for an application or entity can be listed with the <code>effector</code> command:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br app WebCluster effector
Name      Description                                            Parameters   
restart   Restart the process/service represented by an entity      
start     Start the process/service represented by an entity     locations   
stop      Stop the process/service represented by an entity</code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br app WebCluster entity NginxController:CZ8Q effector
Name                              Description                     Parameters   
deploy                            Deploys an archive ...
getCurrentConfiguration           Gets the current ...      
populateServiceNotUpDiagnostics   Populates the attribute ...
reload                            Forces reload of ...  
restart                           Restart the process/service ... restartChildren,restartMachine
start                             Start the process/service ...   locations
stop                              Stop the process/service ...    stopProcessMode,stopMachineMode
update                            Updates the entities ...</code></pre></div>

<p>Details of an individual effector can be viewed by using the name as a parameter for
the <code>effector</code> command:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br app WebCluster entity NginxController:CZ8Q effector update
Name:         update
Description:  Updates the entities configuration, and then forces reload of that configuration
Parameters:</code></pre></div>

<p>An effector can be invoked by using the <code>invoke</code> command with an effector-scope:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br app WebCluster entity NginxController:CZ8Q effector update invoke</code></pre></div>

<p>Parameters can also be passed to the effector:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br app WebCluster entity NginxController:CZ8Q effector restart invoke -P restartChildren=true</code></pre></div>

<p>If a parameter value is complex or spans multiple lines, it may be provided in a file and used like this:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br app WebCluster effector start invoke -P locations=@data.txt</code></pre></div>

<p>Shortcut commands are available for the 3 standard effectors of <code>start</code>, <code>restart</code> and <code>stop</code>.
These commands can be used directly with an app-scope or entity-scope:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br app WebCluster entity NginxController:CZ8Q restart
$ br app WebCluster stop</code></pre></div>

<h2 id="internalLink_cli-usage-guide_policies">Policies</h2>
<p>The policies associated with an application or entity can be listed with the <code>policy</code> command:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br app WebCluster entity NginxController:CZ8Q policy
Id         Name                         State   
VcZ0cfeO   Controller targets tracker   RUNNING</code></pre></div>

<p>Details of an individual policy may be viewed by using the PolicyID as a parameter to
the <code>policy</code> command:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br app WebCluster entity NginxController:CZ8Q policy VcZ0cfeO
Name                 Value                                    Description   
group                DynamicWebAppClusterImpl{id=TpbkaK4D}    group   
notifyOnDuplicates   false                                    Whether to notify listeners when
                                                              a sensor is published with the
                                                              same value as last time   
sensorsToTrack       [Sensor: host.subnet.hostname            Sensors of members to be monitored
                     (java.lang.String), Sensor: http.port    (implicitly adds service-up
                     (java.lang.Integer)]                     to this list, but that
                                                              behaviour may be deleted in a
                                                              subsequent release!)</code></pre></div>

<h2 id="internalLink_cli-usage-guide_activities">Activities</h2>
<p>The activities for an application or entity may be listed with the <code>activity</code> command:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br app WebCluster activity
Id         Task                                   Submitted                      Status      Streams   
Wb6GV5rt   start                                  Sat Dec 19 11:08:01 GMT 2015   Completed      
q2MbyyTo   invoking start[locations] on 2 nodes   Sat Dec 19 11:08:01 GMT 2015   Completed</code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br app WebCluster entity NginxController:CZ8Q activity
Id         Task                                       Submitted                      Status      Streams   
GVh0pyKG   start                                      Sun Dec 20 19:18:06 GMT 2015   Completed          
WJm908rA   provisioning (FixedListMachineProvisi...   Sun Dec 20 19:18:06 GMT 2015   Completed          
L0cKFBrW   pre-start                                  Sun Dec 20 19:18:06 GMT 2015   Completed              
D0Ab2esP   ssh: initializing on-box base dir ./b...   Sun Dec 20 19:18:06 GMT 2015   Completed   env,stderr,stdin,stdout
tumLAdo4   start (processes)                          Sun Dec 20 19:18:06 GMT 2015   Completed                  
YbF2czKM   copy-pre-install-resources                 Sun Dec 20 19:18:06 GMT 2015   Completed                                     
o3YdqxsQ   pre-install                                Sun Dec 20 19:18:06 GMT 2015   Completed                 
TtGw4qMZ   pre-install-command                        Sun Dec 20 19:18:06 GMT 2015   Completed        
duPvOSDB   setup                                      Sun Dec 20 19:18:06 GMT 2015   Completed       
WLtkbhgW   copy-install-resources                     Sun Dec 20 19:18:06 GMT 2015   Completed           
ZQtrImnl   install                                    Sun Dec 20 19:18:06 GMT 2015   Completed           
hzi49YD6   ssh: setting up sudo                       Sun Dec 20 19:18:06 GMT 2015   Completed   env,stderr,stdin,stdout
eEUHcpfi   ssh: Getting machine details for: Ssh...   Sun Dec 20 19:18:07 GMT 2015   Completed   env,stderr,stdin,stdout
juTe2qLG   ssh: installing NginxControllerImpl{i...   Sun Dec 20 19:18:08 GMT 2015   Completed   env,stderr,stdin,stdout
hXqwEZJl   post-install-command                       Sun Dec 20 19:18:08 GMT 2015   Completed          
vZliYwBI   customize                                  Sun Dec 20 19:18:08 GMT 2015   Completed            
O4Wwb0bP   ssh: customizing NginxControllerImpl{...   Sun Dec 20 19:18:08 GMT 2015   Completed   env,stderr,stdin,stdout
sDwMSkE2   copy-runtime-resources                     Sun Dec 20 19:18:08 GMT 2015   Completed         
yDYkdkS8   ssh: create run directory                  Sun Dec 20 19:18:08 GMT 2015   Completed   env,stderr,stdin,stdout
W7dI8r1c   pre-launch-command                         Sun Dec 20 19:18:08 GMT 2015   Completed           
OeZKwM5z   launch                                     Sun Dec 20 19:18:08 GMT 2015   Completed          
y50Gne5E   scheduled:nginx.url.answers.nicely @ ...   Sun Dec 20 19:18:08 GMT 2015   Scheduler,      
ARTninGE   scheduled:service.process.isRunning @...   Sun Dec 20 19:18:08 GMT 2015   Scheduler,      
tvZoNUTN   ssh: launching NginxControllerImpl{id...   Sun Dec 20 19:18:08 GMT 2015   Completed   env,stderr,stdin,stdout
YASrjA4w   post-launch-command                        Sun Dec 20 19:18:09 GMT 2015   Completed             
jgLYv8pE   post-launch                                Sun Dec 20 19:18:09 GMT 2015   Completed          
UN9OcWLS   post-start                                 Sun Dec 20 19:18:09 GMT 2015   Completed           
nmiv97He   reload                                     Sun Dec 20 19:18:09 GMT 2015   Completed            
FJfPbNtp   ssh: restarting NginxControllerImpl{i...   Sun Dec 20 19:18:10 GMT 2015   Completed   env,stderr,stdin,stdout
Xm1tjvKf   update                                     Sun Dec 20 19:18:40 GMT 2015   Completed        
Row67vfa   reload                                     Sun Dec 20 19:18:40 GMT 2015   Completed           
r8QZXlxJ   ssh: restarting NginxControllerImpl{i...   Sun Dec 20 19:18:40 GMT 2015   Completed   env,stderr,stdin,stdout</code></pre></div>

<p>The detail for an individual activity can be viewed by providing the ActivityID as a
parameter to the <code>activity</code> command (an app-scope or entity-scope is not not needed for viewing
the details of an activity):</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br activity tvZoNUTN
Id:                  tvZoNUTN   
DisplayName:         ssh: launching NginxControllerImpl{id=OxPUBk1p}   
Description:            
EntityId:            OxPUBk1p   
EntityDisplayName:   NginxController:OxPU   
Submitted:           Sun Dec 20 19:18:08 GMT 2015   
Started:             Sun Dec 20 19:18:08 GMT 2015   
Ended:               Sun Dec 20 19:18:09 GMT 2015   
CurrentStatus:       Completed   
IsError:             false   
IsCancelled:         false   
SubmittedByTask:     OeZKwM5z   
Streams:             stdin: 1133, stdout: 162, stderr: 0, env 0   
DetailedStatus:      &quot;Completed after 1.05s

Result: 0&quot;</code></pre></div>

<p>The activity command output shows whether any streams were associated with it.  The streams
and environment for an activity can be viewed with the commands <code>stdin</code>, <code>stdout</code>,
<code>stderr</code> and <code>env</code>:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br activity tvZoNUTN stdin
export RUN_DIR=&quot;/home/vagrant/brooklyn-managed-processes/apps/V5GQCpIT/entities/NginxController_OxPUBk1p&quot;
mkdir -p $RUN_DIR
cd $RUN_DIR
cd /home/vagrant/brooklyn-managed-processes/apps/V5GQCpIT/entities/NginxController_OxPUBk1p
{ which &quot;./sbin/nginx&quot; || { EXIT_CODE=$? &amp;&amp; ( echo &quot;The required executable \&quot;./sbin/nginx\&quot; does not exist&quot; | tee /dev/stderr ) &amp;&amp; exit $EXIT_CODE ; } ; }
nohup ./sbin/nginx -p /home/vagrant/brooklyn-managed-processes/apps/V5GQCpIT/entities/NginxController_OxPUBk1p/ -c conf/server.conf &gt; /home/vagrant/brooklyn-managed-processes/apps/V5GQCpIT/entities/NginxController_OxPUBk1p/console 2&gt;&amp;1 &amp;
for i in {1..10}
do
    test -f /home/vagrant/brooklyn-managed-processes/apps/V5GQCpIT/entities/NginxController_OxPUBk1p/logs/nginx.pid &amp;&amp; ps -p `cat /home/vagrant/brooklyn-managed-processes/apps/V5GQCpIT/entities/NginxController_OxPUBk1p/logs/nginx.pid` &amp;&amp; exit
    sleep 1
done
echo &quot;No explicit error launching nginx but couldn&#39;t find process by pid; continuing but may subsequently fail&quot;
cat /home/vagrant/brooklyn-managed-processes/apps/V5GQCpIT/entities/NginxController_OxPUBk1p/console | tee /dev/stderr</code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br activity tvZoNUTN stdout
./sbin/nginx
  PID TTY          TIME CMD
 6178 ?        00:00:00 nginx
Executed /tmp/brooklyn-20151220-191808796-CaiI-launching_NginxControllerImpl_.sh, result 0</code></pre></div>

<p>The child activities of an activity may be listed by providing an activity-scope for the
<code>activity</code> command:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br activity OeZKwM5z
Id:                  OeZKwM5z   
DisplayName:         launch   
Description:            
EntityId:            OxPUBk1p   
EntityDisplayName:   NginxController:OxPU   
Submitted:           Sun Dec 20 19:18:08 GMT 2015   
Started:             Sun Dec 20 19:18:08 GMT 2015   
Ended:               Sun Dec 20 19:18:09 GMT 2015   
CurrentStatus:       Completed   
IsError:             false   
IsCancelled:         false   
SubmittedByTask:     tumLAdo4   
Streams:                
DetailedStatus:      &quot;Completed after 1.06s

No return value (null)&quot;

$ br activity OeZKwM5z activity
Id         Task                                       Submitted                      Status      Streams   
tvZoNUTN   ssh: launching NginxControllerImpl{id...   Sun Dec 20 19:18:08 GMT 2015   Completed   env,stderr,stdin,stdout</code></pre></div>

<p>or by using the <code>-c</code> (or <code>--children</code>) flag with the <code>activity</code> command:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">$ br activity -c OeZKwM5z
Id         Task                                       Submitted                      Status      Streams   
tvZoNUTN   ssh: launching NginxControllerImpl{id...   Sun Dec 20 19:18:08 GMT 2015   Completed   env,stderr,stdin,stdout</code></pre></div>

<h2 id="internalLink_cli-usage-guide_yaml-blueprint">YAML Blueprint</h2>
<p>This the YAML blueprint used for this document.</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">name: WebCluster

location:
  byon:
    user: vagrant
    password: vagrant
    hosts:
      - 192.168.52.101
      - 192.168.52.102
      - 192.168.52.103
      - 192.168.52.104
      - 192.168.52.105

services:

- type: org.apache.brooklyn.entity.webapp.ControlledDynamicWebAppCluster
  name: WebApp
  brooklyn.config:
    wars.root: http://search.maven.org/remotecontent?filepath=org/apache/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.8.0-incubating/brooklyn-example-hello-world-sql-webapp-0.8.0-incubating.war
    java.sysprops:
      brooklyn.example.db.url: &gt;
        $brooklyn:formatString(&quot;jdbc:%s%s?user=%s&amp;password=%s&quot;,
        component(&quot;db&quot;).attributeWhenReady(&quot;datastore.url&quot;),
        &quot;visitors&quot;, &quot;brooklyn&quot;, &quot;br00k11n&quot;)
  brooklyn.policies:
  - type: org.apache.brooklyn.policy.autoscaling.AutoScalerPolicy
    brooklyn.config:
      metric: webapp.reqs.perSec.windowed.perNode
      metricLowerBound: 2
      metricUpperBound: 10
      minPoolSize: 1
      maxPoolSize: 2
      resizeUpStabilizationDelay: 1m
      resizeDownStabilizationDelay: 5m

- type: org.apache.brooklyn.entity.database.mysql.MySqlNode
  id: db
  name: WebDB
  brooklyn.config:
    creationScriptUrl: https://bit.ly/brooklyn-visitors-creation-script</code></pre></div>


	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-gui-guide" class="section-breaker section p-">
	<span style="width: 100%"><h1>GUI Guide</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	
<div class="list-children"><ul>

<li> <a href="#contentsLink-launching">Launching</a> </li>

<li> <a href="#contentsLink-deploying-blueprints">Deploying Blueprints</a> </li>

<li> <a href="#contentsLink-monitoring-and-managing-applications">Monitoring and Managing Applications</a> </li>

<li> <a href="#contentsLink-using-policies">Using Policies</a> </li>

</ul></div>

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-launching" class="section-breaker section p-">
	<span style="width: 100%"><h1>Launching</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>This guide will walk you through connecting to the Brooklyn Server Graphical User Interface and performing various tasks.</p>

<p>For an explanation of common Brooklyn Concepts see the <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/gui/../../start/concept-quickstart.html">Brooklyn Concepts Quickstart</a> or see the  full guide in the <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/gui/../../concepts">Brooklyn Concepts</a> chapter of the <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/gui/../../index.html">User Guide</a>.</p>

<p>This guide assumes that you are using Linux or Mac OS X and that Brooklyn Server will be running on your local system.</p>

<h2 id="internalLink_launching_launch-apache-brooklyn">Launch Apache Brooklyn</h2>

<p>If you haven’t already done so, you will need to start Brooklyn Server using the commands shown below.<br />
It is not necessary at this time, but depending on what you are going to do, 
you may wish to set up some other configuration options first,</p>

<ul>
  <li><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/gui/../brooklyn_properties.html">Security</a></li>
  <li><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/gui/../persistence/index.html">Persistence</a></li>
</ul>

<p>Now start Brooklyn with the following command:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">cd </span>apache-brooklyn-0.12.0-SNAPSHOT
<span class="nv">$ </span>bin/brooklyn launch</code></pre></div>

<p>Please refer to the <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/gui/../server-cli-reference.html">Server CLI Reference</a> for details of other possible command line options.</p>

<p>Brooklyn will output the address of the management interface:</p>

<pre>
INFO  Starting Brooklyn web-console with no security options (defaulting to no authentication), on bind address <any>
INFO  Started Brooklyn console at http://127.0.0.1:8081/, running classpath://brooklyn.war@
INFO  Persistence disabled
INFO  High availability disabled
INFO  Launched Brooklyn; will now block until shutdown command received via GUI/API (recommended) or process interrupt.


_Notice! Before launching Apache Brooklyn, please check the `date` on the local machine.
Even several minutes before or after the actual time could cause problems._

## Connect with Browser

Next, open the web console on [http://127.0.0.1:8081](http://127.0.0.1:8081). 
No applications have been deployed yet, so the "Create Application" dialog opens automatically.

[![Brooklyn web console, showing the YAML tab of the Add Application dialog.](images/add-application-catalog-web-cluster-with-db.png)](images/add-application-catalog-web-cluster-with-db-large.png)


## Next
The next section will show how to **[deploy a blueprint](blueprints.html)**.
</any></pre>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-deploying-blueprints" class="section-breaker section p-">
	<span style="width: 100%"><h1>Deploying Blueprints</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	
<h2 id="internalLink_deploying-blueprints_launching-from-a-blueprint">Launching from a Blueprint</h2>

<p>When you first access the web console on <a href="http://127.0.0.1:8081">http://127.0.0.1:8081</a> you will be requested to create your first application.</p>

<p>We’ll start by deploying an application via a YAML blueprint consisting of the following layers.</p>

<ul>
  <li>MySQL DB</li>
  <li>Dynamic web application cluster
    <ul>
      <li>Nginx load balancer</li>
      <li>Tomcat app server cluster</li>
    </ul>
  </li>
</ul>

<p><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/gui/images/add-application-modal-yaml-large.png"><img src="./v/latest/ops/gui/images/add-application-modal-yaml.png" alt="Brooklyn web console, showing the YAML tab of the Add Application dialog." /></a></p>

<p>Switch to the YAML tab and copy the blueprint below into the large text box. </p>

<p>But <em>before</em> you submit it, modify the YAML to specify the location where the application will be deployed.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">My Web Cluster</span>

<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">jclouds:aws-ec2</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">identity</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ABCDEFGHIJKLMNOPQRST</span>
    <span class="l-Scalar-Plain">credential</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">s3cr3tsq1rr3ls3cr3tsq1rr3ls3cr3tsq1rr3l</span>

<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.ControlledDynamicWebAppCluster</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">My Web</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">webappcluster</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">wars.root</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=org/apache/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.8.0-incubating/brooklyn-example-hello-world-sql-webapp-0.8.0-incubating.war</span>
    <span class="l-Scalar-Plain">java.sysprops</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">brooklyn.example.db.url</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
        <span class="no">$brooklyn:formatString(&quot;jdbc:%s%s?user=%s&amp;password=%s&quot;,</span>
        <span class="no">component(&quot;db&quot;).attributeWhenReady(&quot;datastore.url&quot;),</span>
        <span class="no">&quot;visitors&quot;, &quot;brooklyn&quot;, &quot;br00k11n&quot;)</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.database.mysql.MySqlNode</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">My DB</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">db</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">creationScriptUrl</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://bit.ly/brooklyn-visitors-creation-script</span></code></pre></div>

<p>Replace the <code>location:</code> element with values for your chosen target environment, for example to use SoftLayer rather than AWS (updating with your own credentials): </p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">jclouds:softlayer</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">identity</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ABCDEFGHIJKLMNOPQRST</span>
    <span class="l-Scalar-Plain">credential</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">s3cr3tsq1rr3ls3cr3tsq1rr3ls3cr3tsq1rr3l</span></code></pre></div>

<p><strong>NOTE</strong>: See <strong><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/gui/../locations">Locations</a></strong> in the Operations section of the User Guide for instructions on setting up alternate cloud providers, bring-your-own-nodes, or localhost targets, and storing credentials/locations in a file on disk rather than in the blueprint.</p>

<p>With the modified YAML in the dialog, click “Finish”. The dialog will close and Brooklyn will begin deploying your
application. Your application will be shown as “Starting” on the web console’s front page.</p>

<p><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/gui/images/home-app-starting-large.png"><img src="./v/latest/ops/gui/images/home-app-starting.png" alt="Brooklyn web console, showing the application starting." /></a></p>

<p>Depending on your choice of location it may take some time for the application nodes to start, the next page describes how you can monitor the progress of the application deployment and verify its successful deployment.</p>

<h2 id="internalLink_deploying-blueprints_launching-from-the-catalog">Launching from the Catalog</h2>

<p>Instead of pasting the YAML blueprint each time, it can be added to the Brooklyn Catalog where it will be accessible from the Catalog tab of the Create Application dialog.</p>

<p><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/gui/images/add-application-catalog-web-cluster-with-db-large.png"><img src="./v/latest/ops/gui/images/add-application-catalog-web-cluster-with-db.png" alt="Viewing Catalog entries in Add Application dialog." /></a></p>

<!-- TODO: more detail for adding to catalog? but wait for persistence to be the default, 
     rather than extensively document default.catalog.bom.
     also need to include instructions on stopping (currently in help, including stopping apps) -->

<p>See <strong><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/gui/../catalog/index.html">Catalog</a></strong> in the Operations section of the User Guide for instructions on creating a new Catalog entry from your Blueprint YAML.</p>

<h2 id="internalLink_deploying-blueprints_next">Next</h2>

<p>So far we have touched on Brooklyn’s ability to <em>deploy</em> an application blueprint to a cloud provider.<br />
The next section will show how to <strong><a href="#contentsLink-monitoring-and-managing-applications">Monitor and Manage Applications</a></strong>.</p>

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-monitoring-and-managing-applications" class="section-breaker section p-">
	<span style="width: 100%"><h1>Monitoring and Managing Applications</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>From the Home page, click on the application name or open the Applications tab.</p>

<p>We can explore the management hierarchy of the application, which will show us the entities it is composed of.  Starting from the application use the arrows to expand out the list of entities, or hover over the arrow until a menu popup is displayed so that you can select <code>Expand All</code>.  </p>

<ul>
  <li>My Web Cluster (A <code>BasicApplication</code>)
    <ul>
      <li>My DB (A <code>MySqlNode</code>)</li>
      <li>My Web (A <code>ControlledDynamicWebAppCluster</code>)
        <ul>
          <li>Cluster of TomcatServer (A <code>DynamicWebAppCluster</code>)
            <ul>
              <li>quarantine (A <code>QuarantineGroup</code>)</li>
              <li>TomcatServer (A <code>TomcatServer</code>)</li>
            </ul>
          </li>
          <li>NginxController (An <code>NginxController</code>)</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>Clicking on the “My Web Cluster” entity will show the “Summary” tab,
giving a very high level of what that component is doing. 
Click on each of the child components in turn for more detail on that component. 
Note that the cluster of web servers includes a “quarantine group”, to which members of the 
cluster that fail will be added. These are excluded from the load-balancer’s targets.</p>

<p><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/gui/images/my-web-large.png"><img src="./v/latest/ops/gui/images/my-web.png" alt="Exploring My Web." /></a></p>

<h2 id="internalLink_monitoring-and-managing-applications_activities">Activities</h2>

<p>The Activity tab allows us to drill down into the tasks each entity is currently executing or has recently completed. It is possible to drill down through all child tasks, and view the commands issued, along with any errors or warnings that occurred.</p>

<p>For example clicking on the NginxController in the left hand tree and opening its Activity tab you can observe the ‘start’ task is ‘In progress’.</p>

<p><strong>Note</strong>: You may observe different tasks depending on how far your deployment has progressed).</p>

<p><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/gui/images/my-db-activities-step1-large.png"><img src="./v/latest/ops/gui/images/my-db-activities-step1.png" alt="My DB Activities Step 1." /></a></p>

<p>Clicking on the ‘start’ task you can discover more details on the actions being carried out by that task (a task may consist of additional subtasks).</p>

<p><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/gui/images/my-db-activities-step2-large.png"><img src="./v/latest/ops/gui/images/my-db-activities-step2.png" alt="My DB Activities Step 2." /></a></p>

<p>Continuing to drill down into the ‘In progress’ tasks you will eventually reach the currently active task where you can investigate the ssh command executed on the target node including the current stdin, stdout and stderr output.</p>

<p><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/gui/images/my-db-activities-step3-large.png"><img src="./v/latest/ops/gui/images/my-db-activities-step3.png" alt="My DB Activities Step 3." /></a></p>

<h2 id="internalLink_monitoring-and-managing-applications_sensors">Sensors</h2>

<p>Now click on the “Sensors” tab:
these data feeds drive the real-time picture of the application.
As you navigate in the tree at the left, you can see more targeted statistics coming in in real-time.</p>

<p>Explore the sensors and the tree to find the URL where the <em>NginxController</em> for the webapp we just deployed is running. This can be found in ‘<strong>My Web Cluster</strong> -&gt; <strong>My Web</strong> -&gt; <strong>NginxController</strong> -&gt; <strong><em>main.uri</em></strong>’.</p>

<p>Quickly return to the <strong>‘Brooklyn JS REST client’</strong> web browser
tab showing the “Sensors” and observe the ‘<strong>My Web Cluster</strong> -&gt; <strong>My Web</strong> -&gt; <strong>Cluster of TomcatServer</strong> -&gt; <strong><em>webapp.reqs.perSec.last</em></strong>’ sensor value increase.  </p>

<h2 id="internalLink_monitoring-and-managing-applications_stopping-the-application">Stopping the Application</h2>

<p>To stop an application, select the application in the tree view (the top/root entity), click on the Effectors tab, and invoke the “Stop” effector. This will cleanly shutdown all components in the application and return any cloud machines that were being used.</p>

<p><a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/gui/images/my-web-cluster-stop-confirm-large.png"><img src="./v/latest/ops/gui/images/my-web-cluster-stop-confirm.png" alt="My DB Activities." /></a></p>

<h2 id="internalLink_monitoring-and-managing-applications_next">Next</h2>

<p>Brooklyn’s real power is in using <strong><a href="#contentsLink-using-policies">Policies</a></strong>  to automatically <em>manage</em> applications. </p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-using-policies" class="section-breaker section p-">
	<span style="width: 100%"><h1>Using Policies</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_using-policies_exploring-and-testing-policies">Exploring and Testing Policies</h2>

<p>To see an example of policy based management, please deploy the following blueprint (changing 
the location details as for the example shown earlier):</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">My Web Cluster</span>

<span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>

<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>

<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.ControlledDynamicWebAppCluster</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">My Web</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">wars.root</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=org/apache/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.8.0-incubating/brooklyn-example-hello-world-sql-webapp-0.8.0-incubating.war</span>
    <span class="l-Scalar-Plain">java.sysprops</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">brooklyn.example.db.url</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
        <span class="no">$brooklyn:formatString(&quot;jdbc:%s%s?user=%s&amp;password=%s&quot;,</span>
        <span class="no">component(&quot;db&quot;).attributeWhenReady(&quot;datastore.url&quot;),</span>
        <span class="no">&quot;visitors&quot;, &quot;brooklyn&quot;, &quot;br00k11n&quot;)</span>
  <span class="l-Scalar-Plain">brooklyn.policies</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.policy.autoscaling.AutoScalerPolicy</span>
    <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">metric</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">webapp.reqs.perSec.windowed.perNode</span>
      <span class="l-Scalar-Plain">metricLowerBound</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0.1</span>
      <span class="l-Scalar-Plain">metricUpperBound</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>
      <span class="l-Scalar-Plain">minPoolSize</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
      <span class="l-Scalar-Plain">maxPoolSize</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4</span>
      <span class="l-Scalar-Plain">resizeUpStabilizationDelay</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10s</span>
      <span class="l-Scalar-Plain">resizeDownStabilizationDelay</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1m</span>

<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.database.mysql.MySqlNode</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">db</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">My DB</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">creationScriptUrl</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://bit.ly/brooklyn-visitors-creation-script</span></code></pre></div>

<p>The app server cluster has an <code>AutoScalerPolicy</code>, and the loadbalancer has a <code>targets</code> policy.</p>

<p>Use the Applications tab in the web console to drill down into the Policies section of the ControlledDynamicWebAppCluster. You will see that the <code>AutoScalerPolicy</code> is running.</p>

<p>This policy automatically scales the cluster up or down to be the right size for the cluster’s current load. One server is the minimum size allowed by the policy.</p>

<p>The loadbalancer’s <code>targets</code> policy ensures that the loadbalancer is updated as the cluster size changes.</p>

<p>Sitting idle, this cluster will only contain one server, but you can use a tool like <a href="http://jmeter.apache.org/">jmeter</a> pointed at the nginx endpoint to create load on the cluster. Download a jmeter test plan <a href="https://github.com/apache/brooklyn-library/blob/master/examples/simple-web-cluster/resources/jmeter-test-plan.jmx">here</a>.</p>

<p>As load is added, Apache Brooklyn requests a new cloud machine, creates a new app server, and adds it to the cluster. As load is removed, servers are removed from the cluster, and the infrastructure is handed back to the cloud.</p>

<h2 id="internalLink_using-policies_under-the-covers">Under the Covers</h2>

<p>The <code>AutoScalerPolicy</code> here is configured to respond to the sensor
reporting requests per second per node, invoking the default <code>resize</code> effector.
By clicking on the policy, you can configure it to respond to a much lower threshhold
or set long stabilization delays (the period before it scales out or back).</p>

<p>An even simpler test is to manually suspend the policy, by clicking “Suspend” in the policies list.
You can then switch to the “Effectors” tab and manually trigger a <code>resize</code>.
On resize, new nodes are created and configured, 
and in this case a policy on the nginx node reconfigures nginx whenever the set of active
targets changes.</p>

<h2 id="internalLink_using-policies_next">Next</h2>

<p>This guide has given a quick overview of using the Apache Brooklyn GUI to deploy, monitor and manage applications. The GUI also allows you to perform various Advanced management tasks and to explore and use the REST API (from the Script tab).  Please take some time now to become more familiar with the GUI.</p>

<p>Then continue to read through the <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/gui/../index.html">Operations Guide</a>.</p>


	</div>
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-rest-api" class="section-breaker section p-">
	<span style="width: 100%"><h1>REST API</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Apache Brooklyn exposes a powerful REST API, 
allowing it to be scripted from bash or integrated with other systems.</p>

<p>For many commands, the REST call follows the same structure as the web console URL
scheme, but with the <code>#</code> at the start of the path removed; for instance the catalog
item <code>cluster</code> in the web console is displayed at:</p>

<!-- BROOKLYN_VERSION_BELOW -->
<pre><code>http://localhost:8081/#v1/catalog/entities/cluster:0.12.0-SNAPSHOT
</code></pre>

<p>And in the REST API it is accessed at:</p>

<!-- BROOKLYN_VERSION_BELOW -->
<pre><code>http://localhost:8081/v1/catalog/entities/cluster:0.12.0-SNAPSHOT
</code></pre>

<p>A full reference for the REST API is automatically generated by the server at runtime.
It can be found in the Brooklyn web console, under the Script tab.</p>

<p>Here we include some of the most common REST examples and other advice for working with the REST API.</p>

<h3 id="internalLink_rest-api_tooling-tips">Tooling Tips</h3>

<p>For command-line access, we recommend <code>curl</code>, with tips below. </p>

<p>For navigating in a browser we recommend getting a plugin for 
working with REST; these are available for most browsers and
make it easier to authenticate, set headers, and see JSON responses.</p>

<p>For manipulating JSON responses on the command-line,
the library <code>jq</code> from <a href="https://stedolan.github.io/jq/">stedolan’s github</a>
is very useful, and available in most package repositories, including <code>port</code> and <code>brew</code> on Mac.</p>

<h3 id="internalLink_rest-api_common-rest-examples">Common REST Examples</h3>

<p>Here are some useful snippets:</p>

<ul>
  <li>
    <p>List applications</p>

    <pre><code>curl http://localhost:8081/v1/applications
</code></pre>
  </li>
  <li>
    <p>Deploy an application from <code>__FILE__</code></p>

    <pre><code>curl http://localhost:8081/v1/applications --data-binary @__FILE__
</code></pre>
  </li>
  <li>
    <p>Get details of a task with ID <code>__ID__</code> (where the <code>id</code> is returned by the above,
optionally piped to <code>jq .id</code>)</p>

    <pre><code>curl http://localhost:8081/v1/activities/__ID__
</code></pre>
  </li>
  <li>
    <p>Get the value of sensor <code>service.state</code> on entity <code>e1</code> in application <code>app1</code>
(note you can use either the entity’s ID or its name)</p>

    <pre><code>curl http://localhost:8081/v1/applications/app1/entities/e1/sensors/service.state
</code></pre>
  </li>
  <li>
    <p>Get all sensor values (using the pseudo-sensor <code>current-state</code>)</p>

    <pre><code>curl http://localhost:8081/v1/applications/app1/entities/e1/sensors/service.state
</code></pre>
  </li>
  <li>
    <p>Invoke an effector <code>eff</code> on <code>e1</code>, with argument <code>arg1</code> equal to <code>hi</code>
(note if no arguments, you must specify <code>-d ""</code>; for multiple args, just use multiple <code>-d</code> entries,
or a JSON file with <code>--data-binary @...</code>)</p>

    <pre><code>curl http://localhost:8081/v1/applications/app1/entities/e1/effectors/eff -d arg1=hi
</code></pre>
  </li>
  <li>
    <p>Add an item to the catalog from <code>__FILE__</code></p>

    <pre><code>curl http://localhost:8081/v1/catalog --data-binary @__FILE__
</code></pre>
  </li>
</ul>

<h3 id="internalLink_rest-api_curl-cheat-sheet">Curl Cheat Sheet</h3>

<ul>
  <li>if authentication is required, use <code>--user username:password</code></li>
  <li>to see detailed output, including headers, code, and errors, use <code>-v</code></li>
  <li>where the request is not a simple HTTP GET, use <code>-X POST</code> or <code>-X DELETE</code></li>
  <li>to pass key-value data to a post, use <code>-d key=value</code></li>
  <li>where you are posting from a file <code>__FILE__</code>, use <code>--data-binary @__FILE__</code> (implies a POST) or <code>-T __FILE__ -X POST</code></li>
  <li>to add a header, use <code>-H "key: value"</code>, for example <code>-H "Brooklyn-Allow-Non-Master-Access: true"</code></li>
  <li>to specify that a specific content-type is being uploaded, use <code>-H "Content-Type: application/json"</code> (or <code>application/yaml</code>)</li>
  <li>to specify the content-type required for the result, use <code>-H "Accept: application/json"</code> 
(or <code>application/yaml</code>, or for sensor values, <code>text/plain</code>)</li>
</ul>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-brooklyn.properties" class="section-breaker section p-">
	<span style="width: 100%"><h1>brooklyn.properties</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	
<p>The file <code>~/.brooklyn/brooklyn.properties</code> is read when Brooklyn starts
to load server configuration values.</p>

<p>A template <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/start/brooklyn.properties">brooklyn.properties</a> file is available,
with abundant comments.</p>

<h2 id="internalLink_brooklyn.properties_quick-setup">Quick Setup</h2>

<p>The most common properties set in this file are for access control. Without this, Brooklyn’s 
web-console and REST api will require no authentication.</p>

<p>The simplest way to specify users and passwords is shown below (but see the 
<a href="#internalLink_brooklyn.properties_authentication">Authentication</a> section for how to avoid storing passwords in plain text):</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.webconsole.security.users</span><span class="o">=</span><span class="s">admin,bob</span>
<span class="na">brooklyn.webconsole.security.user.admin.password</span><span class="o">=</span><span class="s">AdminPassw0rd</span>
<span class="na">brooklyn.webconsole.security.user.bob.password</span><span class="o">=</span><span class="s">BobPassw0rd</span></code></pre></div>

<p>The properties file <em>must</em> have permissions 600 
(i.e. readable and writable only by the file’s owner),
for some security.</p>

<p>In many cases, it is preferable instead to use an external credentials store such as LDAP.
Information on configuring these is <a href="#internalLink_brooklyn.properties_authentication">below</a>. </p>

<p>If coming over a network it is highly recommended additionally to use <code>https</code>.
This can be configured with:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.webconsole.security.https.required</span><span class="o">=</span><span class="s">true</span></code></pre></div>

<p>More information, including setting up a certificate, is described <a href="#internalLink_brooklyn.properties_https-configuration">further below</a>.</p>

<h2 id="internalLink_brooklyn.properties_camp-yaml-expressions">Camp YAML Expressions</h2>

<p>Values in <code>brooklyn.properties</code> can use the Camp YAML syntax. Any value starting <code>$brooklyn:</code> is 
parsed as a Camp YAML expression.</p>

<p>This allows <a href="#contentsLink-externalized-configuration">externalized configuration</a> to be used from 
brooklyn.properties. For example:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.location.jclouds.aws-ec2.identity</span><span class="o">=</span><span class="s">$brooklyn:external(&quot;vault&quot;, &quot;aws-identity&quot;)</span>
<span class="na">brooklyn.location.jclouds.aws-ec2.credential</span><span class="o">=</span><span class="s">$brooklyn:external(&quot;vault&quot;, &quot;aws-credential&quot;)</span></code></pre></div>

<p>If for some reason one requires a literal value that really does start with <code>$brooklyn:</code> (i.e.
for the value to not be parsed), then this can be achieved by using the syntax below. This 
example returns the property value <code>$brooklyn:myexample</code>:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">example.property</span><span class="o">=</span><span class="s">$brooklyn:literal(&quot;$brooklyn:myexample&quot;)</span></code></pre></div>

<h2 id="internalLink_brooklyn.properties_locations">Locations</h2>

<p>Information on defining locations in the <code>brooklyn.properties</code> file is available <a href="#contentsLink-locations">here</a>.</p>

<h2 id="internalLink_brooklyn.properties_java">Java</h2>

<p>Arbitrary data can be set in the <code>brooklyn.properties</code>.
This can be accessed in java using <code>ManagementContext.getConfig(KEY)</code>.</p>

<h2 id="internalLink_brooklyn.properties_authentication">Authentication</h2>

<p><strong>Security Providers</strong> are the mechanism by which different authentication authorities are plugged in to Brooklyn.
These can be configured by specifying <code>brooklyn.webconsole.security.provider</code> equal 
to the name of a class implementing <code>SecurityProvider</code>.
An implementation of this could point to Spring, LDAP, OpenID or another identity management system.</p>

<p>The default implementation, <code>ExplicitUsersSecurityProvider</code>, reads from a list of users and passwords
which should be specified as configuration parameters e.g. in <code>brooklyn.properties</code>.
This configuration could look like:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.webconsole.security.users</span><span class="o">=</span><span class="s">admin</span>
<span class="na">brooklyn.webconsole.security.user.admin.salt</span><span class="o">=</span><span class="s">OHDf</span>
<span class="na">brooklyn.webconsole.security.user.admin.sha256</span><span class="o">=</span><span class="s">91e16f94509fa8e3dd21c43d69cadfd7da6e7384051b18f168390fe378bb36f9</span></code></pre></div>

<p>The <code>users</code> line should contain a comma-separated list. The special value <code>*</code> is accepted to permit all users.</p>

<p>To generate this, the brooklyn CLI can be used:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">brooklyn generate-password --user admin

Enter password: 
Re-enter password: 

Please add the following to your brooklyn.properies:

brooklyn.webconsole.security.users<span class="o">=</span>admin
brooklyn.webconsole.security.user.admin.salt<span class="o">=</span>OHDf
brooklyn.webconsole.security.user.admin.sha256<span class="o">=</span>91e16f94509fa8e3dd21c43d69cadfd7da6e7384051b18f168390fe378bb36f9</code></pre></div>

<p>Alternatively, in dev/test environments where a lower level of security is required,
the syntax <code>brooklyn.webconsole.security.user.&lt;username&gt;=&lt;password&gt;</code> can be used for
each <code>&lt;username&gt;</code> specified in the <code>brooklyn.webconsole.security.users</code> list.</p>

<p>Other security providers available include:</p>

<h3 id="internalLink_brooklyn.properties_no-one">No one</h3>

<p><code>brooklyn.webconsole.security.provider=org.apache.brooklyn.rest.security.provider.BlackholeSecurityProvider</code>
will block all logins (e.g. if not using the web console)</p>

<h3 id="internalLink_brooklyn.properties_no-security">No security</h3>

<p><code>brooklyn.webconsole.security.provider=org.apache.brooklyn.rest.security.provider.AnyoneSecurityProvider</code>
will allow logins with no credentials (e.g. in secure dev/test environments) </p>

<h3 id="internalLink_brooklyn.properties_ldap">LDAP</h3>

<p><code>brooklyn.webconsole.security.provider=org.apache.brooklyn.rest.security.provider.LdapSecurityProvider</code>
will cause Brooklyn to call to an LDAP server to authenticate users;
The other things you need to set in <code>brooklyn.properties</code> are:</p>

<ul>
  <li><code>brooklyn.webconsole.security.ldap.url</code> - ldap connection url</li>
  <li><code>brooklyn.webconsole.security.ldap.realm</code> - ldap dc parameter (domain)</li>
  <li><code>brooklyn.webconsole.security.ldap.ou</code> <em>optional, by default it set to Users</em> -  ldap ou parameter</li>
</ul>

<p><strong>brooklyn.properties example configuration:</strong></p>

<p><code>
brooklyn.webconsole.security.provider=org.apache.brooklyn.rest.security.provider.LdapSecurityProvider
brooklyn.webconsole.security.ldap.url=ldap://localhost:10389/????X-BIND-USER=uid=admin%2cou=system,X-BIND-PASSWORD=secret,X-COUNT-LIMIT=1000
brooklyn.webconsole.security.ldap.realm=example.com
</code></p>

<p>After you setup the brooklyn connection to your LDAP server, you can authenticate in brooklyn using your cn (e.g. John Smith) and your password.
<code>org.apache.brooklyn.rest.security.provider.LdapSecurityProvider</code> searches in the LDAP tree in LDAP://cn=John Smith,ou=Users,dc=example,dc=com</p>

<p>If you want to customize the ldap path or something else which is particular to your LDAP setup you
can extend <code>LdapSecurityProvider</code> class or implement from scratch the <code>SecurityProvider</code> interface.</p>

<h2 id="internalLink_brooklyn.properties_entitlements">Entitlements</h2>

<p>In addition to login access, fine-grained permissions – including 
seeing entities, creating applications, seeing sensors, and invoking effectors –
can be defined on a per-user <em>and</em> per-target (e.g. which entity/effector) basis
using a plug-in <strong>Entitlement Manager</strong>.</p>

<p>This can be set globally with the property:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.entitlements.global</span><span class="o">=</span><span class="s">&lt;class&gt;</span></code></pre></div>

<p>The default entitlement manager is one which responds to per-user entitlement rules,
and understands:</p>

<ul>
  <li><code>root</code>:  full access, including to the Groovy console</li>
  <li><code>user</code>:  access to everything but actions that affect the server itself. Such actions include the
Groovy console, stopping the server and retrieving management context configuration.</li>
  <li><code>readonly</code>:  read-only access to almost all information</li>
  <li><code>minimal</code>:  access only to server stats, for use by monitoring systems</li>
</ul>

<p>These keywords are also understood at the <code>global</code> level, so to grant full access to <code>admin</code>,
read-only access to <code>support</code>, limited access to <code>metrics</code> and regular access to <code>user</code>
you can write:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.entitlements.global</span><span class="o">=</span><span class="s">user</span>
<span class="na">brooklyn.entitlements.perUser.admin</span><span class="o">=</span><span class="s">root</span>
<span class="na">brooklyn.entitlements.perUser.support</span><span class="o">=</span><span class="s">readonly</span>
<span class="na">brooklyn.entitlements.perUser.metrics</span><span class="o">=</span><span class="s">minimal</span></code></pre></div>

<p>Under the covers this invokes the <code>PerUserEntitlementManager</code>, 
with a <code>default</code> set (and if not specified <code>default</code> defaults to <code>minimal</code>); 
so the above can equivalently be written:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.entitlements.global</span><span class="o">=</span><span class="s">org.apache.brooklyn.core.mgmt.entitlement.PerUserEntitlementManager</span>
<span class="na">brooklyn.entitlements.perUser.default</span><span class="o">=</span><span class="s">user</span>
<span class="na">brooklyn.entitlements.perUser.admin</span><span class="o">=</span><span class="s">root</span>
<span class="na">brooklyn.entitlements.perUser.support</span><span class="o">=</span><span class="s">readonly</span>
<span class="na">brooklyn.entitlements.perUser.metrics</span><span class="o">=</span><span class="s">minimal</span></code></pre></div>

<p>For more information, see 
<a href="#contentsLink-entitlements">Java: Entitlements</a>.
or
<code>EntitlementManager</code>
  (<a href="https://github.com/apache/brooklyn-server/tree/master/api/src/main/java/org/apache/brooklyn/api/mgmt/entitlement/EntitlementManager.java">src</a>)
.</p>

<h2 id="internalLink_brooklyn.properties_https-configuration">HTTPS Configuration</h2>

<p>See <a href="https.html">HTTPS Configuration</a> for general information on configuring HTTPS.</p>

<p>To enable HTTPS in Brooklyn, add the following to your brooklyn.properties:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.webconsole.security.https.required</span><span class="o">=</span><span class="s">true</span>
<span class="na">brooklyn.webconsole.security.keystore.url</span><span class="o">=</span><span class="s">&lt;path-to-keystore-directory&gt;/server.key</span>
<span class="na">brooklyn.webconsole.security.keystore.password</span><span class="o">=</span><span class="s">mypassword</span>
<span class="na">brooklyn.webconsole.security.keystore.certificate.alias</span><span class="o">=</span><span class="s">brooklyn</span></code></pre></div>


	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-persistence" class="section-breaker section p-">
	<span style="width: 100%"><h1>Persistence</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Brooklyn can be configured to persist its state so that the Brooklyn server can be restarted, 
or so that a high availability standby server can take over.</p>

<p>Brooklyn can persist its state to one of two places: the file system, or to an Object Store
of your choice.</p>

<h2 id="internalLink_persistence_command-line-options">Command Line Options</h2>

<p>To configure brooklyn, the relevant command line options for the <code>launch</code> commands are:</p>

<ul>
  <li><code>--persist</code> <persistence mode="">
The persistence mode.</persistence></li>
  <li><code>--persistenceDir</code> <persistence dir="">
The directory to read/write persisted state (or container name if using an object store).</persistence></li>
  <li><code>--persistenceLocation</code> <persistence location="">
The location spec for an object store to read/write persisted state.</persistence></li>
</ul>

<p>For the persistence mode, the possible values are:</p>

<ul>
  <li><code>disabled</code> means that no state will be persisted or read; when Brooklyn stops all state is lost.</li>
  <li><code>rebind</code> means that it will read existing state, and recreate entities, locations and policies 
from that. If there is no existing state, startup will fail.</li>
  <li><code>clean</code> means that any existing state will be deleted, and Brooklyn will be started afresh.</li>
  <li><code>auto</code> means Brooklyn will rebind if there is any existing state, or will start afresh if 
there is no state.</li>
</ul>

<p>The persistence directory and location can instead be specified from <code>brooklyn.properties</code> using
the following config keys:</p>

<ul>
  <li><code>brooklyn.persistence.dir</code></li>
  <li><code>brooklyn.persistence.location.spec</code></li>
</ul>

<h2 id="internalLink_persistence_file-based-persistence">File-based Persistence</h2>

<p>To persist to the file system, start brooklyn with:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">brooklyn launch --persist auto --persistenceDir /path/to/myPersistenceDir</code></pre></div>

<p>If there is already data at <code>/path/to/myPersistenceDir</code>, then a backup of the directory will 
be made. This will have a name like <code>/path/to/myPersistenceDir.20140701-142101345.bak</code>.</p>

<p>The state is written to the given path. The file structure under that path is:</p>

<ul>
  <li><code>./entities/</code></li>
  <li><code>./locations/</code></li>
  <li><code>./policies/</code></li>
  <li><code>./enrichers/</code></li>
</ul>

<p>In each of those directories, an XML file will be created per item - for example a file per
entity in <code>./entities/</code>. This file will capture all of the state - for example, an
entity’s: id; display name; type; config; attributes; tags; relationships to locations, child 
entities, group membership, policies and enrichers; and dynamically added effectors and sensors.</p>

<p>If using the default persistence dir (i.e. no <code>--persistenceDir</code> was specified), then Brooklyn will
write its state to <code>~/.brooklyn/brooklyn-persisted-state/data</code>. Copies of this directory
will be automatically created in <code>~/.brooklyn/brooklyn-persisted-state/backups/</code> each time Brooklyn 
is restarted (or if a standby Brooklyn instances takes over as master).</p>

<p>A custom directory for Brooklyn state can also be configured in <code>brooklyn.properties</code> using:</p>

<pre><code># For all Brooklyn files
brooklyn.base.dir=/path/to/base/dir

# Sub-directory of base.dir for writing persisted state (if relative). If directory
# starts with "/" (or "~/", or something like "c:\") then assumed to be absolute. 
brooklyn.persistence.dir=data

# Sub-directory of base.dir for creating backup directories (if relative). If directory
# starts with "/" (or "~/", or something like "c:\") then assumed to be absolute. 
brooklyn.persistence.backups.dir=backups
</code></pre>

<p>This <code>base.dir</code> will also include temporary files such as the OSGi cache.</p>

<p>If <code>persistence.dir</code> is not specified then it will use the sub-directory
<code>brooklyn-persisted-state/data</code> of the <code>base.dir</code>. If the <code>backups.dir</code> is not specified
the backup directories will be created in the sub-directory <code>backups</code> of the persistence dir.</p>

<h2 id="internalLink_persistence_object-store-persistence">Object Store Persistence</h2>

<p>Brooklyn can persist its state to any Object Store API that jclouds supports including 
S3, Swift and Azure. This gives access to any compatible Object Store product or cloud provider
including AWS-S3, SoftLayer, Rackspace and Microsoft Azure. For a complete list of supported
providers, see <a href="http://jclouds.apache.org/reference/providers/#blobstore">jclouds</a>.</p>

<p>To configure the Object Store, add the credentials to <code>~/.brooklyn/brooklyn.properties</code> such as:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.location.named.aws-s3-eu-west-1</span><span class="o">=</span><span class="s">aws-s3:eu-west-1</span>
<span class="na">brooklyn.location.named.aws-s3-eu-west-1.identity</span><span class="o">=</span><span class="s">ABCDEFGHIJKLMNOPQRSTU</span>
<span class="na">brooklyn.location.named.aws-s3-eu-west-1.credential</span><span class="o">=</span><span class="s">abcdefghijklmnopqrstuvwxyz1234567890ab/c</span></code></pre></div>

<p>or:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.location.named.softlayer-swift-ams01</span><span class="o">=</span><span class="s">jclouds:openstack-swift:https://ams01.objectstorage.softlayer.net/auth/v1.0</span>
<span class="na">brooklyn.location.named.softlayer-swift-ams01.identity</span><span class="o">=</span><span class="s">ABCDEFGHIJKLM:myname</span>
<span class="na">brooklyn.location.named.softlayer-swift-ams01.credential</span><span class="o">=</span><span class="s">abcdefghijklmnopqrstuvwxyz1234567890abcdefghijklmnopqrstuvwxyz12</span>
<span class="na">brooklyn.location.named.softlayer-swift-ams01.jclouds.keystone.credential-type</span><span class="o">=</span><span class="s">tempAuthCredentials</span></code></pre></div>

<p>Start Brooklyn pointing at this target object store, e.g.:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">nohup brooklyn launch --persist auto --persistenceDir myContainerName --persistenceLocation named:softlayer-swift-ams01 <span class="p">&amp;</span></code></pre></div>

<p>The following <code>brooklyn.properties</code> options can also be used:</p>

<pre><code># Location spec string for an object store (e.g. jclouds:openstack-swift:URL) where persisted state 
# should be kept; if blank or not supplied, the file system is used.
brooklyn.persistence.location.spec=&lt;location&gt;

# Container name for writing persisted state
brooklyn.persistence.dir=/path/to/dataContainer

# Location spec string for an object store (e.g. jclouds:openstack-swift:URL) where backups of  
# persisted state should be kept; defaults to the local file system.
brooklyn.persistence.backups.location.spec=&lt;location&gt;

# Container name for writing backups of persisted state;
# defaults to 'backups' inside the default persistence container.
brooklyn.persistence.backups.dir=/path/to/backupContainer
</code></pre>

<h2 id="internalLink_persistence_rebinding-to-state">Rebinding to State</h2>

<p>When Brooklyn starts up pointing at existing state, it will recreate the entities, locations 
and policies based on that persisted state.</p>

<p>Once all have been created, Brooklyn will “manage” the entities. This will bind to the 
underlying entities under management to update the each entity’s sensors (e.g. to poll over 
HTTP or JMX). This new state will be reported in the web-console and can also trigger 
any registered policies.</p>

<h2 id="internalLink_persistence_cli-commands-for-copying-state">CLI Commands for Copying State</h2>

<p>Brooklyn includes a command to copy persistence state easily between two locations.
The <code>copy-state</code> CLI command takes the following arguments:</p>

<ul>
  <li><code>--persistenceDir</code> <source persistence="" dir="" />
The directory to read persisted state (or container name if using an object store).</li>
  <li><code>--persistenceLocation</code> <source persistence="" location="" />
The location spec for an object store to read persisted state.</li>
  <li><code>--destinationDir</code> <target persistence="" dir="">
The directory to copy persistence data to (or container name if using an object store).</target></li>
  <li><code>--destinationLocation</code> <target persistence="" location="">
The location spec for an object store to copy data to.</target></li>
  <li><code>--transformations</code> <transformations>
The local transformations file to be applied to the copy of the data before uploading it.</transformations></li>
</ul>

<h2 id="internalLink_persistence_cli-commands-for-cleaning-orphaned-state">CLI Commands for Cleaning Orphaned State</h2>

<p>Brooklyn includes a command to clean orphaned state which uses the copy state command
and removes orphaned locations, enrichers, policies and feeds from the copied state.
The <code>clean-orphaned-state</code> CLI command takes the following arguments:</p>

<ul>
  <li><code>--persistenceDir</code> <source persistence="" dir="" />
The directory to read persisted state (or container name if using an object store).</li>
  <li><code>--persistenceLocation</code> <source persistence="" location="" />
The location spec for an object store to read persisted state.</li>
  <li><code>--destinationDir</code> <target persistence="" dir="">
The directory to copy persistence data to, with orphaned state removed.</target></li>
  <li><code>--destinationLocation</code> <target persistence="" location="">
The location spec for an object store to copy data to.</target></li>
</ul>

<h2 id="internalLink_persistence_handling-rebind-failures">Handling Rebind Failures</h2>

<p>If rebind fails fail for any reason, details of the underlying failures will be reported 
in the <code>brooklyn.debug.log</code>. There are several approaches to resolving problems.</p>

<h3 id="internalLink_persistence_determine-underlying-cause">Determine Underlying Cause</h3>

<p>The problems reported in brooklyn.debug.log will indicate where the problem lies - which 
entities, locations or policies, and in what way it failed.</p>

<h3 id="internalLink_persistence_ignore-errors">Ignore Errors</h3>

<p>The <code>~/.brooklyn/brooklyn.properties</code> has several configuration options:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">rebind.failureMode.danglingRef</span><span class="o">=</span><span class="s">continue</span>
<span class="na">rebind.failureMode.loadPolicy</span><span class="o">=</span><span class="s">continue</span>
<span class="na">rebind.failureMode.addPolicy</span><span class="o">=</span><span class="s">continue</span>
<span class="na">rebind.failureMode.rebind</span><span class="o">=</span><span class="s">fail_at_end</span>
<span class="na">rebind.failureMode.addConfig</span><span class="o">=</span><span class="s">fail_at_end</span></code></pre></div>

<p>For each of these configuration options, the possible values are:</p>

<ul>
  <li><code>fail_fast</code>: stop rebind immediately upon errors; do not try to rebind other entities</li>
  <li><code>fail_at_end</code>: continue rebinding all entities, but then fail so that all errors 
encountered are reported</li>
  <li><code>continue</code>: log a warning, but ignore the error to continue rebinding. Depending on the 
type of error, this can cause serious problems later (e.g. if the state of an entity
was entirely missing, then all its children would be orphaned).</li>
</ul>

<p>The meaning of the configuration options is:</p>

<ul>
  <li><code>rebind.failureMode.dangingRef</code>: if there is a reference to an entity, location or policy 
that is missing… whether to continue (discarding the reference) or fail.</li>
  <li><code>rebind.failureMode.loadPolicy</code>: if there is an error instantiate or reconstituting the 
state of a policy or enricher… whether to continue (discarding the policy or enricher) 
or fail.</li>
  <li><code>rebind.failureMode.addPolicy</code>: if there is an error re-adding the policy or enricher to
its associated entity… whether to continue (discarding the policy or enricher) 
or fail.</li>
  <li><code>rebind.failureMode.addConfig</code>: if there is invalid config value, or some other error occurs when adding a config.</li>
  <li><code>rebind.failureMode.rebind</code>: any errors on rebind not covered by the more specific error cases described above.</li>
</ul>

<h3 id="internalLink_persistence_seek-help">Seek Help</h3>

<p>Help can be found at <code>dev@brooklyn.apache.org</code>, where folk will be able to investigate 
issues and suggest work-arounds.</p>

<p>By sharing the persisted state (with credentials removed), Brooklyn developers will be able to 
reproduce and debug the problem.</p>

<h3 id="internalLink_persistence_fix-up-the-state">Fix-up the State</h3>

<p>The state of each entity, location, policy and enricher is persisted in XML. 
It is thus human readable and editable.</p>

<p>After first taking a backup of the state, it is possible to modify the state. For example,
an offending entity could be removed, or references to that entity removed, or its XML 
could be fixed to remove the problem.</p>

<h3 id="internalLink_persistence_fixing-with-groovy-scripts">Fixing with Groovy Scripts</h3>

<p>The final (powerful and dangerous!) tool is to execute Groovy code on the running Brooklyn 
instance. If authorized, the REST api allows arbitrary Groovy scripts to be passed in and 
executed. This allows the state of entities to be modified (and thus fixed) at runtime.</p>

<p>If used, it is strongly recommended that Groovy scripts are run against a disconnected Brooklyn
instance. After fixing the entities, locations and/or policies, the Brooklyn instance’s 
new persisted state can be copied and used to fix the production instance.</p>

<h2 id="internalLink_persistence_writing-persistable-code">Writing Persistable Code</h2>
<p>The most common problem on rebind is that custom entity code has not been written in a way
that can be persisted and/or rebound.</p>

<p>The rule of thumb when implementing new entities, locations, policies and enrichers is that 
all state must be persistable. All state must be stored as config or as attributes, and must be
serializable. For making backwards compatibility simpler, the persisted state should be clean.</p>

<p>Below are tips and best practices for when implementing an entity in Java (or any other 
JVM language).</p>

<p>How to store entity state:</p>

<ul>
  <li>Config keys and values are persisted.</li>
  <li>Store an entity’s runtime state as attributes.</li>
  <li>Don’t store state in arbitrary fields - the field will not be persisted (this is a design
decision, because Brooklyn cannot intercept the field being written to, so cannot know
when to persist).</li>
  <li>Don’t just modify the retrieved attribute value (e.g. <code>getAttribute(MY_LIST).add("a")</code> is bad).
The value may not be persisted unless setAttribute() is called.</li>
  <li>For special cases, it is possible to call <code>entity.requestPerist()</code> which will trigger
asynchronous persistence of the entity.</li>
  <li>Overriding (and customizing) of <code>getRebindSupport()</code> is discouraged - this will change
in a future version.</li>
</ul>

<p>How to store policy/enricher/location state:</p>

<ul>
  <li>Store values as config keys where applicable.</li>
  <li>Unfortunately these (currently) do not have attributes. Normally the state of a policy 
or enricher is transient - on rebind it starts afresh, for example with monitoring the 
performance or health metrics rather than relying on the persisted values.</li>
  <li>For special cases, you can annotate a field with <code>@SetFromFlag</code> for it be persisted. 
When you call <code>requestPersist()</code> then values of these fields will be scheduled to be 
persisted. <em>Warning: the <code>@SetFromFlag</code> functionality may change in future versions.</em></li>
</ul>

<p>Persistable state:</p>

<ul>
  <li>Ensure values can be serialized. This (currently) uses xstream, which means it does not
need to implement <code>Serializable</code>.</li>
  <li>Always use static (or top-level) classes. Otherwise it will try to also persist the outer 
instance!</li>
  <li>Any reference to an entity or location will be automatically swapped out for marker, and 
re-injected with the new entity/location instance on rebind. The same applies for policies,
enrichers, feeds, catalog items and <code>ManagementContext</code>.</li>
</ul>

<p>Behaviour on rebind:</p>

<ul>
  <li>By extending <code>SoftwareProcess</code>, entities get a lot of the rebind logic for free. For 
example, the default <code>rebind()</code> method will call <code>connectSensors()</code>.
See <a href="#contentsLink-custom-entity-development"><code>SoftwareProcess</code> Lifecycle</a>
for more details.</li>
  <li>If necessary, implement rebind. The <code>entity.rebind()</code> is called automatically by the
Brooklyn framework on rebind, after configuring the entity’s config/attributes but before 
the entity is managed.
Note that <code>init()</code> will not be called on rebind.</li>
  <li>Feeds will be persisted if and only if <code>entity.addFeed(...)</code> was called. Otherwise the
feed needs to be re-registered on rebind. <em>Warning: this behaviour may change in future version.</em></li>
  <li>All functions/predicates used with persisted feeds must themselves be persistable - 
use of anonymous inner classes is strongly discouraged.</li>
  <li>Subscriptions (e.g. from calls to <code>subscribe(...)</code> for sensor events) are not persisted.
They must be re-registered on rebind.  <em>Warning: this behaviour may change in future version.</em></li>
</ul>

<p>Below are tips to make backwards-compatibility easier for persisted state: </p>

<ul>
  <li>Never use anonymous inner classes - even in static contexts. The auto-generated class names 
are brittle, making backwards compatibility harder.</li>
  <li>Always use sensible field names (and use <code>transient</code> whenever you don’t want it persisted).
The field names are part of the persisted state.</li>
  <li>Consider using Value Objects for persisted values. This can give clearer separation of 
responsibilities in your code, and clearer control of what fields are being persisted.</li>
  <li>Consider writing transformers to handle backwards-incompatible code changes.
Brooklyn supports applying transformations to the persisted state, which can be done as 
part of an upgrade process.</li>
</ul>

<h2 id="internalLink_persistence_persisted-state-backup">Persisted State Backup</h2>

<h3 id="internalLink_persistence_file-system-backup">File system backup</h3>

<p>When using the file system it is important to ensure it is backed up regularly.</p>

<p>One could use <code>rsync</code> to regularly backup the contents to another server.</p>

<p>It is also recommended to periodically create a complete archive of the state.
A simple mechanism is to run a CRON job periodically (e.g. every 30 minutes) that creates an
archive of the persistence directory, and uploads that to a backup 
facility (e.g. to S3).</p>

<p>Optionally, to avoid excessive load on the Brooklyn server, the archive-generation could be done 
on another “data” server. This could get a copy of the data via an <code>rsync</code> job.</p>

<p>An example script to be invoked by CRON is shown below:</p>

<pre><code>DATE=`date "+%Y%m%d.%H%M.%S"`
BACKUP_FILENAME=/path/to/archives/back-${DATE}.tar.gz
DATA_DIR=/path/to/base/dir/data

tar --exclude '*/backups/*' -czvf $BACKUP_FILENAME $DATA_DIR
# For s3cmd installation see http://s3tools.org/repositories
s3cmd put $BACKUP_FILENAME s3://mybackupbucket
rm $BACKUP_FILENAME
</code></pre>

<h3 id="internalLink_persistence_object-store-backup">Object store backup</h3>

<p>Object Stores will normally handle replication. However, many such object stores do not handle 
versioning (i.e. to allow access to an old version, if an object has been incorrectly changed or 
deleted).</p>

<p>The state can be downloaded periodically from the object store, archived and backed up. </p>

<p>An example script to be invoked by CRON is shown below:</p>

<pre><code>DATE=`date "+%Y%m%d.%H%M.%S"`
BACKUP_FILENAME=/path/to/archives/back-${DATE}.tar.gz
TEMP_DATA_DIR=/path/to/tempdir

brooklyn copy-state \
        --persistenceLocation named:my-persistence-location \
        --persistenceDir /path/to/bucket \
        --destinationDir $TEMP_DATA_DIR

tar --exclude '*/backups/*' -czvf $BACKUP_FILENAME $TEMP_DATA_DIR
# For s3cmd installation see http://s3tools.org/repositories
s3cmd put $BACKUP_FILENAME s3://mybackupbucket
rm $BACKUP_FILENAME
rm -r $TEMP_DATA_DIR
</code></pre>

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-high-availability" class="section-breaker section p-">
	<span style="width: 100%"><h1>High Availability</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Brooklyn will automatically run in HA mode if multiple Brooklyn instances are started
pointing at the same persistence store.  One Brooklyn node (e.g. the first one started)
is elected as HA master:  all <em>write operations</em> against Brooklyn entities, such as creating
an application or invoking an effector, should be directed to the master.</p>

<p>Once one node is running as <code>MASTER</code>, other nodes start in either <code>STANDBY</code> or <code>HOT_STANDBY</code> mode:</p>

<ul>
  <li>
    <p>In <code>STANDBY</code> mode, a Brooklyn instance will monitor the master and will be a candidate
to become <code>MASTER</code> should the master fail. Standby nodes do <em>not</em> attempt to rebind
until they are elected master, so the state of existing entities is not available at
the standby node.  However a standby server consumes very little resource until it is
promoted.</p>
  </li>
  <li>
    <p>In <code>HOT_STANDBY</code> mode, a Brooklyn instance will read and make available the live state of
entities.  Thus a hot-standby node is available as a read-only copy.
As with the standby node, if a hot-standby node detects that the master fails,
it will be a candidate for promotion to master.</p>
  </li>
  <li>
    <p>In <code>HOT_BACKUP</code> mode, a Brooklyn instance will read and make available the live state of
entities, as a read-only copy. However this node is not able to become master,
so it can safely be used to test compatibility across different versions.</p>
  </li>
</ul>

<p>To explicitly specify what HA mode a node should be in, the following CLI options are available
for the parameter <code>--highAvailability</code>:</p>

<ul>
  <li><code>disabled</code>: management node works in isolation; it will not cooperate with any other standby/master nodes in management plane</li>
  <li><code>auto</code>: will look for other management nodes, and will allocate itself as standby or master based on other nodes’ states</li>
  <li><code>master</code>: will startup as master; if there is already a master then fails immediately</li>
  <li><code>standby</code>: will start up as lukewarm standby; if there is not already a master then fails immediately</li>
  <li><code>hot_standby</code>: will start up as hot standby; if there is not already a master then fails immediately</li>
  <li><code>hot_backup</code>: will start up as hot backup; this can be done even if there is not already a master; this node will not be a master </li>
</ul>

<p>The REST API offers live detection and control of the HA mode,
including setting priority to control which nodes will be promoted on master failure:</p>

<ul>
  <li><code>/server/ha/state</code>: Returns the HA state of a management node (GET),
or changes the state (POST)</li>
  <li><code>/server/ha/states</code>: Returns the HA states and detail for all nodes in a management plane</li>
  <li><code>/server/ha/priority</code>: Returns the HA node priority for MASTER failover (GET),
or sets that priority (POST)</li>
</ul>

<p>Note that when POSTing to a non-master server it is necessary to pass a <code>Brooklyn-Allow-Non-Master-Access: true</code> header.
For example, the following cURL command could be used to change the state of a <code>STANDBY</code> node on <code>localhost:8082</code> to <code>HOT_STANDBY</code>:</p>

<pre><code>curl -v -X POST -d mode=HOT_STANDBY -H "Brooklyn-Allow-Non-Master-Access: true" http://localhost:8082/v1/server/ha/state
</code></pre>


	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-high-availability-(supplemental)" class="section-breaker section p-">
	<span style="width: 100%"><h1>High Availability (Supplemental)</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>This document supplements the <a href="#contentsLink-high-availability">High Availability</a> documentation
and provides an example of how to configure a pair of Apache Brooklyn servers to run in master-standby mode with a shared NFS datastore</p>

<h3 id="internalLink_high-availability-(supplemental)_prerequisites">Prerequisites</h3>
<ul>
  <li>Two VMs (or physical machines) have been provisioned</li>
  <li>NFS or another suitable file system has been configured and is available to both VMs*</li>
  <li>An NFS folder has been mounted on both VMs at <code>/mnt/brooklyn-persistence</code> and both machines can write to the folder</li>
</ul>

<p>* Brooklyn can be configured to use either an object store such as S3, or a shared NFS mount. The recommended option is to use an object
store as described in the <a href="#contentsLink-persistence">Object Store Persistence</a> documentation. For simplicity, a shared NFS folder
is assumed in this example</p>

<h3 id="internalLink_high-availability-(supplemental)_launching">Launching</h3>
<p>To start, download and install the latest Apache Brooklyn release on both VMs following the instructions in
<a href="http://brooklyn.apache.org/v/0.10.0/v/latest/start/running.html">Running Apache Brooklyn</a></p>

<p>On the first VM, which will be the master node, run the following to start Brooklyn in high availability mode:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>bin/brooklyn launch --highAvailability master --https --persist auto --persistenceDir /mnt/brooklyn-persistence</code></pre></div>

<p>If you are using RPMs/deb to install, please see the <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/start/running.html">Running Apache Brooklyn</a>
documentation for the appropriate launch commands</p>

<p>Once Brooklyn has launched, on the second VM, run the following command to launch Brooklyn in standby mode:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>bin/brooklyn launch --highAvailability auto --https --persist auto --persistenceDir /mnt/brooklyn-persistence</code></pre></div>

<h3 id="internalLink_high-availability-(supplemental)_failover">Failover</h3>
<p>When running as a HA standby node, each standby Brooklyn server (in this case there is only one standby) will check the shared persisted state
every one second to determine the state of the HA master. If no heartbeat has been recorded for 30 seconds, then an election will be performed
and one of the standby nodes will be promoted to master. At this point all requests should be directed to the new master node.
If the master is terminated gracefully, the secondary will be immediately promoted to mater. Otherwise, the secondary will be promoted after 
heartbeats are missed for a given length of time. This defaults to 30 seconds, and is configured in brooklyn.properties using 
<code>brooklyn.ha.heartbeatTimeout</code></p>

<p>In the event that tasks - such as the provisioning of a new entity - are running when a failover occurs, the new master will display the current
state of the entity, but will not resume its provisioning or re-run any partially completed tasks. In this case it may be necessary
to remove the entity and reprovision it. In the case of a failover whilst executing a task called by an effector, it may be possible to simple
call the effector again</p>

<h3 id="internalLink_high-availability-(supplemental)_client-configuration">Client Configuration</h3>
<p>It is the responsibility of the client to connect to the master Brooklyn server. This can be accomplished in a variety of ways:</p>

<ul>
  <li>
    <h3 id="internalLink_high-availability-(supplemental)_reverse-proxy">Reverse Proxy</h3>

    <p>To allow the client application to automatically fail over in the event of a master server becoming unavailable, or the promotion of a new master,
a reverse proxy can be configured to route traffic depending on the response returned by <code>https://&lt;ip-address&gt;:8443/v1/server/ha/state</code> (see above).
If a server returns <code>"MASTER"</code>, then traffic should be routed to that server, otherwise it should not be. The client software should be configured
to connect to the reverse proxy server and no action is required by the client in the event of a failover. It can take up to 30 seconds for the
standby to be promoted, so the reverse proxy should retry for at least this period, or the failover time should be reconfigured to be shorter</p>
  </li>
  <li>
    <h3 id="internalLink_high-availability-(supplemental)_re-allocating-an-elastic-ip-on-failover">Re-allocating an Elastic IP on Failover</h3>

    <p>If the cloud provider you are using supports Elastic or Floating IPs, then the IP address should be allocated to the HA master, and the client
application configured to connect to the floating IP address. In the event of a failure of the master node, the standby node will automatically
be promoted to master, and the floating IP will need to be manually re-allocated to the new master node. No action is required by the client
in the event of a failover. It is possible to automate the re-allocation of the floating IP if the Brooklyn servers are deployed and managed
by Brooklyn using the entity <code>org.apache.brooklyn.entity.brooklynnode.BrooklynCluster</code></p>
  </li>
  <li>
    <h3 id="internalLink_high-availability-(supplemental)_client-based-failover">Client-based failover</h3>

    <p>In this scenario, the responsibilty for determining the Brooklyn master server falls on the client application. When configuring the client
application, a list of all servers in the cluster is passed in at application startup. On first connection, the client application connects to
any of the members of the cluster to retrieve the HA states (see above). The JSON object returned is used to determine the addresses of all
members of the cluster, and also to determine which node is the HA master</p>

    <p>In the event of a failure of the master node, the client application should then retrieve the HA states of the cluster from any of the other cluster
members. This is the same process as when the application first connects to the cluster. The client should refresh its list of cluster memebers
and determine which node is the HA master</p>

    <p>It is also recommended that the client application periodically checks the status of the cluster and updates its list of addresses. This will
ensure that failover is still possible if the standby server(s) has been replaced. It also allows additional standby servers to be added at any
time</p>
  </li>
</ul>

<h3 id="internalLink_high-availability-(supplemental)_testing">Testing</h3>
<p>You can confirm that Brooklyn is running in high availibility mode on the master by logging into the web console at <code>https://&lt;ip-address&gt;:8443</code>.
Similarly you can log into the web console on the standby VM where you will see a warning that the server is not the high availability master.</p>

<p>To test a failover, you can simply terminate the process on the first VM and log into the web console on the second VM. Upon launch, Brooklyn will
output its PID to the file <code>pid.txt</code>; you can force an immediate (non-graceful) termination of the process by running the following command 
from the same directory from which you launched Brooklyn:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">kill</span> -9 <span class="k">$(</span>cat pid.txt<span class="k">)</span></code></pre></div>

<p>It is also possiblity to check the high availability state of a running Brooklyn server using the following curl command:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl -k -u myusername:mypassword https://&lt;ip-address&gt;:8443/v1/server/ha/state</code></pre></div>

<p>This will return one of the following states:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="s2">&quot;INITIALIZING&quot;</span>
<span class="s2">&quot;STANDBY&quot;</span>
<span class="s2">&quot;HOT_STANDBY&quot;</span>
<span class="s2">&quot;HOT_BACKUP&quot;</span>
<span class="s2">&quot;MASTER&quot;</span>
<span class="s2">&quot;FAILED&quot;</span>
<span class="s2">&quot;TERMINATED&quot;</span></code></pre></div>

<p>Note: The quotation characters will be included in the reply</p>

<p>To obtain information about all of the nodes in the cluster, run the following command against any of the nodes in the cluster:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl -k -u myusername:mypassword https://&lt;ip-address&gt;:8443/v1/server/ha/states</code></pre></div>

<p>This will return a JSON document describing the Brooklyn nodes in the cluster. An example of two HA Brooklyn nodes is as follows (whitespace formatting has been
added for clarity):</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="p-Indicator">{</span>
  <span class="nv">ownId</span><span class="p-Indicator">:</span> <span class="s">&quot;XkJeXUXE&quot;</span><span class="p-Indicator">,</span>
  <span class="nv">masterId</span><span class="p-Indicator">:</span> <span class="s">&quot;yAVz0fzo&quot;</span><span class="p-Indicator">,</span>
  <span class="nv">nodes</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
    <span class="nv">yAVz0fzo</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
      <span class="nv">nodeId</span><span class="p-Indicator">:</span> <span class="s">&quot;yAVz0fzo&quot;</span><span class="p-Indicator">,</span>
      <span class="nv">nodeUri</span><span class="p-Indicator">:</span> <span class="s">&quot;https://&lt;server1-ip-address&gt;:8443/&quot;</span><span class="p-Indicator">,</span>
      <span class="nv">status</span><span class="p-Indicator">:</span> <span class="s">&quot;MASTER&quot;</span><span class="p-Indicator">,</span>
      <span class="nv">localTimestamp</span><span class="p-Indicator">:</span> <span class="nv">1466414301065</span><span class="p-Indicator">,</span>
      <span class="nv">remoteTimestamp</span><span class="p-Indicator">:</span> <span class="nv">1466414301000</span>
    <span class="p-Indicator">},</span>
    <span class="nv">XkJeXUXE</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span>
      <span class="nv">nodeId</span><span class="p-Indicator">:</span> <span class="s">&quot;XkJeXUXE&quot;</span><span class="p-Indicator">,</span>
      <span class="nv">nodeUri</span><span class="p-Indicator">:</span> <span class="s">&quot;https://&lt;server2-ip-address&gt;:8443/&quot;</span><span class="p-Indicator">,</span>
      <span class="nv">status</span><span class="p-Indicator">:</span> <span class="s">&quot;STANDBY&quot;</span><span class="p-Indicator">,</span>
      <span class="nv">localTimestamp</span><span class="p-Indicator">:</span> <span class="nv">1466414301066</span><span class="p-Indicator">,</span>
      <span class="nv">remoteTimestamp</span><span class="p-Indicator">:</span> <span class="nv">1466414301000</span>
    <span class="p-Indicator">}</span>
  <span class="p-Indicator">},</span>
  <span class="nv">links</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="p-Indicator">}</span>
<span class="p-Indicator">}</span></code></pre></div>

<p>The examples above show how to use <code>curl</code> to manually check the status of Brooklyn via its REST API. The same REST API calls can also be used by
automated third party monitoring tools such as Nagios </p>


	</div>
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-osgi-distribution" class="section-breaker section p-">
	<span style="width: 100%"><h1>OSGi Distribution</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h1 id="internalLink_osgi-distribution_running-apache-brooklyn-inside-karaf-container">Running Apache Brooklyn inside Karaf container</h1>

<p>The Apache Brooklyn Karaf based distribution lives in brooklyn-dist/karaf/apache-brooklyn folder.
It’s still in a testing stage so some features might not work as expected. Please contact us on the 
<a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/&">mailing list</a> if you find any problems.</p>

<h2 id="internalLink_osgi-distribution_building">Building</h2>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd </span>brooklyn-dist
mvn clean install
<span class="nb">cd </span>karaf/apache-brooklyn/target
tar -zxvf apache-brooklyn-0.12.0-SNAPSHOT.tar.gz
<span class="nb">cd </span>apache-brooklyn-0.12.0-SNAPSHOT</code></pre></div>

<h2 id="internalLink_osgi-distribution_running">Running</h2>

<p>Start the instance with a console in the foreground using the following command</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bin/karaf</code></pre></div>

<p>This will launch the <a href="https://karaf.apache.org/manual/latest/users-guide/console.html">Karaf console</a>
where you can interact with the running instance. Note that Brooklyn has already started at this point
and is reachable at the usual web console url.</p>

<p>To start in debug mode use</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bin/karaf debug</code></pre></div>

<p>and connect to port 5005 using your normal Java debugger.</p>

<p>To pause startup until the debugger is connected you can use</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">JAVA_DEBUG_OPTS</span><span class="o">=</span><span class="s1">&#39;-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005&#39;</span> bin/karaf debug</code></pre></div>

<p>Start the instance as a server in the background using the following command</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">bin/start</code></pre></div>

<p>The Karaf container will keep state such as installed bundles and configuration between restarts.
To reset any changes add <strong>clean</strong> to the cli arguments.</p>

<h2 id="internalLink_osgi-distribution_configuring">Configuring</h2>

<p>Configuration of Brooklyn when running under Karaf is largely done through standard Karaf mechanisms. 
See the page on <a href="#contentsLink-osgi-configuration">OSGI Configuration</a> for details.</p>

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-osgi-configuration" class="section-breaker section p-">
	<span style="width: 100%"><h1>OSGi Configuration</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Configuration of Apache Brooklyn when running under Karaf is largely done through standard Karaf mechanisms. 
The Karaf “Configuration Admin” subsystem is used to manage configuration values loaded at first boot from the
<code>.cfg</code> files in the <code>etc</code> directory of the distribution. In the Karaf command line these can then be viewed
and manipulated by the <code>config:</code> commands, see the <a href="https://karaf.apache.org/manual/latest/">Karaf documentation</a> for full details.</p>

<h2 id="internalLink_osgi-configuration_configuring-brooklyn-properties">Configuring Brooklyn Properties</h2>

<p>To configure the Brooklyn runtime create an <code>etc/brooklyn.cfg</code> file, following the standard <code>brooklyn.properties</code>
file format. Values can be viewed and managed dynamically via the OSGI configuration admin commands in Karaf,
e.g. <code>config:property-set</code>. The global <code>~/.brooklyn/brooklyn.properties</code> is still supported and has higher
priority for duplicate keys, but it’s values can’t be manipulated with the Karaf commands, so its use is
discouraged.</p>

<p>You can use the standard <code>~/.brooklyn/brooklyn.properties</code> file to configure Brooklyn. Alternatively
create <code>etc/brooklyn.cfg</code> inside the distribution folder (same file format). The keys in the former override
those in the latter.</p>

<p>Web console related configuration is done through the corresponding Karaf mechanisms:</p>

<ul>
  <li>The port is set in <code>etc/org.ops4j.pax.web.cfg</code>, key <code>org.osgi.service.http.port</code>.</li>
  <li>For authentication the JAAS realm “webconsole” is used; by default it will use any
SecurityProvider implementations configured in Brooklyn falling back to auto generating
the password. To configure a custom JAAS realm see the <code>jetty.xml</code> file in 
<code>brooklyn-server/karaf/jetty-config/src/main/resources</code>
and override it by creating a custom one in <code>etc</code> folder. Point the “webconsole” login service
to the JAAS realm you would like to use.</li>
  <li>For other Jetty related configuration consult the Karaf and pax-web docs.</li>
</ul>

<h2 id="internalLink_osgi-configuration_https-configuration">HTTPS Configuration</h2>

<p>See <a href="https.html">HTTPS Configuration</a> for general information on configuring HTTPS.</p>

<p>In <code>etc/org.ops4j.pax.web.cfg</code> in the Brooklyn Karaf distribution root, un-comment the settings:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">org.osgi.service.http.port.secure</span><span class="o">=</span><span class="s">8443</span>
<span class="na">org.osgi.service.http.secure.enabled</span><span class="o">=</span><span class="s">true</span>
<span class="na">org.ops4j.pax.web.ssl.keystore</span><span class="o">=</span><span class="s">${karaf.home}/etc/keystores/keystore.jks</span>
<span class="na">org.ops4j.pax.web.ssl.password</span><span class="o">=</span><span class="s">password</span>
<span class="na">org.ops4j.pax.web.ssl.keypassword</span><span class="o">=</span><span class="s">password</span>
<span class="na">org.ops4j.pax.web.ssl.clientauthwanted</span><span class="o">=</span><span class="s">false</span>
<span class="na">org.ops4j.pax.web.ssl.clientauthneeded</span><span class="o">=</span><span class="s">false</span></code></pre></div>

<p>replacing the passwords with appropriate values, and restart the server. Note the keystore location is relative to 
the installation root, but a fully qualified path can also be given, if it is desired to use some separate pre-existing
store.</p>

<!--
----------
-- NOTE: comment out this section on catalog as the behaviour described is not enabled by default since
-- https://github.com/apache/brooklyn-server/pull/233; re-enable this when that changes
----------
## Catalog in Karaf  
With the traditional launcher, Brooklyn loads the initial contents of the catalog from a `default.catalog.bom` file
as described in the section on [installation](/guide/ops/production-installation.html). Brooklyn finds Java 
implementations to provide for certain things in blueprints (entities, enrichers etc.) by scanning the classpath. 

In the OSGI world this approach is not used, as each bundle only has visibility of its own and its imported Java packages. 
Instead, in Karaf, each bundle can declare its own `catalog.bom` file, in the root of the bundle,
with the catalog declarations for any entities etc. that the bundle contains.

For example, the `catalog.bom` file for Brooklyn's Webapp bundle looks like (abbreviated):

    brooklyn.catalog:
        version: ...
        items:
        - id: org.apache.brooklyn.entity.webapp.nodejs.NodeJsWebAppService
          itemType: entity
          item:
            type: org.apache.brooklyn.entity.webapp.nodejs.NodeJsWebAppService
            name: Node.JS Application
        ...
        - id: resilient-bash-web-cluster-template
          itemType: template
          name: "Template: Resilient Load-Balanced Bash Web Cluster with Sensors"
          description: |
            Sample YAML to provision a cluster of the bash/python web server nodes,
            with sensors configured, and a load balancer pointing at them,
            and resilience policies for node replacement and scaling
          item:
            name: Resilient Load-Balanced Bash Web Cluster (Brooklyn Example)

In the above YAML the first item declares that the bundle provides an entity whose type is
`org.apache.brooklyn.entity.webapp.nodejs.NodeJsWebAppService`, and whose name is 'Node.JS Application'.  The second
item declares that the bundle provides a template application, with id  `resilient-bash-web-cluster-template`, and
includes a description for what this is.

## Configuring the applications in the Catalog

When running some particular deployment of Brooklyn it may not be desirable for the sample applications to appear in
the catalog (for clarity, "application" here in the sense of an item with `itemType: template`).
For example, if you have developed
some bundle with your own application and added it to Karaf then you might want only your own application to appear in
the catalog.

Brooklyn contains a mechanism to allow you to configure what bundles will add their applications to the catalog.
The Karaf configuration file `/etc/org.apache.brooklyn.core.catalog.bomscanner.cfg` contains two properties,
one `whitelist` and the other `blacklist`, that bundles must satisfy for their applications to be added to the catalog.
Each property value is a comma-separated list of regular expressions.  The symbolic id of the bundle must match one of
the regular expressions on the whitelist, and not match any expression on the blacklist, if its applications
are to be added to the bundle.  The default values of these properties are to admit all bundles, and forbid none.

## Caveats

In the OSGi world specifying class names by string in Brooklyn's configuration will work only
for classes living in Brooklyn's core modules. Raise an issue or ping us on IRC if you find
a case where this doesn't work for you. For custom SecurityProvider implementations refer to the
documentation of BrooklynLoginModule.
    
 END Catalog in Karaf comment -->


	</div>
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-logging" class="section-breaker section p-">
	<span style="width: 100%"><h1>Logging</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Brooklyn uses the SLF4J logging facade, which allows use of many popular frameworks including <code>logback</code>, 
<code>java.util.logging</code> and <code>log4j</code>.</p>

<p>The convention for log levels is as follows:</p>

<ul>
  <li><code>ERROR</code> and above:  exceptional situations which indicate that something has unexpectedly failed or
some other problem has occured which the user is expected to attend to</li>
  <li><code>WARN</code>:  exceptional situations which the user may which to know about but which do not necessarily indicate failure or require a response</li>
  <li><code>INFO</code>:  a synopsis of activity, but which should not generate large volumes of events nor overwhelm a human observer</li>
  <li><code>DEBUG</code> and lower:  detail of activity which is not normally of interest, but which might merit closer inspection under certain circumstances.</li>
</ul>

<p>Loggers follow the <code>package.ClassName</code> naming standard.  </p>

<h2 id="internalLink_logging_standard-configuration">Standard Configuration</h2>

<p>A <code>logback.xml</code> file is included in the <code>conf/</code> directly of the Brooklyn distro;
this is read by <code>brooklyn</code> at launch time.  Changes to the logging configuration,
such as new appenders or different log levels, can be made directly in this file
or in a new file included from this.</p>

<h2 id="internalLink_logging_advanced-configuration">Advanced Configuration</h2>

<p>The default <code>logback.xml</code> file references a collection of other log configuration files
included in the Brooklyn jars. It is necessary to understand the source structure
in the <a href="https://github.com/apache/brooklyn-server/tree/master/usage/logback-includes">logback-includes</a> project.</p>

<p>For example, to change the debug log inclusions, create a folder <code>brooklyn</code> under <code>conf</code>
and create a file <code>logback-debug.xml</code> based on the
<a href="https://github.com/apache/brooklyn-server/tree/master/usage/logback-includes/src/main/resources/brooklyn/logback-debug.xml">brooklyn/logback-debug.xml</a>
from that project.</p>

<h2 id="internalLink_logging_log-file-backup">Log File Backup</h2>

<p><em>This sub-section is a work in progress; feedback from the community is extremely welcome.</em></p>

<p>The default rolling log files can be backed up periodically, e.g. using a CRON job.</p>

<p>Note however that the rolling log file naming scheme will rename the historic zipped log files 
such that <code>brooklyn.debug-1.log.zip</code> is the most recent zipped log file. When the current
<code>brooklyn.debug.log</code> is to be zipped, the previous zip file will be renamed 
<code>brooklyn.debug-2.log.zip</code>. This renaming of files can make RSYNC or backups tricky.</p>

<p>An option is to covert/move the file to a name that includes the last-modified timestamp. 
For example (on mac):</p>

<pre><code>LOG_FILE=brooklyn.debug-1.log.zip
TIMESTAMP=`stat -f '%Um' $LOG_FILE`
mv $LOG_FILE /path/to/archive/brooklyn.debug-$TIMESTAMP.log.zip
</code></pre>

<h2 id="internalLink_logging_logging-aggregators">Logging aggregators</h2>

<p>Integration with systems like Logstash and Splunk is possible using standard logback configuration.
Logback can be configured to <a href="http://logback.qos.ch/manual/appenders.html#SyslogAppender">write to the syslog</a>, 
which can then <a href="http://www.logstash.net/docs/1.4.2/inputs/syslog">feed its logs to Logstash</a>.</p>

<h2 id="internalLink_logging_for-more-information">For More Information</h2>

<p>The following resources may be useful when configuring logging:</p>

<ul>
  <li>The <a href="https://github.com/apache/brooklyn-server/tree/master/usage/logback-includes">logback-includes</a> project</li>
  <li><a href="#contentsLink-logging">Brooklyn Developer Guide</a> logging tips</li>
  <li>The <a href="http://logback.qos.ch/">Logback Project</a> home page</li>
</ul>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-https-configuration" class="section-breaker section p-">
	<span style="width: 100%"><h1>HTTPS Configuration</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_https-configuration_getting-the-certificate">Getting the Certificate</h2>
<p>To enable HTTPS web access, you will need a server certificate in a java keystore. To create a self-signed certificate,
for testing and non-production use, you can use the tool <code>keytool</code> from your Java distribution. (A self-signed 
certificate will cause a warning to be displayed by a browser when viewing the page. The various browsers each have 
ways to import the certificate as a trusted one, for test purposes.)</p>

<p>The following command creates a self-signed certificate and adds it to a keystore, <code>keystore.jks</code>:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">% keytool -genkey -keyalg RSA -alias brooklyn <span class="se">\</span>
          -keystore &lt;path-to-keystore-directory&gt;/keystore.jks -storepass <span class="s2">&quot;mypassword&quot;</span> <span class="se">\</span>
          -validity <span class="m">365</span> -keysize <span class="m">2048</span> -keypass <span class="s2">&quot;password&quot;</span></code></pre></div>

<p>The passwords above should be changed to your own values.  Omit those arguments above for the tool to prompt you for the values.</p>

<p>You will then be prompted to enter your name and organization details. This will use (or create, if it does not exist)
a keystore with the password <code>mypassword</code> - you should use your own secure password, which will be the same password
used in your brooklyn.properties (below). You will also need to replace <code>&lt;path-to-keystore-directory&gt;</code> with the full 
path of the folder where you wish to store your keystore. The keystore will contain the newly generated key, 
with alias <code>brooklyn</code> and password <code>password</code>.</p>

<p>For production servers, a valid signed certificate from a trusted certifying authority should be used instead.
Typically keys from a certifying authority are not provided in Java keystore format.  To create a Java keystore from 
existing certificates (CA certificate, and public and private keys), you must first create a PKCS12 keystore from them,
for example with <code>openssl</code>; this can then be converted into a Java keystore with <code>keytool</code>. For example, with 
a CA certificate <code>ca.pem</code>, and public and private keys <code>cert.pem</code> and <code>key.pem</code>, create the PKCS12 store <code>server.p12</code>,
and then convert it into a keystore <code>keystore.jks</code> as follows:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">% openssl pkcs12 -export -in cert.pem -inkey key.pem <span class="se">\</span>
               -out server.p12 -name <span class="s2">&quot;brooklyn&quot;</span> <span class="se">\</span>
               -CAfile ca.pem -caname root -chain -passout pass:<span class="s2">&quot;password&quot;</span>

% keytool -importkeystore <span class="se">\</span>
        -deststorepass <span class="s2">&quot;password&quot;</span> -destkeypass <span class="s2">&quot;password&quot;</span> -destkeystore keystore.jks <span class="se">\</span>
        -srckeystore server.p12 -srcstoretype PKCS12 -srcstorepass <span class="s2">&quot;password&quot;</span> <span class="se">\</span>
        -alias <span class="s2">&quot;brooklyn&quot;</span></code></pre></div>

<h2 id="internalLink_https-configuration_configuring-brooklyn-for-https">Configuring Brooklyn for HTTPS</h2>

<p>How to do this depends on whether you are using the traditional or the Karaf distribution. See either of</p>

<ul>
  <li><a href="#contentsLink-brooklyn.properties">Traditional Distribution</a></li>
  <li><a href="#contentsLink-osgi-configuration">Karaf Distribution</a></li>
</ul>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-externalized-configuration" class="section-breaker section p-">
	<span style="width: 100%"><h1>Externalized Configuration</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Sometimes it is useful that configuration in a blueprint, or in Brooklyn itself, is not given explicitly, but is instead
replaced with a reference to some other storage system. For example, it is undesirable for a blueprint to contain a
plain-text password for a production system, especially if (as we often recommend) the blueprints are kept in the
developer’s source code control system.</p>

<p>To handle this problem, Apache Brooklyn supports externalized configuration. This allows a blueprint to refer to
a piece of information that is stored elsewhere. <code>brooklyn.properties</code> defines the external suppliers of configuration
information. At runtime, when Brooklyn finds a reference to externalized configuration in a blueprint, it consults
<code>brooklyn.properties</code> for information about the supplier, and then requests that the supplier return the information
required by the blueprint.</p>

<p>Take, as a simple example, a web app which connects to a database. In development, the developer is running a local
instance of PostgreSQL with a simple username and password. But in production, an enterprise-grade cluster of PostgreSQL
is used, and a dedicated service is used to provide passwords. The same blueprint can be used to service both groups
of users, with <code>brooklyn.properties</code> changing the behaviour depending on the deployment environment.</p>

<p>Here is the blueprint:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">MyApplication</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">brooklyn.entity.webapp.jboss.JBoss7Server</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">AppServer HelloWorld</span>
  <span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">wars.root</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://search.maven.org/remotecontent?filepath=org/apache/brooklyn/example/brooklyn-example-hello-world-sql-webapp/0.8.0-incubating/brooklyn-example-hello-world-sql-webapp-0.8.0-incubating.war</span>
    <span class="l-Scalar-Plain">http.port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8080+</span>
    <span class="l-Scalar-Plain">java.sysprops</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">brooklyn.example.db.url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:formatString(&quot;jdbc:postgresql://%s/myappdb?user=%s\\&amp;password=%s&quot;,</span>
         <span class="l-Scalar-Plain">external(&quot;servers&quot;, &quot;postgresql&quot;), external(&quot;credentials&quot;, &quot;postgresql-user&quot;), external(&quot;credentials&quot;, &quot;postgresql-password&quot;))</span></code></pre></div>

<p>You can see that when we are building up the JDBC URL, we are using the <code>external</code> function. This takes two parameters:
the first is the name of the configuration supplier, the second is the name of a key that is stored by the configuration
supplier. In this case we are using two different suppliers: <code>servers</code> to store the location of the server, and
<code>credentials</code> which is a security-optimized supplier of secrets.</p>

<p>Developers would add lines like this to the <code>brooklyn.properties</code> file on their workstation:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.external.servers</span><span class="o">=</span><span class="s">org.apache.brooklyn.core.config.external.InPlaceExternalConfigSupplier</span>
<span class="na">brooklyn.external.servers.postgresql</span><span class="o">=</span><span class="s">127.0.0.1</span>
<span class="na">brooklyn.external.credentials</span><span class="o">=</span><span class="s">org.apache.brooklyn.core.config.external.InPlaceExternalConfigSupplier</span>
<span class="na">brooklyn.external.credentials.postgresql-user</span><span class="o">=</span><span class="s">admin</span>
<span class="na">brooklyn.external.credentials.postgresql-password</span><span class="o">=</span><span class="s">admin</span></code></pre></div>

<p>In this case, all of the required information is included in-line in the local <code>brooklyn.properties</code>.</p>

<p>Whereas in production, <code>brooklyn.properties</code> might look like this:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.external.servers</span><span class="o">=</span><span class="s">org.apache.brooklyn.core.config.external.PropertiesFileExternalConfigSupplier</span>
<span class="na">brooklyn.external.servers.propertiesUrl</span><span class="o">=</span><span class="s">https://ops.example.com/servers.properties</span>
<span class="na">brooklyn.external.credentials</span><span class="o">=</span><span class="s">org.apache.brooklyn.core.config.external.vault.VaultAppIdExternalConfigSupplier</span>
<span class="na">brooklyn.external.credentials.endpoint</span><span class="o">=</span><span class="s">https://vault.example.com</span>
<span class="na">brooklyn.external.credentials.path</span><span class="o">=</span><span class="s">secret/enterprise-postgres</span>
<span class="na">brooklyn.external.credentials.appId</span><span class="o">=</span><span class="s">MyApp</span></code></pre></div>

<p>In this case, the list of servers is stored in a properties file located on an Operations Department web server, and the
credentials are stored in an instance of <a href="https://www.vaultproject.io/">Vault</a>.</p>

<h2 id="internalLink_externalized-configuration_defining-suppliers">Defining Suppliers</h2>

<p>External configuration suppliers are defined in <code>brooklyn.properties</code>. The minimal definition is of the form:</p>

<p>brooklyn.external.<em>supplierName</em> = <em>className</em></p>

<p>This defines a supplier named <em>supplierName</em>. Brooklyn will attempt to instantiate <em>className</em>; it is this class which
will provide the behaviour of how to retrieve data from the supplier. Brooklyn includes a number of supplier
implementations; see below for more details.</p>

<p>Suppliers may require additional configuration options. These are given as additional properties in
<code>brooklyn.properties</code>:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.external.supplierName</span> <span class="o">=</span> <span class="s">className</span>
<span class="na">brooklyn.external.supplierName.firstConfig</span> <span class="o">=</span> <span class="s">value</span>
<span class="na">brooklyn.external.supplierName.secondConfig</span> <span class="o">=</span> <span class="s">value</span></code></pre></div>

<h2 id="internalLink_externalized-configuration_referring-to-external-configuration-in-blueprints">Referring to External Configuration in Blueprints</h2>

<p>Externalized configuration adds a new function to the Brooklyn blueprint language DSL, <code>$brooklyn:external</code>. This
function takes two parameters:</p>

<ol>
  <li>supplier</li>
  <li>key</li>
</ol>

<p>When resolving the external reference, Brooklyn will first identify the <em>supplier</em> of the information, then it will
give the supplier the <em>key</em>. The returned value will be substituted into the blueprint.</p>

<p>You can use <code>$brooklyn:external</code> directly:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">MyApplication</span>
<span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">example</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:external(&quot;supplier&quot;, &quot;key&quot;)</span></code></pre></div>

<p>or embed the <code>external</code> function inside another <code>$brooklyn</code> DSL function, such as <code>$brooklyn:formatString</code>:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">MyApplication</span>
<span class="l-Scalar-Plain">brooklyn.config</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">example</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$brooklyn:formatString(&quot;%s&quot;, external(&quot;supplier&quot;, &quot;key&quot;))</span></code></pre></div>

<h2 id="internalLink_externalized-configuration_referring-to-external-configuration-in-brooklynproperties">Referring to External Configuration in brooklyn.properties</h2>

<p>The same blueprint language DSL can be used from <code>brooklyn.properties</code>. For example:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.location.jclouds.aws-ec2.identity</span><span class="o">=</span><span class="s">$brooklyn:external(&quot;mysupplier&quot;, &quot;aws-identity&quot;)</span>
<span class="na">brooklyn.location.jclouds.aws-ec2.credential</span><span class="o">=</span><span class="s">$brooklyn:external(&quot;mysupplier&quot;, &quot;aws-credential&quot;)</span></code></pre></div>

<h2 id="internalLink_externalized-configuration_referring-to-external-configuration-in-catalog-items">Referring to External Configuration in Catalog Items</h2>

<p>The same blueprint language DSL can be used within YAML catalog items. For example:</p>

<pre><code>brooklyn.catalog:
  id: com.example.myblueprint
  version: "1.2.3"
  itemType: entity
  brooklyn.libraries:
  - &gt;
    $brooklyn:formatString("https://%s:%s@repo.example.com/libs/myblueprint-1.2.3.jar", 
    external("mysupplier", "username"), external("mysupplier", "password"))
  item:
    type: com.example.MyBlueprint
</code></pre>

<p>Note the <code>&gt;</code> in the example above is used to split across multiple lines.</p>

<h2 id="internalLink_externalized-configuration_suppliers-available-with-brooklyn">Suppliers available with Brooklyn</h2>

<p>Brooklyn ships with a number of external configuration suppliers ready to use.</p>

<h3 id="internalLink_externalized-configuration_in-place">In-place</h3>

<p><strong>InPlaceExternalConfigSupplier</strong> embeds the configuration keys and values as properties inside <code>brooklyn.properties</code>.
For example:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.external.servers</span><span class="o">=</span><span class="s">org.apache.brooklyn.core.config.external.InPlaceExternalConfigSupplier</span>
<span class="na">brooklyn.external.servers.postgresql</span><span class="o">=</span><span class="s">127.0.0.1</span></code></pre></div>

<p>Then, a blueprint which referred to <code>$brooklyn:external("servers", "postgresql")</code> would receive the value <code>127.0.0.1</code>.</p>

<h3 id="internalLink_externalized-configuration_properties-file">Properties file</h3>

<p><strong>PropertiesFileExternalConfigSupplier</strong> loads a properties file from a URL, and uses the keys and values in this
file to respond to configuration lookups.</p>

<p>Given this configuration:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.external.servers</span><span class="o">=</span><span class="s">org.apache.brooklyn.core.config.external.PropertiesFileExternalConfigSupplier</span>
<span class="na">brooklyn.external.servers.propertiesUrl</span><span class="o">=</span><span class="s">https://ops.example.com/servers.properties</span></code></pre></div>

<p>This would cause the supplier to download the given URL. Assuming that the file contained this entry:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">postgresql</span><span class="o">=</span><span class="s">127.0.0.1</span></code></pre></div>

<p>Then, a blueprint which referred to <code>$brooklyn:external("servers", "postgresql")</code> would receive the value <code>127.0.0.1</code>.</p>

<h3 id="internalLink_externalized-configuration_vault">Vault</h3>

<p><a href="https://www.vaultproject.io">Vault</a> is a server-based tool for managing secrets. Brooklyn provides suppliers that are
able to query the Vault REST API for configuration values. The different suppliers implement alternative authentication
options that Vault provides.</p>

<p>For <em>all</em> of the authentication methods, you must always set these properties in <code>brooklyn.properties</code>:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.external.supplierName.endpoint</span><span class="o">=</span><span class="s">&lt;Vault HTTP/HTTPs endpoint&gt;</span>
<span class="na">brooklyn.external.supplierName.path</span><span class="o">=</span><span class="s">&lt;path to a Vault object&gt;</span></code></pre></div>

<p>For example, if the path is set to <code>secret/brooklyn</code>, then attempting to retrieve the key <code>foo</code> would cause Brooklyn
to retrieve the value of the <code>foo</code> key on the <code>secret/brooklyn</code> object. This value can be set using the Vault CLI
like this:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">vault write secret/brooklyn <span class="nv">foo</span><span class="o">=</span>bar</code></pre></div>

<h4 id="internalLink_externalized-configuration_authentication-by-username-and-password">Authentication by username and password</h4>

<p>The <code>userpass</code> plugin for Vault allows authentication with username and password.</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.external.supplierName</span><span class="o">=</span><span class="s">org.apache.brooklyn.core.config.external.vault.VaultUserPassExternalConfigSupplier</span>
<span class="na">brooklyn.external.supplierName.username</span><span class="o">=</span><span class="s">fred</span>
<span class="na">brooklyn.external.supplierName.password</span><span class="o">=</span><span class="s">s3kr1t</span></code></pre></div>

<h4 id="internalLink_externalized-configuration_authentication-using-app-id">Authentication using App ID</h4>

<p>The <code>app_id</code> plugin for Vault allows you to specify an “app ID”, and then designate particular “user IDs” to be part
of the app. Typically the app ID would be known and shared, but user ID would be autogenerated on the client in some
way. Brooklyn implements this by determining the MAC address of the server running Brooklyn (expressed as 12 lower
case hexadecimal digits without separators) and passing this as the user ID.</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.external.supplierName</span><span class="o">=</span><span class="s">org.apache.brooklyn.core.config.external.vault.VaultAppIdExternalConfigSupplier</span>
<span class="na">brooklyn.external.supplierName.appId</span><span class="o">=</span><span class="s">MyApp</span></code></pre></div>

<p>If you do not wish to use the MAC address as the user ID, you can override it with your own choice of user ID:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.external.supplierName.userId</span><span class="o">=</span><span class="s">server3.cluster2.europe</span></code></pre></div>

<h4 id="internalLink_externalized-configuration_authentication-by-fixed-token">Authentication by fixed token</h4>

<p>If you have a fixed token string, then you can use the <em>VaultTokenExternalConfigSupplier</em> class and provide the token
in <code>brooklyn.properties</code>:</p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="na">brooklyn.external.supplierName</span><span class="o">=</span><span class="s">org.apache.brooklyn.core.config.external.vault.VaultTokenExternalConfigSupplier</span>
<span class="na">brooklyn.external.supplierName.token</span><span class="o">=</span><span class="s">1091fc84-70c1-b266-b99f-781684dd0d2b</span></code></pre></div>

<p>This supplier is suitable for “smoke testing” the Vault supplier using the Initial Root Token or similar. However it
is not suitable for production use as it is inherently insecure - should the token be compromised, an attacker could
have complete access to your Vault, and the cleanup operation would be difficult. Instead you should use one of the
other suppliers.</p>

<h2 id="internalLink_externalized-configuration_writing-custom-external-configuration-suppliers">Writing Custom External Configuration Suppliers</h2>

<p>Supplier implementations must conform to the brooklyn.config.external.ExternalConfigSupplier interface, which is very
simple:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">String</span> <span class="nf">getName</span><span class="o">();</span>
<span class="n">String</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">);</span></code></pre></div>

<p>Classes implementing this interface can be placed in the <code>lib/dropins</code> folder of Brooklyn, and then the supplier
defined in <code>brooklyn.properties</code> as normal.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-requirements" class="section-breaker section p-">
	<span style="width: 100%"><h1>Requirements</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_requirements_server-specification">Server Specification</h2>

<p>The size of server required by Brooklyn depends on the amount of activity. This includes:</p>

<ul>
  <li>the number of entities/VMs being managed</li>
  <li>the number of VMs being deployed concurrently</li>
  <li>the amount of management and monitoring required per entity</li>
</ul>

<p>For dev/test or when there are only a handful of VMs being managed, a small VM is sufficient.
For example, an AWS m3.medium with one vCPU, 3.75GiB RAM and 4GB disk.</p>

<p>For larger production uses, a more appropriate machine spec would be two or more cores,
at least 8GB RAM and 100GB disk. The disk is just for logs, a small amount of persisted state, and
any binaries for custom blueprints/integrations.</p>

<h3 id="internalLink_requirements_disk-space">Disk Space</h3>

<p>There are three main consumers of disk space:</p>

<ul>
  <li><strong>Static files</strong>: these are the Apache Brooklyn distribution with its own
dependencies, plus binaries for custom blueprints and integrations added to
the <code>lib</code> directory. Note that Brooklyn requires that Java is installed which
you may have to consider when calculating disk space requirements.</li>
  <li><strong>Persisted state</strong>: when using <a href="#contentsLink-persistence">Persistence</a> – which
is a prerequisite for <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/ops/high-availability">High Availability</a> – Brooklyn
will save data to a store location. Items in the persisted state include
metadata about the Brooklyn servers, catalog items, and metadata about all
running applications and entities.</li>
  <li><strong>Log files</strong>: Brooklyn writes info and debug log files. By default, these are
written to the local filesystem. This can be reconfigured to set the
destination and to increase or decrease the detail in the logs. See the
<a href="#contentsLink-logging">Logging</a> section for more details.</li>
</ul>

<p>The Apache Brooklyn distribution itself, when unpacked, consumes approximately
75MB of disk space. This includes everything needed to run Brooklyn except for a
Java VM. The space consumed by additional binaries for custom blueprints and
integrations is application-specific.</p>

<p>Persisted state, excluding catalog data, is relatively small, starting at
approximately 300KB for a clean, idle Brooklyn server. Deploying blueprints will
add to this - how much depends exactly on the entities involved and is therefore
application specific, but as a guideline, a 3-node Riak cluster adds
approximately 500KB to the persistence store.</p>

<p>Log data can be a large consumer of disk space. By default Brooklyn generates
two logfiles, one which logs notable information only, and another which logs at
a debug level. Each logfile rotates when it hits a size of 100MB; a maximum of
10 log files are retained for each type. The two logging streams combined,
therefore, can consume up to 2GB of disk space.</p>

<p>In the default configuration of Brooklyn’s <code>.tar.gz</code> and <code>.zip</code> distributions,
logs are saved to the Brooklyn installation directory. You will most likely want
to <a href="#contentsLink-logging">reconfigure Brooklyn’s logging</a> to save logs to a location
elsewhere. In the <code>.rpm</code> and <code>.deb</code> packaging, logging files will be located
under <code>/var/log</code>. You can further reconfiguring the logging detail level and log
rotation according to your organisation’s policy.</p>

<h2 id="internalLink_requirements_supported-operating-systems">Supported Operating Systems</h2>

<p>The recommended operating system is CentOS 6.x or RedHat 6.x.</p>

<p>Brooklyn has also been tested on Ubuntu 14.04 and OS X.</p>

<h2 id="internalLink_requirements_software-requirements">Software Requirements</h2>

<p>Brooklyn requires Java (JRE or JDK) minimum version 1.7. 
OpenJDK is recommended. Brooklyn has also been tested on IBM J9 and Oracle’s JVM.</p>

<h2 id="internalLink_requirements_configuration-requirements">Configuration Requirements</h2>

<h3 id="internalLink_requirements_ports">Ports</h3>

<p>The ports used by Brooklyn are:</p>

<ul>
  <li>8443 for https, to expose the web-console and REST api.</li>
  <li>8081 for http, to expose the web-console and REST api.</li>
</ul>

<p>Whether to use https rather than http is configurable using the CLI option <code>--https</code>; 
the port to use is configurable using the CLI option <code>--port &lt;port&gt;</code>.</p>

<p>To enable remote Brooklyn access, ensure these ports are open in the firewall.
For example, to open port 8443 in iptables, ues the command:</p>

<pre><code>/sbin/iptables -I INPUT -p TCP --dport 8443 -j ACCEPT
</code></pre>

<h3 id="internalLink_requirements_locale">Locale</h3>

<p>Brooklyn expects a sensible set of locale information and time zones to be available;
without this, some time-and-date handling may be surprising.</p>

<p>Brooklyn parses and reports times according to the time zone set at the server.
If Brooklyn is targetting geographically distributed users, 
it is normally recommended that the server’s time zone be set to UTC.</p>

<h3 id="internalLink_requirements_user-setup">User Setup</h3>

<p>It is normally recommended that Brooklyn run as a non-root user with keys installed to <code>~/.ssh/id_rsa{,.pub}</code>. </p>

<h3 id="internalLink_requirements_linux-kernel-entropy">Linux Kernel Entropy</h3>

<p>Check that the <a href="#contentsLink-increase-entropy">linux kernel entropy</a> is sufficient.</p>

<h3 id="internalLink_requirements_system-resource-limits">System Resource Limits</h3>

<p>Check that the <a href="#contentsLink-increase-system-resource-limits">ulimit values</a> are sufficiently high.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-security-guidelines" class="section-breaker section p-">
	<span style="width: 100%"><h1>Security Guidelines</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_security-guidelines_brooklyn-server">Brooklyn Server</h2>

<h3 id="internalLink_security-guidelines_web-console-and-rest-api">Web-console and REST api</h3>

<p>Users are strongly encouraged to use HTTPS, rather than HTTP.</p>

<p>The use of LDAP is encouraged, rather than basic auth.</p>

<p>Configuration of “entitlements” is encouraged, to lock down access to the REST api for different 
users.</p>

<h3 id="internalLink_security-guidelines_brooklyn-user">Brooklyn user</h3>

<p>Users are strongly discouraged from running Brooklyn as root.</p>

<p>For production use-cases (i.e. where Brooklyn will never deploy to “localhost”), the user under 
which Brooklyn is running should not have <code>sudo</code> rights.</p>

<h3 id="internalLink_security-guidelines_persisted-state">Persisted State</h3>

<p>Use of an object store is recommended (e.g. using S3 compliant or Swift API) - thus making
use of the security features offered by the chosen object store.</p>

<p>File-based persistence is also supported. Permissions of the files will automatically
be 600 (i.e. read-write only by the owner). Care should be taken for permissions of the
relevant mount points, disks and directories.</p>

<h2 id="internalLink_security-guidelines_credential-storage">Credential Storage</h2>

<p>For credential storage, users are strongly encouraged to consider using the “externalised 
configuration” feature. This allows credentials to be retrieved from a store managed by you, 
rather than being stored within YAML blueprints or brooklyn.properties.</p>

<p>A secure credential store is strongly recommended, such as use of 
<a href="https://www.vaultproject.io">HashiCorp’s Vault</a> - see
<code>org.apache.brooklyn.core.config.external.vault.VaultExternalConfigSupplier</code>.</p>

<h2 id="internalLink_security-guidelines_infrastructure-access">Infrastructure Access</h2>

<h3 id="internalLink_security-guidelines_cloud-credentials-and-access">Cloud Credentials and Access</h3>

<p>Users are strongly encouraged to create separate cloud credentials for Brooklyn’s API access.</p>

<p>Users are also encouraged to (where possible) configure the cloud provider for only minimal API 
access (e.g. using AWS IAM).</p>

<!--
TODO: We should document the minimum requirements for AWS IAM required by Brooklyn
-->

<h3 id="internalLink_security-guidelines_vm-image-credentials">VM Image Credentials</h3>

<p>Users are strongly discouraged from using hard-coded passwords within VM images. Most cloud 
providers/APIs provide a mechanism to instead set an auto-generated password or to create an 
entry in <code>~/.ssh/authorized_keys</code> (prior to the VM being returned by the cloud provider).</p>

<p>If a hard-coded credential is used, then Brooklyn can be configured with this “loginUser” and 
“loginUser.password” (or “loginUser.privateKeyData”), and can change the password and disable 
root login.</p>

<h3 id="internalLink_security-guidelines_vm-users">VM Users</h3>

<p>It is strongly discouraged to use the root user on VMs being created or managed by Brooklyn.</p>

<h3 id="internalLink_security-guidelines_ssh-keys">SSH keys</h3>

<p>Users are strongly encouraged to use SSH keys for VM access, rather than passwords.</p>

<p>This SSH key could be a file on the Brooklyn server. However, a better solution is to use the 
“externalised configuration” to return the “privateKeyData”. This better supports upgrading of 
credentials.</p>

<h2 id="internalLink_security-guidelines_install-artifact-downloads">Install Artifact Downloads</h2>

<p>When Brooklyn executes scripts on remote VMs to install software, it often requires downloading 
the install artifacts. For example, this could be from an RPM repository or to retrieve <code>.zip</code> 
installers.</p>

<p>By default, the RPM repositories will be whatever the VM image is configured with. For artifacts 
to be downloaded directly, these often default to the public site (or mirror) for that software 
product.</p>

<p>Where users have a private RPM repository, it is strongly encouraged to ensure the VMs are 
configured to point at this.</p>

<p>For other artifacts, users should consider hosting these artifacts in their own web-server and 
configuring Brooklyn to use this. See the documentation for 
<code>org.apache.brooklyn.core.entity.drivers.downloads.DownloadProducerFromProperties</code>.</p>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-troubleshooting" class="section-breaker section p-">
	<span style="width: 100%"><h1>Troubleshooting</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	
<div class="list-children"><ul>

<li> <a href="#contentsLink-troubleshooting-overview">Troubleshooting Overview</a> </li>

<li> <a href="#contentsLink-web-console-issues">Web Console Issues</a> </li>

<li> <a href="#contentsLink-troubleshooting-deployment">Troubleshooting Deployment</a> </li>

<li> <a href="#contentsLink-troubleshooting-server-connectivity-issues-in-the-cloud">Troubleshooting Server Connectivity Issues in the Cloud</a> </li>

<li> <a href="#contentsLink-brooklyn-slow-or-unresponsive">Brooklyn Slow or Unresponsive</a> </li>

<li> <a href="#contentsLink-increase-entropy">Increase Entropy</a> </li>

<li> <a href="#contentsLink-increase-system-resource-limits">Increase System Resource Limits</a> </li>

<li> <a href="#contentsLink-detailed-support-report">Detailed Support Report</a> </li>

<li> <a href="#contentsLink-troubleshooting-softwareprocess-entities">Troubleshooting SoftwareProcess Entities</a> </li>

<li> <a href="#contentsLink-troubleshooting:-going-deep-in-java-and-logs">Troubleshooting: Going Deep in Java and Logs</a> </li>

<li> <a href="#contentsLink-troubleshooting:-monitoring-memory-usage">Troubleshooting: Monitoring Memory Usage</a> </li>

</ul></div>

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-other-0.12.0-snapshot-resources" class="section-breaker section p-">
	<span style="width: 100%"><h1>Other 0.12.0-SNAPSHOT Resources</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Further documentation specific to this version of Brooklyn includes:</p>

<ul>
  <li>
    <p><a href="#contentsLink-api-reference">Javadoc</a></p>
  </li>
  <li>
    <p><a href="#contentsLink-downloads">Downloads</a></p>
  </li>
  <li>
    <p><a href="#contentsLink-release-notes">Release Notes</a></p>
  </li>
  <li>
    <p><a href="#contentsLink-migrating-to-0.8.0">Migrating to 0.8.0</a></p>
  </li>
  <li>
    <p><a href="#contentsLink-known-issues">Known Issues</a></p>
  </li>
  <li>
    <p><a href="#contentsLink-developer-guide">Developer Guide</a></p>
  </li>
  <li>
    <p><a href="#contentsLink-documentation">All Documentation</a></p>
  </li>
</ul>

<p>Also see the <a href="http://brooklyn.apache.org/v/0.10.0/meta/versions.html">other versions</a> or <a href="#contentsLink-documentation">general documentation</a>.</p>

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-release-notes" class="section-breaker section p-">
	<span style="width: 100%"><h1>Release Notes</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_release-notes_version-0120-snapshot">Version 0.12.0-SNAPSHOT</h2>

<p>Thanks go to our community for their improvements, feedback and guidance, and
to Brooklyn’s commercial users for funding much of this development.</p>

<h3 id="internalLink_release-notes_new-features">New Features</h3>

<h3 id="internalLink_release-notes_backwards-compatibility">Backwards Compatibility</h3>

<p>Changes since 0.10.0:</p>

<ol>
  <li>The usage of <code>ManagementContext.getConfig()</code> is deprecated for storing non-config data like
singletons and cached objects. Use <code>ManagementContext.getScratchpad()</code> instead. Affected objects:</li>
</ol>

<ul>
  <li>BrooklynCampConstants.CAMP_PLATFORM</li>
  <li>CampYamlParser.YAML_PARSER_KEY</li>
  <li>BrooklynServiceAttributes.BROOKLYN_REST_OBJECT_MAPPER</li>
  <li>BrooklynWebConfig.SECURITY_PROVIDER_INSTANCE</li>
</ul>

<p>For changes in prior versions, please refer to the release notes for 
<a href="http://brooklyn.apache.org/v/0.10.0/v/0.10.0/misc/release-notes.html">0.10.0</a>.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-migrating-to-0.8.0" class="section-breaker section p-">
	<span style="width: 100%"><h1>Migrating to 0.8.0</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>As noted in the <a href="#contentsLink-release-notes">release notes</a>,
this version introduces major package renames.</p>

<p>However migrating your code should not be hard:</p>

<ul>
  <li>
    <p>For small Java projects, simply “Optimizing Imports” in your IDE should fix code issues.</p>
  </li>
  <li>
    <p>For YAML blueprints and larger projects, 
a set of regexes has been prepared <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/misc/migrate-to-0.8.0-regexes.sed">here</a>
detailing all class renames.</p>
  </li>
</ul>

<p>To download and apply this to an entire directory, you can use the following snippet.
If running this on a Java project, you should enter the <code>src</code> directory
or <code>rm -rf target</code> first.  For other use cases it should be easy to adapt,
noting the use of <code>sed</code> and the arguments (shown for OS X / BSD here). 
Do make a <code>git commit</code> or other backup before applying,
to make it easy to inspect the changes.
It may add a new line to any file which does not terminate with one,
so do not run on binary files.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl https://brooklyn.apache.org/v/latest/misc/migrate-to-0.8.0-regexes.sed -o /tmp/migrate.sed
<span class="nv">$ </span><span class="k">for</span> x in <span class="sb">`</span>find . -type file<span class="sb">`</span> <span class="p">;</span> <span class="k">do</span> sed -E -i .bak -f /tmp/migrate.sed <span class="nv">$x</span> <span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span>find . -name <span class="s2">&quot;*.bak&quot;</span> -delete</code></pre></div>

<p>If you encounter any issues, please <a href="http://brooklyn.apache.org/v/0.10.0/community/index.html">contact us</a>.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-known-issues" class="section-breaker section p-">
	<span style="width: 100%"><h1>Known Issues</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_known-issues_unable-to-provision-certain-types-of-debian-vms">Unable to Provision certain types of Debian VMs</h2>

<p><em>Symptom</em>: Brooklyn fails to provision Debian VMs (e.g. in aws-ec2).</p>

<p><em>Cause</em>: <code>sudo</code> is not available on path, causing Brooklyn to fail to confirm that the VM is ssh’able.</p>

<p><em>Workaround</em>: Choose an image that does have sudo (see <a href="http://wiki.debian.org/Cloud/AmazonEC2Image">wiki.debian.org/Cloud/AmazonEC2Image</a>).</p>

<p><em>Fix</em>: is <a href="https://github.com/brooklyncentral/brooklyn/pull/600">Pull #600</a>; you may also want to run with <code>brooklyn.location.jclouds.aws-ec2.user=root</code> if subsequent commands give permission errors.</p>

<p><em>Versions Affected</em>: 0.5.0-M2</p>

<h3 id="internalLink_known-issues_unable-to-provision-ubuntu-8-vms">Unable to Provision Ubuntu 8 VMs</h3>

<p>*Symptom: Brooklyn fails to provision Ubuntu 8 VMs (e.g. in aws-ec2) with the following error ‘Cannot insert the iptables rule for port 22. Error: sudo: illegal option `-n’’.</p>

<p>*Cause: Ubuntu 8 is too old; the sudo command doesn’t support the -n setting.</p>

<p>*Workaround: Choose Ubuntu 10 or higher.</p>

<p><em>Versions Affected</em>: 0.5.0-M2</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-maven-build" class="section-breaker section p-">
	<span style="width: 100%"><h1>Maven Build</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_maven-build_the-basics">The Basics</h2>

<p>The full build requires the following software to be installed:</p>

<ul>
  <li>Maven (v3.1+)</li>
  <li>Java (v1.7+, 1.8 recommended)</li>
  <li>Go (v1.6+) [if building the CLI client]</li>
  <li>rpm tools [if building the dist packages for those platforms]</li>
</ul>

<p>With these in place, you should be able to build everything with a:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">% mvn clean install</code></pre></div>

<p>Alternatively you can build most things with just Java and Maven installed using:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">mvn clean install -Dno-go-client -Dno-rpm<span class="sb">`</span></code></pre></div>

<p>Other tips:</p>

<ul>
  <li>
    <p>Add <code>-DskipTests</code> to skip tests (builds much faster, but not as safe)</p>
  </li>
  <li>
    <p>You may need more JVM memory, e.g. at the command-line (or in <code>.profile</code>):</p>

    <p><code>export MAVEN_OPTS="-Xmx1024m -Xms512m -XX:MaxPermSize=256m"</code></p>
  </li>
  <li>
    <p>Run <code>-PIntegration</code> to run integration tests, or <code>-PLive</code> to run live tests
(<a href="http://brooklyn.apache.org/v/0.10.0/v/latest/dev/env/../code/tests.html">tests described here</a>)</p>
  </li>
  <li>
    <p>You may need to install <code>rpm</code> package to build RPM packages: <code>brew install rpm</code> for Mac OS, <code>apt-get install rpm</code> for Ubuntu, <code>yum install rpm</code> for Centos/RHEL.
On Mac OS you may also need to set <code>%_tmppath /tmp</code> in <code>~/.rpmmacros</code>.</p>
  </li>
  <li>
    <p>If you’re looking at the maven internals, note that many of the settings are inherited from parent projects (see for instance <code>brooklyn-server/parent/pom.xml</code>)</p>
  </li>
  <li>
    <p>For tips on building within various IDEs, look <a href="#contentsLink-ide-setup">here</a>.</p>
  </li>
</ul>

<h2 id="internalLink_maven-build_when-the-rat-bites">When the RAT Bites</h2>

<p>We use RAT to ensure that all files are compliant to Apache standards.  Most of the time you shouldn’t see it or need to know about it, but if it detects a violation, you’ll get a message such as:</p>

<pre><code>[ERROR] Failed to execute goal org.apache.rat:apache-rat-plugin:0.10:check (default) on project brooklyn-parent: Too many files with unapproved license: 1 See RAT report in: /Users/alex/Data/cloudsoft/dev/gits/brooklyn/target/rat.txt -&gt; [Help 1]
</code></pre>

<p>If there’s a problem, see the file <code>rat.txt</code> in the <code>target</code> directory of the failed project.  (Maven will show you this link in its output.)</p>

<p>Often the problem is one of the following:</p>

<ul>
  <li>
    <p>You’ve added a file which requires the license header but doesn’t have it</p>

    <p><strong>Resolution:</strong>  Simply copy the header from another file</p>
  </li>
  <li>
    <p>You’ve got some temporary files which RAT things should have headers</p>

    <p><strong>Resolution:</strong>  Move the files away, add headers, or turn off RAT (see below)</p>
  </li>
  <li>
    <p>The project structure has changed and you have stale files (e.g. in a <code>target</code> directory)</p>

    <p><strong>Resolution:</strong>  Remove the stale files, e.g. with <code>git clean -df</code> (and if needed a <code>find . -name target -prune -exec rm -rf {} \;</code> to delete folders named <code>target</code>)</p>
  </li>
</ul>

<p>To disable RAT checking on a build, set <code>rat.ignoreErrors</code>, e.g. <code>mvn -Drat.ignoreErrors=true clean install</code>.  (But note you will need RAT to pass in order for a PR to be accepted!)</p>

<p>If there is a good reason that a file, pattern, or directory should be permanently ignored, that is easy to add inside the root <code>pom.xml</code>.</p>

<h2 id="internalLink_maven-build_other-handy-hints">Other Handy Hints</h2>

<ul>
  <li>
    <p>On some <strong>Ubuntu</strong> (e.g. 10.4 LTS) maven v3 is not currently available from the repositories.
Some instructions for installing at are <a href="http://superuser.com/questions/298062/how-do-i-install-maven-3">at superuser.com</a>.</p>
  </li>
  <li>
    <p>The <strong>mvnf</strong> script 
(<a href="https://gist.github.com/2241800">get the gist here</a>) 
simplifies building selected projects, so if you just change something in <code>software-webapp</code> 
and then want to re-run the examples you can do:</p>

    <p><code>examples/simple-web-cluster% mvnf ../../{software/webapp,usage/all}</code> </p>
  </li>
</ul>

<h2 id="internalLink_maven-build_appendix-sample-output">Appendix: Sample Output</h2>

<p>A healthy build will look something like the following,
including a few warnings (which we have looked into and
understand to be benign and hard to get rid of them,
although we’d love to if anyone can help!):</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">% mvn clean install
<span class="o">[</span>INFO<span class="o">]</span> Scanning <span class="k">for</span> projects...
<span class="o">[</span>INFO<span class="o">]</span> ------------------------------------------------------------------------
<span class="o">[</span>INFO<span class="o">]</span> Reactor Build Order:
<span class="o">[</span>INFO<span class="o">]</span> 
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn REST JavaScript Web GUI
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Server Root
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Parent Project
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Test Support Utilities
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Logback Includable Configuration
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Common Utilities

...

<span class="o">[</span>WARNING<span class="o">]</span> Ignoring project <span class="nb">type </span>war - <span class="nv">supportedProjectTypes</span> <span class="o">=</span> <span class="o">[</span>jar<span class="o">]</span>

...

<span class="o">[</span>WARNING<span class="o">]</span> We have a duplicate org/xmlpull/v1/XmlPullParser.class in ~/.m2/repository/xpp3/xpp3_min/1.1.4c/xpp3_min-1.1.4c.jar

...

<span class="o">[</span>INFO<span class="o">]</span> — maven-assembly-plugin:2.3:single <span class="o">(</span>build-distribution-dir<span class="o">)</span> @ brooklyn-dist —
<span class="o">[</span>INFO<span class="o">]</span> Reading assembly descriptor: src/main/config/build-distribution-dir.xml
<span class="o">[</span>WARNING<span class="o">]</span> Cannot include project artifact: io.brooklyn:brooklyn-dist:jar:0.12.0-SNAPSHOT<span class="p">;</span> it doesn<span class="s1">&#39;t have an associated file or directory.</span>
<span class="s1">[INFO] Copying files to ~/repos/apache/brooklyn/usage/dist/target/brooklyn-dist</span>
<span class="s1">[WARNING] Assembly file: ~/repos/apache/brooklyn/usage/dist/target/brooklyn-dist is not a regular file (it may be a directory). It cannot be attached to the project build for installation or deployment.</span>

<span class="s1">...</span>

<span class="s1">[INFO] — maven-assembly-plugin:2.3:single (build-distribution-archive) @ brooklyn-dist —</span>
<span class="s1">[INFO] Reading assembly descriptor: src/main/config/build-distribution-archive.xml</span>
<span class="s1">[WARNING] Cannot include project artifact: io.brooklyn:brooklyn-dist:jar:0.12.0-SNAPSHOT; it doesn&#39;</span>t have an associated file or directory.
<span class="o">[</span>INFO<span class="o">]</span> Building tar: /Users/aled/repos/apache/brooklyn/usage/dist/target/brooklyn-0.12.0-SNAPSHOT-dist.tar.gz
<span class="o">[</span>WARNING<span class="o">]</span> Cannot include project artifact: io.brooklyn:brooklyn-dist:jar:0.12.0-SNAPSHOT<span class="p">;</span> it doesn<span class="s1">&#39;t have an associated file or directory.</span>

<span class="s1">...</span>

<span class="s1">[WARNING] Don&#39;</span>t override file /Users/aled/repos/apache/brooklyn/usage/archetypes/quickstart/target/test-classes/projects/integration-test-1/project/brooklyn-sample/src/main/resources/sample-icon.png

...

<span class="o">[</span>INFO<span class="o">]</span> Reactor Summary:
<span class="o">[</span>INFO<span class="o">]</span> 
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Parent Project ........................... SUCCESS <span class="o">[</span>3.072s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Utilities to Support Testing <span class="o">(</span>listeners etc<span class="o">)</span>  SUCCESS <span class="o">[</span>3.114s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Logback Includable Configuration ......... SUCCESS <span class="o">[</span>0.680s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Common Utilities ......................... SUCCESS <span class="o">[</span>7.263s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Groovy Utilities ......................... SUCCESS <span class="o">[</span>5.193s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn API ...................................... SUCCESS <span class="o">[</span>2.146s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Test Support ............................. SUCCESS <span class="o">[</span>2.517s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> CAMP Server Parent Project ........................ SUCCESS <span class="o">[</span>0.075s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> CAMP Base ......................................... SUCCESS <span class="o">[</span>4.079s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn REST Swagger Apidoc Utilities ............ SUCCESS <span class="o">[</span>1.983s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Logback Configuration .................... SUCCESS <span class="o">[</span>0.625s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> CAMP Server ....................................... SUCCESS <span class="o">[</span>5.446s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Core ..................................... SUCCESS <span class="o">[</span>1:24.122s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Policies ................................. SUCCESS <span class="o">[</span>44.425s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Hazelcast Storage ........................ SUCCESS <span class="o">[</span>7.143s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Jclouds Location Targets ................. SUCCESS <span class="o">[</span>16.488s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Secure JMXMP Agent ....................... SUCCESS <span class="o">[</span>8.634s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn JMX RMI Agent ............................ SUCCESS <span class="o">[</span>2.315s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Software Base ............................ SUCCESS <span class="o">[</span>28.538s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Network Software Entities ................ SUCCESS <span class="o">[</span>3.896s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn OSGi Software Entities ................... SUCCESS <span class="o">[</span>4.589s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Web App Software Entities ................ SUCCESS <span class="o">[</span>17.484s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Messaging Software Entities .............. SUCCESS <span class="o">[</span>7.106s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Database Software Entities ............... SUCCESS <span class="o">[</span>5.229s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn NoSQL Data Store Software Entities ....... SUCCESS <span class="o">[</span>11.901s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Monitoring Software Entities ............. SUCCESS <span class="o">[</span>4.027s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn CAMP REST API ............................ SUCCESS <span class="o">[</span>15.285s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn REST API ................................. SUCCESS <span class="o">[</span>4.489s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn REST Server .............................. SUCCESS <span class="o">[</span>30.270s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn REST Client .............................. SUCCESS <span class="o">[</span>7.007s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn REST JavaScript Web GUI .................. SUCCESS <span class="o">[</span>24.397s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Launcher ................................. SUCCESS <span class="o">[</span>15.923s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Command Line Interface ................... SUCCESS <span class="o">[</span>9.279s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn All Things ............................... SUCCESS <span class="o">[</span>13.875s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Distribution ............................. SUCCESS <span class="o">[</span>49.370s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Quick-Start Project Archetype ............ SUCCESS <span class="o">[</span>12.053s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Examples Aggregator Project .............. SUCCESS <span class="o">[</span>0.085s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Examples Support Aggregator Project - Webapps  SUCCESS <span class="o">[</span>0.053s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> hello-world-webapp Maven Webapp ................... SUCCESS <span class="o">[</span>0.751s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> hello-world-sql-webapp Maven Webapp ............... SUCCESS <span class="o">[</span>0.623s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Simple Web Cluster Example ............... SUCCESS <span class="o">[</span>5.398s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Global Web Fabric Example ................ SUCCESS <span class="o">[</span>3.176s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn Simple Messaging Publish-Subscribe Example  SUCCESS <span class="o">[</span>3.217s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn NoSQL Cluster Examples ................... SUCCESS <span class="o">[</span>6.790s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> Brooklyn QA ....................................... SUCCESS <span class="o">[</span>7.117s<span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> ------------------------------------------------------------------------
<span class="o">[</span>INFO<span class="o">]</span> BUILD SUCCESS
<span class="o">[</span>INFO<span class="o">]</span> ------------------------------------------------------------------------
<span class="o">[</span>INFO<span class="o">]</span> Total <span class="nb">time</span>: 8:33.983s
<span class="o">[</span>INFO<span class="o">]</span> Finished at: Mon Jul <span class="m">21</span> 14:56:46 BST 2014
<span class="o">[</span>INFO<span class="o">]</span> Final Memory: 66M/554M
<span class="o">[</span>INFO<span class="o">]</span> ------------------------------------------------------------------------</code></pre></div>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-ide-setup" class="section-breaker section p-">
	<span style="width: 100%"><h1>IDE Setup</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Gone are the days when IDE integration always just works…  Maven and Eclipse fight,
neither quite gets along perfectly with Groovy,
git branch switches (sooo nice) can be slow, etc etc.</p>

<p>But with a bit of a dance the IDE can still be your friend,
making it much easier to run tests and debug.</p>

<p>As a general tip, don’t always trust the IDE to build correctly; if you hit a snag,
do a command-line <code>mvn clean install</code> (optionally with <code>-DskipTests</code> and/or <code>-Dno-go-client</code>)
then refresh the project.</p>

<p>See instructions below for specific IDEs.</p>

<h2 id="internalLink_ide-setup_eclipse">Eclipse</h2>

<p>The default Eclipse downloads already include all of the plugins needed for
working with the Brooklyn project. Optionally you can install the
Groovy and TestNG plugins, but they are not required for building the project.
You can install these using Help -&gt; Install New Software, or from the Eclipse Marketplace:</p>

<ul>
  <li>
    <p>Groovy Plugin: GRECLIPSE from
<a href="http://dist.springsource.org/snapshot/GRECLIPSE/e4.5/">dist.springsource.org/snapshot/GRECLIPSE/e4.5/</a>;
Be sure to include Groovy 2.3 compiler support and Maven-Eclipse (m2e) support.
More details including download sites for other versions can be found at the <a href="http://docs.groovy-lang.org/latest/html/documentation/#section-groovyeclipse">Groovy Eclipse Plugin site</a>.</p>
  </li>
  <li>
    <p>TestNG Plugin: beust TestNG from <a href="http://beust.com/eclipse">beust.com/eclipse</a></p>
  </li>
</ul>

<p>As of this writing, Eclipse 4.5 and Eclipse 4.4 are commonly used,
and the codebase can be imported (Import -&gt; Existing Maven Projects)
and successfully built and run inside an IDE.
However there are quirks, and mileage may vary. Disable <code>Build Automatically</code>
from the <code>Project</code> menu if the IDE is slow to respond.</p>

<p>If you encounter issues, the following hints may be helpful:</p>

<ul>
  <li>
    <p>If m2e reports import problems, it is usually okay (even good) to mark all to “Resolve All Later”.
The build-helper connector is useful if you’re prompted for it, but
do <em>not</em> install the Tycho OSGi configurator (this causes show-stopping IAE’s, and we don’t need Eclipse to make bundles anyway).
You can manually mark as permanently ignored certain errors;
this updates the pom.xml (and should be current).</p>
  </li>
  <li>
    <p>A quick command-line build (<code>mvn clean install -DskipTests -Dno-go-client</code>) followed by a workspace refresh
can be useful to re-populate files which need to be copied to <code>target/</code></p>
  </li>
  <li>
    <p>m2e likes to put <code>excluding="**"</code> on <code>resources</code> directories; if you’re seeing funny missing files
(things like not resolving jclouds/aws-ec2 locations or missing WARs), try building clean install
from the command-line then doing Maven -&gt; Update Project (clean uses a maven-replacer-plugin to fix
<code>.classpath</code>s).
Alternatively you can go through and remove these manually in Eclipse (Build Path -&gt; Configure)
or the filesystem, or use
the following command to remove these rogue blocks in the generated <code>.classpath</code> files:</p>
  </li>
</ul>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">% find . -name .classpath -exec sed -i.bak <span class="s1">&#39;s/[ ]*..cluding=&quot;[\*\/]*\(\.java\)*&quot;//g&#39;</span> <span class="o">{}</span> <span class="se">\;</span></code></pre></div>

<ul>
  <li>You may need to ensure <code>src/main/{java,resources}</code> is created in each project dir,
if (older versions) complain about missing directories,
and the same for <code>src/test/{java,resources}</code> <em>if</em> there are tests (<code>src/test</code> exists):</li>
</ul>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">find . <span class="se">\(</span> -path <span class="s2">&quot;*/src/main&quot;</span> -or -path <span class="s2">&quot;*/src/test&quot;</span> <span class="se">\)</span> -exec <span class="nb">echo</span> <span class="o">{}</span> <span class="se">\;</span> -exec mkdir -p <span class="o">{}</span>/<span class="o">{</span>java,resources<span class="o">}</span> <span class="se">\;</span></code></pre></div>

<p>If the pain starts to be too much, come find us on IRC #brooklyncentral or
<a href="http://brooklyn.apache.org/v/0.10.0/community/index.html">elsewhere</a> and we can hopefully share our pearls.
(And if you have a tip we haven’t mentioned please let us know that too!)</p>

<h2 id="internalLink_ide-setup_intellij-idea">IntelliJ IDEA</h2>

<p>To develop or debug Brooklyn in IntelliJ, you will need to ensure that the Groovy and TestNG plugins are installed
via the IntelliJ IDEA | Preferences | Plugins menu. Once installed, you can open Brooklyn from the root folder,
(e.g. <code>~/myfiles/brooklyn</code>) which will automatically open the subprojects.</p>

<p>Brooklyn has informally standardized on arranging <code>import</code> statements as per Eclipse’s default configuration.
IntelliJ’s default configuration is different, which can result in unwanted “noise” in commits where imports are
shuffled backward and forward between the two types - PRs which do this will likely fail the review. To avoid this,
reconfigure IntelliJ to organize imports similar to Eclipse. See <a href="http://stackoverflow.com/a/17194980/68898">this StackOverflow answer</a>
for a suitable configuration.</p>

<h2 id="internalLink_ide-setup_netbeans">Netbeans</h2>

<p>Tips from Netbeans users wanted!</p>

<h2 id="internalLink_ide-setup_debugging-tips">Debugging Tips</h2>

<p>To debug Brooklyn, create a launch configuration which launches the <code>BrooklynJavascriptGuiLauncher</code> class. NOTE: You may
need to add additional projects or folders to the classpath of the run configuration (e.g. add the brooklyn-software-nosql
project if you wish to deploy a MongoDBServer). You will also need to ensure that the working directory is set to the jsgui
folder. For IntelliJ, you can set the ‘Working directory’ of the Run/Debug Configuration to <code>$MODULE_DIR$/../jsgui</code>. For
Eclipse, use the default option of <code>${workspace_loc:brooklyn-jsgui}</code>.</p>

<p>To debug the jsgui (the Brooklyn web console), you will need to build Brooklyn with -DskipOptimization to prevent the build from minifying the javascript.
When building via the command line, use the command <code>mvn clean install -DskipOptimization</code>, and if you are using IntelliJ IDEA, you can add the option
to the Maven Runner by clicking on the Maven Settings icon in the Maven Projects tool window  and adding the <code>skipOptimization</code> property with no value.</p>

<p>When running at the command line you can enable remote connections so that one can attach a debugger to the Java process:
    Run Java with the following on the command line or in JAVA_OPTS: <code>-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005</code></p>

<p>To debug a brooklyn instance that has been run with the above JAVA_OPTS, create a remote build configuration (IntelliJ -
Run | Edit Configurations | + | Remote) with the default options, ensuring the port matches the address specified in JAVA_OPTS.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-code-structure" class="section-breaker section p-">
	<span style="width: 100%"><h1>Code Structure</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Brooklyn is split into the following subprojects:</p>

<ul>
  <li><strong>brooklyn-server</strong>:
    <ul>
      <li><strong>api</strong>: the pure-Java interfaces for interacting with the system</li>
      <li><strong>camp</strong>: the components for a server which speaks with the CAMP REST API and understands the CAMP YAML plan language</li>
      <li><strong>core</strong>: the base class implementations for entities and applications, entity traits, locations, policies, sensor and effector support, tasks, and more</li>
      <li><strong>karaf</strong>: OSGi support</li>
      <li><strong>launcher</strong>: for launching brooklyn, either using a main method or invoked from the cli project</li>
      <li><strong>locations</strong>: specific location integrations
        <ul>
          <li><strong>jclouds</strong>: integration with many cloud APIs and providers via Apache jclouds</li>
        </ul>
      </li>
      <li><strong>logging</strong>: how we enable configurable logging
        <ul>
          <li><strong>logback-includes</strong>: Various helpful logback XML files that can be included; does not contain logback.xml </li>
          <li><strong>logback-xml</strong>: Contains a logback.xml that references the include files in brooklyn-logback-includes</li>
        </ul>
      </li>
      <li><strong>parent</strong>: a meta-project parent to collect dependencies and other maven configuration for re-use  </li>
      <li><strong>policy</strong>: collection of useful policies for automating entity activity</li>
      <li><strong>rest</strong>: supporting the REST API
        <ul>
          <li><strong>rest-api</strong>: The API classes for the Brooklyn REST api</li>
          <li><strong>rest-client</strong>: A client Java implementation for using the Brooklyn REST API </li>
          <li><strong>rest-server</strong>: The server-side implementation of the Brooklyn REST API</li>
        </ul>
      </li>
      <li><strong>server-cli</strong>: implementation of the Brooklyn <em>server</em> command line interface; not to be confused with the client CLI</li>
      <li><strong>software</strong>: support frameworks for creating entities which mainly launch software processes on machines
        <ul>
          <li><strong>base</strong>: software process lifecycle abstract classes and drivers (e.g. SSH) </li>
          <li><strong>winrm</strong>: support for connecting to Windows machines</li>
        </ul>
      </li>
      <li><strong>test-framework</strong>: provides Brooklyn entities for building YAML tests for other entities</li>
      <li><strong>test-support</strong>: provides Brooklyn-specific support for Java TestNG tests, used by nearly all projects in scope <code>test</code>, building on <code>utils/test-support</code></li>
      <li><strong>utils</strong>: projects with lower level utilities
        <ul>
          <li><strong>common</strong>: Utility classes and methods developed for Brooklyn but not dependent on Brooklyn</li>
          <li><strong>groovy</strong>: Groovy extensions and utility classes and methods developed for Brooklyn but not dependent on Brooklyn</li>
          <li><strong>jmx/jmxmp-ssl-agent</strong>: An agent implementation that can be attached to a Java process, to give expose secure JMXMP</li>
          <li><strong>jmx/jmxrmi-agent</strong>: An agent implementation that can be attached to a Java process, to give expose JMX-RMI without requiring all high-number ports to be open</li>
          <li><strong>rest-swagger</strong>: Swagger REST API utility classes and methods developed for Brooklyn but not dependent on Brooklyn</li>
          <li><strong>test-support</strong>: Test utility classes and methods developed for Brooklyn but not dependent on Brooklyn</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>brooklyn-ui</strong>: Javascript web-app for the brooklyn management web console (builds a WAR)</p>
  </li>
  <li><strong>brooklyn-library</strong>: a library of useful blueprints
    <ul>
      <li><strong>examples</strong>: some canonical examples</li>
      <li><strong>qa</strong>: longevity and stress tests</li>
      <li><strong>sandbox</strong>: experimental items</li>
      <li><strong>software</strong>: blueprints for software processes
        <ul>
          <li><strong>webapp</strong>: web servers (JBoss, Tomcat), load-balancers (Nginx), and DNS (Geoscaling) </li>
          <li><strong>database</strong>: relational databases (SQL) </li>
          <li><strong>nosql</strong>: datastores other than RDBMS/SQL (often better in distributed environments) </li>
          <li><strong>messaging</strong>: messaging systems, including Qpid, Apache MQ, RabbitMQ </li>
          <li><strong>monitoring</strong>: monitoring tools, including Monit</li>
          <li><strong>osgi</strong>: OSGi servers </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>brooklyn-docs</strong>: the markdown source code for this documentation</p>
  </li>
  <li><strong>brooklyn-dist</strong>: projects for packaging Brooklyn and making it easier to consume
      * <strong>all</strong>: maven project to supply a shaded JAR (containing all dependencies) for convenience
      * <strong>archetypes</strong>: A maven archetype for easily generating the structure of new downstream projects
      * <strong>dist</strong>: builds brooklyn as a downloadable .zip and .tar.gz
      * <strong>scripts</strong>: various scripts useful for building, updating, etc. (see comments in the scripts)</li>
</ul>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-tests" class="section-breaker section p-">
	<span style="width: 100%"><h1>Tests</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>We have the following tests groups:</p>

<ul>
  <li>normal (i.e. no group) – should run quickly, not need internet, and not side effect the machine (apart from a few /tmp files)          </li>
  <li>Integration – deploys locally, may read and write from internet, takes longer.
    If you change an entity, rerun the relevant integration test to make sure all is well!</li>
  <li>Live – deploys remotely, may provision machines (but should clean up, getting rid of them in a try block)</li>
  <li>Live-sanity – a sub-set of “Live” that can be run regularly; a trade-off of optimal code coverage for the 
time/cost of those tests.</li>
  <li>WIP – short for “work in progress”, this will disable the test from being run by the normal brooklyn maven profiles,
while leaving the test enabled so that one can work on it in IDEs or run the selected test(s) from the command line.</li>
  <li>Acceptance – this (currently little-used) group is for very long running tests, such as soak tests</li>
</ul>

<p>To run these from the command line, use something like the following:</p>

<ul>
  <li>normal: <code>mvn clean install</code></li>
  <li>integration: <code>mvn clean verify -PEssentials,Locations,Entities,Integration -Dmaven.test.failure.ignore=true --fail-never</code></li>
  <li>Live: <code>mvn clean verify -PEntities,Locations,Entities,Live -Dmaven.test.failure.ignore=true --fail-never</code></li>
  <li>Live-sanity: <code>mvn clean verify -PEntities,Locations,Entities,Live-sanity -Dmaven.test.failure.ignore=true --fail-never</code></li>
</ul>

<p>To run a single test, use something like the following:</p>

<ul>
  <li>run a single test class: <code>mvn -Dtest=org.apache.brooklyn.enricher.stock.EnrichersTest -DfailIfNoTests=false test</code></li>
  <li>run a single test method: <code>mvn -Dtest=org.apache.brooklyn.enricher.stock.EnrichersTest#testAdding -DfailIfNoTests=false test</code></li>
</ul>

<!-- TODO describe how to run each of these, as a group, and individually; and profiles -->

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-license-considerations" class="section-breaker section p-">
	<span style="width: 100%"><h1>License Considerations</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>The Apache Software Foundation, quite rightly, place a high standard on code provenance and license compliance. The
Apache license is flexible and compatible with many other types of license, meaning there is generally little problem
with incorporating other open source works into Brooklyn (with GPL being the notable exception). However diligence is
required to ensure that the project is legally sound, and third parties are rightfully credited where appropriate.</p>

<p>This page is an interpretation of the <a href="http://www.apache.org/legal/resolved.html">Apache Legal Previously Asked Questions</a>
page as it specifically applies to the Brooklyn project, such as how we organise our code and the releases that we make.
However this page is not authoritative; if there is any conflict between this page and the Previously Asked Questions or
other Apache Legal authority, they will take precedence over this page.</p>

<p>If you have any doubt, please ask on the Brooklyn mailing list, and/or the Apache Legal mailing list.</p>

<h2 id="internalLink_license-considerations_what-code-licenses-can-we-bundle">What code licenses can we bundle?</h2>

<p>Apache Legal maintains the <a href="http://www.apache.org/legal/resolved.html#category-a">“Category A” list</a>, which is a list
of licenses that are compatible with the Apache License; that is, code under these licenses can be imported into
Brooklyn without violating Brooklyn’s Apache License nor the code’s original license (subject to correctly modifying
the <code>LICENSE</code> and/or <code>NOTICE</code> files; see below).</p>

<p>Apache Legal also maintain the <a href="http://www.apache.org/legal/resolved.html#category-x">“Category X” list</a>. Code licensed
under a Category X license <strong>cannot</strong> be imported into Brooklyn without violating either Brooklyn’s Apache license or
the code’s original license.</p>

<p>There is also a <a href="http://www.apache.org/legal/resolved.html#category-b">“Category B” list</a>, which are licenses that are
compatible with the Apache license only under certain circumstances. In practice, this means that we can declare a
dependency on a library licensed under a Category B license, and bundle the binary build of the library in our binary
builds, but we cannot import its source code into the Brooklyn codebase.</p>

<p>If the code you are seeking to import does not appear on any of these lists, check to see if the license content is the
same as a known license. For example, many projects actually use a BSD license but do not label it as “The BSD License”.
If you are still not certain about the license, please ask on the Brooklyn mailing list, and/or the Apache Legal mailing
list.</p>

<h2 id="internalLink_license-considerations_about-license-and-notice-files">About LICENSE and NOTICE files</h2>

<p>Apache Legal requires that <em>each</em> artifact that the project releases contains a <code>LICENSE</code> and <code>NOTICE</code> file that is
<em>accurate for the contents of that artifact</em>. This means that, potentially, <strong>every artifact that Brooklyn releases may
contain a different <code>LICENSE</code> and <code>NOTICE</code> file</strong>. In practice, it’s not usually that complicated and there are only a
few variations of these files needed.</p>

<p>Furthermore, <em>accurate</em> <code>LICENSE</code> and <code>NOTICE</code> files means that it correctly attributes the contents of the artifact,
and it does not contain anything unnecessary. This provision is what prevents us creating a mega LICENSE file and using
it in every single artifact we release, because in many cases it will contain information that is not relevant to an
artifact.</p>

<p>What is a correct <code>LICENSE</code> and <code>NOTICE</code> file?</p>

<ul>
  <li>A correct <code>LICENSE</code> file is one that contains the text of the licence of any part of the code. The Apache Software
License V2 will naturally be the first part of this file, as it’s the license which we use for all the original code
in Brooklyn. If some <em>Category A</em> licensed third-party code is bundled with this artifact, then the <code>LICENSE</code> file
should identify what the third-party code is, and include a copy of its license. For example, if jquery is bundled
with a web app, the <code>LICENSE</code> file would include a note jquery.js, its copyright and its license (MIT), and include a
full copy of the MIT license.</li>
  <li>A correct <code>NOTICE</code> file contains notices required by bundled third-party code above and beyond that which we have
already noted in <code>LICENSE</code>. In practice modifying <code>NOTICE</code> is rarely required beyond the initial note about Apache
Brooklyn. See <a href="http://www.apache.org/legal/resolved.html#required-third-party-notices">What Are Required Third-party Notices?</a>
for more information</li>
</ul>

<h2 id="internalLink_license-considerations_applying-license-and-notice-files-to-brooklyn">Applying LICENSE and NOTICE files to Brooklyn</h2>

<p>When the Brooklyn project makes a release, we produce and release the following types of artifacts:</p>

<ol>
  <li>One source release artifact</li>
  <li>One binary release artifact</li>
  <li>A large number of Maven release artifacts</li>
</ol>

<p>Therefore, our source release, our binary release, and every one of our Maven release artifacts, must <strong>each</strong> have
their own, individually-tailored, <code>LICENSE</code> and <code>NOTICE</code> files.</p>

<p>To some extent, this is automated, using scripts in <code>usage/dist/licensing</code>;
but this must be manually run, and wherever source code is included or a project has insufficient information in its POM,
you’ll need to add project-specific metadata (with a project-specific <code>source-inclusions.yaml</code> file and/or in the 
dist project’s <code>overrides.yaml</code> file).  See the README.md in that project’s folder for more information.</p>

<h3 id="internalLink_license-considerations_maven-artifacts">Maven artifacts</h3>

<p>Each Maven module will generally produce a JAR file from code under <code>src/main</code>, and a JAR file from code under
<code>src/test</code>. (There are some exceptions which may produce different artifacts.)</p>

<p>If the contents of the module are purely Apache Brooklyn original code, and the outputs are JAR files, then <em>no action
is required</em>. The default build process will incorporate a general-purpose <code>LICENSE</code> and <code>NOTICE</code> file into all built
JAR files. <code>LICENSE</code> will contain just a copy of the Apache Software License v2, and <code>NOTICE</code> will contain just the
module’s own notice fragment.</p>

<p>However you will need to take action if either of these conditions are true:</p>

<ul>
  <li>the module produces an artifact that is <strong>not</strong> a JAR file - for example, the jsgui project produces a WAR file;</li>
  <li>the module bundles third-party code that requires a change to <code>LICENSE</code> and/or <code>NOTICE</code>.</li>
</ul>

<p>In this case you will need to disable the automatic insertion of <code>LICENSE</code> and <code>NOTICE</code> and insert your own versions
instead.</p>

<p>For an example of a JAR file with customized <code>LICENSE</code>/<code>NOTICE</code> files, refer to the <code>usage/cli</code> project.
For an example of a WAR file with customized <code>LICENSE</code>/<code>NOTICE</code> files, refer to the <code>usage/jsgui</code> project.</p>

<h3 id="internalLink_license-considerations_the-source-release">The source release</h3>

<p>In practice, the source release contains nothing that isn’t in the individual produced Maven artifacts (the obvious
difference about it being source instead of binary isn’t relevant). Therefore, the source release <code>LICENSE</code> and <code>NOTICE</code>
can be considered to be the union of every Maven artifact’s <code>LICENSE</code> and <code>NOTICE</code>. The amalgamated files are kept in
the root of the repository.</p>

<h3 id="internalLink_license-considerations_the-binary-release">The binary release</h3>

<p>This is the trickiest one to get right. The binary release includes everything that is in the source and Maven releases,
<strong>plus every Java dependency of the project</strong>. This means that the binary release is pulling in many additional items,
each of which have their own license, and which will therefore impact on <code>LICENSE</code> and <code>NOTICE</code>.</p>

<p>Therefore you must inspect every file that is present in the binary distribution, ascertain its license status, and
ensure that <code>LICENSE</code> and <code>NOTICE</code> are correct.</p>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-miscellaneous-tips-and-tricks" class="section-breaker section p-">
	<span style="width: 100%"><h1>Miscellaneous Tips and Tricks</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_miscellaneous-tips-and-tricks_general-good-ways-of-working">General Good Ways of Working</h2>

<ul>
  <li>
    <p>If working on something which could be contributed to Brooklyn,
do it in a project under the <code>sandbox</code> directory.
This means we can accept pulls more easily (as sandbox items aren’t built as part of the main build)
and speed up collaboration.</p>
  </li>
  <li>
    <p>When debugging an entity, make sure the  <a href="#contentsLink-logging">brooklyn.SSH logger</a> is set to DEBUG and accessible.</p>
  </li>
  <li>
    <p>Use tests heavily!  These are pretty good to run in the IDE (once you’ve completed <a href="#contentsLink-ide-setup">IDE setup</a>),
and far quicker to spot problems than runtime, plus we get early-warning of problems introduced in the future.
(In particular, Groovy’s laxity with compilation means it is easy to introduce silly errors which good test coverage will find much faster.)</p>
  </li>
  <li>
    <p>If you hit inexplicable problems at runtime, try clearing your Maven caches,
or the brooklyn-relevant parts, under <code>~/.m2/repository</code>.
Also note your IDE might be recompiling at the same time as a Maven command-line build,
so consider turning off auto-build.</p>
  </li>
  <li>
    <p>When a class or method becomes deprecated, always include <code>@deprecated</code> in the Javadoc
e.g. “<code>@deprecated since 0.7.0; instead use {@link ...}</code>”</p>
    <ul>
      <li>Include when it was deprecated</li>
      <li>Suggest what to use instead – e.g. link to alternative method, and/or code snippet, etc.</li>
      <li>Consider logging a warning message when a deprecated method or config option is used,
saying who is using it (e.g. useful if deprecated config keys are used in yaml) –
if it’s a method which might be called a lot, some convenience for “warn once per entity” would be helpful)</li>
      <li>See the <a href="https://docs.oracle.com/javase/7/docs/technotes/guides/javadoc/deprecation/deprecation.html">Java deprecation documentation</a></li>
    </ul>
  </li>
</ul>

<p><a name="EntityDesign"></a></p>

<h2 id="internalLink_miscellaneous-tips-and-tricks_entity-design-tips">Entity Design Tips</h2>

<ul>
  <li>
    <p>Look at related entities and understand what they’ve done, in particular which
sensors and config keys can be re-used.
(Many are inherited from interfaces, where they are declared as constants,
e.g. <code>Attributes</code> and <code>UsesJmx</code>.)</p>
  </li>
  <li>
    <p>Understand the location hierarchy:  software process entities typically get an <code>SshMachineLocation</code>,
and use a <code>*SshDriver</code> to do what they need.  This will usually have a <code>MachineProvisioningLocation</code> parent, e.g. a
<code>JcloudsLocation</code> (e.g. AWS eu-west-1 with credentials) or possibly a <code>LocalhostMachineProvisioningLocation</code>.
Clusters will take such a <code>MachineProvisioningLocation</code> (or a singleton list); fabircs take a list of locations.
Some PaaS systems have their own location model, such as <code>OpenShiftLocation</code>.</p>
  </li>
  <li>
    <p>Finally, don’t be shy about <a href="http://brooklyn.apache.org/v/0.10.0/community/index.html">talking with others</a>,
that’s far better than spinning your wheels (or worse, having a bad experience),
plus it means we can hopefully improve things for other people!</p>
  </li>
</ul>

<h2 id="internalLink_miscellaneous-tips-and-tricks_yaml-blueprint-debugging">YAML Blueprint Debugging</h2>

<ul>
  <li>
    <p>Brooklyn will reject any YAML blueprint that contains syntax errors and will alert the user of such errors.</p>
  </li>
  <li>
    <p>However, it is possible to create a blueprint that is syntactically legal but results in runtime problems
for Brooklyn (for example, if an enricher’s <code>enricher.producer</code> value is not immediately resolvable).</p>
  </li>
  <li>
    <p>If Brooklyn appears to freeze after deploying a blueprint, run the <code>jstack &lt;brooklyn-pid&gt;</code> command to view
the state of all running threads. By examining this output, it may become obvious which thread(s) are causing
the problem, and the details of the stack trace will provide insight into which part of the blueprint is
incorrectly written.</p>
  </li>
</ul>

<h2 id="internalLink_miscellaneous-tips-and-tricks_project-maintenance">Project Maintenance</h2>

<ul>
  <li>
    <p>Adding a new project may need updates to <code>/pom.xml</code> <code>modules</code> section and <code>usage/all</code> dependencies</p>
  </li>
  <li>
    <p>Adding a new example project may need updates to <code>/pom.xml</code> and <code>/examples/pom.xml</code> (and the documentation too!)</p>
  </li>
</ul>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-logging" class="section-breaker section p-">
	<span style="width: 100%"><h1>Logging</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_logging_logging-a-quick-overview">Logging: A Quick Overview</h2>

<p>For logging, we use <strong>logback</strong> which implements the slf4j API.
This means you can use any slf4j compliant logging framework,
with a default configuration which just works out of the box
and bindings to the other common libraries (<code>java.util.logging</code>, <code>log4j</code>, …)
if you prefer one of those.</p>

<p>To use:</p>

<ul>
  <li>
    <p><strong>Users</strong>:
If using a brooklyn binary installation, simply edit the <code>logback.xml</code>
or <code>logback-custom.xml</code> supplied in the archive, sometimes in a <code>conf/</code>
directory.</p>
  </li>
  <li>
    <p><strong>Developers</strong>:
When setting up a new project, if you want logging it is recommended to include 
the <code>brooklyn-logback-xml</code> project as an <em>optional</em> and <em>provided</em> maven dependency, 
and then to put custom logging configuration in either <code>logback-custom.xml</code> or <code>logback-main.xml</code>, 
as described below.</p>
  </li>
</ul>

<h2 id="internalLink_logging_customizing-your-logging">Customizing Your Logging</h2>

<p>The project <code>brooklyn-logback-xml</code> supplies a <code>logback.xml</code> configuration,
with a mechanism which allows it to be easily customized, consumed, and overridden.
You may wish to include this as an <em>optional</em> dependency so that it is not forced
upon downstream projects.  This <code>logback.xml</code> file supplied contains just one instruction,
to include <code>logback-main.xml</code>, and that file in turn includes:</p>

<ul>
  <li><code>logback-custom.xml</code></li>
  <li><code>brooklyn/logback-appender-file.xml</code></li>
  <li><code>brooklyn/logback-appender-stdout.xml</code></li>
  <li><code>brooklyn/logback-logger-excludes.xml</code></li>
  <li><code>brooklyn/logback-debug.xml</code></li>
</ul>

<p>For the most common customizations, simply create a <code>logback-custom.xml</code> on your classpath
(ensuring it is loaded <em>before</em> brooklyn classes in classpath ordering in the pom)
and supply your customizations there:  </p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;included&gt;</span>
    <span class="c">&lt;!-- filename to log to --&gt;</span>           
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;logging.basename&quot;</span> <span class="na">scope=</span><span class="s">&quot;context&quot;</span> <span class="na">value=</span><span class="s">&quot;acme-app&quot;</span> <span class="nt">/&gt;</span>
    
    <span class="c">&lt;!-- additional loggers --&gt;</span>
    <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;com.acme.app&quot;</span> <span class="na">level=</span><span class="s">&quot;DEBUG&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/included&gt;</span></code></pre></div>

<p>For other configuration, you can override individual files listed above.
For example:</p>

<ul>
  <li>To remove debug logging, create a trivial <code>brooklyn/logback-debug.xml</code>, 
containing simply <code>&lt;included/&gt;</code>.</li>
  <li>To customise stdout logging, perhaps to give it a threshhold WARN instead of INFO,
create a <code>brooklyn/logback-appender-stdout.xml</code> which defines an appender STDOUT.</li>
  <li>To discard all brooklyn’s default logging, create a <code>logback-main.xml</code> which 
contains your configuration. This should look like a standard logback
configuration file, except it should be wrapped in <code>&lt;included&gt;</code> XML tags rather
than <code>&lt;configuration&gt;</code> XML tags (because it is included from the <code>logback.xml</code>
which comes with <code>brooklyn-logback-xml</code>.)</li>
  <li>To redirect all jclouds logging to a separate file include <code>brooklyn/logback-logger-debug-jclouds.xml</code>.
This redirects all logging from <code>org.jclouds</code> and <code>jclouds</code> to one of two files: anything
logged from Brooklyn’s persistence thread will end up in a <code>persistence.log</code>, everything else
will end up in <code>jclouds.log</code>.</li>
</ul>

<p>You should <strong>not</strong> supply your own <code>logback.xml</code> if you are using <code>brooklyn-logback-xml</code>.
If you do, logback will detect multiple files with that name and will scream at you.
If you wish to supply your own <code>logback.xml</code>, do <strong>not</strong> include <code>brooklyn-logback-xml</code>.
(Alternatively you can include a <code>logback.groovy</code> which causes logback to ignore <code>logback.xml</code>.)</p>

<p>You can set a specific logback config file to use with:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">-Dlogback.configurationFile<span class="o">=</span>/path/to/config.xml</code></pre></div>

<h2 id="internalLink_logging_assemblies">Assemblies</h2>

<p>When building an assembly, it is recommended to create a <code>conf/logback.xml</code> which 
simply includes <code>logback-main.xml</code> (which comes from the classpath).  Users of the assembly
can then edit the <code>logback.xml</code> file in the usual way, or they can plug in to the configuration 
mechanisms described above, by creating files such as <code>logback-custom.xml</code> under <code>conf/</code>.</p>

<p>Including <code>brooklyn-logback-xml</code> as an <em>optional</em> and <em>provided</em> dependency means everything
should work correctly in IDE’s but it will not include the extra <code>logback.xml</code> file in the assembly.
(Alternatively if you include the <code>conf/</code> dir in your IDE build, you should exclude this dependency.)</p>

<p>With this mechanism, you can include <code>logback-custom.xml</code> and/or other files underneath 
<code>src/main/resources/</code> of a project, as described above (for instance to include custom
logging categories and define the log file name) and it should get picked up, 
both in the IDE and in the assembly.   </p>

<h2 id="internalLink_logging_tests">Tests</h2>

<p>Brooklyn projects <code>test</code> scope includes the <code>brooklyn-utils-test-support</code> project
which supplies a <code>logback-test.xml</code>. logback uses this file in preference to <code>logback.xml</code>
when available (ie when running tests). However the <code>logback-test.xml</code> Brooklyn uses
includes the same <code>logback-main.xml</code> call path above, so your configurations should still work.</p>

<p>The only differences of the <code>logback-test.xml</code> configuration is that:</p>

<ul>
  <li>Debug logging is included for all Brooklyn packages</li>
  <li>The log file is called <code>brooklyn-tests.log</code> </li>
</ul>

<h2 id="internalLink_logging_caveats">Caveats</h2>

<ul>
  <li>
    <p>logback uses SLF4J version 1.6 which is <strong>not compatible</strong> with 1.5.x. 
If you have dependent projects using 1.5.x (such as older Grails) things may break.</p>
  </li>
  <li>
    <p>If you’re not getting the logging you expect in the IDE, make sure 
<code>src/main/resources</code> is included in the classpath.
(In eclipse, right-click the project, the Build Path -&gt; Configure,
then make sure all dirs are included (All) and excluded (None) – 
<code>mvn clean install</code> should do this for you.)</p>
  </li>
  <li>
    <p>You may find that your IDE logs to a file <code>brooklyn-tests.log</code> 
if it doesn’t distinguish between test build classpaths and normal classpaths.</p>
  </li>
  <li>
    <p>Logging configuration using file overrides such as this is very sensitive to
classpath order. To get a separate <code>brooklyn-tests.log</code> file during testing,
for example, the <code>brooklyn-test-support</code> project with scope <code>test</code> must be
declared as a dependency <em>before</em> <code>brooklyn-logback-includes</code>, due to the way
both files declare <code>logback-appender-file.xml</code>.</p>
  </li>
  <li>
    <p>Similarly note that the <code>logback-custom.xml</code> file is included <em>after</em> 
logging categories and levels are declared, but before appenders are declared,
so that logging levels declared in that file dominate, and that 
properties from that file apply to appenders.</p>
  </li>
  <li>
    <p>Finally remember this is open to improvement. It’s the best system we’ve found
so far but we welcome advice. In particular if it could be possible to include
files from the classpath with wildcards in alphabetical order, we’d be able
to remove some of the quirks listed above (though at a cost of some complexity!).</p>
  </li>
</ul>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-brooklyn-remote-debugging" class="section-breaker section p-">
	<span style="width: 100%"><h1>Brooklyn Remote Debugging</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Usually during development, you will be running Brooklyn from your IDE (see <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/dev/tips/../env/ide/index.html">IDE Setup</a>), in which case
debugging is as simple as setting a breakpoint. There may however be times when you need to debug an existing remote
Brooklyn instance (often referred to as Resident Brooklyn, or rBrooklyn) on another machine, usually in the cloud.</p>

<p>Thankfully, the tools are available to do this, and setting it up is quite straightforward. The steps are as follows:</p>

<ul>
  <li><a href="#internalLink_brooklyn-remote-debugging_sourceCodeVersion">Getting the right source code version</a></li>
  <li><a href="#internalLink_brooklyn-remote-debugging_startingBrooklyn">Starting Brooklyn with a debug listener</a></li>
  <li><a href="#internalLink_brooklyn-remote-debugging_sshTunnel">Creating an SSH tunnel</a></li>
  <li><a href="#internalLink_brooklyn-remote-debugging_connectingIDE">Connecting your IDE</a></li>
</ul>

<h2 id="internalLink_brooklyn-remote-debugging_a-namesourcecodeversionagetting-the-right-source-code-version"><a name="sourceCodeVersion"></a>Getting the right source code version</h2>
<p>The first step is to ensure that your local copy of the source code is at the version used to build the remote Brooklyn
instance. The git commit that was used to build Brooklyn is available via the REST API:</p>

<pre><code>http://&lt;remote-address&gt;:&lt;remote-port&gt;/v1/server/version
</code></pre>

<p>This should return details of the build as a JSON string similar to the following (formatted for clarity):</p>

<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;0.12.0-SNAPSHOT&quot;</span><span class="p">,</span>  
    <span class="nt">&quot;buildSha1&quot;</span><span class="p">:</span> <span class="s2">&quot;c0fdc15291702281acdebf1b11d431a6385f5224&quot;</span><span class="p">,</span>
    <span class="nt">&quot;buildBranch&quot;</span><span class="p">:</span> <span class="s2">&quot;UNKNOWN&quot;</span>
<span class="p">}</span></code></pre></div>

<p>The value that we’re interested in is <code>buildSha1</code>. This is the git commit that was used to build Brooklyn. We can now
checkout and build the Brooklyn code at this commit by running the following in the root of your Brooklyn repo:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">% git checkout c0fdc15291702281acdebf1b11d431a6385f5224
% mvn clean install -DskipTests</code></pre></div>

<p>Whilst building the code isn’t strictly necessary, it can help prevent some IDE issues.</p>

<h2 id="internalLink_brooklyn-remote-debugging_a-namestartingbrooklynastarting-brooklyn-with-a-debug-listener"><a name="startingBrooklyn"></a>Starting Brooklyn with a debug listener</h2>
<p>By default, Brooklyn does not listen for a debugger to be attached, however this behaviour can be set by setting JAVA_OPTS,
which will require a restart of the Brooklyn node. To do this, SSH to the remote Brooklyn node and run the following in the
root of the Brooklyn installation:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># NOTE: Running this kill command will lose existing apps and machines if persistence is disabled.</span>
% <span class="nb">kill</span> <span class="sb">`</span>cat pid_java<span class="sb">`</span>
% <span class="nb">export </span><span class="nv">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;-Xms256m -Xmx1g -XX:MaxPermSize=256m -agentlib:jdwp=transport=dt_socket,address=127.0.0.1:8888,server=y,suspend=n&quot;</span>
% bin/brooklyn launch <span class="p">&amp;</span></code></pre></div>

<p>If <code>JAVA_OPTS</code> is not set, Brooklyn will automatically set it to <code>"-Xms256m -Xmx1g -XX:MaxPermSize=256m"</code>, which is why
we have prepended the agentlib settings with these values here.</p>

<p>You should see the following in the console output:</p>

<pre><code>Listening for transport dt_socket at address: 8888
</code></pre>

<p>This will indicate the Brooklyn is listening on port 8888 for a debugger to be attached.</p>

<h2 id="internalLink_brooklyn-remote-debugging_a-namesshtunnelacreating-an-ssh-tunnel"><a name="sshTunnel"></a>Creating an SSH tunnel</h2>

<p>If port 8888 is accessible on the remote Brooklyn server, then you can skip this step and simply use the address of the
server in place of 127.0.0.1 in the <a href="#internalLink_brooklyn-remote-debugging_connectingIDE">Connecting your IDE</a> section below. It will normally be possible to
make the port accessible by configuring Security Groups, iptables, endpoints etc., but for a quick ad-hoc connection it’s
usually simpler to create an SSH tunnel. This will create an open SSH connection that will redirect traffic from a port
on a local interface via SSH to a port on the remote machine. To create the tunnel, run the following on your local
machine:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># replace this with the address or IP of the remote Brooklyn node</span>
<span class="nv">REMOTE_HOST</span><span class="o">=</span>&lt;remote-address&gt;
<span class="c"># if you wish to use a different port, this value must match the port specified in the JAVA_OPTS</span>
<span class="nv">REMOTE_PORT</span><span class="o">=</span><span class="m">8888</span> 
<span class="c"># if you wish to use a different local port, this value must match the port specified in the IDE configuration</span>
<span class="nv">LOCAL_PORT</span><span class="o">=</span><span class="m">8888</span> 
<span class="c"># set this to the login user you use to SSH to the remote Brooklyn node</span>
<span class="nv">SSH_USER</span><span class="o">=</span>root 
<span class="c"># The private key file used to SSH to the remote node. If you use a password, see the alternative command below</span>
<span class="nv">PRIVATE_KEY_FILE</span><span class="o">=</span>~/.ssh/id_rsa 

% ssh -YNf -i <span class="nv">$PRIVATE_KEY_FILE</span> -l <span class="nv">$SSH_USER</span> -L <span class="nv">$LOCAL_PORT</span>:127.0.0.1:<span class="nv">$REMOTE_PORT</span> <span class="nv">$REMOTE_HOST</span></code></pre></div>

<p>If you use a password to SSH to the remote Brooklyn node, simply remove the <code>-i $PRIVATE_KEY_FILE</code> section like so:</p>

<pre><code>ssh -YNf -l $SSH_USER -L $LOCAL_PORT:127.0.0.1:$REMOTE_PORT $REMOTE_HOST
</code></pre>

<p>If you are using a password to connect, you will be prompted to enter your password to connect to the remote node upon
running the SSH command.</p>

<p>The SSH tunnel should now be redirecting traffic from port 8888 on the local 127.0.0.1 network interface via the SSH 
tunnel to port 8888 on the remote 127.0.0.1 interface. It should now be possible to connect the debugger and start
debugging.</p>

<h2 id="internalLink_brooklyn-remote-debugging_a-nameconnectingidea-connecting-your-ide"><a name="connectingIDE"></a> Connecting your IDE</h2>

<p>Setting up your IDE will differ depending upon which IDE you are using. Instructions are given here for Eclipse and
IntelliJ, and have been tested with Eclipse Luna and IntelliJ Ultimate 14.</p>

<h3 id="internalLink_brooklyn-remote-debugging_eclipse-setup">Eclipse Setup</h3>

<p>To debug using Eclipse, first open the Brooklyn project in Eclipse (see <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/dev/tips/../env/ide/index.html">IDE Setup</a>).</p>

<p>Now create a debug configuration by clicking <code>Run</code> | <code>Debug Configurations...</code>. You will then be presented with the 
Debug Configuration dialog.</p>

<p>Select <code>Remote Java Application</code> from the list and click the ‘New’ button to create a new configuration. Set the name
to something suitable such as ‘Remote debug on 8888’. The Project can be set to any of the Brooklyn projects, the 
Connection Type should be set to ‘Standard (Socket Attach)’. The Host should be set to either localhost or 127.0.0.1
and the Port should be set to 8888. Click ‘Debug’ to start debugging.</p>

<h3 id="internalLink_brooklyn-remote-debugging_intellij-setup">IntelliJ Setup</h3>

<p>To debug using IntelliJ, first open the Brooklyn project in IntelliJ (see <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/dev/tips/../env/ide/index.html">IDE Setup</a>).</p>

<p>Now create a debug configuration by clicking <code>Run</code> | <code>Edit Configurations</code>. You will then be presented with the
Run/Debug Configurations dialog.</p>

<p>Click on the <code>+</code> button and select ‘Remote’ to create a new remote configuration. Set the name to something suitable
such as ‘Remote debug on 8888’. The first three sections simply give the command line arguments for starting the java
process using different versions of java, however we have already done this in 
<a href="#internalLink_brooklyn-remote-debugging_startingBrooklyn">Starting Brooklyn with a debug listener</a>. The Transport option should be set to ‘Socket’, the Debugger Mode should be set to ‘Attach’, the
Host should be set to localhost or 127.0.0.1 (or the address of the remote machine if you are not using an SSH tunnel),
and the Port should be set to 8888. The ‘Search sources’ section should be set to <code>&lt;whole project&gt;</code>. Click OK to save the
configuration, then select the configuration from the configurations drop-down and click the debug button to start
debugging.</p>

<h3 id="internalLink_brooklyn-remote-debugging_testing">Testing</h3>

<p>The easiest way to test that remote debugging has been setup correctly is to set a breakpoint and see if it is hit. An
easy place to start is to create a breakpoint in the <code>ServerResource.java</code> class, in the <code>getStatus()</code> 
method. </p>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	  
	 

 
	    
	     
	     

	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-glossary" class="section-breaker section p-">
	<span style="width: 100%"><h1>Glossary</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	
<h4 id="internalLink_glossary_autonomic">Autonomic</h4>

<p>Refers to the self-managing characteristics of distributed computing resources,
adapting to unpredictable changes while hiding intrinsic complexity to
operators and users.</p>

<h4 id="internalLink_glossary_blueprint">Blueprint</h4>

<p>A description of an application or system, which can be used for its automated
deployment and runtime management. The blueprint describes a model of the
application (i.e. its components, their configuration, and their
relationships), along with policies for runtime management. The blueprint can
be described in <a href="#internalLink_glossary_yaml">YAML</a>.</p>

<h6 id="internalLink_glossary_see-also">See also</h6>
<ul>
  <li><a href="#contentsLink-catalog">Documentation</a> for the entity,
policy and enricher blueprints that Apache Brooklyn supports out-of-the-box.</li>
</ul>

<h4 id="internalLink_glossary_effector">Effector</h4>

<p>An operation on an <a href="#internalLink_glossary_entity">entity</a>.</p>

<h4 id="internalLink_glossary_enricher">Enricher</h4>

<p>Generates new events or <a href="#internalLink_glossary_sensor">sensor</a> values (metrics) for an entity, usually by aggregating 
or modifying data from one or more other sensors.</p>

<h4 id="internalLink_glossary_entity">Entity</h4>

<p>A component of an application or system. This could be a physical component, a
service, a grouping of components, or a logical construct describing part of an
application/system. It is a “managed element” in autonomic computing parlance.</p>

<h4 id="internalLink_glossary_policy">Policy</h4>

<p>Part of an autonomic management system, performing runtime management. A policy
is associated with an <a href="#internalLink_glossary_entity">entity</a>; it normally manages the health of that entity
or an associated group of entities (e.g. HA policies or auto-scaling policies).</p>

<h4 id="internalLink_glossary_sensor">Sensor</h4>

<p>An attribute of an <a href="#internalLink_glossary_entity">entity</a>.</p>

<h4 id="internalLink_glossary_yaml">YAML</h4>

<p>A human-readable data format.</p>

<h6 id="internalLink_glossary_see-also-1">See also</h6>
<ul>
  <li><a href="http://en.wikipedia.org/wiki/YAML">Wikipedia article</a> on YAML</li>
</ul>

<h4 id="internalLink_glossary_apache-jclouds">Apache jclouds</h4>

<p>An open source Java library that provides a consistent interface to many
clouds. Apache Brooklyn uses Apache jclouds as its core cloud abstraction.</p>

<h6 id="internalLink_glossary_see-also-2">See also</h6>
<ul>
  <li><a href="https://jclouds.apache.org/">Project homepage</a></li>
</ul>

<h4 id="internalLink_glossary_camp-and-tosca">CAMP and TOSCA</h4>

<p>OASIS Cloud Application Management for Platforms (CAMP) and OASIS Topology and
Orchestration Specification for Cloud Applications (TOSCA) are specifications
that aim to standardise the portability and management of cloud applications.</p>

<h6 id="internalLink_glossary_see-also-3">See also</h6>
<ul>
  <li><a href="https://www.oasis-open.org/committees/tc_home.php?wg_abbrev=camp">CAMP homepage</a></li>
  <li><a href="https://www.oasis-open.org/committees/tc_home.php?wg_abbrev=tosca">TOSCA homepage</a></li>
</ul>


	</div>
	 
	  
	 

 
	    
	     
	     

	    
	     
	     

	    
	    
	  
	 

 
	    
	    
	  
	 

 
    
		
		

    
		
		

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-developers" class="section-breaker section p-">
	<span style="width: 100%"><h1>Developers</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Hello developers!
These pages are aimed at people who want to get involved with reading, changing, testing and otherwise
working with the bleeding edge Brooklyn code.</p>

<div class="panel panel-danger">
<div class="panel-heading">
    <h4 id="internalLink_developers_caution">Caution</h4>
  </div>
<div class="panel-body">
    <p>As these pages contain information about accessing the bleeding edge code and artifacts produced from it,
you should be aware that the code and binaries you will encounter may be unstable.
The Apache Software Foundation has not performed the level of validation and due diligence done 
on formally released artifacts. 
Proceed only if you understand the potential consequences of using unreleased code
and are comfortable doing so.</p>
  </div>
</div>

<p>We heartily welome contributions and new members.
There’s nothing official needed to get involved; 
simply come say hello somewhere in the <a href="http://brooklyn.apache.org/v/0.10.0/developers/../community/index.html">community</a>:</p>

<ul>
  <li><a href="http://brooklyn.apache.org/v/0.10.0/developers/../community/mailing-lists.html">Mailing lists</a></li>
  <li><a href="http://brooklyn.apache.org/v/0.10.0/developers/../community/irc.html">IRC channel</a></li>
  <li><a href="https://issues.apache.org/jira/browse/BROOKLYN">JIRA for bug tracking</a></li>
</ul>

<p>Then <a href="#contentsLink-get-the-code">get the code</a>.</p>

<p>When you have a blueprint or an improvement you want to share, 
there are a few instructions to note on <a href="#contentsLink-how-to-contribute">how to contribute</a>.</p>

<p>If you’re looking to learn more about the codebase itself, 
have a look at <a href="#contentsLink-developer-guide">Developer Guide</a>.
There are also a number of <a href="#contentsLink-handy-places">development bookmarks</a> for the tools we use
(git, jenkins, jira).</p>

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-get-the-code" class="section-breaker section p-">
	<span style="width: 100%"><h1>Get the Code</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_get-the-code_the-basics">The Basics</h2>

<p>The Apache Brooklyn source code is available at <a href="http://github.com/apache/brooklyn">GitHub apache/brooklyn</a>,
together with many <a href="https://github.com/apache?query=brooklyn"><code>brooklyn-*</code> sub-module projects</a>.
Checkout and build all the submodules with:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">git clone http://github.com/apache/brooklyn/
<span class="nb">cd </span>brooklyn
git submodule init
git submodule update --remote --merge --recursive
git submodule foreach <span class="s1">&#39;git checkout master&#39;</span>

mvn clean install</code></pre></div>

<p>This will produce an artifact in <code>brooklyn-dist/dist/brooklyn-dist-0.12.0-SNAPSHOT-dist.tar.gz</code> <!-- BROOKLYN_VERSION -->
which you can use <a href="http://brooklyn.apache.org/v/0.10.0/v/latest/start/running.html">in the usual way</a>.
Some options which may be useful:</p>

<ul>
  <li>Use <code>--depth 1</code> with <code>git clone</code> to skip the history (much faster but your <code>git log</code> will be incomplete)</li>
  <li>Use <code>-DskipTests</code> with <code>mvn</code> to skip tests (again much faster but it won’t catch failures)</li>
  <li>See below if you don’t want to use submodules</li>
</ul>

<p>Thereafter to update the code in submodules, we strongly recommend doing this:</p>

<pre><code>git pull &amp;&amp; git submodule update --remote --merge --recursive
</code></pre>

<p>This merges the latest upstream changes into the current branch of each sub-module on your local machine,
giving nice errors on conflicts.
It’s fine also to do branching and pulling in each submodule,
but running <code>update</code> without these parameters can cause chaos!
This <a href="#contentsLink-get-the-code">page</a> elaborates on potential chaos and pitfalls,
and it provides instructions for setting up an alias <code>git sup</code> for this command.</p>

<h3 id="internalLink_get-the-code_if-you-cant-stand-submodules">If You Can’t Stand Submodules</h3>

<p><a href="#contentsLink-get-the-code">These instructions</a> can help setting up a local environment
which does not rely on submodules.</p>

<h3 id="internalLink_get-the-code_contributing-a-small-change">Contributing a Small Change</h3>

<p>If you’re making a small change in one project, consider just using that project.
Whether you use this uber-project or not, to <a href="http://brooklyn.apache.org/v/0.10.0/developers/code/../how-to-contribute.html">contribute</a> 
you’ll need to follow the usual fork-&gt;work-&gt;push-&gt;pull-request process.</p>

<p>To understand where you might want to make your change,
look at the <a href="#contentsLink-code-structure">code structure</a>.</p>

<h3 id="internalLink_get-the-code_bigger-and-regular-changes">Bigger and Regular Changes</h3>

<p>Regular contributors will typically have their own fork for each of the submodule projects,
and will probably want some other settings and tips <a href="#contentsLink-get-the-code">as described here</a>.</p>

<h2 id="internalLink_get-the-code_next-steps">Next Steps</h2>

<ul>
  <li>
    <p>See the <a href="#contentsLink-get-the-code">detailed Brooklyn &amp; Git guide</a> to 
<a href="#contentsLink-get-the-code">set up forks</a> or <a href="#contentsLink-get-the-code">handy git aliases</a></p>
  </li>
  <li>
    <p>Visit the <a href="#contentsLink-developer-guide">Developer Guide</a> has information on 
<a href="#contentsLink-code-structure">project structure</a>,
<a href="#contentsLink-maven-build">Maven setup</a> and more</p>
  </li>
  <li>
    <p>Review <a href="http://brooklyn.apache.org/v/0.10.0/developers/code/../how-to-contribute.html">How to Contribute</a> 
to <a href="http://brooklyn.apache.org/v/0.10.0/developers/code/../how-to-contribute.html">file your CLA</a>
or 
<a href="#contentsLink-code-structure">project structure</a>,
<a href="#contentsLink-maven-build">Maven setup</a> and more</p>
  </li>
</ul>

<p>Where things aren’t documented <strong>please ask us</strong> at 
<a href="https://mail-archives.apache.org/mod_mbox/brooklyn-dev/">the brooklyn mailing list</a>
so we can remedy this!</p>

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-how-to-contribute" class="section-breaker section p-">
	<span style="width: 100%"><h1>How to Contribute</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Welcome and thank you for your interest in contributing to Apache Brooklyn! This guide will take you through the
process of making contributions to the Apache Brooklyn code base.</p>

<div class="panel panel-info">
<div class="panel-heading">
    <h4 id="internalLink_how-to-contribute_tldr">TL;DR</h4>
  </div>
<div class="panel-body">

    <ul>
      <li>Pull request to the relevant <a href="http://github.com/apache/?query=brooklyn">GitHub</a> project</li>
      <li>Sign the <a href="https://www.apache.org/licenses/#clas">Apache CLA</a> if it’s non-trivial.</li>
      <li>For bigger changes, open a <a href="https://issues.apache.org/jira/browse/BROOKLYN">Jira</a>
 and/or <a href="http://brooklyn.apache.org/v/0.10.0/developers/../community/mailing-lists.html">email the list</a>.</li>
    </ul>

  </div>
</div>

<h3 id="internalLink_how-to-contribute_contributor-license-agreement">Contributor License Agreement</h3>

<p>Apache Brooklyn is licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>. All
contributions will be under this license, so please read and understand this license before contributing.</p>

<p>For all but the most trivial patches, <strong>we need a Contributor License Agreement for you</strong> on file with the Apache
Software Foundation. Please read the <a href="https://www.apache.org/licenses/#clas">guide to CLAs</a> to find out how to file a
CLA with the Foundation.</p>

<h3 id="internalLink_how-to-contribute_join-the-community">Join the Community</h3>

<p>If it’s your first contribution or it’s a particularly big or complex contribution, things typically go much more
smoothly when they start off with a conversation. 
Significant changes are normally discussed on the mailing list in any case,
sometimes with a <a href="https://drive.google.com/drive/#folders/0B3XurVLRa7pIUHNFV3NuVVRkRlE/0B3XurVLRa7pIblN4NGRNN2dYUGM/0B3XurVLRa7pIMlZQSUxrdTh4Wmc">feature proposal</a> document.</p>

<p>Visit our <a href="#contentsLink-developers">Community</a> page to see how to contact Brooklyners via IRC or email.</p>

<h3 id="internalLink_how-to-contribute_create-an-issue-in-jira">Create an Issue in Jira</h3>

<p>The first step is usually to create or find an issue in <a href="https://issues.apache.org/jira/browse/BROOKLYN">Brooklyn’s Jira</a>
for your feature request or fix. For small changes this isn’t necessary, but it’s good to see if your change fixes an
existing issue anyway.</p>

<h3 id="internalLink_how-to-contribute_pull-request-at-github">Pull Request at GitHub</h3>

<p>This is our preferred way for contributing code. Our root GitHub repository is located at
<a href="https://github.com/apache/brooklyn">https://github.com/apache/brooklyn</a> with most of the code in one of the subprojects.
You can checkout and PR against just one of the projects listed there. See the README in our root repository for information on subprojects.</p>

<p>Your commit messages must properly describes the changes that have been made and their purpose
(<a href="http://tbaggery.com/2008/04/19/a-note-about-git-commit-messages.html">here are some guidelines</a>). If your
contributions fix a Jira issue, then ensure that you reference the issue (like <code>BROOKLYN-9876</code>) in the commit message.</p>

<p>Create a pull request (PR) in GitHub for the change you’re interested in making.
Include a link to the Jira issue (if it has one) in the PR comment as well as the commit message.</p>

<p>Some good references for working with GitHub are below.  </p>

<ul>
  <li><a href="https://help.github.com/articles/set-up-git">Setting Up Git with GitHub</a></li>
  <li><a href="https://help.github.com/articles/fork-a-repo">Forking a Repository</a></li>
  <li><a href="https://help.github.com/articles/using-pull-requests">Submitting Pull Requests</a></li>
  <li><a href="https://help.github.com/articles/interactive-rebase">Rebasing your Branch</a></li>
</ul>

<p>Finally, add a comment in the Jira issue with a link to the pull request so we know the code is ready to be reviewed.</p>

<h3 id="internalLink_how-to-contribute_the-review-process">The Review Process</h3>

<p>The Apache Brooklyn community will review your pull request before it is merged. 
If we are slow to respond, please feel free to post a reminder to the PR, Jira issue, IRC channel
or mailing list – see the <a href="http://brooklyn.apache.org/v/0.10.0/developers/../community/index.html">Community</a> page to see how to contact us.</p>

<p>During the review process you may be asked to make some changes to your submission. While working through feedback,
it can be beneficial to create new commits so the incremental change is obvious.  This can also lead to a complex set
of commits, and having an atomic change per commit is preferred in the end.  Use your best judgement and work with
your reviewer as to when you should revise a commit or create a new one.</p>

<p>You may also get automated messages on the pull request from the CI running tests
or GitHub determining whether a PR can be merged.
Please keep these up to date to aid reviewers.</p>

<p>A pull request is considered ready to be merged once it gets at lease one +1 from a committer.
At this point your code will be included in the latest Apache Brooklyn.
Congratulations and thank you!</p>

<h3 id="internalLink_how-to-contribute_contributing-without-using-github">Contributing without using GitHub</h3>

<p>If you prefer to not use GitHub, then that is fine - we are also happy to accept patches attached to a Jira issue.
Our canonical root repository is located at <code>https://git-wip-us.apache.org/repos/asf/brooklyn.git</code> with others
in <code>brooklyn-*.git</code>; for example:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>git clone https://git-wip-us.apache.org/repos/asf/brooklyn-server.git</code></pre></div>

<p>When producing patches, please use <code>git format-patch</code> or a similar mechanism - this will ensure that you are properly
attributed as the author of the patch when a committer merges it.
The review process will be as with pull requests, except for comments only appearing on the Jira issue.</p>

<h3 id="internalLink_how-to-contribute_handy-places">Handy Places</h3>

<p>If you’ve not done so, you’ll probably want to start by <a href="#contentsLink-get-the-code">getting the code</a>.
Once you’ve done that, you’ll find <a href="#contentsLink-handy-places">handy development bookmarks here</a>.</p>

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-committer-guide" class="section-breaker section p-">
	<span style="width: 100%"><h1>Committer Guide</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>These pages contain information that is relevant to people with “committer” status in our project.</p>

<div class="list-children"><ul>

<li> <a href="#contentsLink-merging-contributed-code">Merging Contributed Code</a> </li>

<li> <a href="#contentsLink-release-process">Release Process</a> </li>

</ul></div>

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-merging-contributed-code" class="section-breaker section p-">
	<span style="width: 100%"><h1>Merging Contributed Code</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>The Apache Brooklyn Git repositories are hosted in the ASF infrastructure and mirrored to Github. This is the current
repository layout:</p>

<ul>
  <li><a href="https://git-wip-us.apache.org/repos/asf?s=brooklyn">Apache</a> - the main and official repository</li>
  <li><a href="https://github.com/apache/brooklyn">GitHub</a> - mirror of the ASF repository, used to accept contributions
and do code reviews</li>
</ul>

<h2 id="internalLink_merging-contributed-code_before">Before</h2>

<p>For everything except the most trivial changes, the submitter must have a CLA on file. Check the <a href="https://people.apache.org/committer-index.html">list of Apache
committers, and non-commiters with ICLAs on record</a> and prompt the
contributor to file an appropriate CLA if required.</p>

<p>For all significant changes, there must be a Jira issue. If a Jira issue is not referenced in the PR and/or commit
messages, prompt the contributor to open a Jira issue.</p>

<h2 id="internalLink_merging-contributed-code_rules-of-thumb">Rules of thumb</h2>

<ol>
  <li>Every contribution is a piece of intellectual property.  This is the precious sustenance that nourishes our
project.  Please treat it with respect.</li>
  <li>Always give credit where it is due, ensure every merged commit reflects properly the individual who authored that
commit.  Preserve both the name and email address.</li>
  <li>Ensure your name and email address are there as the committer prior to pushing it to the Apache repositories.</li>
  <li>Always strive for linear commit history, avoid merge commits while pulling in contributor’s changes.</li>
</ol>

<h2 id="internalLink_merging-contributed-code_setting-up-your-repository">Setting up your repository</h2>

<p>Follow <a href="http://brooklyn.apache.org/v/0.10.0/developers/committers/../code/git-more.html">these instructions</a> to configure your local repositories.
Make sure the canonical ASF repo is enabled as that is where you’ll need to push to merge changes,
and that you are able to fetch pull-requests.</p>

<p>Once that is done, run <code>git fetch --all</code> to update from all remote repositories - you will see all the pull requests appear:</p>

<pre><code>* [new ref]         refs/pull/98/head -&gt; upstream/pr/1234
* [new ref]         refs/pull/99/head -&gt; upstream/pr/1235
</code></pre>

<h2 id="internalLink_merging-contributed-code_merging-a-pull-request">Merging a pull request</h2>

<p>Fetch the latest remote branches, which will cause a remote branch for the PR to become available to you.</p>

<pre><code>git fetch --all
</code></pre>

<p>If you want to inspect a particular PR and/or run tests, check out the branch:</p>

<pre><code>git checkout upstream/pr/1234
</code></pre>

<p>To perform the merge, first update your master branch to the latest:</p>

<pre><code>git checkout master
git pull --rebase
</code></pre>

<p>Then merge and push:</p>

<pre><code>git merge --no-ff -m 'This closes #1234' upstream/pr/1234
git push apache-git master
</code></pre>

<p>Note that this commit message is important, as this is what will trigger the
pull request to be automatically closed, and the <code>--no-ff</code> means that a merge
commit will always be created.</p>

<h2 id="internalLink_merging-contributed-code_alternative-options">Alternative options</h2>

<h3 id="internalLink_merging-contributed-code_adding-the-remote-reference-to-the-contributors-repository">Adding the remote reference to the contributor’s repository</h3>

<p>Fetch the branch of the user you want to merge from (replacing <code>-PROJECT</code> as appropriate):</p>

<pre><code>git fetch https://github.com/user-to-merge-from/brooklyn-PROJECT.git branch-to-merge-from
</code></pre>

<p>If you commonly merge from a particular user, you’ll want to add their repo as a remote to make fetching branches easier:</p>

<pre><code>git remote add user-to-merge-from https://github.com/user-to-merge-from/brooklyn-PROJECT.git
git fetch user-to-merge-from
</code></pre>

<h3 id="internalLink_merging-contributed-code_merging-from-a-patch-file">Merging from a patch file</h3>

<p>Save the patch from the Github patch link (just append ‘.patch’ to the pull request link to get it). This patch will
keep the authorship of the commit, so we should use it instead of the diff.</p>

<p>Apply the patch preserving the original author:</p>

<pre><code>git am pull-request-9876.patch
</code></pre>

<h2 id="internalLink_merging-contributed-code_additional-information">Additional information</h2>

<p>Particularly for new committers, you may find the following ASF information useful:</p>

<ul>
  <li><a href="https://www.apache.org/dev/new-committers-guide.html">Guide for new project committers</a></li>
  <li><a href="https://www.apache.org/dev/committers.html">Committers FAQ</a></li>
  <li><a href="https://git-wip-us.apache.org/">Git at Apache</a></li>
</ul>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-release-process" class="section-breaker section p-">
	<span style="width: 100%"><h1>Release Process</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<ol>
  <li><a href="http://brooklyn.apache.org/v/0.10.0/developers/committers/release-process/prepare-for-release.html">Preparing for a release</a> - How to prepare the project for a release</li>
  <li><a href="#contentsLink-release-prerequisites">Prerequisites</a> - steps that a new release manager must do (but which only need to be done once)</li>
  <li><a href="#contentsLink-environment-variables-for-the-release">Set environment variables</a> - many example snippets here use environment variables to
avoid repetition - this page describes what they are</li>
  <li><a href="#contentsLink-release-branch-and-set-version">Create a release branch and set the version</a></li>
  <li><a href="#contentsLink-make-the-release-artifacts">Make the release artifacts</a></li>
  <li><a href="#contentsLink-verify-the-release-artifacts">Verify the release artifacts</a></li>
  <li><a href="#contentsLink-publish-to-the-staging-area">Publish the release artifacts to the staging area</a></li>
  <li><a href="#contentsLink-vote-on-dev@brooklyn">Vote on the dev@brooklyn list</a></li>
  <li>If the vote fails - <a href="#contentsLink-fix-on-the-release-branch">fix the release branch</a> and resume from step 4</li>
  <li><a href="#contentsLink-publish-to-the-public">Publish the release artifacts to the public location</a></li>
  <li><a href="#contentsLink-announce-the-release">Announce the release</a></li>
</ol>

	</div>
	 
	  
	   
	    
	    
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-release-prerequisites" class="section-breaker section p-">
	<span style="width: 100%"><h1>Release Prerequisites</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_release-prerequisites_subversion-repositories-for-release-artifacts">Subversion repositories for release artifacts</h2>

<p>Apache releases are posted to dist.apache.org, which is a Subversion repository.</p>

<p>We have two directories here:</p>

<ul>
  <li>https://dist.apache.org/repos/dist/release/brooklyn - this is where PMC approved releases go. Do not upload
here until we have a vote passed on dev@brooklyn. Check out this folder and name it
<code>apache-dist-release-brooklyn</code></li>
  <li>https://dist.apache.org/repos/dist/dev/brooklyn - this is where releases to be voted on go. Make the release
artifact, and post it here, then post the [VOTE] thread with links here. Check out this folder and name it
<code>apache-dist-dev-brooklyn</code>.</li>
</ul>

<p>Example:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">svn co https://dist.apache.org/repos/dist/release/brooklyn apache-dist-release-brooklyn
svn co https://dist.apache.org/repos/dist/dev/brooklyn apache-dist-dev-brooklyn</code></pre></div>

<p>When working with these folders, <strong>make sure you are working with the correct one</strong>, otherwise you may be publishing
pre-release software to the global release mirror network!</p>

<h2 id="internalLink_release-prerequisites_software-packages">Software packages</h2>

<p>The following software packages are required during the build. Make sure you have them installed.</p>

<ul>
  <li>A Java Development Kit, version 1.7</li>
  <li><code>maven</code> and <code>git</code></li>
  <li>Go Language 1.6 - usually provided by the <code>golang</code> package on popular distributions</li>
  <li>The <code>rpmbuild</code> command - usually provided by the <code>rpm</code> package on popular distributions</li>
  <li><code>xmlstarlet</code> is required by the release script to process version numbers in <code>pom.xml</code> files;
on mac, <code>port install xmlstarlet</code> should do the trick.</li>
  <li><code>zip</code> and <code>unzip</code></li>
  <li><code>gnupg2</code>, and <code>gnupg-agent</code> if it is packaged separately (it is on Ubuntu Linux)</li>
  <li><code>pinentry</code> for secure entry of GPG passphrases. If you are building remotely on a Linux machine, <code>pinentry-curses</code> is
recommended; building on a mac, <code>port install pinentry-mac</code> is recommended.</li>
  <li><code>md5sum</code> and <code>sha1sum</code> - these are often present by default on Linux, but not on Mac;
<code>port install md5sha1sum</code> should remedy that.</li>
  <li>if <code>gpg</code> does not resolve (it is needed for maven), create an alias or script pointing at <code>gpg2 "$@"</code></li>
  <li>the <code>mmv</code> command (usually in a package named <code>mmv</code>) will help with the final steps of the release process</li>
</ul>

<h2 id="internalLink_release-prerequisites_gpg-keys">GPG keys</h2>

<p>The release manager must have a GPG key to be used to sign the release. See below to install <code>gpg2</code>
(with a <code>gpg</code> alias).  The steps here also assume you have the following set
(not using <code>whoami</code> if that’s not appropriate):</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">ASF_USERNAME</span><span class="o">=</span><span class="sb">`</span>whoami<span class="sb">`</span>
<span class="nv">GPG_KEY</span><span class="o">=</span><span class="nv">$ASF_USERNAME</span>@apache.org
<span class="nv">SVN_USERNAME</span><span class="o">=</span><span class="nv">$ASF_USERNAME</span></code></pre></div>

<p>If you have an existing GPG key, but it does not include your Apache email address, you can add your email address as
described <a href="https://superuser.com/a/293283">in this Superuser.com posting</a>. Otherwise, create a new GPG key giving your
Apache email address, using <code>gpg2 --gen-key</code> then <code>gpg2 --export-key $GPG_KEY &gt; my-apache.key</code> and 
<code>gpg2 --export-secret-key -a $GPG_KEY &gt; my-apache.private.key</code> in the right directory (<code>~/.ssh</code> is a good one).</p>

<p>Upload your GPG public key (complete with your Apache email address on it) to a public keyserver - e.g. run
<code>gpg2 --export --armor $GPG_KEY</code> and paste it into the “submit” box on http://pgp.mit.edu/</p>

<p>Look up your key fingerprint with <code>gpg2 --fingerprint $GPG_KEY</code> - it’s the long sequence of hex numbers
separated by spaces. Log in to <a href="https://id.apache.org/">https://id.apache.org/</a> then copy-and-paste the fingerprint into
“OpenPGP Public Key Primary Fingerprint”. Submit.</p>

<p>Now add your key to the <code>apache-dist-release-brooklyn/KEYS</code> file:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd </span>apache-dist-release-brooklyn
<span class="o">(</span>gpg2 --list-sigs <span class="nv">$ASF_USERNAME</span>@apache.org <span class="o">&amp;&amp;</span> gpg2 --armor --export <span class="nv">$ASF_USERNAME</span>@apache.org<span class="o">)</span> &gt;&gt; KEYS
svn --username <span class="nv">$SVN_USERNAME</span> --no-auth-cache commit -m <span class="s2">&quot;Update brooklyn/KEYS for $GPG_KEY&quot;</span></code></pre></div>

<p>References:</p>

<ul>
  <li><a href="https://mail-archives.apache.org/mod_mbox/incubator-general/201410.mbox/%3CCAOGo0VawupMYRWJKm%2Bi%2ByMBqDQQtbv-nQkfRud5%2BV9PusZ2wnQ%40mail.gmail.com%3E">Post on the general@incubator list</a></li>
  <li><a href="http://irtfweb.ifa.hawaii.edu/~lockhart/gpg/gpg-cs.html">GPG cheatsheet</a></li>
</ul>

<p>We recommend the use of the <code>gpg-agent</code>, as the release process invokes gpg to sign a large number of artifacts, one at
a time. The agent stores its configuration in <code>~/.gnupg/gpg-agent.conf</code>. A sample configuration is shown below; it uses
the Mac OSX <code>pinentry-mac</code> program which can be obtained through MacPorts or other sources. For other platforms you will
need to change this; sometimes you can omit it completely and your OS will pick a suitable alternative. The following
two lines cause your passphrase to be cached in memory for a limited period; it will expire from the cache 30 minutes
after it was most recently accessed, or 4 hours after it was first cached.  </p>

<p><code>
pinentry-program /Applications/MacPorts/pinentry-mac.app/Contents/MacOS/pinentry-mac
default-cache-ttl 1800
max-cache-ttl 14400
</code></p>

<p>If you experience trouble with PGP subsequently (when running maven):</p>

<ul>
  <li>See <a href="https://www.enigmail.net/support/gnupg2_issues.php">GnuPG/Pinentry Enigmail debugging</a> for tips on diagnosing gpg-agent communication (from the process to this agent and from this agent to the pinentry program)</li>
  <li>See <a href="https://www.gnupg.org/documentation/manuals/gnupg/Agent-Options.html">GnuPG Agent Options</a> for extended gpg-agent debug</li>
</ul>

<h2 id="internalLink_release-prerequisites_maven-configuration">Maven configuration</h2>

<p>The release will involve uploading artifacts to Apache’s Nexus instance - therefore you will need to configure your
Maven install with the necessary credentials.</p>

<p>You will need to add something like this to your <code>~/.m2/settings.xml</code> file:</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="nt">&lt;settings</span> <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://maven.apache.org/SETTINGS/1.1.0 http://maven.apache.org/xsd/settings-1.1.0.xsd&quot;</span>
          <span class="na">xmlns=</span><span class="s">&quot;http://maven.apache.org/SETTINGS/1.1.0&quot;</span>
          <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- ... --&gt;</span>

    <span class="nt">&lt;servers&gt;</span>

        <span class="c">&lt;!-- ... --&gt;</span>

        <span class="c">&lt;!-- Required for uploads to Apache&#39;s Nexus instance. These are LDAP credentials - the same credentials you</span>
<span class="c">           - would use to log in to Git and Jenkins (but not JIRA) --&gt;</span>
        <span class="nt">&lt;server&gt;</span>
            <span class="nt">&lt;id&gt;</span>apache.snapshots.https<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;username&gt;</span>xxx<span class="nt">&lt;/username&gt;</span>
            <span class="nt">&lt;password&gt;</span>xxx<span class="nt">&lt;/password&gt;</span>
        <span class="nt">&lt;/server&gt;</span>
        <span class="nt">&lt;server&gt;</span>
            <span class="nt">&lt;id&gt;</span>apache.releases.https<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;username&gt;</span>xxx<span class="nt">&lt;/username&gt;</span>
            <span class="nt">&lt;password&gt;</span>xxx<span class="nt">&lt;/password&gt;</span>
        <span class="nt">&lt;/server&gt;</span>

        <span class="c">&lt;!-- ... --&gt;</span>

    <span class="nt">&lt;/servers&gt;</span>

    <span class="c">&lt;!-- ... --&gt;</span>

<span class="nt">&lt;/settings&gt;</span></code></pre></div>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-environment-variables-for-the-release" class="section-breaker section p-">
	<span style="width: 100%"><h1>Environment variables for the release</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Many example commands in this section using variable names as placeholders for information that will vary between
releases. To allow these example commands to run unmodified, set these environment variables appropriately.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># The version currently set on the master branch (BROOKLYN_VERSION_BELOW)</span>
<span class="nv">OLD_MASTER_VERSION</span><span class="o">=</span>0.12.0-SNAPSHOT
<span class="c"># The next version to be set on the master branch</span>
<span class="nv">NEW_MASTER_VERSION</span><span class="o">=</span>0.10.0-SNAPSHOT

<span class="c"># The version we are releasing now.</span>
<span class="nv">VERSION_NAME</span><span class="o">=</span>0.9.0

<span class="c"># The release candidate number we are making now.</span>
<span class="nv">RC_NUMBER</span><span class="o">=</span>1

<span class="c"># Modules and submodules - these will come in handy later</span>
<span class="nv">SUBMODULES</span><span class="o">=</span><span class="s2">&quot;$( perl -n -e &#39;if ($_ =~ /path += +(.*)$/) { print $1.&quot;</span><span class="se">\n</span><span class="s2">&quot; }&#39; &lt; .gitmodules )&quot;</span>
<span class="nv">MODULES</span><span class="o">=</span><span class="s2">&quot;. ${SUBMODULES}&quot;</span></code></pre></div>

<p>Alternatively, use the command <code>eval $( ./brooklyn-dist/release/environment.sh )</code> to set these values automatically.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-release-branch-and-set-version" class="section-breaker section p-">
	<span style="width: 100%"><h1>Release branch and set version</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>This will allow development to continue on master without affecting the release; it also allows quick-fixes to the
release branch to address last-minute problems (which must of course be merged/cherry-picked back into master later).</p>

<p>Do not use -rc1, -rc2 etc. in version strings. Use the version that will be the actual published version. (The artifacts
that get uploaded to the dist.apache.org/dev will include “-rc1” etc. in the folder name, but the contents will be <em>as
final</em>. Therefore, turning the rc into the final is simply a case of taking the rc file and publishing it to the release
folder with the correct name.)</p>

<p>References:</p>

<ul>
  <li><a href="https://mail-archives.apache.org/mod_mbox/incubator-general/201409.mbox/%3CCAK2iWdS1H9dkJcSdohky6hFqJdP0XyuhAG%2B%3D1Aspxcjt5RmnJw%40mail.gmail.com%3E">Post on general@incubator</a></li>
  <li><a href="https://mail-archives.apache.org/mod_mbox/incubator-general/201409.mbox/%3CCAOGo0VaEz4cEUbgMgqhh3hiiiubnspiGkQ%3DQv08bOwPqRtzAvQ%40mail.gmail.com%3E">Post on general@incubator</a></li>
</ul>

<h2 id="internalLink_release-branch-and-set-version_create-the-release-branch-and-set-the-release-version-number">Create the release branch and set the release version number</h2>

<p>Create a branch with the same name as the version, based off master:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">git checkout master
git pull --rebase <span class="c"># assumes that the Apache canonical repository is the default upstream for your master - amend if necessary</span>
git submodule update --remote --merge --recursive
<span class="k">for</span> m in <span class="nv">$MODULES</span><span class="p">;</span> <span class="k">do</span> <span class="o">(</span> <span class="nb">cd</span> <span class="nv">$m</span> <span class="o">&amp;&amp;</span> git checkout master <span class="o">&amp;&amp;</span> git checkout -b <span class="nv">$VERSION_NAME</span> <span class="o">)</span><span class="p">;</span> <span class="k">done</span></code></pre></div>

<p>Now change the version numbers in this branch throughout the project using the script <code>brooklyn-dist/release/change-version.sh</code> and commit it:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">./brooklyn-dist/release/change-version.sh BROOKLYN <span class="nv">$OLD_MASTER_VERSION</span> <span class="nv">$VERSION_NAME</span>
<span class="c"># Now inspect the changes and ensure there are no surprises</span>
find . -name <span class="s2">&quot;*.bak&quot;</span> -delete
<span class="k">for</span> m in <span class="nv">$SUBMODULES</span><span class="p">;</span> <span class="k">do</span> <span class="o">(</span> <span class="nb">cd</span> <span class="nv">$m</span> <span class="o">&amp;&amp;</span> git add . <span class="o">&amp;&amp;</span> git commit -m <span class="s2">&quot;Change version to $VERSION_NAME&quot;</span> <span class="o">)</span><span class="p">;</span> <span class="k">done</span>
git add <span class="nv">$SUBMODULES</span> <span class="o">&amp;&amp;</span> git commit -m <span class="s2">&quot;Update submodules to $VERSION_NAME&quot;</span>
git add . <span class="o">&amp;&amp;</span> git commit -m <span class="s2">&quot;Change version to $VERSION_NAME&quot;</span></code></pre></div>

<p>If you are happy with the changes, push them:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">for</span> m in <span class="nv">$MODULES</span><span class="p">;</span> <span class="k">do</span> <span class="o">(</span> <span class="nb">cd</span> <span class="nv">$m</span> <span class="o">&amp;&amp;</span> git push apache-git <span class="nv">$VERSION_NAME</span> <span class="o">)</span><span class="p">;</span> <span class="k">done</span></code></pre></div>

<h2 id="internalLink_release-branch-and-set-version_update-the-version-on-master">Update the version on master</h2>

<p>The <code>master</code> branch will now need updating to refer to the next planned version. (This step is not required if making
a “milestone” release or similar.)</p>

<p>The release notes should be cleared out and the version history augmented with the new version.</p>

<p>Example:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">for</span> m in <span class="nv">$MODULES</span><span class="p">;</span> <span class="k">do</span> <span class="o">(</span> <span class="nb">cd</span> <span class="nv">$m</span> <span class="o">&amp;&amp;</span> git checkout master <span class="o">)</span><span class="p">;</span> <span class="k">done</span>
./brooklyn-dist/release/change-version.sh BROOKLYN <span class="nv">$OLD_MASTER_VERSION</span> <span class="nv">$NEW_MASTER_VERSION</span>
<span class="c"># Now inspect the changes and ensure there are no surprises</span></code></pre></div>

<p>Open <code>brooklyn-docs/guide/misc/release-notes.md</code> and <code>brooklyn-docs/website/meta/versions.md</code> in your favourite editor and amend.
For release notes this means bumping the reference to the previous version in the “Backwards Compatibility” section
and putting some placeholder text elsewhere.</p>

<p>Then:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">find . -name <span class="s2">&quot;*.bak&quot;</span> -delete
<span class="k">for</span> m in <span class="nv">$SUBMODULES</span><span class="p">;</span> <span class="k">do</span> <span class="o">(</span> <span class="nb">cd</span> <span class="nv">$m</span> <span class="o">&amp;&amp;</span> git add . <span class="o">&amp;&amp;</span> git commit -m <span class="s2">&quot;Change version to $NEW_MASTER_VERSION&quot;</span> <span class="o">)</span><span class="p">;</span> <span class="k">done</span>
git add <span class="nv">$SUBMODULES</span> <span class="o">&amp;&amp;</span> git commit -m <span class="s2">&quot;Update submodules to $NEW_MASTER_VERSION&quot;</span>
git add . <span class="o">&amp;&amp;</span> git commit -m <span class="s2">&quot;Change version to $NEW_MASTER_VERSION&quot;</span></code></pre></div>

<p>If you are happy with the changes, push them:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">for</span> m in <span class="nv">$MODULES</span><span class="p">;</span> <span class="k">do</span> <span class="o">(</span> <span class="nb">cd</span> <span class="nv">$m</span> <span class="o">&amp;&amp;</span> git push apache-git master <span class="o">)</span><span class="p">;</span> <span class="k">done</span></code></pre></div>

<h2 id="internalLink_release-branch-and-set-version_switch-back-to-the-release-branch">Switch back to the release branch</h2>

<p>Move back to the release branch:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">for</span> m in <span class="nv">$MODULES</span><span class="p">;</span> <span class="k">do</span> <span class="o">(</span> <span class="nb">cd</span> <span class="nv">$m</span> <span class="o">&amp;&amp;</span> git checkout <span class="nv">$VERSION_NAME</span> <span class="o">)</span><span class="p">;</span> <span class="k">done</span></code></pre></div>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-make-the-release-artifacts" class="section-breaker section p-">
	<span style="width: 100%"><h1>Make the release artifacts</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>A release script is provided in <code>brooklyn-dist/release/make-release-artifacts.sh</code>. This script will prepare all the release artifacts.
It is written to account for several Apache requirements, so you are strongly advised to use it rather than “rolling your own”.</p>

<p>The release script will:</p>

<ul>
  <li><strong>Create source code and binary distribution artifacts</strong> and place them in a temporary staging directory on your workstation, usually <code>brooklyn-dist/release/tmp/</code>.</li>
  <li><strong>Create Maven artifacts and upload them to a staging repository</strong> located on the Apache Nexus server.</li>
</ul>

<p>The script has a single required parameter <code>-r</code> which is given the release candidate number - so <code>-r1</code> will create
release candidate 1 and will name the artifacts appropriately.</p>

<p>The script takes a <code>-n</code> parameter to work in <em>dry run</em> mode; in this mode, the script will NOT upload Maven artifacts
or commit the release to the Subversion repository. This speeds up the process (the Maven deploy in particular slows
down the build) and will catch any problems such as PGP or javadoc problems much sooner.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># A dry run to test everything is OK</span>
./brooklyn-dist/release/make-release-artifacts.sh -r<span class="nv">$RC_NUMBER</span> -n

<span class="c"># The real build, which will publish artifacts</span>
./brooklyn-dist/release/make-release-artifacts.sh -r<span class="nv">$RC_NUMBER</span></code></pre></div>

<p>It will show you the release information it has deduced, and ask yes-or-no if it can proceed. Then you will be prompted
for the passphrase to your GnuPG private key. You should only be asked this question once; the GnuPG agent will cache
the password for the remainder of the build.</p>

<p>Please note that the script will thoroughly clean the Git workspace of all uncommitted and unadded files <strong>even in dry
run mode</strong>. Therefore <strong>you really want to run this against a secondary checkout.</strong> It will wipe <code>.project</code> files and
other IDE metadata, and bad things can happen if an IDE tries to write while the script is running. Consider using the
Vagrant configuration provided.</p>

<p>Please note that uploading to the Nexus staging repository is a slow process. Expect this stage of the build to take
2 hours.</p>

<p>The release script will:</p>

<ol>
  <li>Prepare a staging directory for the source code release</li>
  <li>Create .tar.gz and .zip artifacts of the source code</li>
  <li>Invoke Maven to build the source code (including running unit tests), and deploy artifacts to a Maven remote
repository</li>
  <li>Save the .tar.gz and .zip artifacts produced by the build of <code>brooklyn-dist</code></li>
  <li>For each of the produced files, produce MD5, SHA1, SHA256 and GnuPG signatures</li>
</ol>

<p>At the end of the script, it will show you the files it has produced and their location.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-verify-the-release-artifacts" class="section-breaker section p-">
	<span style="width: 100%"><h1>Verify the release artifacts</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Below is described a series of “sanity checks” that should be performed before uploading the artifacts to the
pre-release area. They are also useful for community members that want to check the artifact before voting (community
members may also want to check the <a href="#contentsLink-release-prerequisites">list of required software packages</a> to ensure
they have the GnuPG and md5sum/sha1sum installed.</p>

<h2 id="internalLink_verify-the-release-artifacts_setup">Setup</h2>

<p>The scripts below use several environment variables to cut out repetition and enable easy repeatability for the next
release. You should determine the following information and set your environment:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># The version we are releasing now.</span>
<span class="nv">VERSION_NAME</span><span class="o">=</span>0.10.0

<span class="c"># The release candidate number we are making now.</span>
<span class="nv">RC_NUMBER</span><span class="o">=</span>1

<span class="c"># A reference to your Git repository for Brooklyn</span>
<span class="nv">BASE_REPO</span><span class="o">=</span>~/repos/apache-asf/brooklyn

<span class="c"># The Git commit hash from which the release was made - get this from the release script, or the Release Manager&#39;s announcement</span>
<span class="nv">GIT_COMMIT</span><span class="o">=</span>edcf928ee65cc29a84376c822759e468a9f016fe</code></pre></div>

<p>Import the PGP keys of the release Managers:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">curl https://dist.apache.org/repos/dist/release/brooklyn/KEYS <span class="p">|</span> gpg2 --import</code></pre></div>

<h2 id="internalLink_verify-the-release-artifacts_download-the-artifacts">Download the artifacts</h2>

<p>If you’ve just built the RC, simply go to that directory and skip this step.</p>

<p>If you’re verifying a build someone else has made, first download the files including all keys using:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">TEMP_DIR</span><span class="o">=</span>~/tmp/brooklyn/release/<span class="k">${</span><span class="nv">VERSION_NAME</span><span class="k">}</span>-rc<span class="k">${</span><span class="nv">RC_NUMBER</span><span class="k">}</span>
<span class="nv">BASE_NAME</span><span class="o">=</span>apache-brooklyn-<span class="k">${</span><span class="nv">VERSION_NAME</span><span class="k">}</span>-rc<span class="k">${</span><span class="nv">RC_NUMBER</span><span class="k">}</span>
<span class="nv">BASE_URL</span><span class="o">=</span>https://dist.apache.org/repos/dist/dev/brooklyn/<span class="k">${</span><span class="nv">BASE_NAME</span><span class="k">}</span>/

mkdir -p <span class="k">${</span><span class="nv">TEMP_DIR</span><span class="k">}</span>
<span class="nb">cd</span> <span class="k">${</span><span class="nv">TEMP_DIR</span><span class="k">}</span>
curl -s <span class="nv">$BASE_URL</span> <span class="p">|</span> <span class="se">\</span>
    grep href <span class="p">|</span> grep -v <span class="s1">&#39;\.\.&#39;</span> <span class="p">|</span> <span class="se">\</span>
    sed -e <span class="s1">&#39;s@.*href=&quot;@&#39;</span><span class="nv">$BASE_URL</span><span class="s1">&#39;@&#39;</span> <span class="p">|</span> <span class="se">\</span>
    sed -e <span class="s1">&#39;s@&quot;&gt;.*@@&#39;</span> <span class="p">|</span> <span class="se">\</span>
    xargs -n <span class="m">1</span> curl -O</code></pre></div>

<p>(Alternatively if you have <code>apache-dist-dev-repo</code> checked out,
you can do an <code>svn up</code> in there and <code>cd apache-brooklyn-${VERSION_NAME}-rc${RC_NUMBER}</code>.)</p>

<h2 id="internalLink_verify-the-release-artifacts_verify-presence-of-notice--license">Verify presence of NOTICE &amp; LICENSE</h2>
<p>Check that all archives are correctly annotated with license information.
Check NOTICE is included:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">for</span> ARCHIVE in <span class="k">$(</span>find * -type f ! <span class="se">\(</span> -name <span class="s1">&#39;*.asc&#39;</span> -o -name <span class="s1">&#39;*.md5&#39;</span> -o -name <span class="s1">&#39;*.sha1&#39;</span> -o -name <span class="s1">&#39;*.sha256&#39;</span> <span class="se">\)</span> <span class="k">)</span><span class="p">;</span> <span class="k">do</span>
  <span class="nv">REL_ARCHIVE</span><span class="o">=</span><span class="k">${</span><span class="nv">ARCHIVE</span><span class="p">/-rc?</span><span class="k">}</span>
  <span class="k">case</span> <span class="nv">$ARCHIVE</span> in
    *.tar.gz<span class="o">)</span>
      <span class="nv">LIST</span><span class="o">=</span><span class="s2">&quot;tar -tvf&quot;</span>
      <span class="nv">PREFIX</span><span class="o">=</span><span class="k">${</span><span class="nv">REL_ARCHIVE</span><span class="p">%.tar.gz</span><span class="k">}</span>
      <span class="p">;;</span>
    *.zip<span class="o">)</span>
      <span class="nv">LIST</span><span class="o">=</span><span class="s2">&quot;unzip -Zl&quot;</span>
      <span class="nv">PREFIX</span><span class="o">=</span><span class="k">${</span><span class="nv">REL_ARCHIVE</span><span class="p">%.zip</span><span class="k">}</span>
      <span class="p">;;</span>
    *.rpm<span class="o">)</span>
      <span class="nv">LIST</span><span class="o">=</span><span class="s2">&quot;rpm -qlp&quot;</span>
      <span class="nv">PREFIX</span><span class="o">=</span><span class="s2">&quot;/opt/brooklyn&quot;</span>
      <span class="p">;;</span>
    *<span class="o">)</span>
      <span class="nb">echo</span> <span class="s2">&quot;Unrecognized file type $ARCHIVE. Aborting!&quot;</span>
      <span class="nb">exit </span>1
      <span class="p">;;</span>
  <span class="k">esac</span>
  <span class="nv">$LIST</span> <span class="nv">$ARCHIVE</span> <span class="p">|</span> grep <span class="s2">&quot;$PREFIX/NOTICE&quot;</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
  <span class="nv">$LIST</span> <span class="nv">$ARCHIVE</span> <span class="p">|</span> grep <span class="s2">&quot;$PREFIX/LICENSE&quot;</span> <span class="se">\</span>
    <span class="o">||</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot;Missing LICENSE or NOTICE in $ARCHIVE. Aborting!&quot;</span><span class="p">;</span> <span class="nb">break</span><span class="p">;</span> <span class="o">}</span> 
<span class="k">done</span></code></pre></div>

<h2 id="internalLink_verify-the-release-artifacts_verify-the-hashes-and-signatures-of-artifacts">Verify the hashes and signatures of artifacts</h2>

<p>Then check the hashes and signatures, ensuring you get a positive message from each one:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">for</span> artifact in <span class="k">$(</span>find * -type f ! <span class="se">\(</span> -name <span class="s1">&#39;*.asc&#39;</span> -o -name <span class="s1">&#39;*.md5&#39;</span> -o -name <span class="s1">&#39;*.sha1&#39;</span> -o -name <span class="s1">&#39;*.sha256&#39;</span> <span class="se">\)</span> <span class="k">)</span><span class="p">;</span> <span class="k">do</span>
    md5sum -c <span class="k">${</span><span class="nv">artifact</span><span class="k">}</span>.md5 <span class="o">&amp;&amp;</span> <span class="se">\</span>
    shasum -a1 -c <span class="k">${</span><span class="nv">artifact</span><span class="k">}</span>.sha1 <span class="o">&amp;&amp;</span> <span class="se">\</span>
    shasum -a256 -c <span class="k">${</span><span class="nv">artifact</span><span class="k">}</span>.sha256 <span class="o">&amp;&amp;</span> <span class="se">\</span>
    gpg2 --verify <span class="k">${</span><span class="nv">artifact</span><span class="k">}</span>.asc <span class="k">${</span><span class="nv">artifact</span><span class="k">}</span> <span class="se">\</span>
      <span class="o">||</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot;Invalid signature for $artifact. Aborting!&quot;</span><span class="p">;</span> <span class="nb">break</span><span class="p">;</span> <span class="o">}</span>
<span class="k">done</span></code></pre></div>

<h2 id="internalLink_verify-the-release-artifacts_verify-expanded-source-archive-matches-contents-of-rc-tag">Verify expanded source archive matches contents of RC tag</h2>

<p>These commands will compare the contents of the source release to the contents of the equivalent Git commit. Note that
there will be some differences: we cannot release binary files in the source release, so some test artifacts will
appear to be missing from the source release, and the source release excludes the documentation, website and release
scripts.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd</span> <span class="nv">$BASE_REPO</span>
git checkout <span class="nv">$GIT_COMMIT</span>
git clean -d -f -x <span class="c"># WARNING: this will forcibly clean your workspace!</span>

<span class="nb">cd</span> <span class="nv">$TEMP_DIR</span>
mkdir unpacked-src
<span class="c"># Either:</span>
tar xzf <span class="k">${</span><span class="nv">BASE_NAME</span><span class="k">}</span>-src.tar.gz -C unpacked-src/
<span class="c"># or:</span>
unzip <span class="k">${</span><span class="nv">BASE_NAME</span><span class="k">}</span>-src.zip -d unpacked-src/
<span class="c"># (or preferably both!)</span>
diff -qr unpacked-src/<span class="nv">$BASE_NAME</span> <span class="nv">$BASE_REPO</span></code></pre></div>

<h2 id="internalLink_verify-the-release-artifacts_check-for-files-with-invalid-headers-in-source-archive">Check for files with invalid headers in source archive</h2>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">grep -rL <span class="s2">&quot;Licensed to the Apache Software Foundation&quot;</span> * <span class="p">|</span> less</code></pre></div>

<h2 id="internalLink_verify-the-release-artifacts_check-for-binary-files-in-source-archive">Check for binary files in source archive</h2>

<p>Look for files which are created/compiled based on other source files in the distribution.
“Primary” binary files like images are acceptable.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">find . <span class="p">|</span> xargs -n1 file <span class="p">|</span> awk -F <span class="s1">$&#39;:&#39;</span> <span class="s1">&#39; { t = $1; $1 = $2; $2 = t; print; } &#39;</span> <span class="p">|</span> sort <span class="p">|</span> less</code></pre></div>

<h2 id="internalLink_verify-the-release-artifacts_verify-the-operation-of-the-binary-distribution">Verify the operation of the binary distribution</h2>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd</span> <span class="nv">$TEMP_DIR</span>
mkdir unpacked-bin
<span class="c"># Either:</span>
tar xzf <span class="k">${</span><span class="nv">BASE_NAME</span><span class="k">}</span>-bin.tar.gz -C unpacked-bin/
<span class="c"># or:</span>
unzip <span class="k">${</span><span class="nv">BASE_NAME</span><span class="k">}</span>-bin.tar.gz -d unpacked-bin/
<span class="c"># (or preferably both!)</span>
<span class="nb">cd </span>unpacked-bin
./bin/brooklyn launch</code></pre></div>

<p>Try deploying a simple app, such as the YAML:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">location</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">org.apache.brooklyn.entity.webapp.jboss.JBoss7Server</span></code></pre></div>

<h2 id="internalLink_verify-the-release-artifacts_inspect-the-maven-staging-repository">Inspect the Maven staging repository</h2>

<p>Go to the Apache Nexus server at <a href="https://repository.apache.org/">https://repository.apache.org/</a> and log in using the
link in the top right (the credentials are the same as your Git and Jenkins credentials). Go to the “Staging
Repositories” page, and click the repository with the name starting <code>orgapachebrooklyn</code>.</p>

<p>Give this a brief inspection to ensure that it looks reasonable. In particular:</p>

<ul>
  <li>The expected projects are there. (There is no need to do an exhaustive check - but if there is only a couple of
projects there, then something has clearly gone wrong!)</li>
  <li>The projects contain artifacts with the expected version number.</li>
  <li>The artifacts for a project look reasonable - and there is a <code>.asc</code> file (detached PGP cleartext signature) for each
artifact.</li>
</ul>

<h2 id="internalLink_verify-the-release-artifacts_about-the-sanity-check">About the sanity check</h2>

<p>This is the most basic sanity check. This is now suitable to be uploaded to the pre-release area and an announcement
made with voting open. This is then the point for the RM and the community to perform more detailed testing on the RC
artifacts and submit bug reports and votes.</p>

<p>Automated sanity check script available at brooklyn-dist/release/verity_brooklyn_rc.sh</p>

<h2 id="internalLink_verify-the-release-artifacts_if-the-sanity-check-fails">If the sanity check fails</h2>

<p>Note the problems causing the failure, and file bug reports, start mailing list discussions etc., as appropriate.</p>

<h4 id="internalLink_verify-the-release-artifacts_for-the-release-manager-who-was-preparing-an-rc-for-upload">For the release manager who was preparing an RC for upload</h4>

<p>You should completely discard the defective artifacts.</p>

<p>You will also need to drop the Maven staging repository on Apache’s Nexus server: go to the Apache Nexus server at
<a href="https://repository.apache.org/">https://repository.apache.org/</a> and log in using the link in the top right (the
credentials are the same as your Git and Jenkins credentials). Go to the “Staging Repositories” page, and tick the
repository with the name starting <code>orgapachebrooklyn</code>. Click the <strong>Drop</strong> button.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-publish-to-the-staging-area" class="section-breaker section p-">
	<span style="width: 100%"><h1>Publish to the staging area</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_publish-to-the-staging-area_update-the-canonical-git-repository">Update the canonical Git repository</h2>

<p>Make a signed tag for this release candidate:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">for</span> m in <span class="k">${</span><span class="nv">MODULES</span><span class="k">}</span><span class="p">;</span> <span class="k">do</span> <span class="o">(</span> <span class="nb">cd</span> <span class="nv">$m</span> <span class="o">&amp;&amp;</span> git tag -s -m <span class="s2">&quot;Tag release ${VERSION_NAME} release candidate ${RC_NUMBER}&quot;</span> rel/apache-brooklyn-<span class="k">${</span><span class="nv">VERSION_NAME</span><span class="k">}</span>-rc<span class="k">${</span><span class="nv">RC_NUMBER</span><span class="k">}</span> <span class="o">)</span><span class="p">;</span> <span class="k">done</span></code></pre></div>

<p>Now push the release branch and release candidate tag:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">for</span> m in <span class="k">${</span><span class="nv">MODULES</span><span class="k">}</span><span class="p">;</span> <span class="k">do</span> <span class="o">(</span> <span class="nb">cd</span> <span class="nv">$m</span> <span class="o">&amp;&amp;</span> git push apache-git <span class="nv">$VERSION_NAME</span> <span class="o">&amp;&amp;</span> git push apache-git rel/apache-brooklyn-<span class="k">${</span><span class="nv">VERSION_NAME</span><span class="k">}</span>-rc<span class="k">${</span><span class="nv">RC_NUMBER</span><span class="k">}</span> <span class="o">)</span><span class="p">;</span> <span class="k">done</span></code></pre></div>

<h2 id="internalLink_publish-to-the-staging-area_publish-the-source-and-binary-distributions-to-the-pre-release-area">Publish the source and binary distributions to the pre-release area</h2>

<p>You will need to have checked out the Apache distribution Subversion repository located at
https://dist.apache.org/repos/dist/dev/brooklyn. Please refer to <a href="#contentsLink-release-prerequisites">Prerequisites</a> for
information.</p>

<p>In your workspace for the <code>dist.apache.org</code> repo, create a directory with the artifact name and version:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">mkdir apache-brooklyn-<span class="k">${</span><span class="nv">VERSION_NAME</span><span class="k">}</span>-rc<span class="k">${</span><span class="nv">RC_NUMBER</span><span class="k">}</span></code></pre></div>

<p>Copy into this directory all of the artifacts from the previous step - <code>-src</code> and <code>-bin</code>, <code>.tar.gz</code>, <code>.zip</code> and <code>.rpm</code>,
and all associated <code>.md5</code>, <code>.sha1</code>, <code>.sha256</code> and <code>.asc</code> signatures. Then commit:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">svn add apache-brooklyn-<span class="k">${</span><span class="nv">VERSION_NAME</span><span class="k">}</span>-rc<span class="k">${</span><span class="nv">RC_NUMBER</span><span class="k">}</span>
svn commit --username <span class="nv">$SVN_USERNAME</span> --no-auth-cache --message <span class="s2">&quot;Add apache-brooklyn-${VERSION_NAME}-rc${RC_NUMBER} to dist/dev/brooklyn&quot;</span></code></pre></div>

<p>These steps can be performed as part of the <code>make-release-artifacts.sh</code> script used earlier
if <code>${APACHE_DIST_SVN_DIR}</code> points to the appropriate subversion directory.</p>

<h2 id="internalLink_publish-to-the-staging-area_close-the-staging-repository-on-apaches-nexus-server">Close the staging repository on Apache’s Nexus server</h2>

<p><em>Closing</em> the staging repository locks it from further changes, and provides a public URL for the repository that can
be used for downloading the artifacts.</p>

<p>Go to the Apache Nexus server at <a href="https://repository.apache.org/">https://repository.apache.org/</a> and log in using the
link in the top right (the credentials are the same as your Git and Jenkins credentials). Go to the “Staging
Repositories” page, and tick the repository with the name starting <code>orgapachebrooklyn</code>. Click the <strong>Close</strong> button.
Provide a description which includes the version and release candidate, e.g. <code>Apache Brooklyn 0.10.0-rc1</code>.</p>

	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-vote-on-dev@brooklyn" class="section-breaker section p-">
	<span style="width: 100%"><h1>Vote on dev@brooklyn</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_vote-on-dev@brooklyn_start-the-vote">Start the vote</h2>

<p>A script to generate the voting email can be found in <code>brooklyn-dist/release/print-vote-email.sh</code>,
taking a single argument being the staging repo ID. For example:</p>

<pre><code>brooklyn-dist/release/print-vote-email.sh orgapachebrooklyn-1234 | pbcopy
</code></pre>

<p>You should move the subject and put your name at the end, and simply eyeball the rest. This should be sent to <strong>dev@brooklyn.apache.org</strong>.</p>

<p>Alternatively, copy-paste the e-mail template below, being sure to substitute:</p>

<ul>
  <li>VERSION_NAME</li>
  <li>RC_NUMBER</li>
  <li>URLs containing version numbers</li>
  <li>URL for your own PGP key</li>
  <li>Checksums</li>
  <li>URL for the Maven staging repository</li>
</ul>

<h3 id="internalLink_vote-on-dev@brooklyn_subject-vote-release-apache-brooklyn-versionname-rcrcnumber">Subject: [VOTE] Release Apache Brooklyn ${VERSION_NAME} [rc${RC_NUMBER}]</h3>

<div class="highlight"><pre><code class="language-text" data-lang="text">This is to call for a vote for the release of Apache Brooklyn ${VERSION_NAME}.

This release comprises of a source code distribution, and a corresponding
binary distribution, and Maven artifacts.

The source and binary distributions, including signatures, digests, etc. can
be found at:
https://dist.apache.org/repos/dist/dev/brooklyn/apache-brooklyn-${VERSION_NAME}-rc${RC_NUMBER}

The artifact SHA-256 checksums are as follows:
c3b5c581f14b44aed786010ac7c8c2d899ea0ff511135330395a2ff2a30dd5cf *apache-brooklyn-${VERSION_NAME}-rc${RC_NUMBER}-bin.tar.gz
cef49056ba6e5bf012746a72600b2cee8e2dfca1c39740c945c456eacd6b6fca *apache-brooklyn-${VERSION_NAME}-rc${RC_NUMBER}-bin.zip
8069bfc54e7f811f6b57841167b35661518aa88cabcb070bf05aae2ff1167b5a *apache-brooklyn-${VERSION_NAME}-rc${RC_NUMBER}-src.tar.gz
acd2229c44e93e41372fd8b7ea0038f15fe4aaede5a3bcc5056f28a770543b82 *apache-brooklyn-${VERSION_NAME}-rc${RC_NUMBER}-src.zip

The Nexus staging repository for the Maven artifacts is located at:
https://repository.apache.org/content/repositories/orgapachebrooklyn-1004

All release artifacts are signed with the following key:
https://people.apache.org/keys/committer/richard.asc

KEYS file available here:
https://dist.apache.org/repos/dist/release/brooklyn/KEYS

The artifacts were built from Git commit ID
24a23c5a4fd5967725930b8ceaed61dfbd225980
https://git-wip-us.apache.org/repos/asf?p=brooklyn.git;a=commit;h=24a23c5a4fd5967725930b8ceaed61dfbd225980


Please vote on releasing this package as Apache Brooklyn ${VERSION_NAME}.

The vote will be open for at least 72 hours.
[ ] +1 Release this package as Apache Brooklyn ${VERSION_NAME}
[ ] +0 no opinion
[ ] -1 Do not release this package because ...


Thanks,
[Release manager name]</code></pre></div>

<h2 id="internalLink_vote-on-dev@brooklyn_discuss-the-vote">Discuss the vote</h2>
<p>Open a parallel thread for a place to discuss the vote. Name it [DISCUSS]<subject of="" the="" voting="" email="">, replying
to the vote email. Here's an example body for the email.</subject></p>

<div class="highlight"><pre><code class="language-text" data-lang="text">This thread is for discussions related to the release vote.

I should clarify what we are looking for in a release vote. Particularly,
we are looking for people to download,validate, and test the release.
Only if you are satisfied that the artifacts are correct and the quality is
high enough, should you make a &quot;+1&quot; vote. Alongside your vote you should list
the checks that you made.

Here is a good example: http://markmail.org/message/gevsz2pdciraw6jw

The vote is not simply about &quot;the master branch contains the features I wanted&quot; -
it is about making sure that *these* artifacts are *correct* (e.g. they are
not corrupted, hashes and signatures pass) and are of *sufficiently high
quality* to be stamped as an official release of The Apache Software Foundation.

Why test the artifacts when master is looking good? Here are some reasons:

- somebody could have made a commit that broke it, since you last git pulled
- the release branch could have been made at the wrong point, or inconsistently
  between all of the submodules
- something in the release process could have broken it
- I could have made a mistake and corrupted the files
- a problem with the Apache infrastructure could mean that the release files are
  unobtainable or corrupted

This is why the release manager needs you to download the actual release
artifacts and try them out.

The way Apache works can be a bit arcane sometimes, but it&#39;s all done with
a reason. If the vote passes then the contents of the email and its links
become &quot;endorsed&quot; by The Apache Software Foundation, and the Foundation will
take on legal liability for them, forever.

And of course we want the best possible experience for our users - so we need
the actual release files to be tested manually to make sure that a mistake does
not ruin the experience for users.

So if you can spare an hour or more to download some of the artifacts and try
them out, then it will be *very* useful! The vote lasts for three days so
there&#39;s no need to rush to get a vote in.

Thanks!
[Release manager name]</code></pre></div>

<h2 id="internalLink_vote-on-dev@brooklyn_reply-to-vote">Reply to vote</h2>

<p>Here is an example checklist (thanks Andrew Phillips for your thoroughness on jclouds!)</p>

<p>Checklist (all items optional, mark only those personally verified):</p>

<ul>
  <li>[ ] Checksums and PGP signatures are valid.</li>
  <li>[ ] Expanded source archive matches contents of RC tag.</li>
  <li>[ ] Expanded source archive builds and passes tests.</li>
  <li>[ ] LICENSE is present and correct.</li>
  <li>[ ] NOTICE is present and correct, including copyright date.</li>
  <li>[ ] All files have license headers where appropriate.</li>
  <li>[ ] All dependencies have compatible licenses.</li>
  <li>[ ] No compiled archives bundled in source archive.</li>
  <li>[ ] I follow this project’s commits list.</li>
</ul>

<h2 id="internalLink_vote-on-dev@brooklyn_count-the-vote-results">Count the vote results</h2>

<p>If the release email stated a deadline (normally 72 hours), then you should wait at least that long. If there are
insufficient votes you may need to extend the deadline - as an informal aim, we should look to get 2/3rds of the PPMC
and some mentors voting +1. If a release-critical issue is raised and confirmed, then you may end the vote early with a
negative result.</p>

<p>Votes from PPMC members are binding; votes from others are non-binding. In the case of non-binding negative votes,
please consider these carefully even if you are not bound by them.</p>

<p>If there are any negative or zero votes, consider these carefully. Aim to “convert” negative or zero votes into positive
by addressing any concerns. A negative vote is not necessarily a veto[citation required], but it should be a clear
warning sign to not proceed if somebody strongly believes that the release should not proceed as is.</p>

<p>Finally, count up the +1s and separate into binding (PPMC) and non-binding.</p>

<h2 id="internalLink_vote-on-dev@brooklyn_email-the-vote-result">Email the vote result</h2>

<p>This is a new email thread with a different subject
(the same as before with <code>[RESULT]</code> prepended).</p>

<p>Note that you must find the URL for the previous thread at <a href="https://mail-archives.apache.org/">mail-archives.apache.org</a>.</p>

<h3 id="internalLink_vote-on-dev@brooklyn_subject-resultvote-release-apache-brooklyn-versionname-rcrcnumber">Subject: [RESULT][VOTE] Release Apache Brooklyn ${VERSION_NAME} [rc${RC_NUMBER}]</h3>

<div class="highlight"><pre><code class="language-text" data-lang="text">The vote for releasing Apache Brooklyn ${VERSION_NAME} passed with 5 binding +1s, 1 non-binding +1s, and no 0 or -1.

Vote thread link:
https://mail-archives.apache.org/mod_mbox/brooklyn-dev/201507.mbox/%3CCABQFKi1WapCMRUqQ93E7Qow5onKgL3nyG3HW9Cse7vo%2BtUChRQ%40mail.gmail.com%3E

Binding +1s:
Hadrian Zbarcea (IPMC)
Richard Downer
Sam Corbett
Aled Sage
Andrea Turli

Non-binding +1s:
Ciprian Ciubotariu

Thanks to everyone that tested our release and voted.

Next, the release manager will publish the artifacts, and make an announcement to this list once they are available from
the Apache mirrors.</code></pre></div>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-fix-on-the-release-branch" class="section-breaker section p-">
	<span style="width: 100%"><h1>Fix on the release branch</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Make whatever changes are necessary on the release branch, supported by discussions on the mailing list.</p>

<p>Repeat the instructions to <a href="#contentsLink-make-the-release-artifacts">make release artifacts</a>.</p>

<p>Remember that after the release is done, you should cherry-pick the changes to a new feature branch based on <code>master</code>
and open a pull request, so that the next version will incorporate the bug fixes.</p>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-publish-to-the-public" class="section-breaker section p-">
	<span style="width: 100%"><h1>Publish to the public</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<h2 id="internalLink_publish-to-the-public_update-the-canonical-git-repository">Update the canonical Git repository</h2>

<p>Make a signed tag for this release:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">for</span> m in <span class="k">${</span><span class="nv">MODULES</span><span class="k">}</span><span class="p">;</span> <span class="k">do</span> <span class="o">(</span> <span class="nb">cd</span> <span class="nv">$m</span> <span class="o">&amp;&amp;</span> git tag -s -m <span class="s2">&quot;Tag release ${VERSION_NAME}&quot;</span> rel/apache-brooklyn-<span class="k">${</span><span class="nv">VERSION_NAME</span><span class="k">}</span> rel/apache-brooklyn-<span class="k">${</span><span class="nv">VERSION_NAME</span><span class="k">}</span>-rc<span class="k">${</span><span class="nv">RC_NUMBER</span><span class="k">}</span> <span class="o">)</span><span class="p">;</span> <span class="k">done</span></code></pre></div>

<p>Now push the release tag:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">for</span> m in <span class="k">${</span><span class="nv">MODULES</span><span class="k">}</span><span class="p">;</span> <span class="k">do</span> <span class="o">(</span> <span class="nb">cd</span> <span class="nv">$m</span> <span class="o">&amp;&amp;</span> git push apache-git rel/apache-brooklyn-<span class="k">${</span><span class="nv">VERSION_NAME</span><span class="k">}</span> <span class="o">)</span><span class="p">;</span> <span class="k">done</span></code></pre></div>

<h2 id="internalLink_publish-to-the-public_publish-the-source-and-binary-distributions-to-the-pre-release-area">Publish the source and binary distributions to the pre-release area</h2>

<p>You will need to have checked out the Apache distribution Subversion repository located at
https://dist.apache.org/repos/dist/release/brooklyn. Please refer to <a href="#contentsLink-release-prerequisites">Prerequisites</a> for
information.</p>

<p>In your workspace for the <code>dist.apache.org</code> repo, create a directory with the artifact name and version:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">mkdir apache-brooklyn-<span class="k">${</span><span class="nv">VERSION_NAME</span><span class="k">}</span></code></pre></div>

<p>Refer back to the pre-release area Subversion (see <a href="#contentsLink-publish-to-the-staging-area">Publish to the staging area</a>), and copy all of
the release candidate artifacts - <code>-src</code> and <code>-bin</code>, <code>.tar.gz</code> and <code>.zip</code>, and all associated <code>.md5</code>, <code>.sha1</code>, <code>.sha256</code>
and <code>.asc</code> signatures - into this new folder.</p>

<p>Rename all of the files to remove the <code>-rcN</code> designation:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">for</span> f in *<span class="p">;</span> <span class="k">do</span> mv <span class="nv">$f</span> <span class="k">${</span><span class="nv">f</span><span class="p">//-rc</span><span class="k">${</span><span class="nv">RC_NUMBER</span><span class="k">}</span><span class="p">/</span><span class="k">}</span><span class="p">;</span> <span class="k">done</span></code></pre></div>

<p>The hash files will need patching to refer to the filenames without the <code>-rcN</code> designation:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sed -i.bak <span class="s1">&#39;s/-rc&#39;</span><span class="nv">$RC_NUMBER</span><span class="s1">&#39;-/-/&#39;</span> *.md5 *.sha1 *.sha256
rm -f *.bak</code></pre></div>

<p>Note that the PGP signatures do not embed the filename so they do not need to be modified</p>

<p>As a final check, re-test the hashes and signatures:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">for</span> artifact in <span class="k">$(</span>find * -type f ! <span class="se">\(</span> -name <span class="s1">&#39;*.asc&#39;</span> -o -name <span class="s1">&#39;*.md5&#39;</span> -o -name <span class="s1">&#39;*.sha1&#39;</span> -o -name <span class="s1">&#39;*.sha256&#39;</span> <span class="se">\)</span> <span class="k">)</span><span class="p">;</span> <span class="k">do</span>
    md5sum -c <span class="k">${</span><span class="nv">artifact</span><span class="k">}</span>.md5 <span class="o">&amp;&amp;</span> <span class="se">\</span>
    shasum -a1 -c <span class="k">${</span><span class="nv">artifact</span><span class="k">}</span>.sha1 <span class="o">&amp;&amp;</span> <span class="se">\</span>
    shasum -a256 -c <span class="k">${</span><span class="nv">artifact</span><span class="k">}</span>.sha256 <span class="o">&amp;&amp;</span> <span class="se">\</span>
    gpg2 --verify <span class="k">${</span><span class="nv">artifact</span><span class="k">}</span>.asc <span class="k">${</span><span class="nv">artifact</span><span class="k">}</span> <span class="se">\</span>
      <span class="o">||</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot;Invalid signature for $artifact. Aborting!&quot;</span><span class="p">;</span> <span class="nb">break</span><span class="p">;</span> <span class="o">}</span>
<span class="k">done</span></code></pre></div>

<p>(You may get warnings such as: <code>gpg: WARNING: This key is not certified with a trusted signature!</code> 
and <code>There is no indication that the signature belongs to the owner.</code> This happens if you have not trusted
the person’s key. A key-signing party is a good way to extend this web of trust).</p>

<p>Then, add them to Subversion and commit.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">svn add apache-brooklyn-<span class="k">${</span><span class="nv">VERSION_NAME</span><span class="k">}</span>
svn commit --message <span class="s2">&quot;Add apache-brooklyn-${VERSION_NAME} to dist/release/brooklyn&quot;</span></code></pre></div>

<h2 id="internalLink_publish-to-the-public_publish-the-staging-repository-on-apaches-nexus-server">Publish the staging repository on Apache’s Nexus server</h2>

<p><em>Releasing</em> the staging repository causes its contents to be copied to the main Apache Nexus repository. This in turn
is propagated to Maven Central, meaning all of our users can access the artifacts using a default Maven configuration
(there’s no need to add a <code>&lt;repository&gt;</code> to their <code>pom.xml</code> or <code>~/.m2/settings.xml</code>).</p>

<p>Go to the Apache Nexus server at <a href="https://repository.apache.org/">https://repository.apache.org/</a> and log in using the
link in the top right (the credentials are the same as your Git and Jenkins credentials). Go to the “Staging
Repositories” page, and tick the repository with the name starting <code>orgapachebrooklyn</code>. Click the <strong>Release</strong> button.
Provide a description which includes the version, e.g. <code>Apache Brooklyn 0.7.0-incubating</code>.</p>

<p>Note there is only one orgapachebrooklyn staging repository at a time; this will be the one created for the release
candidate with whatever name was used there (e.g. it might include “rc” in the name). If you really want, you can 
double-check under the “content” that brooklyn-dist has artifacts without rc in the name.</p>

<h2 id="internalLink_publish-to-the-public_update-the-website">Update the website</h2>

<p><em>Instructions on uploading to the website are beyond the scope of these instructions. Refer to the 
<a href="https://github.com/apache/brooklyn-docs/tree/master/README.md">appropriate instructions</a>.</em></p>

<h3 id="internalLink_publish-to-the-public_publish-documentation-for-the-new-release">Publish documentation for the new release</h3>

<p>Go to the release branch and perform a build:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">git checkout <span class="k">${</span><span class="nv">VERSION_NAME</span><span class="k">}</span>
mvn clean install -DskipTests</code></pre></div>

<p>Ensure the SVN repo is up-to-date (very painful otherwise!)</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd</span> <span class="k">${</span><span class="nv">BROOKLYN_SITE_DIR</span><span class="p">-../brooklyn-site-public</span><span class="k">}</span>
svn up
<span class="nb">cd</span> -</code></pre></div>

<p>Generate the permalink docs for the release:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd </span>brooklyn-docs
./_build/build.sh guide-version --install</code></pre></div>

<p>Now publish _site/v/<em>${VERSION_NAME}</em> to the public website.</p>

<p>Update the “latest” docs to this release:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">./_build/build.sh guide-latest --install</code></pre></div>

<p>Now publish _site/v/latest to the public website:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd</span> <span class="k">${</span><span class="nv">BROOKLYN_SITE_DIR</span><span class="p">-../../brooklyn-site-public</span><span class="k">}</span>
svn add * --force
<span class="nb">export </span><span class="nv">DELETIONS</span><span class="o">=</span><span class="k">$(</span> svn status <span class="p">|</span> sed -e <span class="s1">&#39;/^!/!d&#39;</span> -e <span class="s1">&#39;s/^!//&#39;</span> <span class="k">)</span>
<span class="k">if</span> <span class="o">[</span> ! -z <span class="s2">&quot;${DELETIONS}&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span> svn rm <span class="k">${</span><span class="nv">DELETIONS</span><span class="k">}</span> <span class="p">;</span> <span class="k">fi</span></code></pre></div>

<h3 id="internalLink_publish-to-the-public_update-the-main-website-to-link-to-the-new-release">Update the main website to link to the new release</h3>

<p>This should be done on the <code>master</code> branch:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">git checkout master</code></pre></div>

<ol>
  <li>Edit the file <code>brooklyn-docs/_config.yml</code> - change <code>brooklyn-stable-version</code> to be the newly-release version, and
<code>brooklyn-version</code> to be the current SNAPSHOT version on the master branch.</li>
  <li>Edit the file <code>brooklyn-docs/website/download/verify.md</code> to add links to the MD5/SHA1/SHA256 hashes and PGP signatures for the
new version.</li>
  <li>Edit the file <code>brooklyn-docs/website/meta/versions.md</code> to add the new version.</li>
  <li>Build the updated site with <code>./_build/build.sh website-root --install</code>.</li>
  <li>Publish to the public website.</li>
  <li>Commit your changes to master, e.g. with a message like “Update latest docs to 0.8.0-incubating”</li>
</ol>

<h2 id="internalLink_publish-to-the-public_tag-the-release-in-git">Tag the release in git</h2>

<p>Make a signed tag for this release, based on the tag for the release candidate, and then push the tag:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">git tag -s -m <span class="s2">&quot;Tag release ${VERSION_NAME}&quot;</span> apache-brooklyn-<span class="k">${</span><span class="nv">VERSION_NAME</span><span class="k">}</span> apache-brooklyn-<span class="k">${</span><span class="nv">VERSION_NAME</span><span class="k">}</span>-rc<span class="k">${</span><span class="nv">RC_NUMBER</span><span class="k">}</span>
git push apache apache-brooklyn-<span class="k">${</span><span class="nv">VERSION_NAME</span><span class="k">}</span></code></pre></div>

<p>Note the tag <code>apache-brooklyn-${VERSION_NAME}-rc${RC_NUMBER}</code> should have been created as part of the
RC creation - see <a href="#contentsLink-make-the-release-artifacts">make-release-artifacts</a>.</p>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-announce-the-release" class="section-breaker section p-">
	<span style="width: 100%"><h1>Announce the release</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>After svnpubsub has updated, the artifacts will be visible at https://www.apache.org/dist/brooklyn/, and distributed to Apache mirrors around the world shortly after.</p>

<p>An announcement email can then be made:</p>

<h3 id="internalLink_announce-the-release_subject-announce-apache-brooklyn-090-released">Subject: [ANNOUNCE] Apache Brooklyn 0.9.0 released</h3>

<div class="highlight"><pre><code class="language-text" data-lang="text">The Apache Brooklyn team is proud to announce the latest release of Apache
Brooklyn 0.9.0.

Apache Brooklyn is a framework for modelling, deploying, and managing
applications through autonomic blueprints. More details on Apache Brooklyn
can be found at https://brooklyn.apache.org/

Version 0.9.0 is a major step for Apache Brooklyn, including many new features
and fixes.

Thanks go to our community for their improvements, feedback and guidance, and
to Brooklyn’s commercial users for funding much of this development.

As well as a source code release, we offer a full binary distribution
download, and a full set of Maven artifacts for developers.

Release notes:
https://brooklyn.apache.org/v/0.9.0/misc/release-notes.html

Download:
https://brooklyn.apache.org/download/

User guide:
https://brooklyn.apache.org/v/0.9.0/

Maven artifacts have also been made available on repository.apache.org and
Maven Central.

Thanks
Richard Downer
release manager for 0.9.0
on behalf of the Brooklyn PPMC</code></pre></div>


	</div>
	 
	  
	 

 
	    
	    
	  
	 

 
	    
	    
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-code-standards" class="section-breaker section p-">
	<span style="width: 100%"><h1>Code Standards</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	<p>Without being too restrictive about how you have to code as part of Brooklyn,
there are some style points that really make life easier when sharing code
among ourselves:</p>

<ul>
  <li>Use spaces (not tabs!) with 4 spaces indentation</li>
  <li>Keep line length &lt;=128</li>
  <li>Don’t reformat code or organize imports unless there’s very good
reason (this makes history and merges much harder)</li>
</ul>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	 
	<div id="contentsLink-handy-places" class="section-breaker section p-">
	<span style="width: 100%"><h1>Handy Places</h1><a href="#content-top" class="goToTop">^</a></span>
	
	
	
	
	
	
	
	
	
	
	
	
	
<ul>
  <li>
    <p><strong>Code</strong> is in Github at <a href="https://github.com/apache/brooklyn/">https://github.com/apache/brooklyn/</a></p>
  </li>
  <li>
    <p><strong>Issues</strong> are in Jira at <a href="https://issues.apache.org/jira/browse/BROOKLYN/">https://issues.apache.org/jira/browse/BROOKLYN/</a></p>
  </li>
  <li>
    <p><strong>Maven repositories</strong> are at:</p>

    <ul>
      <li><a href="https://repository.apache.org/content/repositories/releases/org/apache/brooklyn">Apache releases</a></li>
      <li><a href="https://repository.apache.org/content/repositories/snapshots/org/apache/brooklyn">Apache snapshots</a></li>
    </ul>
  </li>
  <li>
    <p><strong>CI</strong> is done by Jenkins at <a href="https://builds.apache.org/job/brooklyn-master-build/">https://builds.apache.org/job/brooklyn-master-build/</a></p>
  </li>
</ul>


	</div>
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	  
	 

 
	    
	     
	     

	
	
	
	
	
	
	
	 
	 
	  
	 

 
	    
	    
	  
	 

 
    
		
		

    
  
</div>

</body>
</html>